import{a5 as o,a6 as i,a9 as h,hF as k,bA as $,b9 as f,cy as R,cb as g,eH as T,s as C}from"./index-b516d057.js";import{o as E}from"./StreamFeatureManager-3c1591f4.js";import{createConnection as G}from"./createConnection-c6387383.js";import{r as P}from"./EventedSet-680e6831.js";import{b as j}from"./Query-071039d7.js";import{E as x}from"./FeatureLikeLayerView3D-88097627.js";import{n as U}from"./LayerView3D-c03d44fc.js";import{C as V}from"./RenderGeometry-5dbc1699.js";import{u as F}from"./LayerView-060b46d4.js";import{o as L}from"./StreamLayerView-ea24b9cf.js";import"./CircularArray-ef508845.js";import"./query-351887b5.js";import"./pbfQueryUtils-b37a842c.js";import"./pbf-2651fe50.js";import"./OptimizedGeometry-196224d4.js";import"./OptimizedFeature-e90b69df.js";import"./OptimizedFeatureSet-1d1ac4b9.js";import"./queryZScale-d7a48772.js";import"./FullTextSearch-12e0754c.js";import"./QuantizationParameters-f983cf8d.js";import"./hydratedFeatures-2365c307.js";import"./dehydratedPoint-5a1dfed5.js";import"./UpdatingHandles-7949a657.js";import"./geometryServiceUtils-3e048225.js";import"./project-1bd91657.js";import"./dehydratedFeatures-2a3f0608.js";import"./quantizationUtils-17105106.js";import"./ViewingMode-5d7d590b.js";import"./dehydratedFeatureComparison-7855b188.js";import"./SceneView-123ac862.js";import"./Viewpoint-f83262d0.js";import"./Cyclical-4c223a04.js";import"./jsxFactory-92036771.js";import"./uuid-709b6c67.js";import"./HeightModelInfo-b816d32b.js";import"./ElevationQuery-a3eaf0a0.js";import"./vec2f32-eaf29605.js";import"./InterleavedLayout-d76b0d59.js";import"./types-1305598a.js";import"./DefaultTechniqueConfiguration-b4dbe32f.js";import"./requestImageUtils-b142708c.js";import"./enums-bdecffa2.js";import"./Texture-bcb6d63f.js";import"./contextUtils-81fda295.js";import"./interfaces-8918b36f.js";import"./Material-5f4156ac.js";import"./FramebufferObject-123b7c8d.js";import"./ShaderTechniqueConfiguration-2502462e.js";import"./ColorMaterial-bdf1f62a.js";import"./VerticalOffset.glsl-5743f98e.js";import"./OrderIndependentTransparency-755f7dcc.js";import"./featureConversionUtils-09cf00ff.js";import"./edgeUtils-6e4a97fb.js";import"./SnappingCandidate-970faec6.js";import"./ElevationProvider-abb53936.js";import"./objectResourceUtils-003803db.js";import"./devEnvironmentUtils-4eab2a99.js";import"./DefaultMaterial_COLOR_GAMMA-101ea40c.js";import"./Version-1f969b2a.js";import"./resourceUtils-1d03d2fe.js";import"./mat3f32-6c416b1c.js";import"./NestedMap-1b5db22e.js";import"./verticalOffsetUtils-e5214af9.js";import"./orientedBoundingBox-67c5cd22.js";import"./symbolColorUtils-3ca646c8.js";import"./RenderState-1d6218ee.js";import"./callExpressionWithFeature-36423058.js";import"./lineStippleUtils-0688e06c.js";import"./projectVectorToDehydratedPoint-e30a7ff8.js";import"./interfaces-1a80c8eb.js";import"./frustum-f9d53cdf.js";import"./webStyleSymbolUtils-4761c8f2.js";import"./glUtil-ce5ee52b.js";import"./VertexElementDescriptor-2925c6af.js";import"./Intersector-fa865806.js";import"./boundedPlane-1da2f094.js";import"./Octree-7cea9440.js";import"./Intersector-a291e778.js";import"./Scheduler-ff5943a4.js";import"./signal-51ed66f5.js";import"./debugFlags-9a30f077.js";import"./fontUtils-56b88a2f.js";import"./projectVectorToVector-56c29b20.js";import"./coordinateSystem-38339d17.js";import"./scaleUtils-72744379.js";import"./LayerConstants-d3ac1b7a.js";import"./DefaultUI-af7068c2.js";import"./screenUtils-8dc4a7f9.js";import"./Map-1ad4186f.js";import"./Basemap-8d62c69e.js";import"./loadAll-5e767cfa.js";import"./writeUtils-e226a8aa.js";import"./Ground-ed93a93a.js";import"./CollectionFlattener-193451da.js";import"./editableLayers-856f2cb4.js";import"./basemapUtils-6ec10a55.js";import"./TablesMixin-292d1d89.js";import"./IViewEvents-9a85f53d.js";import"./interfaces-0421c5e6.js";import"./heightModelInfoUtils-0dd2b6e4.js";import"./mat2d-d4af8487.js";import"./mat2df32-fb26a8c9.js";import"./mat2df64-4d1a9198.js";import"./capabilities-9d56a1da.js";import"./themeUtils-7dcf5b71.js";import"./globalCss-94006b67.js";import"./accessibleHandler-e91101b2.js";import"./Compass-b37d7d1d.js";import"./GoTo-4d856ce0.js";import"./NavigationToggle-57c00adb.js";import"./Zoom-73b5f25a.js";import"./resources-d4afed0c.js";import"./viewpointUtils-245ed782.js";import"./projectPointToVectorWithEngine-f608a34a.js";import"./projectVectorToPoint-fbaf5599.js";import"./earthUtils-ef4b5643.js";import"./spatialReferenceSupport-5aeb751c.js";import"./ElevationSamplerData-9f34f589.js";import"./terrainUtils-b6b761ab.js";import"./Environment-91bfea7d.js";import"./weather-2eb64924.js";import"./projectPointToWGS84ComparableLonLat-1ba40d40.js";import"./projectVectorToWGS84ComparableLonLat-5675a9f4.js";import"./vec3f32-bac7ea57.js";import"./ShadowCastVisualizeTechniqueConfiguration-4fcc4e25.js";import"./ray-8da55042.js";import"./ZoomMomentumEstimator-7437d26a.js";import"./labelFormatUtils-d440367f.js";import"./labelUtils-b29175f3.js";import"./FeatureTileDescriptor3D-27dbeac7.js";import"./RenderCoordsHelper-8f237859.js";import"./intersectorUtilsConversions-d05d75a3.js";import"./Intersector-2e1d9db3.js";import"./LercDecoder-b49c0e9c.js";import"./WorkerHandle-9433ab9a.js";import"./RenderableTile-52f61d09.js";import"./enums-fb086c25.js";import"./VertexArrayObject-d19dab8d.js";import"./config-1337d16e.js";import"./TiledDisplayObject-e7d105ae.js";import"./DisplayObject-9a6e3923.js";import"./TileKey-4b1303ff.js";import"./rasterUtils-15abcc11.js";import"./TileInfoView-ce4d65fb.js";import"./TileStrategy-a729431f.js";import"./QueueProcessor-4b9d43d3.js";import"./StyleDefinition-29c49b98.js";import"./enums-f1a6a48a.js";import"./floatRGBA-ca990bbb.js";import"./edgeProcessing-82213448.js";import"./resources-15104e7a.js";import"./EdgeWorkerHandle-7d97defa.js";import"./workerHelper-d1cc0cda.js";import"./testSVGPremultipliedAlpha-f5e92e14.js";import"./DefaultVertexAttributeLayouts-8962d8eb.js";import"./RenderingContext-c0ea7a49.js";import"./ProgramCache-891c4b8d.js";import"./Program-96bc94ed.js";import"./hitTestSelectUtils-d512707e.js";import"./layerViewUtils-6ebe90f4.js";import"./queryForSymbologySnapping-caae9522.js";import"./elevationInfoUtils-be36d866.js";import"./hash-6f442295.js";import"./Graphics3DObjectStates-511adea3.js";import"./jsonUtils-52514725.js";import"./DictionaryLoader-e327eff9.js";import"./FieldsIndex-e8db657f.js";import"./UnknownTimeZone-a05df022.js";import"./HeatmapColorStop-3fff4333.js";import"./heatmapUtils-7f42325f.js";import"./rendererConversion-b2429202.js";import"./defaults-4faa92e6.js";import"./defaultsJSON-59981e75.js";import"./optimizedFeatureQueryEngineAdapter-1fecea41.js";import"./PooledRBush-fa11eac4.js";import"./quickselect-bc0541de.js";import"./popupUtils-e4ebc84a.js";import"./FeatureFilter-55dd341e.js";import"./floorFilterUtils-080a7cd2.js";import"./QueryEngine-ee1ccbba.js";import"./WhereClause-41137be1.js";import"./TimeOnly-879c5107.js";import"./projectionSupport-dcf335fc.js";import"./json-48e3ea08.js";import"./QueryEngineCapabilities-85c4f1d0.js";import"./utils-f54bcc46.js";import"./utils-1a995f8e.js";import"./FeatureStore-02a891a3.js";import"./BoundsStore-230a1891.js";import"./heatmapTextureUtils-6877589a.js";import"./projectExtentUtils-15e84132.js";const N=2500;let c=class extends T{getObjectId(){return this.objectId}};o([i({type:Number,json:{read:!0}})],c.prototype,"objectId",void 0),c=o([h("esri.layers.graphics.controllers.StreamGraphic")],c);let H=class{constructor(t){this.onUpdate=t,this._idToGraphic=new Map}destroy(){this._idToGraphic.clear()}add(t){this._idToGraphic.set(t.objectId,t)}get(t){return this._idToGraphic.get(t)}forEach(t){this._idToGraphic.forEach(t)}removeById(t){const r=this._idToGraphic.get(t);return r?(r.sourceLayer=r.layer=null,this._idToGraphic.delete(t),r):null}update(t,r){this.onUpdate(t,r)}get size(){return this._idToGraphic.size}},s=class extends k($){constructor(){super(...arguments),this.isPaused=!1,this.graphics=new P,this._updateInfo={websocket:0,client:0},this._updateIntervalId=null,this._outSpatialReference=null}initialize(){this.addResolvingPromise(this.layer.when(()=>this._startup()))}destroy(){this.clear()}_clearInterval(){this._updateIntervalId!==null&&(clearInterval(this._updateIntervalId),this._updateIntervalId=null)}clear(){this._clearInterval(),this.connection=f(this.connection),this.store=f(this.store),this.graphics.clear(),this.removeAllHandles()}get updating(){return!this.connection||this.connection.connectionStatus==="connected"}_startup(){const{layer:t,layerView:r}=this,{spatialReference:a,definitionExpression:m,geometryDefinition:l,objectIdField:d,timeInfo:_,purgeOptions:v,maxReconnectionAttempts:I,maxReconnectionInterval:w,customParameters:b}=t,S=t.geometryType?R.toJSON(t.geometryType):null,M=a,u=r.view.spatialReference,O={geometry:l,where:m};this.clear(),this._set("connection",G(t.parsedUrl,M,u,S,O,I,w,b??void 0)),this._outSpatialReference=u.toJSON(),this.store=new H(this._onUpdate.bind(this)),this.featuresManager=new E(this.store,d,_.toJSON(),v);const y="startup-watches";this.removeHandles(y),this.addHandles([t.on("send-message-to-socket",n=>this.connection.sendMessageToSocket(n)),t.on("send-message-to-client",n=>this.connection.sendMessageToClient(n)),this.connection.on("data-received",n=>this._onFeature(n)),this.connection.on("message-received",n=>this._onWebSocketMessage(n)),g(()=>[t.definitionExpression,t.geometryDefinition,t.purgeOptions],()=>this._startup())],y),this.isPaused||this._initUpdateInterval()}_onWebSocketMessage(t){if(this.layerView.emit("message-received",t),"type"in t)switch(t.type){case"delete":if(t.objectIds)for(const r of t.objectIds)this.featuresManager.removeById(r);if(t.trackIds)for(const r of t.trackIds)this.featuresManager.removeByTrackId(r);break;case"clear":this.store.forEach(r=>this.featuresManager.removeById(r.objectId))}}_onFeature(t){this._updateInfo.websocket++,this.layerView.hasEventListener("data-received")&&this.layerView.emit("data-received",{attributes:t.attributes,centroid:t.centroid,geometry:t.geometry});try{t.geometry==null||t.geometry.spatialReference||(t.geometry.spatialReference=this._outSpatialReference);const r=c.fromJSON(t);r.sourceLayer=r.layer=this.layer,this.featuresManager.add(r)}catch{}}_onUpdate(t,r){r!=null&&this.graphics.removeMany(r),t!=null&&(this._updateInfo.client+=t.length,this.graphics.addMany(t))}_initUpdateInterval(){this._clearInterval();const{updateInterval:t}=this.layer;let r=performance.now();this._updateIntervalId=setInterval(()=>{const a=performance.now(),m=a-r;if(m>N){r=a;const l=Math.round(this._updateInfo.client/(m/1e3)),d=Math.round(this._updateInfo.websocket/(m/1e3));this._updateInfo.client=0,this._updateInfo.websocket=0,this.layerView.emit("update-rate",{client:l,websocket:d})}this.featuresManager.checkForUpdates()},t)}pauseStream(){this.isPaused=!0,this._clearInterval()}resumeStream(){this.isPaused=!1,this._initUpdateInterval()}};o([i()],s.prototype,"isPaused",void 0),o([i({constructOnly:!0})],s.prototype,"layer",void 0),o([i({constructOnly:!0})],s.prototype,"layerView",void 0),o([i()],s.prototype,"connection",void 0),o([i({readOnly:!0})],s.prototype,"updating",null),s=o([h("esri.layers.graphics.controllers.StreamController")],s);let p=class extends L(x(U(F))){constructor(){super(...arguments),this.type="stream-3d",this.updatePolicy=V.ASYNC,this.hasZ=!0,this.hasM=!1}initialize(){this.addHandles(g(()=>this.suspended,e=>{this.controller&&this._onSuspendedChange(e)}))}get connectionError(){var t,r;const e=(r=(t=this.controller)==null?void 0:t.connection)==null?void 0:r.errorString;return e?new C("stream-controller",e):null}createQuery(){return new j({outFields:["*"],returnGeometry:!0,outSpatialReference:this.view.spatialReference})}queryLatestObservations(e,t){return this.queryEngine.executeQueryForLatestObservations(this._ensureQuery(e),t==null?void 0:t.signal)}get _streamConnectionStatus(){var e,t;return((t=(e=this.controller)==null?void 0:e.connection)==null?void 0:t.connectionStatus)??"disconnected"}createController(){return new s({layer:this.layer,layerView:this})}beforeSetController(){}_doPause(){var e;(e=this.controller)==null||e.pauseStream()}_doResume(){var e;(e=this.controller)==null||e.resumeStream()}};o([i({readOnly:!0})],p.prototype,"updatePolicy",void 0),o([i({readOnly:!0})],p.prototype,"connectionError",null),o([i()],p.prototype,"controller",void 0),o([i({readOnly:!0})],p.prototype,"hasZ",void 0),o([i({readOnly:!0})],p.prototype,"hasM",void 0),o([i({readOnly:!0})],p.prototype,"_streamConnectionStatus",null),p=o([h("esri.views.3d.layers.StreamLayerView3D")],p);const Io=p;export{Io as default};
