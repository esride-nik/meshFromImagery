import{aq as y,v as f,y as u,dM as J,kS as V,kT as W,hw as Y,hy as N,hx as U,eY as k,kj as Z,eZ as K,aR as Q,kU as X,q as ss,kV as es,an as ts}from"./index-b516d057.js";import{r as as}from"./uuid-709b6c67.js";import{r as os,a as ns,u as rs,c as is,d as v,l as cs,t as ls,n as us,p as ps}from"./uploadAssetErrors-faaa3a92.js";import{i as w,h as ms,e as A,m as fs,a as ds}from"./progressUtils-874eb29d.js";const D=1e6,x=20*D,ys=2e9,ws=3;async function gs({data:e,name:t,description:s},a,o){let r=null;try{const n=y(a,"uploads"),i=y(n,"info"),{data:c}=await f(i,{query:{f:"json"},responseType:"json"});u(o);const p=J(a),l=c.maxUploadFileSize*D,d=p?ys:l,b=p?Math.min(x,l):x;if(e.size>d)throw new Error("Data too large");const C=y(n,"register"),{data:j}=await f(C,{query:{f:"json",itemName:hs(t),description:s},responseType:"json",method:"post"});if(u(o),!j.success)throw new Error("Registration failed");const{itemID:B}=j.item;r=y(n,B);const z=y(r,"uploadPart"),F=Math.ceil(e.size/b),g=new Array;for(let m=0;m<F;++m)g.push(e.slice(m*b,Math.min((m+1)*b,e.size)));const h=g.slice().reverse(),E=new Array,M=w(F,o==null?void 0:o.onProgress,"uploadItem"),L=async()=>{for(;h.length!==0;){const m=g.length-h.length,P=h.pop(),T=new FormData,H=M.simulate(m,ms(P.size));try{const _=P;T.append("f","json"),T.append("file",_),T.append("partId",`${m}`);const{data:G}=await f(z,{timeout:0,body:T,responseType:"json",method:"post"});if(u(o),!G.success)throw new Error("Part upload failed")}finally{H.remove()}}};for(let m=0;m<ws&&h.length!==0;++m)E.push(L());await Promise.all(E);const $=y(r,"commit"),{data:S}=await f($,{query:{f:"json",parts:g.map((m,P)=>P).join(",")},responseType:"json",method:"post"});if(u(o),!S.success)throw new Error("Commit failed");return S.item}catch(n){if(r!=null){const i=y(r,"delete");await f(i,{query:{f:"json"},responseType:"json",method:"post"})}throw n}}function hs(e){return e.replaceAll("/","_").replaceAll("\\","_")}async function Hs(e,t,s){var r;const a=e.length;if(!a)return(r=s==null?void 0:s.onProgress)==null||r.call(s,1),[];const o=w(a,s==null?void 0:s.onProgress,"uploadAssets");return Promise.all(e.map((n,i)=>Ps(n,t,{...s,onProgress:o.makeOnProgress(i)})))}async function Ps(e,{layer:t,ongoingUploads:s},a){var n;const o=s.get(e);if(o)return o;if(!Rs(t))throw new os;if(Ts(e,t))return(n=a==null?void 0:a.onProgress)==null||n.call(a,1),e;const r=bs(e,t,a);s.set(e,r);try{await r}finally{s.delete(e)}return e}function Ts(e,t){const{parsedUrl:s}=t;return s!=null&&e.metadata.externalSources.some(a=>V(a,s))}async function bs(e,t,s){const{metadata:a}=e,{displaySource:o}=a,r=I(o==null?void 0:o.source,t),n=!!r,i=a.externalSources.length>0,c=n?As(r,t,s):i?js(e,t,s):Fs(e,t,s),p=await c;return u(s),e.addExternalSources([p]),e}async function As(e,t,s){return{source:await q(e,t,s),original:!0}}async function js(e,t,s){const a=R(t),{externalSources:o}=e.metadata,r=Ss(o,t);if(!r)throw new ns;const n=w(A.uploadConvertibleSource,s==null?void 0:s.onProgress,"uploadConvertibleSource"),i=await q(r,t,{onProgress:n.makeOnProgress("uploadEditSource")});e.addExternalSources([{source:i,original:!0}]);const c=r.reduce((l,{asset:d})=>d instanceof File?l+d.size:l,0),p=n.simulate("serviceAssetsToGlb",fs(c));try{return{source:await Is(i,t,a)}}finally{p.remove()}}async function Fs(e,t,s){const a=w(A.uploadLocalMesh,s==null?void 0:s.onProgress,"uploadLocalMesh"),o=Es(e,t,{...s,onProgress:a.makeOnProgress("meshToAssetBlob")});return{source:await O([o],t,{...s,onProgress:a.makeOnProgress("uploadAssetBlobs")}),extent:e.extent.clone(),original:!0}}async function Es(e,t,s){const a=R(t),o=await e.load(s),r=await o.toBinaryGLTF({ignoreLocalTransform:!0});u(s);const n=await r.buffer();return u(s),{blob:new Blob([n.data],{type:n.type}),assetName:`${as()}.glb`,assetType:a}}function Ss(e,t){for(const s of e){const a=I(s.source,t);if(a)return a}return null}function I(e,t){if(!e)return null;const{infoFor3D:{supportedFormats:s,editFormats:a}}=t,o=X(e),r=new Array;let n=!1;for(let i=0;i<o.length;++i){const c=xs(o[i],s);if(!c)return null;a.includes(c.assetType)&&(n=!0),r.push(c)}return n?r:null}function xs(e,t){const s=W(e,t);return s?{asset:e,assetType:s}:null}async function q(e,t,s){return O(e.map(a=>Ns(a,s)),t,s)}async function O(e,t,s){const a=w(A.uploadAssetBlobs,s==null?void 0:s.onProgress,"uploadAssetBlobs"),o=await ks(e,t,{...s,onProgress:a.makeOnProgress("prepareAssetItems")});u(s);const r=o.map(({item:i})=>i),{uploadResults:n}=await vs(r,t,{...s,onProgress:a.makeOnProgress("uploadAssetItems")});return u(s),e.map((i,c)=>Ds(o[c],n[c],t))}async function Ns(e,t){const{asset:s,assetType:a}=e;if(s instanceof File)return{blob:s,assetName:s.name,assetType:a};const o=await s.toBlob(t);return u(t),{blob:o,assetName:s.assetName,assetType:a}}async function Us(e,t,s){const{blob:a,assetType:o,assetName:r}=e;let n=null;try{const i=await gs({data:a,name:r},t.url,s);u(s),n={assetType:o,assetUploadId:i.itemID}}catch(i){ss(i),Cs().warnOnce(`Service ${t.url} does not support the REST Uploads API.`)}if(!n){const i=await es(a);if(u(s),!i.isBase64)throw new us;n={assetType:o,assetData:i.data}}if(!n)throw new ps;return{item:n,assetName:r}}function ks(e,t,s){const a=w(e.length,s==null?void 0:s.onProgress,"prepareAssetItems");return Promise.all(e.map(async(o,r)=>{const n=Us(await o,t,{...s,onProgress:a.makeOnProgress(r)});return u(s),n}))}async function vs(e,t,s){const a=ds(s==null?void 0:s.onProgress);try{const o=await f(y(t.parsedUrl.path,"uploadAssets"),{timeout:0,query:{f:"json",assets:JSON.stringify(e)},method:"post",responseType:"json"});if(u(s),o.data.uploadResults.length!==e.length)throw new rs(e.length,o.data.uploadResults.length);return o.data}finally{a.remove()}}function Ds(e,t,s){const{success:a}=t;if(!a){const{error:p}=t;throw new is(e.assetName,p)}const{assetHash:o}=t,{assetName:r,item:{assetType:n}}=e,{infoFor3D:{supportedFormats:i}}=s,c=Y(n,i);if(!c)throw new v(n);return new N(r,c,[new U(`${s.parsedUrl.path}/assets/${o}`,o)])}async function Is(e,t,s){var p;const a=e.map(({assetName:l,parts:d})=>({assetName:l,assetHash:d[0].partHash})),o=(p=t.capabilities)==null?void 0:p.operations.supportsAsyncConvert3D,r={f:"json",assets:JSON.stringify(a),transportType:"esriTransportTypeUrl",targetFormat:s,async:o},n=y(t.parsedUrl.path,"convert3D");let i;try{i=(await(o?Os:qs)(n,{query:r,responseType:"json",timeout:0})).data}catch{throw new cs}const{supportedFormats:c}=t.infoFor3D;return i.assets.map(l=>{const d=k(l.contentType,c);if(!d)throw new v(d);return new N(l.assetName,l.contentType,[new U(l.assetURL,l.assetHash)])})}function qs(e,t){return f(e,t)}async function Os(e,t){const s=(await f(e,t)).data.statusUrl;for(;;){const a=(await f(s,{query:{f:"json"},responseType:"json"})).data;switch(a.status){case"Completed":return f(a.resultUrl,{query:{f:"json"},responseType:"json"});case"CompletedWithErrors":throw new Error(a.status);case"Failed ImportChanges":case"InProgress":case"Pending":case"ExportAttachments":case"ExportChanges":case"ExportingData":case"ExportingSnapshot":case"ImportAttachments":case"ProvisioningReplica":case"UnRegisteringReplica":break;default:throw new Error}await Z(Bs)}}function Rs(e){return!!e.infoFor3D&&!!e.url}function R(e){const{infoFor3D:t}=e,s=k("model/gltf-binary",t.supportedFormats)??K("glb",t.supportedFormats);if(!s)throw new ls;return s}function Cs(){return ts.getLogger("esri.layers.graphics.sources.support.uploadAssets")}const Bs=Q(1e3);export{Hs as uploadAssets};
