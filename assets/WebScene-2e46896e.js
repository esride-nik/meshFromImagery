import{s as u,a5 as n,a6 as o,a9 as g,ae as w,ah as f,X as F,dE as fe,jZ as je,j_ as Me,V,eU as I,b9 as _e,ba as H,ep as Se,aa as Ue,an as R,iQ as xe,x as Ne,al as ke,_ as Ie,gk as Ge,cc as Fe,d4 as ce,aW as z,pv as We,eq as qe,U as Be,hF as Je,a2 as De,dm as Ke,dp as E,cd as He,hi as ze,pw as Qe,I as P,j as O,S as Ae,io as Xe,px as Ze,o8 as Ye,hn as de,f as he,M as et,fP as tt,ad as b,a7 as Q,eh as it}from"./index-b516d057.js";import{g as rt}from"./Map-1ad4186f.js";import{l as le}from"./Viewpoint-f83262d0.js";import{t as nt}from"./loadAll-5e767cfa.js";import{i as ue}from"./originUtils-cfe4feaf.js";import{v as st}from"./HeightModelInfo-b816d32b.js";import{i as at}from"./heightModelInfoUtils-0dd2b6e4.js";import{b as ot,v as lt,w as me}from"./basemapUtils-6ec10a55.js";import{i as pt,a as ct,l as dt}from"./Viewing-eaadba2d.js";import{e as ht}from"./tagSymbols-a2a561f5.js";import{l as ye}from"./ViewingMode-5d7d590b.js";import{r as ge}from"./spatialReferenceSupport-5aeb751c.js";import{i as we}from"./saveAPIKeyUtils-b849c848.js";import{p as ut,u as mt}from"./saveUtils-2b9108f6.js";import{j as W,i as yt,p as Le,a as gt}from"./Environment-91bfea7d.js";import{R as wt}from"./Basemap-8d62c69e.js";import{I as vt}from"./Scheduler-ff5943a4.js";import{p as L}from"./SlideThumbnail-a64b3c3c.js";import{e as bt,n as ft}from"./weather-2eb64924.js";import{b as _t}from"./Ground-ed93a93a.js";import{r as St}from"./Version-1f969b2a.js";import"./CollectionFlattener-193451da.js";import"./editableLayers-856f2cb4.js";import"./TablesMixin-292d1d89.js";import"./Cyclical-4c223a04.js";import"./multiOriginJSONSupportUtils-c978f4c3.js";import"./uuid-709b6c67.js";import"./resourceUtils-2ae38811.js";import"./writeUtils-e226a8aa.js";import"./signal-51ed66f5.js";import"./debugFlags-9a30f077.js";import"./RenderState-1d6218ee.js";const It="webscene:failed-to-copy-embedded-resources",At="webscene:schema-validation";function Lt(){return new u(It,"Copying of embedded resources is currently not supported")}function $t(e){return new u(At,"Failed to save webscene due to schema validation errors. See 'details.errors' for more detailed information",{errors:e})}var Z;let j=Z=class extends w{constructor(e){super(e),this.viewing=null}clone(){return new Z({viewing:this.viewing?this.viewing.clone():null})}};n([o({type:pt,json:{write:!0}})],j.prototype,"viewing",void 0),j=Z=n([g("esri.webscene.ApplicationProperties")],j);const Tt=j;var Y;let _=Y=class extends w{constructor(e){super(e),this.environment=new W,this.spatialReference=null,this.viewpoint=null}set viewingMode(e){this._set("viewingMode",e)}clone(){return new Y({environment:this.environment.clone(),spatialReference:this.spatialReference?this.spatialReference.clone():null,viewingMode:this.viewingMode,viewpoint:this.viewpoint?this.viewpoint.clone():null})}};n([o({type:W,json:{write:{isRequired:!0}}})],_.prototype,"environment",void 0),n([o({type:f})],_.prototype,"spatialReference",void 0),n([o({type:["local","global"]})],_.prototype,"viewingMode",null),n([o({type:le,json:{write:{isRequired:!0}}})],_.prototype,"viewpoint",void 0),_=Y=n([g("esri.webscene.InitialViewProperties")],_);const q=_;var ee;let M=ee=class extends w{constructor(){super(...arguments),this.text=""}clone(){return new ee({text:this.text})}};n([o({type:String,json:{write:!0}})],M.prototype,"text",void 0),M=ee=n([g("esri.webscene.support.Description")],M);const U=M;var te;let $=te=class extends w{constructor(){super(...arguments),this.lighting=new Le,this.weather=new ft}clone(){return new te({lighting:F(this.lighting),weather:F(this.weather)})}};n([o({types:yt,json:{write:!0}})],$.prototype,"lighting",void 0),n([o({types:bt,json:{write:!0}})],$.prototype,"weather",void 0),$=te=n([g("esri.webscene.Environment")],$);var x;let N=x=class extends w{constructor(){super(...arguments),this.opacity=null}clone(){return new x({opacity:this.opacity})}cloneAndApplyTo(e){return this.opacity==null||((e=(e==null?void 0:e.clone())??new _t).opacity=this.opacity),e}static fromGround(e){return new x({opacity:e.opacity})}};n([o({type:Number,json:{type:fe,read:{reader:je,source:"transparency"},write:{writer:(e,t)=>{t.transparency=Me(e)},target:"transparency"}}})],N.prototype,"opacity",void 0),N=x=n([g("esri.webscene.support.SlideGround")],N);const $e=N;var ie;let T=ie=class extends w{constructor(e){super(e),this.id="",this.sublayerIds=null}clone(){return new ie({id:this.id,sublayerIds:F(this.sublayerIds)})}};n([o({type:String,json:{write:!0}})],T.prototype,"id",void 0),n([o({type:[fe],json:{read:{source:"subLayerIds"},write:{target:"subLayerIds"}}})],T.prototype,"sublayerIds",void 0),T=ie=n([g("esri.webscene.support.SlideVisibleLayer")],T);var re;let k=re=class extends w{constructor(){super(...arguments),this.text=""}clone(){return new re({text:this.text})}};n([o({type:String,json:{write:{isRequired:!0}}})],k.prototype,"text",void 0),k=re=n([g("esri.webscene.support.Title")],k);const C=k;let Rt=0;const ne=V.ofType(T);let m=class extends w{constructor(e){super(e),this.id=Date.now().toString(16)+"-slide-"+Rt++,this.title=new C,this.description=new U,this.hidden=!1,this.thumbnail=new L,this.viewpoint=null,this.basemap=null,this.ground=null,this.environment=new $,this.visibleLayers=new ne}destroy(){this.visibleLayers.removeAll(),this.basemap=null,this.thumbnail=_e(this.thumbnail),this.description=null,this.title=null,this.thumbnail=null}castTitle(e){return typeof e=="string"?new C({text:e}):H(C,e)}castDescription(e){return typeof e=="string"?new U({text:e}):H(U,e)}castThumbnail(e){return typeof e=="string"?new L({url:e}):H(L,e)}castBasemap(e){return ot(e)}set visibleLayers(e){this._set("visibleLayers",Se(e,this._get("visibleLayers"),ne))}castVisibleLayers(e){return e&&typeof e.map=="function"?e.map(t=>{if(typeof t=="string")return{id:t};if(t instanceof Ue){const i=ve(t);return{id:t.id,sublayerIds:i}}return t.id?{id:t.id,sublayerIds:"sublayerIds"in t?t.sublayerIds:void 0}:(R.getLogger(this).warn('Invalid visible layer, expected { id }, Layer or "id"'),t)}):null}clone(){var e,t;return new this.constructor({id:this.id,title:this.title.clone(),thumbnail:this.thumbnail.clone(),description:this.description&&this.description.clone()||null,viewpoint:this.viewpoint&&this.viewpoint.clone()||null,basemap:((e=this.basemap)==null?void 0:e.clone())||null,ground:((t=this.ground)==null?void 0:t.clone())||null,visibleLayers:this.visibleLayers.clone(),environment:this.environment&&this.environment.clone()||null,hidden:this.hidden})}async _updateVisibleLayersFrom(e){const t=[];await Promise.allSettled(this._getLayers(e.map).map(i=>e.whenLayerView(i).then(r=>{if(r.visible){const s=ve(i);t.push(new T({id:r.layer.id,sublayerIds:s}))}})).toArray()),this.visibleLayers.removeAll(),this.visibleLayers.addMany(t)}updateFrom(e,t){const i={format:"png",quality:80,width:120,height:75,disableDecorations:!0,...t==null?void 0:t.screenshot};return e.when(()=>(this.viewpoint=e.viewpoint.clone(),this.environment.lighting=e.environment.lighting.type==="virtual"?gt.prototype.clone.apply(e.environment.lighting):Le.prototype.clone.apply(e.environment.lighting),this.environment.weather=e.environment.weather.clone(),this.basemap=e.map.basemap&&e.map.basemap.clone()||null,this.ground=e.map.ground?$e.fromGround(e.map.ground):null,this._updateVisibleLayersFrom(e))).then(()=>e.takeScreenshot(i)).then(r=>(this.thumbnail=new L({url:r.dataUrl}),this))}async applyTo(e,t){this._applyToController!=null&&this._applyToController.abort();let i=new AbortController;this._applyToController=i;const r=xe(t,()=>i==null?void 0:i.abort()),s=e.resourceController.scheduler.registerTask(vt.SLIDE);let a=!1;const p={animate:!0,...t,signal:this._applyToController.signal},d=async()=>{await Promise.all([s.schedule(async()=>a=await this._setViewpointOfInterest(e,p)),s.schedule(()=>this._applyBasemap(e,p),p.signal)]),await this._loadLayersWithSublayerVisibility(e),await Promise.all([s.schedule(()=>this._applyLayerVisibility(e),p.signal),s.schedule(()=>this._applyGround(e),p.signal),s.schedule(()=>this._applyViewpoint(e,p),p.signal)]),await s.schedule(()=>e.environment.weather=this.environment.weather.clone())},h=await Ne(e.addUpdatingPromise(d()));if(a&&(e.contentCamera=null),s.remove(),this._applyToController===i&&(this._applyToController=null),i=null,r==null||r.remove(),h.ok===!1)throw h.error;return this}async _applyBasemap(e,t){if(this.basemap){try{await this.basemap.load(t)}catch(i){if(ke(i))throw i}e.map.basemap=lt(this.basemap,e.map.basemap)}}_applyGround(e){this.ground&&(e.map.ground=this.ground.cloneAndApplyTo(e.map.ground))}_getLayers(e){const t=new V;return this._collectLayers(e,t),this._collectLayers(e.ground,t),t}_collectLayers(e,t){e.layers.forEach(i=>{i.persistenceEnabled&&(t.add(i),"layers"in i&&this._collectLayers(i,t))})}async _loadLayersWithSublayerVisibility(e){this.visibleLayers&&await Promise.allSettled(this._getLayers(e.map).items.map(t=>{var r;return((r=this.visibleLayers.find(s=>s.id===t.id))==null?void 0:r.sublayerIds)?t.load():null}))}_applyLayerVisibility(e){this.visibleLayers&&this._getLayers(e.map).forEach(t=>{const i=this.visibleLayers.find(a=>a.id===t.id);t.visible=i!=null;const r=i==null?void 0:i.sublayerIds,s=Te(t);r&&s&&s.forEach(a=>a.visible=r.includes(a.id))})}async _setViewpointOfInterest(e,t){if(e.state.fixedContentCamera||!this.viewpoint||t!=null&&t.ignoreViewpoint||!(t!=null&&t.useDestinationCamera))return!1;const{toCameraAsync:i}=await Ie(()=>import("./viewpointUtils-245ed782.js").then(s=>s.c),["assets/viewpointUtils-245ed782.js","assets/Viewpoint-f83262d0.js","assets/index-b516d057.js","assets/index-b252abd2.css","assets/Cyclical-4c223a04.js","assets/projectPointToVectorWithEngine-f608a34a.js","assets/dehydratedPoint-5a1dfed5.js","assets/projectVectorToPoint-fbaf5599.js","assets/projectVectorToVector-56c29b20.js","assets/frustum-f9d53cdf.js","assets/scaleUtils-72744379.js","assets/Intersector-fa865806.js","assets/ViewingMode-5d7d590b.js","assets/boundedPlane-1da2f094.js","assets/verticalOffsetUtils-e5214af9.js","assets/orientedBoundingBox-67c5cd22.js","assets/earthUtils-ef4b5643.js","assets/ElevationProvider-abb53936.js","assets/spatialReferenceSupport-5aeb751c.js"]),r=await i(e,this.viewpoint);return e.contentCamera=r,r!=null}async _applyViewpoint(e,t){if(this._applyCachedCameraTrackingEnabled(e),this.viewpoint&&!t.ignoreViewpoint){this.viewpoint.camera!=null&&(this.viewpoint.camera.fov=e.camera.fov);const i=this.environment.lighting;if(t.animate&&i.type==="sun"&&i.date)return this._animateToLighting(e,t);t.animate&&(e.environment.applyLighting(i.clone()),await e.goTo(this.viewpoint,t)),e.viewpoint=this.viewpoint}e.environment.applyLighting(this.environment.lighting.clone())}async _animateToLighting(e,t){let i=null;return e.environment.lighting.type!=="virtual"&&this.environment.lighting.type!=="virtual"&&(e.viewingMode==="global"&&(i=this._animateLightingWithCamera(e,e.environment.lighting,this.environment.lighting)),e.environment.cachedCameraTrackingEnabled=e.environment.lighting.cameraTrackingEnabled,e.environment.lighting.cameraTrackingEnabled=!1),e.environment.lighting.directShadowsEnabled=this.environment.lighting.directShadowsEnabled,this.environment.lighting.type==="virtual"||e.environment.lighting.type==="virtual"?(e.environment.applyLighting(this.environment.lighting.clone()),e.environment.lighting.type!=="virtual"&&(e.environment.cachedCameraTrackingEnabled=e.environment.lighting.cameraTrackingEnabled,e.environment.lighting.cameraTrackingEnabled=!1)):this.environment.lighting.displayUTCOffset!=null&&(e.environment.lighting.displayUTCOffset=this.environment.lighting.displayUTCOffset),e.goTo(this.viewpoint,t).then(()=>{this._applyCachedCameraTrackingEnabled(e),e.environment.applyLighting(this.environment.lighting.clone())}).catch(r=>{throw e.animation==null&&this._applyCachedCameraTrackingEnabled(e),r}).finally(()=>{Ge(i)})}_applyCachedCameraTrackingEnabled(e){e.environment.cachedCameraTrackingEnabled!=null&&(e.environment.lighting.cameraTrackingEnabled=e.environment.cachedCameraTrackingEnabled,e.environment.cachedCameraTrackingEnabled=null)}_getTime(e){return[e.getTime(),3600*e.getUTCHours()+60*e.getUTCMinutes()+e.getUTCSeconds()]}_setTime(e,t,i){return e.setTime(t),e.setUTCHours(i/3600),e.setUTCMinutes(i%3600/60),e.setUTCSeconds(i%3600%60),e}_animateLightingWithCamera(e,t,i){const r=new Date(t.date.toString()),[s,a]=this._getTime(r),[p,d]=this._getTime(i.date),h=Ct(a,d),l=e.renderCoordsHelper,y=z();l.toRenderCoords(e.camera.position,y);const v=z(),J=z();this.viewpoint.camera!=null&&l.toRenderCoords(this.viewpoint.camera.position,v);const Ve=new Date;return Fe(()=>e.camera,Ee=>{l.toRenderCoords(Ee.position,J);const D=ce(y,J),pe=ce(v,J);let K=0;D+pe!==0&&(K=D/(D+pe));const Pe=s+(p-s)*K,Oe=Vt(a,h*K);t.date=this._setTime(Ve,Pe,Oe)})}static createFrom(e,t){return new this().updateFrom(e,t)}};function Te(e){if(e.type==="building-scene"||e.type==="map-image")return e.allSublayers.toArray()}function ve(e){const t=Te(e);if(t)return t.filter(i=>i.visible).map(i=>i.id)}n([o({type:String,json:{write:{isRequired:!0}}})],m.prototype,"id",void 0),n([o({type:C,json:{default:()=>new C({text:""}),write:{isRequired:!0}}})],m.prototype,"title",void 0),n([I("title")],m.prototype,"castTitle",null),n([o({type:U,json:{write:{overridePolicy:e=>({enabled:!(!e||!e.text)})}}})],m.prototype,"description",void 0),n([I("description")],m.prototype,"castDescription",null),n([o({type:Boolean,nonNullable:!0,json:{write:!0,default:!1}})],m.prototype,"hidden",void 0),n([o({type:L,json:{default:()=>new L({url:""}),write:{isRequired:!0}}})],m.prototype,"thumbnail",void 0),n([I("thumbnail")],m.prototype,"castThumbnail",null),n([o({type:le,nonNullable:!0,json:{write:{isRequired:!0}}})],m.prototype,"viewpoint",void 0),n([o({type:wt,json:{read:{source:"baseMap"},write:{target:"baseMap"}}})],m.prototype,"basemap",void 0),n([I("basemap")],m.prototype,"castBasemap",null),n([o({type:$e,json:{write:!0}})],m.prototype,"ground",void 0),n([o({type:ne,json:{write:{isRequired:!0}}})],m.prototype,"visibleLayers",null),n([I("visibleLayers")],m.prototype,"castVisibleLayers",null),n([o({type:$,json:{write:!0}})],m.prototype,"environment",void 0),m=n([g("esri.webscene.Slide")],m);const se=86400,be=43200;function Ct(e,t){let i=t-e;return i>be&&(i-=se),i<-be&&(i+=se),i}function Vt(e,t){return We(e+t,se)}const Et=m,ae=V.ofType(Et);let G=class extends w{constructor(e){super(e),this.slides=new ae}destroy(){this.slides.forEach(e=>e.destroy()),this.slides.removeAll()}set slides(e){e&&(e=e.filter(t=>!!t.viewpoint)),this._set("slides",Se(e,this._get("slides"),ae))}clone(){return new this.constructor({slides:this.slides.clone()})}};n([o({type:ae,nonNullable:!0,json:{write:!0}}),I(qe)],G.prototype,"slides",null),G=n([g("esri.webscene.Presentation")],G);const Re=G;var oe;let A=oe=class extends w{constructor(e){super(e)}clone(){return new oe({name:this.name,path:this.path,title:this.title})}};n([o({type:String,json:{write:!0}})],A.prototype,"name",void 0),n([o({type:String,json:{write:!0}})],A.prototype,"path",void 0),n([o({type:String,json:{write:!0}})],A.prototype,"title",void 0),A=oe=n([g("esri.webscene.TransportationNetwork")],A);const Pt=A;class B extends St{constructor(t,i){super(t,i,"webscene")}get supportsGround(){return this.since(1,8)}get supportsVisibleElevationLayersInSlides(){return this.lessThan(1,8)}}let Ot=null;function jt(){return Ot}var Ce;const S=new B(1,32),Mt=()=>{const t=[],i=S.major;for(let r=8;r<=S.minor;r++)t.push(`${i}.${r}`);return t},X="Web Scene";let c=class extends Be.LoadableMixin(Je(De(rt))){constructor(e){super(e),this[Ce]=!0,this._layersIdGCTimeoutId=void 0,this._updateFromPromise=null,this.applicationProperties=null,this.clippingArea=null,this.clippingEnabled=!1,this.floorInfo=null,this.heightModelInfo=void 0,this.sourceVersion=null,this.transportationNetworks=null,this.presentation=new Re,this.initialViewProperties=new q,this.portalItem=null,this.resourceInfo=null,this._debouncedSaveOperations=Ke(async(t,i,r)=>{switch(t){case E.SAVE:return this._saveImpl(i);case E.SAVE_AS:return this._saveAsImpl(r,i)}}),this._resourceReferences={portalItem:null,paths:[]},this.authoringApp=null,this.authoringAppVersion=null,this._isAuthoringAppSetByUser=!1,this._isAuthoringAppVersionSetByUser=!1}initialize(){if(this.when().catch(e=>{R.getLogger(this).error("#load()","Failed to load web scene",e)}),this.resourceInfo){let e;try{e=this._validateJSON(this.resourceInfo)}catch(t){return void this.addResolvingPromise(Promise.reject(t))}this.read(e),this.addResolvingPromise(this._validateSpatialReference()),this.addResolvingPromise(this._validateHeightModelInfo())}this.addHandles(He(()=>this.allLayers,"change",()=>this._scheduleLayersIdGC()))}destroy(){this._unscheduleLayersIdGC(),this.presentation&&this.presentation.destroy(),this.portalItem=_e(this.portalItem)}writeClippingArea(e,t){t.clippingArea||(t.clippingArea={}),t.clippingArea.geometry=e.toJSON()}readClippingEnabled(e,t){return!!t.clippingArea&&!!t.clippingArea.clip}writeClippingEnabled(e,t){this.clippingArea&&(t.clippingArea||(t.clippingArea={}),t.clippingArea.clip=e)}writeLayers(e,t,i,r){t[i]=this._layersToJSON(e,"operational-layers",r)}readSourceVersion(e,t){const[i,r]=t.version.split(".");return new B(parseInt(i,10),parseInt(r,10))}writeSourceVersion(e,t,i){t[i]=`${S.major}.${S.minor}`}writeTables(e,t,i,r){const s=this._layersToJSON(e,"tables",r);s.length&&(t[i]=s)}get thumbnailUrl(){var e;return((e=this.portalItem)==null?void 0:e.thumbnailUrl)??null}set thumbnailUrl(e){e?this._override("thumbnailUrl",e):(this._clearOverride("thumbnailUrl"),this.clear("thumbnailUrl","user"))}set authoringApp(e){this._isAuthoringAppSetByUser=!0,this._set("authoringApp",e)}writeAuthoringApp(e,t){e&&this._isAuthoringAppSetByUser?t.authoringApp=e:t.authoringApp="ArcGIS API for JavaScript"}set authoringAppVersion(e){this._isAuthoringAppVersionSetByUser=!0,this._set("authoringAppVersion",e)}writeAuthoringAppVersion(e,t){e&&this._isAuthoringAppVersionSetByUser?t.authoringAppVersion=e:t.authoringAppVersion=ze}writeGround(e,t,i,r){t[i]=e?e.write({},r):{transparency:0,layers:[]}}readInitialViewProperties(e,t){var r,s;const i={};return(r=t.initialState)!=null&&r.environment&&(i.environment=W.fromJSON(t.initialState.environment)),i.spatialReference=t.spatialReference?f.fromJSON(t.spatialReference):f.WebMercator,i.viewingMode=t.viewingMode??"global",(s=t.initialState)!=null&&s.viewpoint&&(i.viewpoint=le.fromJSON(t.initialState.viewpoint)),new q(i)}get spatialReference(){var e;return((e=this.initialViewProperties)==null?void 0:e.spatialReference)??f.WebMercator}get viewingMode(){var e;return((e=this.initialViewProperties)==null?void 0:e.viewingMode)??"global"}load(e){const t=this.ground;return this.addResolvingPromise(this._loadFromSource().then(()=>{t&&t!==this.ground&&t.destroy()})),Promise.resolve(this)}loadAll(){return nt(this,e=>{const t=this.presentation&&this.presentation.slides;e(this.ground,this.basemap,this.layers,t&&t.map(i=>i.basemap),this.tables)})}read(e,t){var s;t={...t,origin:"web-scene"};const i=this._isAuthoringAppVersionSetByUser,r=this._isAuthoringAppSetByUser;if(Qe(this,e,a=>super.read(e,a),t),r||(this._isAuthoringAppSetByUser=!1),i||(this._isAuthoringAppVersionSetByUser=!1),e.baseMap&&Array.isArray(e.baseMap.elevationLayers)&&((s=this.sourceVersion)==null?void 0:s.supportsVisibleElevationLayersInSlides)){const a=e.baseMap.elevationLayers.map(l=>({id:l.id})),p=this.presentation.slides,d=(l,y)=>l.visibleLayers.some(v=>v.id===y),h=a.filter(l=>!p.some(y=>d(y,l.id)));p.forEach(l=>{l.visibleLayers.addMany(h)})}}_writeBasemapElevationLayers(e){var i;const t=(i=e.ground)==null?void 0:i.layers;!e.baseMap&&(t!=null&&t.length)&&(e.baseMap={title:"Basemap",baseMapLayers:[]}),e.baseMap&&(e.baseMap.elevationLayers=F(t))}_layersToJSON(e,t,i){const r={...i,layerContainerType:t};return e.map(s=>this._verifyWritableLayer(s,i)?s.write({},r):null).filter(s=>!!s).toArray()}_verifyWritableLayer(e,t){return!!e.persistenceEnabled&&("write"in e||(t!=null&&t.messages&&t.messages.push(new u("layer:unsupported",`Layers (${e.title}, ${e.id}) of type '${e.declaredClass}' cannot be persisted in web scenes`,{layer:e})),!1))}write(e,t){var s;if(this.loadStatus!=="loaded"){const a=new u("webscene:not-loaded","Web scene must be loaded before it can be serialized");throw R.getLogger(this).error("#toJSON()","Web scene must be loaded before it can be serialized",this.loadError||this.loadStatus),a}this._runLayersIdGC();const i=!(t!=null&&t.messages);t={messages:[],...t,origin:"web-scene"};const r=super.write(e,t);if(i){const a=((s=t.messages)==null?void 0:s.filter(p=>p.name==="web-document-write:property-required"))??[];if(a.length){const p=new u("web-document:property-required","One or more properties that are required in the webscene JSON are missing, see details for the specific errors",{errors:a});throw R.getLogger(this).error("#toJSON()","One or more properties that are required in the webscene JSON are missing",a),p}}return this._writeBasemapElevationLayers(r),r}async save(e){return this._debouncedSaveOperations(E.SAVE,e)}async _saveImpl(e){var s;if(!this.portalItem)throw new u("webscene:portal-item-not-set","Portal item to save to has not been set on the WebScene");if(we(this.portalItem),((s=this.portalItem)==null?void 0:s.type)!==X)throw new u("webscene:portal-item-wrong-type",`Portal item needs to have type "${X}"`);const t=this._updateFromPromise;await this._ensureLoadBeforeSave();const i=this._enableVerifyItemRelativeUrls({origin:"web-scene",url:this.portalItem.itemUrl?P(this.portalItem.itemUrl):null,messages:[],portal:this.portalItem.portal??O.getDefault(),portalItem:this.portalItem,writtenProperties:[],blockedRelativeUrls:[],resources:{toAdd:[],toUpdate:[],toKeep:[],pendingOperations:[]}}),r=this.write({},i);return await Promise.all(i.resources.pendingOperations),await this._verifySave(r,i,e),this._updateTypeKeywords(this.portalItem),await ut(this.portalItem,r,this._resourceReferences,i,null),ue(i),t&&await t,await this._saveThumbnail(),this.portalItem}async saveAs(e,t){return this._debouncedSaveOperations(E.SAVE_AS,t,e)}async _saveAsImpl(e,t){let i=Ae.from(e);if(!i)throw new u("webscene:portal-item-required","saveAs requires a portal item to save to");we(i),i.id&&(i=i.clone(),i.id=null);const r=i.portal||O.getDefault();await this._ensureLoadBeforeSave(),i.type=X,i.portal=r;const s=this._enableVerifyItemRelativeUrls({origin:"web-scene",url:null,messages:[],portal:r,portalItem:i,writtenProperties:[],blockedRelativeUrls:[],resources:{toAdd:[],toUpdate:[],toKeep:[],pendingOperations:[]}}),a=this.write({},s);await Promise.all(s.resources.pendingOperations),await this._verifySaveAs(a,s,t);const p=this.thumbnailUrl,d=!this._isOverridden("thumbnailUrl");if(this._updateTypeKeywords(i),await r.signIn(),!r.user)throw new u("webscene:user-not-signed-in","saveAs requires a user to be signed in to the portal");return await r.user.addItem({item:i,folder:t==null?void 0:t.folder,data:a}),await mt(this._resourceReferences,s,null),this.portalItem=i,Xe.prototype.read.call(this,{version:a.version,authoringApp:a.authoringApp,authoringAppVersion:a.authoringAppVersion},{name:"web-scene",ignoreDefaults:!0,url:i.itemUrl?P(i.itemUrl):void 0}),ue(s),p&&(this.thumbnailUrl=d?Ze(p,"w","8192"):p),s.portalItem=i,await this._saveThumbnail(),i}async _saveThumbnail(){var e;this._isOverridden("thumbnailUrl")&&(await((e=this.portalItem)==null?void 0:e.updateThumbnail({thumbnail:this.thumbnailUrl})),this._clearOverride("thumbnailUrl"),this.clear("thumbnailUrl","user"))}_verifySave(e,t,i,r=!1){var h;if(!Ye(this.spatialReference))return Promise.reject(new u("webscene:unsupported-spatial-reference","Webscenes using spatial reference systems from Mars or Moon can not be saved currently."));let s,a=((h=t.messages)==null?void 0:h.filter(l=>l.type==="error").map(l=>new u(l.name,l.message,l.details)))??[];t.blockedRelativeUrls&&(a=a.concat(t.blockedRelativeUrls.map(l=>new u("url:unsupported",`Relative url '${l}' is not supported in Web Scene`)))),i&&i.ignoreUnsupported&&(a=a.filter(l=>l.name!=="layer:unsupported"&&l.name!=="symbol:unsupported"&&l.name!=="symbol-layer:unsupported"&&l.name!=="property:unsupported"&&l.name!=="url:unsupported"&&l.name!=="scenemodification:unsupported")),i!=null&&i.requiredPropertyChecksDisabled&&(a=a.filter(l=>l.name!=="web-document-write:property-required"));const p=!!(i!=null&&i.strictSchemaValidationEnabled),d=jt();return s=p&&d?d().then(l=>{const y=l.validate(e);if(y.length>0){const v=`webscene did not validate:
${y.join(`
`)}`;R.getLogger(this).error(`${r?"saveAs":"save"}(): ${v}`)}return y.map(v=>new u("webscene:schema-validation",v))}).then(l=>{if(l.length>0)throw $t(l.concat(a));return a}):Promise.resolve(a),s.then(l=>{if(l.length>0)throw new u("webscene:save","Failed to save webscene due to unsupported or invalid content. See 'details.errors' for more detailed information",{errors:l})})}_verifySaveAs(e,t,i){return this.canNotSaveAs(t)?Promise.reject(Lt()):this._verifySave(e,t,i,!0)}verifySaveAs(e){const t=this._enableVerifyItemRelativeUrls({origin:"web-scene",messages:[]}),i=this.write({},t);return this._verifySaveAs(i,t,e)}canNotSaveAs(e){var t,i;return e||(e=this._enableVerifyItemRelativeUrls({origin:"web-scene",messages:[]}),this.write({},e)),(((i=(t=e.verifyItemRelativeUrls)==null?void 0:t.writtenUrls)==null?void 0:i.length)??0)>0}async updateFrom(e,t={}){const i=this._updateFrom(e,t);this._updateFromPromise=i,await i,this._updateFromPromise===i&&(this._updateFromPromise=null)}async _updateFrom(e,t={}){if(await e.whenReady(),!t.environmentExcluded&&e.environment&&(this.initialViewProperties.environment=W.prototype.clone.apply(e.environment)),!t.viewpointExcluded&&e.viewpoint&&(this.initialViewProperties.viewpoint=e.viewpoint.clone()),this.initialViewProperties.spatialReference=e.spatialReference.clone(),this.initialViewProperties.viewingMode=e.viewingMode,e.clippingArea!=null?e.clippingArea!==this.clippingArea&&(this.clippingArea=e.clippingArea.clone(),this.clippingEnabled=!0):this.clippingEnabled=!1,e.heightModelInfo&&(this.heightModelInfo=e.heightModelInfo.clone()),e.map===this)for(const i of e.allLayerViews){const r="visible";r in i&&r in i.layer&&i._isOverridden(r)&&(i.layer[r]=i[r])}(t.thumbnailExcluded===!1||t.thumbnailExcluded==null&&!t.viewpointExcluded)&&await this._updateFromThumbnail(e,t.thumbnailSize??void 0)}async _updateFromThumbnail(e,t){const i=ct(e,t),r=await e.takeScreenshot({format:"jpg",width:i.width,height:i.height,disableDecorations:!0});this.thumbnailUrl=r.dataUrl}_loadFromSource(){var e;return this.resourceInfo?this._loadFromJSON(this.resourceInfo,{origin:"web-scene"}):(e=this.portalItem)!=null&&e.id?this._loadFromItem(this.portalItem):this._loadObjectsWithLayers()}_readAndLoadFromJSON(e,t){const i=this._validateJSON(e);return this.read(i,t),this._loadFromJSON(i,t)}_extractOperationalLayers(e){var s;const t=[];if(!((s=this.sourceVersion)!=null&&s.supportsGround)&&e.baseMap&&Array.isArray(e.baseMap.elevationLayers))for(const a of e.baseMap.elevationLayers)t.push(a);const i=[],r=a=>{var p;return a.layers&&(a.layers=a.layers.filter(r)),a.layerType!=="ArcGISTiledElevationServiceLayer"||((p=this.sourceVersion)!=null&&p.supportsGround||i.push(a),!1)};return{operationalLayers:e.operationalLayers?e.operationalLayers.filter(r):[],operationalElevationLayers:i,basemapElevationLayers:t}}async _loadFromJSON(e,t){var l;const i=new V;await this._validateSpatialReference(),await this._validateHeightModelInfo();const{populateOperationalLayers:r}=await Ie(()=>import("./layersCreator-0c047b3d.js"),["assets/layersCreator-0c047b3d.js","assets/index-b516d057.js","assets/index-b252abd2.css","assets/portalLayers-88006a68.js","assets/associatedFeatureServiceUtils-158b7391.js","assets/lazyLayerLoader-edff256b.js","assets/styleUtils-a3d96bf6.js"]),{operationalLayers:s,operationalElevationLayers:a,basemapElevationLayers:p}=this._extractOperationalLayers(e),d=[],h={context:{...t,layerContainerType:"operational-layers"}};if(this.portalItem&&(h.context.portal=this.portalItem.portal||O.getDefault()),p.length>0){const y={...h,context:{...h.context,layerContainerType:"ground"}};y.defaultLayerType="ArcGISTiledElevationServiceLayer",d.push(r(this.ground.layers,p,y))}if(a.length>0){const y={...h,context:{...h.context,layerContainerType:"ground"}};y.defaultLayerType="ArcGISTiledElevationServiceLayer",d.push(r(i,a,y))}s&&s.length>0&&d.push(r(this.layers,s,h)),(l=e.tables)!=null&&l.length&&d.push(r(this.tables,e.tables,{...h,context:{...h.context,layerContainerType:"tables"},defaultLayerType:"ArcGISFeatureLayer"})),await Promise.allSettled(d),await this._loadObjectsWithLayers(),this.ground.layers.addMany(i)}async _ensureLoadBeforeSave(){await this.load(),await this._loadObjectsWithLayers();const e=[],t=[...this.allLayers.items];for(const{basemap:i}of this.presentation.slides.items)i&&(t.push(...i.baseLayers.items),t.push(...i.referenceLayers.items));for(const i of t)if("beforeSave"in i&&typeof i.beforeSave=="function"){const r=i.beforeSave();r&&e.push(r)}await Promise.allSettled(e)}async _loadObjectsWithLayers(){const e=[];this.ground&&e.push(this.ground.load()),this.basemap&&e.push(this.basemap.load()),this.presentation.slides.forEach(t=>{t.basemap&&e.push(t.basemap.load())}),await Promise.allSettled(e)}async _loadFromItem(e){if(await e.load().catch(r=>{throw new u("webscene:load-portal-item","Failed to load portal item",{error:r})}),e.type!=="Web Scene")throw new u("webscene:invalid-portal-item","Invalid portal item type '${type}', expected 'Web Scene'",{type:e.type});const t=await e.fetchData();this.resourceInfo=t;const i={origin:"web-scene",url:P(e.itemUrl),portal:e.portal||O.getDefault(),portalItem:e,readResourcePaths:[]};await this._readAndLoadFromJSON(t,i),this._resourceReferences={portalItem:e,paths:i.readResourcePaths??[]}}_validateSpatialReference(){const e=this.initialViewProperties,t=this._sceneSpatialReference;let i;if(e.viewingMode!=="local"){if(!ge(t,ye.Global))return Promise.reject(new u("webscene:unsupported-spatial-reference","Unsupported spatial reference (${spatialReference.wkid}) in global mode, only Web Mercator, WGS84 GCS or CGCS2000 are supported",{spatialReference:t,viewingMode:e.viewingMode}));i=d=>!d||it(d,t)}else{if(!ge(t,ye.Local))return Promise.reject(new u("webscene:unsupported-spatial-reference","Unsupported spatial reference (${spatialReference.wkid}) in local mode, only projected coordinate systems are supported",{spatialReference:t,viewingMode:e.viewingMode}));i=d=>!d||d.equals(t)}const r=d=>{var h,l;return((h=d==null?void 0:d.camera)==null?void 0:h.position.spatialReference)??((l=d==null?void 0:d.targetGeometry)==null?void 0:l.spatialReference)},s=e.viewpoint,a=r(s);if(a&&!i(a))return Promise.reject(new u("webscene:incompatible-camera-spatial-reference","Camera spatial reference (${cameraSpatialReference.wkid}) is incompatible with the scene spatial reference (${sceneSpatialReference.wkid})",{cameraSpatialReference:a,sceneSpatialReference:t,viewingMode:e.viewingMode}));const p=this.presentation.slides.find(d=>!i(r(d.viewpoint)));if(p){const d=r(p.viewpoint);return Promise.reject(new u("webscene:incompatible-slide-spatial-reference","Slide spatial reference (${slideSpatialReference.wkid}) is incompatible with the scene spatial reference (${sceneSpatialReference.wkid})",{slideSpatialReference:d,sceneSpatialReference:t,viewingMode:e.viewingMode}))}return Promise.resolve()}_validateHeightModelInfo(){const e=this._sceneSpatialReference,t=at(this.heightModelInfo,e);return t?Promise.reject(t):Promise.resolve()}_validateJSON(e){const t=B.parse(e.version||"","webscene");return S.validate(t),e.version=`${t.major}.${t.minor}`,t.major===1&&t.minor<=2&&(e.spatialReference=f.WebMercator.toJSON()),e}_updateTypeKeywords(e){de(e,he.LOCAL_SCENE,this.initialViewProperties.viewingMode==="local"),de(e,he.DEVELOPER_BASEMAP,me(this.basemap)||this.presentation.slides.some(({basemap:t})=>!!t&&me(t))),e.typeKeywords&&(e.typeKeywords=e.typeKeywords.filter((t,i,r)=>r.indexOf(t)===i))}get _sceneSpatialReference(){return this.initialViewProperties.spatialReference||f.WebMercator}get _verifyItemRelativeRootPath(){var e;return(e=this.portalItem)!=null&&e.itemUrl?P(this.portalItem.itemUrl).path:null}_enableVerifyItemRelativeUrls(e){const t=this._verifyItemRelativeRootPath;return t&&(e.verifyItemRelativeUrls={rootPath:t,writtenUrls:[]}),e}_unscheduleLayersIdGC(){this._layersIdGCTimeoutId&&(clearTimeout(this._layersIdGCTimeoutId),this._layersIdGCTimeoutId=0)}_scheduleLayersIdGC(){this._unscheduleLayersIdGC(),this._layersIdGCTimeoutId=setTimeout(()=>{this._layersIdGCTimeoutId=0,this._runLayersIdGC()},3e3)}_runLayersIdGC(){var r,s;this._unscheduleLayersIdGC();const e=(s=(r=this.applicationProperties)==null?void 0:r.viewing)==null?void 0:s.search,t=a=>this.allLayers.some(p=>p.id===a&&p.persistenceEnabled);e&&e.layers&&(e.layers=e.layers.filter(a=>t(a.id)));const i=this.presentation&&this.presentation.slides;i&&i.forEach(a=>{a.visibleLayers&&(a.visibleLayers=a.visibleLayers.filter(p=>t(p.id)))})}static fromJSON(e){if(!e)throw new u("webscene:empty-resource","Expected a JSON resource but got nothing");return new this({resourceInfo:e})}};Ce=ht,c.version=`${S.major}.${S.minor}`,n([o({type:Tt,json:{write:!0}})],c.prototype,"applicationProperties",void 0),n([o({type:et,json:{read:{source:"clippingArea.geometry",reader:tt},write:{target:"clippingArea.geometry"}}})],c.prototype,"clippingArea",void 0),n([b("clippingArea")],c.prototype,"writeClippingArea",null),n([o({type:Boolean,json:{write:{target:"clippingArea.clip"}}})],c.prototype,"clippingEnabled",void 0),n([Q("clippingEnabled",["clippingArea"])],c.prototype,"readClippingEnabled",null),n([b("clippingEnabled")],c.prototype,"writeClippingEnabled",null),n([o({type:dt,json:{read:{source:"mapFloorInfo"},write:{target:"mapFloorInfo"}}})],c.prototype,"floorInfo",void 0),n([o({type:st,json:{write:!0}})],c.prototype,"heightModelInfo",void 0),n([o({json:{write:{target:"operationalLayers",ignoreOrigin:!0}}})],c.prototype,"layers",void 0),n([b("layers")],c.prototype,"writeLayers",null),n([o({readOnly:!0,type:B,json:{type:Mt(),write:{ignoreOrigin:!0,target:"version",isRequired:!0,overridePolicy:()=>({enabled:!0,allowNull:!0,ignoreOrigin:!0})}}})],c.prototype,"sourceVersion",void 0),n([Q("sourceVersion",["version"])],c.prototype,"readSourceVersion",null),n([b("sourceVersion")],c.prototype,"writeSourceVersion",null),n([o({json:{read:!1,write:{enabled:!0,ignoreOrigin:!0}}})],c.prototype,"tables",void 0),n([b("tables")],c.prototype,"writeTables",null),n([o()],c.prototype,"thumbnailUrl",null),n([o({type:String,json:{write:{writerEnsuresNonNull:!0,ignoreOrigin:!0}}})],c.prototype,"authoringApp",null),n([b("authoringApp")],c.prototype,"writeAuthoringApp",null),n([o({type:String,json:{write:{writerEnsuresNonNull:!0,ignoreOrigin:!0}}})],c.prototype,"authoringAppVersion",null),n([b("authoringAppVersion")],c.prototype,"writeAuthoringAppVersion",null),n([o({json:{write:{isRequired:!0,allowNull:!0,ignoreOrigin:!0,enabled:!0}}})],c.prototype,"ground",void 0),n([b("ground")],c.prototype,"writeGround",null),n([o({type:V.ofType(Pt),json:{write:!0}})],c.prototype,"transportationNetworks",void 0),n([o({type:Re,nonNullable:!0,json:{write:{ignoreOrigin:!0,writer:(e,t,i,r)=>{if(e.slides&&e.slides.length>0){const s={...r,isPresentation:!0};t.presentation=e.write({},s)}}}}})],c.prototype,"presentation",void 0),n([o({type:q,nonNullable:!0,json:{write:{target:"initialState",isRequired:!0,ignoreOrigin:!0},default:()=>new q({viewingMode:"global",spatialReference:f.WebMercator})}})],c.prototype,"initialViewProperties",void 0),n([Q("initialViewProperties",["initialState.environment","initialState.viewpoint","spatialReference","viewingMode"])],c.prototype,"readInitialViewProperties",null),n([o({type:f,json:{read:!1,write:{isRequired:!0,ignoreOrigin:!0}}})],c.prototype,"spatialReference",null),n([o({type:["local","global"],json:{read:!1,write:{isRequired:!0,ignoreOrigin:!0}}})],c.prototype,"viewingMode",null),n([o({type:Ae})],c.prototype,"portalItem",void 0),n([o()],c.prototype,"resourceInfo",void 0),c=n([g("esri.WebScene")],c);const mi=c;export{mi as default};
