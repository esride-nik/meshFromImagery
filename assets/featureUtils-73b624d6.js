import{an as R,dR as g,b3 as k,b5 as h,eW as D,gT as z,b4 as G,aL as O,dB as S,gU as T,fU as I,gV as p}from"./index-b516d057.js";import{Z as P,N as E}from"./utils-1a995f8e.js";const Q="esri.widgets.Feature.support.featureUtils",F=R.getLogger(Q),_=/href=(""|'')/gi,H=/(\{([^\{\r\n]+)\})/g,B=/\'/g,x=/^\s*expression\//i,V=/(\n)/gi,W=/[\u00A0-\u9999<>\&]/gim,J=/href\s*=\s*(?:\"([^\"]+)\"|\'([^\']+)\')/gi,K=/^(?:mailto:|tel:)/,j="relationships/",w=G("short-date-short-time");function we(e){if(e!=null)return(e.sourceLayer||e.layer)??void 0}async function Ne(e,n){return typeof e=="function"?e(n):e}function Ze(e=""){if(e)return!K.test(e.trim().toLowerCase())}function X(e){return!!e&&x.test(e)}function Y(e,n){if(!X(n)||!e)return null;const t=n.replace(x,"").toLowerCase();let r=null;return e.some(i=>i.name.toLowerCase()===t&&(r=i,!0)),r}function $e(e,n){const t=Y(n,e==null?void 0:e.fieldName);return t?t.title||null:e?e.label||e.fieldName:null}function ee(e,n){const t=n.get(e.toLowerCase());return`{${(t==null?void 0:t.fieldName)||e}}`}function ne(e){return e.replaceAll(_,"")}function C(e,n){const t=b(n,e);return t?t.name:e}function Ee(e,n){return e&&e.map(t=>C(t,n))}function b(e,n){return e&&typeof e.getField=="function"&&n?e.getField(n)??null:null}function q(e){return`${e}`.trim()}function xe({attributes:e,globalAttributes:n,layer:t,text:r,expressionAttributes:i,fieldInfoMap:o}){return r?te({formattedAttributes:n,template:le(r,{...n,...i,...e},t),fieldInfoMap:o}):""}function te({formattedAttributes:e,template:n,fieldInfoMap:t}){return q(ne(g(g(n,r=>ee(r,t)),e)))}function re(e,n,t=!1){const r=n[e];if(typeof r=="string"){const i="%27",o=(t?encodeURIComponent(r):r).replaceAll(B,i);n[e]=o}}function ie(e,n=!1){const t={...e};return Object.keys(t).forEach(r=>re(r,t,n)),t}function oe(e,n,t){const r=(n=q(n))&&n[0]!=="{";return g(e,ie(t,r||!1))}function ae(e,n){return e.replaceAll(H,(t,r,i)=>{const o=b(n,i);return o?`{${o.name}}`:r})}function le(e,n,t){const r=ae(e,t);return r&&r.replaceAll(J,(i,o,u)=>oe(i,o||u,n))}function ue(e,n){if(typeof e=="string"&&n&&n.dateFormat==null&&(n.places!=null||n.digitSeparator!=null)){const t=Number(e);if(!isNaN(t))return t}return e}function se(e){return e!=null&&typeof e=="object"&&"fieldsIndex"in e&&"geometryType"in e&&"getField"in e&&"load"in e&&"loaded"in e&&"objectIdField"in e&&"spatialReference"in e&&"type"in e&&(e.type==="feature"||e.type==="scene")&&"when"in e}function fe(e){return e!=null&&typeof e=="object"&&"createQuery"in e&&"queryFeatureCount"in e&&"queryObjectIds"in e&&"queryRelatedFeatures"in e&&"queryRelatedFeaturesCount"in e&&"relationships"in e}function A(e){return se(e)&&fe(e)}function je(e){return!!e&&typeof e=="object"&&"sourceLayer"in e&&A(e.sourceLayer)}function ce(e,n){var c;const{fieldInfos:t,fieldName:r,preventPlacesFormatting:i,layer:o,timeZone:u}=n,a=pe(t,r),l=b(o,r);if(a&&!T(r)){const f=l==null?void 0:l.type,d=(c=a.format)==null?void 0:c.dateFormat;if(f==="date"||f==="date-only"||f==="time-only"||f==="timestamp-offset"||d)return E(e,{format:d,fieldType:f,timeZoneOptions:{layerTimeZone:o&&"preferredTimeZone"in o?o.preferredTimeZone:null,viewTimeZone:u,datesInUnknownTimezone:!(!o||!("datesInUnknownTimezone"in o))&&!!o.datesInUnknownTimezone}})}const s=a==null?void 0:a.format;return typeof e=="string"&&T(r)&&s?de(e,s):typeof(e=ue(e,s))=="string"||e==null||s==null?M(e):I(e,i?{...p(s),minimumFractionDigits:0,maximumFractionDigits:20}:p(s))}function de(e,n){return e=e.trim(),/\d{2}-\d{2}/.test(e)?e:e.includes(",")?y(e,",",", ",n):e.includes(";")?y(e,";","; ",n):e.includes(" ")?y(e," "," ",n):I(Number(e),p(n))}function y(e,n,t,r){return e.trim().split(n).map(i=>I(Number(i),p(r))).join(t)}function pe(e,n){if(e!=null&&e.length&&n)return e.find(t=>{var r;return((r=t.fieldName)==null?void 0:r.toLowerCase())===n.toLowerCase()})}function me({fieldName:e,graphic:n,layer:t}){if(v(e)||!t||typeof t.getFeatureType!="function")return null;const{typeIdField:r}=t;if(!r||e!==r)return null;const i=t.getFeatureType(n);return i?i.name:null}function ye({fieldName:e,value:n,graphic:t,layer:r}){if(v(e)||!r||typeof r.getFieldDomain!="function")return null;const i=t&&r.getFieldDomain(e,{feature:t});return i&&i.type==="coded-value"?i.getName(n):null}function Ce(e,n,t,r){const{creatorField:i,creationDateField:o,editorField:u,editDateField:a}=e;if(!n)return;const l=k(r&&"preferredTimeZone"in r?r.preferredTimeZone:null,!(!r||!("datesInUnknownTimezone"in r))&&!!r.datesInUnknownTimezone,t,w,"date"),s={...w,...l},c=n[a];if(typeof c=="number"){const d=n[u];return{type:"edit",date:h(c,s),user:d}}const f=n[o];if(typeof f=="number"){const d=n[i];return{type:"create",date:h(f,s),user:d}}return null}function qe(e,n){const t=new Map;return e&&e.forEach(r=>{const i=C(r.fieldName,n);r.fieldName=i,t.set(i.toLowerCase(),r)}),t}function Ae(e){const n=[];if(!e)return n;const{fieldInfos:t,content:r}=e;return t&&n.push(...t),r&&Array.isArray(r)&&r.forEach(i=>{if(i.type==="fields"){const o=i==null?void 0:i.fieldInfos;o&&n.push(...o)}}),n}function Me(e){return e.replaceAll(W,n=>`&#${n.charCodeAt(0)};`)}function M(e){return typeof e=="string"?e.replaceAll(V,'<br class="esri-text-new-line" />'):e}function U(e){var f;const{value:n,fieldName:t,fieldInfos:r,fieldInfoMap:i,layer:o,graphic:u,timeZone:a}=e;if(n==null)return"";const l=ye({fieldName:t,value:n,graphic:u,layer:o});if(l)return l;const s=me({fieldName:t,graphic:u,layer:o});if(s)return s;if(i.get(t.toLowerCase()))return ce(n,{fieldInfos:r||Array.from(i.values()),fieldName:t,layer:o,timeZone:a});const c=(f=o==null?void 0:o.fieldsIndex)==null?void 0:f.get(t);return c&&(P(c)||O(c))?E(n,{fieldType:c.type,timeZoneOptions:{layerTimeZone:o&&"preferredTimeZone"in o?o.preferredTimeZone:null,viewTimeZone:a,datesInUnknownTimezone:!(!o||!("datesInUnknownTimezone"in o))&&!!o.datesInUnknownTimezone}}):M(n)}function Ue({fieldInfos:e,attributes:n,layer:t,graphic:r,fieldInfoMap:i,relatedInfos:o,timeZone:u}){const a={};return o==null||o.forEach(l=>he({attributes:a,relatedInfo:l,fieldInfoMap:i,fieldInfos:e,layer:t,timeZone:u})),n&&Object.keys(n).forEach(l=>{const s=n[l];a[l]=U({fieldName:l,fieldInfos:e,fieldInfoMap:i,layer:t,value:s,graphic:r,timeZone:u})}),a}async function ge(e,n){var c,f;const{layer:t,graphic:r,outFields:i,objectIds:o,returnGeometry:u,spatialReference:a}=e,l=o[0];if(typeof l!="number"&&typeof l!="string"){const d="Could not query required fields for the specified feature. The feature's ID is invalid.",m={layer:t,graphic:r,objectId:l,requiredFields:i};return F.warn(d,m),null}if(!((f=(c=D(t))==null?void 0:c.operations)!=null&&f.supportsQuery)){const d="The specified layer cannot be queried. The following fields will not be available.",m={layer:t,graphic:r,requiredFields:i,returnGeometry:u};return F.warn(d,m),null}const s=t.createQuery();return s.objectIds=o,s.outFields=i!=null&&i.length?i:[t.objectIdField],s.returnGeometry=!!u,s.returnZ=!!u,s.returnM=!!u,s.outSpatialReference=a,(await t.queryFeatures(s,n)).features[0]}async function Ie(e){var r;if(!((r=e.expressionInfos)!=null&&r.length))return!1;const n=await S(),{arcadeUtils:{hasGeometryFunctions:t}}=n;return t(e)}async function ve({graphic:e,popupTemplate:n,layer:t,spatialReference:r},i){if(!t||!n||(typeof t.load=="function"&&await t.load(i),!e.attributes))return;const o=e.attributes[t.objectIdField];if(o==null)return;const u=[o],a=await n.getRequiredFields(t.fieldsIndex),l=z(a,e),s=l?[]:a,c=n.returnGeometry||await Ie(n);if(l&&!c)return;const f=await ge({layer:t,graphic:e,outFields:s,objectIds:u,returnGeometry:c,spatialReference:r},i);f&&(f.geometry&&(e.geometry=f.geometry),f.attributes&&(e.attributes={...e.attributes,...f.attributes}))}function v(e=""){return!!e&&e.includes(j)}function be(e){return e?`${j}${e.layerId}/${e.fieldName}`:""}function N({attributes:e,graphic:n,relatedInfo:t,fieldInfos:r,fieldInfoMap:i,layer:o,timeZone:u}){e&&n&&t&&Object.keys(n.attributes).forEach(a=>{const l=be({layerId:t.relation.id.toString(),fieldName:a}),s=n.attributes[a];e[l]=U({fieldName:l,fieldInfos:r,fieldInfoMap:i,layer:o,value:s,graphic:n,timeZone:u})})}function he({attributes:e,relatedInfo:n,fieldInfoMap:t,fieldInfos:r,layer:i,timeZone:o}){var u,a;e&&n&&((u=n.relatedFeatures)==null||u.forEach(l=>N({attributes:e,graphic:l,relatedInfo:n,fieldInfoMap:t,fieldInfos:r,layer:i,timeZone:o})),(a=n.relatedStatsFeatures)==null||a.forEach(l=>N({attributes:e,graphic:l,relatedInfo:n,fieldInfoMap:t,fieldInfos:r,layer:i,timeZone:o})))}const Z=e=>{if(!e)return!1;const n=e.toUpperCase();return n.includes("CURRENT_TIMESTAMP")||n.includes("CURRENT_DATE")||n.includes("CURRENT_TIME")},L=({layer:e,method:n,query:t,definitionExpression:r})=>{var u,a;if(!((a=(u=e.capabilities)==null?void 0:u.query)!=null&&a.supportsCacheHint)||n==="attachments")return;const i=t.where!=null?t.where:null,o=t.geometry!=null?t.geometry:null;Z(r)||Z(i)||(o==null?void 0:o.type)==="extent"||t.resultType==="tile"||(t.cacheHint=!0)},Le=({query:e,layer:n,method:t})=>{L({layer:n,method:t,query:e,definitionExpression:`${n.definitionExpression} ${n.serviceDefinitionExpression}`})},Re=({queryPayload:e,layer:n,method:t})=>{L({layer:n,method:t,query:e,definitionExpression:`${n.definitionExpression} ${n.serviceDefinitionExpression}`})};function ke(e,n,t){return e&&n&&t?$(e.allLayers,n,t)||$(e.allTables,n,t):null}function $(e,n,t){const r=n.type==="scene"&&n.associatedLayer?n.associatedLayer.url:n.url;return e.filter(A).find(i=>i!==n&&i.url===r&&i.layerId===t.relatedTableId)}function De(e){const n=e.getObjectId();return n!=null?`oid:${n}`:`uid:${e.uid}`}export{Ze as C,xe as D,we as E,De as F,A as J,je as K,X as M,ae as P,Ee as R,ke as T,pe as Y,M as a,Re as b,ve as c,v as d,Le as h,Ae as i,Ce as n,Me as o,$e as q,qe as r,ge as s,Ue as u,C as v,Ne as x,te as z};
