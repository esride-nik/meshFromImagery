import{pK as He,pL as ze,aW as b,d8 as T,f5 as g,fu as Re,ft as Lt,fO as Gt,fq as It,jo as k,fC as F,fe as E,p4 as ee,gL as K,fv as ke,fx as Dt,fD as dt,jA as Ut,fw as Mt,a5 as d,a6 as p,a9 as G,bA as J,pM as ft,i0 as at,cb as v,dr as A,g9 as Ve,an as ie,dA as j,kd as Ee,kN as Le,d1 as st,a$ as Ge,h3 as tt,aZ as x,B as W,gA as wt,e_ as Pt,fk as ne,j3 as Ft,fn as ae,la as Ie,fa as se,gN as oe,f6 as re,db as ct,fr as Ue,fM as Fe,gO as je,gH as jt,gP as Bt,iN as le,ce as bt,gl as Nt,b9 as Tt,cc as At,pN as Ct,ao as de,gk as Be,n0 as Ne,gM as qe,n3 as X,kl as We,km as Ke,V as Je,gj as qt}from"./index-b516d057.js";import{s as Xe}from"./AnalysisView3D-3b0b8c91.js";import{t as _,r as Ye,u as Ze}from"./LengthDimension-61f692da.js";import{e as Qe}from"./getDefaultUnitForView-d1ffbf16.js";import{f as ce}from"./unitFormatUtils-67047561.js";import{e as ti}from"./dehydratedPoint-5a1dfed5.js";import{x as Z}from"./hydratedFeatures-2365c307.js";import{m as B,g as ei}from"./Segment-fd60ac10.js";import{x as ii,z as ni}from"./euclideanLengthMeasurementUtils-aa8fca96.js";import{s as Ot}from"./Cyclical-4c223a04.js";import{$ as _t,w as ai,e as H,D as pe,F as si,M as xt,O as rt}from"./manipulatorUtils-9334c98f.js";import{F as oi,H as ue,A as Ht}from"./dragEventPipeline3D-4663cd2c.js";import{D as ri,f as et,O as li,b as N,P as di}from"./RenderGeometry-5dbc1699.js";import{d as P}from"./Material-5f4156ac.js";import{g as me}from"./ImageMaterial-10c9471b.js";import{d as ot,R as zt,U as ci}from"./InteractiveToolBase-ddd44c70.js";import{u as he,t as R}from"./interfaces-0421c5e6.js";import{t as pi}from"./memoize-3e55df82.js";import{h as ui}from"./UpdatingHandles-7949a657.js";import{l as mi}from"./Factory-829a6ea7.js";import{O as hi}from"./SnappingVisualizer3D-493bdb16.js";import{u as I,r as gi,t as fi}from"./LineVisualElement-e3bb1937.js";import{d as _i}from"./VerticesVisualElement-efafb673.js";import{h as pt,R as vi,b as yi}from"./lineStippleUtils-0688e06c.js";import{V as Si,p as Mi,w as wi}from"./EditGeometryOperations-c2e73f2d.js";import{a as Pi}from"./SceneSnappingManagerPool-2ede5e56.js";import{e as bi}from"./SnappingContext-90969376.js";import{f as Ci}from"./SnappingDragPipelineStep-e275580d.js";import{p as Oi}from"./SnappingOperation-4a4ee09b.js";import{w as $i,e as Wt}from"./snappingUtils-93e84fbe.js";import{b as Di,t as Ti}from"./Intersector-fa865806.js";import{a as Ai}from"./AnalysisToolBase-71ee6ca9.js";import{c as xi}from"./screenUtils-8dc4a7f9.js";import{h as Hi}from"./quantityFormatUtils-e5b1c45f.js";import{r as zi,t as Ri}from"./vec4f32-0d1b2306.js";import{a as ki}from"./Object3DVisualElement-459b9b9c.js";import{A as ge}from"./ElevationQuery-a3eaf0a0.js";import{a as Vi,v as Ei,l as Li}from"./analysisViewUtils-9b921032.js";import"./VisualElement-187372ae.js";import"./viewUtils-9f810d02.js";import"./elevationInfoUtils-be36d866.js";import"./jsxFactory-92036771.js";import"./uuid-709b6c67.js";import"./TextOverlayItem-7f83875e.js";import"./projectVectorToVector-56c29b20.js";import"./measurementUtils-3881da59.js";import"./ElevationProvider-abb53936.js";import"./ray-8da55042.js";import"./ColorMaterial-bdf1f62a.js";import"./DefaultTechniqueConfiguration-b4dbe32f.js";import"./requestImageUtils-b142708c.js";import"./enums-bdecffa2.js";import"./Texture-bcb6d63f.js";import"./contextUtils-81fda295.js";import"./interfaces-8918b36f.js";import"./FramebufferObject-123b7c8d.js";import"./ShaderTechniqueConfiguration-2502462e.js";import"./InterleavedLayout-d76b0d59.js";import"./types-1305598a.js";import"./VerticalOffset.glsl-5743f98e.js";import"./OrderIndependentTransparency-755f7dcc.js";import"./ViewingMode-5d7d590b.js";import"./verticalOffsetUtils-e5214af9.js";import"./orientedBoundingBox-67c5cd22.js";import"./vec3f32-bac7ea57.js";import"./weather-2eb64924.js";import"./RenderState-1d6218ee.js";import"./NestedMap-1b5db22e.js";import"./frustum-f9d53cdf.js";import"./VertexElementDescriptor-2925c6af.js";import"./VertexArrayObject-d19dab8d.js";import"./Octree-7cea9440.js";import"./floatRGBA-ca990bbb.js";import"./Intersector-2e1d9db3.js";import"./glUtil-ce5ee52b.js";import"./Scheduler-ff5943a4.js";import"./signal-51ed66f5.js";import"./debugFlags-9a30f077.js";import"./interfaces-1a80c8eb.js";import"./drawUtils-bd7471ac.js";import"./ExtendedLineVisualElement-451ab04d.js";import"./EngineVisualElement-43f3e8cb.js";import"./LaserlineVisualElement-c0026af2.js";import"./PointVisualElement-11117df9.js";import"./RightAngleQuadVisualElement-95156bc2.js";import"./geometry2dUtils-a99dcf3d.js";import"./SnappingManager-aa70fdd4.js";import"./FeatureFilter-55dd341e.js";import"./Query-071039d7.js";import"./FullTextSearch-12e0754c.js";import"./QuantizationParameters-f983cf8d.js";import"./floorFilterUtils-080a7cd2.js";import"./PointSnappingHint-671c9f09.js";import"./dehydratedFeatureComparison-7855b188.js";import"./boundedPlane-1da2f094.js";import"./vec2f32-eaf29605.js";import"./dehydratedFeatures-2a3f0608.js";import"./quantizationUtils-17105106.js";import"./featureConversionUtils-09cf00ff.js";import"./OptimizedFeature-e90b69df.js";import"./OptimizedFeatureSet-1d1ac4b9.js";import"./OptimizedGeometry-196224d4.js";import"./edgeUtils-6e4a97fb.js";import"./SnappingCandidate-970faec6.js";import"./objectResourceUtils-003803db.js";import"./devEnvironmentUtils-4eab2a99.js";import"./DefaultMaterial_COLOR_GAMMA-101ea40c.js";import"./Version-1f969b2a.js";import"./resourceUtils-1d03d2fe.js";import"./mat3f32-6c416b1c.js";import"./symbolColorUtils-3ca646c8.js";import"./callExpressionWithFeature-36423058.js";import"./projectVectorToDehydratedPoint-e30a7ff8.js";import"./webStyleSymbolUtils-4761c8f2.js";import"./Intersector-a291e778.js";import"./fontUtils-56b88a2f.js";function Gi(t,e,i){if(t==null)return null;const n=t.dimensionSegment.startRenderSpace,a=t.dimensionSegment.endRenderSpace,s=ii(n,a,t.spatialReference);if(s==null)return null;const o=e===_.Vertical?He(s.value,s.unit,i):ze(s.value,s.unit,i);return ce(s,o)}function ut(t){const{elevationAlignedStartPoint:e,elevationAlignedEndPoint:i,dimension:{offset:n,measureType:a,orientation:s}}=t;return{elevationAlignedStartPoint:e,elevationAlignedEndPoint:i,offset:n,measureType:a,orientation:s}}function mt({elevationAlignedStartPoint:t,elevationAlignedEndPoint:e,offset:i,measureType:n,orientation:a},s,o=null){if(t==null||e==null)return null;const l=_e(o!=null?o.directSegment:new B,{elevationAlignedStartPoint:t,elevationAlignedEndPoint:e},s),r=o!=null?o.primaryOffsetAxis:b();vt(r,{measureType:n,elevationAlignedStartPoint:t,elevationAlignedEndPoint:e,directSegment:l,orientation:a,renderCoordsHelper:s});const c=o!=null?o.dimensionSegment:new B;return Rt({elevationAlignedStartPoint:t,elevationAlignedEndPoint:e})&&n===_.Vertical?(T(c.startRenderSpace,l.startRenderSpace),T(c.endRenderSpace,l.endRenderSpace)):ve(c,{offsetAxis:r,offset:i,relativeToSegment:l,renderCoordsHelper:s}),{directSegment:l,dimensionSegment:c,primaryOffsetAxis:r,spatialReference:s.spatialReference}}function Kt(t,e,i,n){return e===it.Start?(T(t.startRenderSpace,i.startRenderSpace),T(t.endRenderSpace,n.startRenderSpace)):(T(t.startRenderSpace,i.endRenderSpace),T(t.endRenderSpace,n.endRenderSpace)),t}var it;function Ii(t,e,i,n){dt(t.startRenderSpace,e.startRenderSpace,i,n),dt(t.endRenderSpace,e.endRenderSpace,i,n)}function fe(t,e,i,n){switch(e){case _.Direct:return _e(t,i,n);case _.Horizontal:case _.Vertical:{const{elevationAlignedStartPoint:a,elevationAlignedEndPoint:s,dimension:o,geometry:l}=i;let r;o.measureType===_.Direct?(r=Ui(l,n)===a.z>s.z,e===_.Horizontal&&(r=!r)):r=!Fi(l);const[c,u]=r?[a,s]:[s,a],h=Z(u,ji);return e===_.Horizontal?h.z=c.z:(h.x=c.x,h.y=c.y),n.toRenderCoords(c,t.startRenderSpace),n.toRenderCoords(h,t.endRenderSpace),t}}}function _e(t,e,i){return i.toRenderCoords(e.elevationAlignedStartPoint,t.startRenderSpace),i.toRenderCoords(e.elevationAlignedEndPoint,t.endRenderSpace),t}function Ui(t,e){const i=t.directSegment.eval(.5,g.get()),n=e.worldUpAtPosition(i,g.get()),a=t.dimensionSegment.eval(.5,g.get()),s=k(g.get(),a,i);return!ee(s,K)&&E(s,n)>0}function Fi(t){const{startRenderSpace:e,endRenderSpace:i}=t.dimensionSegment,{startRenderSpace:n,endRenderSpace:a}=t.directSegment;return Ut(n,e)<Ut(a,i)}(function(t){t[t.Start=0]="Start",t[t.End=1]="End"})(it||(it={}));const ji=ti(0,0,0,null);function Bi(t,e,i,n){const{directSegment:a}=i,s=vt(g.get(),{measureType:e,directSegment:a,renderCoordsHelper:n}),o=ve(Ni,{offsetAxis:s,offset:0,relativeToSegment:a,renderCoordsHelper:n}).eval(.5,g.get()),l=k(g.get(),t,o);return E(l,s)*n.unitInMeters}const Ni=new B;function vt(t,e){const{measureType:i,elevationAlignedStartPoint:n,elevationAlignedEndPoint:a,directSegment:{startRenderSpace:s,endRenderSpace:o},directSegment:l,renderCoordsHelper:r}=e,c=l.eval(.5,g.get()),u=r.worldUpAtPosition(c,g.get()),h=r.worldBasisAtPosition(c,Re.Y,g.get());switch(i){case _.Horizontal:T(t,u);break;case _.Vertical:E(s,u)<E(o,u)?k(t,o,s):k(t,s,o),F(t,t,u),F(t,t,u);break;case _.Direct:{const m=e.orientation??0;if(Rt({elevationAlignedStartPoint:n,elevationAlignedEndPoint:a}))Lt(lt,-Gt(m),u),It(t,h,lt);else{const S=k(g.get(),o,s),f=F(g.get(),S,u);F(f,f,S),Lt(lt,Gt(m),S),It(t,f,lt)}break}}return ee(t,K)?T(t,h):ke(t,t)}const lt=Dt();function Rt({elevationAlignedStartPoint:t,elevationAlignedEndPoint:e}){return t!=null&&e!=null&&t.x===e.x&&t.y===e.y}function ve(t,e){const{offsetAxis:i,offset:n,relativeToSegment:{startRenderSpace:a,endRenderSpace:s},relativeToSegment:o,renderCoordsHelper:l}=e,r=n/l.unitInMeters,[c,u]=qi(a,s,i,r);return dt(t.startRenderSpace,o.startRenderSpace,i,c),dt(t.endRenderSpace,o.endRenderSpace,i,u),t}function qi(t,e,i,n=0){const a=E(e,i),s=E(t,i),o=Math.abs(a-s)+n;return a>s?[o,n]:[n,o]}function yt(t,e,i){const n=e.directSegment.eval(.5,g.get());return i.worldUpAtPosition(n,t)}function kt(t,e){const{startRenderSpace:i,endRenderSpace:n}=e.directSegment;return k(t,n,i)}function Vt(t,e,i={invert:!1}){const{startRenderSpace:n,endRenderSpace:a}=e.dimensionSegment;return i.invert?k(t,n,a):k(t,a,n)}function $t(t,e){const i=t.directSegment.eval(.5,g.get());return e.headingAtPosition(i,t.primaryOffsetAxis)}function Wi(t,e){return Mt(Vt(Ki,t))/e**2}const Ki=b();function ye(t){const{elevationAlignedStartPoint:e,elevationAlignedEndPoint:i}=t;if(e==null||i==null)return!1;const n=ni(e,i);return n!=null&&ce(n,"meters").value>Se}const Se=1e5;function nt(t){return t.geometry!=null}let U=class extends J{constructor(e){super(e)}initialize(){const e=ft(()=>this.analysisViewData.computations,({computation:i})=>this._watchComputation(i));this.addHandles(at(e))}get analysis(){return this.analysisViewData.analysis}get _defaultUnit(){return Qe(this.view)}_watchComputation(e){return v(()=>ut(e),i=>{const{measureType:n}=i;if(ye(i)&&n!==_.Direct){const s=Math.round(Ve(Se,"meters","kilometers"));return ie.getLogger(this).warnOnce(`A ${n} dimension in the analysis (id: '${this.analysis.id}') will not display, because only direct dimensions can measure lengths greater than ${s} km. Update the measureType of the affected dimension to "direct" to display it.`),void(e.geometry=null)}const a=mt(i,this.view.renderCoordsHelper,e.geometry);e.geometry=a,e.result.length=Gi(a,n,this._defaultUnit)},A)}};d([p({constructOnly:!0})],U.prototype,"analysisViewData",void 0),d([p({constructOnly:!0})],U.prototype,"view",void 0),d([p()],U.prototype,"analysis",null),d([p()],U.prototype,"_defaultUnit",null),U=d([G("esri.views.3d.analysis.Dimension.support.DimensionController")],U);function ht(t){return Ee(t.accentColor,.5)}function Ji(t){return Le(t.accentColor)}const Me=5,Xi=new j([127,127,127,.5]),we=.8,Yi=4,Zi=6,Qi=.1,Pe=.5,tn=18,en=2,nn=.3,an=2,sn=.25,on=20,rn=5,Jt=5,Xt=10,ln=2500,dn=50,cn=2;class pn{constructor(e){this.start=e.start,this.end=e.end,this.offset=e.offset,this.heading=e.heading,this.rotation=e.rotation,this.direct=e.direct,this.horizontal=e.horizontal,this.vertical=e.vertical}manipulatorName(e){return Object.keys(this).find(i=>this.hasOwnProperty(i)&&e===this[i])}values(){return[this.start,this.end,this.offset,this.heading,this.rotation,this.direct,this.horizontal,this.vertical]}forEachMeasureTypeManipulator(e){for(const i of Ye)e(this.manipulatorForMeasureType(i),i)}manipulatorForMeasureType(e){switch(e){case _.Direct:return this.direct;case _.Horizontal:return this.horizontal;case _.Vertical:return this.vertical}}}class un extends _t{constructor(e,i){const n=ai(j.toUnitRGBA(ht(e.effectiveTheme))),a=[new H(ri(n,1,32,32),V)];super({view:e,renderObjects:a,metadata:i.metadata,available:!1,grabCursor:"crosshair",radius:Me,collisionPriority:1}),this._themeHandle=v(()=>({color:j.toUnitRGBA(ht(e.effectiveTheme))}),s=>n.setParameters(s))}destroy(){this._themeHandle.remove(),super.destroy()}}function mn(t,e){const i=[ct(-.5,0,0),ct(.5,0,0)],n=et(e.unfocusedMaterial,i.map(s=>st(b(),s,Pe))),a=n.instantiate({material:e.focusedMaterial});return new _t({view:t,renderObjects:[new H(n,R.Unfocused|R.Selected|V),new H(a,R.Focused|V)],collisionType:{type:"line",paths:[i]},radius:Et(e.lineSizePt)/2,metadata:e.metadata,available:!1,...pe})}class Yt extends _t{constructor(e,{lineSizePt:i,material:n,metadata:a}){super({view:e,autoScaleRenderObjects:!1,collisionPriority:1,metadata:a}),this._options={calloutColor:Ge(),lineSizePt:i,material:n},this._themeHandle=v(()=>j.toUnitRGBA(ht(e.effectiveTheme)),s=>{this._options.calloutColor=s,Qt(this,Zt({...this._options,metadata:this.metadata}))},tt)}update({lineSizePt:e,material:i}){this._options.lineSizePt=e,this._options.material=i,Qt(this,Zt({...this._options,metadata:this.metadata}))}destroy(){this._themeHandle.remove(),super.destroy()}}function Zt({calloutColor:t,lineSizePt:e,material:i,metadata:n}){return{calloutLength:.25*li*we*x(e)+tn,calloutColor:t,calloutWidth:en,customStateMask:V,discScale:nn,focusMultiplier:an,material:i,metadata:n}}function hn(t,e){const i=[ct(-.5,0,0),ct(.5,0,0)],n=et(e.thinOffsetManipulatorMaterial,i),a=et(e.unfocusedMaterial,i.map(o=>st(b(),o,Pe))),s=a.instantiate({material:e.focusedMaterial});return new _t({view:t,renderObjects:[new H(a,R.Unfocused|V),new H(s,R.Focused|V),new H(n,V)],collisionType:{type:"line",paths:[i]},radius:Et(e.lineSizePt)/2,available:!1,metadata:e.metadata,...pe})}function gn(t,{isStart:e,createSnappingPipelineStep:i,dimension:n,onUpdate:a,view:s}){const o=e?"startPoint":"endPoint";return[ot(t,(r,c,u,h)=>{const m=Ht(r),{snappingStep:S,cancelSnapping:f}=i(h);u=u.next(m).next(zt(n,[o,"measureType","orientation"])).next(f),c.next(m).next(oi(s)).next(...S).next(M=>{const y=Z(M.mapEnd,new W);a(o==="startPoint"?{startPoint:y}:{endPoint:y})})})]}function fn(t,{computation:e,view:i}){return[ot(t,(n,a,s)=>{if(!nt(e)||!n.selected)return;const{geometry:o,dimension:l}=e,r=Ht(n);a.next(r).next(Ce(i,l,o.dimensionSegment,o.primaryOffsetAxis)),s.next(r).next(zt(l,["offset"]))})]}function _n(t,{computation:e,view:i}){return[ot(t,(n,a,s)=>{be({cancel:s,computation:e,settingHeading:!0,steps:a,view:i})})]}function vn(t,{computation:e,view:i}){return[ot(t,(n,a,s)=>{be({cancel:s,computation:e,settingHeading:!1,steps:a,view:i})}),t.events.on("immediate-click",n=>{yn(n,e,i)})]}function yn(t,e,i){const{dimension:n,geometry:a}=e;if(n.orientation===90||n.orientation===270)return n.orientation=0,void t.stopPropagation();if(a==null)return;const{renderCoordsHelper:s}=i,o=mt({...ut(e),orientation:90},s),l=mt({...ut(e),orientation:270},s);if(o==null||l==null)return;const r=$t(o,s),c=$t(l,s),u=Oe(a,i),h=Ot.shortestSignedDiff(u,r),m=Ot.shortestSignedDiff(u,c);n.orientation=Math.abs(h)<Math.abs(m)?90:270,t.stopPropagation()}function be(t){const{cancel:e,computation:i,settingHeading:n,steps:a,view:s}=t;if(!nt(i))return;const{renderCoordsHelper:o}=s,{dimension:l,geometry:r}=i,c=b(),u=De(b(),r,r.directSegment,o),h=Te(g.get(),{forHeading:n,geometry:r,renderCoordsHelper:o}),m=wt(u,h,Pt()),S=n?l.orientation??$t(r,s.renderCoordsHelper):l.orientation??0;a.next(ue(s,m)).next(f=>{f.action==="start"&&T(c,f.renderStart);const M=Ue(m),y=si(c,f.renderEnd,u,M);let L=S-Fe(y);n||(L=Sn(L)),l.orientation=L}),e.next(zt(l,["orientation"]))}function Sn(t){const e=Ot.normalize(t)%90;return e<Jt?t-e:90-e<Jt?t+(90-e):t}function Mn(t,{computation:e,manipulatorMeasureType:i,view:n}){let a=_.Direct,s=0,o=0;return[t.events.on("grab-changed",l=>{if(l.action!=="start"||!nt(e))return;const{dimension:r,geometry:c}=e;a=r.measureType,s=r.offset,o=r.orientation;const u=T(g.get(),t.renderLocation);r.measureType=i,r.offset=Bi(u,i,c,n.renderCoordsHelper),r.orientation=0}),ot(t,(l,r,c)=>{if(!nt(e))return;const{geometry:u,dimension:h}=e,{renderCoordsHelper:m}=n,S=fe(Ae,i,e,m),f=vt(g.get(),{measureType:i,directSegment:u.directSegment,renderCoordsHelper:m}),M=Ht(l);r.next(M).next(Ce(n,h,S,f)),c.next(M).next(y=>(h.measureType=a,h.offset=s,h.orientation=o,y))})]}function Ce(t,e,i,n){const a=ne(g.get(),i.endRenderSpace,i.startRenderSpace);F(a,a,n);const s=wt(i.startRenderSpace,a,Pt()),o=wt(i.startRenderSpace,n,Pt()),l=e.offset;let r,c=0;const u=new ci;return u.next(ue(t,s)).next(h=>{h.action==="start"&&(c=Ft(o,h.renderStart));const m=(Ft(o,h.renderEnd)-c)*t.renderCoordsHelper.unitInMeters;e.offset=l+m,r=h}),h=>(u.execute(h),r)}function Oe(t,e){const{directSegment:i}=t,{renderCoordsHelper:n}=e,a=yt(g.get(),t,n),s=kt(g.get(),t),o=F(g.get(),s,a),{viewForward:l}=e.state.camera;E(o,l)>0&&st(o,o,-1);const r=i.eval(.5,g.get());return n.headingAtPosition(r,o)}function wn(t,e,i){const{dimensionSegment:n,primaryOffsetAxis:a}=e,s=Vt(Q,e),o=ae(s,K)?Ie(gt):xt(s,a,K,gt),l=Math.max(se(s),Qi/i.unitInMeters);oe(o,o,re(Q,l,l,l)),t.modelTransform=o,t.renderLocation=n.eval(.5,Q)}function Pn(t,e,i){$e(t,e,i,{forHeading:!0})}function bn(t,e,i){$e(t,e,i,{forHeading:!1})}function $e(t,e,i,{forHeading:n}){const{dimension:a,geometry:s}=e,{primaryOffsetAxis:o}=s,l=st(Cn,o,a.offset>=0?1:-1),r=Te(On,{forHeading:n,geometry:s,renderCoordsHelper:i});F(r,r,l);const c=xt(l,r,K,gt);t.modelTransform=c,t.renderLocation=De(Q,s,s.dimensionSegment,i)}const Cn=b(),On=b();function $n(t,e,i,n){const{geometry:a}=e,s=fe(Ae,i,e,n),o=vt(Q,{measureType:i,directSegment:a.directSegment,renderCoordsHelper:n}),l=k(St,s.endRenderSpace,s.startRenderSpace),r=xt(l,o,K,gt),c=se(l);oe(r,r,re(St,c,c,c)),t.modelTransform=r,t.renderLocation=s.eval(.5,St)}function De(t,e,i,n){const{startRenderSpace:a,endRenderSpace:s}=i,o=Dn(e,n)?a:s;return T(t,o)}function Te(t,{forHeading:e,geometry:i,renderCoordsHelper:n}){return e?yt(t,i,n):Vt(t,i,{invert:!0})}function Dn(t,e){const i=kt(Tn,t),n=yt(An,t,e);return E(i,n)>0}const Tn=b(),An=b();function xn(t){return x(t)+Yi}function Et(t){return x(t)+Zi}function Qt(t,e){var S;const i=e.material??new me({transparent:!0,writeDepth:!1,textureId:(S=e.texture)==null?void 0:S.id,renderOccluded:P.Opaque,isDecoration:!0}),n=e.focusMultiplier??rt.focusMultiplier,a=e.calloutLength??rt.calloutLength,s=rt.discRadius*(e.discScale??1),o=s*n,l=(f,M)=>{const y=[0,1,2,2,3,0];return new je(M,[[jt.POSITION,new Bt([a-f,-f,0,a+f,-f,0,a+f,f,0,a-f,f,0],y,3,!0)],[jt.UV0,new Bt([0,0,1,0,1,1,0,1],y,2,!0)]])},r=e.calloutWidth??rt.calloutWidth,c=new N({width:r,color:e.calloutColor,renderOccluded:P.OccludeAndTransparent,isDecoration:!0}),u=et(c,[[0,0,0],[a-s,0,0]]),h=et(c,[[0,0,0],[a-o,0,0]]),m=e.customStateMask??he.None;t.collisionType={type:"disc",direction:[0,0,1],offset:[a,0,0]},t.focusMultiplier=n,t.metadata=e.metadata,t.radius=s,t.renderObjects=[new H(l(s,i),R.Unfocused|m),new H(u,R.Unfocused|m),new H(l(o,i),R.Focused|m),new H(h,R.Focused|m)]}const V=he.Custom1,Q=b(),St=b(),gt=Dt(),Ae=new B;var D;function Hn(t,e){return{enabled:e.effectiveFeatureEnabled,elevationAlignedStartPoint:t.elevationAlignedStartPoint,elevationAlignedEndPoint:t.elevationAlignedEndPoint,geometry:t.geometry}}function zn(t,e){if(ye(t))return D.Direct;if(!t.enabled)return null;const{geometry:i}=t;if(i==null||ae(i.directSegment.startRenderSpace,i.directSegment.endRenderSpace))return null;const{camera:n}=e.state,a=yt(g.get(),i,e.renderCoordsHelper),s=kt(g.get(),i),o=st(g.get(),a,E(s,a)),l=ne(g.get(),s,o),r=Mt(l),c=Mt(o),{startRenderSpace:u,endRenderSpace:h}=i.directSegment,m=Math.max(n.computeScreenPixelSizeAt(u)*Xt,n.computeScreenPixelSizeAt(h)*Xt)**2;return r<m?D.Vertical:c<m?D.Horizontal:null}function Rn(t,e,{constraint:i,view:n}){const{unconstrainedGeometry:a}=t;if(a==null)return;const{renderCoordsHelper:s,spatialReference:o}=n,{startRenderSpace:l,endRenderSpace:r}=a.directSegment,c=s.fromRenderCoords(l,new W,o),u=s.fromRenderCoords(r,new W,o);let h;h=e==="start"?{startPoint:c}:{endPoint:u},xe(t,h,{constraint:i,elevationAlignedStartPoint:t.elevationAlignedStartPoint,elevationAlignedEndPoint:t.elevationAlignedEndPoint,unconstrainedGeometry:a,view:n})}function xe(t,e,i){const{constraint:n,elevationAlignedStartPoint:a,elevationAlignedEndPoint:s,unconstrainedGeometry:o,view:l}=i,{dimension:r,previousConstraint:c,preConstraintProperties:u}=t;if(a==null||s==null)return;const h=()=>{"startPoint"in e?r.startPoint=e.startPoint:"endPoint"in e&&(r.endPoint=e.endPoint)};if(n==null)h(),c!=null&&u!=null&&(r.measureType=u.measureType,r.orientation=u.orientation);else switch(r.measureType=_.Direct,n){case D.Horizontal:if(n!==c&&(r.orientation=0),"startPoint"in e){const m=e.startPoint;m!=null&&(m.z=s.z),r.startPoint=m}else if("endPoint"in e){const m=e.endPoint;m!=null&&(m.z=a.z),r.endPoint=m}break;case D.Vertical:if(n!==c&&(r.orientation=Oe(o,l)),"startPoint"in e){const m=e.startPoint;m!=null&&(m.x=s.x,m.y=s.y),r.startPoint=m}else if("endPoint"in e){const m=e.endPoint;m!=null&&(m.x=a.x,m.y=a.y),r.endPoint=m}break;case D.Direct:n!==c&&u!=null&&(r.orientation=u.orientation),h()}t.previousConstraint=n,t.unconstrainedGeometry=o}(function(t){t[t.Horizontal=0]="Horizontal",t[t.Vertical=1]="Vertical",t[t.Direct=2]="Direct"})(D||(D={}));let w=class extends J{constructor(t){super(t),this._stagedDimension=null,this._computationManipulators=new Map,this._computationHandles=new le,this._orientationManipulatorTexture=null,this._updatingHandles=new ui,this._getSnappingContext=pi(n=>new bi({elevationInfo:{mode:"absolute-height",offset:0},pointer:n,editGeometryOperations:new Si(new Mi("point",wi(!0,!1,this.view.spatialReference))),visualizer:new hi}));const{view:e}=t;this._snappingManagerResult=Pi(e),this.addHandles(this._snappingManagerResult),this._unfocusedOffsetManipulatorMaterial=this._createOffsetManipulatorMaterial(),this._focusedOffsetManipulatorMaterial=this._createOffsetManipulatorMaterial(),this._thinOffsetManipulatorMaterial=this._createOffsetManipulatorMaterial(),this._thinOffsetManipulatorMaterial.setParameters({stipplePattern:pt(2)}),this._constraintSnappingIndicator=new I({view:e,attached:!0,width:1,renderOccluded:P.OccludeAndTransparent,stipplePattern:pt(5),isDecoration:!0});const i=j.toUnitRGBA(Xi);this._stagedStartIndicator=new _i({view:e,attached:!1,elevationInfo:{mode:"absolute-height",offset:0},spatialReference:t.view.renderCoordsHelper.spatialReference,color:i,size:2*Me,outlineSize:0,renderOccluded:P.OccludeAndTransparent,isDecoration:!0})}initialize(){var n;const{view:t}=this;this._snappingOperation=new Oi({view:t});const e=!((n=t._stage)!=null&&n.renderView.renderingContext.driverTest.svgPremultipliesAlpha.result);this._orientationManipulatorMaterial=new me({transparent:!0,writeDepth:!1,renderOccluded:P.Opaque,isDecoration:!0}),this.addHandles(v(()=>({accentColor:ht(t.effectiveTheme),contrastColor:Ji(t.effectiveTheme)}),({accentColor:a,contrastColor:s})=>{const o=this._orientationManipulatorTexture,l=mi(t.textures,{accentColor:a,contrastColor:s,preMultiplyAlpha:e});this._orientationManipulatorMaterial.setParameters({textureId:l.texture.id}),this._orientationManipulatorTexture=l,o==null||o.release();const r=j.toUnitRGBA(a);this._unfocusedOffsetManipulatorMaterial.setParameters({color:r}),this._focusedOffsetManipulatorMaterial.setParameters({color:r}),this._thinOffsetManipulatorMaterial.setParameters({color:r}),this._constraintSnappingIndicator.color=r},tt));const i=ft(()=>this.analysisViewData.computations,({computation:a})=>this._createManipulators(a));this.addHandles(at(i)),this.addHandles([v(()=>({stagedPoint:this._snappingOperation.stagedPoint,stagedComputation:this._stagedComputation}),({stagedPoint:a,stagedComputation:s})=>{if(s==null||a==null)return;const o=Z(a,new W);this._applyPointUpdate(s,{endPoint:o})},bt),v(()=>({stagedDimension:this._stagedDimension,selectedComputation:this.analysisViewData.selectedComputation,firstGrabbedManipulator:this.firstGrabbedManipulator}),(a,s)=>{const{stagedDimension:o,selectedComputation:l,firstGrabbedManipulator:r}=a;if(o===(s==null?void 0:s.stagedDimension)&&r===(s==null?void 0:s.firstGrabbedManipulator)){for(const c of[l,s==null?void 0:s.selectedComputation])if(c!=null){const u=this._computationManipulators.get(c);u!=null&&this._updateManipulators(c,u,a)}}else for(const[c,u]of this._computationManipulators)this._updateManipulators(c,u,a)},A),v(()=>this.analysis.style.lineSize,a=>{this._updateManipulatorStyle(a)},tt),v(()=>this.view.state.camera,()=>{this._stagedComputation!=null&&this._updateStagedDimensionOffset(this._stagedComputation)}),v(()=>{const a=this._stagedComputation;if(!a)return null;const s=a.elevationAlignedStartPoint,o=b();return s!=null&&this.view.renderCoordsHelper.toRenderCoords(s,o)?o:null},a=>{a!=null?(this._stagedStartIndicator.vertices=[a],this._stagedStartIndicator.attached=!0):this._stagedStartIndicator.attached=!1})]),this.addHandles(this._constraintHandles),this.addHandles(this._snappingIndicatorHandles),$i(this,()=>{const a=this._activeComputation,s=this._stagedComputation;if(a==null||s!=null){const o=this.view.inputManager.latestPointerType??"mouse",l=this._getSnappingContext(o);this._updatingHandles.addPromise(Nt(this._snappingOperation.resnap(this._snappingManager,l)))}if(a!=null){const{start:o,end:l}=this._computationManipulators.get(a);if(o.grabbing||l.grabbing){const r=o.grabbing?"start":"end",c=this._computeConstraint(a);Rn(a,r,{constraint:c,view:this.view})}}})}destroy(){var t;this._snappingOperation=Tt(this._snappingOperation),this._computationHandles.destroy(),this._constraintSnappingIndicator.destroy(),this._stagedStartIndicator.destroy(),(t=this._orientationManipulatorTexture)==null||t.release()}get updating(){return this._updatingHandles.updating||this._snappingManager.updating}get firstGrabbedManipulator(){return this.parentTool.firstGrabbedManipulator}get hasGrabbedManipulators(){return this.parentTool.hasGrabbedManipulators}get snappingOptions(){return this._snappingManager.options}get _snappingManager(){return this._snappingManagerResult.snappingManager}get _activeComputation(){if(this._stagedComputation!=null)return this._stagedComputation;const{selectedComputation:t}=this.analysisViewData;return this.hasGrabbedManipulators&&t!=null?t:null}get _stagedComputation(){var i;const t=this._stagedDimension,e=(i=this.analysisViewData.computations.at(-1))==null?void 0:i.computation;return t==null||e==null||e.dimension!==t?null:e}get _constraintHandles(){return[At(()=>this.analysisViewData.selectedComputation,t=>{t.previousConstraint=this._computeConstraint(t)},{...A,equals:Ct}),v(()=>{const t=this._activeComputation;if(t==null)return null;const{measureType:e,orientation:i}=t.dimension;return{measureType:e,orientation:i,computation:t}},(t,e)=>{if(t!=null&&e==null){const{measureType:i,orientation:n,computation:a}=t;switch(a.previousConstraint){case D.Horizontal:a.preConstraintProperties={measureType:_.Horizontal,orientation:0};break;case D.Vertical:a.preConstraintProperties={measureType:_.Vertical,orientation:0};break;case D.Direct:a.preConstraintProperties={measureType:_.Direct,orientation:n};break;default:a.preConstraintProperties={measureType:i,orientation:n}}}t==null&&e!=null&&(e.computation.preConstraintProperties=null)},bt)]}get _snappingIndicatorHandles(){const t="snapping-indicator-event-handles";return[v(()=>({stagedComputation:this._stagedComputation,activeComputation:this._activeComputation}),({stagedComputation:e,activeComputation:i})=>{const n=this._constraintSnappingIndicator;if(this.removeHandles(t),i!=null)if(i===e)n.attached=!0;else{const{start:a,end:s}=this._computationManipulators.get(i),o=()=>{n.attached=a.grabbing||s.grabbing};o(),this.addHandles([a.events.on("grab-changed",o),s.events.on("grab-changed",o)],t)}else n.attached=!1}),v(()=>{const e=this._activeComputation;return e!=null?{geometry:e.geometry,constraint:e.previousConstraint}:{}},({geometry:e,constraint:i})=>{const n=this._constraintSnappingIndicator;e!=null&&i!=null&&i!==D.Direct?(n.visible=!0,n.setGeometryFromSegment(e.directSegment)):n.visible=!1})]}removeStaged(){return this._stagedDimension!=null&&(this.analysis.dimensions.remove(this._stagedDimension),this._stagedDimension=null,!0)}onDeactivate(){this.removeStaged(),this._resetSnappingState()}onClick(t){const{_stagedDimension:e}=this;if(e==null){const i=this._onUnstagedClick(t);return this.analysis.dimensions.add(i),null}return this._onStagedClick(t),e}onPointerMove({mapPoint:t,pointerType:e}){if(e==="touch")return;const i=this._getSnappingContext(e);this._updatingHandles.addPromise(Nt(this._snappingOperation.snap({point:t},this._snappingManager,i)))}onManipulatorSelectionChanged(){this.analysisViewData.selectedComputation!=null&&(this._computationManipulators.get(this.analysisViewData.selectedComputation).offset.selected||(this.analysisViewData.selectedDimension=null))}_onUnstagedClick({mapPoint:t,pointerType:e}){let i=t;if(e==="mouse"){const a=this._getSnappingContext(e);i=this._snappingManager.update({point:t,context:a})}const n=new Ze({startPoint:Z(i,new W),endPoint:null,measureType:_.Horizontal});return this._stagedDimension=n,this._resetSnappingState(),n}_onStagedClick({mapPoint:t,pointerType:e}){const i=this._stagedComputation;if(i==null)return;let n=t;if(e==="mouse"){const s=this._getSnappingContext(e);n=this._snappingManager.update({point:t,context:s})}const a=Z(n,new W);this._applyPointUpdate(i,{endPoint:a}),this._stagedDimension=null,this._resetSnappingState()}_resetSnappingState(){this._snappingManager.doneSnapping(),this._snappingOperation.abort(),this._snappingOperation.stagedPoint=null}_createManipulators(t){const e=this._setupPointManipulator(t,{isStart:!0}),i=this._setupPointManipulator(t,{isStart:!1}),n=this._setupOffsetManipulator(t),a=this._setupHeadingManipulator(t),s=this._setupRotationManipulator(t),o=this._setupMeasureTypeManipulator(t,_.Direct),l=this._setupMeasureTypeManipulator(t,_.Horizontal),r=this._setupMeasureTypeManipulator(t,_.Vertical),c=new pn({start:e,end:i,offset:n,heading:a,rotation:s,direct:o,horizontal:l,vertical:r});return this._setupComputationToManipulatorsSync(t,c),this._computationManipulators.set(t,c),this.manipulators.addMany(c.values()),{manipulators:c,remove:()=>{this._computationHandles.remove(t),this._computationManipulators.delete(t);for(const u of c.values())this.manipulators.remove(u)}}}_setupComputationToManipulatorsSync(t,e){this._computationHandles.add([v(()=>t.geometry,()=>this._updateManipulators(t,e),{...A,equals:Ct})],t)}_setupPointManipulator(t,e){const{view:i}=this,{dimension:n}=t,a=new un(i,{metadata:n}),s=gn(a,{isStart:e.isStart,createSnappingPipelineStep:o=>Ci({snappingContext:this._getSnappingContext(o),snappingManager:this._snappingManager,updatingHandles:this._updatingHandles}),dimension:n,onUpdate:o=>this._applyPointUpdate(t,o),view:i});return this._computationHandles.add(s,t),a}_setupOffsetManipulator(t){const{view:e}=this,i=mn(e,{lineSizePt:this.analysis.style.lineSize,unfocusedMaterial:this._unfocusedOffsetManipulatorMaterial,focusedMaterial:this._focusedOffsetManipulatorMaterial,metadata:t.dimension}),n=fn(i,{computation:t,view:e});return this._computationHandles.add(n,t),i}_setupHeadingManipulator(t){const{view:e}=this,i=new Yt(e,{lineSizePt:this.analysis.style.lineSize,material:this._orientationManipulatorMaterial,metadata:t.dimension}),n=_n(i,{computation:t,view:e});return this._computationHandles.add(n,t),i}_setupRotationManipulator(t){const{view:e}=this,i=new Yt(e,{lineSizePt:this.analysis.style.lineSize,material:this._orientationManipulatorMaterial,metadata:t.dimension}),n=vn(i,{computation:t,view:e});return this._computationHandles.add(n,t),i}_setupMeasureTypeManipulator(t,e){const{view:i}=this,n=hn(i,{lineSizePt:this.analysis.style.lineSize,unfocusedMaterial:this._unfocusedOffsetManipulatorMaterial,focusedMaterial:this._focusedOffsetManipulatorMaterial,thinOffsetManipulatorMaterial:this._thinOffsetManipulatorMaterial,metadata:t.dimension}),a=Mn(n,{computation:t,manipulatorMeasureType:e,view:i});return this._computationHandles.add(a,t),n}_updateManipulators(t,e,i={stagedDimension:this._stagedDimension,selectedComputation:this.analysisViewData.selectedComputation,firstGrabbedManipulator:this.firstGrabbedManipulator}){const{stagedDimension:n,selectedComputation:a,firstGrabbedManipulator:s}=i,{start:o,end:l,offset:r,heading:c,rotation:u}=e,h=a===t,m=nt(t),{dimension:S}=t;for(const y of e.values()){const L=m&&n==null&&(s==null||y===s);y===r?(y.available=L,y.selected=h):y.available=L&&h}if(!m)return;this._computeConstraint(t)!=null?e.forEachMeasureTypeManipulator(y=>y.available=!1):e.manipulatorForMeasureType(S.measureType).available=!1;for(const y of[c,u])S.measureType===_.Direct&&S.offset!==0||(y.available=!1);Rt(t)?u.available=!1:c.available=!1;const{geometry:f}=t;o.renderLocation=f.directSegment.startRenderSpace,l.renderLocation=f.directSegment.endRenderSpace;const{renderCoordsHelper:M}=this.view;wn(r,f,M),c.available&&Pn(c,t,M),u.available&&bn(u,t,M),e.forEachMeasureTypeManipulator((y,L)=>{y.available&&$n(y,t,L,M)})}_updateManipulatorStyle(t){const e=xn(t),i=Et(t),n={lineSizePt:t,material:this._orientationManipulatorMaterial};for(const{offset:a,heading:s,rotation:o}of this._computationManipulators.values())a.radius=i/2,s.update(n),o.update(n);this._unfocusedOffsetManipulatorMaterial.setParameters({width:e}),this._focusedOffsetManipulatorMaterial.setParameters({width:i})}_applyPointUpdate(t,e){const{view:i}=this,n=ut(t);"startPoint"in e&&(n.elevationAlignedStartPoint=e.startPoint),"endPoint"in e&&(n.elevationAlignedEndPoint=e.endPoint);const a=mt(n,i.renderCoordsHelper);if(a==null)return;const s=this._computeConstraint({...n,geometry:a});xe(t,e,{...n,constraint:s,unconstrainedGeometry:a,view:i}),t===this._stagedComputation&&this._updateStagedDimensionOffset(t)}_updateStagedDimensionOffset(t){if(t.geometry==null)return;t.geometry.directSegment.eval(.5,te);const e=this.view.state.camera.computeScreenPixelSizeAt(te);t.dimension.offset=dn*e}_computeConstraint(t){return zn(Hn(t,this._snappingManager.options),this.view)}_createOffsetManipulatorMaterial(){return new N({width:1,renderOccluded:P.OccludeAndTransparent,writeDepth:!1,hasPolygonOffset:!0,isDecoration:!0})}get testInfo(){const t=e=>{var i;return(i=this.analysisViewData.computations.find(({computation:n})=>n.dimension===e))==null?void 0:i.computation};return{disableManipulatorPartialOcclusion:()=>{this._stagedStartIndicator.renderOccluded=P.Occlude,this.manipulators.forEach(({manipulator:e})=>{for(const{geometry:i}of e.renderObjects)i.material.setParameters({renderOccluded:P.Occlude})})},getManipulatorsForDimension:e=>this._computationManipulators.get(t(e)),getComputationForDimension:e=>t(e),getConstraintForDimension:e=>{const i=t(e);return i!=null?this._computeConstraint(i):null},stagedDimension:this._stagedDimension,stagedStartIndicator:this._stagedStartIndicator,constraintSnappingIndicator:this._constraintSnappingIndicator,snappingManager:this._snappingManager}}};d([p({constructOnly:!0})],w.prototype,"analysis",void 0),d([p({constructOnly:!0})],w.prototype,"analysisViewData",void 0),d([p({constructOnly:!0})],w.prototype,"manipulators",void 0),d([p({constructOnly:!0})],w.prototype,"parentTool",void 0),d([p({constructOnly:!0,nonNullable:!0})],w.prototype,"view",void 0),d([p({readOnly:!0})],w.prototype,"updating",null),d([p()],w.prototype,"firstGrabbedManipulator",null),d([p()],w.prototype,"hasGrabbedManipulators",null),d([p()],w.prototype,"snappingOptions",null),d([p()],w.prototype,"_stagedDimension",void 0),d([p()],w.prototype,"_activeComputation",null),d([p()],w.prototype,"_stagedComputation",null),w=d([G("esri.views.3d.analysis.Dimension.LengthDimensionSubTool")],w);const te=b();var q;(function(t){t.Ready="ready",t.Creating="creating",t.Created="created"})(q||(q={}));let O=class extends Ai{constructor(t){super(t),this.automaticManipulatorSelection=!1,this.removeIncompleteOnCancel=!1,this._pointerMoveTimerMs=ln,this._prevPointerMoveTimeout=null}initialize(){this._intersector=Di(this.view.state.viewingMode),this._intersector.options.store=Ti.MIN,this._lengthDimensionSubTool=new w({analysis:this.analysis,analysisViewData:this.analysisViewData,manipulators:this.manipulators,parentTool:this,view:this.view}),this.addHandles([at(this._lengthDimensionSubTool),de(()=>this._clearPointerMoveTimeout()),v(()=>this.state,t=>{t===q.Created&&this.finishToolCreation()},A),At(()=>this.firstGrabbedManipulator,t=>{this.selectedDimension=t.metadata},A),v(()=>this.selectedDimension,()=>this._resetPointerMoveTimeout(),A)])}get state(){return this.analysis.dimensions.some(t=>t.type==="length")?this._activeSubTool!=null?q.Creating:q.Created:q.Ready}get updating(){return this._lengthDimensionSubTool.updating}get cursor(){return this.active?"crosshair":null}get selectedDimension(){return this.analysisViewData.selectedDimension}set selectedDimension(t){this.analysisViewData.selectedDimension=t}onInputEvent(t){switch(t.type){case"immediate-click":this._clickHandler(t);break;case"immediate-double-click":this._doubleClickHandler(t);break;case"pointer-move":this._pointerMoveHandler(t);break;case"key-down":if(Wt.cancel===t.key){if(this._activeSubTool!=null&&this._activeSubTool.removeStaged())return void t.stopPropagation();this.active||(this.selectedDimension=null)}else Wt.delete.includes(t.key)&&this._deleteKeyHandler()}}onActivate(){this._activeSubTool=this._lengthDimensionSubTool}onDeactivate(){this._activeSubTool!=null&&(this._activeSubTool.onDeactivate(),this._activeSubTool=null)}onShow(){this._resetPointerMoveTimeout()}onManipulatorSelectionChanged(){this._lengthDimensionSubTool.onManipulatorSelectionChanged()}onHide(){this.selectedDimension=null}_clickHandler(t){if(this.hasFocusedManipulators)return void t.stopPropagation();if(this._activeSubTool==null)return;const e=this._intersectScreen(t);e!=null&&(this.selectedDimension=this._activeSubTool.onClick({mapPoint:e,pointerType:t.pointerType}),t.stopPropagation())}_doubleClickHandler(t){this.active&&(this.view.activeTool=null,t.stopPropagation())}_pointerMoveHandler(t){if(this._resetPointerMoveTimeout(),this._activeSubTool==null||this.hasFocusedManipulators)return;const e=this._intersectScreen(t);e!=null&&this._activeSubTool.onPointerMove({mapPoint:e,pointerType:t.pointerType})}_deleteKeyHandler(){this._activeSubTool!=null&&this._activeSubTool.removeStaged(),this._removeSelected()}_intersectScreen(t){const e=xi(t);this.view.sceneIntersectionHelper.intersectToolIntersectorScreen(e,this._intersector);const i=this._intersector.results.min,n=g.get();return i.getIntersectionPoint(n)?this.view.renderCoordsHelper.fromRenderCoords(n,this.view.spatialReference):null}_removeSelected(){this.selectedDimension!=null&&(this.analysis.dimensions.remove(this.selectedDimension),this.selectedDimension=null)}_clearPointerMoveTimeout(){this._prevPointerMoveTimeout=Be(this._prevPointerMoveTimeout)}_resetPointerMoveTimeout(){this._clearPointerMoveTimeout(),this.manipulators.forEach(t=>t.manipulator.state|=V),this._prevPointerMoveTimeout=Ne.setTimeout(()=>{this.manipulators.forEach(t=>t.manipulator.state&=~V)},this._pointerMoveTimerMs)}get testInfo(){return{...this._lengthDimensionSubTool.testInfo,setManipulatorAutoHideDelay:t=>{this._pointerMoveTimerMs=t,this._resetPointerMoveTimeout()}}}};d([p({constructOnly:!0})],O.prototype,"view",void 0),d([p({constructOnly:!0})],O.prototype,"analysis",void 0),d([p({readOnly:!0})],O.prototype,"state",null),d([p({readOnly:!0})],O.prototype,"updating",null),d([p({readOnly:!0})],O.prototype,"cursor",null),d([p({constructOnly:!0})],O.prototype,"analysisViewData",void 0),d([p()],O.prototype,"selectedDimension",null),d([p()],O.prototype,"automaticManipulatorSelection",void 0),d([p()],O.prototype,"_activeSubTool",void 0),d([p()],O.prototype,"_lengthDimensionSubTool",void 0),O=d([G("esri.views.3d.analysis.Dimension.DimensionTool")],O);class kn extends ki{constructor(e,i){super(e),this._hasExternalMaterial=!1,this._renderOccluded=P.OccludeAndTransparent,this._width=1,this._color=zi(1,0,1,1),this._placement="end",this._markerPrimitive="arrow",this._material=i,this._hasExternalMaterial=i!=null,this.applyProperties(e)}setGeometryFromSegment(e,i){const n=e.endRenderSpace;this.transform=qe(Vn,n),this._normal=i;const{points:a}=e.createRenderGeometry(n,this.view.renderCoordsHelper);this.geometry=[a]}get renderOccluded(){return this._material!=null?this._material.parameters.renderOccluded:this._renderOccluded}set renderOccluded(e){this._renderOccluded=e,this._material!=null&&this._material.setParameters({renderOccluded:e})}get geometry(){return this._geometry}set geometry(e){this._geometry=e,this.recreateGeometry()}get normal(){return this._normal}set normal(e){this._normal=e,this.recreateGeometry()}get width(){return this._material!=null?this._material.parameters.width:this._width}set width(e){this._width=e,this._material!=null&&this._material.setParameters({width:e})}get color(){return this._material!=null?this._material.parameters.color:this._color}set color(e){this._color=Ri(e),this._material!=null&&this._material.setParameters({color:this._color})}get placement(){return this._material!=null?this._material.parameters.placement:this._placement}set placement(e){this._placement=e,this._material!=null&&this._material.setParameters({placement:this._placement})}get markerPrimitive(){var e;return((e=this._material)==null?void 0:e.parameters.markerPrimitive)??this._markerPrimitive}set markerPrimitive(e){this._markerPrimitive=e,this._material!=null&&this._material.setParameters({markerPrimitive:e})}createExternalResources(){this._hasExternalMaterial||(this._material=new ge({width:this._width,color:this._color,placement:this._placement,renderOccluded:this._renderOccluded,markerPrimitive:this._markerPrimitive,isDecoration:this.isDecoration}))}destroyExternalResources(){this._hasExternalMaterial||(this._material=null)}createGeometries(e){for(const i of vi(this.geometry,this.normal)){const n=yi(this._material,i);e.addGeometry(n)}}forEachExternalMaterial(e){this._hasExternalMaterial||e(this._material)}}const Vn=Dt();let En=class{set visible(e){for(const i of this._visualElements.values())i.attached=e}constructor(e){this.destroyed=!1,this._handles=new le,this._messages=null,this._labelSegment=new B;const{analysis:i,computation:n,view:a,messages:s,isDecoration:o}=e;this.analysis=i,this.computation=n,this.view=a,this._messages=s;const l=e.visible,r={view:a,attached:l,isDecoration:o},{fontSize:c,textColor:u,textBackgroundColor:h}=i.style;this._visualElements=new Un({marker:new kn(r,e.markerMaterial),dimension:new I(r,e.dimensionLineMaterial),startOffset:new I(r,e.offsetLineMaterial),endOffset:new I(r,e.offsetLineMaterial),dimensionSmall:new I(r,e.smallDimensionLineMaterial),startOffsetSmall:new I(r,e.smallOffsetLineMaterial),endOffsetSmall:new I(r,e.smallOffsetLineMaterial),label:new ei({view:a,attached:l,distance:0,geometry:{type:"segment",sampleLocation:"center",segment:this._labelSegment,callout:!1},fontSize:x(c),textColor:u.clone(),backgroundColor:h.clone(),isDecoration:o})}),this._handles.add([v(()=>n.geometry,m=>{this.updateCameraDependentElements(a.state.camera,m,i.style),n.geometry!=null&&this._updateLines(n.geometry)},{...tt,equals:Ct}),v(()=>n.length,m=>this._updateLabelContent(m),tt)])}destroy(){this.destroyed=!0,this._handles=Tt(this._handles);for(const e of this._visualElements.values())e.destroy()}get testInfo(){return{dimensionVisualElement:this._visualElements.dimension,label:this._visualElements.label}}_updateLines(e){const i=Kt(Ln,it.Start,e.directSegment,e.dimensionSegment),n=Kt(Gn,it.End,e.directSegment,e.dimensionSegment),a=this._visualElements;a.marker.setGeometryFromSegment(e.dimensionSegment,e.primaryOffsetAxis),a.dimension.setGeometryFromSegment(e.dimensionSegment),a.startOffset.setGeometryFromSegment(i),a.endOffset.setGeometryFromSegment(n),a.dimensionSmall.setGeometryFromSegment(e.dimensionSegment),a.startOffsetSmall.setGeometryFromSegment(i),a.endOffsetSmall.setGeometryFromSegment(n)}updateCameraDependentElements(e,i,n){const a=this._visualElements;if(i==null){for(const M of a.values())M.visible=!1;return}const s=e.computeScreenPixelSizeAt(i.dimensionSegment.eval(.5,In)),o=Wi(i,s),l=o<(x(n.lineSize)*cn)**2,r=!l;a.marker.visible=r,a.dimension.visible=r,a.startOffset.visible=r,a.endOffset.visible=r,a.dimensionSmall.visible=l,a.startOffsetSmall.visible=l,a.endOffsetSmall.visible=l;const c=x(n.fontSize)*rn,{label:u}=a;if(u.visible=o>=c**2,!u.visible)return;const{dimensionSegment:h,primaryOffsetAxis:m}=i,{offset:S}=this.computation.dimension,f=(Math.sign(S)>=0?1:-1)*this._labelOffsetPx(n)*s;Ii(this._labelSegment,h,m,f),u.updateLabelPosition()}updateLabelStyle(e){const{label:i}=this._visualElements;i.fontSize=x(e.fontSize),i.textColor=e.textColor,i.backgroundColor=e.textBackgroundColor}updateUnitsMessages(e){this._messages=e;const{length:i}=this.computation;this._updateLabelContent(i)}_updateLabelContent(e){const{label:i}=this._visualElements;e!=null&&this._messages!=null?i.text=Hi(this._messages,e,e.unit):i.text=""}_labelOffsetPx(e){return 1.5*x(e.fontSize)+on+x(e.lineSize/2)}};const Ln=new B,Gn=new B,In=b();class Un{constructor(e){this.marker=e.marker,this.dimension=e.dimension,this.startOffset=e.startOffset,this.endOffset=e.endOffset,this.dimensionSmall=e.dimensionSmall,this.startOffsetSmall=e.startOffsetSmall,this.endOffsetSmall=e.endOffsetSmall,this.label=e.label}values(){return[this.marker,this.dimension,this.startOffset,this.endOffset,this.dimensionSmall,this.startOffsetSmall,this.endOffsetSmall,this.label]}}let z=class extends J{get analysis(){return this.analysisViewData.analysis}get visible(){return this.analysisViewData.visible}constructor(t){super(t),this.loadingMessages=!1,this._messages=null}initialize(){const t=this.isDecoration;this._markerMaterial=new ge({width:1,anchor:di.Tip,color:X,placement:"begin-end",worldSpace:!0,hideOnShortSegments:!0,hasTip:!0,renderOccluded:P.OccludeAndTransparent,markerPrimitive:"triangle",isDecoration:t}),this._dimensionLineMaterial=new N({width:1,color:X,renderOccluded:P.OccludeAndTransparent,markerParameters:this._markerMaterial.parameters,isDecoration:t}),this._offsetLineMaterial=new N({width:1,color:X,renderOccluded:P.OccludeAndTransparent,stipplePattern:pt(5),isDecoration:t}),this._smallDimensionLineMaterial=new N({width:1,color:X,renderOccluded:P.OccludeAndTransparent,isDecoration:t}),this._smallOffsetLineMaterial=new N({width:1,color:X,renderOccluded:P.OccludeAndTransparent,stipplePattern:pt(5),isDecoration:t});for(const i of this._lineMaterials())this.view._stage.add(i),this.addHandles(de(()=>{var n;(n=this.view._stage)==null||n.remove(i)}));const e=ft(()=>this.analysisViewData.computations,({computation:i})=>this._createVisualization(i));this._dimensionVisualizations=e,this.addHandles([at(e),v(()=>j.toUnitRGBA(this.analysis.style.color),i=>{for(const n of this._lineMaterials())n.setParameters({color:i})},A),v(()=>this.analysis.style.lineSize,i=>{const n=x(i);this._markerMaterial.setParameters({width:n*we}),this._dimensionLineMaterial.setParameters({width:n,markerParameters:this._markerMaterial.parameters});const a=Math.max(n*sn,1);this._offsetLineMaterial.setParameters({width:a})},A),v(()=>({camera:this.view.state.camera,style:Fn(this.analysis)}),({camera:i,style:n})=>{for(const{visualization:a}of this._dimensionVisualizations)a.updateCameraDependentElements(i,a.computation.geometry,n),a.updateLabelStyle(n)}),v(()=>this.visible,i=>{for(const{visualization:n}of this._dimensionVisualizations)n.visible=i})]),this.addHandles([We(()=>this._updateMessageBundle()),At(()=>!this.loadingMessages,()=>{for(const{visualization:i}of this._dimensionVisualizations)i.updateUnitsMessages(this._messages)},bt)]),this._updateMessageBundle()}get testInfo(){return{visualizations:this._dimensionVisualizations.items.map(({visualization:t})=>t),disablePartialOcclusion:()=>{for(const t of this._lineMaterials())t.setParameters({renderOccluded:P.Occlude})}}}_createVisualization(t){const e=new En({analysis:this.analysis,computation:t,view:this.view,visible:this.visible,markerMaterial:this._markerMaterial,dimensionLineMaterial:this._dimensionLineMaterial,offsetLineMaterial:this._offsetLineMaterial,smallDimensionLineMaterial:this._smallDimensionLineMaterial,smallOffsetLineMaterial:this._smallOffsetLineMaterial,messages:this._messages,isDecoration:this.isDecoration});return{visualization:e,remove:()=>e.destroy()}}_lineMaterials(){return[this._markerMaterial,this._dimensionLineMaterial,this._offsetLineMaterial,this._smallDimensionLineMaterial,this._smallOffsetLineMaterial]}async _updateMessageBundle(){this.loadingMessages=!0;try{this._messages=await Ke("esri/core/t9n/Units")}finally{this.loadingMessages=!1}}};function Fn(t){const{fontSize:e,lineSize:i,textColor:n,textBackgroundColor:a}=t.style;return{fontSize:e,lineSize:i,textBackgroundColor:a.clone(),textColor:n.clone()}}d([p({constructOnly:!0})],z.prototype,"analysisViewData",void 0),d([p({constructOnly:!0,nonNullable:!0})],z.prototype,"view",void 0),d([p({constructOnly:!0})],z.prototype,"isDecoration",void 0),d([p()],z.prototype,"analysis",null),d([p()],z.prototype,"visible",null),d([p()],z.prototype,"loadingMessages",void 0),z=d([G("esri.views.3d.analysis.Dimension.DimensionVisualization")],z);let Y=class extends J{constructor(t){super(t),this.dimension=null,this.length=null}};d([p({constructOnly:!0,nonNullable:!0})],Y.prototype,"dimension",void 0),d([p()],Y.prototype,"length",void 0),Y=d([G("esri.views.3d.analysis.LengthDimensionResult")],Y);const jn=Y;let $=class extends J{constructor(t){super(t),this.geometry=null,this.unconstrainedGeometry=null,this.elevationAlignedStartPoint=null,this.elevationAlignedEndPoint=null}normalizeCtorArgs(t){const{dimension:e,...i}=t;return{result:new jn({dimension:e}),...i}}initialize(){this.addHandles([v(()=>this.dimension.startPoint,t=>this.elevationAlignedStartPoint=this.projectAndAlignPoint(t),A),v(()=>this.dimension.endPoint,t=>this.elevationAlignedEndPoint=this.projectAndAlignPoint(t),A)])}get dimension(){return this.result.dimension}get length(){return this.result.length}};d([p({constructOnly:!0,nonNullable:!0})],$.prototype,"result",void 0),d([p({constructOnly:!0,nonNullable:!0})],$.prototype,"projectAndAlignPoint",void 0),d([p()],$.prototype,"dimension",null),d([p()],$.prototype,"length",null),d([p()],$.prototype,"geometry",void 0),d([p()],$.prototype,"unconstrainedGeometry",void 0),d([p()],$.prototype,"elevationAlignedStartPoint",void 0),d([p()],$.prototype,"elevationAlignedEndPoint",void 0),d([p()],$.prototype,"preConstraintProperties",void 0),d([p()],$.prototype,"previousConstraint",void 0),$=d([G("esri.views.3d.analysis.LengthDimensionComputation")],$);const Bn=t=>{let e=class extends t{constructor(...i){super(...i),this.analysis=null,this.tool=null,this.selectedDimension=null,this.interactive=!1,this.visible=null}get results(){return new Je}createLengthDimensions(i){throw new Error("Method not implemented.")}};return d([p({constructOnly:!0})],e.prototype,"view",void 0),d([p({constructOnly:!0,nonNullable:!0})],e.prototype,"analysis",void 0),d([p()],e.prototype,"tool",void 0),d([p({readOnly:!0})],e.prototype,"results",null),d([p()],e.prototype,"selectedDimension",void 0),d([p()],e.prototype,"interactive",void 0),d([p()],e.prototype,"visible",void 0),e=d([G("esri.views.analysis.DimensionAnalysisView")],e),e};let C=class extends Bn(Xe(J)){constructor(t){super(t),this.type="dimension-view-3d",this.tool=null,this.selectedDimension=null,this._dimensionsToComputations=new Map,this._placementTask=null,this._projectAndAlignPoint=null}initialize(){this._projectAndAlignPoint=e=>{if(e==null)return null;const{spatialReference:i,elevationProvider:n}=this.view,a=gi(e,i,n);return a==null&&fi(this.analysis,e.spatialReference,ie.getLogger(this)),a};const t=ft(()=>this.analysis.dimensions,e=>this._createComputation(e));this.computations=t,this.addHandles([Vi(this,O),at(t)]),this._analysisVisualization=new z({analysisViewData:this,view:this.view,isDecoration:!this.parent}),this._analysisController=new U({analysisViewData:this,view:this.view})}destroy(){this._placementTask=qt(this._placementTask),this._analysisVisualization=Tt(this._analysisVisualization),Ei(this)}get updating(){var t;return((t=this._analysisVisualization)==null?void 0:t.loadingMessages)??!1}get results(){return this.analysis.dimensions.map(t=>this._dimensionsToComputations.get(t).result)}get selectedComputation(){const{selectedDimension:t}=this;return t==null?null:this._dimensionsToComputations.get(t)}get testInfo(){return{visualization:this._analysisVisualization,controller:this._analysisController}}async createLengthDimensions(t){return this.selectedDimension=null,this._placementTask=qt(this._placementTask),this._placementTask=Li(this,t),this._placementTask.promise}_createComputation(t){const{_dimensionsToComputations:e}=this,i=new $({dimension:t,projectAndAlignPoint:this._projectAndAlignPoint});return e.set(t,i),{computation:i,remove:()=>this._removeComputation(i)}}_removeComputation(t){const{dimension:e}=t;e===this.selectedDimension&&(this.selectedDimension=null),this._dimensionsToComputations.delete(e),t.destroy()}};d([p({readOnly:!0})],C.prototype,"type",void 0),d([p()],C.prototype,"tool",void 0),d([p()],C.prototype,"updating",null),d([p({readOnly:!0})],C.prototype,"results",null),d([p()],C.prototype,"computations",void 0),d([p()],C.prototype,"selectedDimension",void 0),d([p()],C.prototype,"selectedComputation",null),d([p()],C.prototype,"_analysisVisualization",void 0),d([p()],C.prototype,"_analysisController",void 0),d([p()],C.prototype,"_dimensionsToComputations",void 0),d([p()],C.prototype,"_placementTask",void 0),C=d([G("esri.views.3d.analysis.DimensionAnalysisView3D")],C);const eo=C;export{eo as default};
