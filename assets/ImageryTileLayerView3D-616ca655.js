import{s as y,gs as c,hO as u,a5 as n,a6 as h,a9 as g}from"./index-b516d057.js";import{n as f}from"./LayerView3D-c03d44fc.js";import{o as b}from"./TiledLayerView3D-14f64d5b.js";import{a0 as I}from"./SceneView-123ac862.js";import{p as R}from"./ImageryTileLayerView-59c582f2.js";import{u as w}from"./LayerView-060b46d4.js";import{a as z}from"./RefreshableLayerView-4a86a8ac.js";import{r as T}from"./drapedUtils-5cffceb9.js";import{n as x}from"./capabilities-9d56a1da.js";import"./heightModelInfoUtils-0dd2b6e4.js";import"./HeightModelInfo-b816d32b.js";import"./terrainUtils-b6b761ab.js";import"./ViewingMode-5d7d590b.js";import"./Scheduler-ff5943a4.js";import"./signal-51ed66f5.js";import"./debugFlags-9a30f077.js";import"./RenderState-1d6218ee.js";import"./Viewpoint-f83262d0.js";import"./Cyclical-4c223a04.js";import"./jsxFactory-92036771.js";import"./uuid-709b6c67.js";import"./ElevationQuery-a3eaf0a0.js";import"./RenderGeometry-5dbc1699.js";import"./vec3f32-bac7ea57.js";import"./DefaultTechniqueConfiguration-b4dbe32f.js";import"./requestImageUtils-b142708c.js";import"./enums-bdecffa2.js";import"./Texture-bcb6d63f.js";import"./contextUtils-81fda295.js";import"./interfaces-8918b36f.js";import"./Material-5f4156ac.js";import"./FramebufferObject-123b7c8d.js";import"./ShaderTechniqueConfiguration-2502462e.js";import"./ElevationProvider-abb53936.js";import"./dehydratedPoint-5a1dfed5.js";import"./hydratedFeatures-2365c307.js";import"./weather-2eb64924.js";import"./NestedMap-1b5db22e.js";import"./frustum-f9d53cdf.js";import"./VertexElementDescriptor-2925c6af.js";import"./VertexArrayObject-d19dab8d.js";import"./Octree-7cea9440.js";import"./InterleavedLayout-d76b0d59.js";import"./types-1305598a.js";import"./OrderIndependentTransparency-755f7dcc.js";import"./floatRGBA-ca990bbb.js";import"./Intersector-2e1d9db3.js";import"./Intersector-fa865806.js";import"./boundedPlane-1da2f094.js";import"./verticalOffsetUtils-e5214af9.js";import"./orientedBoundingBox-67c5cd22.js";import"./glUtil-ce5ee52b.js";import"./vec2f32-eaf29605.js";import"./ColorMaterial-bdf1f62a.js";import"./VerticalOffset.glsl-5743f98e.js";import"./dehydratedFeatures-2a3f0608.js";import"./quantizationUtils-17105106.js";import"./featureConversionUtils-09cf00ff.js";import"./OptimizedFeature-e90b69df.js";import"./OptimizedFeatureSet-1d1ac4b9.js";import"./OptimizedGeometry-196224d4.js";import"./edgeUtils-6e4a97fb.js";import"./SnappingCandidate-970faec6.js";import"./objectResourceUtils-003803db.js";import"./devEnvironmentUtils-4eab2a99.js";import"./DefaultMaterial_COLOR_GAMMA-101ea40c.js";import"./Version-1f969b2a.js";import"./resourceUtils-1d03d2fe.js";import"./mat3f32-6c416b1c.js";import"./symbolColorUtils-3ca646c8.js";import"./callExpressionWithFeature-36423058.js";import"./lineStippleUtils-0688e06c.js";import"./projectVectorToDehydratedPoint-e30a7ff8.js";import"./interfaces-1a80c8eb.js";import"./webStyleSymbolUtils-4761c8f2.js";import"./Intersector-a291e778.js";import"./fontUtils-56b88a2f.js";import"./projectVectorToVector-56c29b20.js";import"./coordinateSystem-38339d17.js";import"./scaleUtils-72744379.js";import"./LayerConstants-d3ac1b7a.js";import"./DefaultUI-af7068c2.js";import"./UpdatingHandles-7949a657.js";import"./screenUtils-8dc4a7f9.js";import"./Map-1ad4186f.js";import"./Basemap-8d62c69e.js";import"./loadAll-5e767cfa.js";import"./writeUtils-e226a8aa.js";import"./Ground-ed93a93a.js";import"./CollectionFlattener-193451da.js";import"./editableLayers-856f2cb4.js";import"./basemapUtils-6ec10a55.js";import"./TablesMixin-292d1d89.js";import"./IViewEvents-9a85f53d.js";import"./interfaces-0421c5e6.js";import"./mat2d-d4af8487.js";import"./mat2df32-fb26a8c9.js";import"./mat2df64-4d1a9198.js";import"./themeUtils-7dcf5b71.js";import"./globalCss-94006b67.js";import"./accessibleHandler-e91101b2.js";import"./Compass-b37d7d1d.js";import"./GoTo-4d856ce0.js";import"./NavigationToggle-57c00adb.js";import"./Zoom-73b5f25a.js";import"./resources-d4afed0c.js";import"./viewpointUtils-245ed782.js";import"./projectPointToVectorWithEngine-f608a34a.js";import"./projectVectorToPoint-fbaf5599.js";import"./earthUtils-ef4b5643.js";import"./spatialReferenceSupport-5aeb751c.js";import"./ElevationSamplerData-9f34f589.js";import"./Environment-91bfea7d.js";import"./projectPointToWGS84ComparableLonLat-1ba40d40.js";import"./projectVectorToWGS84ComparableLonLat-5675a9f4.js";import"./ShadowCastVisualizeTechniqueConfiguration-4fcc4e25.js";import"./ray-8da55042.js";import"./ZoomMomentumEstimator-7437d26a.js";import"./labelFormatUtils-d440367f.js";import"./labelUtils-b29175f3.js";import"./FeatureTileDescriptor3D-27dbeac7.js";import"./geometryServiceUtils-3e048225.js";import"./project-1bd91657.js";import"./RenderCoordsHelper-8f237859.js";import"./intersectorUtilsConversions-d05d75a3.js";import"./LercDecoder-b49c0e9c.js";import"./WorkerHandle-9433ab9a.js";import"./RenderableTile-52f61d09.js";import"./enums-fb086c25.js";import"./config-1337d16e.js";import"./TiledDisplayObject-e7d105ae.js";import"./DisplayObject-9a6e3923.js";import"./TileKey-4b1303ff.js";import"./rasterUtils-15abcc11.js";import"./TileInfoView-ce4d65fb.js";import"./TileStrategy-a729431f.js";import"./QueueProcessor-4b9d43d3.js";import"./StyleDefinition-29c49b98.js";import"./enums-f1a6a48a.js";import"./edgeProcessing-82213448.js";import"./resources-15104e7a.js";import"./EdgeWorkerHandle-7d97defa.js";import"./workerHelper-d1cc0cda.js";import"./testSVGPremultipliedAlpha-f5e92e14.js";import"./DefaultVertexAttributeLayouts-8962d8eb.js";import"./RenderingContext-c0ea7a49.js";import"./ProgramCache-891c4b8d.js";import"./Program-96bc94ed.js";import"./hitTestSelectUtils-d512707e.js";import"./layerViewUtils-6ebe90f4.js";import"./popupUtils-e4ebc84a.js";let a=class extends R(z(b(f(w)))){constructor(){super(...arguments),this.type="imagery-tile-3d",this.isAlignedMapTile=!0}initialize(){this.layer.increaseRasterJobHandlerUsage(),this.fullExtent==null&&this.addResolvingPromise(Promise.reject(new y("layerview:spatial-reference-incompatible","The layer extent cannot be projected to the view's spatial reference",{layer:this.layer})));const t=c(()=>{var i,e;return(e=(i=this.view)==null?void 0:i.basemapTerrain)==null?void 0:e.tilingSchemeLocked}).then(()=>{const i=this.view.basemapTerrain.tilingScheme,e=this.layer.tileInfo,r=["png","png24","png32","jpg","mixed"].includes(e.format)&&i.compatibleWith(e);this.isAlignedMapTile=r;const o=r?e:i.toTileInfo();this.tileInfo=o,this._updatingHandles.add(()=>[this.layer.renderer,this.layer.interpolation,this.layer.bandIds,this.layer.multidimensionalDefinition,this.layer.multidimensionalSubset,this.layer.rasterFunction,this.timeExtent],()=>this.refresh())});this.addResolvingPromise(t)}destroy(){this.layer.decreaseRasterJobHandlerUsage(),this.view=null}get _blankTile(){const t=document.createElement("canvas"),i=t.getContext("2d"),[e,r]=this.tileInfo.size;return t.width=e,t.height=r,i.clearRect(0,0,e,r),i.getImageData(0,0,e,r)}get imageFormatIsOpaque(){return this.layer.tileInfo.format==="jpg"}get hasMixedImageFormats(){return this.layer.tileInfo.format==="mixed"}get dataLevelRange(){var r,o;const t=this.layer.tileInfo,i=(r=this.tileInfo.lodAt(0))==null?void 0:r.scale,e=(o=this.layer.tileInfo.lodAt(t.lods.length-1))==null?void 0:o.scale;return this.levelRangeFromScaleRange(i,e)}_getfullExtent(){var t;return u(this.layer.rasterInfo,((t=this.view.basemapTerrain)==null?void 0:t.spatialReference)!=null?this.view.basemapTerrain.spatialReference:this.view.spatialReference)}async fetchTile(t,i,e,r){const o=this.tileInfo,s=this._canSymbolizeInWebGL(),d={tileInfo:o,requestRawData:s,signal:r.signal,timeExtent:this.timeExtent,requestAsImageElement:this.isAlignedMapTile},m=await this.layer.fetchTile(t,i,e,d);if(m instanceof HTMLImageElement)return m;let l=m==null?void 0:m.pixelBlock;if(l==null)return this._blankTile;if(!s&&(l=await this.layer.applyRenderer(m),l==null))return this._blankTile;const p=new I([t,i,e],l,o.size[0],o.size[1]);return s?(p.symbolizerRenderer=this.layer.symbolizer.rendererJSON,p.symbolizerParameters=this.layer.symbolizer.generateWebGLParameters(this._getSymbolizerOptions(t)),p.transformGrid=m.transformGrid):p.isRendereredSource=!0,p.interpolation=this.layer.interpolation,p.bandIds=this.layer.bandIds,p}_getSymbolizerOptions(t){var e;const i=this.tileInfo.lodAt(t).resolution;return{pixelBlock:null,isGCS:((e=this.view.basemapTerrain)==null?void 0:e.spatialReference)!=null?this.view.basemapTerrain.spatialReference.isGeographic:this.view.spatialReference.isGeographic,resolution:{x:i,y:i},bandIds:this.layer.bandIds}}ensureSymbolizerParameters(t){this._canSymbolizeInWebGL()&&JSON.stringify(t.symbolizerRenderer)!==JSON.stringify(this.layer.symbolizer.rendererJSON)&&(t.symbolizerParameters=this.layer.symbolizer.generateWebGLParameters(this._getSymbolizerOptions(t.lij[0])))}createFetchPopupFeaturesQueryGeometry(t,i){return T(t,i,this.view)}refresh(){this.emit("data-changed")}async doRefresh(){this.suspended||this.emit("data-changed")}_canSymbolizeInWebGL(){var o,s;const t=x("3d"),{symbolizer:i}=this.layer,e=(s=(o=i.lookup)==null?void 0:o.colormapLut)==null?void 0:s.indexedColormap,r=e&&e.length>4*(t.maxTextureSize||4906);return t.supportsTextureFloat&&i.canRenderInWebGL&&!r}};n([h({readOnly:!0})],a.prototype,"_blankTile",null),n([h({readOnly:!0})],a.prototype,"imageFormatIsOpaque",null),n([h({readOnly:!0})],a.prototype,"hasMixedImageFormats",null),n([h({readOnly:!0})],a.prototype,"dataLevelRange",null),a=n([g("esri.views.3d.layers.ImageryTileLayerView3D")],a);const ce=a;export{ce as default};
