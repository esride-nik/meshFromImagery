import{gH as l,fO as et,mt as It,f9 as pt,f6 as X,d8 as nt,fe as z,fd as At,fc as Ot,fC as ft,fk as ot,fv as lt,aW as v,d2 as dt,mu as ht,mv as St}from"./index-b516d057.js";import{H as x}from"./InterleavedLayout-d76b0d59.js";import{r as G}from"./glUtil-ce5ee52b.js";const Tt=x().vec3f(l.POSITION).u16(l.COMPONENTINDEX),wt=x().vec2u8(l.SIDENESS),Wt=G(wt),B=x().vec3f(l.POSITION0).vec3f(l.POSITION1).vec3f(l.NORMAL).u16(l.COMPONENTINDEX).u8(l.VARIANTOFFSET,{glNormalized:!0}).u8(l.VARIANTSTROKE).u8(l.VARIANTEXTENSION,{glNormalized:!0}),K=x().vec3f(l.POSITION0).vec3f(l.POSITION1).vec3f(l.NORMALA).vec3f(l.NORMALB).u16(l.COMPONENTINDEX).u8(l.VARIANTOFFSET,{glNormalized:!0}).u8(l.VARIANTSTROKE).u8(l.VARIANTEXTENSION,{glNormalized:!0}),Ht=new Map([[l.POSITION0,0],[l.POSITION1,1],[l.COMPONENTINDEX,2],[l.VARIANTOFFSET,3],[l.VARIANTSTROKE,4],[l.VARIANTEXTENSION,5],[l.NORMAL,6],[l.NORMALA,6],[l.NORMALB,7],[l.SIDENESS,8]]),P=-1;var st;function vt(t,e,o,s=Mt){const r=t.vertices.position,c=t.vertices.componentIndex,m=et(s.anglePlanar),a=et(s.angleSignificantEdge),I=Math.cos(a),f=Math.cos(m),u=k.edge,A=u.position0,O=u.position1,p=u.faceNormal0,E=u.faceNormal1,d=Pt(t),$=Vt(t),n=$.length/4,i=e.allocate(n);let g=0;const N=n,h=o.allocate(N);let w=0,y=0,S=0;const Q=It(0,n),D=new Float32Array(n);D.forEach((M,T,F)=>{r.getVec($[4*T],A),r.getVec($[4*T+1],O),F[T]=pt(A,O)}),Q.sort((M,T)=>D[T]-D[M]);const Y=new Array,Z=new Array;for(let M=0;M<n;M++){const T=Q[M],F=D[T],H=$[4*T],mt=$[4*T+1],R=$[4*T+2],_=$[4*T+3],tt=_===P;if(r.getVec(H,A),r.getVec(mt,O),tt)X(p,d[3*R],d[3*R+1],d[3*R+2]),nt(E,p),u.componentIndex=c.get(H),u.cosAngle=z(p,E);else{if(X(p,d[3*R],d[3*R+1],d[3*R+2]),X(E,d[3*_],d[3*_+1],d[3*_+2]),u.componentIndex=c.get(H),u.cosAngle=z(p,E),$t(u,f))continue;u.cosAngle<-.9999&&nt(E,p)}y+=F,S++,tt||Et(u,I)?(e.write(i,g++,u),Y.push(F)):yt(u,m)&&(o.write(h,w++,u),Z.push(F))}const gt=new Float32Array(Y.reverse()),Nt=new Float32Array(Z.reverse());return{regular:{instancesData:e.trim(i,g),lodInfo:{lengths:gt}},silhouette:{instancesData:o.trim(h,w),lodInfo:{lengths:Nt}},averageEdgeLength:y/S}}function Et(t,e){return t.cosAngle<e}function $t(t,e){return t.cosAngle>e}function yt(t,e){const o=At(t.cosAngle),s=k.fwd,r=k.ortho;return Ot(s,t.position1,t.position0),o*(z(ft(r,t.faceNormal0,t.faceNormal1),s)>0?-1:1)>e}function Vt(t){const e=t.faces.length/3,o=t.faces,s=t.neighbors;let r=0;for(let a=0;a<e;a++){const I=s[3*a],f=s[3*a+1],u=s[3*a+2],A=o[3*a],O=o[3*a+1],p=o[3*a+2];r+=I===P||A<O?1:0,r+=f===P||O<p?1:0,r+=u===P||p<A?1:0}const c=new Int32Array(4*r);let m=0;for(let a=0;a<e;a++){const I=s[3*a],f=s[3*a+1],u=s[3*a+2],A=o[3*a],O=o[3*a+1],p=o[3*a+2];(I===P||A<O)&&(c[m++]=A,c[m++]=O,c[m++]=a,c[m++]=I),(f===P||O<p)&&(c[m++]=O,c[m++]=p,c[m++]=a,c[m++]=f),(u===P||p<A)&&(c[m++]=p,c[m++]=A,c[m++]=a,c[m++]=u)}return c}function Pt(t){const e=t.faces.length/3,o=t.vertices.position,s=t.faces,r=U.v0,c=U.v1,m=U.v2,a=new Float32Array(3*e);for(let I=0;I<e;I++){const f=s[3*I],u=s[3*I+1],A=s[3*I+2];o.getVec(f,r),o.getVec(u,c),o.getVec(A,m),ot(c,c,r),ot(m,m,r),ft(r,c,m),lt(r,r),a[3*I]=r[0],a[3*I+1]=r[1],a[3*I+2]=r[2]}return a}(function(t){t[t.SOLID=0]="SOLID",t[t.SKETCH=1]="SKETCH"})(st||(st={}));const k={edge:{position0:v(),position1:v(),faceNormal0:v(),faceNormal1:v(),componentIndex:0,cosAngle:0},ortho:v(),fwd:v()},U={v0:v(),v1:v(),v2:v()},Mt={anglePlanar:4,angleSignificantEdge:35};function rt(t,e,o){const s=e/3,r=new Uint32Array(o+1),c=new Uint32Array(o+1),m=(n,i)=>{n<i?r[n+1]++:c[i+1]++};for(let n=0;n<s;n++){const i=t[3*n],g=t[3*n+1],N=t[3*n+2];m(i,g),m(g,N),m(N,i)}let a=0,I=0;for(let n=0;n<o;n++){const i=r[n+1],g=c[n+1];r[n+1]=a,c[n+1]=I,a+=i,I+=g}const f=new Uint32Array(6*s),u=r[o],A=(n,i,g)=>{if(n<i){const N=r[n+1]++;f[2*N]=i,f[2*N+1]=g}else{const N=c[i+1]++;f[2*u+2*N]=n,f[2*u+2*N+1]=g}};for(let n=0;n<s;n++){const i=t[3*n],g=t[3*n+1],N=t[3*n+2];A(i,g,n),A(g,N,n),A(N,i,n)}const O=(n,i)=>{const g=2*n,N=i-n;for(let h=1;h<N;h++){const w=f[g+2*h],y=f[g+2*h+1];let S=h-1;for(;S>=0&&f[g+2*S]>w;S--)f[g+2*S+2]=f[g+2*S],f[g+2*S+3]=f[g+2*S+1];f[g+2*S+2]=w,f[g+2*S+3]=y}};for(let n=0;n<o;n++)O(r[n],r[n+1]),O(u+c[n],u+c[n+1]);const p=new Int32Array(3*s),E=(n,i)=>n===t[3*i]?0:n===t[3*i+1]?1:n===t[3*i+2]?2:-1,d=(n,i)=>{const g=E(n,i);p[3*i+g]=-1},$=(n,i,g,N)=>{const h=E(n,i);p[3*i+h]=N;const w=E(g,N);p[3*N+w]=i};for(let n=0;n<o;n++){let i=r[n];const g=r[n+1];let N=c[n];const h=c[n+1];for(;i<g&&N<h;){const w=f[2*i],y=f[2*u+2*N];w===y?($(n,f[2*i+1],y,f[2*u+2*N+1]),i++,N++):w<y?(d(n,f[2*i+1]),i++):(d(y,f[2*u+2*N+1]),N++)}for(;i<g;)d(n,f[2*i+1]),i++;for(;N<h;)d(f[2*u+2*N],f[2*u+2*N+1]),N++}return p}let ut=class{updateSettings(e){this.settings=e,this._edgeHashFunction=e.reducedPrecision?Lt:Rt}write(e,o,s){const r=this._edgeHashFunction(s);b.seed=r;const c=b.getIntRange(0,255),m=b.getIntRange(0,this.settings.variants-1),a=.7,I=b.getFloat(),f=255*(.5*xt(-(1-Math.min(I/a,1))+Math.max(0,I-a)/(1-a),1.2)+.5);e.position0.setVec(o,s.position0),e.position1.setVec(o,s.position1),e.componentIndex.set(o,s.componentIndex),e.variantOffset.set(o,c),e.variantStroke.set(o,m),e.variantExtension.set(o,f)}trim(e,o){return e.slice(0,o)}};const J=new Float32Array(6),W=new Uint32Array(J.buffer),V=new Uint32Array(1);function Rt(t){const e=J;e[0]=t.position0[0],e[1]=t.position0[1],e[2]=t.position0[2],e[3]=t.position1[0],e[4]=t.position1[1],e[5]=t.position1[2],V[0]=5381;for(let o=0;o<W.length;o++)V[0]=31*V[0]+W[o];return V[0]}function Lt(t){const e=J;e[0]=L(t.position0[0]),e[1]=L(t.position0[1]),e[2]=L(t.position0[2]),e[3]=L(t.position1[0]),e[4]=L(t.position1[1]),e[5]=L(t.position1[2]),V[0]=5381;for(let o=0;o<W.length;o++)V[0]=31*V[0]+W[o];return V[0]}const it=1e4;function L(t){return Math.round(t*it)/it}function xt(t,e){const o=t<0?-1:1;return Math.abs(t)**e*o}let q=class{constructor(){this._commonWriter=new ut}updateSettings(e){this._commonWriter.updateSettings(e)}allocate(e){return B.createBuffer(e)}write(e,o,s){this._commonWriter.write(e,o,s),dt(C,s.faceNormal0,s.faceNormal1),lt(C,C),e.normal.setVec(o,C)}trim(e,o){return this._commonWriter.trim(e,o)}};q.Layout=B,q.glLayout=G(B,1);class j{constructor(){this._commonWriter=new ut}updateSettings(e){this._commonWriter.updateSettings(e)}allocate(e){return K.createBuffer(e)}write(e,o,s){this._commonWriter.write(e,o,s),e.normalA.setVec(o,s.faceNormal0),e.normalB.setVec(o,s.faceNormal1)}trim(e,o){return this._commonWriter.trim(e,o)}}j.Layout=K,j.glLayout=G(K,1);const C=v(),b=new ht;function zt(t){const e=Ft(t.data,t.skipDeduplicate,t.indices,t.indicesLength);return ct.updateSettings(t.writerSettings),at.updateSettings(t.writerSettings),vt(e,ct,at)}function Ft(t,e,o,s){if(e){const m=rt(o,s,t.count);return new Dt(o,s,m,t)}const r=St(t.buffer,t.stride/4,{originalIndices:o,originalIndicesLength:s}),c=rt(r.indices,s,r.uniqueCount);return{faces:r.indices,facesLength:r.indices.length,neighbors:c,vertices:Tt.createView(r.buffer)}}class Dt{constructor(e,o,s,r){this.faces=e,this.facesLength=o,this.neighbors=s,this.vertices=r}}const ct=new q,at=new j,Bt=x().vec3f(l.POSITION0).vec3f(l.POSITION1),Kt=x().vec3f(l.POSITION0).vec3f(l.POSITION1).u16(l.COMPONENTINDEX);export{wt as A,Wt as E,Tt as T,st as a,q as b,Bt as d,zt as f,Kt as m,vt as p,Ht as r,Ft as u,j as w};
