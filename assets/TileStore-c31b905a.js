import{bj as k,M as E,kY as F,bg as j,k as O}from"./index-b516d057.js";import{f as R}from"./quickselect-bc0541de.js";import{a as V}from"./QuantizationParameters-f983cf8d.js";import{e as I}from"./TileKey-4b1303ff.js";import{l as C}from"./TileInfoView-ce4d65fb.js";function Y(i,t){if(!(this instanceof Y))return new Y(i,t);this._maxEntries=Math.max(4,i||9),this._minEntries=Math.max(2,Math.ceil(.4*this._maxEntries)),t&&(typeof t=="function"?this.toBBox=t:this._initFormat(t)),this.clear()}function P(i,t,e){if(!e)return t.indexOf(i);for(var n=0;n<t.length;n++)if(e(i,t[n]))return n;return-1}function d(i,t){x(i,0,i.children.length,t,i)}function x(i,t,e,n,h){h||(h=f(null)),h.minX=1/0,h.minY=1/0,h.maxX=-1/0,h.maxY=-1/0;for(var r,s=t;s<e;s++)r=i.children[s],p(h,i.leaf?n(r):r);return h}function p(i,t){return i.minX=Math.min(i.minX,t.minX),i.minY=Math.min(i.minY,t.minY),i.maxX=Math.max(i.maxX,t.maxX),i.maxY=Math.max(i.maxY,t.maxY),i}function b(i,t){return i.minX-t.minX}function w(i,t){return i.minY-t.minY}function X(i){return(i.maxX-i.minX)*(i.maxY-i.minY)}function g(i){return i.maxX-i.minX+(i.maxY-i.minY)}function T(i,t){return(Math.max(t.maxX,i.maxX)-Math.min(t.minX,i.minX))*(Math.max(t.maxY,i.maxY)-Math.min(t.minY,i.minY))}function D(i,t){var e=Math.max(i.minX,t.minX),n=Math.max(i.minY,t.minY),h=Math.min(i.maxX,t.maxX),r=Math.min(i.maxY,t.maxY);return Math.max(0,h-e)*Math.max(0,r-n)}function v(i,t){return i.minX<=t.minX&&i.minY<=t.minY&&t.maxX<=i.maxX&&t.maxY<=i.maxY}function _(i,t){return t.minX<=i.maxX&&t.minY<=i.maxY&&t.maxX>=i.minX&&t.maxY>=i.minY}function f(i){return{children:i,height:1,leaf:!0,minX:1/0,minY:1/0,maxX:-1/0,maxY:-1/0}}function S(i,t,e,n,h){for(var r,s=[t,e];s.length;)(e=s.pop())-(t=s.pop())<=n||(r=t+Math.ceil((e-t)/n/2)*n,R(i,r,t,e,h),s.push(t,r,r,e))}Y.prototype={all:function(){return this._all(this.data,[])},search:function(i){var t=this.data,e=[],n=this.toBBox;if(!_(i,t))return e;for(var h,r,s,a,o=[];t;){for(h=0,r=t.children.length;h<r;h++)s=t.children[h],_(i,a=t.leaf?n(s):s)&&(t.leaf?e.push(s):v(i,a)?this._all(s,e):o.push(s));t=o.pop()}return e},collides:function(i){var t=this.data,e=this.toBBox;if(!_(i,t))return!1;for(var n,h,r,s,a=[];t;){for(n=0,h=t.children.length;n<h;n++)if(r=t.children[n],_(i,s=t.leaf?e(r):r)){if(t.leaf||v(i,s))return!0;a.push(r)}t=a.pop()}return!1},load:function(i){if(!i||!i.length)return this;if(i.length<this._minEntries){for(var t=0,e=i.length;t<e;t++)this.insert(i[t]);return this}var n=this._build(i.slice(),0,i.length-1,0);if(this.data.children.length)if(this.data.height===n.height)this._splitRoot(this.data,n);else{if(this.data.height<n.height){var h=this.data;this.data=n,n=h}this._insert(n,this.data.height-n.height-1,!0)}else this.data=n;return this},insert:function(i){return i&&this._insert(i,this.data.height-1),this},clear:function(){return this.data=f([]),this},remove:function(i,t){if(!i)return this;for(var e,n,h,r,s=this.data,a=this.toBBox(i),o=[],l=[];s||o.length;){if(s||(s=o.pop(),n=o[o.length-1],e=l.pop(),r=!0),s.leaf&&(h=P(i,s.children,t))!==-1)return s.children.splice(h,1),o.push(s),this._condense(o),this;r||s.leaf||!v(s,a)?n?(e++,s=n.children[e],r=!1):s=null:(o.push(s),l.push(e),e=0,n=s,s=s.children[0])}return this},toBBox:function(i){return i},compareMinX:b,compareMinY:w,toJSON:function(){return this.data},fromJSON:function(i){return this.data=i,this},_all:function(i,t){for(var e=[];i;)i.leaf?t.push.apply(t,i.children):e.push.apply(e,i.children),i=e.pop();return t},_build:function(i,t,e,n){var h,r=e-t+1,s=this._maxEntries;if(r<=s)return d(h=f(i.slice(t,e+1)),this.toBBox),h;n||(n=Math.ceil(Math.log(r)/Math.log(s)),s=Math.ceil(r/Math.pow(s,n-1))),(h=f([])).leaf=!1,h.height=n;var a,o,l,m,u=Math.ceil(r/s),M=u*Math.ceil(Math.sqrt(s));for(S(i,t,e,M,this.compareMinX),a=t;a<=e;a+=M)for(S(i,a,l=Math.min(a+M-1,e),u,this.compareMinY),o=a;o<=l;o+=u)m=Math.min(o+u-1,l),h.children.push(this._build(i,o,m,n-1));return d(h,this.toBBox),h},_chooseSubtree:function(i,t,e,n){for(var h,r,s,a,o,l,m,u;n.push(t),!t.leaf&&n.length-1!==e;){for(m=u=1/0,h=0,r=t.children.length;h<r;h++)o=X(s=t.children[h]),(l=T(i,s)-o)<u?(u=l,m=o<m?o:m,a=s):l===u&&o<m&&(m=o,a=s);t=a||t.children[0]}return t},_insert:function(i,t,e){var n=this.toBBox,h=e?i:n(i),r=[],s=this._chooseSubtree(h,this.data,t,r);for(s.children.push(i),p(s,h);t>=0&&r[t].children.length>this._maxEntries;)this._split(r,t),t--;this._adjustParentBBoxes(h,r,t)},_split:function(i,t){var e=i[t],n=e.children.length,h=this._minEntries;this._chooseSplitAxis(e,h,n);var r=this._chooseSplitIndex(e,h,n),s=f(e.children.splice(r,e.children.length-r));s.height=e.height,s.leaf=e.leaf,d(e,this.toBBox),d(s,this.toBBox),t?i[t-1].children.push(s):this._splitRoot(e,s)},_splitRoot:function(i,t){this.data=f([i,t]),this.data.height=i.height+1,this.data.leaf=!1,d(this.data,this.toBBox)},_chooseSplitIndex:function(i,t,e){var n,h,r,s,a,o,l,m;for(o=l=1/0,n=t;n<=e-t;n++)s=D(h=x(i,0,n,this.toBBox),r=x(i,n,e,this.toBBox)),a=X(h)+X(r),s<o?(o=s,m=n,l=a<l?a:l):s===o&&a<l&&(l=a,m=n);return m},_chooseSplitAxis:function(i,t,e){var n=i.leaf?this.compareMinX:b,h=i.leaf?this.compareMinY:w;this._allDistMargin(i,t,e,n)<this._allDistMargin(i,t,e,h)&&i.children.sort(n)},_allDistMargin:function(i,t,e,n){i.children.sort(n);var h,r,s=this.toBBox,a=x(i,0,t,s),o=x(i,e-t,e,s),l=g(a)+g(o);for(h=t;h<e-t;h++)r=i.children[h],p(a,i.leaf?s(r):r),l+=g(a);for(h=e-t-1;h>=t;h--)r=i.children[h],p(o,i.leaf?s(r):r),l+=g(o);return l},_adjustParentBBoxes:function(i,t,e){for(var n=e;n>=0;n--)p(t[n],i)},_condense:function(i){for(var t,e=i.length-1;e>=0;e--)i[e].children.length===0?e>0?(t=i[e-1].children).splice(t.indexOf(i[e]),1):this.clear():d(i[e],this.toBBox)},_initFormat:function(i){var t=["return a"," - b",";"];this.compareMinX=new Function("a","b",t.join(i[0])),this.compareMinY=new Function("a","b",t.join(i[1])),this.toBBox=new Function("a","return {minX: a"+i[0]+", minY: a"+i[1]+", maxX: a"+i[2]+", maxY: a"+i[3]+"};")}};let y=class ${constructor(t,e){this.key=new I(0,0,0,0),this.bounds=k(),this.objectIds=new Set,this.key.set(e);const n=t.getLODInfoAt(this.key);this.tileInfoView=t,this.tileInfoView.getTileBounds(this.bounds,this.key,!0),this.resolution=n.resolution,this.scale=n.scale,this.level=n.level}get id(){return this.key.id}get extent(){return E.fromBounds(this.bounds,this.tileInfoView.tileInfo.spatialReference)}get transform(){return{originPosition:"upperLeft",scale:[this.resolution,this.resolution],translate:[this.bounds[0],this.bounds[3]]}}createChildTiles(){const t=this.key.getChildKeys(),e=F.acquire();for(let n=0;n<t.length;n++)e[n]=new $(this.tileInfoView,t[n]);return e}getQuantizationParameters(){return V.fromJSON({mode:"view",originPosition:"upperLeft",tolerance:this.resolution,extent:{xmin:this.bounds[0],ymin:this.bounds[1],xmax:this.bounds[2],ymax:this.bounds[3],spatialReference:this.tileInfoView.tileInfo.spatialReference}})}};const c={added:[],removed:[]},B=new Set,A=new I(0,0,0,0);let K=class extends j{constructor(t){super(),this._tiles=new Map,this._index=Y(9,O("esri-csp-restrictions")?e=>({minX:e.bounds[0],minY:e.bounds[1],maxX:e.bounds[2],maxY:e.bounds[3]}):[".bounds[0]",".bounds[1]",".bounds[2]",".bounds[3]"]),this.tiles=[],this.tileScheme=t}destroy(){this.clear()}clear(){this.tiles.length=0,this._tiles.clear(),this._index.clear()}has(t){return this._tiles.has(t)}get(t){return this._tiles.get(t)}boundsIntersections(t){return this._index.search({minX:t[0],minY:t[1],maxX:t[2],maxY:t[3]})}updateTiles(t){const e={added:[],removed:[]};for(const n of t.added)if(!this.has(n)){const h=new y(this.tileScheme,n);this._tiles.set(n,h),this._index.insert(h),e.added.push(h)}for(const n of t.removed)if(this.has(n)){const h=this.get(n);this._tiles.delete(n),this._index.remove(h),e.removed.push(h)}this.tiles.length=0,this._tiles.forEach(n=>this.tiles.push(n)),(e.added.length||e.removed.length)&&this.emit("update",e)}setViewState(t){const e=this.tileScheme.getTileCoverage(t,0);if(!e)return;const{spans:n,lodInfo:h}=e,{level:r}=h;if(n.length>0)for(const{row:s,colFrom:a,colTo:o}of n)for(let l=a;l<=o;l++){const m=A.set(r,s,h.normalizeCol(l),h.getWorldForColumn(l)).id;if(B.add(m),!this.has(m)){const u=new y(this.tileScheme,m);this._tiles.set(m,u),this._index.insert(u),this.tiles.push(u),c.added.push(u)}}for(let s=this.tiles.length-1;s>=0;s--){const a=this.tiles[s];B.has(a.id)||(this._tiles.delete(a.id),this.tiles.splice(s,1),this._index.remove(a),c.removed.push(a))}(c.added.length||c.removed.length)&&this.emit("update",c),C.pool.release(e),B.clear(),c.added.length=0,c.removed.length=0}};export{K as d,Y as i};
