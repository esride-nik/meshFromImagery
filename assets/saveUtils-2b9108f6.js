import{dt as I,y as v,s as g,du as b,x as h}from"./index-b516d057.js";import{n as k}from"./uuid-709b6c67.js";import{getSiblingOfSameTypeI as x,contentToBlob as f}from"./resourceUtils-2ae38811.js";async function $(e,t,r=null){const o=await l(e,t,r);await m(o,t,r)}async function A(e,t,r,o,a=null){const n=await l(r,o,a);await e.update({data:t}),await m(n,o,a)}async function l(e,t,r=null){if(!(t!=null&&t.resources))return;const o=t.portalItem===e.portalItem?new Set(e.paths):new Set;e.paths.length=0,e.portalItem=t.portalItem;const a=new Set(t.resources.toKeep.map(s=>s.resource.path)),n=new Set,c=[];a.forEach(s=>{o.delete(s),e.paths.push(s)});for(const s of t.resources.toUpdate)if(o.delete(s.resource.path),a.has(s.resource.path)||n.has(s.resource.path)){const{resource:w,content:d,finish:y,error:S}=s,p=x(w,k());e.paths.push(p.path),c.push(i({resource:p,content:d,compress:s.compress,finish:y,error:S},r))}else e.paths.push(s.resource.path),c.push(F(s,r)),n.add(s.resource.path);for(const s of t.resources.toAdd)e.paths.push(s.resource.path),o.has(s.resource.path)?o.delete(s.resource.path):c.push(i(s,r));if(c.length===0)return o;const u=await I(c);if(v(r),u.length>0)throw new g("save:resources","Failed to save one or more resources",{errors:u});return o}async function m(e,t,r=null){if(!e||!t.portalItem)return;const o=[];for(const a of e){const n=t.portalItem.resourceFromPath(a);o.push(n.portalItem.removeResource(n,r))}await b(o)}async function i(e,t){var a,n;const r={...t??{},compress:e.compress},o=await h(e.resource.portalItem.addResource(e.resource,await f(e.content),r));if(o.ok!==!0)throw(a=e.error)==null||a.call(e,o.error),o.error;(n=e.finish)==null||n.call(e,e.resource)}async function F(e,t){var o,a;const r=await h(e.resource.update(await f(e.content),t));if(r.ok!==!0)throw(o=e.error)==null||o.call(e,r.error),r.error;(a=e.finish)==null||a.call(e,e.resource)}async function B(e){const t=[];for(const r of e.allLayers)if("beforeSave"in r&&typeof r.beforeSave=="function"){const o=r.beforeSave();o&&t.push(o)}await Promise.allSettled(t)}export{B as m,A as p,$ as u};
