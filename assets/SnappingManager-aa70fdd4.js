import{a5 as f,a6 as g,a9 as pe,bA as fe,V as Ke,e_ as V,aW as y,gg as K,gm as we,gn as me,go as Se,gi as G,gA as Me,r9 as Ye,p1 as en,d8 as Ne,fD as A,q2 as Pt,f9 as tn,fh as nn,fk as Ae,jM as sn,fe as b,g4 as rn,f6 as ie,jo as C,ra as an,f1 as ee,rb as on,fC as Ue,eB as gt,rc as Xe,le as $t,lf as Oe,gq as cn,fX as ln,fr as Tt,rd as yt,re as un,d2 as Rt,j3 as dn,fi as Ct,bh as hn,fn as T,lG as pn,d4 as bt,fw as fn,p4 as gn,rf as yn,kc as re,db as Qe,mf as vn,i5 as _n,qv as Sn,rg as En,rh as wn,nV as mn,cb as Ee,dr as Be,eD as Ft,kq as ke,an as xn,ri as Ln,i0 as Pn,ir as $n,y as ze,ez as Tn,dN as Rn,_ as Le,eV as Cn,da as bn,l6 as Vt,bg as Fn,ce as vt,di as _t,br as Vn,gt as In}from"./index-b516d057.js";import{y as m,d as Mn}from"./elevationInfoUtils-be36d866.js";import{p as J,i as L,l as de,c as ae,R as Nn,d as M,n as j,f as Z,a as It,m as et,k as w,q as An,t as ge,v as be,r as qn,o as On,g as Pe}from"./snappingUtils-93e84fbe.js";import{h as kn}from"./UpdatingHandles-7949a657.js";import{l as x,v as zn,L as De,m as Dn}from"./geometry2dUtils-a99dcf3d.js";import{d as Ce}from"./FeatureFilter-55dd341e.js";import{o as Hn}from"./floorFilterUtils-080a7cd2.js";import{u as $}from"./viewUtils-9f810d02.js";import{e as He}from"./dehydratedPoint-5a1dfed5.js";let ce=class extends fe{constructor(e){super(e),this.layer=null,this.enabled=!0,this.updating=!1,this.availability=1}};f([g({constructOnly:!0})],ce.prototype,"layer",void 0),f([g()],ce.prototype,"enabled",void 0),f([g()],ce.prototype,"updating",void 0),f([g()],ce.prototype,"availability",void 0),ce=f([pe("esri.views.interactive.snapping.FeatureSnappingLayerSource")],ce);const Gn=ce;let R=class extends fe{constructor(e){super(e),this.enabled=!1,this.enabledToggled=!1,this.selfEnabled=!0,this.featureEnabled=!0,this.featureSources=new Ke,this.distance=J.distance,this.touchSensitivityMultiplier=J.touchSensitivityMultiplier}get effectiveEnabled(){return this.enabledToggled?!this.enabled:this.enabled}get effectiveSelfEnabled(){return this.effectiveEnabled&&this.selfEnabled}get effectiveFeatureEnabled(){return this.effectiveEnabled&&this.featureEnabled}};f([g()],R.prototype,"enabled",void 0),f([g()],R.prototype,"enabledToggled",void 0),f([g()],R.prototype,"selfEnabled",void 0),f([g()],R.prototype,"featureEnabled",void 0),f([g({type:Ke.ofType(Gn)})],R.prototype,"featureSources",void 0),f([g()],R.prototype,"distance",void 0),f([g()],R.prototype,"touchSensitivityMultiplier",void 0),f([g({readOnly:!0})],R.prototype,"effectiveEnabled",null),f([g({readOnly:!0})],R.prototype,"effectiveSelfEnabled",null),f([g({readOnly:!0})],R.prototype,"effectiveFeatureEnabled",null),R=f([pe("esri.views.interactive.snapping.SnappingOptions")],R);const jn=R;function tt({start:n,end:e,type:t},s,i){const r=[],a=K(le,e,n),c=K(ye,n,s),o=we(a),l=2*me(a,c),d=l*l-4*o*(we(c)-i*i);if(d===0){const u=-l/(2*o);(t===F.PLANE||u>=0)&&r.push(Se(G(),n,a,u))}else if(d>0){const u=Math.sqrt(d),h=(-l+u)/(2*o);(t===F.PLANE||h>=0)&&r.push(Se(G(),n,a,h));const p=(-l-u)/(2*o);(t===F.PLANE||p>=0)&&r.push(Se(G(),n,a,p))}return r}function Mt(n,e){const t=n.start,s=n.end,i=K(le,s,t),r=ie(ye,-i[1],i[0],0),a=e.start,c=e.end,o=C(it,c,a),l=b(o,r),d=ie(Gt,t[0],t[1],0),u=C(jt,d,a),h=b(u,r);if(Math.abs(l)<H)return[];const p=A(Zt,a,o,h/l);if(e.type===x.RAY){const v=C(Ve,p,a);if(b(v,o)<-H)return[]}if(n.type===F.HALF_PLANE){const v=an(Ve,p,t);if(me(v,i)<-H)return[]}return[ee(p)]}function Zn(n,e){return Wn(Fe(rt,e[2],n),e)}function Nt(n,e){const s=zt(Fe(rt,0,n),Fe(Bn,0,e)),i=[];for(const r of s)i.push(on(r));return i}function At(n,e){return nt(n,Fe(rt,n[2],e))}function qt(n,e,t){const s=K(le,n,e),i=t/cn(s),r=Se(y(),e,s,i);return r[2]=n[2],r}function nt(n,{start:e,end:t,type:s}){const i=C(le,n,e),r=C(ye,t,e),a=b(i,r)/b(r,r);return A(y(),e,r,s===x.RAY?Math.max(a,0):a)}const Ot=(()=>{const n=y(),e=y(),t=y();return({start:s,end:i},{center:r,radius:a,normal:c,slicePlane:o})=>{const l=y(),d=Me(r,c,Qn);if(S(Ye(d,s),0)&&S(Ye(d,i),0)){en(c,n,e);const u=(v,E)=>(Ae(t,E,r),sn(v,b(t,n),b(t,e)),v),h=zn({start:u(Ht,s),end:u(Xn,i),type:x.LINE},rn,a),p=[];for(const[v,E]of h){const _=Ne(y(),r);A(_,_,n,v),A(_,_,e,E),o&&!se(o,_)||p.push(_)}return p}return Pt(d,s,i,l)?!S(tn(l,r),a)||o&&!se(o,l)?[]:[l]:[]}})();function kt({start:n,end:e,type:t},s,i){const r=[],a=Ae(le,e,n),c=K(ye,n,s),o=we(a),l=2*me(a,c),d=l*l-4*o*(we(c)-i*i);if(d===0){const u=-l/(2*o);(t===x.LINE||u>=0)&&r.push(A(y(),n,a,u))}else if(d>0){const u=Math.sqrt(d),h=(-l+u)/(2*o);(t===x.LINE||h>=0)&&r.push(A(y(),n,a,h));const p=(-l-u)/(2*o);(t===x.LINE||p>=0)&&r.push(A(y(),n,a,p))}return r}function zt(n,e){const t=n.start,s=n.end,i=e.start,r=e.end,a=C(le,s,t),c=C(ye,r,i),o=C(it,i,t),l=Ue(Gt,a,c),d=b(o,l);if(!gt(d,0,H))return[];const u=Xe(l);if(gt(u,0,H))return[];const h=Ue(jt,o,c),p=b(h,l)/u,v=A(Zt,t,a,p);if(n.type===x.RAY){const E=C(Ve,v,t);if(b(a,E)<-H)return[]}if(e.type===x.RAY){const E=C(Ve,v,i);if(b(c,E)<-H)return[]}return[ee(v)]}function Wn({start:n,end:e,type:t},s){const i=C(le,s,n),r=C(ye,e,n),a=Ue(it,r,i);if(Xe(a)/Xe(r)<H)switch(t){case x.LINE:return[ee(s)];case x.RAY:return b(r,i)<-H?[]:[ee(s)]}return[]}function st(n,e,t,s){const[i,r]=n,[a,c]=t,o=a-i,l=c-r,d=o*o+l*l,u=Math.sqrt(d);if(u>e+s)return[];if(u<Math.abs(e-s))return[];if(S(u,0)&&S(e,s))return[];const h=(e*e-s*s+d)/(2*u),p=Math.sqrt(e*e-h*h),v=p*l/u,E=p*o/u,[_,P]=$t(Ht,n,t,h/u);return S(v,E)?[Oe(_,P)]:[Oe(_+v,P-E),Oe(_-v,P+E)]}function Fe(n,e,{start:t,end:s,type:i}){return ie(n.start,t[0],t[1],e),ie(n.end,s[0],s[1],e),n.type=Un[i],n}function Dt(n,e){return S(n[2],e[2])}function S(n,e){return Math.abs(n-e)<H}function Yn(n,e){return e.filter(t=>se(n,t))}function se(n,e){return nn(n,e)}var F;(function(n){n[n.PLANE=0]="PLANE",n[n.HALF_PLANE=1]="HALF_PLANE"})(F||(F={}));const Un={[F.PLANE]:x.LINE,[F.HALF_PLANE]:x.RAY},H=1e-6,Ht=G(),Xn=G(),le=y(),ye=y(),it=y(),Gt=y(),jt=y(),Zt=y(),Ve=y(),Qn=V(),rt={start:y(),end:y(),type:x.LINE},Bn={start:y(),end:y(),type:x.LINE};class W{intersect(e){return Y(this,e)}closestPoints(e){return[this.closestTo(e)]}}class ve extends W{constructor(e){super(),this.point=e}equals(e){return this===e||O(e)&&T(this.point,e.point)}closestTo(){return de(this.point)}}class at extends W{constructor(e,t,s){super(),this.start=e,this.end=t,this.lineLike={start:e,end:t,type:s}}equals(e){return this===e||k(e)&&this.lineLike.type===e.lineLike.type&&T(this.start,e.start)&&T(this.end,e.end)}closestTo(e){const t=nt(e,this.lineLike);return L(t)}}class ot extends at{constructor(e,t){super(e,t,x.LINE)}}class Jn extends at{constructor(e,t){super(e,t,x.RAY)}}class Wt extends W{constructor(e){super(),this.constraints=e}equals(e){return this===e||Je(e)&&pn(this.constraints,e.constraints,(t,s)=>t.equals(s))}closestTo(e){let t,s=1/0;for(const i of this.constraints){const r=i.closestTo(e),a=bt(e,r);a<s&&(s=a,t=r)}return t?de(t):e}closestPoints(e){return this.constraints.flatMap(t=>t===this?[]:t.closestPoints(e))}}class Yt extends W{constructor(e,t){super(),this.center=e,this.radius=t}equals(e){return this===e||D(e)&&this.center[0]===e.center[0]&&this.center[1]===e.center[1]&&this.radius===e.radius}closestTo(e){const t=qt(e,this.center,this.radius);return L(t)}}class ct extends W{constructor(e,t){super(),this.center=e,this.radius=t}equals(e){return this===e||X(e)&&T(this.center,e.center)&&this.radius===e.radius}closestTo(e){const t=qt(e,this.center,this.radius);return t[2]=this.center[2],L(t)}asCircle(){return new lt(de(this.center),this.radius,ae(0,0,1))}}class lt extends W{constructor(e,t,s,i=void 0){super(),this.center=e,this.radius=t,this.normal=s,this.slicePlane=i}equals(e){return this===e||te(e)&&T(this.center,e.center)&&T(this.normal,e.normal)&&this.radius===e.radius}closestTo(e){const{center:t,radius:s}=this;Ct(this.getPlane(Kn),e,Ge);const i=C(Ge,Ge,t),r=fn(i);if(S(r,0))return de(e);const a=s/Math.sqrt(r),c=A(y(),t,i,a),{slicePlane:o}=this;if(o&&!se(o,c)){const l=dt(o,this);return(l==null?void 0:l.closestTo(e))??de(e)}return L(c)}getPlane(e=V()){return Me(this.center,this.normal,e)}}const Ge=y(),Kn=V();class es extends W{constructor(e){super(),this.z=e}equals(e){return this===e||U(e)&&this.z===e.z}closestTo(e){return L(Qe(e[0],e[1],this.z))}getPlane(e=V()){return ie(St,0,0,this.z),Me(St,vn,e)}}const St=y();class ut extends W{constructor(e,t,s){super(),this.start=e,this.end=t,this.planeLike={start:e,end:t,type:s}}equals(e){return this===e||z(e)&&this.planeLike.type===e.planeLike.type&&T(this.start,e.start)&&T(this.end,e.end)}closestTo(e){return L(At(e,this.planeLike))}closestEndTo(e){const{start:t,end:s}=this;return Math.sign(me(K(ts,s,t),K(ns,e,t)))>0?s:t}getPlane(e=V()){const t=Ne(Et,this.end);return t[2]+=1,_n(this.start,this.end,t,e)}getSlicePlane(e=V()){const{start:t,end:s,type:i}=this.planeLike;if(i===F.PLANE)return;const r=ie(Et,t[0],t[1],0),a=ie(wt,s[0],s[1],0),c=Ae(wt,a,r);return Me(r,c,e),e}}const ts=G(),ns=G(),Et=y(),wt=y();class Ut extends ut{constructor(e,t){super(e,t,F.HALF_PLANE)}}class Xt extends ut{constructor(e,t){super(e,t,F.PLANE)}}class ss extends W{constructor(e,t){super(),this.sphere=Sn(e,t)}equals(e){return this===e||Q(e)&&En(this.sphere,e.sphere)}closestTo(e){const t=wn(this.sphere,e,y());return L(t)}get center(){return this.sphere}get radius(){return this.sphere[3]}}class Qt extends W{constructor(e,t,s){super(),this.start=e,this.end=t,this.getZ=s,this.planeLike={start:e,end:t,type:F.PLANE}}equals(e){return this===e||Ie(e)&&T(this.start,e.start)&&T(this.end,e.end)&&this.getZ===e.getZ}closestTo(e){return is(this,e)}addIfOnTheGround(e,t){for(const s of t){const i=this.getZ(s[0],s[1])??0;S(s[2],i)&&(s[2]=i,e.push(s))}}}function is(n,e){const t=At(e,n.planeLike);return t[2]=n.getZ(t[0],t[1])??Jt,L(t)}function Y(n,e){if(Je(n)){const t=[];for(const s of n.constraints){const i=s.intersect(e);i&&t.push(i)}return ht(t)}if(Je(e))return Y(e,n);if(Ie(n))return mt(n,e);if(Ie(e))return mt(e,n);if(O(n)){const{point:t}=n,s=e.closestTo(t);return gn(s,t)?n:void 0}if(k(n)){if(O(e))return Y(e,n);if(k(e))return N(zt(n.lineLike,e.lineLike));if(U(e))return rs(n,e);if(z(e))return N(Mt(e.planeLike,n.lineLike));if(D(e))return N(kt(n.lineLike,e.center,e.radius));if(te(e))return N(Ot(n.lineLike,e));if(X(e))return as(n,e);if(Q(e))return os(n,e)}else if(U(n)){if(O(e)||k(e))return Y(e,n);if(U(e))return cs(n,e);if(z(e))return ls(n,e);if(D(e))return us(n,e);if(te(e))return hs(n,e);if(X(e))return ds(n,e);if(Q(e))return ps(n,e)}else if(z(n)){if(O(e)||k(e)||U(e))return Y(e,n);if(z(e))return je(Nt(n.planeLike,e.planeLike));if(D(e))return je(tt(n.planeLike,e.center,e.radius));if(te(e))return gs(n,e);if(X(e))return fs(n,e);if(Q(e))return ys(n,e)}else if(D(n)){if(O(e)||k(e)||U(e)||z(e))return Y(e,n);if(D(e))return je(st(n.center,n.radius,e.center,e.radius));if(te(e))return void 0;if(X(e))return vs(n,e);if(Q(e))return void 0}else if(te(n)){if(O(e)||k(e)||U(e)||z(e)||D(e))return Y(e,n);if(te(e))return void 0;if(X(e))return e.asCircle(),void 0;if(Q(e))return void 0}else if(X(n)){if(O(e)||k(e)||U(e)||z(e)||D(e)||te(e))return Y(e,n);if(X(e))return _s(e,n);if(Q(e))return void 0}else if(Q(n)){if(O(e)||k(e)||U(e)||z(e)||D(e)||X(e))return Y(e,n);if(Q(e))return void 0}}const rs=(()=>{const n=V();return(e,t)=>{const{start:s,end:i}=e;if(Dt(s,i)&&S(s[2],t.z))return e;const r=y();return Pt(t.getPlane(n),s,i,r)?new ve(L(r)):void 0}})();function as({lineLike:n},{center:e,radius:t}){const s=e[2];return N(kt(n,e,t).filter(i=>S(i[2],s)))}function os({lineLike:n},{sphere:e}){return N(yn(e,n.start,n.end))}const dt=(()=>{const n=ln(),e=V(),t={start:y(),end:y(),type:x.LINE};return(s,i,r)=>{const{normal:a,center:c,radius:o}=i,l=b(a,Tt(s)),d=S(Ye(s,c),0);if(S(l,1))return d?i:void 0;if(i.getPlane(e),d&&S(l,0)&&yt(s)&&yt(e)){if(S(o,0))return!r||se(r,c)?new ve(de(c)):void 0;const h=ee(c);h[2]+=o;const p=ee(c);p[2]-=o;const v=[];return r&&!se(r,h)||v.push(h),r&&!se(r,p)||v.push(p),N(v)}if(!un(s,e,n))return;Ne(t.start,n.origin),Rt(t.end,n.origin,n.direction);const u=Ot(t,i);return N(r?Yn(r,u):u)}})();function cs(n,e){return S(n.z,e.z)?n:void 0}function ls({z:n},{planeLike:e}){const[t,s]=e.start,[i,r]=e.end,a=ae(t,s,n),c=ae(i,r,n);return e.type===F.PLANE?new ot(a,c):new Jn(a,c)}function us(n,e){const[t,s]=e.center;return new ct(ae(t,s,n.z),e.radius)}function ds(n,e){return S(e.center[2],n.z)?e:void 0}const hs=(()=>{const n=V();return(e,t)=>dt(e.getPlane(n),t)})();function ps(n,{center:e,radius:t}){const s=Math.abs(e[2]-n.z);if(s>t&&!S(s,t))return;const i=ae(e[0],e[1],n.z),r=Math.sqrt(t**2-s**2);return S(r,0)?void 0:new ct(i,r)}const fs=(()=>{const n=V();return(e,{center:t,radius:s})=>{const i=tt(e.planeLike,t,s),r=t[2];e.getSlicePlane(n);const a=[];for(const[c,o]of i){const l=[c,o,r];se(n,l)&&a.push(l)}return N(a)}})(),gs=(()=>{const n=V(),e=V();return(t,s)=>dt(t.getPlane(n),s,t.getSlicePlane(e))})(),ys=(()=>{const n=V();return(e,{center:t,radius:s})=>{const i=e.getPlane(n),r=dn(i,t),a=Math.abs(r);if(a>s&&!S(a,s))return;const c=ee(Tt(i)),o=A(y(),t,c,r),l=Math.sqrt(s**2-r**2);return S(l,0)?new ve(L(Ct(i,t,y()))):new lt(L(o),l,c,e.getSlicePlane())}})();function vs(n,e){const t=re(n.center,e.center);return S(t,0)&&S(n.radius,e.radius)?e:Bt(st(n.center,n.radius,e.center,e.radius),e.center[2])}function _s(n,e){if(!Dt(n.center,e.center))return;const t=re(n.center,e.center);return S(t,0)&&S(n.radius,e.radius)?n:Bt(st(n.center,n.radius,e.center,e.radius),n.center[2])}function mt(n,e){const{planeLike:t,getZ:s}=n,i=[];if(O(e))n.addIfOnTheGround(i,Zn(t,e.point));else if(k(e))n.addIfOnTheGround(i,Mt(t,e.lineLike));else if(D(e))for(const[r,a]of tt(t,e.center,e.radius)){const c=s(r,a);c!=null&&i.push(Qe(r,a,c))}else if(z(e)||Ie(e))for(const[r,a]of Nt(t,e.planeLike)){const c=s(r,a)??Jt;i.push(Qe(r,a,c))}return N(i)}function je(n){return ht(n.map(([e,t])=>{const s=ae(e,t,0),i=ae(e,t,1);return new ot(s,i)}))}function N(n){return ht(n.map(e=>e?new ve(L(e)):void 0))}function Bt(n,e){return N(n.map(([t,s])=>[t,s,e]))}function ht(n){if(n.length!==0)return n.length===1?n[0]??void 0:new Wt(n.filter(hn))}function Je(n){return n instanceof Wt}function O(n){return n instanceof ve}function k(n){return n instanceof at}function U(n){return n instanceof es}function z(n){return n instanceof ut}function D(n){return n instanceof Yt}function X(n){return n instanceof ct}function te(n){return n instanceof lt}function Q(n){return n instanceof ss}function Ie(n){return n instanceof Qt}const Jt=0;let I=class extends fe{get layerView(){var n,e;return(e=(n=this.view)==null?void 0:n.allLayerViews)==null?void 0:e.find(t=>t.layer===this.layer)}get valid(){return this._valid}get subtypeFilter(){var s,i;const{layer:n}=this;if(!mn(n)||!((s=n.subtypes)!=null&&s.length))return{mode:"not-in-use",filter:null};const e=((i=n.fieldsIndex.get(n.subtypeField))==null?void 0:i.name)??n.subtypeField,t=n.sublayers.filter(r=>r.visible).map(r=>r.subtypeCode);return t.length?t.length===n.subtypes.length?{mode:"all-visible",filter:null}:t.length===1?{mode:"in-use",filter:`${e} = ${t.getItemAt(0)}`}:{mode:"in-use",filter:`${e} IN (${t.join(", ")})`}:{mode:"none-visible",filter:null}}get floorFilter(){const{view:n,layer:e}=this;return n&&e?Hn({view:n,layer:e}):null}constructor(n){super(n),this.rulesTable=null,this._valid=!1}initialize(){if(!this.snappingSource||!this.layer)return;const{layer:n,snappingSource:e}=this;if("refresh"in n){const t=n;this.addHandles(t.on("refresh",()=>e.refresh()))}this.loadRules(),this.addHandles([Ee(()=>e.updating,t=>e.layerSource.updating=t,Be),Ee(()=>e.availability,t=>e.layerSource.availability=t,Be)])}getFetchCandidatesParameters(n,e,t){var l,d;if(!this.valid)return[];const{layer:s,layerView:i,floorFilter:r,rulesTable:a,subtypeFilter:c}=this,o={distance:t,mode:((l=this.view)==null?void 0:l.type)??"2d",point:n,coordinateHelper:e.coordinateHelper,...this._types,filter:i&&"filter"in i?i.filter:null};if(r&&(o.filter=Ze(o.filter,r)),c.mode!=="not-in-use"&&c.mode!=="all-visible"){if(c.mode==="none-visible")return[];o.filter?o.filter.where=Ft(o.filter.where,c.mode):o.filter=new Ce({where:c.filter})}if(a){const u=e.feature,h=u==null?void 0:u.sourceLayer;if(!(u&&ke(s)&&s.layerId&&ke(h)&&a.loadStatus==="loaded"))return[];const p=[],v=s.layerId,E=(d=a.getFeatureSQL(h,u))==null?void 0:d[v];if(!E)return[];const _=E.anyVertex;let P=E.endVertex;return P&&_&&P===_&&(P=""),P&&p.push({...o,returnEdge:!1,vertexMode:"ends",filter:Ze(o.filter,P)}),_&&p.push({...o,returnEdge:!1,vertexMode:"all",filter:Ze(o.filter,_)}),p}return[o]}async loadRules(){var t,s;const{layer:n,view:e}=this;if(n&&e&&Nn(e==null?void 0:e.map)&&ke(n)){const i=(t=e.map.utilityNetworks)==null?void 0:t.find(r=>r.isUtilityLayer(n));if(i)try{this.rulesTable=await i.getRulesTable(),await((s=this.rulesTable)==null?void 0:s.load()),this._valid=!0}catch{return void xn.getLogger("esri.views.interactive.snapping.FeatureSnappingSourceInfo").error("Failed to load rules table for snapping source",n.title)}}else this._valid=!0}get _types(){return{returnEdge:!0,vertexMode:"all"}}remove(){this.destroy()}destroy(){var n;(n=this.snappingSource)==null||n.destroy()}};function Ze(n,e){return n==null?new Ce({where:e}):n.where?new Ce({where:Ft(n.where,e)}):new Ce({where:e})}f([g({constructOnly:!0})],I.prototype,"layer",void 0),f([g({constructOnly:!0})],I.prototype,"snappingSource",void 0),f([g({constructOnly:!0})],I.prototype,"view",void 0),f([g()],I.prototype,"layerView",null),f([g()],I.prototype,"rulesTable",void 0),f([g()],I.prototype,"valid",null),f([g()],I.prototype,"subtypeFilter",null),f([g()],I.prototype,"floorFilter",null),f([g()],I.prototype,"_valid",void 0),I=f([pe("esri.views.interactive.snapping.FeatureSnappingSourceInfo")],I);class _e{constructor(e,t,s,i){this.targetPoint=e,this.constraint=t,this.isDraped=s,this.domain=i}}let pt=class extends _e{constructor({targetPoint:e,objectId:t,constraint:s,isDraped:i}){super(e,s,i,M.FEATURE),this.objectId=t}},Ss=class extends pt{constructor(e){super({...e,isDraped:!0,constraint:new Qt(e.edgeStart,e.edgeEnd,e.getGroundElevation)})}get hints(){return[new j(Z.REFERENCE,this.constraint.start,this.constraint.end,this.isDraped,this.domain)]}},Es=class extends pt{constructor(e){super({...e,constraint:new ot(e.edgeStart,e.edgeEnd)})}get hints(){return[new j(Z.REFERENCE,this.constraint.start,this.constraint.end,this.isDraped,this.domain)]}};class Kt extends _e{constructor({targetPoint:e,constraint:t,previousVertex:s,otherVertex:i,otherVertexType:r,objectId:a,isDraped:c}){super(e,t,c,M.SELF),this.previousVertex=s,this.otherVertex=i,this.otherVertexType=r,this.objectId=a}get hints(){const e=this.previousVertex,t=this.otherVertexType===he.CENTER?this.otherVertex:this.targetPoint,s=this.otherVertexType===he.CENTER?this.targetPoint:this.otherVertex;return[new j(Z.TARGET,t,s,this.isDraped,this.domain),new j(Z.REFERENCE,e,t,this.isDraped,this.domain),new It(this.previousVertex,t,s,this.isDraped,this.domain)]}}var he;(function(n){n[n.NEXT=0]="NEXT",n[n.CENTER=1]="CENTER"})(he||(he={}));let ne=class extends fe{get updating(){return this._snappingSources.some(e=>e==null||e.valid&&e.snappingSource.updating)||this._updatingHandles.updating}constructor(e){super(e),this.options=null,this._domain=M.FEATURE,this._updatingHandles=new kn,this._sourceModules={featureService:{module:null,loader:null},featureCollection:{module:null,loader:null},graphics:{module:null,loader:null},notes:{module:null,loader:null},scene:{module:null,loader:null}}}initialize(){const e=Ln(()=>{var t;return(t=this.options)==null?void 0:t.featureSources},(t,s)=>this._createSourceInfo(t,s));this._snappingSources=e,this.addHandles(Pn(e))}destroy(){this._set("options",null),this._updatingHandles.destroy()}async fetchCandidates(e,t,s,i){var o;if(!(t&this._domain&&this.options!=null&&this.options.effectiveFeatureEnabled))return[];const r=[],a=this._computeScreenSizeDistanceParameters(e,s);for(const l of this._snappingSources){if(l==null||!l.valid||!l.snappingSource.layerSource.enabled||(o=l.layerView)!=null&&o.suspended)continue;const d=l.getFetchCandidatesParameters(e,s,a);for(const u of d)r.push(l.snappingSource.fetchCandidates(u,i).then(h=>h.filter(p=>!this._candidateIsExcluded(l.snappingSource,p,s.excludeFeature))))}const c=(await $n(r)).flat();return this._addRightAngleCandidates(c,e,a,s),ze(i),et(e,c),c}_addRightAngleCandidates(e,t,s,i){var u,h,p,v,E,_,P,ft;const r=i.vertexHandle!=null?(h=(u=i.vertexHandle.rightEdge)==null?void 0:u.rightVertex)==null?void 0:h.pos:i.editGeometryOperations!=null&&i.editGeometryOperations.data.type==="polygon"?(v=(p=i.editGeometryOperations.data.components[0])==null?void 0:p.getFirstVertex())==null?void 0:v.pos:null,a=i.vertexHandle!=null?(_=(E=i.vertexHandle.leftEdge)==null?void 0:E.leftVertex)==null?void 0:_.pos:i.editGeometryOperations!=null?(ft=(P=i.editGeometryOperations.data.components[0])==null?void 0:P.getLastVertex())==null?void 0:ft.pos:null,{view:c}=this,o=w(r,c,i),l=w(a,c,i),d=e.length;for(let xe=0;xe<d;xe++)this._addRightAngleCandidate(e[xe],l,t,s,e),this._addRightAngleCandidate(e[xe],o,t,s,e)}_addRightAngleCandidate(e,t,s,i,r){if(t==null||!ws(e))return;const a=e.constraint.closestTo(t),c=(a[0]-s[0])/i.x,o=(a[1]-s[1])/i.y,{start:l,end:d}=e.constraint;if(c*c+o*o<=1){const u=new Kt({targetPoint:a,otherVertex:t,otherVertexType:he.NEXT,previousVertex:re(a,l)>re(a,d)?l:d,constraint:new Ut(t,a),objectId:e.objectId,isDraped:e.isDraped});r.push(u)}}_computeScreenSizeDistanceParameters(e,t){let s=this.options!=null?this.options.distance*(t.pointer==="touch"?this.options.touchSensitivityMultiplier:1):0;return this.view==null?{x:s,y:s,z:s,distance:s}:this.view.type==="2d"?(s*=this.view.resolution,{x:s,y:s,z:s,distance:s}):this._computeScreenSizeDistanceParameters3D(e,s,this.view,t)}_computeScreenSizeDistanceParameters3D(e,t,s,i){const{spatialReference:r}=i;s.renderCoordsHelper.toRenderCoords(e,r,xt);const a=s.state.camera.computeScreenPixelSizeAt(xt),c=a*s.renderCoordsHelper.unitInMeters,o=c/Tn(r),l=c/Rn(r),d=t*o,u=t*l,h=$(e,r,m,s),p=h?We(h,e,o,0,0,s,i):0,v=h?We(h,e,0,o,0,s,i):0,E=h?We(h,e,0,0,l,s,i):0;return{x:p===0?0:d/p,y:v===0?0:d/v,z:E===0?0:u/E,distance:a*t}}_candidateIsExcluded(e,t,s){if(s==null)return!1;const i=this._getCandidateObjectId(t);if(i==null)return!1;const r=e.layerSource.layer;return r.type==="graphics"?s.uid===i:s.sourceLayer===r&&!(!s.attributes||!("objectIdField"in r))&&s.attributes[r.objectIdField]===i}_getCandidateObjectId(e){return e instanceof pt?e.objectId:null}async _createSourceInfo(e,t){const s=e.layer;s.loaded||(await s.load(),ze(t));const{view:i}=this,r=await this._createFeatureSnappingSourceType(e);return ze(t),new I(r==null?{}:{snappingSource:r,view:i,layer:s})}async _createFeatureSnappingSourceType(e){switch(e.layer.type){case"feature":case"geojson":case"csv":case"oriented-imagery":case"subtype-group":case"wfs":return this._createFeatureSnappingSourceFeatureLayer(e);case"graphics":return this._createFeatureSnappingSourceGraphicsLayer(e);case"map-notes":return this._createFeatureSnappingSourceMapNotesLayer(e);case"scene":case"building-scene":return this._createFeatureSnappingSourceSceneLayer(e)}return null}async _createFeatureSnappingSourceSceneLayer(e){const{view:t}=this;return t==null||t.type!=="3d"?null:new(await this._getSourceModule("scene")).SceneLayerSnappingSource({layerSource:e,view:t})}async _createFeatureSnappingSourceFeatureLayer(e){var t;switch((t=e.layer.source)==null?void 0:t.type){case"feature-layer":case"oriented-imagery":return new(await this._getSourceModule("featureService")).FeatureServiceSnappingSource({spatialReference:this.spatialReference,view:this.view,layerSource:e});case"memory":case"csv":case"geojson":case"wfs":return e.layer.geometryType==="mesh"?null:new(await this._getSourceModule("featureCollection")).FeatureCollectionSnappingSource({layerSource:e,view:this.view})}return null}async _createFeatureSnappingSourceGraphicsLayer(e){return new(await this._getSourceModule("graphics")).GraphicsSnappingSource({getGraphicsLayers:()=>[e.layer],spatialReference:this.spatialReference,view:this.view,layerSource:e})}async _createFeatureSnappingSourceMapNotesLayer(e){return new(await this._getSourceModule("notes")).GraphicsSnappingSource({getGraphicsLayers:()=>{var t;return((t=e.layer.sublayers)==null?void 0:t.toArray())??[]},spatialReference:this.spatialReference,view:this.view,layerSource:e})}async _getSourceModule(e){const t=this._sourceModules[e];if(t.loader==null){const s=this._loadSourceModule(e),i={module:null,loader:s};this._sourceModules[e]=i;const r=await s,a={module:r,loader:s};return this._sourceModules[e]=a,r}return t.module==null?t.loader:t.module}_loadSourceModule(e){const t=this._updatingHandles;switch(e){case"featureService":return t.addPromise(Le(()=>import("./FeatureServiceSnappingSource-bf98e523.js"),["assets/FeatureServiceSnappingSource-bf98e523.js","assets/index-b516d057.js","assets/index-b252abd2.css","assets/memoize-3e55df82.js","assets/UpdatingHandles-7949a657.js","assets/elevationInfoUtils-be36d866.js","assets/boundedPlane-1da2f094.js","assets/layerViewUtils-6ebe90f4.js","assets/FeatureTileDescriptor3D-27dbeac7.js","assets/snappingUtils-93e84fbe.js","assets/dehydratedPoint-5a1dfed5.js","assets/Query-071039d7.js","assets/FullTextSearch-12e0754c.js","assets/QuantizationParameters-f983cf8d.js","assets/screenUtils-8dc4a7f9.js","assets/signal-51ed66f5.js","assets/queryEngineUtils-3186d4e6.js","assets/VertexSnappingCandidate-bc4acb9f.js","assets/PointSnappingHint-671c9f09.js","assets/TileTreeDebugger-7b374a11.js","assets/WorkerHandle-9433ab9a.js","assets/debugFlags-9a30f077.js","assets/geometry2dUtils-a99dcf3d.js","assets/FeatureFilter-55dd341e.js","assets/floorFilterUtils-080a7cd2.js","assets/viewUtils-9f810d02.js"]));case"featureCollection":return t.addPromise(Le(()=>import("./FeatureCollectionSnappingSource-2d733051.js"),["assets/FeatureCollectionSnappingSource-2d733051.js","assets/index-b516d057.js","assets/index-b252abd2.css","assets/memoize-3e55df82.js","assets/elevationInfoUtils-be36d866.js","assets/snappingUtils-93e84fbe.js","assets/dehydratedPoint-5a1dfed5.js","assets/Query-071039d7.js","assets/FullTextSearch-12e0754c.js","assets/QuantizationParameters-f983cf8d.js","assets/screenUtils-8dc4a7f9.js","assets/signal-51ed66f5.js","assets/queryEngineUtils-3186d4e6.js","assets/VertexSnappingCandidate-bc4acb9f.js","assets/PointSnappingHint-671c9f09.js","assets/symbologySnappingCandidates-ffc7ee52.js","assets/UpdatingHandles-7949a657.js","assets/geometry2dUtils-a99dcf3d.js","assets/FeatureFilter-55dd341e.js","assets/floorFilterUtils-080a7cd2.js","assets/viewUtils-9f810d02.js"]));case"graphics":case"notes":return t.addPromise(Le(()=>import("./GraphicsSnappingSource-70c49e94.js"),["assets/GraphicsSnappingSource-70c49e94.js","assets/index-b516d057.js","assets/index-b252abd2.css","assets/memoize-3e55df82.js","assets/UpdatingHandles-7949a657.js","assets/normalizeUtilsSync-7ead5aec.js","assets/featureConversionUtils-09cf00ff.js","assets/OptimizedFeature-e90b69df.js","assets/OptimizedFeatureSet-1d1ac4b9.js","assets/OptimizedGeometry-196224d4.js","assets/FeatureStore-02a891a3.js","assets/BoundsStore-230a1891.js","assets/PooledRBush-fa11eac4.js","assets/quickselect-bc0541de.js","assets/QueryEngine-ee1ccbba.js","assets/WhereClause-41137be1.js","assets/TimeOnly-879c5107.js","assets/UnknownTimeZone-a05df022.js","assets/projectionSupport-dcf335fc.js","assets/json-48e3ea08.js","assets/QueryEngineCapabilities-85c4f1d0.js","assets/quantizationUtils-17105106.js","assets/utils-f54bcc46.js","assets/heatmapUtils-7f42325f.js","assets/utils-1a995f8e.js","assets/basemapUtils-6ec10a55.js","assets/Basemap-8d62c69e.js","assets/loadAll-5e767cfa.js","assets/writeUtils-e226a8aa.js","assets/SnappingCandidate-970faec6.js","assets/FieldsIndex-e8db657f.js","assets/Scheduler-ff5943a4.js","assets/signal-51ed66f5.js","assets/debugFlags-9a30f077.js","assets/RenderState-1d6218ee.js","assets/optimizedFeatureQueryEngineAdapter-1fecea41.js","assets/elevationInfoUtils-be36d866.js","assets/snappingUtils-93e84fbe.js","assets/dehydratedPoint-5a1dfed5.js","assets/Query-071039d7.js","assets/FullTextSearch-12e0754c.js","assets/QuantizationParameters-f983cf8d.js","assets/screenUtils-8dc4a7f9.js","assets/queryEngineUtils-3186d4e6.js","assets/VertexSnappingCandidate-bc4acb9f.js","assets/PointSnappingHint-671c9f09.js","assets/symbologySnappingCandidates-ffc7ee52.js","assets/geometry2dUtils-a99dcf3d.js","assets/FeatureFilter-55dd341e.js","assets/floorFilterUtils-080a7cd2.js","assets/viewUtils-9f810d02.js"]));case"scene":return t.addPromise(Le(()=>import("./SceneLayerSnappingSource-9c282463.js"),["assets/SceneLayerSnappingSource-9c282463.js","assets/index-b516d057.js","assets/index-b252abd2.css","assets/UpdatingHandles-7949a657.js","assets/EdgeWorkerHandle-7d97defa.js","assets/WorkerHandle-9433ab9a.js","assets/workerHelper-d1cc0cda.js","assets/InterleavedLayout-d76b0d59.js","assets/types-1305598a.js","assets/edgeProcessing-82213448.js","assets/glUtil-ce5ee52b.js","assets/enums-bdecffa2.js","assets/VertexElementDescriptor-2925c6af.js","assets/snappingUtils-93e84fbe.js","assets/dehydratedPoint-5a1dfed5.js","assets/Query-071039d7.js","assets/FullTextSearch-12e0754c.js","assets/QuantizationParameters-f983cf8d.js","assets/screenUtils-8dc4a7f9.js","assets/signal-51ed66f5.js","assets/elevationInfoUtils-be36d866.js","assets/VertexSnappingCandidate-bc4acb9f.js","assets/PointSnappingHint-671c9f09.js","assets/geometry2dUtils-a99dcf3d.js","assets/FeatureFilter-55dd341e.js","assets/floorFilterUtils-080a7cd2.js","assets/viewUtils-9f810d02.js"]))}}get test(){return{snappingSources:this._snappingSources}}};function ws(n){return(n instanceof Es||n instanceof Ss)&&!ms(n)}function ms({constraint:{start:n,end:e}}){const t=bt(n,e),s=re(n,e);return t<Cn()||s/t<Ls}function We(n,e,t,s,i,r,{spatialReference:a}){const c=Ne(xs,e);c[0]+=t,c[1]+=s,c[2]+=i;const o=$(c,a,m,r);return o?An(o,n):1/0}f([g({constructOnly:!0})],ne.prototype,"spatialReference",void 0),f([g({constructOnly:!0})],ne.prototype,"view",void 0),f([g()],ne.prototype,"options",void 0),f([g({readOnly:!0})],ne.prototype,"updating",null),f([g()],ne.prototype,"_snappingSources",void 0),ne=f([pe("esri.views.interactive.snapping.FeatureSnappingEngine")],ne);const xt=y(),xs=y(),Ls=1e-4;let qe=class{constructor(e,t){this.view=e,this.options=t,this.squaredShortLineThreshold=J.shortLineThreshold*J.shortLineThreshold}snap(e,t){return t.vertexHandle!=null?t.vertexHandle.type!=="vertex"?[]:this.snapExistingVertex(e,t):this.snapNewVertex(e,t)}edgeExceedsShortLineThreshold(e,t){return this.exceedsShortLineThreshold(w(e.leftVertex.pos,this.view,t),w(e.rightVertex.pos,this.view,t),t)}exceedsShortLineThreshold(e,t,{spatialReference:s}){return this.squaredShortLineThreshold===0||ge($(t,s,m,this.view),$(e,s,m,this.view))>this.squaredShortLineThreshold}isVertical(e,t){return re(e,t)<J.verticalLineThreshold}squaredProximityThreshold(e){return e==="touch"?this._squaredTouchProximityThreshold:this._squaredMouseProximityThreshold}get _squaredMouseProximityThreshold(){return this.options.distance*this.options.distance}get _squaredTouchProximityThreshold(){const{distance:e,touchSensitivityMultiplier:t}=this.options,s=e*t;return s*s}},Ps=class extends _e{constructor({lineStart:e,lineEnd:t,targetPoint:s,isDraped:i}){super(s,new Xt(e,t),i,M.SELF),this._referenceLineHint=new j(Z.REFERENCE_EXTENSION,e,t,i,this.domain)}get hints(){return[this._referenceLineHint,new j(Z.TARGET,this._lineEndClosestToTarget(),this.targetPoint,this.isDraped,this.domain)]}_lineEndClosestToTarget(){return this.constraint.closestEndTo(this.targetPoint)}};class $s extends qe{snapNewVertex(e,t){const s=t.editGeometryOperations.data.components[0],i=s.edges.length,r=[];if(i<1)return r;const{spatialReference:a}=t,c=$(e,a,m,this.view),{view:o}=this,l=s.edges[i-1];let d=l;do{if(this.edgeExceedsShortLineThreshold(d,t)){const u=be(d,o,t);this._processCandidateProposal(u.left,u.right,e,c,t,r)}d=d.leftVertex.leftEdge}while(d&&d!==l);return r}snapExistingVertex(e,t){const s=[],i=t.vertexHandle,r=i.component;if(r.edges.length<2)return s;const{view:a}=this,{spatialReference:c}=t,o=$(e,c,m,a),l=i.leftEdge,d=i.rightEdge;l&&d&&this.edgeExceedsShortLineThreshold(l,t)&&this.edgeExceedsShortLineThreshold(d,t)&&this._processCandidateProposal(w(l.leftVertex.pos,a,t),w(d.rightVertex.pos,a,t),e,o,t,s);const u=r.edges[0];let h=u;do{if(h!==i.leftEdge&&h!==i.rightEdge&&this.edgeExceedsShortLineThreshold(h,t)){const p=be(h,a,t);this._processCandidateProposal(p.left,p.right,e,o,t,s)}h=h.rightVertex.rightEdge}while(h&&h!==u);return s}_processCandidateProposal(e,t,s,i,r,a){var d;const{spatialReference:c,pointer:o}=r,l=L(nt(s,{start:e,end:t,type:x.LINE}));ge(i,$(l,c,m,this.view))<this.squaredProximityThreshold(o)&&a.push(new Ps({lineStart:e,lineEnd:t,targetPoint:l,isDraped:((d=r.elevationInfo)==null?void 0:d.mode)==="on-the-ground"}))}}let Ts=class extends _e{constructor({referenceLine:e,lineStart:t,targetPoint:s,isDraped:i}){const r=ee(t),{left:a,right:c}=e;Ae(r,Rt(r,r,c),a),super(s,new Xt(t,L(r)),i,M.SELF),this._referenceLines=[{edge:e,fadeLeft:!0,fadeRight:!0}]}get hints(){return[new j(Z.TARGET,this.constraint.start,this.targetPoint,this.isDraped,this.domain),new qn(this.constraint.start,this.targetPoint,this.isDraped,this.domain),...this._referenceLines.map(e=>new j(Z.REFERENCE,e.edge.left,e.edge.right,this.isDraped,this.domain,e.fadeLeft,e.fadeRight))]}addReferenceLine(e){const t={edge:e,fadeLeft:!0,fadeRight:!0};this._referenceLines.forEach(s=>{T(e.right,s.edge.left)&&(s.fadeLeft=!1,t.fadeRight=!1),T(e.right,s.edge.right)&&(s.fadeRight=!1,t.fadeRight=!1),T(e.left,s.edge.right)&&(s.fadeRight=!1,t.fadeLeft=!1),T(e.left,s.edge.left)&&(s.fadeLeft=!1,t.fadeLeft=!1)}),this._referenceLines.push(t)}};class Rs extends qe{snapNewVertex(e,t){const s=t.editGeometryOperations.data.components[0],i=s.edges.length,r=s.vertices.length,a=[];if(i<2)return a;const{view:c}=this,o=$(e,t.spatialReference,m,c),l=w(s.vertices[r-1].pos,c,t),d=w(s.vertices[0].pos,c,t),u=s.edges[i-1];let h=u;do{if(this.edgeExceedsShortLineThreshold(h,t)){const p=be(h,c,t);this._checkEdgeForParallelLines(p,l,e,o,t,a),this._checkEdgeForParallelLines(p,d,e,o,t,a)}h=h.leftVertex.leftEdge}while(h&&h!==u);return a}snapExistingVertex(e,t){const s=[],i=t.vertexHandle,r=i.component;if(r.edges.length<3)return s;const{view:a}=this,c=$(e,t.spatialReference,m,a),o=i.leftEdge,l=i.rightEdge,d=r.vertices[0],u=w(d.pos,a,t),h=r.vertices.length,p=r.vertices[h-1],v=w(p.pos,a,t),E=r.edges[0];let _=E;do{if(_!==o&&_!==l&&this.edgeExceedsShortLineThreshold(_,t)){const P=be(_,a,t);o&&this._checkEdgeForParallelLines(P,w(o.leftVertex.pos,a,t),e,c,t,s),l&&this._checkEdgeForParallelLines(P,w(l.rightVertex.pos,a,t),e,c,t,s),i===d?this._checkEdgeForParallelLines(P,v,e,c,t,s):i===p&&this._checkEdgeForParallelLines(P,u,e,c,t,s)}_=_.rightVertex.rightEdge}while(_&&_!==E);return s}_checkEdgeForParallelLines(e,t,s,i,r,a){var h;const c=e.left,o=e.right;if(De(oe,t,c,o),re(oe,t)<J.parallelLineThreshold)return;De(oe,s,c,o,t);const{spatialReference:l,pointer:d}=r,u=ae(oe[0],oe[1],s[2]);if(ge(i,$(u,l,m,this.view))<this.squaredProximityThreshold(d)){if(this.isVertical(u,t)||this.isVertical(c,o)||this._parallelToPreviousCandidate(e,a))return;a.push(new Ts({referenceLine:e,lineStart:t,targetPoint:u,isDraped:((h=r.elevationInfo)==null?void 0:h.mode)==="on-the-ground"}))}}_parallelToPreviousCandidate(e,t){const s=e.left,i=e.right;for(const r of t)if(De(oe,i,r.constraint.start,r.constraint.end,s),re(oe,i)<J.parallelLineThreshold)return r.addReferenceLine(e),!0;return!1}}const oe=G();let Cs=class extends qe{snapNewVertex(e,t){const s=t.editGeometryOperations.data.components[0],i=s.vertices.length,r=[];if(i<2)return r;const{view:a}=this,c=$(e,t.spatialReference,m,a),o=s.vertices[i-1];if(this.edgeExceedsShortLineThreshold(o.leftEdge,t)){const d=w(o.pos,a,t),u=w(o.leftEdge.leftVertex.pos,a,t);this._checkForSnappingCandidate(r,u,d,e,c,t)}const l=s.vertices[0];if(this.edgeExceedsShortLineThreshold(l.rightEdge,t)){const d=w(l.pos,a,t),u=w(l.rightEdge.rightVertex.pos,a,t);this._checkForSnappingCandidate(r,u,d,e,c,t)}return r}snapExistingVertex(e,t){const s=[],i=t.vertexHandle;if(i.component.vertices.length<3)return s;const{view:r}=this,a=$(e,t.spatialReference,m,r),c=i.leftEdge,o=i.rightEdge;if(c!=null&&c.leftVertex.leftEdge){const l=c.leftVertex.leftEdge;if(this.edgeExceedsShortLineThreshold(l,t)){const d=w(l.rightVertex.pos,r,t),u=w(l.leftVertex.pos,r,t);this._checkForSnappingCandidate(s,u,d,e,a,t)}}if(o!=null&&o.rightVertex.rightEdge){const l=o.rightVertex.rightEdge;if(this.edgeExceedsShortLineThreshold(l,t)){const d=w(l.leftVertex.pos,r,t),u=w(l.rightVertex.pos,r,t);this._checkForSnappingCandidate(s,u,d,e,a,t)}}return s}_checkForSnappingCandidate(e,t,s,i,r,a){var h;const{spatialReference:c,pointer:o}=a;K($e,s,t);const l=ie(bs,$e[1],-$e[0],0),d=me(l,K($e,i,s))/we(l),u=L(Se(ee(i),s,l,d));if(ge(r,$(u,c,m,this.view))<this.squaredProximityThreshold(o)){if(this.isVertical(u,s)||this.isVertical(s,t))return;const p=A(y(),s,l,Math.sign(d));e.push(new Kt({targetPoint:u,constraint:new Ut(s,L(p)),previousVertex:t,otherVertex:s,otherVertexType:he.CENTER,isDraped:((h=a.elevationInfo)==null?void 0:h.mode)==="on-the-ground"}))}}};const $e=G(),bs=y();let Fs=class extends _e{constructor({targetPoint:e,point1:t,point2:s,isDraped:i}){super(e,new Yt(L(bn(y(),t,s,.5)),.5*Vt(t,s)),i,M.SELF),this._p1=t,this._p2=s}get hints(){return[new j(Z.REFERENCE,this.targetPoint,this._p1,this.isDraped,this.domain),new j(Z.REFERENCE,this.targetPoint,this._p2,this.isDraped,this.domain),new It(this._p1,this.targetPoint,this._p2,this.isDraped,this.domain)]}};class Vs extends qe{snapNewVertex(e,t){const s=t.editGeometryOperations.data.components[0],i=[],r=s.vertices.length;if(t.editGeometryOperations.data.type!=="polygon"||r<2)return i;const{view:a}=this,c=s.vertices[0],o=s.vertices[r-1],l=w(c.pos,a,t),d=w(o.pos,a,t);return this._processCandidateProposal(l,d,e,t,i),i}snapExistingVertex(e,t){const s=[],i=t.vertexHandle,r=i.component;if(r.edges.length<2||t.editGeometryOperations.data.type==="polyline"&&(i.index===0||i.index===r.vertices.length-1))return s;const{view:a}=this,c=w(i.leftEdge.leftVertex.pos,a,t),o=w(i.rightEdge.rightVertex.pos,a,t);return this._processCandidateProposal(c,o,e,t,s),s}_processCandidateProposal(e,t,s,i,r){var p;if(!this.exceedsShortLineThreshold(e,t,i))return;const a=$t(Is,e,t,.5),c=.5*Vt(e,t),o=y();Dn(o,s,a,c),o[2]=s[2];const l=L(o),{spatialReference:d,pointer:u}=i,h=$(s,d,m,this.view);if(ge(h,$(l,d,m,this.view))<this.squaredProximityThreshold(u)){if(this.isVertical(e,l)||this.isVertical(l,t))return;r.push(new Fs({targetPoint:l,point1:e,point2:t,isDraped:((p=i.elevationInfo)==null?void 0:p.mode)==="on-the-ground"}))}}}const Is=G();let ue=class extends fe{constructor(n){super(n),this.updating=!1,this._snappers=new Ke,this._domain=M.SELF}initialize(){this._snappers.push(new Rs(this.view,this.options),new $s(this.view,this.options),new Cs(this.view,this.options),new Vs(this.view,this.options))}set options(n){this._set("options",n);for(const e of this._snappers)e.options=n}async fetchCandidates(n,e,t){if(!(e&this._domain&&this.options.effectiveSelfEnabled))return[];const s=[];for(const i of this._snappers.items)for(const r of i.snap(n,t))s.push(r);return et(n,s),s}};f([g({readOnly:!0})],ue.prototype,"updating",void 0),f([g({constructOnly:!0})],ue.prototype,"view",void 0),f([g()],ue.prototype,"options",null),ue=f([pe("esri.views.interactive.snapping.SelfSnappingEngine")],ue);function Ms(n,e){return[new ue({view:n,options:e}),new ne({view:n,options:e,spatialReference:n.spatialReference})]}function Lt(n,e,{z:t,m:s,spatialReference:i,elevationInfo:r}){if(t==null&&s==null){const o=He(n[0],n[1],void 0,i);return s!=null&&(o.m=s,o.hasM=!0),o}if(e==null||e.type==="2d"){const o=He(n[0],n[1],t,i);return s!=null&&(o.m=s,o.hasM=!0),o}const a=Mn(e,n,i,m,r)??0,c=He(n[0],n[1],a,i);return s!=null&&(c.m=s,c.hasM=!0),c}class Te extends _e{constructor(e,t,s,i){super(e,new ve(e),i,M.ALL),this.first=t,this.second=s}get hints(){return this.first.targetPoint=this.targetPoint,this.second.targetPoint=this.targetPoint,[...this.first.hints,...this.second.hints,new On(this.targetPoint,this.isDraped,this.domain)]}}let q=class extends Fn.EventedMixin(fe){constructor(n){super(n),this.options=new jn,this.snappingEnginesFactory=Ms,this._engines=[],this._currentMainCandidate=null,this._currentOtherActiveCandidates=[],this._currentSnappedType=B.MAIN}initialize(){this.addHandles([Ee(()=>{const{effectiveFeatureEnabled:n,effectiveSelfEnabled:e,touchSensitivityMultiplier:t,distance:s}=this.options;return{effectiveFeatureEnabled:n,effectiveSelfEnabled:e,touchSensitivityMultiplier:t,distance:s}},()=>{this.doneSnapping(),this.emit("changed")},vt),Ee(()=>this.options,n=>{for(const e of this._engines)e.options=n},vt),Ee(()=>({viewReady:this.view.ready,viewSpatialReference:this.view.spatialReference,snappingEnginesFactory:this.snappingEnginesFactory}),({viewReady:n,snappingEnginesFactory:e})=>this._recreateEngines(n,e),Be)])}destroy(){this._destroyEngines()}get updating(){return this._engines.some(n=>n.updating)}_recreateEngines(n,e){if(this._destroyEngines(),!n)return;const{view:t,options:s}=this;this._engines=e(t,s)}_destroyEngines(){for(const n of this._engines)n.destroy();this._engines=[]}get _squaredMouseProximityTreshold(){return this.options.distance*this.options.distance}get _squaredTouchProximityThreshold(){const{distance:n,touchSensitivityMultiplier:e}=this.options,t=n*e;return t*t}get _squaredSatisfiesConstraintThreshold(){return J.satisfiesConstraintScreenThreshold*J.satisfiesConstraintScreenThreshold}snap(n){return Ns(n)?this._snapMultiPoint(n):this._snapSinglePoint(n)}update(n){const{point:e,context:t}=n;this._removeVisualization();const s=this._currentMainCandidate;if(s==null)return e;const i=this._selectUpdateInput(n);if(i==null)return e;const{spatialReference:r}=t,a=_t(i,r);if(a==null)return e;const{view:c}=this,{elevationInfo:o,visualizer:l}=t,d=[],u=Pe(a,c,o),h=s.constraint.closestTo(u);if(!this._arePointsWithinScreenThreshold(u,h,t))return this._resetSnappingState(),e;s.targetPoint=h,d.push(...s.hints);for(const p of this._currentOtherActiveCandidates)p.targetPoint=h,d.push(...p.hints);return l!=null&&this.addHandles(l.draw(d,{spatialReference:r,elevationInfo:As(t),view:c,selfSnappingZ:t.selfSnappingZ}),Re),Lt(h,c,{z:e.z,m:e.m,spatialReference:e.spatialReference,elevationInfo:o})}doneSnapping(){this._removeVisualization(),this._resetSnappingState()}_selectUpdateInput({point:n,scenePoint:e}){switch(this._currentSnappedType){case B.MAIN:return n;case B.SCENE:return e}}_resetSnappingState(){this._currentMainCandidate=null,this._currentOtherActiveCandidates=[],this._currentSnappedType=B.MAIN}_removeVisualization(){this.removeHandles(Re)}async _snapSinglePoint({point:n,context:e,signal:t}){const{view:s}=this,{elevationInfo:i}=e,r=Pe(n,s,i),a=await this._fetchCandidates(r,M.ALL,e,t);return this._createSnapResult(r,B.MAIN,a,s,e,{z:n.z,m:n.m,spatialReference:n.spatialReference,elevationInfo:i},t)}async _snapMultiPoint({point:n,scenePoint:e,context:t,signal:s}){const{view:i}=this,{coordinateHelper:r,elevationInfo:a,spatialReference:c}=t;await Vn(e.spatialReference,c);const o=_t(e,c),l=Pe(o,i,a),d=await this._fetchCandidates(l,M.FEATURE,t,s);if(d.length>0){const p=await this._fetchCandidates(l,M.SELF,t,s);return this._createSnapResult(l,B.SCENE,[...d,...p],i,t,{z:o.z,m:o.m,spatialReference:o.spatialReference,elevationInfo:a},s)}const u=Pe(n,i,a),h=await this._fetchCandidates(u,M.SELF,t,s);return this._createSnapResult(u,B.MAIN,h,i,t,{z:r.hasZ()&&n.hasZ?n.z??0:void 0,m:r.hasM()&&n.hasM?n.m??0:void 0,spatialReference:n.spatialReference,elevationInfo:a},s)}async _fetchCandidates(n,e,t,s){return(await Promise.all(this._engines.map(i=>i.fetchCandidates(n,e,t,s)))).flat()}_createSnapResult(n,e,t,s,i,r,a){return{get valid(){return!In(a)},apply:()=>{const{spatialReference:c}=i,{snappedPoint:o,hints:l}=this._processCandidates(n,e,t,i);return this._removeVisualization(),i.visualizer!=null&&this.addHandles(i.visualizer.draw(l,{spatialReference:c,elevationInfo:m,view:s,selfSnappingZ:i.selfSnappingZ}),Re),Lt(o,s,r)}}}_processCandidates(n,e,t,s){if(t.length<1)return this.doneSnapping(),{snappedPoint:n,hints:[]};this._currentSnappedType!==e&&this._resetSnappingState(),et(n,t);const i=this._currentMainCandidate;if(i!=null){const r=this._findOldConstraintInNewCandidates(i,t);if(r>=0){if(!(t[r]instanceof Te))return this._intersectWithOtherCandidates(r,t,n,e,s);if(this._arePointsWithinScreenThreshold(n,i.targetPoint,s))return this._updateSnappingCandidate(i,e,t,s)}}return this._intersectWithOtherCandidates(0,t,n,e,s)}_findOldConstraintInNewCandidates(n,e){return n instanceof Te?this._findOldCandidateIndex(e,n.first)>=0&&this._findOldCandidateIndex(e,n.second)>=0?0:-1:this._findOldCandidateIndex(e,n)}_intersectWithOtherCandidates(n,e,t,s,i){const{coordinateHelper:r}=i,a=e[n],c=[];for(let o=0;o<e.length;++o){if(o===n)continue;const l=e[o],d=a.constraint.intersect(l.constraint);if(d)for(const u of d.closestPoints(a.targetPoint))c.push([new Te(u,a,l,l.isDraped),this._squaredScreenDistance(t,u,r)])}return c.length>0&&(c.sort((o,l)=>o[1]-l[1]),c[0][1]<this._squaredPointProximityThreshold(i.pointer))?this._updateSnappingCandidate(c[0][0],s,e,i):this._updateSnappingCandidate(a,s,e,i)}_updateSnappingCandidate(n,e,t,s){this.doneSnapping(),this._currentMainCandidate=n,this._currentSnappedType=e;const i=this._currentMainCandidate.targetPoint,r=[];r.push(...n.hints);for(const a of t){if(n instanceof Te){if(a.constraint.equals(n.first.constraint)||a.constraint.equals(n.second.constraint))continue}else if(a.constraint.equals(n.constraint))continue;const c=a.constraint.closestTo(i);this._squaredScreenDistance(c,i,s.coordinateHelper)<this._squaredSatisfiesConstraintThreshold&&(a.targetPoint=i,this._currentOtherActiveCandidates.push(a),r.push(...a.hints))}return{snappedPoint:i,hints:r}}_squaredPointProximityThreshold(n){return n==="touch"?this._squaredTouchProximityThreshold:this._squaredMouseProximityTreshold}_arePointsWithinScreenThreshold(n,e,t){return this._squaredScreenDistance(n,e,t.coordinateHelper)<this._squaredPointProximityThreshold(t.pointer)}_squaredScreenDistance(n,e,t){return ge(this._toScreen(n,t),this._toScreen(e,t))}_toScreen(n,e){return $(n,e.spatialReference,m,this.view)}_findOldCandidateIndex(n,e){let t=-1;for(let s=0;s<n.length;++s)if(e.constraint.equals(n[s].constraint)){t=s;break}return t}get test(){return{visualizationsActive:this.hasHandles(Re),engines:this._engines}}};var B;f([g({constructOnly:!0})],q.prototype,"view",void 0),f([g()],q.prototype,"options",void 0),f([g({readOnly:!0})],q.prototype,"updating",null),f([g()],q.prototype,"snappingEnginesFactory",void 0),f([g()],q.prototype,"_engines",void 0),f([g()],q.prototype,"_squaredMouseProximityTreshold",null),f([g()],q.prototype,"_squaredTouchProximityThreshold",null),f([g()],q.prototype,"_squaredSatisfiesConstraintThreshold",null),q=f([pe("esri.views.interactive.snapping.SnappingManager")],q),function(n){n[n.MAIN=0]="MAIN",n[n.SCENE=1]="SCENE"}(B||(B={}));const Re="visualization-handle";function Ns(n){return n.scenePoint!=null}function As({coordinateHelper:n,elevationInfo:e}){return n.hasZ()?m:e}export{ne as I,q as P,Ut as T,Es as a,ve as b,es as d,H as e,jn as l,pt as n,Gn as p,ss as q,Ss as r};
