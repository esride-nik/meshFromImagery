import{a5 as a,a6 as d,a9 as V,cb as S,h3 as O,eH as Se,bA as oe,nW as bt,qN as rt,an as Ve,s as ze,iq as Mt,du as J,aD as At,v as Ct,mV as nt,eU as _e,bh as ot,qO as xt,_ as M,h1 as Oe,h7 as Ft,qP as Et,qQ as $t,qR as at,qS as Tt,cd as he,b9 as Rt,kj as Lt,dZ as St,al as Vt,lF as ae}from"./index-b516d057.js";import{O as X,n as u,e as j,r as Pe,Q as Re,i as ke}from"./jsxFactory-92036771.js";import{y as Ot,I as Pt}from"./Attachments-ef3101ea.js";import{e as lt}from"./Heading-92f210ca.js";import{x as me,C as dt,q as ct,d as B,D as Y,P as qe,z as je,R as kt,v as Xe,M as pt,Y as Nt,a as Ne,o as De,r as Dt,i as Be,E as Wt,s as Ht,J as Ut,n as zt,c as qt,u as Ie,h as jt,b as Xt}from"./featureUtils-73b624d6.js";import{e as ut,t as Bt}from"./widget-826a6ea9.js";import{e as ee}from"./globalCss-94006b67.js";import{p as Yt}from"./uriUtils-dead790b.js";import{x as Qt}from"./utils-6ca5af6f.js";import{m as Jt,b as be}from"./Query-071039d7.js";import{s as Me}from"./executeQueryJSON-eec0ecca.js";import"./featureConversionUtils-09cf00ff.js";import"./pbf-2651fe50.js";import"./AttachmentInfo-3d2302be.js";import"./AttachmentQuery-bede5a71.js";import Kt from"./RelationshipQuery-2c9e4485.js";import"./TopFeaturesQuery-6d0bf5f5.js";import{r as Zt}from"./themeUtils-7dcf5b71.js";import{e as ht}from"./throttle-7bf02de9.js";import Gt from"./FeatureLayer-c4c5819f.js";import{F as We}from"./FeatureRelationshipViewModel-9f00674c.js";import{t as b}from"./resources-d4afed0c.js";let se=class extends Ot{constructor(e){super(e),this.description=null,this.title=null}};a([d()],se.prototype,"description",void 0),a([d()],se.prototype,"title",void 0),se=a([V("esri.widgets.Feature.FeatureAttachments.FeatureAttachmentsViewModel")],se);const He=se,Ae="esri-feature-element-info",Ce={base:Ae,title:`${Ae}__title`,description:`${Ae}__description`};let Z=class extends X{constructor(e,i){super(e,i),this.description=null,this.headingLevel=2,this.title=null}render(){return u("div",{class:Ce.base},this._renderTitle(),this._renderDescription())}_renderTitle(){const{title:e}=this;return e?u(lt,{class:Ce.title,level:this.headingLevel},e):null}_renderDescription(){const{description:e}=this;return e?u("div",{class:Ce.description,key:"description"},e):null}};a([d()],Z.prototype,"description",void 0),a([d()],Z.prototype,"headingLevel",void 0),a([d()],Z.prototype,"title",void 0),Z=a([V("esri.widgets.Feature.support.FeatureElementInfo")],Z);const ge=Z,ei={base:"esri-feature-attachments"};let D=class extends X{constructor(e,i){super(e,i),this._featureElementInfo=null,this.attachmentsWidget=new Pt,this.headingLevel=2,this.viewModel=new He}initialize(){this._featureElementInfo=new ge,this.addHandles([S(()=>{var e,i;return[(e=this.viewModel)==null?void 0:e.description,(i=this.viewModel)==null?void 0:i.title,this.headingLevel]},()=>this._setupFeatureElementInfo(),O),S(()=>this.viewModel,e=>this.attachmentsWidget.viewModel=e,O)])}destroy(){var e;this.attachmentsWidget.viewModel=null,this.attachmentsWidget.destroy(),(e=this._featureElementInfo)==null||e.destroy()}get description(){return this.viewModel.description}set description(e){this.viewModel.description=e}get displayType(){return this.attachmentsWidget.displayType}set displayType(e){this.attachmentsWidget.displayType=e}get graphic(){return this.viewModel.graphic}set graphic(e){this.viewModel.graphic=e}get title(){return this.viewModel.title}set title(e){this.viewModel.title=e}render(){var i;const{attachmentsWidget:e}=this;return u("div",{class:ei.base},(i=this._featureElementInfo)==null?void 0:i.render(),e==null?void 0:e.render())}_setupFeatureElementInfo(){var r;const{description:e,title:i,headingLevel:s}=this;(r=this._featureElementInfo)==null||r.set({description:e,title:i,headingLevel:s})}};a([d({readOnly:!0})],D.prototype,"attachmentsWidget",void 0),a([d()],D.prototype,"description",null),a([d()],D.prototype,"displayType",null),a([d()],D.prototype,"graphic",null),a([d()],D.prototype,"headingLevel",void 0),a([d()],D.prototype,"title",null),a([d({type:He})],D.prototype,"viewModel",void 0),D=a([V("esri.widgets.Feature.FeatureAttachments")],D);const ti=D;let q=class extends oe{constructor(e){super(e),this._loadingPromise=null,this.created=null,this.creator=null,this.destroyer=null,this.graphic=null,this.addHandles(S(()=>this.creator,i=>{this._destroyContent(),this._createContent(i)},O))}destroy(){this._destroyContent()}get state(){return this._loadingPromise?"loading":"ready"}_destroyContent(){const{created:e,graphic:i,destroyer:s}=this;e&&i&&(me(s,{graphic:i}).catch(()=>null),this._set("created",null))}async _createContent(e){const i=this.graphic;if(!i||!e)return;const s=me(e,{graphic:i}).catch(()=>null);this._loadingPromise=s,this.notifyChange("state");const r=await s;s===this._loadingPromise&&(this._loadingPromise=null,this.notifyChange("state"),this._set("created",r))}};a([d({readOnly:!0})],q.prototype,"created",void 0),a([d()],q.prototype,"creator",void 0),a([d()],q.prototype,"destroyer",void 0),a([d({type:Se})],q.prototype,"graphic",void 0),a([d({readOnly:!0})],q.prototype,"state",null),q=a([V("esri.widgets.Feature.FeatureContent.FeatureContentViewModel")],q);const fe=q,xe="esri-feature-content",Fe={base:xe,loaderContainer:`${xe}__loader-container`,loader:`${xe}__loader`};let G=class extends X{constructor(e,i){super(e,i),this.viewModel=null,this._addTargetToAnchors=s=>{Array.from(s.querySelectorAll("a")).forEach(r=>{dt(r.href)&&!r.hasAttribute("target")&&r.setAttribute("target","_blank")})}}get creator(){var e;return(e=this.viewModel)==null?void 0:e.creator}set creator(e){this.viewModel&&(this.viewModel.creator=e)}get graphic(){var e;return(e=this.viewModel)==null?void 0:e.graphic}set graphic(e){this.viewModel&&(this.viewModel.graphic=e)}render(){var i;const e=(i=this.viewModel)==null?void 0:i.state;return u("div",{class:Fe.base},e==="loading"?this._renderLoading():this._renderCreated())}_renderLoading(){return u("div",{class:Fe.loaderContainer,key:"loader"},u("div",{class:Fe.loader}))}_renderCreated(){var i;const e=(i=this.viewModel)==null?void 0:i.created;return e?e instanceof HTMLElement?u("div",{afterCreate:this._attachToNode,bind:e,key:e}):ut(e)?u("div",{key:e},!e.destroyed&&e.render()):u("div",{afterCreate:this._addTargetToAnchors,innerHTML:e,key:e}):null}_attachToNode(e){const i=this;e.appendChild(i)}};a([d()],G.prototype,"creator",null),a([d()],G.prototype,"graphic",null),a([d({type:fe})],G.prototype,"viewModel",void 0),G=a([V("esri.widgets.Feature.FeatureContent")],G);const ce=G;let H=class extends oe{constructor(e){super(e),this.attributes=null,this.expressionInfos=null,this.description=null,this.fieldInfos=null,this.title=null}get formattedFieldInfos(){const{expressionInfos:e,fieldInfos:i}=this,s=[];return i==null||i.forEach(r=>{if(!(!r.hasOwnProperty("visible")||r.visible))return;const n=r.clone();n.label=ct(n,e),s.push(n)}),s}};a([d()],H.prototype,"attributes",void 0),a([d({type:[bt]})],H.prototype,"expressionInfos",void 0),a([d()],H.prototype,"description",void 0),a([d({type:[rt]})],H.prototype,"fieldInfos",void 0),a([d({readOnly:!0})],H.prototype,"formattedFieldInfos",null),a([d()],H.prototype,"title",void 0),H=a([V("esri.widgets.Feature.FeatureFields.FeatureFieldsViewModel")],H);const ye=H,le="esri-feature-fields",de={base:le,fieldHeader:`${le}__field-header`,fieldData:`${le}__field-data`,fieldDataDate:`${le}__field-data--date`};let N=class extends X{constructor(e,i){super(e,i),this._featureElementInfo=null,this.viewModel=new ye,this.messages=null,this.messagesURIUtils=null}initialize(){this._featureElementInfo=new ge,this.addHandles(S(()=>{var e,i;return[(e=this.viewModel)==null?void 0:e.description,(i=this.viewModel)==null?void 0:i.title]},()=>this._setupFeatureElementInfo(),O))}destroy(){var e;(e=this._featureElementInfo)==null||e.destroy()}get attributes(){return this.viewModel.attributes}set attributes(e){this.viewModel.attributes=e}get description(){return this.viewModel.description}set description(e){this.viewModel.description=e}get expressionInfos(){return this.viewModel.expressionInfos}set expressionInfos(e){this.viewModel.expressionInfos=e}get fieldInfos(){return this.viewModel.fieldInfos}set fieldInfos(e){this.viewModel.fieldInfos=e}get title(){return this.viewModel.title}set title(e){this.viewModel.title=e}render(){var e;return u("div",{class:de.base},(e=this._featureElementInfo)==null?void 0:e.render(),this._renderFields())}_renderFieldInfo(e,i){const{attributes:s}=this.viewModel,r=e.fieldName,n=e.label||r,o=s?s[r]==null?"":s[r]:"",l=!(!e.format||!e.format.dateFormat),p=typeof o=="number"&&!l?this._forceLTR(o):Yt(this.messagesURIUtils,o),c={[de.fieldDataDate]:l};return u("tr",{key:`fields-element-info-row-${r}-${i}`},u("th",{class:de.fieldHeader,innerHTML:n,key:`fields-element-info-row-header-${r}-${i}`}),u("td",{class:this.classes(de.fieldData,c),innerHTML:p,key:`fields-element-info-row-data-${r}-${i}`}))}_renderFields(){const{formattedFieldInfos:e}=this.viewModel;return e!=null&&e.length?u("table",{class:ee.table,summary:this.messages.fieldsSummary},u("tbody",null,e.map((i,s)=>this._renderFieldInfo(i,s)))):null}_setupFeatureElementInfo(){var s;const{description:e,title:i}=this;(s=this._featureElementInfo)==null||s.set({description:e,title:i})}_forceLTR(e){return`&lrm;${e}`}};a([d()],N.prototype,"attributes",null),a([d()],N.prototype,"description",null),a([d()],N.prototype,"expressionInfos",null),a([d()],N.prototype,"fieldInfos",null),a([d()],N.prototype,"title",null),a([d({type:ye,nonNullable:!0})],N.prototype,"viewModel",void 0),a([d(),j("esri/widgets/Feature/t9n/Feature")],N.prototype,"messages",void 0),a([d(),j("esri/widgets/support/t9n/uriUtils")],N.prototype,"messagesURIUtils",void 0),N=a([V("esri.widgets.Feature.FeatureFields")],N);const mt=N,ii=()=>window.matchMedia("(prefers-reduced-motion: reduce)").matches,si="esri.widgets.Feature.support.relatedFeatureUtils",Ye=Ve.getLogger(si),Qe=new Map;function pe(t){if(!B(t))return null;const[e,i]=t.split("/").slice(1);return{layerId:e,fieldName:i}}function ri(t,e){if(!e.relationships)return null;let i=null;const{relationships:s}=e;return s.some(r=>r.id===parseInt(t,10)&&(i=r,!0)),i}function ni({originRelationship:t,relationships:e,layerId:i}){let s=null;return e&&e.some(r=>(`${r.relatedTableId}`===i&&r.id===(t==null?void 0:t.id)&&(s=r),!!s)),s}function oi(t,e){const i=e.toLowerCase();for(const s in t)if(s.toLowerCase()===i)return t[s];return null}function ai(t,e){const i=ri(t,e);if(i)return{url:`${e.url}/${i.relatedTableId}`,sourceSpatialReference:e.spatialReference,relation:i,relatedFields:[],outStatistics:[]}}function li(t,e){if(!e||!t)return;const{features:i,statsFeatures:s}=t,r=i==null?void 0:i.value;e.relatedFeatures=r?r.features:[];const n=s==null?void 0:s.value;e.relatedStatsFeatures=n?n.features:[]}function di(t,e,i,s){var n;const r=new Kt;return r.outFields=["*"],r.relationshipId=typeof e.id=="number"?e.id:parseInt(e.id,10),r.objectIds=[t.attributes[i.objectIdField]],((n=i.queryRelatedFeatures)==null?void 0:n.call(i,r,s))??Promise.resolve({})}function ci(t,e,i){let s=0;const r=[];for(;s<e.length;)r.push(`${t} IN (${e.slice(s,i+s)})`),s+=i;return r.join(" OR ")}function pi(t){return t?nt(t):void 0}function ui(t){return t?nt(t,(e,i)=>JSON.stringify(e.toJSON())===JSON.stringify(i.toJSON())):void 0}async function hi(t,e,i,s){const r=i.layerId.toString(),{layerInfo:n,relation:o,relatedFields:l,outStatistics:p,url:c,sourceSpatialReference:h}=e,m=pi(l),f=ui(p);if(!n||!o)return null;const _=ni({originRelationship:o,relationships:n.relationships,layerId:r});if(_!=null&&_.relationshipTableId&&_.keyFieldInRelationshipTable){const y=(await di(t,_,i,s))[t.attributes[i.objectIdField]];if(!y)return null;const w=y.features.map(v=>v.attributes[n.objectIdField]);if(f!=null&&f.length&&n.supportsStatistics){const v=new be;v.where=ci(n.objectIdField,w,1e3),v.outFields=m,v.outStatistics=f,v.sourceSpatialReference=h;const F={features:Promise.resolve(y),statsFeatures:Me(c,v)};return J(F)}}const g=_==null?void 0:_.keyField;if(g){const y=At(yi(n.fields,g)),w=oi(t.attributes,o.keyField),v=y?`${g}=${w}`:`${g}='${w}'`,F=Me(c,new be({where:v,outFields:m,sourceSpatialReference:h}),s),A=f!=null&&f.length&&n.supportsStatistics?Me(c,new be({where:v,outFields:m,outStatistics:f,sourceSpatialReference:h}),s):null,$={features:F};return A&&($.statsFeatures=A),J($)}return null}function mi(t,e){return Ct(t,{query:{f:"json"},signal:e==null?void 0:e.signal})}function fi({relatedInfos:t,layer:e},i){const s={};return t.forEach((r,n)=>{const{relation:o}=r;if(!o){const m=new ze("relation-required","A relation is required on a layer to retrieve related records.");throw Ye.error(m),m}const{relatedTableId:l}=o;if(typeof l!="number"){const m=new ze("A related table ID is required on a layer to retrieve related records.");throw Ye.error(m),m}const p=`${e.url}/${l}`,c=Qe.get(p),h=c??mi(p);c||Qe.set(p,h),s[n]=h}),Mt(J(s),i)}function _i({graphic:t,relatedInfos:e,layer:i},s){const r={};return e.forEach((n,o)=>{n.layerInfo&&(r[o]=hi(t,n,i,s))}),J(r)}function gi({relatedInfo:t,fieldName:e,fieldInfo:i}){var s,r;if((s=t.relatedFields)==null||s.push(e),i.statisticType){const n=new Jt({statisticType:i.statisticType,onStatisticField:e,outStatisticFieldName:e});(r=t.outStatistics)==null||r.push(n)}}function yi(t,e){if(t!=null){e=e.toLowerCase();for(const i of t)if(i&&i.name.toLowerCase()===e)return i}return null}const Je={chartAnimation:!0};let x=class extends oe{constructor(t){super(t),this.abilities={...Je},this.activeMediaInfoIndex=0,this.attributes=null,this.description=null,this.fieldInfoMap=null,this.formattedAttributes=null,this.expressionAttributes=null,this.isAggregate=!1,this.layer=null,this.mediaInfos=null,this.popupTemplate=null,this.relatedInfos=null,this.title=null}castAbilities(t){return{...Je,...t}}get activeMediaInfo(){return this.formattedMediaInfos[this.activeMediaInfoIndex]||null}get formattedMediaInfos(){return this._formatMediaInfos()||[]}get formattedMediaInfoCount(){return this.formattedMediaInfos.length}setActiveMedia(t){this._setContentElementMedia(t)}next(){this._pageContentElementMedia(1)}previous(){this._pageContentElementMedia(-1)}_setContentElementMedia(t){const{formattedMediaInfoCount:e}=this,i=(t+e)%e;this.activeMediaInfoIndex=i}_pageContentElementMedia(t){const{activeMediaInfoIndex:e}=this,i=e+t;this._setContentElementMedia(i)}_formatMediaInfos(){const{mediaInfos:t,layer:e}=this,i=this.attributes??{},s=this.formattedAttributes??{},r=this.expressionAttributes??{},n=this.fieldInfoMap??new Map;return(t==null?void 0:t.map(o=>{const l=o==null?void 0:o.clone();if(!l)return null;if(l.title=Y({attributes:i,fieldInfoMap:n,globalAttributes:s,expressionAttributes:r,layer:e,text:l.title}),l.caption=Y({attributes:i,fieldInfoMap:n,globalAttributes:s,expressionAttributes:r,layer:e,text:l.caption}),l.altText=Y({attributes:i,fieldInfoMap:n,globalAttributes:s,expressionAttributes:r,layer:e,text:l.altText}),l.type==="image"){const{value:p}=l;return this._setImageValue({value:p,formattedAttributes:s,layer:e}),l.value.sourceURL?l:void 0}if(l.type==="pie-chart"||l.type==="line-chart"||l.type==="column-chart"||l.type==="bar-chart"){const{value:p}=l;return this._setChartValue({value:p,chartType:l.type,attributes:i,formattedAttributes:s,layer:e,expressionAttributes:r}),l}return null}).filter(ot))??[]}_setImageValue(t){const e=this.fieldInfoMap??new Map,{value:i,formattedAttributes:s,layer:r}=t,{linkURL:n,sourceURL:o}=i;if(o){const l=qe(o,r);i.sourceURL=je({formattedAttributes:s,template:l,fieldInfoMap:e})}if(n){const l=qe(n,r);i.linkURL=je({formattedAttributes:s,template:l,fieldInfoMap:e})}}_setChartValue(t){const{value:e,attributes:i,formattedAttributes:s,chartType:r,layer:n,expressionAttributes:o}=t,{popupTemplate:l,relatedInfos:p}=this,{fields:c,normalizeField:h}=e,m=n;if(e.fields=kt(c,m),h&&(e.normalizeField=Xe(h,m)),!c.some(_=>!!(s[_]!=null||B(_)&&(p!=null&&p.size))))return;const f=(l==null?void 0:l.fieldInfos)??[];c.forEach((_,g)=>{var v;const y=(v=e.colors)==null?void 0:v[g];if(B(_))return void(e.series=[...e.series,...this._getRelatedChartInfos({fieldInfos:f,fieldName:_,formattedAttributes:s,chartType:r,value:e,color:y})]);const w=this._getChartOption({value:e,attributes:i,chartType:r,formattedAttributes:s,expressionAttributes:o,fieldName:_,fieldInfos:f,color:y});e.series.push(w)})}_getRelatedChartInfos(t){var _;const{fieldInfos:e,fieldName:i,formattedAttributes:s,chartType:r,value:n,color:o}=t,l=[],p=pe(i),c=p&&((_=this.relatedInfos)==null?void 0:_.get(p.layerId.toString()));if(!c)return l;const{relatedFeatures:h,relation:m}=c;if(!m||!h)return l;const{cardinality:f}=m;return h.forEach(g=>{const{attributes:y}=g;y&&Object.keys(y).forEach(w=>{w===p.fieldName&&l.push(this._getChartOption({value:n,attributes:y,formattedAttributes:s,fieldName:i,chartType:r,relatedFieldName:w,hasMultipleRelatedFeatures:(h==null?void 0:h.length)>1,fieldInfos:e,color:o}))})}),f==="one-to-many"||f==="many-to-many"?l:[l[0]]}_getTooltip({label:t,value:e,chartType:i}){return i==="pie-chart"?`${t}`:`${t}: ${e}`}_getChartOption(t){var U;const{value:e,attributes:i,formattedAttributes:s,expressionAttributes:r,fieldName:n,relatedFieldName:o,fieldInfos:l,chartType:p,hasMultipleRelatedFeatures:c,color:h}=t,m=this.layer,f=this.fieldInfoMap??new Map,{normalizeField:_,tooltipField:g}=e,y=_?B(_)?i[pe(_).fieldName]:i[_]:null,w=pt(n)&&r&&r[n]!==void 0?r[n]:o&&i[o]!==void 0?i[o]:i[n]!==void 0?i[n]:s[n],v=new xt({fieldName:n,color:h,value:w===void 0?null:w&&y?w/y:w});if(B(n)){const k=f.get(n.toLowerCase()),ve=g&&f.get(g.toLowerCase()),vt=(k==null?void 0:k.fieldName)??n,we=c&&g?pe(g).fieldName:(ve==null?void 0:ve.fieldName)??g,wt=c&&we?i[we]:s[we]??(k==null?void 0:k.label)??(k==null?void 0:k.fieldName)??o,It=c&&o?i[o]:s[vt];return v.tooltip=this._getTooltip({label:wt,value:It,chartType:p}),v}const F=Nt(l,n),A=Xe(n,m),$=g&&s[g]!==void 0?s[g]:ct(F||new rt({fieldName:A}),(U=this.popupTemplate)==null?void 0:U.expressionInfos),K=s[A];return v.tooltip=this._getTooltip({label:$,value:K,chartType:p}),v}};a([d()],x.prototype,"abilities",void 0),a([_e("abilities")],x.prototype,"castAbilities",null),a([d()],x.prototype,"activeMediaInfoIndex",void 0),a([d({readOnly:!0})],x.prototype,"activeMediaInfo",null),a([d()],x.prototype,"attributes",void 0),a([d()],x.prototype,"description",void 0),a([d()],x.prototype,"fieldInfoMap",void 0),a([d()],x.prototype,"formattedAttributes",void 0),a([d()],x.prototype,"expressionAttributes",void 0),a([d({readOnly:!0})],x.prototype,"formattedMediaInfos",null),a([d()],x.prototype,"isAggregate",void 0),a([d()],x.prototype,"layer",void 0),a([d({readOnly:!0})],x.prototype,"formattedMediaInfoCount",null),a([d()],x.prototype,"mediaInfos",void 0),a([d()],x.prototype,"popupTemplate",void 0),a([d()],x.prototype,"relatedInfos",void 0),a([d()],x.prototype,"title",void 0),x=a([V("esri.widgets.Feature.FeatureMedia.FeatureMediaViewModel")],x);const Q=x,C="esri-feature-media",T={base:C,mediaContainer:`${C}__container`,mediaItemContainer:`${C}__item-container`,mediaItem:`${C}__item`,mediaItemText:`${C}__item-text`,mediaItemTitle:`${C}__item-title`,mediaItemCaption:`${C}__item-caption`,mediaNavigation:`${C}__item-navigation`,mediaPagination:`${C}__pagination`,mediaPaginationText:`${C}__pagination-text`,mediaPrevious:`${C}__previous`,mediaPreviousIconLTR:`${C}__previous-icon`,mediaPreviousIconRTL:`${C}__previous-icon--rtl`,mediaNext:`${C}__next`,mediaNextIconLTR:`${C}__next-icon`,mediaNextIconRTL:`${C}__next-icon--rtl`,mediaChart:`${C}__chart`,mediaPaginationButton:`${C}__pagination-button`,mediaPaginationIcon:`${C}__pagination-icon`,mediaChartRendered:`${C}__chart--rendered`},Ee=15,z="category",te="value",vi="rgba(50, 50, 50, 1)",wi=250,Ii=500,bi=200;let R=class extends X{constructor(e,i){super(e,i),this._refreshTimer=null,this._refreshIntervalInfo=null,this._featureElementInfo=null,this._chartRootMap=new WeakMap,this.viewModel=new Q,this.messages=null,this._disposeChart=s=>{var r;(r=this._chartRootMap.get(s))==null||r.dispose(),this._chartRootMap.delete(s)},this._createChart=async s=>{const{destroyed:r,viewModel:n}=this;if(r||!n||!s)return;const{createRoot:o}=await M(()=>import("./chartUtilsAm5-945b8e53.js"),["assets/chartUtilsAm5-945b8e53.js","assets/index-b516d057.js","assets/index-b252abd2.css","assets/Theme-016ad2b9.js","assets/chartUtilsAm5-2f34c09b.js","assets/Tooltip-3e2bf68f.js","assets/DefaultTheme-ef2e8ff5.js"]),l=await o(s);this._chartRootMap.set(s,l),this._renderChart({mediaInfo:n.activeMediaInfo,root:l})}}initialize(){this._featureElementInfo=new ge,this.addHandles([S(()=>{var e,i;return[(e=this.viewModel)==null?void 0:e.activeMediaInfo,(i=this.viewModel)==null?void 0:i.activeMediaInfoIndex]},()=>this._setupMediaRefreshTimer(),O),S(()=>{var e,i;return[(e=this.viewModel)==null?void 0:e.description,(i=this.viewModel)==null?void 0:i.title]},()=>this._setupFeatureElementInfo(),O)])}loadDependencies(){return Pe({icon:()=>M(()=>import("./calcite-icon-39deb8ae.js"),["assets/calcite-icon-39deb8ae.js","assets/icon-c122f720.js","assets/jsxFactory-92036771.js","assets/index-b516d057.js","assets/index-b252abd2.css","assets/uuid-709b6c67.js","assets/observers-9c654f26.js"])})}destroy(){var e;this._clearMediaRefreshTimer(),(e=this._featureElementInfo)==null||e.destroy()}get attributes(){return this.viewModel.attributes}set attributes(e){this.viewModel.attributes=e}get activeMediaInfoIndex(){return this.viewModel.activeMediaInfoIndex}set activeMediaInfoIndex(e){this.viewModel.activeMediaInfoIndex=e}get description(){return this.viewModel.description}set description(e){this.viewModel.description=e}get fieldInfoMap(){return this.viewModel.fieldInfoMap}set fieldInfoMap(e){this.viewModel.fieldInfoMap=e}get layer(){return this.viewModel.layer}set layer(e){this.viewModel.layer=e}get mediaInfos(){return this.viewModel.mediaInfos}set mediaInfos(e){this.viewModel.mediaInfos=e}get popupTemplate(){return this.viewModel.popupTemplate}set popupTemplate(e){this.viewModel.popupTemplate=e}get relatedInfos(){return this.viewModel.relatedInfos}set relatedInfos(e){this.viewModel.relatedInfos=e}get title(){return this.viewModel.title}set title(e){this.viewModel.title=e}render(){var e;return u("div",{bind:this,class:T.base,onkeyup:this._handleMediaKeyup},(e=this._featureElementInfo)==null?void 0:e.render(),this._renderMedia())}_renderMedia(){const{formattedMediaInfoCount:e,activeMediaInfoIndex:i}=this.viewModel,s=this._renderMediaText();return e?u("div",{class:T.mediaContainer,key:"media-element-container"},this._renderMediaInfo(),u("div",{class:T.mediaNavigation},s,e>1?u("div",{class:T.mediaPagination},this._renderMediaPageButton("previous"),u("span",{class:T.mediaPaginationText},Oe(this.messages.pageText,{index:i+1,total:e})),this._renderMediaPageButton("next")):null)):null}_renderMediaText(){const{activeMediaInfo:e}=this.viewModel;if(!e)return null;const i=e&&e.title?u("div",{class:T.mediaItemTitle,innerHTML:e.title,key:"media-title"}):null,s=e&&e.caption?u("div",{class:T.mediaItemCaption,innerHTML:e.caption,key:"media-caption"}):null;return i||s?u("div",{class:T.mediaItemText,key:"media-text"},i,s):null}_renderImageMediaInfo(e){const{_refreshIntervalInfo:i}=this,{activeMediaInfoIndex:s,formattedMediaInfoCount:r}=this.viewModel,{value:n,refreshInterval:o,altText:l,title:p,type:c}=e,{sourceURL:h,linkURL:m}=n,f=dt(m??void 0)?"_blank":"_self",_=f==="_blank"?"noreferrer":"",g=o?i:null,y=g?g.timestamp:0,w=g?g.sourceURL:h,v=u("img",{alt:l||p,key:`media-${c}-${s}-${r}-${y}`,src:w??void 0});return(m?u("a",{href:m,rel:_,target:f,title:p},v):null)??v}_renderChartMediaInfo(e){const{activeMediaInfoIndex:i,formattedMediaInfoCount:s}=this.viewModel;return u("div",{afterCreate:this._createChart,afterRemoved:this._disposeChart,bind:this,class:T.mediaChart,key:`media-${e.type}-${i}-${s}`})}_renderMediaInfoType(){const{activeMediaInfo:e}=this.viewModel;return e?e.type==="image"?this._renderImageMediaInfo(e):e.type.includes("chart")?this._renderChartMediaInfo(e):null:null}_renderMediaInfo(){const{activeMediaInfo:e}=this.viewModel;return e?u("div",{class:T.mediaItemContainer,key:"media-container"},u("div",{class:T.mediaItem,key:"media-item-container"},this._renderMediaInfoType())):null}_renderMediaPageButton(e){if(this.viewModel.formattedMediaInfoCount<2)return null;const i=e==="previous",s=i?this.messages.previous:this.messages.next,r=i?"chevron-left":"chevron-right",n=i?"media-previous":"media-next",o=i?this._previous:this._next;return u("button",{"aria-label":s,bind:this,class:T.mediaPaginationButton,key:n,onclick:o,tabIndex:0,title:s,type:"button"},u("calcite-icon",{class:T.mediaPaginationIcon,icon:r,scale:"s"}))}_setupFeatureElementInfo(){var s;const{description:e,title:i}=this;(s=this._featureElementInfo)==null||s.set({description:e,title:i})}_next(){this.viewModel.next()}_previous(){this.viewModel.previous()}_getRenderer(){if(!this.viewModel)return;const{isAggregate:e,layer:i}=this.viewModel;return e&&(i!=null&&i.featureReduction)&&"renderer"in i.featureReduction?i.featureReduction.renderer:i==null?void 0:i.renderer}async _getSeriesColors(e){const{colorAm5:i}=await M(()=>import("./chartCommon-a080f93e.js"),["assets/chartCommon-a080f93e.js","assets/Theme-016ad2b9.js","assets/index-b516d057.js","assets/index-b252abd2.css","assets/Responsive-41bba195.js","assets/Button-d5e3d401.js","assets/Tooltip-3e2bf68f.js","assets/ColorSet-19b07c03.js"]),s=new Map;return e.forEach(r=>{r.color&&s.set(r,i(r.color.toCss(!0)))}),s}async _getRendererColors(){const{colorAm5:e}=await M(()=>import("./chartCommon-a080f93e.js"),["assets/chartCommon-a080f93e.js","assets/Theme-016ad2b9.js","assets/index-b516d057.js","assets/index-b252abd2.css","assets/Responsive-41bba195.js","assets/Button-d5e3d401.js","assets/Tooltip-3e2bf68f.js","assets/ColorSet-19b07c03.js"]),i=new Map,s=this._getRenderer(),r="default";if(!s)return i;const n=await Qt(s);return n.delete(r),Array.from(n.values()).every(o=>(o==null?void 0:o.length)===1)&&Array.from(n.keys()).forEach(o=>{var p,c;const l=(c=(p=n.get(o))==null?void 0:p[0])==null?void 0:c.toCss(!0);l&&i.set(o,e(l))}),i}_handleMediaKeyup(e){const i=Ft(e);i==="ArrowLeft"&&(e.stopPropagation(),this.viewModel.previous()),i==="ArrowRight"&&(e.stopPropagation(),this.viewModel.next())}_canAnimateChart(){return!!this.viewModel&&!!this.viewModel.abilities.chartAnimation&&!ii()}_getChartAnimationMS(){return this._canAnimateChart()?wi:0}_getChartSeriesAnimationMS(){return this._canAnimateChart()?Ii:0}async _renderChart(e){const{root:i,mediaInfo:s}=e,{value:r,type:n}=s,{ResponsiveThemeAm5:o,DarkThemeAm5:l,AnimatedThemeAm5:p,ColorSetAm5:c,ThemeAm5:h,esriChartColorSet:m}=await M(()=>import("./chartCommon-a080f93e.js"),["assets/chartCommon-a080f93e.js","assets/Theme-016ad2b9.js","assets/index-b516d057.js","assets/index-b252abd2.css","assets/Responsive-41bba195.js","assets/Button-d5e3d401.js","assets/Tooltip-3e2bf68f.js","assets/ColorSet-19b07c03.js"]),f=h.new(i);f.rule("ColorSet").set("colors",m),f.rule("ColorSet").set("reuse",!0);const _=[o.new(i),f];Zt()&&_.push(l.new(i)),this._canAnimateChart()&&_.push(p.new(i)),i.setThemes(_);const g=await this._getRendererColors(),y=await this._getSeriesColors(r.series),w=c.new(i,{}),v=y.get(r.series[0]),F=v?{lineSettings:{stroke:v}}:void 0,A=r.series.map(($,K)=>{const U=y.get($)||g.get($.fieldName)||w.getIndex(K);return{[z]:$.tooltip,[te]:$.value,columnSettings:{fill:U,stroke:U},...F}}).filter($=>n!=="pie-chart"||$.value!=null&&$.value>0);n==="pie-chart"?this._createPieChart(e,A):this._createXYChart(e,A)}_getDirection(){return Re(this.container)?"rtl":"ltr"}_isInversed(){return!!Re(this.container)}async _customizeChartTooltip(e,i="horizontal"){var r;const{colorAm5:s}=await M(()=>import("./chartCommon-a080f93e.js"),["assets/chartCommon-a080f93e.js","assets/Theme-016ad2b9.js","assets/index-b516d057.js","assets/index-b252abd2.css","assets/Responsive-41bba195.js","assets/Button-d5e3d401.js","assets/Tooltip-3e2bf68f.js","assets/ColorSet-19b07c03.js"]);e.setAll({pointerOrientation:i}),(r=e.get("background"))==null||r.setAll({stroke:s(vi)}),e.label.setAll({direction:this._getDirection(),oversizedBehavior:"wrap",maxWidth:bi})}async _createPieChart(e,i){const{TooltipAm5:s}=await M(()=>import("./chartCommon-a080f93e.js"),["assets/chartCommon-a080f93e.js","assets/Theme-016ad2b9.js","assets/index-b516d057.js","assets/index-b252abd2.css","assets/Responsive-41bba195.js","assets/Button-d5e3d401.js","assets/Tooltip-3e2bf68f.js","assets/ColorSet-19b07c03.js"]),{PieChartAm5:r,PieSeriesAm5:n}=await M(()=>import("./pieChart-8272b6ff.js"),["assets/pieChart-8272b6ff.js","assets/index-b516d057.js","assets/index-b252abd2.css","assets/Tick-52f438fc.js","assets/Theme-016ad2b9.js","assets/ColorSet-19b07c03.js","assets/DefaultTheme-ef2e8ff5.js"]),{mediaInfo:o,root:l}=e,{title:p}=o,c=5,h=(o==null?void 0:o.altText)||(o==null?void 0:o.title)||"",m=l.container.children.push(r.new(l,{ariaLabel:h,focusable:!0,paddingBottom:c,paddingTop:c,paddingLeft:c,paddingRight:c})),f=`{category}: {valuePercentTotal.formatNumber('0.00')}%
 ({value})`,_=s.new(l,{labelText:f}),g=m.series.push(n.new(l,{name:p,valueField:te,categoryField:z,tooltip:_}));g.ticks.template.set("forceHidden",!0),g.labels.template.set("forceHidden",!0),g.slices.template.states.create("active",{shiftRadius:c}),this._customizeChartTooltip(_),g.slices.template.setAll({ariaLabel:f,focusable:!0,templateField:"columnSettings"}),g.data.setAll(i),g.appear(this._getChartSeriesAnimationMS()),m.appear(this._getChartAnimationMS()),m.root.dom.classList.toggle(T.mediaChartRendered,!0)}_getMinSeriesValue(e){let i=0;return e.forEach(s=>i=Math.min(s.value,i)),i}async _createColumnChart(e,i,s){const{TooltipAm5:r,ScrollbarAm5:n}=await M(()=>import("./chartCommon-a080f93e.js"),["assets/chartCommon-a080f93e.js","assets/Theme-016ad2b9.js","assets/index-b516d057.js","assets/index-b252abd2.css","assets/Responsive-41bba195.js","assets/Button-d5e3d401.js","assets/Tooltip-3e2bf68f.js","assets/ColorSet-19b07c03.js"]),{CategoryAxisAm5:o,AxisRendererXAm5:l,ValueAxisAm5:p,AxisRendererYAm5:c,ColumnSeriesAm5:h}=await M(()=>import("./xyChart-d504d9ae.js"),["assets/xyChart-d504d9ae.js","assets/LineSeries-edf0978b.js","assets/Theme-016ad2b9.js","assets/index-b516d057.js","assets/index-b252abd2.css","assets/ColorSet-19b07c03.js","assets/DefaultTheme-ef2e8ff5.js","assets/Tick-52f438fc.js","assets/Button-d5e3d401.js"]),{mediaInfo:m,root:f}=i,{value:_,title:g}=m;e.setAll({wheelX:"panX",wheelY:"zoomX"});const y=e.xAxes.push(o.new(f,{renderer:l.new(f,{inversed:this._isInversed()}),categoryField:z}));y.get("renderer").labels.template.setAll({forceHidden:!0});const w=e.yAxes.push(p.new(f,{renderer:c.new(f,{inside:!1}),min:this._getMinSeriesValue(_.series)}));w.get("renderer").labels.template.setAll({direction:this._getDirection()});const v="{categoryX}",F=r.new(f,{labelText:v}),A=e.series.push(h.new(f,{name:g,xAxis:y,yAxis:w,valueYField:te,categoryXField:z,tooltip:F}));this._customizeChartTooltip(F),A.columns.template.setAll({ariaLabel:v,focusable:!0,templateField:"columnSettings"}),_.series.length>Ee&&e.set("scrollbarX",n.new(f,{orientation:"horizontal"})),y.data.setAll(s),A.data.setAll(s),A.appear(this._getChartSeriesAnimationMS()),e.appear(this._getChartAnimationMS())}async _createBarChart(e,i,s){const{TooltipAm5:r,ScrollbarAm5:n}=await M(()=>import("./chartCommon-a080f93e.js"),["assets/chartCommon-a080f93e.js","assets/Theme-016ad2b9.js","assets/index-b516d057.js","assets/index-b252abd2.css","assets/Responsive-41bba195.js","assets/Button-d5e3d401.js","assets/Tooltip-3e2bf68f.js","assets/ColorSet-19b07c03.js"]),{CategoryAxisAm5:o,AxisRendererXAm5:l,ValueAxisAm5:p,AxisRendererYAm5:c,ColumnSeriesAm5:h}=await M(()=>import("./xyChart-d504d9ae.js"),["assets/xyChart-d504d9ae.js","assets/LineSeries-edf0978b.js","assets/Theme-016ad2b9.js","assets/index-b516d057.js","assets/index-b252abd2.css","assets/ColorSet-19b07c03.js","assets/DefaultTheme-ef2e8ff5.js","assets/Tick-52f438fc.js","assets/Button-d5e3d401.js"]),{mediaInfo:m,root:f}=i,{value:_,title:g}=m;e.setAll({wheelX:"panY",wheelY:"zoomY"});const y=e.yAxes.push(o.new(f,{renderer:c.new(f,{inversed:!0}),categoryField:z}));y.get("renderer").labels.template.setAll({forceHidden:!0});const w=e.xAxes.push(p.new(f,{renderer:l.new(f,{inside:!1,inversed:this._isInversed()}),min:this._getMinSeriesValue(_.series)}));w.get("renderer").labels.template.setAll({direction:this._getDirection()});const v="{categoryY}",F=r.new(f,{labelText:v}),A=e.series.push(h.new(f,{name:g,xAxis:w,yAxis:y,valueXField:te,categoryYField:z,tooltip:F}));this._customizeChartTooltip(F,"vertical"),A.columns.template.setAll({ariaLabel:v,focusable:!0,templateField:"columnSettings"}),_.series.length>Ee&&e.set("scrollbarY",n.new(f,{orientation:"vertical"})),y.data.setAll(s),A.data.setAll(s),A.appear(this._getChartSeriesAnimationMS()),e.appear(this._getChartAnimationMS())}async _createLineChart(e,i,s){var K,U,k;const{TooltipAm5:r,ScrollbarAm5:n}=await M(()=>import("./chartCommon-a080f93e.js"),["assets/chartCommon-a080f93e.js","assets/Theme-016ad2b9.js","assets/index-b516d057.js","assets/index-b252abd2.css","assets/Responsive-41bba195.js","assets/Button-d5e3d401.js","assets/Tooltip-3e2bf68f.js","assets/ColorSet-19b07c03.js"]),{CategoryAxisAm5:o,AxisRendererXAm5:l,ValueAxisAm5:p,AxisRendererYAm5:c,LineSeriesAm5:h}=await M(()=>import("./xyChart-d504d9ae.js"),["assets/xyChart-d504d9ae.js","assets/LineSeries-edf0978b.js","assets/Theme-016ad2b9.js","assets/index-b516d057.js","assets/index-b252abd2.css","assets/ColorSet-19b07c03.js","assets/DefaultTheme-ef2e8ff5.js","assets/Tick-52f438fc.js","assets/Button-d5e3d401.js"]),{root:m,mediaInfo:f}=i,{value:_,title:g}=f;e.setAll({wheelX:"panX",wheelY:"zoomX"});const y=e.xAxes.push(o.new(m,{renderer:l.new(m,{inversed:this._isInversed()}),categoryField:z}));y.get("renderer").labels.template.setAll({forceHidden:!0});const w=e.yAxes.push(p.new(m,{renderer:c.new(m,{inside:!1}),min:this._getMinSeriesValue(_.series)}));w.get("renderer").labels.template.setAll({direction:this._getDirection()});const v="{categoryX}",F=(U=(K=s[0])==null?void 0:K.lineSettings)==null?void 0:U.stroke,A=r.new(m,{getFillFromSprite:!F,labelText:v});F&&((k=A.get("background"))==null||k.setAll({fill:F}));const $=e.series.push(h.new(m,{name:g,xAxis:y,yAxis:w,valueYField:te,categoryXField:z,tooltip:A}));$.strokes.template.setAll({templateField:"lineSettings"}),this._customizeChartTooltip(A,"vertical"),_.series.length>Ee&&e.set("scrollbarX",n.new(m,{orientation:"horizontal"})),y.data.setAll(s),$.data.setAll(s),$.appear(this._getChartSeriesAnimationMS()),e.appear(this._getChartAnimationMS())}async _createXYChart(e,i){const{XYChartAm5:s,XYCursorAm5:r}=await M(()=>import("./xyChart-d504d9ae.js"),["assets/xyChart-d504d9ae.js","assets/LineSeries-edf0978b.js","assets/Theme-016ad2b9.js","assets/index-b516d057.js","assets/index-b252abd2.css","assets/ColorSet-19b07c03.js","assets/DefaultTheme-ef2e8ff5.js","assets/Tick-52f438fc.js","assets/Button-d5e3d401.js"]),{root:n,mediaInfo:o}=e,{type:l}=o,p=(o==null?void 0:o.altText)||(o==null?void 0:o.title)||"",c=n.container.children.push(s.new(n,{ariaLabel:p,focusable:!0,panX:!0,panY:!0}));c.set("cursor",r.new(n,{})),l==="column-chart"&&await this._createColumnChart(c,e,i),l==="bar-chart"&&await this._createBarChart(c,e,i),l==="line-chart"&&await this._createLineChart(c,e,i),c.root.dom.classList.toggle(T.mediaChartRendered,!0)}_clearMediaRefreshTimer(){const{_refreshTimer:e}=this;e&&(clearTimeout(e),this._refreshTimer=null)}_updateMediaInfoTimestamp(e){const i=Date.now();this._refreshIntervalInfo={timestamp:i,sourceURL:e&&this._getImageSource(e,i)}}_setupMediaRefreshTimer(){this._clearMediaRefreshTimer();const{activeMediaInfo:e}=this.viewModel;e&&e.type==="image"&&e.refreshInterval&&this._setRefreshTimeout(e)}_setRefreshTimeout(e){const{refreshInterval:i,value:s}=e;if(!i)return;const r=6e4*i;this._updateMediaInfoTimestamp(s.sourceURL);const n=setInterval(()=>{this._updateMediaInfoTimestamp(s.sourceURL)},r);this._refreshTimer=n}_getImageSource(e,i){const s=e.includes("?")?"&":"?",[r,n=""]=e.split("#");return`${r}${s}timestamp=${i}${n?"#":""}${n}`}};a([d()],R.prototype,"_refreshIntervalInfo",void 0),a([d()],R.prototype,"attributes",null),a([d()],R.prototype,"activeMediaInfoIndex",null),a([d()],R.prototype,"description",null),a([d()],R.prototype,"fieldInfoMap",null),a([d()],R.prototype,"layer",null),a([d()],R.prototype,"mediaInfos",null),a([d()],R.prototype,"popupTemplate",null),a([d()],R.prototype,"relatedInfos",null),a([d()],R.prototype,"title",null),a([d({type:Q})],R.prototype,"viewModel",void 0),a([d(),j("esri/widgets/Feature/t9n/Feature")],R.prototype,"messages",void 0),R=a([V("esri.widgets.Feature.FeatureMedia")],R);const ft=R,Mi=["$datastore","$map","$layer","$aggregatedfeatures"],Ai="esri.widgets.Feature.support.arcadeFeatureUtils",Ci=Ve.getLogger(Ai);function xi(t){return typeof t=="string"?Ne(De(t)):Array.isArray(t)?Fi(t):(t==null?void 0:t.declaredClass)==="esri.arcade.Dictionary"?Ei(t):t}function Fi(t){return`<ul class="esri-widget__list">${t.map(e=>`<li>${typeof e=="string"?Ne(De(e)):e}</li>`).join("")}</ul>`}function Ei(t){return`<table class="esri-widget__table">${t.keys().map(e=>{const i=t.field(e);return`<tr><th>${e}</th><td>${typeof i=="string"?Ne(De(i)):i}</td></tr>`}).join("")}</table>`}function $i({aggregatedFeatures:t,arcadeUtils:e,featureSetVars:i,context:s,viewInfo:r,map:n,graphic:o,interceptor:l}){i.forEach(p=>{const c=p.toLowerCase(),h=r.sr,m={map:n,spatialReference:h,interceptor:l};if(c==="$map"&&(s.vars[c]=e.convertMapToFeatureSetCollection(m)),c==="$layer"&&(s.vars[c]=e.convertFeatureLayerToFeatureSet({layer:o.sourceLayer,spatialReference:h,interceptor:l})),c==="$datastore"&&(s.vars[c]=e.convertServiceUrlToWorkspace({url:o.sourceLayer.url,spatialReference:h,interceptor:l})),c==="$aggregatedfeatures"){const f=o.layer,{fields:_,objectIdField:g,geometryType:y,spatialReference:w,displayField:v}=f,F=new Gt({fields:_,objectIdField:g,geometryType:y,spatialReference:w,displayField:v,...f.type==="feature"?{templates:f.templates,typeIdField:f.typeIdField,types:f.types}:null,source:t});s.vars[c]=e.convertFeatureLayerToFeatureSet({layer:F,spatialReference:w,interceptor:l})}})}function _t(){return M(()=>import("./arcadeUtils-b244a3e5.js").then(t=>t.aC),["assets/arcadeUtils-b244a3e5.js","assets/index-b516d057.js","assets/index-b252abd2.css","assets/TimeOnly-879c5107.js","assets/UnknownTimeZone-a05df022.js","assets/ImmutableArray-ee1d0ce7.js","assets/number-2ab18aee.js","assets/featureConversionUtils-09cf00ff.js","assets/OptimizedFeature-e90b69df.js","assets/OptimizedFeatureSet-1d1ac4b9.js","assets/OptimizedGeometry-196224d4.js","assets/FieldsIndex-e8db657f.js","assets/hash-6f442295.js"])}function Ti(t){return"createQuery"in t&&"queryFeatures"in t}async function Ri({graphic:t,view:e}){const{isAggregate:i,layer:s}=t;if(!i||!s||(e==null?void 0:e.type)!=="2d")return[];const r=await e.whenLayerView(s);if(!Ti(r))return[];const n=r.createQuery(),o=t.getObjectId();n.aggregateIds=o!=null?[o]:[];const{features:l}=await r.queryFeatures(n);return l}async function gt({expressionInfo:t,arcadeUtils:e,interceptor:i,spatialReference:s,map:r,graphic:n,view:o}){if(!(t!=null&&t.expression))return null;const l=e.createSyntaxTree(t.expression),p=Mi.filter(_=>e.hasVariable(l,_)),[c]=await Promise.all([Ri({graphic:n,view:o}),e.loadScriptDependencies(l,!0,p)]),h=e.getViewInfo({spatialReference:s}),m=e.createExecContext(n,h,o==null?void 0:o.timeZone);m.interceptor=i,m.useAsync=!0,$i({aggregatedFeatures:c,arcadeUtils:e,featureSetVars:p,context:m,viewInfo:h,map:r,graphic:n,interceptor:i});const f=e.createFunction(l,m);return e.executeAsyncFunction(f,m).catch(_=>Ci.error("arcade-execution-error",{error:_,graphic:n,expressionInfo:t}))}async function Li({expressionInfos:t,spatialReference:e,graphic:i,interceptor:s,map:r,view:n}){if(!(t!=null&&t.length))return{};const o=await _t(),l={};for(const h of t)l[`expression/${h.name}`]=gt({expressionInfo:h,arcadeUtils:o,interceptor:s,spatialReference:e,map:r,graphic:i,view:n});const p=await J(l),c={};for(const h in p)c[h]=xi(p[h].value);return c}const Si=1;let P=class extends oe{constructor(e){super(e),this._abortController=null,this.expressionInfo=null,this.graphic=null,this.contentElement=null,this.contentElementViewModel=null,this.interceptor=null,this.view=null,this._cancelQuery=()=>{const{_abortController:i}=this;i&&i.abort(),this._abortController=null},this._createVM=()=>{var r,n;const i=(r=this.contentElement)==null?void 0:r.type;(n=this.contentElementViewModel)==null||n.destroy();const s=i==="fields"?new ye:i==="media"?new Q:i==="text"?new fe:null;this._set("contentElementViewModel",s)},this._compile=async()=>{this._cancelQuery();const i=new AbortController;this._abortController=i,await this._compileExpression(),this._abortController===i&&(this._abortController=null)},this._compileThrottled=ht(this._compile,Si,this),this._compileExpression=async()=>{const{expressionInfo:i,graphic:s,interceptor:r,spatialReference:n,map:o,view:l,_abortController:p}=this;if(!(i&&s&&n&&o))return void this._set("contentElement",null);const c=await _t();if(p!==this._abortController)return;const h=await gt({arcadeUtils:c,expressionInfo:i,graphic:s,interceptor:r,map:o,spatialReference:n,view:l});if(!h||h.declaredClass!=="esri.arcade.Dictionary")return void this._set("contentElement",null);const m=await h.castAsJsonAsync(p==null?void 0:p.signal),f=m==null?void 0:m.type,_=f==="media"?$t.fromJSON(m):f==="text"?at.fromJSON(m):f==="fields"?Tt.fromJSON(m):null;this._set("contentElement",_)},this.addHandles([S(()=>[this.expressionInfo,this.graphic,this.map,this.spatialReference,this.view],()=>this._compileThrottled(),O),S(()=>[this.contentElement],()=>this._createVM(),O)])}initialize(){this.addHandles(this._compileThrottled)}destroy(){var e;this._cancelQuery(),(e=this.contentElementViewModel)==null||e.destroy(),this._set("contentElementViewModel",null),this._set("contentElement",null)}get spatialReference(){var e;return((e=this.view)==null?void 0:e.spatialReference)??null}set spatialReference(e){this._override("spatialReference",e)}get state(){const{_abortController:e,contentElement:i,contentElementViewModel:s}=this;return e?"loading":i||s?"ready":"disabled"}get map(){var e;return((e=this.view)==null?void 0:e.map)??null}set map(e){this._override("map",e)}};a([d()],P.prototype,"_abortController",void 0),a([d({type:Et})],P.prototype,"expressionInfo",void 0),a([d({type:Se})],P.prototype,"graphic",void 0),a([d({readOnly:!0})],P.prototype,"contentElement",void 0),a([d({readOnly:!0})],P.prototype,"contentElementViewModel",void 0),a([d()],P.prototype,"interceptor",void 0),a([d()],P.prototype,"spatialReference",null),a([d({readOnly:!0})],P.prototype,"state",null),a([d()],P.prototype,"map",null),a([d()],P.prototype,"view",void 0),P=a([V("esri.widgets.Feature.FeatureExpression.FeatureExpressionViewModel")],P);const Ue=P,$e="esri-feature",Te={base:`${$e}-expression`,loadingSpinnerContainer:`${$e}__loading-container`,spinner:`${$e}__loading-spinner`};let ue=class extends X{constructor(t,e){super(t,e),this._contentWidget=null,this.viewModel=new Ue}initialize(){this.addHandles(S(()=>{var t;return(t=this.viewModel)==null?void 0:t.contentElementViewModel},()=>this._setupExpressionWidget(),O))}destroy(){this._destroyContentWidget()}render(){var e;const{state:t}=this.viewModel;return u("div",{class:Te.base},t==="loading"?this._renderLoading():t==="disabled"?null:(e=this._contentWidget)==null?void 0:e.render())}_renderLoading(){return u("div",{class:Te.loadingSpinnerContainer,key:"loading-container"},u("span",{class:this.classes(ke.loadingIndicator,ee.rotating,Te.spinner)}))}_destroyContentWidget(){const{_contentWidget:t}=this;t&&(t.viewModel=null,t.destroy()),this._contentWidget=null}_setupExpressionWidget(){const{contentElementViewModel:t,contentElement:e}=this.viewModel,i=e==null?void 0:e.type;this._destroyContentWidget();const s=t?i==="fields"?new mt({viewModel:t}):i==="media"?new ft({viewModel:t}):i==="text"?new ce({viewModel:t}):null:null;this._contentWidget=s,this.scheduleRender()}};a([d({type:Ue})],ue.prototype,"viewModel",void 0),ue=a([V("esri.widgets.Feature.FeatureExpression")],ue);const Vi=ue,re="esri-feature",ie=`${re}-relationship`,W={base:ie,listContainer:`${ie}__list`,listItem:`${ie}__list-item`,listItemHidden:`${ie}__list-item--hidden`,listContainerQuerying:`${ie}__list--querying`,featureObserver:`${re}__feature-observer`,stickySpinnerContainer:`${re}__sticky-loading-container`,loadingSpinnerContainer:`${re}__loading-container`,spinner:`${re}__loading-spinner`},Ke={title:!0,description:!0};let L=class extends X{constructor(t,e){super(t,e),this._featureElementInfo=null,this._relatedFeatureIntersectionObserverNode=null,this._relatedFeatureIntersectionObserver=new IntersectionObserver(([i])=>{i!=null&&i.isIntersecting&&this._increaseFeaturePage()},{root:window.document}),this.headingLevel=2,this.viewModel=new We,this.messages=null,this.messagesCommon=null,this.visibleElements={...Ke},this._increaseFeaturePage=()=>{const{state:i,showAllEnabled:s,relatedFeatures:r,featuresPerPage:n,featurePage:o}=this.viewModel;i==="ready"&&s&&r.length>=n*o&&this.viewModel.featurePage++}}initialize(){this._featureElementInfo=new ge,this.addHandles([S(()=>[this.viewModel.description,this.viewModel.title,this.headingLevel],()=>this._setupFeatureElementInfo(),O),S(()=>[this.viewModel.state,this.viewModel.showAllEnabled,this._relatedFeatureIntersectionObserverNode],()=>this._handleRelatedFeatureObserverChange()),he(()=>this.viewModel.relatedFeatureViewModels,"change",()=>this._setupRelatedFeatureViewModels())])}loadDependencies(){return Pe({icon:()=>M(()=>import("./calcite-icon-39deb8ae.js"),["assets/calcite-icon-39deb8ae.js","assets/icon-c122f720.js","assets/jsxFactory-92036771.js","assets/index-b516d057.js","assets/index-b252abd2.css","assets/uuid-709b6c67.js","assets/observers-9c654f26.js"]),list:()=>M(()=>import("./calcite-list-2b87684c.js"),["assets/calcite-list-2b87684c.js","assets/jsxFactory-92036771.js","assets/index-b516d057.js","assets/index-b252abd2.css","assets/uuid-709b6c67.js","assets/interactive-39956fb6.js","assets/observers-9c654f26.js","assets/utils3-c1eb0197.js","assets/loadable-7d42c3de.js","assets/filter2-4b1b51ca.js","assets/debounce-7cc294e2.js","assets/locale-2cb18332.js","assets/key-c2c83cc7.js","assets/t9n-622f279b.js","assets/icon-c122f720.js","assets/input-9795a695.js","assets/form-60623048.js","assets/label2-0071fcd4.js","assets/component-7281ffa6.js","assets/progress-2100df13.js","assets/loader-ea663d25.js","assets/guid-2347ca41.js","assets/scrim-41a5f26e.js"]),"list-item":()=>M(()=>import("./calcite-list-item-acd56289.js"),["assets/calcite-list-item-acd56289.js","assets/jsxFactory-92036771.js","assets/index-b516d057.js","assets/index-b252abd2.css","assets/uuid-709b6c67.js","assets/interactive-39956fb6.js","assets/utils3-c1eb0197.js","assets/locale-2cb18332.js","assets/key-c2c83cc7.js","assets/observers-9c654f26.js","assets/t9n-622f279b.js","assets/loadable-7d42c3de.js","assets/action-79a6733c.js","assets/guid-2347ca41.js","assets/component-7281ffa6.js","assets/icon-c122f720.js","assets/loader-ea663d25.js","assets/handle-d29406b2.js"]),notice:()=>M(()=>import("./calcite-notice-ae448cb5.js"),["assets/calcite-notice-ae448cb5.js","assets/jsxFactory-92036771.js","assets/index-b516d057.js","assets/index-b252abd2.css","assets/uuid-709b6c67.js","assets/conditionalSlot-11b5e54d.js","assets/observers-9c654f26.js","assets/loadable-7d42c3de.js","assets/locale-2cb18332.js","assets/key-c2c83cc7.js","assets/t9n-622f279b.js","assets/openCloseComponent-3fbda1cf.js","assets/component-7281ffa6.js","assets/icon-c122f720.js"])})}destroy(){this._unobserveRelatedFeatureObserver(),this._featureElementInfo=Rt(this._featureElementInfo)}get displayShowAllButton(){const{showAllEnabled:t,featureCount:e,displayCount:i,state:s}=this.viewModel;return!t&&!!e&&s==="ready"&&(e>i||i===0)}get displayListItems(){return this.displayShowAllButton||this.viewModel.relatedFeatureViewModels.length>0}get description(){return this.viewModel.description}set description(t){this.viewModel.description=t}get featureCountDescription(){const{messages:t}=this,{featureCount:e}=this.viewModel;return Oe(t==null?void 0:t.numberRecords,{number:e})}get title(){return this.viewModel.title}set title(t){this.viewModel.title=t}castVisibleElements(t){return{...Ke,...t}}render(){var e;const{state:t}=this.viewModel;return u("div",{class:this.classes(W.base,ee.widget)},(e=this._featureElementInfo)==null?void 0:e.render(),t==="loading"?this._renderLoading():t==="disabled"?this._renderRelationshipNotFound():this._renderRelatedFeatures())}_renderStickyLoading(){return this.viewModel.state==="querying"?u("div",{class:W.stickySpinnerContainer,key:"sticky-loader"},this._renderLoadingIcon()):null}_renderLoadingIcon(){return u("span",{class:this.classes(ke.loadingIndicator,ee.rotating,W.spinner)})}_renderLoading(){return u("div",{class:W.loadingSpinnerContainer,key:"loading-container"},this._renderLoadingIcon())}_renderShowAllIconNode(){return u("calcite-icon",{icon:"list",scale:"s",slot:"content-end"})}_renderChevronIconNode(){const t=Re(this.container)?"chevron-left":"chevron-right";return u("calcite-icon",{icon:t,scale:"s",slot:"content-end"})}_renderRelatedFeature(t){var r;const{itemDescriptionFieldName:e}=this.viewModel,i=t.title;t.description=e&&((r=t.formattedAttributes)==null?void 0:r.global[e]);const s=t.state==="loading";return u("calcite-list-item",{class:this.classes(W.listItem,{[W.listItemHidden]:s}),description:t.description??"",key:t.uid,label:i,onCalciteListItemSelect:()=>this.emit("select-record",{featureViewModel:t})},this._renderChevronIconNode())}_renderShowAllListItem(){var t;return this.displayShowAllButton?u("calcite-list-item",{description:this.featureCountDescription,key:"show-all-item",label:(t=this.messages)==null?void 0:t.showAll,onCalciteListItemSelect:()=>this.emit("show-all-records")},this._renderShowAllIconNode()):null}_renderNoRelatedFeaturesMessage(){var t;return u("calcite-notice",{icon:"information",key:"no-related-features-message",kind:"brand",open:!0,scale:"s",width:"full"},u("div",{slot:"message"},(t=this.messages)==null?void 0:t.noRelatedFeatures))}_renderFeatureObserver(){return u("div",{afterCreate:this._relatedFeatureIntersectionObserverCreated,bind:this,class:W.featureObserver,key:"feature-observer"})}_renderList(){const{relatedFeatureViewModels:t}=this.viewModel;return u("calcite-list",null,t.toArray().map(e=>this._renderRelatedFeature(e)),this._renderShowAllListItem())}_renderRelatedFeatures(){const{displayListItems:t}=this,{state:e}=this.viewModel;return u("div",{class:this.classes(W.listContainer,{[W.listContainerQuerying]:e==="querying"}),key:"list-container"},t?this._renderList():e==="ready"?this._renderNoRelatedFeaturesMessage():null,this._renderStickyLoading(),this._renderFeatureObserver())}_renderRelationshipNotFound(){var t;return u("calcite-notice",{icon:"exclamation-mark-triangle",key:"relationship-not-found",kind:"danger",open:!0,scale:"s",width:"full"},u("div",{slot:"message"},(t=this.messages)==null?void 0:t.relationshipNotFound))}_setupRelatedFeatureViewModels(){const{relatedFeatureViewModels:t}=this.viewModel,e="related-feature-viewmodels";this.removeHandles(e),t==null||t.forEach(i=>{this.addHandles(S(()=>[i.title,i.state],()=>this.scheduleRender(),O),e)}),this.scheduleRender()}_setupFeatureElementInfo(){var r;const{headingLevel:t,visibleElements:e}=this,i=e.description&&this.description,s=e.title&&this.title;(r=this._featureElementInfo)==null||r.set({description:i,title:s,headingLevel:t})}async _handleRelatedFeatureObserverChange(){this._unobserveRelatedFeatureObserver();const{state:t,showAllEnabled:e}=this.viewModel;await Lt(0),this._relatedFeatureIntersectionObserverNode&&t==="ready"&&e&&this._relatedFeatureIntersectionObserver.observe(this._relatedFeatureIntersectionObserverNode)}_relatedFeatureIntersectionObserverCreated(t){this._relatedFeatureIntersectionObserverNode=t}_unobserveRelatedFeatureObserver(){this._relatedFeatureIntersectionObserverNode&&this._relatedFeatureIntersectionObserver.unobserve(this._relatedFeatureIntersectionObserverNode)}};a([d()],L.prototype,"_relatedFeatureIntersectionObserverNode",void 0),a([d({readOnly:!0})],L.prototype,"displayShowAllButton",null),a([d({readOnly:!0})],L.prototype,"displayListItems",null),a([d()],L.prototype,"description",null),a([d({readOnly:!0})],L.prototype,"featureCountDescription",null),a([d()],L.prototype,"headingLevel",void 0),a([d()],L.prototype,"title",null),a([d({type:We})],L.prototype,"viewModel",void 0),a([d(),j("esri/widgets/Feature/t9n/Feature")],L.prototype,"messages",void 0),a([d(),j("esri/t9n/common")],L.prototype,"messagesCommon",void 0),a([d()],L.prototype,"visibleElements",void 0),a([_e("visibleElements")],L.prototype,"castVisibleElements",null),L=a([V("esri.widgets.Feature.FeatureRelationship")],L);const Ze=L;class Oi{constructor(e,i){this.preLayerQueryCallback=e,this.preRequestCallback=i,this.preLayerQueryCallback||(this.preLayerQueryCallback=s=>{}),this.preRequestCallback||(this.preLayerQueryCallback=s=>{})}}var ne;const Pi=1,Ge="content-view-models",et="relationship-view-models",tt={attachmentsContent:!0,chartAnimation:!0,customContent:!0,expressionContent:!0,fieldsContent:!0,mediaContent:!0,textContent:!0,relationshipContent:!0};let I=ne=class extends St(oe){constructor(t){super(t),this._error=null,this._featureAbortController=null,this._graphicChangedThrottled=ht(this._graphicChanged,Pi,this),this._expressionAttributes=null,this._graphicExpressionAttributes=null,this.abilities={...tt},this.content=null,this.contentViewModels=[],this.description=null,this.defaultPopupTemplateEnabled=!1,this.formattedAttributes=null,this.lastEditInfo=null,this.relatedInfos=new Map,this.title="",this.view=null,this._isAllowedContentType=e=>{const{abilities:i}=this;return e.type==="attachments"&&!!i.attachmentsContent||e.type==="custom"&&!!i.customContent||e.type==="fields"&&!!i.fieldsContent||e.type==="media"&&!!i.mediaContent||e.type==="text"&&!!i.textContent||e.type==="expression"&&!!i.expressionContent||e.type==="relationship"&&!!i.relationshipContent},this.addHandles(S(()=>[this.graphic,this._effectivePopupTemplate,this.abilities],()=>this._graphicChangedThrottled(),O))}initialize(){this.addHandles(this._graphicChangedThrottled)}destroy(){this._clear(),this._cancelFeatureQuery(),this._error=null,this.graphic=null,this._destroyContentViewModels(),this.relatedInfos.clear()}get _effectivePopupTemplate(){return this.graphic!=null?this.graphic.getEffectivePopupTemplate(this.defaultPopupTemplateEnabled):null}get _fieldInfoMap(){return Dt(Be(this._effectivePopupTemplate),this._sourceLayer)}get _sourceLayer(){return Wt(this.graphic)}castAbilities(t){return{...tt,...t}}get isTable(){var t;return((t=this._sourceLayer)==null?void 0:t.isTable)||!1}get state(){return this.graphic?this._error?"error":this.waitingForContent?"loading":"ready":"disabled"}set graphic(t){this._set("graphic",t?t.clone():null)}get spatialReference(){var t;return((t=this.view)==null?void 0:t.spatialReference)??null}set spatialReference(t){this._override("spatialReference",t)}get map(){var t;return((t=this.view)==null?void 0:t.map)||null}set map(t){this._override("map",t)}get waitingForContent(){return!!this._featureAbortController}setActiveMedia(t,e){const i=this.contentViewModels[t];i instanceof Q&&i.setActiveMedia(e)}nextMedia(t){const e=this.contentViewModels[t];e instanceof Q&&e.next()}previousMedia(t){const e=this.contentViewModels[t];e instanceof Q&&e.previous()}async updateGeometry(){var o;const{graphic:t,spatialReference:e,_sourceLayer:i}=this;await(i==null?void 0:i.load());const s=i==null?void 0:i.objectIdField;if(!s||!t||!i)return;const r=(o=t==null?void 0:t.attributes)==null?void 0:o[s];if(r==null)return;const n=[r];if(!t.geometry){const l=await Ht({layer:i,graphic:t,outFields:[],objectIds:n,returnGeometry:!0,spatialReference:e}),p=l==null?void 0:l.geometry;p&&(t.geometry=p)}}_clear(){this._set("title",""),this._set("content",null),this._set("formattedAttributes",null)}async _graphicChanged(){this._cancelFeatureQuery(),this._error=null,this._clear();const{graphic:t}=this;if(!t)return;const e=new AbortController;this._featureAbortController=e;try{await this._queryFeature({signal:e.signal})}catch(i){Vt(i)||(this._error=i,Ve.getLogger(this).error("error","The popupTemplate could not be displayed for this feature.",{error:i,graphic:t,popupTemplate:this._effectivePopupTemplate}))}this._featureAbortController===e&&(this._featureAbortController=null)}_cancelFeatureQuery(){const{_featureAbortController:t}=this;t&&t.abort(),this._featureAbortController=null}_compileContentElement(t,e){return t.type==="attachments"?this._compileAttachments(t,e):t.type==="custom"?this._compileCustom(t,e):t.type==="fields"?this._compileFields(t,e):t.type==="media"?this._compileMedia(t,e):t.type==="text"?this._compileText(t,e):t.type==="expression"?this._compileExpression(t,e):t.type==="relationship"?this._compileRelationship(t,e):void 0}_compileContent(t){if(this._destroyContentViewModels(),this.graphic)return Array.isArray(t)?t.filter(this._isAllowedContentType).map((e,i)=>this._compileContentElement(e,i)).filter(ot):typeof t=="string"?this._compileText(new at({text:t}),0).text:t}_destroyContentViewModels(){this.removeHandles(et),this.removeHandles(Ge),this.contentViewModels.forEach(t=>t&&!t.destroyed&&t.destroy()),this._set("contentViewModels",[])}_matchesFeature(t,e){var r;const i=(r=t==null?void 0:t.graphic)==null?void 0:r.getObjectId(),s=e==null?void 0:e.getObjectId();return i!=null&&s!=null&&i===s}_setRelatedFeaturesViewModels({relatedFeatureViewModels:t,relatedFeatures:e,map:i}){const{view:s,spatialReference:r}=this;e==null||e.filter(Boolean).forEach(n=>{t.find(o=>this._matchesFeature(o,n))||t.add(new ne({abilities:{relationshipContent:!1},map:i,view:s,spatialReference:r,graphic:n}))}),t.forEach(n=>{(e==null?void 0:e.find(l=>this._matchesFeature(n,l)))||t.remove(n)})}_setExpressionContentVM(t,e){const i=this.formattedAttributes,{contentElement:s,contentElementViewModel:r}=t,n=s==null?void 0:s.type;r&&n&&(n==="fields"&&(this._createFieldsFormattedAttributes({contentElement:s,contentElementIndex:e,formattedAttributes:i}),r.set(this._createFieldsVMParams(s,e))),n==="media"&&(this._createMediaFormattedAttributes({contentElement:s,contentElementIndex:e,formattedAttributes:i}),r.set(this._createMediaVMParams(s,e))),n==="text"&&r.set(this._createTextVMParams(s)))}_compileRelationship(t,e){const{displayCount:i,orderByFields:s,relationshipId:r,title:n,description:o}=t,{_sourceLayer:l,graphic:p,map:c}=this;if(!Ut(l))return;const h=new We({displayCount:i,graphic:p,orderByFields:s,relationshipId:r,layer:l,map:c,...this._compileTitleAndDesc({title:n,description:o})});return this.contentViewModels[e]=h,this.addHandles(he(()=>h.relatedFeatures,"change",()=>this._setRelatedFeaturesViewModels(h)),et),t}_compileExpression(t,e){const{expressionInfo:i}=t,{graphic:s,map:r,spatialReference:n,view:o}=this,l=new Ue({expressionInfo:i,graphic:s,interceptor:ne.interceptor,map:r,spatialReference:n,view:o});return this.contentViewModels[e]=l,this.addHandles(S(()=>l.contentElementViewModel,()=>this._setExpressionContentVM(l,e),O),Ge),t}_compileAttachments(t,e){const{graphic:i}=this,{description:s,title:r}=t;return this.contentViewModels[e]=new He({graphic:i,...this._compileTitleAndDesc({title:r,description:s})}),t}_compileCustom(t,e){const{graphic:i}=this,{creator:s,destroyer:r}=t;return this.contentViewModels[e]=new fe({graphic:i,creator:s,destroyer:r}),t}_compileTitleAndDesc({title:t,description:e}){const{_fieldInfoMap:i,_sourceLayer:s,graphic:r,formattedAttributes:n}=this,o=r==null?void 0:r.attributes,l=this._expressionAttributes,p=n.global;return{title:Y({attributes:o,fieldInfoMap:i,globalAttributes:p,expressionAttributes:l,layer:s,text:t}),description:Y({attributes:o,fieldInfoMap:i,globalAttributes:p,expressionAttributes:l,layer:s,text:e})}}_createFieldsVMParams(t,e){const i=this._effectivePopupTemplate,s=this.formattedAttributes,r={...s==null?void 0:s.global,...s==null?void 0:s.content[e]},n=(t==null?void 0:t.fieldInfos)||(i==null?void 0:i.fieldInfos),o=n==null?void 0:n.filter(({fieldName:h})=>pt(h)||B(h)||r.hasOwnProperty(h)),l=i==null?void 0:i.expressionInfos,{description:p,title:c}=t;return{attributes:r,expressionInfos:l,fieldInfos:o,...this._compileTitleAndDesc({title:c,description:p})}}_compileFields(t,e){const i=t.clone(),s=new ye(this._createFieldsVMParams(t,e));return this.contentViewModels[e]=s,i.fieldInfos=s.formattedFieldInfos.slice(0),i}_createMediaVMParams(t,e){const{abilities:i,graphic:s,_fieldInfoMap:r,_effectivePopupTemplate:n,relatedInfos:o,_sourceLayer:l,_expressionAttributes:p}=this,c=this.formattedAttributes,h=(s==null?void 0:s.attributes)??{},{description:m,mediaInfos:f,title:_}=t;return{abilities:{chartAnimation:i.chartAnimation},activeMediaInfoIndex:t.activeMediaInfoIndex||0,attributes:h,isAggregate:s==null?void 0:s.isAggregate,layer:l,fieldInfoMap:r,formattedAttributes:{...c==null?void 0:c.global,...c==null?void 0:c.content[e]},expressionAttributes:p,mediaInfos:f,popupTemplate:n,relatedInfos:o,...this._compileTitleAndDesc({title:_,description:m})}}_compileMedia(t,e){const i=t.clone(),s=new Q(this._createMediaVMParams(t,e));return i.mediaInfos=s.formattedMediaInfos.slice(0),this.contentViewModels[e]=s,i}_createTextVMParams(t){var n;const{graphic:e,_fieldInfoMap:i,_sourceLayer:s,_expressionAttributes:r}=this;if(t&&t.text){const o=(e==null?void 0:e.attributes)??{},l=((n=this.formattedAttributes)==null?void 0:n.global)??{};t.text=Y({attributes:o,fieldInfoMap:i,globalAttributes:l,expressionAttributes:r,layer:s,text:t.text})}return{graphic:e,creator:t.text}}_compileText(t,e){const i=t.clone();return this.contentViewModels[e]=new fe(this._createTextVMParams(i)),i}_compileLastEditInfo(){const{_effectivePopupTemplate:t,_sourceLayer:e,graphic:i,view:s}=this;if(!t)return;const{lastEditInfoEnabled:r}=t,n=e==null?void 0:e.editFieldsInfo;return r&&n?zt(n,i==null?void 0:i.attributes,(s==null?void 0:s.timeZone)??ae,e):void 0}_compileTitle(t){var l;const{_fieldInfoMap:e,_sourceLayer:i,graphic:s,_expressionAttributes:r}=this,n=(s==null?void 0:s.attributes)??{},o=((l=this.formattedAttributes)==null?void 0:l.global)??{};return Y({attributes:n,fieldInfoMap:e,globalAttributes:o,expressionAttributes:r,layer:i,text:t})}async _getTitle(){const{_effectivePopupTemplate:t,graphic:e}=this;if(!e)return null;const i=t==null?void 0:t.title;return me(i,{graphic:e})}async _getContent(){const{_effectivePopupTemplate:t,graphic:e}=this;if(!e)return null;const i=t==null?void 0:t.content;return me(i,{graphic:e})}async _queryFeature(t){const{_featureAbortController:e,_sourceLayer:i,graphic:s,_effectivePopupTemplate:r}=this,n=this.map,o=this.view,l=this.spatialReference;if(e!==this._featureAbortController||!s)return;await qt({graphic:s,popupTemplate:r,layer:i,spatialReference:l},t);const{content:{value:p},title:{value:c}}=await J({content:this._getContent(),title:this._getTitle()}),{expressionAttributes:{value:h}}=await J({checkForRelatedFeatures:this._checkForRelatedFeatures(t),expressionAttributes:Li({expressionInfos:r==null?void 0:r.expressionInfos,spatialReference:l,graphic:s,map:n,interceptor:ne.interceptor,view:o})});e===this._featureAbortController&&s&&(this._expressionAttributes=h,this._graphicExpressionAttributes={...s.attributes,...h},this._set("formattedAttributes",this._createFormattedAttributes(p)),this._set("title",this._compileTitle(c)),this._set("lastEditInfo",this._compileLastEditInfo()||null),this._set("content",this._compileContent(p)||null))}_createMediaFormattedAttributes({contentElement:t,contentElementIndex:e,formattedAttributes:i}){var c;const{_effectivePopupTemplate:s,graphic:r,relatedInfos:n,_sourceLayer:o,_fieldInfoMap:l,_graphicExpressionAttributes:p}=this;i.content[e]=Ie({fieldInfos:s==null?void 0:s.fieldInfos,graphic:r,attributes:{...p,...t.attributes},layer:o,fieldInfoMap:l,relatedInfos:n,timeZone:((c=this.view)==null?void 0:c.timeZone)??ae})}_createFieldsFormattedAttributes({contentElement:t,contentElementIndex:e,formattedAttributes:i}){var s;if(t.fieldInfos){const{graphic:r,relatedInfos:n,_sourceLayer:o,_fieldInfoMap:l,_graphicExpressionAttributes:p}=this;i.content[e]=Ie({fieldInfos:t.fieldInfos,graphic:r,attributes:{...p,...t.attributes},layer:o,fieldInfoMap:l,relatedInfos:n,timeZone:((s=this.view)==null?void 0:s.timeZone)??ae})}}_createFormattedAttributes(t){var c;const{_effectivePopupTemplate:e,graphic:i,relatedInfos:s,_sourceLayer:r,_fieldInfoMap:n,_graphicExpressionAttributes:o}=this,l=e==null?void 0:e.fieldInfos,p={global:Ie({fieldInfos:l,graphic:i,attributes:o,layer:r,fieldInfoMap:n,relatedInfos:s,timeZone:((c=this.view)==null?void 0:c.timeZone)??ae}),content:[]};return Array.isArray(t)&&t.forEach((h,m)=>{h.type==="fields"&&this._createFieldsFormattedAttributes({contentElement:h,contentElementIndex:m,formattedAttributes:p}),h.type==="media"&&this._createMediaFormattedAttributes({contentElement:h,contentElementIndex:m,formattedAttributes:p})}),p}_checkForRelatedFeatures(t){const{graphic:e,_effectivePopupTemplate:i}=this;return this._queryRelatedInfos(e,Be(i),t)}async _queryRelatedInfos(t,e,i){const{relatedInfos:s,_sourceLayer:r}=this;s.clear();const n=(r==null?void 0:r.associatedLayer)!=null?await(r==null?void 0:r.associatedLayer.load(i)):r;if(!n||!t)return;const o=e.filter(c=>c&&B(c.fieldName));if(!(o!=null&&o.length))return;e.forEach(c=>this._configureRelatedInfo(c,n));const l=await fi({relatedInfos:s,layer:n},i);Object.keys(l).forEach(c=>{var f;const h=s.get(c.toString()),m=(f=l[c])==null?void 0:f.value;h&&m&&(h.layerInfo=m.data)});const p=await _i({graphic:t,relatedInfos:s,layer:n},i);Object.keys(p).forEach(c=>{var h;li((h=p[c])==null?void 0:h.value,s.get(c.toString()))})}_configureRelatedInfo(t,e){const{relatedInfos:i}=this,s=pe(t.fieldName);if(!s)return;const{layerId:r,fieldName:n}=s;if(!r)return;const o=i.get(r.toString())||ai(r,e);o&&(gi({relatedInfo:o,fieldName:n,fieldInfo:t}),this.relatedInfos.set(r,o))}};I.interceptor=new Oi(jt,Xt),a([d()],I.prototype,"_error",void 0),a([d()],I.prototype,"_featureAbortController",void 0),a([d({readOnly:!0})],I.prototype,"_effectivePopupTemplate",null),a([d({readOnly:!0})],I.prototype,"_fieldInfoMap",null),a([d({readOnly:!0})],I.prototype,"_sourceLayer",null),a([d()],I.prototype,"abilities",void 0),a([_e("abilities")],I.prototype,"castAbilities",null),a([d({readOnly:!0})],I.prototype,"content",void 0),a([d({readOnly:!0})],I.prototype,"contentViewModels",void 0),a([d()],I.prototype,"description",void 0),a([d({type:Boolean})],I.prototype,"defaultPopupTemplateEnabled",void 0),a([d({readOnly:!0})],I.prototype,"isTable",null),a([d({readOnly:!0})],I.prototype,"state",null),a([d({readOnly:!0})],I.prototype,"formattedAttributes",void 0),a([d({type:Se,value:null})],I.prototype,"graphic",null),a([d({readOnly:!0})],I.prototype,"lastEditInfo",void 0),a([d({readOnly:!0})],I.prototype,"relatedInfos",void 0),a([d()],I.prototype,"spatialReference",null),a([d({readOnly:!0})],I.prototype,"title",void 0),a([d()],I.prototype,"map",null),a([d({readOnly:!0})],I.prototype,"waitingForContent",null),a([d()],I.prototype,"view",void 0),I=ne=a([V("esri.widgets.FeatureViewModel")],I);const yt=I,ki=t=>{let e=class extends t{constructor(){super(...arguments),this.renderNodeContent=i=>ut(i)&&!i.destroyed?u("div",{class:b.contentNode,key:i},i.render()):i instanceof HTMLElement?u("div",{afterCreate:this._attachToNode,bind:i,class:b.contentNode,key:i}):Bt(i)?u("div",{afterCreate:this._attachToNode,bind:i.domNode,class:b.contentNode,key:i}):null}_attachToNode(i){const s=this;i.appendChild(s)}};return e=a([V("esri.widgets.Feature.ContentMixin")],e),e};var Le;const it={title:!0,content:!0,lastEditedInfo:!0},st="relationship-handles";let E=Le=class extends ki(X){constructor(t,e){super(t,e),this._contentWidgets=[],this.flowItems=null,this.headingLevel=2,this.messages=null,this.messagesCommon=null,this.messagesURIUtils=null,this.visibleElements={...it},this.viewModel=new yt}initialize(){this.addHandles(S(()=>{var t;return(t=this.viewModel)==null?void 0:t.contentViewModels},()=>this._setupContentWidgets(),O))}loadDependencies(){return Pe({notice:()=>M(()=>import("./calcite-notice-ae448cb5.js"),["assets/calcite-notice-ae448cb5.js","assets/jsxFactory-92036771.js","assets/index-b516d057.js","assets/index-b252abd2.css","assets/uuid-709b6c67.js","assets/conditionalSlot-11b5e54d.js","assets/observers-9c654f26.js","assets/loadable-7d42c3de.js","assets/locale-2cb18332.js","assets/key-c2c83cc7.js","assets/t9n-622f279b.js","assets/openCloseComponent-3fbda1cf.js","assets/component-7281ffa6.js","assets/icon-c122f720.js"])})}destroy(){this._destroyContentWidgets()}get graphic(){return this.viewModel.graphic}set graphic(t){this.viewModel.graphic=t}get defaultPopupTemplateEnabled(){return this.viewModel.defaultPopupTemplateEnabled}set defaultPopupTemplateEnabled(t){this.viewModel.defaultPopupTemplateEnabled=t}get isTable(){return this.viewModel.isTable}get label(){var t;return((t=this.messages)==null?void 0:t.widgetLabel)??""}set label(t){this._overrideIfSome("label",t)}get spatialReference(){return this.viewModel.spatialReference}set spatialReference(t){this.viewModel.spatialReference=t}get title(){return this.viewModel.title}castVisibleElements(t){return{...it,...t}}get map(){return this.viewModel.map}set map(t){this.viewModel.map=t}get view(){return this.viewModel.view}set view(t){this.viewModel.view=t}setActiveMedia(t,e){return this.viewModel.setActiveMedia(t,e)}nextMedia(t){return this.viewModel.nextMedia(t)}previousMedia(t){return this.viewModel.previousMedia(t)}render(){const{state:t}=this.viewModel,e=u("div",{class:b.container,key:"container"},this._renderTitle(),t==="error"?this._renderError():t==="loading"?this._renderLoading():this._renderContentContainer());return u("div",{class:this.classes(b.base,ee.widget)},e)}_renderError(){const{messagesCommon:t,messages:e,visibleElements:i}=this;return u("calcite-notice",{icon:"exclamation-mark-circle",kind:"danger",open:!0,scale:"s"},i.title?u("div",{key:"error-title",slot:"title"},t.errorMessage):null,u("div",{key:"error-message",slot:"message"},e.loadingError))}_renderLoading(){return u("div",{class:b.loadingSpinnerContainer,key:"loading-container"},u("span",{class:this.classes(ke.loadingIndicator,ee.rotating,b.spinner)}))}_renderContentContainer(){const{visibleElements:t}=this;return t.content?u("div",{class:b.main},[this._renderContent(),this._renderLastEditInfo()]):null}_renderTitle(){const{visibleElements:t,title:e}=this;return t.title?u(lt,{class:b.title,innerHTML:e,level:this.headingLevel}):null}_renderContent(){const t=this.viewModel.content,e="content";if(!t)return null;if(Array.isArray(t))return t.length?u("div",{class:b.contentNode,key:`${e}-content-elements`},t.map(this._renderContentElement,this)):null;if(typeof t=="string"){const i=this._contentWidgets[0];return!i||i.destroyed?null:u("div",{class:this.classes(b.contentNode,b.contentNodeText),key:`${e}-content`},i.render())}return this.renderNodeContent(t)}_renderContentElement(t,e){var s;const{visibleElements:i}=this;if(typeof i.content!="boolean"&&!((s=i.content)!=null&&s[t.type]))return null;switch(t.type){case"attachments":return this._renderAttachments(e);case"custom":return this._renderCustom(t,e);case"fields":return this._renderFields(e);case"media":return this._renderMedia(e);case"text":return this._renderText(t,e);case"expression":return this._renderExpression(e);case"relationship":return this._renderRelationship(e);default:return null}}_renderAttachments(t){const e=this._contentWidgets[t];if(!e||e.destroyed)return null;const{state:i,attachmentInfos:s}=e.viewModel;return i==="loading"||s.length>0?u("div",{class:this.classes(b.contentElement),key:this._buildKey("attachments-element",t)},e.render()):null}_renderRelationship(t){const e=this._contentWidgets[t];return e&&!e.destroyed&&this.flowItems?u("div",{class:b.contentElement,key:this._buildKey("relationship-element",t)},e.render()):null}_renderExpression(t){const e=this._contentWidgets[t];return!e||e.destroyed?null:u("div",{class:b.contentElement,key:this._buildKey("expression-element",t)},e.render())}_renderCustom(t,e){const{creator:i}=t,s=this._contentWidgets[e];return!s||s.destroyed?null:i?u("div",{class:b.contentElement,key:this._buildKey("custom-element",e)},s.render()):null}_renderFields(t){const e=this._contentWidgets[t];return!e||e.destroyed?null:u("div",{class:b.contentElement,key:this._buildKey("fields-element",t)},e.render())}_renderMedia(t){const e=this._contentWidgets[t];return!e||e.destroyed?null:u("div",{class:b.contentElement,key:this._buildKey("media-element",t)},e.render())}_renderLastEditInfo(){const{visibleElements:t,messages:e}=this,{lastEditInfo:i}=this.viewModel;if(!i||!t.lastEditedInfo)return null;const{date:s,user:r}=i,n=i.type==="edit"?r?e.lastEditedByUser:e.lastEdited:r?e.lastCreatedByUser:e.lastCreated,o=Oe(n,{date:s,user:r});return u("div",{class:this.classes(b.lastEditedInfo,b.contentElement),key:"edit-info-element"},o)}_renderText(t,e){const i=t.text,s=this._contentWidgets[e];return!s||s.destroyed?null:i?u("div",{class:this.classes(b.contentElement,b.text),key:this._buildKey("text-element",e)},s.render()):null}_buildKey(t,...e){var i,s;return`${t}__${((s=(i=this.viewModel)==null?void 0:i.graphic)==null?void 0:s.uid)||"0"}-${e.join("-")}`}_destroyContentWidget(t){t&&(t.viewModel=null,!t.destroyed&&t.destroy())}_destroyContentWidgets(){this.removeHandles(st),this._contentWidgets.forEach(t=>this._destroyContentWidget(t)),this._contentWidgets=[]}_addFeatureRelationshipHandles(t){const{flowItems:e,visibleElements:i}=this;this.addHandles([he(()=>t,"select-record",({featureViewModel:s})=>{e&&(s.abilities={relationshipContent:!0},e.push(new Le({flowItems:e,viewModel:s,visibleElements:i})))}),he(()=>t,"show-all-records",()=>{if(!e)return;const{viewModel:s}=t;s.showAllEnabled=!0;const r=new Ze({visibleElements:{title:!1,description:!1},viewModel:s});this._addFeatureRelationshipHandles(r),e.push(r)})],st)}_setupContentWidgets(){var r;this._destroyContentWidgets();const{headingLevel:t,visibleElements:e}=this,i=(r=this.viewModel)==null?void 0:r.content,{contentViewModels:s}=this.viewModel;if(Array.isArray(i))i.forEach((n,o)=>{if(n.type==="attachments"&&(this._contentWidgets[o]=new ti({displayType:n.displayType,headingLevel:e.title?t+1:t,viewModel:s[o]})),n.type==="fields"&&(this._contentWidgets[o]=new mt({viewModel:s[o]})),n.type==="media"&&(this._contentWidgets[o]=new ft({viewModel:s[o]})),n.type==="text"&&(this._contentWidgets[o]=new ce({viewModel:s[o]})),n.type==="custom"&&(this._contentWidgets[o]=new ce({viewModel:s[o]})),n.type==="expression"&&(this._contentWidgets[o]=new Vi({viewModel:s[o]})),n.type==="relationship"){const l=new Ze({viewModel:s[o]});this._addFeatureRelationshipHandles(l),this._contentWidgets[o]=l}},this);else{const n=s[0];n&&!n.destroyed&&(this._contentWidgets[0]=new ce({viewModel:n}))}this.scheduleRender()}};a([d()],E.prototype,"graphic",null),a([d()],E.prototype,"defaultPopupTemplateEnabled",null),a([d()],E.prototype,"flowItems",void 0),a([d()],E.prototype,"headingLevel",void 0),a([d({readOnly:!0})],E.prototype,"isTable",null),a([d()],E.prototype,"label",null),a([d(),j("esri/widgets/Feature/t9n/Feature")],E.prototype,"messages",void 0),a([d(),j("esri/t9n/common")],E.prototype,"messagesCommon",void 0),a([d(),j("esri/widgets/support/t9n/uriUtils")],E.prototype,"messagesURIUtils",void 0),a([d()],E.prototype,"spatialReference",null),a([d({readOnly:!0})],E.prototype,"title",null),a([d()],E.prototype,"visibleElements",void 0),a([_e("visibleElements")],E.prototype,"castVisibleElements",null),a([d()],E.prototype,"map",null),a([d()],E.prototype,"view",null),a([d({type:yt})],E.prototype,"viewModel",void 0),E=Le=a([V("esri.widgets.Feature")],E);const Ni=E,_s=Object.freeze(Object.defineProperty({__proto__:null,default:Ni},Symbol.toStringTag,{value:"Module"}));export{_s as F,yt as X,ki as i,Ni as x};
