import{a5 as h,a6 as u,a9 as V,bA as Yt,cn as Pa,km as za,y as Ha,cb as f,cd as Va,ao as Y,dA as Pe,kd as ka,kN as Ua,lp as Xa,p4 as Na,kQ as Ya,kc as Za,jM as Et,gR as ra,gr as la,le as Fa,gp as Ba,gi as re,gy as ze,aW as H,dr as Jt,j9 as ja,hQ as Z,h3 as $,kP as N,b9 as R,f6 as ct,cc as Xt,lf as qa,so as ri,i0 as Gt,fO as He,sp as pa,d2 as At,d1 as Vt,aU as Wa,cv as Ka,sq as Qa,gv as Ja,k3 as ha,iN as Ve,bg as $t,gM as wi,f5 as x,i$ as F,nh as tn,fK as we,ft as ca,db as B,n2 as Oe,kK as li,fx as ke,gk as gt,nj as en,fk as L,fv as ei,fe as Ee,fC as Dt,sr as an,oA as nn,lb as ua,gN as da,b0 as ii,k as on,V as sn,fr as _e,gA as ga,e_ as pi,fc as ma,ss as rn,gS as Oi,fw as ln,st as pn,mM as Ei,mg as hn,fa as te,ac as cn,da as Pt,fi as un,ez as _a,ah as dn,D as gn,ce as Te,n1 as mn,ni as Ti,mF as _n,f1 as le,fM as ce,d4 as vn,d0 as Ai,fg as Gi,su as fn,sv as yn,sw as Mn,hv as Di,sx as bn,sy as Sn,B as xn,bh as wn,ld as On,f8 as va,d8 as ai,k1 as En,fD as Ht,id as Tn}from"./index-b516d057.js";import{r as An,o as Gn,t as Ii,s as z,f as Dn,c as In}from"./elevationInfoUtils-be36d866.js";import{q as $n}from"./quantityFormatUtils-e5b1c45f.js";import{e as Rn}from"./getDefaultUnitForView-d1ffbf16.js";import{x as Cn}from"./TextOverlayItem-7f83875e.js";import{l as Ln,u as ve,a as bt,s as Ue,p as Pn,b as zn,c as ye}from"./automaticLengthMeasurementUtils-412e2f10.js";import{f as Hn}from"./viewUtils-9f810d02.js";import{O as ue}from"./SnappingVisualizer3D-493bdb16.js";import{a as fa}from"./interfaces-1a80c8eb.js";import{z as Zt,w as Nt}from"./OutlineVisualElement-75d7e05b.js";import{G as hi}from"./ExtendedLineVisualElement-451ab04d.js";import{d as $i}from"./VerticesVisualElement-efafb673.js";import{e as ci,o as ui,W as Ae,X as ya,Y as Vn,Z as kn,K as Un,D as Me,L as Xn}from"./RenderGeometry-5dbc1699.js";import{e as Ft}from"./GraphicState-0d3046df.js";import{d as It}from"./Material-5f4156ac.js";import{K as Nn,X as Yn,g as Zn,V as Xe,l as Fn,x as Ri}from"./editPlaneUtils-f4a70878.js";import{k as Bn,o as jn,r as qn}from"./surfaceCoordinateSystems-1cfad4a3.js";import{getDrawMeshHelpMessage as Wn}from"./helpMessageUtils3d-26675e60.js";import{a as ht,m as Ge,i as de,o as We,n as Ci}from"./unitFormatUtils-67047561.js";import{h as di}from"./UpdatingHandles-7949a657.js";import{e as Ne}from"./dehydratedPoint-5a1dfed5.js";import{$ as et,e as w,w as Mt,k as Ma,b as ne,v as ba,F as Sa}from"./manipulatorUtils-9334c98f.js";import{e as Kn}from"./SnappingManager-aa70fdd4.js";import{o as Qn,P as xa,l as Jn,n as to}from"./SketchViewModel-fedf7932.js";import{n as kt}from"./manipulatorUtils-c4d6f78f.js";import{r as De}from"./signal-51ed66f5.js";import{c as ni}from"./LaserlineVisualElement-c0026af2.js";import{t as Li}from"./projectVectorToVector-56c29b20.js";import{x as eo}from"./PointVisualElement-11117df9.js";import{T as gi,P as wa,M as io,U as ao,k as no,D as oo,H as mi}from"./dragEventPipeline3D-4663cd2c.js";import{x as so,z as ro,d as rt,D as pe,y as lo,q as ie,U as Oa,P as Kt,l as Ye,j as po,w as ho,C as Pi,O as co}from"./InteractiveToolBase-ddd44c70.js";import{f as _i}from"./ColorMaterial-bdf1f62a.js";import{t as O,u as yt}from"./interfaces-0421c5e6.js";import{S as uo}from"./GraphicManipulator-bf7f8b04.js";import{V as Ze,y as zi,N as go,E as St,e as Ea}from"./EditGeometryOperations-c2e73f2d.js";import{p as Rt,c as Ta}from"./SketchTooltipOptions-cc43c059.js";import{e as Ie}from"./SnappingContext-90969376.js";import{f as $e}from"./SnappingDragPipelineStep-e275580d.js";import{r as ge,a as Fe,l as vi,n as mo,c as _o,p as vo}from"./TranslateTooltipInfos-e784159d.js";import{y as Re,R as fo,d as yo}from"./euclideanLengthMeasurementUtils-aa8fca96.js";import{t as Hi}from"./IViewEvents-9a85f53d.js";import{o as Mo}from"./automaticAreaMeasurementUtils-7a3ffffd.js";import{l as oi}from"./ViewingMode-5d7d590b.js";import{r as bo}from"./Cyclical-4c223a04.js";import{I as So,H as xo,z as wo,g as Oo,c as Eo,C as To,a as Ao,i as Go,B as Aa,D as Vi,e as Do,N as Io,F as $o}from"./ShiftManipulator-85ff8a40.js";import{Z as me,W as he,J as Ro}from"./boundedPlane-1da2f094.js";import{l as Co}from"./Factory-829a6ea7.js";import{m as Ga}from"./ray-8da55042.js";import{i as Lo,p as Po}from"./ExtentTooltipInfos-e0fd687c.js";import"./jsxFactory-92036771.js";import"./uuid-709b6c67.js";import"./themeUtils-7dcf5b71.js";import"./memoize-3e55df82.js";import"./snappingUtils-93e84fbe.js";import"./Query-071039d7.js";import"./FullTextSearch-12e0754c.js";import"./QuantizationParameters-f983cf8d.js";import"./screenUtils-8dc4a7f9.js";import"./geometryEngine-656a968c.js";import"./geometryEngineBase-dfbd3a67.js";import"./hydrated-40effdd0.js";import"./projectVectorToWGS84ComparableLonLat-5675a9f4.js";import"./geodesicUtils-822c19ca.js";import"./vec4f32-0d1b2306.js";import"./EngineVisualElement-43f3e8cb.js";import"./VisualElement-187372ae.js";import"./RightAngleQuadVisualElement-95156bc2.js";import"./lineStippleUtils-0688e06c.js";import"./DefaultTechniqueConfiguration-b4dbe32f.js";import"./requestImageUtils-b142708c.js";import"./enums-bdecffa2.js";import"./Texture-bcb6d63f.js";import"./contextUtils-81fda295.js";import"./interfaces-8918b36f.js";import"./FramebufferObject-123b7c8d.js";import"./ShaderTechniqueConfiguration-2502462e.js";import"./frustum-f9d53cdf.js";import"./Object3DVisualElement-459b9b9c.js";import"./vec3f32-bac7ea57.js";import"./ElevationProvider-abb53936.js";import"./hydratedFeatures-2365c307.js";import"./weather-2eb64924.js";import"./RenderState-1d6218ee.js";import"./NestedMap-1b5db22e.js";import"./VertexElementDescriptor-2925c6af.js";import"./VertexArrayObject-d19dab8d.js";import"./Octree-7cea9440.js";import"./InterleavedLayout-d76b0d59.js";import"./types-1305598a.js";import"./OrderIndependentTransparency-755f7dcc.js";import"./floatRGBA-ca990bbb.js";import"./Intersector-2e1d9db3.js";import"./Intersector-fa865806.js";import"./verticalOffsetUtils-e5214af9.js";import"./orientedBoundingBox-67c5cd22.js";import"./glUtil-ce5ee52b.js";import"./Scheduler-ff5943a4.js";import"./debugFlags-9a30f077.js";import"./helpMessageUtils-1ce96584.js";import"./coordinateSystem-38339d17.js";import"./projectVectorToPoint-fbaf5599.js";import"./measurementUtils-3881da59.js";import"./dehydratedFeatureComparison-7855b188.js";import"./SnappingOperation-4a4ee09b.js";import"./mat2d-d4af8487.js";import"./mat2df64-4d1a9198.js";import"./geometry2dUtils-a99dcf3d.js";import"./FeatureFilter-55dd341e.js";import"./floorFilterUtils-080a7cd2.js";import"./layerUtils-437666a3.js";import"./hitTestSelectUtils-d512707e.js";import"./drawUtils-bd7471ac.js";import"./VerticalOffset.glsl-5743f98e.js";import"./defaults-4faa92e6.js";import"./defaultsJSON-59981e75.js";import"./drapedUtils-5cffceb9.js";import"./PointSnappingHint-671c9f09.js";import"./euclideanAreaMeasurementUtils-f9ba1710.js";import"./ImageMaterial-10c9471b.js";import"./SlicePlane-40eedf78.js";import"./persistable-a11ce298.js";import"./MD5-715f37cd.js";import"./multiOriginJSONSupportUtils-c978f4c3.js";import"./resourceExtension-63924db9.js";import"./LineVisualElement-e3bb1937.js";import"./RenderCoordsHelper-8f237859.js";import"./projectVectorToDehydratedPoint-e30a7ff8.js";const zo=3025,Ho={default:15,far:25};let at=class extends Yt{constructor(i){super(i),this.context=null,this.stagedVertex=null,this.visible=!0,this.edgeDistance="default",this._messagesUnits=null,this._labelInfos=[],this._nextLabelIndex=0}initialize(){const i=Pa(async t=>{const e=await za("esri/core/t9n/Units");Ha(t),this._messagesUnits=e});this.addHandles([f(()=>[this.context!=null&&this.getCameraOrExtent(this.context),this.visible,this._edgeDistancePixels,this.stagedVertex,this._messagesUnits],()=>this._update()),...["vertex-add","vertex-update","vertex-remove"].map(t=>Va(()=>{var e;return(e=this.context)==null?void 0:e.editGeometryOperations},t,()=>this._update())),Y(()=>i.abort()),f(()=>this._colors,t=>this._updateStyle(t))])}destroy(){for(this._nextLabelIndex=0;this._labelInfos.length;)this._destroyLabel(this._labelInfos.pop())}get updating(){return this._messagesUnits==null}get test(){return{labelContents:this._labelInfos.slice(0,this._nextLabelIndex).map(i=>i.label.text)}}get _edgeDistancePixels(){return Ho[this.edgeDistance]}get _colors(){var t;const i=((t=this.context)==null?void 0:t.view.effectiveTheme.textColor)??Pe.fromArray([255,255,255]);return{textColor:i,backgroundColor:ka(Ua(i,Xa.Low),.6)}}_update(){if(this.destroyed)return;this._nextLabelIndex=0;const i=this.context;if(i==null)return void this._destroyUnusedLabels();const{components:t,geometry:e,coordinateHelper:n}=i.editGeometryOperations.data;if(!e)return void this._destroyUnusedLabels();const a=t.length;for(let o=0;o<a;++o){const s=[];if(t[o].iterateVertices(g=>{s.push(n.toXYZ(g.pos))}),o===0&&this.stagedVertex!=null&&s.push(n.toXYZ(this.stagedVertex)),s.length<2)continue;const r=s[0],l=s[s.length-1];e.type==="polygon"&&s.length>2&&!Na(r,l)&&s.push(r);const p=a===1&&!Ya(s);let c=Vo,d=ko;this.toScreenPointArray(i,r,c);for(let g=1;g<s.length;++g){const m=s[g-1],_=s[g];this.toScreenPointArray(i,_,d),this._addLabel(i,m,c,_,d,p),[c,d]=[d,c]}}this._destroyUnusedLabels()}_updateStyle({textColor:i,backgroundColor:t}){const e=this._nextLabelIndex,n=this._labelInfos;for(let a=0;a<e;++a){const{label:o}=n[a];o.textColor=i,o.backgroundColor=t}}_addLabel(i,t,e,n,a,o){const{label:s}=this._getOrCreateLabel(i);if(!this.visible||Za(e,a)<zo)return void(s.visible=!1);const r=i.graphicState!=null?i.graphicState.isDraped?"on-the-ground":"absolute-height":An(i.editGeometryOperations.data.geometry,i.elevationInfo),{spatialReference:l}=i.editGeometryOperations.data,p=Ln(t,n,l,r),c=this._messagesUnits,d=Rn(i.view);s.text=c!=null&&p!=null?$n(c,p,d):"",s.visible=!0;const g=a[0]-e[0],m=a[1]-e[1];o?Et(it,-m,g):Et(it,m,-g),ra(it,it),la(it,it,this._edgeDistancePixels),Fa(oe,e,a,.5),Ba(oe,oe,it),s.position=[oe[0],oe[1]],Math.abs(it[0])>Math.abs(it[1])?s.anchor=it[0]>0?"left":"right":s.anchor=-it[1]<0?"top":"bottom"}_getOrCreateLabel(i){var s;const t=this._labelInfos.length>this._nextLabelIndex,{textColor:e,backgroundColor:n}=this._colors;if(t){const r=this._labelInfos[this._nextLabelIndex++],{label:l}=r;return l.textColor=e,l.backgroundColor=n,r}const a=new Cn({anchor:"center",fontSize:10,textColor:e,backgroundColor:n});(s=i.view.overlay)==null||s.items.add(a);const o={label:a};return this._labelInfos.push(o),this._nextLabelIndex=this._labelInfos.length,o}_destroyUnusedLabels(){for(;this._labelInfos.length>this._nextLabelIndex;)this._destroyLabel(this._labelInfos.pop())}_destroyLabel({label:i}){var t,e;(e=(t=this.context)==null?void 0:t.view.overlay)==null||e.items.remove(i),i.destroy()}};h([u()],at.prototype,"context",void 0),h([u()],at.prototype,"stagedVertex",void 0),h([u()],at.prototype,"visible",void 0),h([u()],at.prototype,"edgeDistance",void 0),h([u()],at.prototype,"updating",null),h([u()],at.prototype,"_messagesUnits",void 0),h([u()],at.prototype,"_edgeDistancePixels",null),h([u()],at.prototype,"_colors",null),at=h([V("esri.views.interactive")],at);const it=re(),oe=re(),Vo=ze(),ko=ze();let Ce=class extends at{getCameraOrExtent({view:t}){return t.state.camera}toScreenPointArray({view:t,elevationInfo:e,editGeometryOperations:n},a,o=ze()){const{spatialReference:s}=n.data.coordinateHelper;return Hn(a,s,e,t,ki),t.state.camera.projectToScreen(ki,o),o}};Ce=h([V("esri.views.3d.interactive.SegmentLabels3D")],Ce);const ki=H();function fi(i){const{graphic:t}=i;return[f(()=>i.displaying,e=>{e?Uo(t):Ui(t)},{...Jt}),Y(()=>Ui(t))]}function Uo(i){const{geometry:t}=i;Da(t)&&i.notifyMeshTransformChanged({action:fa.EnableFastUpdates})}function Ui(i){const{geometry:t}=i;Da(t)&&i.notifyMeshTransformChanged({action:fa.DisableFastUpdates})}function Da(i){return(i==null?void 0:i.type)==="mesh"&&!i.vertexSpace.isGeoreferenced}let Bt=class extends Nn{constructor(i){super(i),this._activeVertexVisualElement=null,this._createGraphicState=null,this._outlineVisualElement=null,this._verticesVisualElement=null,this._verticalLineVisualElement=null,this._settings=new Zt({getTheme:()=>this.view.effectiveTheme}),this.geometryType=null,this.type="draw-3d"}initialize(){const{mode:i,offset:t}=this.elevationInfo;this.internalGraphicsLayer.elevationInfo=new ja({mode:i,offset:t})}normalizeCtorArgs(i){if(!i.elevationInfo){const t=i.hasZ??!0;return{...i,elevationInfo:Gn(t)}}return i}initializeGraphic(i){const{view:t}=this,e=this._createGraphicState=new Ft({graphic:i});return Z([t.maskOccludee(i),t.trackGraphicState(e),f(()=>({element:this._outlineVisualElement,isDraped:e.isDraped}),({element:n,isDraped:a})=>{n&&(n.isDraped=a)},Jt),this._setupLoadingIndicator(e),...fi(e)])}updateDrawMeshTooltipInfo(i){const{graphic:t,tooltipOptions:e,view:n}=this;i.tooltipOptions=e,i.viewType=n.type,i.helpMessage=Wn(t,this.view),this.updateElevation(i.elevation)}makeDrawOperation(){const{geometryType:i}=this,t=i!=="circle"&&i!=="rectangle";return new Bn({view:this.view,manipulators:this.manipulators,geometryType:Yn(i),drawingMode:this.mode,hasZ:this.hasZ,defaultZ:this.defaultZ,snapToSceneEnabled:this.snapToScene,drawSurface:new jn(this.view,this.elevationInfo,[this.internalGraphicsLayer]),elevationDrawSurface:new qn(this.elevationInfo,this.defaultZ,this.view,this.internalGraphicsLayer),hasM:!1,elevationInfo:this.elevationInfo,snappingManager:this.snappingManager,snappingVisualizer:new ue,segmentLabels:t?new Ce:null,labelOptions:this.labelOptions,tooltipOptions:this.tooltipOptions,isDraped:this._createGraphicState?this._createGraphicState.isDraped:Ii(this.hasZ,this.elevationInfo)==="on-the-ground",cursor:this.cursor})}onActiveVertexChanged(i){const{view:t}=this;if(this._activeVertexVisualElement)return this._activeVertexVisualElement.vertices=[i],this._updateVerticalLineVisualElement(i),Y();const e=this._settings,n=e.manipulators.vertex,a=new $i({view:t,spatialReference:t.spatialReference,vertices:[i],elevationInfo:this.internalGraphicsLayer.elevationInfo,size:n.size,outlineSize:n.outlineSize,renderOccluded:n.renderOccluded,attached:!1,isDecoration:!0});this._activeVertexVisualElement=a;const o=e.visualElements.zVerticalLine,s=new hi({view:t,extensionType:o.extensionType,innerWidth:1,attached:!1,writeDepthEnabled:!1,renderOccluded:It.OccludeAndTransparent,isDecoration:!0});this._verticalLineVisualElement=s;const r=Z([f(()=>e.visualElements.zVerticalLine,l=>l.apply(s),$),f(()=>({selectedColor:N(e.colors.selected),outlineColor:N(e.manipulators.vertex.outlineColor)}),({selectedColor:l,outlineColor:p})=>{a.color=l,a.outlineColor=p},$),Y(()=>{this._activeVertexVisualElement=R(this._activeVertexVisualElement),this._verticalLineVisualElement=R(this._verticalLineVisualElement)})]);return a.attached=!0,r}_updateVerticalLineVisualElement(i){const t=this._verticalLineVisualElement;if(!t)return;const{renderCoordsHelper:e,elevationProvider:n}=this.view;ct(jt,i[0],i[1],i[2]),Xi.setFromElevationInfo(this.elevationInfo),jt[2]=ci(jt,n,Xi,e),e.toRenderCoords(jt,this.view.spatialReference,jt)?(t.setStartEndFromWorldDownAtLocation(jt),t.attached=!0):t.attached=!1}onOutlineChanged(i){if(this._outlineVisualElement)return this._outlineVisualElement.geometry=i,Y();const t=this.internalGraphicsLayer.elevationInfo,{view:e}=this,n=this._settings,a=new Nt({view:e,geometry:i,elevationInfo:t,isDraped:this._createGraphicState?this._createGraphicState.isDraped:Ii(this.hasZ,t)==="on-the-ground",attached:!1,isDecoration:!0});this._outlineVisualElement=a;const o=Z([f(()=>n.visualElements.lineGraphics.outline,s=>s.apply(a),$),f(()=>n.visualElements.lineGraphics.shadowStyle,s=>s.apply(a),$),Y(()=>{this._outlineVisualElement=R(this._outlineVisualElement)})]);return a.attached=!0,a.laserlineEnabled=!0,o}onRegularVerticesChanged(i){if(this._verticesVisualElement)return this._verticesVisualElement.vertices=i,Y();const{view:t}=this,e=this._settings,n=e.manipulators.vertex,a=new $i({view:t,spatialReference:t.spatialReference,vertices:i,elevationInfo:this.internalGraphicsLayer.elevationInfo,size:n.size,outlineSize:n.outlineSize,renderOccluded:n.renderOccluded,attached:!1,isDecoration:!0}),o=Z([f(()=>({color:N(e.manipulators.vertex.color),outlineColor:N(e.manipulators.vertex.outlineColor)}),({color:s,outlineColor:r})=>{a.color=s,a.outlineColor=r},$),Y(()=>{this._verticesVisualElement=R(this._verticesVisualElement)})]);return a.attached=!0,this._verticesVisualElement=a,o}updateGraphicGeometry(i,t){if(this.geometryType==="mesh"&&(t==null?void 0:t.type)==="point"){const e=this.geometryToPlace;return e&&e.centerAt(t),void(e&&i.geometry===e?e.vertexSpace.isGeoreferenced?i.notifyGeometryChanged():i.notifyMeshTransformChanged():i.geometry=e)}super.updateGraphicGeometry(i,t)}_setupLoadingIndicator(i){const{drawOperation:t}=this;if(!this.geometryToPlace)return t.loading=!1,null;t.loading=!0;const e=Y(()=>{t.loading=!1});let n;const a=()=>n&&cancelAnimationFrame(n);return Z([Xt(()=>i.displaying,()=>{a(),n=requestAnimationFrame(()=>e.remove())},{...Jt,once:!0}),Y(a),e])}};h([u({constructOnly:!0})],Bt.prototype,"elevationInfo",void 0),h([u({constructOnly:!0})],Bt.prototype,"geometryType",void 0),h([u()],Bt.prototype,"type",void 0),h([u({constructOnly:!0})],Bt.prototype,"view",void 0),Bt=h([V("esri.views.3d.interactive.editingTools.draw.DrawGraphicTool3D")],Bt);const Xi=new ui,jt=H();function Xo(i){const t=yi(i);return qa(Math.cos(t),Math.sin(t))}function yi(i){if(i==null||i.type!=="polyline"&&i.type!=="polygon")return 0;const t=i.type==="polyline"?i.paths:i.rings;for(const e of t)for(let n=0;n<e.length-1;n++){const a=e[n],o=e[n+1],s=a[0]-o[0],r=a[1]-o[1];if(s*s+r*r>Kn)return Math.atan2(o[1]-a[1],o[0]-a[0])}return 0}var st;(function(i){i[i.NONE=0]="NONE",i[i.ANY=1]="ANY",i[i.Z=2]="Z",i[i.XY=4]="XY"})(st||(st={}));var G;(function(i){i[i.TRANSLATE_Z=0]="TRANSLATE_Z",i[i.TRANSLATE_XY=1]="TRANSLATE_XY",i[i.SCALE=2]="SCALE",i[i.ROTATE=3]="ROTATE",i[i.SCALE_ROTATE=4]="SCALE_ROTATE"})(G||(G={}));let Ia=class{constructor(){this.grabbingState=st.NONE,this.zManipulator=null,this.firstSelected=null,this.numSelected=0,this.firstGrabbedXY=null}update(t){this.grabbingState=st.NONE,this.zManipulator=null,this.numSelected=0,this.firstSelected=null,this.firstGrabbedXY=null,t.forEachManipulator((e,n)=>{if(n===G.TRANSLATE_Z&&(this.zManipulator=e),e instanceof et&&(e.selected&&(this.numSelected===0&&(this.firstSelected=e),this.numSelected++),this.firstGrabbedXY==null&&e.grabbing&&n===G.TRANSLATE_XY&&(this.firstGrabbedXY=e)),e.grabbing)switch(this.grabbingState|=st.ANY,n){case G.TRANSLATE_Z:this.grabbingState|=st.Z;break;case G.TRANSLATE_XY:this.grabbingState|=st.XY}})}};function No(i){const{view:t,graphic:e}=i,n=new Ft({graphic:e}),a=Yo(i,n),o=[a,Zo(i,a.visualElement,n),t.maskOccludee(e),t.trackGraphicState(n)];return{visualElement:a.visualElement,remove:()=>ri(o)}}function Yo(i,t){const{view:e,graphic:n}=i,a=new Nt({view:e,geometry:si(n)?n.geometry:null,elevationInfo:z(n),attached:!1,isDecoration:!0}),o=new Zt({getTheme:()=>e.effectiveTheme}),s=()=>{a.attached=t.displaying},r=Z([f(()=>o.visualElements.lineGraphics.outline,l=>l.apply(a),$),f(()=>o.visualElements.lineGraphics.shadowStyle,l=>l.apply(a),$),f(()=>t.displaying,s),f(()=>t.isDraped,l=>{a.isDraped=l}),t.on("changed",()=>a.geometry=si(n)?n.geometry:null),Gt(a)]);return s(),{visualElement:a,remove:()=>r.remove()}}function Zo(i,t,e){const{graphic:n,view:a}=i,o=[],s=z(n),r=s.mode==="on-the-ground"||!s.offset&&s.mode!=="absolute-height",l=new Ia,p=new Zt({getTheme:()=>a.effectiveTheme}),c=p.visualElements,d=new hi({view:a,extensionType:c.zVerticalLine.extensionType,innerWidth:1,attached:!1,writeDepthEnabled:!1,renderOccluded:It.OccludeAndTransparent,isDecoration:!0}),g=He(c.heightPlaneAngleCutoff),m=new ni({view:a,attached:!1,angleCutoff:g,isDecoration:!0}),_=De(1);o.push(f(()=>({lineShadowStyle:p.visualElements.lineGraphics.shadowStyle,pointShadowStyle:p.visualElements.pointGraphics.shadowStyle,alpha:_.value}),({lineShadowStyle:T,pointShadowStyle:D,alpha:X})=>{T.apply(t,X),D.apply(d,X)},$));const v=De(1);o.push(f(()=>({heightPlane:p.visualElements.heightPlane,alpha:v.value}),({heightPlane:T,alpha:D})=>T.apply(m,D),$));const y=()=>{if(l.update(i),!e.displaying||r&&(e.isDraped||!si(n)||!n.geometry.hasZ))return t.laserlineEnabled=!1,d.attached=!1,void(m.attached=!1);t.laserlineEnabled=!0;const T=l.grabbingState&st.XY?c.laserlineAlphaMultiplier:1;_.value=T;const D=l.grabbingState&st.Z?c.laserlineAlphaMultiplier:1;v.value=D,Fo(d,l),Bo(i,t,m,l)};o.push(f(()=>p.visualElements.zVerticalLine,T=>T.apply(d),$)),o.push(e.on("changed",y),f(()=>e.displaying,y),t.events.on("attachment-origin-changed",y),Gt(d),Gt(m));const b=[],M=()=>{ri(b),b.length=0,i.forEachManipulator(T=>b.push(T.events.on("grab-changed",y))),i.forEachManipulator(T=>b.push(T.events.on("select-changed",y))),y()};return M(),o.push(i.onManipulatorsChanged(M),pa(()=>Z(b))),Z(o)}function Fo(i,t){const e=t.numSelected===1?t.firstSelected:t.numSelected>1&&t.firstGrabbedXY!=null?t.firstGrabbedXY:null;e!=null?(i.setStartEndFromWorldDownAtLocation(e.renderLocation),i.attached=!0):i.attached=!1}function Bo(i,t,e,n){if(n.numSelected>0){ct(Lt,0,0,0);let a=0;i.forEachManipulator((o,s)=>{s===G.TRANSLATE_XY&&o.selected&&o instanceof et&&(At(Lt,Lt,o.renderLocation),a++)}),a>0?(e.heightManifoldTarget=Vt(Lt,Lt,1/a),e.attached=!0):e.attached=!1}else{const a=t.attachmentOrigin;a!=null&&i.view.renderCoordsHelper.toRenderCoords(a,Lt)?(e.heightManifoldTarget=Lt,e.attached=!0):e.attached=!1}}function si(i){return i.geometry!=null&&(i.geometry.type==="polygon"||i.geometry.type==="polyline")}const Lt=H();function jo(i){const{view:t,graphic:e}=i,n=new Ft({graphic:e}),a=[],o=Wo(i,n,a);return qo(i,n,a,o),a.push(t.trackGraphicState(n)),{visualElement:o,remove:()=>ri(a)}}function qo(i,t,e,n){const{view:a,graphic:o}=i,s=new Zt({getTheme:()=>a.effectiveTheme}),r=new hi({view:a,extensionType:s.visualElements.zVerticalLine.extensionType,innerWidth:1,attached:!1,writeDepthEnabled:!1,renderOccluded:It.OccludeAndTransparent,isDecoration:!0});e.push(f(()=>s.visualElements.zVerticalLine,M=>M.apply(r),$));const l=new ni({view:a,intersectsLineInfinite:!0,attached:!1,isDecoration:!0}),p=He(s.visualElements.heightPlaneAngleCutoff),c=new ni({view:a,attached:!1,angleCutoff:p,isDecoration:!0}),d=z(i.graphic),g=ui.fromElevationInfo(d),m=d.mode==="on-the-ground"||!d.offset&&d.mode!=="absolute-height",_=new Ia,v=De(1);e.push(f(()=>({heightPlane:s.visualElements.heightPlane,alpha:v.value}),({heightPlane:M,alpha:T})=>M.apply(c,T),$));const y=De(1);e.push(f(()=>({shadowStyle:s.visualElements.pointGraphics.shadowStyle,alpha:y.value}),({shadowStyle:M,alpha:T})=>M.apply(l,T),$));const b=()=>{_.update(i);const M=Mi(o),T=m&&(t.isDraped||M==null||!M.hasZ);let D=!0;if(T||M==null)D=!1;else{const tt=ci(M,a.elevationProvider,g,a.renderCoordsHelper);ct(ot,M.x,M.y,tt),Li(ot,M.spatialReference,ot,a.renderCoordsHelper.spatialReference),r.setStartEndFromWorldDownAtLocation(ot),l.intersectsWorldUpAtLocation=ot}const X=_.grabbingState&st.Z?s.visualElements.laserlineAlphaMultiplier:1;v.value=X;const j=Ka(ts);!T&&t.displaying&&n.calculateMapBounds(j)&&Li(Qa(j,ot),a.spatialReference,ot,a.renderCoordsHelper.spatialReference)?(c.heightManifoldTarget=ot,c.attached=!0):c.attached=!1;const A=_.grabbingState&st.XY?s.visualElements.laserlineAlphaMultiplier:1;y.value=A;const q=D&&t.displaying&&!T;l.attached=q,r.attached=q};e.push(f(()=>[t.displaying,t.isDraped],b),t.on("changed",b)),i.forEachManipulator(M=>{e.push(M.events.on("grab-changed",b))}),e.push(Gt(l)),e.push(Gt(r)),e.push(Gt(c)),b()}function Wo(i,t,e){const{view:n,graphic:a}=i,o=new eo({view:n,geometry:Mi(a),elevationInfo:z(a),isDecoration:!0});return Ko(i,o,t,e),e.push(Gt(o)),o}function Mi(i){const t=i.geometry;return t==null?null:t.type==="point"?t:t.type==="mesh"?t.anchor.clone():null}function Ko(i,t,e,n){const a=()=>{t.attached=e.displaying},o=new Zt({getTheme:()=>i.view.effectiveTheme});Qo(i,t,e,n),o.visualElements.pointGraphics.outline.apply(t),n.push(f(()=>e.displaying,a,$))}function Qo(i,t,e,n){const{view:a,graphic:o}=i;let s=null;const r=p=>{s!=null&&(s.remove(),s=null),e.isDraped&&p!=null&&(s=Jo(a,p,()=>{t.geometry=p}))},l=()=>{const p=Mi(o);r(p),t.geometry=p};n.push(e.on("changed",l),pa(()=>s)),l()}function Jo(i,t,e){const n=i.elevationProvider.spatialReference;Ja(t,ot,n);const a=ot[0],o=ot[1];return i.elevationProvider.on("elevation-change",s=>{ha(s.extent,a,o)&&e()})}const ot=H(),ts=Wa();function Be(i){switch(i.graphic.geometry.type){case"point":case"mesh":return jo(i);case"polygon":case"polyline":return No(i);default:return null}}const $a=128,ut=70,es=80,Ra=.02,is=54,as=100,Ca=Math.ceil(ut/3*2),zt=160,Ke=.5,Qe=24,qt=9,ns=zt+30,Ni=zt+53,os=60,ss=23,rs=5*Math.PI/12,ls=1*Math.PI/3,Yi=10,Zi=.2,Fi=30,Bi=53,ji=.2,qi=.3,ps=200,hs=3,cs=1e6;let fe=class{constructor(){this._available=!0}set location(t){this._forEachManipulator3D(e=>e.location=t)}set elevationAlignedLocation(t){this._forEachManipulator3D(e=>e.elevationAlignedLocation=t)}set elevationInfo(t){this._forEachManipulator3D(e=>e.elevationInfo=t)}get renderLocation(){let t;return this._forEachManipulator3D(e=>{t||(t=e.renderLocation)}),t}get available(){return this._available}set available(t){this._available=t,this._forEachManipulator3D(e=>e.available=t)}get hovering(){return this.someManipulator(t=>t.hovering)}get grabbing(){return this.someManipulator(t=>t.grabbing)}get dragging(){return this.someManipulator(t=>t.dragging)}hasManipulator(t){return this.someManipulator(e=>e===t)}someManipulator(t){let e=!1;return this.forEachManipulator(n=>{!e&&t(n)&&(e=!0)}),e}_forEachManipulator3D(t){this.forEachManipulator((e,n)=>{e instanceof et&&t(e,n)})}};function je(i,t,e,n){const a=(o,s)=>t({action:o,graphic:i,dxScreen:s.screenDeltaX,dyScreen:s.screenDeltaY});return e((o,s,r)=>(s.next(l=>(l.action==="start"&&a("start",l),l)).next(so(i,n)).next(l=>{switch(l.action){case"start":case"update":(l.translationX||l.translationY||l.translationZ)&&a("update",l);break;case"end":a("end",l)}return l}),{steps:s,cancel:r=r.next(ro(i)).next(l=>(a("end",{screenDeltaX:0,screenDeltaY:0}),l))}))}function Le(i){if((i==null?void 0:i.axis)==null)return 1;const{mapStart:t,mapEnd:e,axis:n}=i,a=[e.x-t.x,e.y-t.y];return a[0]*n[0]+a[1]*n[1]>0?1:-1}let us=class extends fe{constructor(t){super(),this._handles=new Ve,this._arrowManipulatorInfos=new Array,this._angle=0,this._scale=1,this._radius=ut,this._updateAfterDrag=!1,this.events=new $t,this._tool=t.tool,this._view=t.view,this._opaqueMaterial=this._createMaterial(),this._transparentMaterial=this._createMaterial(.5),t.radius!=null&&(this._radius=t.radius),this._createManipulators(),this.forEachManipulator(e=>this._tool.manipulators.add(e))}set orthogonalAvailable(t){this._arrowManipulatorInfos.length>=3&&(this._arrowManipulatorInfos[1].manipulator.available=t,this._arrowManipulatorInfos[3].manipulator.available=t)}destroy(){this._handles=R(this._handles),this.forEachManipulator(t=>{this._tool.manipulators.remove(t),t.destroy()}),this._tool=null,this._view=null,this._arrowManipulatorInfos.length=0}forEachManipulator(t){for(const{manipulator:e}of this._arrowManipulatorInfos)t(e,G.TRANSLATE_XY)}createGraphicDragPipeline(t,e,n){const a=e.graphic,o=z(a),s=a.geometry.spatialReference;return je(a,n,r=>this.createDragPipeline((l,p,c,d,g)=>({steps:p,cancel:c}=t(l,p,c,d,g),r(l,p,c)),o,s,a),this._view.state.viewingMode)}createDragPipeline(t,e,n,a){return Z(this._arrowManipulatorInfos.map(({manipulator:o},s)=>rt(o,(r,l,p,c,d)=>{const g=l.next(m=>({...m,manipulatorType:G.TRANSLATE_XY})).next(pe(this._view,r.elevationAlignedLocation)).next(gi(this._view,r.elevationAlignedLocation,e,n,a)).next(lo(r.location,this.angle+(s+1)*Math.PI*.5)).next(ie());t(r,g,p,c,d)})))}get angle(){return this._angle}set angle(t){this._angle=t,this.dragging?this._updateAfterDrag=!0:this._updateManipulatorTransform()}get displayScale(){return this._scale}set displayScale(t){this._scale=t,this._updateManipulatorTransform()}get radius(){return this._radius}set radius(t){this._radius!==t&&(this._radius=t,this._updateManipulators())}_updateManipulators(){for(let t=0;t<this._arrowManipulatorInfos.length;t++)this._updateArrowManipulator(this._arrowManipulatorInfos[t],t);this._updateManipulatorTransform()}_updateArrowManipulator({manipulator:t,transform:e},n){const a=this._radius/ut,o=is*a,s=o*Math.sqrt(3)/2,r=Ae(this._opaqueMaterial,s,o/2,o/2,Ra);ya(r,wi(F.get(),ct(x.get(),0,-s/3,0))),t.renderObjects=[new w(r,O.Focused),new w(r.instantiate({material:this._transparentMaterial}),O.Unfocused)],t.radius=s/3*2*1.2;const l=tn(F.get(),n*Math.PI/2),p=wi(F.get(),ct(x.get(),0,as*a,0));we(e,l,p)}_createManipulators(){for(let t=0;t<4;t++){const e=this._createArrowManipulator(t);this._arrowManipulatorInfos.push(e)}this._updateManipulatorTransform()}_updateManipulatorTransform(){const t=this.angle,e=ca(F.get(),t,B(0,0,1));if(e==null)return;const n=Oe(F.get(),ct(x.get(),this.displayScale,this.displayScale,this.displayScale)),a=we(F.get(),n,e);for(const o of this._arrowManipulatorInfos){const s=we(F.get(),a,o.transform);o.manipulator.modelTransform=s}}_createArrowManipulator(t){const e=new et({view:this._view,autoScaleRenderObjects:!1,worldOriented:!0,focusMultiplier:1,touchMultiplier:1,collisionType:{type:"disc",direction:B(0,0,1)}}),n={manipulator:e,transform:ke()};return this._updateArrowManipulator(n,t),this._handles.add(e.events.on("drag",a=>{this._updateAfterDrag&&a.action==="end"&&!this.dragging&&(this._updateManipulatorTransform(),this._updateAfterDrag=!1)})),n}_createMaterial(t=1){const e=new _i({cullFace:li.Back,renderOccluded:It.Transparent,isDecoration:!0});return this._handles.add(f(()=>Pe.toUnitRGBA(this._view.effectiveTheme.accentColor),n=>{n[3]*=t,e.setParameters({color:n})},$)),e}get test(){return{arrowManipulators:this._arrowManipulatorInfos.map(({manipulator:t})=>t)}}},ds=class{constructor(){this._view=null,this._elevationInfo=null,this._lastDragEvent=null,this._next=null,this._enabled=!1}get enabled(){return this._enabled}set enabled(t){if(this._enabled!==t&&this._lastDragEvent!=null&&this._next!=null){const e=this._lastDragEvent.mapEnd,n=this._snap(this._lastDragEvent.screenEnd);if(n!=null){const a={action:"update",mapStart:this._lastDragEvent.mapStart,mapEnd:t===!0?n:e,screenStart:this._lastDragEvent.screenEnd,screenEnd:this._lastDragEvent.screenEnd};this._next.execute(a)}}this._enabled=t}_snap(t){const e=this._view!=null?this._view.toMap(t,{exclude:[]}):null;return e!=null&&this._view!=null&&(e.z=Dn(e,this._view,this._elevationInfo)),e}createDragEventPipelineStep(t,e){this._view=t,this._elevationInfo=e,this._lastDragEvent=null;const n=new Oa;return this._next=n,[a=>{if(this._lastDragEvent=a.action!=="end"?{...a}:null,this._enabled){const o=this._snap(a.screenEnd);return o!=null?{action:a.action,mapStart:a.mapStart,mapEnd:o,screenStart:a.screenStart,screenEnd:a.screenEnd}:null}return{action:a.action,mapStart:a.mapStart,mapEnd:a.mapEnd,screenStart:a.screenStart,screenEnd:a.screenEnd}},n]}};class gs extends fe{constructor(t){super(),this._handles=new Ve,this._snapToScene=new ds,this._scale=1,this._radius=ut,this._view=t.view,this._tool=t.tool,this._discMaterial=this._createMaterial(),this._discMaterialTransparent=this._createMaterial(.5),t.snapToScene!=null&&(this.snapToScene=t.snapToScene),t.radius!=null&&(this._radius=t.radius),this._createManipulator(),this.forEachManipulator(e=>this._tool.manipulators.add(e))}destroy(){this._handles=R(this._handles),this.forEachManipulator(t=>{this._tool.manipulators.remove(t),t.destroy()}),this._tool=null,this._view=null,this._manipulator=null}forEachManipulator(t){t(this._manipulator,G.TRANSLATE_XY)}get displayScale(){return this._scale}set displayScale(t){this._scale=t,this._updateManipulatorTransform()}get snapToScene(){return this._snapToScene.enabled}set snapToScene(t){this._snapToScene.enabled=t}get radius(){return this._radius}set radius(t){t!==this._radius&&(this._radius=t,this._updateManipulator())}createGraphicDragPipeline(t,e,n){const a=e.graphic,o=z(a),s=a.geometry.spatialReference;return je(a,n,r=>this.createDragPipeline((l,p,c,d,g)=>({steps:p,cancel:c}=t(l,p,c,d,g),r(l,p,c)),o,s,a),this._view.state.viewingMode)}createDragPipeline(t,e,n,a){const o=this._view;return rt(this._manipulator,(s,r,l,p,c)=>{const d=r.next(pe(o,s.elevationAlignedLocation)).next(gi(o,s.elevationAlignedLocation,e,n,a)).next(...this._snapToScene.createDragEventPipelineStep(o,e)).next(g=>({...g,manipulatorType:G.TRANSLATE_XY})).next(ie());t(s,d,l,p,c)})}_updateManipulatorTransform(){const t=Oe(F.get(),ct(x.get(),this.displayScale,this.displayScale,this.displayScale));this._manipulator.modelTransform=t}_createManipulator(){const t=this._view;this._manipulator=new et({view:t,worldSized:!1,autoScaleRenderObjects:!1,focusMultiplier:1,touchMultiplier:1,collisionType:{type:"disc",direction:B(0,0,1)},worldOriented:!0}),this._updateManipulator()}_updateManipulator(){const t=Vn(this._discMaterial,Ra,1,$a,B(0,0,1),B(0,0,0));t.transformation=Oe(ke(),B(this._radius,this._radius,this._radius)),this._manipulator.renderObjects=[new w(t,O.Focused),new w(t.instantiate({material:this._discMaterialTransparent}),O.Unfocused)],this._manipulator.radius=es*(this._radius/ut)}_createMaterial(t=1){const e=new _i({cullFace:li.Back,renderOccluded:It.Transparent,isDecoration:!0});return this._handles.add(f(()=>Pe.toUnitRGBA(this._view.effectiveTheme.accentColor),n=>{n[3]*=t,e.setParameters({color:n})},$)),e}get test(){return{discManipulator:this._manipulator}}}class ms extends fe{constructor(t){super(),this._radius=ut,this.events=new $t,this._tool=t.tool,this._view=t.view;const e=new Zt({getTheme:()=>this._view.effectiveTheme});this._settings=e,t.radius!=null&&(this._radius=t.radius);const n=this._view.effectiveTheme.accentColor;this._materials={materialUnfocused:Mt(this._createDarkenedColor(n,1,.25),It.Occlude),materialFocused:Mt(this._createDarkenedColor(n,1,0),It.Occlude),materialOccludedUnfocused:Mt(this._createDarkenedColor(n,.7,0),e.zManipulator.renderOccluded),materialOccludedFocused:Mt(this._createDarkenedColor(n,.85,0),e.zManipulator.renderOccluded)},this._themeHandle=f(()=>this._view.effectiveTheme.accentColor,a=>{const o=this._createDarkenedColor(a,1,.25),s=this._createDarkenedColor(a,1,0),r=this._createDarkenedColor(a,.7,0),l=this._createDarkenedColor(a,.85,0),{materialUnfocused:p,materialFocused:c,materialOccludedUnfocused:d,materialOccludedFocused:g}=this._materials;p.setParameters({color:o}),c.setParameters({color:s}),d.setParameters({color:r}),g.setParameters({color:l})}),this._createManipulator(),this.forEachManipulator(a=>this._tool.manipulators.add(a))}destroy(){this._themeHandle=gt(this._themeHandle),this._manipulator.applyObjectTransform=vs,this.forEachManipulator(t=>{this._tool.manipulators.remove(t),t.destroy()})}forEachManipulator(t){t(this._manipulator,G.TRANSLATE_Z)}createGraphicDragPipeline(t,e,n){const a=e.graphic.geometry.spatialReference;return je(e.graphic,n,o=>this.createDragPipeline((s,r,l,p,c)=>({steps:r,cancel:l}=t(s,r,l,p,c),o(s,r,l)),a),this._view.state.viewingMode)}createDragPipeline(t,e){const n=this._view;return rt(this._manipulator,(a,o,s,r,l)=>{const p=o.next(c=>({...c,manipulatorType:G.TRANSLATE_Z})).next(wa(n,a.renderLocation,e)).next(ie());t(a,p,s,r,l)})}get radius(){return this._radius}set radius(t){t!==this._radius&&(this._radius=t,this._updateManipulator())}_updateManipulator(){const t=this._settings,e=this._radius/ut,n=t.zManipulator.height*e,a=t.zManipulator.coneHeight*e,o=t.zManipulator.coneWidth*e,s=t.zManipulator.width*e,r=[B(0,0,0),B(0,0,n)],l=[B(0,0,0),B(0,0,n+a)],p=b=>{const M=ke();if(nn(M,M,[0,0,n]),ua(M,M,Math.PI/2),b){const T=1+2*b/o;da(M,M,[T,T,T])}return M},c=p(0),{materialUnfocused:d,materialFocused:g,materialOccludedUnfocused:m,materialOccludedFocused:_}=this._materials,v=kn(d,r,s/2,16,!1),y=Un(d,a,o/2,16,!1);y.transformation=c,this._manipulator.renderObjects=[new w(y,O.Unfocused),new w(v,O.Unfocused),new w(y.instantiate({material:g}),O.Focused),new w(v.instantiate({material:g}),O.Focused),new w(y.instantiate({material:m}),O.Unfocused),new w(v.instantiate({material:m}),O.Unfocused),new w(y.instantiate({material:_}),O.Focused),new w(v.instantiate({material:_}),O.Focused)],this._manipulator.radius=s/2+2,this._manipulator.collisionType={type:"line",paths:[l]}}_createManipulator(){const t=this._view,e=new et({view:t,autoScaleRenderObjects:!1,worldSized:!1,selectable:!1,cursor:"ns-resize",elevationInfo:this.elevationInfo,worldOriented:!0,collisionPriority:1.6});e.applyObjectTransform=n=>{const a=t.state.camera,o=Wi;t.renderCoordsHelper.toRenderCoords(this._manipulator.elevationAlignedLocation,o);const s=en(a.eye,o),r=a.computeRenderPixelSizeAtDist(s),l=L(Wt,o,a.eye);ei(l,l);const p=_s;t.renderCoordsHelper.worldUpAtPosition(Wi,p);const c=Math.abs(Ee(l,p)),d=Dt(Wt,l,p),g=Dt(Wt,d,p),m=ii(c,.01,1),_=1-Math.sqrt(1-m*m)/m/a.fullWidth,v=this._settings,y=this._radius/ut,b=v.zManipulator.width*y;Vt(g,ei(g,g),(1/_-1)*s+r*b),n[12]-=Wt[0],n[13]-=Wt[1],n[14]-=Wt[2]},this._manipulator=e,this._updateManipulator()}_createDarkenedColor(t,e,n){const a=an(t,n);return a.a*=e,Pe.toUnitRGBA(a)}get test(){return{manipulator:this._manipulator}}}const Wi=H(),Wt=H(),_s=H(),vs=()=>{};let Ut=class extends fe{constructor(t){super(),this._handles=new Ve,this._interactive=!0;const{tool:e,view:n,snapToScene:a,radius:o}=t;this._view=n,this.xyManipulation=new gs({tool:e,view:n,snapToScene:a,radius:o}),this.xyAxisManipulation=new us({tool:e,view:n,radius:o}),this.zManipulation=new ms({tool:e,view:n,radius:o}),this.xyManipulation.available=t.xyAvailable,this.xyAxisManipulation.available=t.xyAxisAvailable,this.zManipulation.available=t.zAvailable,this._autoHideXYAxis(),this.forEachManipulator(s=>this._handles.add(s.events.on("grab-changed",()=>this._updateManipulatorInteractivity())))}destroy(){this._handles.destroy(),this.xyManipulation.destroy(),this.xyAxisManipulation.destroy(),this.zManipulation.destroy()}createGraphicDragPipeline(t,e,n){return Z([this.xyManipulation.createGraphicDragPipeline((a,o,s,r,l)=>t(S.XY,a,o,s,r,l),e,n),this.xyAxisManipulation.createGraphicDragPipeline((a,o,s,r,l)=>t(S.XY_AXIS,a,o,s,r,l),e,n),this.zManipulation.createGraphicDragPipeline((a,o,s,r,l)=>t(S.Z,a,o,s,r,l),e,n)])}createDragPipeline(t,e,n,a){return Z([this.xyManipulation.createDragPipeline((o,s,r,l,p)=>t(S.XY,o,s,r,l,p),e,n,a),this.xyAxisManipulation.createDragPipeline((o,s,r,l,p)=>t(S.XY_AXIS,o,s,r,l,p),e,n,a),this.zManipulation.createDragPipeline((o,s,r,l,p)=>t(S.Z,o,s,r,l,p),n)])}set snapToScene(t){this.xyManipulation.snapToScene=t}set angle(t){this.xyAxisManipulation.angle=t}set interactive(t){this._interactive!==t&&(this._interactive=t,this._updateManipulatorInteractivity())}set radius(t){this.xyAxisManipulation.radius=t,this.xyManipulation.radius=t,this.zManipulation.radius=t}set displayScale(t){this.xyManipulation.displayScale=t,this.xyAxisManipulation.displayScale=t}forEachManipulator(t){this.xyManipulation.forEachManipulator(e=>t(e,G.TRANSLATE_XY)),this.xyAxisManipulation.forEachManipulator(e=>t(e,G.TRANSLATE_XY)),this.zManipulation.forEachManipulator(e=>t(e,G.TRANSLATE_Z))}get _xyAxisVisible(){const t=this.xyManipulation.someManipulator(e=>e.focused)||this.xyAxisManipulation.someManipulator(e=>e.focused);return this._view.inputManager&&this._view.inputManager.latestPointerType==="touch"||t}_autoHideXYAxis(){const t=this.xyAxisManipulation,e=this.xyManipulation;if(on("esri-mobile"))return;const n=[];e.forEachManipulator(o=>n.push(o)),t.forEachManipulator(o=>n.push(o));const a=()=>{const o=[];this._xyAxisVisible||t.forEachManipulator(s=>o.push(s.disableDisplay())),this._handles.remove(Ki),this._handles.add(o,Ki)};for(const o of n)this._handles.add(o.events.on("focus-changed",a));this._view.inputManager&&this._handles.add(Xt(()=>{var o;return(o=this._view.inputManager)==null?void 0:o.latestPointerType},a)),a()}_updateManipulatorInteractivity(){const t=this.grabbing;this.forEachManipulator(e=>{e.interactive=!t&&this._interactive||e.grabbing})}static radiusForSymbol(t){const e=t!=null&&t.type==="point-3d"&&t.symbolLayers;return e&&e.some(n=>n.type==="icon")?Ca:ut}};const Ki="disable-xy-axis-display";var S;(function(i){i[i.XY=0]="XY",i[i.XY_AXIS=1]="XY_AXIS",i[i.Z=2]="Z"})(S||(S={}));class bi extends fe{constructor(t){super(),this._view=t.view,this._tool=t.tool,this._graphicState=t.graphicState,this._createManipulator(),this.forEachManipulator(e=>this._tool.manipulators.add(e))}destroy(){this.forEachManipulator(t=>{this._tool.manipulators.remove(t),t.destroy()}),this._tool=null,this._view=null,this._manipulator=null,this._graphicState=null}forEachManipulator(t){t(this._manipulator,G.TRANSLATE_XY)}createGraphicDragPipeline(t){return je(this._graphicState.graphic,t,e=>this.createDragPipeline(e),this._view.state.viewingMode)}createDragPipeline(t){const e=this._view,n=this._graphicState.graphic,a=n.geometry!=null?n.geometry.spatialReference:null;return rt(this._manipulator,(o,s,r,l,p)=>{const c=s.next(io(p,e,n,a)).next(Kt()).next(ie());t(o,c,r,l,p)})}_createManipulator(){const t=this._view,e=this._graphicState.graphic;this._manipulator=new uo({graphic:e,view:t,selectable:!0,cursor:"move"})}}let fs=class{constructor(t){this.allGraphics=t,this.type="graphic-move-start"}};class ys{constructor(t,e,n){this.dx=t,this.dy=e,this.allGraphics=n,this.type="graphic-move"}}class Qi{constructor(t){this.allGraphics=t,this.type="graphic-move-stop"}}const lt="manipulators";let dt=class extends $t.EventedMixin(Ye){constructor(i){super(i),this._infos=new Map,this.graphics=new sn,this.enableZ=!0,this.tooltipOptions=new Rt,this.type="move-3d",this._updatingHandles=new di,this._moveManipulation=null,this._tooltip=null,this._translateGraphicTooltipInfo=null,this._translateGraphicXYTooltipInfo=null,this._translateGraphicZTooltipInfo=null}initialize(){const{view:i}=this;this.addHandles([this.graphics.on("change",e=>{e.removed.forEach(n=>this.removeHandles(n)),this._updateGraphicInfos(e),this._setupFastTransformUpdates(e.added),this._refreshManipulators()}),f(()=>this.tooltipOptions.enabled,e=>{this._tooltip=e?new ve({view:i}):R(this._tooltip)},Jt)]);const t=this.graphics.toArray();this._updateGraphicInfos({added:t,removed:[]}),this._setupFastTransformUpdates(t),this._refreshManipulators(),this.finishToolCreation()}destroy(){this._tooltip=R(this._tooltip),this._moveManipulation=R(this._moveManipulation),this._set("view",null),this._updatingHandles.destroy()}get updating(){return this._updatingHandles.updating}reset(){}_updateGraphicInfos({added:i,removed:t}){var e;for(const n of i){if(Qn(n)!==xa.SUPPORTED)continue;const a=new Ms(n),o=this.view.trackGraphicState(a.state);this._infos.set(a.graphic,{info:a,handle:o})}for(const n of t)(e=this._infos.get(n))==null||e.handle.remove(),this._infos.delete(n)}_setupFastTransformUpdates(i){for(const t of i){const{info:e}=this._infos.get(t);this.addHandles(fi(e.state),t)}}_refreshManipulators(){if(this.removeHandles(lt),this._moveManipulation=R(this._moveManipulation),this.manipulators.removeAll(),this._infos.size===0)return;const i=Array.from(this._infos.values(),({info:t})=>t);this._createManipulators(i),this._createVisualElements(i),this._updateMoveManipulation(i)}_createManipulators(i){for(const t of i){const e=t.state;t.manipulationXY=new bi({tool:this,view:this.view,graphicState:e}),t.manipulationXY.forEachManipulator(n=>this.addHandles([n.events.on("immediate-click",a=>{this.emit("immediate-click",{...a,graphic:e.graphic}),a.stopPropagation()}),n.events.on("grab-changed",({action:a})=>{const{tooltipOptions:o,_tooltip:s}=this;s!=null&&(a==="start"?(this._translateGraphicTooltipInfo??(this._translateGraphicTooltipInfo=new ge({tooltipOptions:o})),s.info=this._translateGraphicTooltipInfo,s.info.tooltipOptions=o,s.info.distance=ht):s.clear())})],lt)),this.addHandles(t.manipulationXY.createDragPipeline((n,a,o,s)=>this._buildDragEventPipeline(i,S.XY,n,a,o,s)),lt)}this._createMoveManipulation(i)}_createMoveManipulation(i){const t=new Ut({tool:this,view:this.view,snapToScene:!1,xyAvailable:!0,xyAxisAvailable:!0,zAvailable:!0,radius:i.length===1?Ut.radiusForSymbol(i[0].graphic.symbol):ut});this._moveManipulation=t,t.elevationInfo={mode:"absolute-height",offset:0},t.forEachManipulator(o=>{this.addHandles(o.events.on("immediate-click",s=>{t.zManipulation.hasManipulator(o)||this.graphics.length!==1||this.emit("immediate-click",{...s,graphic:this.graphics.at(0)}),s.stopPropagation()}),lt)});const e=o=>s=>{this.addHandles(s.events.on("focus-changed",({action:r})=>{const l=this._tooltip;l!=null&&(r==="focus"?this._updateMoveTooltip(i,o):l.clear())}),lt)};this._moveManipulation.xyManipulation.forEachManipulator(e(S.XY)),this._moveManipulation.xyAxisManipulation.forEachManipulator(e(S.XY_AXIS)),this._moveManipulation.zManipulation.forEachManipulator(e(S.Z));const n=()=>this._updateMoveManipulation(i);for(const o of i)this.addHandles([o.state.on("changed",n),f(()=>o.state.displaying,n)],lt);const a=i[i.length-1];this.addHandles(a.state.on("changed",()=>this._updateMoveManipulationAngle(a)),lt),this.addHandles(t.createDragPipeline((o,s,r,l,p)=>this._buildDragEventPipeline(i,o,s,r,l,p),z(a.graphic),a.graphic.geometry.spatialReference,a.graphic),lt),this._updateMoveManipulationAngle(a)}_createVisualElements(i){for(const t of i){const e=t.graphic,n=Be({view:this.view,graphic:e,forEachManipulator:a=>{var o,s;(o=t.manipulationXY)==null||o.forEachManipulator(a),(s=this._moveManipulation)==null||s.forEachManipulator(a)},onManipulatorsChanged:()=>Y()});n!=null&&(t.geometryRepresentation=n.visualElement,t.geometryRepresentation instanceof Nt&&this.addHandles([t.geometryRepresentation.events.on("attachment-origin-changed",()=>{t.state.isDraped||this._updateMoveManipulation(i)}),f(()=>t.state.isDraped,()=>this._updateMoveManipulation(i))],lt),this.addHandles(n,lt))}}_updateMoveManipulationAngle(i){this._moveManipulation&&(this._moveManipulation.angle=yi(i.graphic.geometry))}_updateMoveManipulation(i){const t=Ne(0,0,0,this.view.spatialReference);let e=0,n=!1;const a=this._moveManipulation;if(a){for(const o of i){if(!o.state.displaying)continue;const s=o.state.graphic;this.enableZ&&kt(s)&&(n=!0);const r=o.geometryRepresentation instanceof Nt&&!o.state.isDraped?o.geometryRepresentation.attachmentOrigin:Ma(this.view,s);if(r!=null){const{x:l,y:p,z:c}=r;t.x+=l,t.y+=p,c&&(t.z??(t.z=0),t.z+=c),e++}}e>0?(t.x/=e,t.y/=e,t.z??(t.z=0),t.z/=e,a.location=t,a.xyManipulation.available=!0,a.xyAxisManipulation.available=!0,a.zManipulation.available=n):a.available=!1}}_buildDragEventPipeline(i,t,e,n,a,o){const s=[],r=[];let l=null,p=null;const c=()=>{for(const d of s)d.dragging=!1;s.length=0,r.length=0,l=null,p=null,this._moveManipulation&&(this._moveManipulation.interactive=!0)};if(i.length===1&&t===S.XY){const d=i[0].graphic;({steps:n,cancel:a}=this._buildSnappingPipelineSteps(d,z(d),n,a,o))}return a=a.next(d=>p==null?void 0:p(d)).next(()=>(this.emit("graphic-move-stop",new Qi(r)),this.destroyed||c(),null)),{steps:n=n.next(d=>{var g,m;if(d.action==="start"){s.length=0,r.length=0;for(const _ of i)_.dragging||!((g=_.manipulationXY)!=null&&g.hasManipulator(e))&&((m=_.manipulationXY)!=null&&m.grabbing)||(s.push(_),r.push(_.graphic),_.dragging=!0);if(r.length!==0&&(this._moveManipulation&&(this._moveManipulation.interactive=!1),l=po(r,this.view.state.viewingMode),p=ho(r),this.emit("graphic-move-start",new fs(r)),this.destroyed))return null}return r.length!==0?d:null}).next(d=>l==null?void 0:l(d)).next(d=>(this._updateMoveTooltip(i,t,d),d)).next(d=>{switch(d.action){case"start":case"update":if(d.translationX||d.translationY||d.translationZ){const g=this.view.toScreen(d.mapStart),m=this.view.toScreen(d.mapEnd),_=m.x-g.x,v=m.y-g.y;if(this.emit("graphic-move",new ys(_,v,r)),this.destroyed)return null}break;case"end":if(this.emit("graphic-move-stop",new Qi(r)),this.destroyed)return null;c()}return null}),cancel:a}}_updateMoveTooltip(i,t,e){const{tooltipOptions:n,_tooltip:a}=this;if(a==null)return;a.clear();const o=i.length===0?"absolute-height":i[0].state.isDraped?"on-the-ground":"absolute-height";switch(t){case S.XY:a.info=this._translateGraphicTooltipInfo??(this._translateGraphicTooltipInfo=new ge({tooltipOptions:n})),this._updateMoveTooltipDistance(a.info,e,(s,r)=>bt(s,r,o));break;case S.XY_AXIS:a.info=this._translateGraphicXYTooltipInfo??(this._translateGraphicXYTooltipInfo=new vi({tooltipOptions:n})),this._updateMoveTooltipDistance(a.info,e,(s,r)=>{const l=bt(s,r,o);return Ge(l,Le(e))});break;case S.Z:a.info=this._translateGraphicZTooltipInfo??(this._translateGraphicZTooltipInfo=new Fe({tooltipOptions:n})),this._updateMoveTooltipDistance(a.info,e,Re)}a.info.tooltipOptions=n}_updateMoveTooltipDistance(i,t,e){if(t!=null&&t.action!=="end"){const{mapStart:n,mapEnd:a}=t,o=e(n,a);i.distance=o??ht}else i.distance=ht}_buildSnappingPipelineSteps(i,t,e,n,a){const o=i.geometry;if(o==null||o.type!=="point"&&o.type!=="mesh")return{steps:e,cancel:n};const s=(o.type==="point"?o:o.anchor).clone(),r=new Ie({elevationInfo:t,pointer:a,editGeometryOperations:Ze.fromGeometry(s,this.view.state.viewingMode),visualizer:new ue,excludeFeature:i}),l=this.snappingManager,{snappingStep:p,cancelSnapping:c}=$e({snappingContext:r,snappingManager:l,updatingHandles:this._updatingHandles});return n=n.next(c),{steps:e=e.next(d=>(s.z=In(this.view,s,z(i),{mode:"absolute-height",offset:0}),{...d,snapOrigin:r.coordinateHelper.pointToVector(s)})).next(...p),cancel:n}}get test(){return{tooltip:this._tooltip}}};h([u({constructOnly:!0,nonNullable:!0})],dt.prototype,"view",void 0),h([u()],dt.prototype,"graphics",void 0),h([u({constructOnly:!0,nonNullable:!0})],dt.prototype,"enableZ",void 0),h([u({constructOnly:!0,type:Rt})],dt.prototype,"tooltipOptions",void 0),h([u({constructOnly:!0})],dt.prototype,"snappingManager",void 0),h([u()],dt.prototype,"type",void 0),h([u()],dt.prototype,"updating",null),dt=h([V("esri.views.3d.interactive.editingTools.graphicMove3D.GraphicMoveTool")],dt);class Ms{constructor(t){this.geometryRepresentation=null,this.manipulationXY=null,this.dragging=!1,this.state=new Ft({graphic:t})}get graphic(){return this.state.graphic}}function Ji(i,t,e){const n=e.mode==="on-the-ground"?zi.XY:zi.XYZ;return new go(i,n,t,0)}function ta(i,t,e){const n=H();if(!i.renderCoordsHelper.toRenderCoords(t,n))return null;const a=ea(i,t,_e(e.plane)),o=ea(i,t,e.edgeDirection);if(a==null||o==null)return null;const s=Dt(H(),a,o);return ga(n,s,pi())}function ea(i,t,e){const n=Ne(t.x+e[0],t.y+e[1],t.z+e[2],t.spatialReference),a=H(),o=H();return i.renderCoordsHelper.toRenderCoords(t,a)&&i.renderCoordsHelper.toRenderCoords(n,o)?ma(o,a,o):null}function bs(i,t,e){const n=_e(i),a=ma(H(),t,e),o=Dt(H(),a,n),s=Dt(H(),a,o);return rn(a[0],a[1],a[2],0,o[0],o[1],o[2],0,s[0],s[1],s[2],0,0,0,0,1)}function Ss(i,t,e){const n=e.projectToRenderScreen(i,Oi()),a=e.projectToRenderScreen(t,Oi());return n!=null&&a!=null?ln(L(n,n,a)):0}let Tt=class extends Ue{constructor(t){super(t),this.type="reshape-edge-offset",this.distance=ht,this.area=null,this.totalLength=null}};h([u()],Tt.prototype,"type",void 0),h([u()],Tt.prototype,"distance",void 0),h([u()],Tt.prototype,"area",void 0),h([u()],Tt.prototype,"totalLength",void 0),Tt=h([V("esri.views.interactive.tooltip.ReshapeEdgeOffsetTooltipInfo")],Tt);let C=class extends $t.EventedMixin(Yt){constructor(t){super(t),this._selectedIndex=0,this._manipulatorHandles=new Ve,this._manipulatorInfos=[],this._numGrabbing=0,this._numDragging=0,this._reshapeEventState=I.NONE,this._updatingHandles=new di,this._recreatingManipulators=!1,this._settings=new Zt({getTheme:()=>this.view.effectiveTheme}),this._translateGraphicTooltipInfo=null,this._translateGraphicXYTooltipInfo=null,this._translateGraphicZTooltipInfo=null,this._translateVertexTooltipInfo=null,this._translateVertexXYTooltipInfo=null,this._translateVertexZTooltipInfo=null,this._edgeOffsetTooltipInfo=null,this.outputGeometry=null,this._vertexLaserLineVisualElement=null}initialize(){const{graphic:t,view:e}=this,n=this._settings.manipulators,a=n.vertex;this._vertexManipulatorMaterial=Mt(N(a.color),a.renderOccluded),this._vertexManipulatorOutlineMaterial=ne(N(a.outlineColor),a.renderOccluded),this._vertexManipulatorHoverOutlineMaterial=ne(N(a.hoverOutlineColor),a.renderOccluded);const o=n.edge;this._edgeManipulatorMaterial=Mt(N(o.color),o.renderOccluded),this._edgeManipulatorOutlineMaterial=ne(N(o.outlineColor),o.renderOccluded);const s=n.edgeOffset;this._edgeOffsetManipulatorMaterial=Mt(N(s.color),s.renderOccluded,!1),this._edgeOffsetManipulatorHoverMaterial=Mt(N(s.hoverColor),s.renderOccluded,!1);const r=n.selected;this._selectedManipulatorMaterial=Mt(N(r.color),r.renderOccluded),this._selectedManipulatorOutlineMaterial=ne(N(r.outlineColor),r.renderOccluded),this._selectedManipulatorHoverOutlineMaterial=ne(N(r.hoverOutlineColor),r.renderOccluded);const l=this._graphicState=new Ft({graphic:t});this._tooltip=new ve({view:e}),this.addHandles([f(()=>{const p=this._settings.manipulators;return{vertexSettings:p.vertex,edgeSettings:p.edge,edgeOffsetSettings:p.edgeOffset,selectedSettings:p.selected}},({vertexSettings:p,edgeSettings:c,edgeOffsetSettings:d,selectedSettings:g})=>{p.applyColor(this._vertexManipulatorMaterial),p.applyOutline(this._vertexManipulatorOutlineMaterial),p.applyHoverOutline(this._vertexManipulatorHoverOutlineMaterial),c.applyColor(this._edgeManipulatorMaterial),c.applyOutline(this._edgeManipulatorOutlineMaterial),d.applyColor(this._edgeOffsetManipulatorMaterial),d.applyHover(this._edgeOffsetManipulatorHoverMaterial),g.applyColor(this._selectedManipulatorMaterial),g.applyOutline(this._selectedManipulatorOutlineMaterial),g.applyHoverOutline(this._selectedManipulatorHoverOutlineMaterial)}),f(()=>l.displaying,p=>{for(const c of this._manipulatorInfos)c.manipulator.available=p}),f(()=>({labels:this._segmentLabels,enabled:this._labelOptions.enabled,edgeOffsetEnabled:this.enableEdgeOffset}),({labels:p,enabled:c,edgeOffsetEnabled:d})=>{p!=null&&(p.visible=c,p.edgeDistance=d?"far":"default")},$),Xt(()=>!this._tooltipOptions.enabled,()=>this._tooltip.clear(),$),this.view.trackGraphicState(l)])}destroy(){this._segmentLabels=R(this._segmentLabels),this._tooltip=R(this._tooltip),this._removeManipulators(),this._updatingHandles.destroy()}get inputGeometry(){return this._editGeometryOperations!=null?this._editGeometryOperations.data.geometry:null}set inputGeometry(t){this._recreateEditGeometryAndManipulators(t)}get updating(){return this._updatingHandles.updating}get manipulators(){return this.tool.manipulators}get view(){return this.tool.view}get graphic(){return this.tool.graphic}get enableZShape(){return this.tool.enableZShape}get enableZVertex(){return this.tool.enableZVertex}get enableMoveGraphic(){return this.tool.enableMoveGraphic}get enableMidpoints(){return this.tool.enableMidpoints}get enableEdgeOffset(){return this.tool.enableEdgeOffset}get _labelOptions(){return this.tool.labelOptions}get _tooltipOptions(){return this.tool.tooltipOptions}get _accentColor(){return this.view.effectiveTheme.accentColor}removeSelectedVertices(){const t=this._manipulatorInfos.filter(e=>e.manipulator.selected&&e.type==="vertex");this._removeVertices(t)}onManipulatorSelectionChanged(){this.emit("manipulators-changed")}_removeManipulators(){this._manipulatorHandles.removeAll(),this._moveManipulation=R(this._moveManipulation),this._graphicMoveManipulation=R(this._graphicMoveManipulation),this.manipulators.removeAll(),this._manipulatorInfos=[],this._numGrabbing=0,this._numDragging=0}_createManipulators(t){if(this._editGeometryOperations==null)return;const e=z(this.graphic);for(const n of this._editGeometryOperations.data.components){const a=t==null?void 0:t.byComponentIndex.get(n.index);for(const o of n.vertices){const s=a==null?void 0:a.has(o.index);this._createVertexOrEdgeManipulator(o,e,s)}for(const o of n.edges)this._createVertexOrEdgeManipulator(o,e)}this._createGraphicMoveManipulation(),this._createMoveManipulation(e),this._createVisualElements()}get canRedo(){return this._editGeometryOperations!=null&&this._editGeometryOperations.canRedo}get canUndo(){return this._editGeometryOperations!=null&&this._editGeometryOperations.canUndo}redo(){if(this._editGeometryOperations==null)return null;const t=this._editGeometryOperations.redo();return t!=null&&(this.outputGeometry=this._editGeometryOperations.data.geometry,this._recreateManipulators()),t}undo(){if(this._editGeometryOperations==null)return null;this.emit("undo");const t=this._editGeometryOperations.undo();return t!=null&&(this.outputGeometry=this._editGeometryOperations.data.geometry,this._recreateManipulators()),t}_recreateManipulators(){this._recreatingManipulators||(this._recreatingManipulators=!0,this._removeManipulators(),this._tooltip.clear(),this._createManipulators(),this._recreatingManipulators=!1)}_recreateEditGeometryAndManipulators(t){const e={byComponentIndex:new Map};if(t!=null&&this.inputGeometry!=null&&pn(t,this.inputGeometry)){for(const a of this._manipulatorInfos)if(a.type==="vertex"&&a.manipulator.selected){const{index:o,component:{index:s}}=a.handle,{byComponentIndex:r}=e,l=r.get(s)||new Set;l.add(o),r.set(s,l)}}if(this._recreatingManipulators=!0,this._removeManipulators(),this._tooltip.clear(),this._editGeometryOperations=R(this._editGeometryOperations),this._segmentLabels=R(this._segmentLabels),t==null)return void(this._recreatingManipulators=!1);const n=t.type==="mesh"?t.anchor:t;this._editGeometryOperations=Ze.fromGeometry(n,this.view.state.viewingMode),this._createManipulators(e),this._segmentLabels=new Ce({context:{view:this.view,editGeometryOperations:this._editGeometryOperations,elevationInfo:z(this.graphic),labelOptions:this._labelOptions,graphic:this.graphic,graphicState:this._graphicState},visible:this._labelOptions.enabled}),this._recreatingManipulators=!1}_perGraphicManipulatorDragAction(t,e){if(e.action==="end")return e;let n=0;const a=[],o=this._manipulatorInfos.some(r=>r.type==="vertex"&&r.manipulator.selected),s=t===Qt.SELECTED_OR_ALL&&o;for(const r of this._manipulatorInfos)r.type==="vertex"&&(r.manipulator.grabbing||s&&!r.manipulator.selected||a.push(r),n++);if(a.length===0)return e;if(this._moveVertices(a,e),a.length===n){if(this._updateEventState(I.MOVING),this.destroyed)return e;this.emit("move",{type:"move",dx:e.screenDeltaX,dy:e.screenDeltaY,mover:this.graphic})}else{if(this._updateEventState(I.RESHAPING),this.destroyed)return e;this.emit("reshape",{type:"reshape",mover:this.graphic})}return e}_isMultiVertexSelection(){return this._manipulatorInfos.reduce((t,e)=>e.type==="vertex"&&e.manipulator.selected?t+1:t,0)>1}_perVertexManipulatorDragAction(t){if(this._updateEventState(I.RESHAPING),this.destroyed)return;const{mapDeltaX:e,mapDeltaY:n,mapDeltaZ:a}=t;if(!e&&!n&&!a)return;const o=[];for(const s of this._manipulatorInfos)s.type==="vertex"&&(s.manipulator.selected&&!s.manipulator.grabbing||s===t.info)&&o.push(s);this._moveVertices(o,t,St.ACCUMULATE_STEPS),this.emit("reshape",{type:"reshape",mover:this.graphic})}_updateEventState(t){if(t===this._reshapeEventState)return!1;switch(t){case I.NONE:if(this._numGrabbing!==0||this._numDragging!==0)return!1;switch(this._reshapeEventState){case I.MOVING:this.emit("move",{type:"move-stop",dx:0,dy:0,mover:this.graphic});break;case I.RESHAPING:this.emit("reshape",{type:"reshape-stop",mover:this.graphic})}break;case I.MOVING:switch(this._reshapeEventState){case I.NONE:this.emit("move",{type:"move-start",dx:0,dy:0,mover:this.graphic});break;case I.RESHAPING:this.emit("reshape",{type:"reshape-stop",mover:this.graphic}),this.destroyed||this.emit("move",{type:"move-start",dx:0,dy:0,mover:this.graphic})}break;case I.RESHAPING:switch(this._reshapeEventState){case I.NONE:this.emit("reshape",{type:"reshape-start",mover:this.graphic});break;case I.MOVING:this.emit("move",{type:"move-stop",dx:0,dy:0,mover:this.graphic}),this.destroyed||this.emit("reshape",{type:"reshape-start",mover:this.graphic})}}if(this.destroyed)return!1;const e=this._reshapeEventState!==t;return this._reshapeEventState=t,e}_createGraphicMoveManipulation(){const{tool:t,view:e}=this,n=this._graphicState;if(this._graphicMoveManipulation=new bi({tool:t,view:e,graphicState:n}),this.enableMoveGraphic){let a=null;this._manipulatorHandles.add(this._graphicMoveManipulation.createDragPipeline((o,s,r)=>{s.next(l=>this._trackNumDragging(l)).next(l=>(l.action==="start"&&(a=this._editGeometryOperations.createUndoGroup()),l)).next(l=>this._perGraphicManipulatorDragAction(Qt.ALL,l)).next(l=>(this._updateTranslateGraphicTooltip(S.XY,l),l)).next(l=>{l.action==="end"&&(this._tooltip.clear(),a=gt(a))}),r.next(()=>this._onDragCancel(!0,()=>a=gt(a)))})),this._graphicMoveManipulation.forEachManipulator(o=>this._manipulatorHandles.add(this._watchAndUpdateGrabState(o,!1)))}else this._graphicMoveManipulation.forEachManipulator(a=>{a.grabbable=!1,a.cursor=null});this._graphicMoveManipulation.forEachManipulator(a=>this._manipulatorHandles.add(a.events.on("immediate-click",o=>{this._manipulatorInfos.some(s=>s.manipulator.selected)?this._clearSelection():this.emit("immediate-click",{...o,graphic:this.graphic}),o.stopPropagation()})))}_createMoveManipulation(t){const{graphic:e,tool:n,view:a}=this,o=this._graphicState;this._moveManipulation=new Ut({tool:n,view:a,xyAvailable:!0,xyAxisAvailable:!0,zAvailable:this.enableZShape&&kt(e),snapToScene:!1,radius:Ut.radiusForSymbol(e.symbol)}),this._moveManipulation.forEachManipulator(l=>this.addHandles([l.events.on("immediate-click",p=>{this._moveManipulation.zManipulation.hasManipulator(l)||this._manipulatorInfos.some(c=>c.manipulator.selected)||this.emit("immediate-click",{...p,graphic:e}),p.stopPropagation()}),this._watchAndUpdateGrabState(l,!1)]));const s=l=>p=>{this.addHandles(p.events.on("focus-changed",({action:c})=>{c==="focus"&&this._tooltipOptions.enabled?this._updateTranslateTooltip(l):this._tooltip.clear()}))};this._moveManipulation.xyManipulation.forEachManipulator(s(S.XY)),this._moveManipulation.xyAxisManipulation.forEachManipulator(s(S.XY_AXIS)),this._moveManipulation.zManipulation.forEachManipulator(s(S.Z)),this._moveManipulation.elevationInfo={mode:"absolute-height",offset:0};const r=e.geometry.spatialReference;this.addHandles([this._moveManipulation.createDragPipeline((l,p,c,d,g)=>{const{snappingStep:m,cancelSnapping:_}=$e({predicate:v=>!!v.info,snappingManager:n.snappingManager,snappingContext:new Ie({editGeometryOperations:this._editGeometryOperations,elevationInfo:t,pointer:g,excludeFeature:e,visualizer:new ue}),updatingHandles:this._updatingHandles,useZ:!1});return d=d.next(v=>(this._onDragCancel(),v)).next(_),{steps:c=c.next(v=>this._trackNumDragging(v)).next(v=>{const y=this._manipulatorInfos.filter(b=>b.type==="vertex"&&b.manipulator.selected);return v.manipulatorType===G.TRANSLATE_XY&&y.length===1?{...v,info:y[0],snapOrigin:y[0].handle.pos}:v}).next(Pi(this.view,t,e)).next(...m).next(Kt()).next(v=>this._perGraphicManipulatorDragAction(Qt.SELECTED_OR_ALL,v)).next(v=>(this._updateTranslateTooltip(l,v),v)),cancel:d}},t,r,e),f(()=>o.displaying,()=>this._updateMoveManipulationPosition(),$),o.on("changed",()=>{this._recreatingManipulators||this._updateMoveManipulationPosition()}),f(()=>o.isDraped,l=>{this._updateMoveManipulationPosition();const p="align-move-manipulation";l?this.addHandles(this.view.elevationProvider.on("elevation-change",()=>this._updateMoveManipulationPosition()),p):this.removeHandles(p)},$)])}_createVisualElements(){const{graphic:t,view:e}=this,n=Be({view:e,graphic:t,forEachManipulator:a=>{if(!this.destroyed&&!this._recreatingManipulators){this._graphicMoveManipulation.forEachManipulator(a),this._moveManipulation.forEachManipulator(a);for(const o of this._manipulatorInfos)a(o.manipulator,G.TRANSLATE_XY)}},onManipulatorsChanged:a=>this.on("manipulators-changed",a)});n!=null&&(this._outlineVisualElement=n.visualElement instanceof Nt?n.visualElement:null),this._outlineVisualElement!=null&&this._manipulatorHandles.add(this._outlineVisualElement.events.on("attachment-origin-changed",()=>{this._graphicState.isDraped||this._updateMoveManipulationPosition()})),this._manipulatorHandles.add(n)}_createEdgeOffsetManipulator(t,e=z(this.graphic)){var _,v;const n=this._settings.manipulators.edgeOffset,a=n.size/2,o=a+n.collisionPadding,s=a/o,r=s*Math.sqrt(3)/2;this._edgeOffsetManipulatorGeometryInside==null&&(this._edgeOffsetManipulatorGeometryInside=Ae(this._edgeOffsetManipulatorMaterial,r,s/2,s/2,n.height,n.offset)),this._edgeOffsetManipulatorGeometryOutside==null&&(this._edgeOffsetManipulatorGeometryOutside=Ae(this._edgeOffsetManipulatorMaterial,-r,s/2,s/2,n.height,-n.offset));const l=[new w(this._edgeOffsetManipulatorGeometryInside.instantiate(),O.Unfocused),new w(this._edgeOffsetManipulatorGeometryInside.instantiate({material:this._edgeOffsetManipulatorHoverMaterial}),O.Focused),new w(this._edgeOffsetManipulatorGeometryOutside.instantiate(),O.Unfocused),new w(this._edgeOffsetManipulatorGeometryOutside.instantiate({material:this._edgeOffsetManipulatorHoverMaterial}),O.Focused)],p=new et({view:this.view,renderObjects:l,elevationInfo:e.mode!=="on-the-ground"||Ei(this.graphic.symbol)?{mode:"absolute-height",offset:0}:e,worldOriented:!1,focusMultiplier:1,radius:o,available:!(!this.graphic.visible||!((_=this.graphic.layer)!=null&&_.visible)),collisionType:{type:"disc",direction:B(0,0,1)},collisionPriority:1,metadata:{deleting:!1}}),c=new et({view:this.view,worldSized:!0,worldOriented:!1,available:!(!this.graphic.visible||!((v=this.graphic.layer)!=null&&v.visible)),collisionPriority:-10,cursor:this.enableMoveGraphic?"move":"default",metadata:{deleting:!1}}),d={manipulator:p,handle:t,locationUpdateHandle:null,type:"edge",selectedIndex:0,edgeManipulator:c,elevationInfo:e,visibilityHandle:null};this._autoHideEdgeOffsetManipulator(d,n.minSquaredEdgeLength),this._updateEdgeOffsetManipulator(d);const g=[];for(const y of[d.handle.leftVertex,d.handle.rightVertex]){const b=this._getManipulatorInfoFromHandle(y);b!=null&&g.push(b.manipulator.events.on("location-update",()=>this._updateEdgeOffsetManipulator(d)))}d.locationUpdateHandle=Z(g),this._manipulatorHandles.add(d.locationUpdateHandle,p),this._manipulatorHandles.add([this._watchAndUpdateGrabState(p,!0),this._watchAndUpdateGrabState(c,!0)],p),this._manipulatorHandles.add(rt(p,this._createEdgeOffsetPipeline(d,e)),p),this._manipulatorHandles.add(rt(c,(y,b,M,T)=>{if(T==="touch")this._createEdgeOffsetPipeline(d,e)(y,b,M);else if(this.enableMoveGraphic){const D=this.graphic,X=D.geometry!=null?D.geometry.spatialReference:null;b.next(j=>this._trackNumDragging(j)).next(pe(this.view,y.elevationAlignedLocation)).next(gi(this.view,y.elevationAlignedLocation,e,X,D)).next(ie()).next(Kt()).next(j=>this._perGraphicManipulatorDragAction(Qt.ALL,j)).next(j=>(this._updateTranslateGraphicTooltip(S.XY,j),j)).next(j=>{j.action==="end"&&this._tooltip.clear()}),M.next(()=>this._onDragCancel(!y.metadata.deleting))}}),p);const m=y=>{this._manipulatorInfos.some(b=>b.manipulator.selected)?this._clearSelection():this.emit("immediate-click",{...y,graphic:this.graphic}),y.stopPropagation()};return this._manipulatorHandles.add([p.events.on("immediate-click",m),c.events.on("immediate-click",m),p.events.on("focus-changed",({action:y})=>{const{_tooltipOptions:b,_tooltip:M}=this;y==="focus"&&b.enabled?(M.info=this._edgeOffsetTooltipInfo??(this._edgeOffsetTooltipInfo=new Tt({tooltipOptions:b})),M.info.distance=ht,M.info.tooltipOptions=b,this._updateTooltipAreaOrTotalLength(M.info)):M.clear()})],p),this._manipulatorInfos.push(d),this.manipulators.add(p),this.manipulators.add(c),this.emit("manipulators-changed"),d}_autoHideEdgeOffsetManipulator(t,e){const n=t.manipulator,a=t.edgeManipulator,o=()=>{t.visibilityHandle=gt(t.visibilityHandle);const s=this._getManipulatorInfoFromHandle(t.handle.leftVertex),r=this._getManipulatorInfoFromHandle(t.handle.rightVertex),l=s!=null&&r!=null&&Ss(s.manipulator.renderLocation,r.manipulator.renderLocation,this.view.state.camera)<e;(!n.focused&&!a.focused||l)&&(n.grabbable=!l,a.grabbable=!l,t.visibilityHandle=Z([n.disableDisplay(),Y(()=>{n.grabbable=!0,a.grabbable=this.enableMoveGraphic})]))};this._manipulatorHandles.add([n.events.on("focus-changed",o),a.events.on("focus-changed",o),Y(()=>{gt(t.visibilityHandle),a.metadata.deleting=!0,this.manipulators.remove(a)})],n),o()}_updateEdgeOffsetManipulator(t){this._updateManipulatorPosition(t);const{coordinateHelper:e}=this._editGeometryOperations.data,n=ta(this.view,t.manipulator.elevationAlignedLocation,Ji(e,t.handle,t.manipulator.elevationInfo)),a=this._getManipulatorInfoFromHandle(t.handle.leftVertex),o=this._getManipulatorInfoFromHandle(t.handle.rightVertex);if(a==null||o==null)return;const s=a.manipulator.renderLocation,r=o.manipulator.renderLocation,l=n!=null?bs(n,s,r):hn;t.manipulator.modelTransform=l,t.edgeManipulator.elevationAlignedLocation=t.manipulator.elevationAlignedLocation,t.edgeManipulator.modelTransform=l;const p=te(L(be,s,r))/2;t.edgeManipulator.collisionType={type:"line",paths:[[[-p,0,0],[p,0,0]]]}}_createEdgeOffsetPipeline(t,e){return(n,a,o)=>{this._clearSelection();const{step:s,cleanup:r}=this._initializeEdgeOffset(t,e);a.next(l=>this._trackNumDragging(l)).next(pe(this.view,n.elevationAlignedLocation)).next(s).next(ao(this.view)).next(no(this.view,this._editGeometryOperations.data.spatialReference)).next(Kt()).next(this._applyComputeEdgeOffsetDistanceStep()).next(this._applyEdgeOffsetStep(t)).next(this._showEdgeOffsetTooltip()).next(l=>{l.action==="end"&&r()}),o.next(()=>{n.metadata.deleting||(r(),this._onDragCancel())})}}_initializeEdgeOffset(t,e){const{view:n}=this,a=this._editGeometryOperations,o=Ji(a.data.coordinateHelper,t.handle,e),s=a.createUndoGroup(),r=ta(n,t.manipulator.elevationAlignedLocation,o);if(o.requiresSplitEdgeLeft){const _=this._getManipulatorInfoFromHandle(t.handle.leftVertex.leftEdge);_!=null&&this._splitEdgeManipulator(_,1)}if(o.requiresSplitEdgeRight){const _=this._getManipulatorInfoFromHandle(t.handle.rightVertex.rightEdge);_!=null&&this._splitEdgeManipulator(_,0)}const l=()=>new gn({paths:[[t.handle.leftVertex.pos,t.handle.rightVertex.pos]],spatialReference:a.data.spatialReference}),p=this._settings,c=new Nt({view:n,isDraped:this._graphicState.isDraped,geometry:l(),elevationInfo:t.elevationInfo,width:p.visualElements.lineGraphics.outline.width,attached:!1,isDecoration:!0});let d;const g=()=>{this._cleanEdgeOffsetCollapsedEdges(t),d=gt(d)},m=this.on("undo",g);return d=Z([f(()=>N(this._accentColor),_=>c.color=_,$),Gt(c),f(()=>this._graphicState.isDraped,_=>c.isDraped=_),this._graphicState.on("changed",()=>c.geometry=l()),s,m]),c.attached=!0,{step:_=>o==null||r==null?(g(),null):{..._,operation:o,plane:r},cleanup:g}}_applyEdgeOffsetStep(t){return e=>{if(this.destroyed||e.operation==null)return e;this._updateEventState(I.RESHAPING);const{mapDeltaX:n,mapDeltaY:a,mapDeltaZ:o}=e;return(n||a||o)&&(this._offsetEdge(t,e),this.emit("reshape",{type:"reshape",mover:this.graphic})),e}}_applyComputeEdgeOffsetDistanceStep(){return t=>{const{operation:e,mapEnd:n}=t;return e==null||n==null?t:(t.action==="start"&&e.selectArrowFromStartPoint(n),{...t,signedDistance:e.signedDistanceToPoint(n)})}}_showEdgeOffsetTooltip(){return t=>{const{mapEnd:e,signedDistance:n,operation:a}=t,{_tooltip:o,_tooltipOptions:s}=this;return s.enabled&&n!=null?(o.info=this._edgeOffsetTooltipInfo??(this._edgeOffsetTooltipInfo=new Tt({tooltipOptions:s})),o.info.tooltipOptions=s,o.info.distance=t.action==="end"?ht:xs(this._graphicState.isDraped,n*a.selectedArrow,e,a.plane,this._editGeometryOperations.data.coordinateHelper),this._updateTooltipAreaOrTotalLength(o.info),t):(o.clear(),t)}}_cleanEdgeOffsetCollapsedEdges(t){var l,p;const e=(l=t.handle.leftVertex.leftEdge)==null?void 0:l.leftVertex,n=t.handle.leftVertex,a=(p=t.handle.rightVertex.rightEdge)==null?void 0:p.rightVertex,o=t.handle.rightVertex,s=this._editGeometryOperations.data.coordinateHelper,r=[];if(e&&s.distance(e.pos,n.pos)<Je){const c=this._getManipulatorInfoFromHandle(n);c!=null&&r.push(c)}if(s.distance(n.pos,o.pos)<Je||a&&s.distance(a.pos,o.pos)<Je){const c=this._getManipulatorInfoFromHandle(o);c!=null&&r.push(c)}r.length&&this._removeVertices(r)}_computeVertexManipulatorSizeAndOutline(t){const e=t.size/2,n=e+t.collisionPadding;return{size:e/n,outlineSize:(e+t.outlineSize)/n}}_createVertexOrEdgeManipulator(t,e=z(this.graphic),n=!1){var g;const{view:a}=this,o=this._settings;if(t.type==="edge"){if(this.enableEdgeOffset)return this._createEdgeOffsetManipulator(t,e);if(!this.enableMidpoints)return null}if(this._vertexManipulatorGeometry==null||this._vertexManipulatorOutlineGeometry==null){const{size:m,outlineSize:_}=this._computeVertexManipulatorSizeAndOutline(o.manipulators.vertex);this._vertexManipulatorGeometry=Me(this._vertexManipulatorMaterial,m,16,16),this._vertexManipulatorOutlineGeometry=Me(this._vertexManipulatorOutlineMaterial,_,16,16)}if(this._edgeManipulatorGeometry==null||this._edgeManipulatorOutlineGeometry==null){const{size:m,outlineSize:_}=this._computeVertexManipulatorSizeAndOutline(o.manipulators.edge);this._edgeManipulatorGeometry=Me(this._edgeManipulatorMaterial,m,16,16),this._edgeManipulatorOutlineGeometry=Me(this._edgeManipulatorOutlineMaterial,_,16,16)}const{geometry:s}=this.graphic,r=s==null?void 0:s.type,l=r==="point"||r==="mesh"?[]:[new w(this._vertexManipulatorGeometry.instantiate(),nt.Vertex|O.Unselected),new w(this._vertexManipulatorOutlineGeometry.instantiate(),nt.Vertex|O.Unfocused|O.Unselected),new w(this._vertexManipulatorOutlineGeometry.instantiate({material:this._vertexManipulatorHoverOutlineMaterial}),nt.Vertex|O.Focused|O.Unselected),new w(this._vertexManipulatorGeometry.instantiate({material:this._selectedManipulatorMaterial}),O.Selected),new w(this._vertexManipulatorOutlineGeometry.instantiate({material:this._selectedManipulatorOutlineMaterial}),O.Selected|O.Unfocused),new w(this._vertexManipulatorOutlineGeometry.instantiate({material:this._selectedManipulatorHoverOutlineMaterial}),O.Selected|O.Focused)];this.enableMidpoints&&l.push(new w(this._edgeManipulatorGeometry.instantiate({material:this._vertexManipulatorMaterial}),nt.Edge|O.Focused|O.Unselected),new w(this._edgeManipulatorOutlineGeometry.instantiate({material:this._vertexManipulatorHoverOutlineMaterial}),nt.Edge|O.Focused|O.Unselected),new w(this._edgeManipulatorGeometry.instantiate(),nt.Edge|O.Unfocused|O.Unselected),new w(this._edgeManipulatorOutlineGeometry.instantiate(),nt.Edge|O.Unfocused|O.Unselected));const p=new et({view:a,renderObjects:l,elevationInfo:e,focusMultiplier:1,touchMultiplier:1,available:!(!this.graphic.visible||!((g=this.graphic.layer)!=null&&g.visible)),metadata:{deleting:!1}});p.selected=n,this._setTypeSpecificManipulatorSettings(p,t,e);const c=t.type==="edge"?{manipulator:p,handle:t,locationUpdateHandle:null,type:"edge",selectedIndex:0}:{manipulator:p,handle:t,type:"vertex",selectedIndex:0};if(this._manipulatorInfos.push(c),this.manipulators.add(p),this._updateManipulatorPosition(c),c.type==="edge"){const m=[];for(const _ of[c.handle.leftVertex,c.handle.rightVertex]){const v=this._getManipulatorInfoFromHandle(_);v!=null&&m.push(v.manipulator.events.on("location-update",()=>this._updateManipulatorPosition(c)))}c.locationUpdateHandle=Z(m),this._manipulatorHandles.add(c.locationUpdateHandle,p)}this._manipulatorHandles.add(this._watchAndUpdateGrabState(p,!0),p);const d=rt(p,(m,_,v,y)=>{let b=null;const{snappingStep:M,cancelSnapping:T}=$e({predicate:()=>!this._isMultiVertexSelection(),snappingManager:this.tool.snappingManager,snappingContext:new Ie({editGeometryOperations:this._editGeometryOperations,elevationInfo:e,pointer:y,excludeFeature:this.graphic,visualizer:new ue}),updatingHandles:this._updatingHandles,useZ:!1});v=v.next(D=>(this._onDragCancel(!m.metadata.deleting,()=>b=gt(b)),D)).next(T),_.next(D=>this._trackNumDragging(D)).next(D=>{if(D.action==="start"&&(b=this._editGeometryOperations.createUndoGroup()),c.type==="edge"){const X=this._splitEdgeManipulator(c);return{...D,info:X,snapOrigin:X.handle.pos}}return{...D,info:c,snapOrigin:c.handle.pos}}).next(pe(this.view,m.elevationAlignedLocation)).next(oo(this.view,this.graphic,m.elevationAlignedLocation,m.location.spatialReference,this.graphic)).next(Pi(this.view,e,this.graphic)).next(...M).next(Kt()).next(D=>{this._perVertexManipulatorDragAction(D),D.action==="end"&&(b=gt(b)),this._updateTranslateVertexTooltip(m,S.XY,D)})});return this._manipulatorHandles.add([d,p.events.on("immediate-click",m=>this._manipulatorClickCallback(m,c)),p.events.on("select-changed",()=>{c.selectedIndex=++this._selectedIndex,this._updateMoveManipulationPosition()}),p.events.on("focus-changed",({action:m})=>{m==="focus"&&c.type!=="edge"?this._updateTranslateVertexTooltip(p,S.XY):this._tooltip.clear()})],p),this.emit("manipulators-changed"),c}_trackNumDragging(t){switch(t.action){case"start":this._numDragging++;break;case"end":this._numDragging--}return t}_onDragCancel(t=!0,e){switch(this._numDragging--,t&&(this.undo(),this.outputGeometry=this._editGeometryOperations!=null?this._editGeometryOperations.data.geometry:null),this.tool.snappingManager!=null&&this.tool.snappingManager.doneSnapping(),this._tooltip.clear(),this._reshapeEventState){case I.NONE:break;case I.MOVING:this.emit("move",{type:"move",dx:0,dy:0,mover:this.graphic});break;case I.RESHAPING:this.emit("reshape",{type:"reshape",mover:this.graphic})}e&&e(),this.destroyed||this._updateEventState(I.NONE)}_setTypeSpecificManipulatorSettings(t,e,n){const{graphic:a}=this,o=this._settings;switch(e.type){case"vertex":{t.state=nt.Vertex,t.selectable=!0,t.cursor="move",t.collisionPriority=2;const{size:s,collisionPadding:r}=o.manipulators.vertex;t.radius=s/2+r,t.elevationInfo=n;const{geometry:l}=a,p=l==null?void 0:l.type;t.interactive=p!=null&&p!=="point"&&p!=="mesh";break}case"edge":{t.state=nt.Edge,t.selectable=!1,t.cursor="copy",t.collisionPriority=-1;const{size:s,collisionPadding:r}=o.manipulators.edge;t.radius=s/2+r,t.elevationInfo=n.mode!=="on-the-ground"||Ei(a.symbol)?{mode:"absolute-height",offset:0}:n;break}}}_watchAndUpdateGrabState(t,e){return t.events.on("grab-changed",n=>this._onGrabStateChanged(t,e,n.action,n.pointerType))}_onGrabStateChanged(t,e,n,a="mouse"){if(!this._recreatingManipulators){if(n==="start")e&&this._updateSelection(t),this._numGrabbing++;else if(this._numGrabbing--,this._updateEventState(I.NONE),this.destroyed)return;this._moveManipulation.interactive=!this._numGrabbing,(a!=="touch"||this.enableEdgeOffset)&&(this._manipulatorInfos.forEach(o=>{const{manipulator:s}=o,{geometry:r}=this.graphic,l=r==null?void 0:r.type;s.interactive=s.grabbing||!this._numGrabbing&&l!=null&&l!=="point"&&l!=="mesh","edgeManipulator"in o&&(o.edgeManipulator.interactive=o.edgeManipulator.grabbing||!this._numGrabbing)}),this._graphicMoveManipulation.forEachManipulator(o=>{o.interactive=o.grabbing||!this._numGrabbing}))}}_clearSelection(){for(const t of this._manipulatorInfos)t.manipulator.grabbing||(t.manipulator.selected=!1)}_updateSelection(t){t.grabbing&&!t.selected&&t.selectable&&(this._clearSelection(),t.selected=!0,this.emit("manipulators-changed"))}_removeManipulator(t){t!=null&&(t.manipulator.metadata.deleting=!0,this.manipulators.remove(t.manipulator),this._manipulatorHandles.remove(t.manipulator),cn(this._manipulatorInfos,t),this.emit("manipulators-changed"))}_getManipulatorInfoFromHandle(t){if(t){for(const e of this._manipulatorInfos)if(t===e.handle)return e}return null}_updateManipulatorPosition(t){if(t==null)return;const e=this._editGeometryOperations;if(t.type==="vertex")t.manipulator.location=e.data.coordinateHelper.vectorToDehydratedPoint(t.handle.pos,se),t.manipulator.grabbing&&this._vertexLaserLineVisualElement!=null&&(this._vertexLaserLineVisualElement.visualElement.intersectsWorldUpAtLocation=t.manipulator.renderLocation);else if(t.type==="edge"){const n=this._getManipulatorInfoFromHandle(t.handle.leftVertex),a=this._getManipulatorInfoFromHandle(t.handle.rightVertex);if(n==null||a==null)return;const o=n.manipulator,s=a.manipulator;if(t.manipulator.elevationInfo!=null&&t.manipulator.elevationInfo.mode==="on-the-ground"){const r=o.location,l=s.location,p=.5,c=r.x+p*(l.x-r.x),d=r.y+p*(l.y-r.y),g=r.hasZ&&l.hasZ?0:void 0;t.manipulator.location=Ne(c,d,g,e.data.spatialReference)}else Pt(be,o.renderLocation,s.renderLocation,.5),t.manipulator.renderLocation=be}}_splitEdgeManipulator(t,e=.5){const n=this._editGeometryOperations,a=n.splitEdge(t.handle,e).createdVertex;t.locationUpdateHandle=gt(t.locationUpdateHandle);const o=z(this.graphic);let s;this.enableEdgeOffset?(this._removeManipulator(t),s=this._createVertexOrEdgeManipulator(a)):(s=t,s.handle=a,s.type="vertex",this._setTypeSpecificManipulatorSettings(t.manipulator,t.handle,o)),a.leftEdge&&this._createVertexOrEdgeManipulator(a.leftEdge),a.rightEdge&&this._createVertexOrEdgeManipulator(a.rightEdge),this.outputGeometry=n.data.geometry,this._updateManipulatorPosition(s),this.enableEdgeOffset||this._updateTranslateVertexTooltip(s.manipulator,S.XY),this._updateSelection(t.manipulator);const r=this._updateEventState(I.RESHAPING),l=n.data.coordinateHelper.vectorToArray(s.handle.pos),p=n.data.components.indexOf(a.component);return this.emit("vertex-add",{type:"vertex-add",vertices:[{coordinates:l,componentIndex:p,vertexIndex:a.index}],added:l}),r&&this._updateEventState(I.NONE),s}_updateMoveManipulationPosition(){const t=ct(be,0,0,0);let e=0,n=!1,a=null,o=null;for(const s of this._manipulatorInfos)s.type==="vertex"&&(s.manipulator.selected?(e++,At(t,t,s.manipulator.renderLocation),a==null||s.selectedIndex>a.selectedIndex?(o=a,a=s):(o==null||s.selectedIndex>o.selectedIndex)&&(o=s)):n=!0);if(e===0){const s=this._graphicState.displaying&&this.enableMoveGraphic;this._moveManipulation.xyManipulation.available=s,this._moveManipulation.xyAxisManipulation.available=s,this._moveManipulation.xyAxisManipulation.orthogonalAvailable=s,this._moveManipulation.zManipulation.available=s&&this.enableZShape&&kt(this.graphic),this._moveManipulation.angle=yi(this.graphic.geometry),this._moveManipulation.radius=Ut.radiusForSymbol(this.graphic.symbol)}else{const s=this._graphicState.displaying;this._moveManipulation.xyManipulation.available=s,this._moveManipulation.xyAxisManipulation.available=s,this._moveManipulation.zManipulation.available=s&&this.enableZVertex&&kt(this.graphic),this._moveManipulation.xyAxisManipulation.orthogonalAvailable=s&&e!==1;let r=0;if(a!=null){const l=a.handle.pos,p=o!=null?o.handle.pos:a.handle.leftEdge&&a.handle.leftEdge.leftVertex?a.handle.leftEdge.leftVertex.pos:null,c=o==null&&a.handle.rightEdge&&a.handle.rightEdge.rightVertex?a.handle.rightEdge.rightVertex.pos:null;p&&c?this._moveManipulation.xyAxisManipulation.available=!1:p?r=ia(p,l):c&&(r=ia(l,c))}this._moveManipulation.angle=r,this._moveManipulation.radius=Ca}e!==0&&n?(Vt(t,t,1/e),se.spatialReference=this._editGeometryOperations.data.spatialReference,se.hasZ=!0,this.view.renderCoordsHelper.fromRenderCoords(t,se),this._moveManipulation.elevationAlignedLocation=se):this._outlineVisualElement==null||this._graphicState.isDraped||this._outlineVisualElement.attachmentOrigin==null?ba(this.view,this._moveManipulation,this.graphic):this._moveManipulation.elevationAlignedLocation=this._outlineVisualElement.attachmentOrigin}_removeVertices(t){var a;const e=new Array,n=this._editGeometryOperations;for(const o of t)if(o.type==="vertex"&&n.canRemoveVertex(o.handle.component)){e.push(o.handle),this._removeManipulator(o),this._removeManipulator(this._getManipulatorInfoFromHandle(o.handle.leftEdge)),this._removeManipulator(this._getManipulatorInfoFromHandle(o.handle.rightEdge));const s=n.removeVertices([o.handle]),r=(a=s.removedVertices)==null?void 0:a[0].createdEdge;r&&this._createVertexOrEdgeManipulator(r)}if(e.length>0){const o=e.map(r=>{const l=n.data.components.indexOf(r.component);return{coordinates:n.data.coordinateHelper.vectorToArray(r.pos),componentIndex:l,vertexIndex:r.index}});this.outputGeometry=n.data.geometry;const s=this._updateEventState(I.RESHAPING);if(this.destroyed||(this.emit("vertex-remove",{type:"vertex-remove",removed:o.map(r=>r.coordinates),vertices:o}),this.destroyed)||s&&(this._updateEventState(I.NONE),this.destroyed))return;this._updateMoveManipulationPosition()}}_moveVertices(t,e,n=e.action==="start"?St.NEW_STEP:St.ACCUMULATE_STEPS){const a=this._editGeometryOperations;a.moveVertices(t.map(o=>o.handle),e.mapDeltaX,e.mapDeltaY,e.mapDeltaZ,n),this.outputGeometry=a.data.geometry;for(const o of t)this._updateManipulatorPosition(o)}_offsetEdge(t,e){if(e.operation==null||e.signedDistance==null)return;const n=this._editGeometryOperations,a=e.operation.clone();a.distance=e.signedDistance,n.updateVertices([t.handle.leftVertex,t.handle.rightVertex],a),this.outputGeometry=n.data.geometry,this._updateManipulatorPosition(this._getManipulatorInfoFromHandle(t.handle.leftVertex)),this._updateManipulatorPosition(this._getManipulatorInfoFromHandle(t.handle.rightVertex))}_manipulatorClickCallback(t,e){t.shiftKey||this._clearSelection(),e.type==="vertex"&&(e.manipulator.selected=!e.manipulator.selected,t.button===Hi.Right&&this._removeVertices([e])),e.type==="edge"&&t.button===Hi.Left&&this._splitEdgeManipulator(e),t.stopPropagation()}_updateTranslateTooltip(t,e){const n=this._manipulatorInfos.filter(a=>a.type==="vertex"&&a.manipulator.selected);n.length===1?this._updateTranslateVertexTooltip(n[0].manipulator,t,e):this._updateTranslateGraphicTooltip(t,e)}_updateTranslateGraphicTooltip(t,e){const{_tooltipOptions:n,_tooltip:a}=this;if(!n.enabled)return;const o=this._graphicState.isDraped?"on-the-ground":"absolute-height";switch(t){case S.XY:a.info=this._translateGraphicTooltipInfo??(this._translateGraphicTooltipInfo=new ge({tooltipOptions:n})),this._updateTranslateTooltipDistance(a.info,e,(s,r)=>bt(s,r,o));break;case S.XY_AXIS:a.info=this._translateGraphicXYTooltipInfo??(this._translateGraphicXYTooltipInfo=new vi({tooltipOptions:n})),this._updateTranslateTooltipDistance(a.info,e,(s,r)=>{const l=bt(s,r,o);return Ge(l,Le(e))});break;case S.Z:a.info=this._translateGraphicZTooltipInfo??(this._translateGraphicZTooltipInfo=new Fe({tooltipOptions:n})),this._updateTranslateTooltipDistance(a.info,e,Re)}a.info.tooltipOptions=n}_updateTranslateVertexTooltip(t,e,n){const{_tooltipOptions:a,_tooltip:o}=this;if(!a.enabled)return;const s=this._graphicState.isDraped?"on-the-ground":"absolute-height";switch(e){case S.XY:o.info=this._translateVertexTooltipInfo??(this._translateVertexTooltipInfo=new vo({tooltipOptions:a})),this._updateTranslateTooltipDistance(o.info,n,(l,p)=>bt(l,p,s)),this._updateTooltipAreaOrTotalLength(o.info);break;case S.XY_AXIS:o.info=this._translateVertexXYTooltipInfo??(this._translateVertexXYTooltipInfo=new _o({tooltipOptions:a})),this._updateTranslateTooltipDistance(o.info,n,(l,p)=>{const c=bt(l,p,s);return Ge(c,Le(n))}),this._updateTooltipAreaOrTotalLength(o.info);break;case S.Z:o.info=this._translateVertexZTooltipInfo??(this._translateVertexZTooltipInfo=new mo({tooltipOptions:a})),this._updateTranslateTooltipDistance(o.info,n,Re)}const r=fo(t.elevationAlignedLocation);r!=null&&(o.info.elevation=Zn({actual:r})),o.info.tooltipOptions=a}_updateTranslateTooltipDistance(t,e,n){if(e!=null&&e.action!=="end"){const{mapStart:a,mapEnd:o}=e,s=n(a,o);t.distance=s??ht}else t.distance=ht}_updateTooltipAreaOrTotalLength(t){const{geometry:e}=this.graphic;if(e==null)return t.area=null,void(t.totalLength=null);const n=this._graphicState.isDraped?"on-the-ground":"absolute-height";t.area=e.type==="polygon"?Mo(e,n):null,t.totalLength=e.type==="polyline"?Pn(e,n):null}get test(){return{segmentLabels:this._segmentLabels,tooltip:this._tooltip}}};function ia(i,t){return Math.atan2(t[1]-i[1],t[0]-i[0])+Math.PI/2}function xs(i,t,e,n,a){if(i){const o=a.toXYZ(a.pointToVector(e)),s=un(n,o,x.get()),r=zn(s,o,a.spatialReference);if(r!=null)return de(r.value*Math.sign(t),r.unit)}return de(t*_a(e.spatialReference),"meters")}h([u()],C.prototype,"_editGeometryOperations",void 0),h([u()],C.prototype,"_segmentLabels",void 0),h([u({constructOnly:!0})],C.prototype,"tool",void 0),h([u()],C.prototype,"_tooltip",void 0),h([u()],C.prototype,"inputGeometry",null),h([u()],C.prototype,"outputGeometry",void 0),h([u({readOnly:!0})],C.prototype,"updating",null),h([u()],C.prototype,"manipulators",null),h([u()],C.prototype,"view",null),h([u()],C.prototype,"graphic",null),h([u()],C.prototype,"enableZShape",null),h([u()],C.prototype,"enableZVertex",null),h([u()],C.prototype,"enableMoveGraphic",null),h([u()],C.prototype,"enableMidpoints",null),h([u()],C.prototype,"enableEdgeOffset",null),h([u()],C.prototype,"_labelOptions",null),h([u()],C.prototype,"_tooltipOptions",null),h([u()],C.prototype,"_accentColor",null),C=h([V("esri.views.3d.interactive.editingTools.reshapeGraphic.ReshapeOperation")],C);const se=Ne(0,0,void 0,dn.WGS84),be=H(),Je=1e-6;var nt,I,Qt;(function(i){i.Vertex=yt.Custom1,i.Edge=yt.Custom2})(nt||(nt={})),function(i){i[i.NONE=0]="NONE",i[i.MOVING=1]="MOVING",i[i.RESHAPING=2]="RESHAPING"}(I||(I={})),function(i){i[i.ALL=0]="ALL",i[i.SELECTED_OR_ALL=1]="SELECTED_OR_ALL"}(Qt||(Qt={}));let U=class extends $t.EventedMixin(Ye){constructor(i){super(i),this._internalGeometryUpdate=!1,this.enableZShape=!0,this.enableZVertex=!0,this.enableMoveGraphic=!0,this.enableMidpoints=!0,this.enableEdgeOffset=!1,this.type="reshape-3d",this.labelOptions=new Ta,this.tooltipOptions=new Rt,this.snappingManager=null,this.automaticManipulatorSelection=!1}initialize(){const i=this._reshapeOperation=new C({tool:this});this.addHandles([i.on("reshape",t=>{t.type==="reshape"&&this._onReshapeGeometryChanged(),this.emit("reshape",t)}),i.on("move",t=>{t.type==="move"&&this._onReshapeGeometryChanged(),this.emit("move",t)}),i.on("vertex-add",t=>{this._onReshapeGeometryChanged(),this.emit("vertex-add",t)}),i.on("vertex-remove",t=>{this._onReshapeGeometryChanged(),this.emit("vertex-remove",t)}),i.on("immediate-click",t=>this.emit("immediate-click",t)),this.view.on("pointer-down",["Shift"],t=>t.stopPropagation()),f(()=>this.graphic,()=>this._updateGraphic(),Jt)]),this.finishToolCreation()}destroy(){this._reshapeOperation=R(this._reshapeOperation)}get updating(){var i;return((i=this._reshapeOperation)==null?void 0:i.updating)??!1}_updateGeometry(){const i=Jn(this.graphic);this._reshapeOperation.inputGeometry=i!=null?i.clone():null}_updateGraphic(){if(this.removeHandles("onGraphicGeometryChange"),this._updateGeometry(),to(this.graphic)!==xa.SUPPORTED)return;const i=f(()=>{var t;return(t=this.graphic)==null?void 0:t.geometry},()=>{this._internalGeometryUpdate===!1&&this._updateGeometry()},Te);this.addHandles(i,"onGraphicGeometryChange")}onManipulatorSelectionChanged(){this._reshapeOperation&&this._reshapeOperation.onManipulatorSelectionChanged()}_updateGeometryInternally(i){this._internalGeometryUpdate=!0;const{graphic:t}=this,{geometry:e}=t;(e==null?void 0:e.type)==="mesh"&&i.type==="point"?(t.geometry=e.centerAt(i),t.notifyGeometryChanged()):t.geometry=i,this._internalGeometryUpdate=!1}_onReshapeGeometryChanged(){const{outputGeometry:i}=this._reshapeOperation;this.graphic!=null&&i&&this._updateGeometryInternally(i.clone())}get canUndo(){return this._reshapeOperation.canUndo??!1}undo(){this.snappingManager!=null&&this.snappingManager.doneSnapping();const i=this._reshapeOperation.undo(),{outputGeometry:t}=this._reshapeOperation;i&&t&&this._updateGeometryInternally(t.clone())}get canRedo(){return this._reshapeOperation.canRedo??!1}redo(){this.snappingManager!=null&&this.snappingManager.doneSnapping();const i=this._reshapeOperation.redo(),{outputGeometry:t}=this._reshapeOperation;i&&t&&this._updateGeometryInternally(t.clone())}onInputEvent(i){i.type!=="key-down"||i.key!=="Delete"&&i.key!=="Backspace"||this._reshapeOperation.removeSelectedVertices()}reset(){}get test(){return{snappingManager:this.snappingManager,reshapeOperation:this._reshapeOperation}}};h([u()],U.prototype,"_reshapeOperation",void 0),h([u({constructOnly:!0,nonNullable:!0})],U.prototype,"view",void 0),h([u({constructOnly:!0})],U.prototype,"graphic",void 0),h([u({constructOnly:!0,nonNullable:!0})],U.prototype,"enableZShape",void 0),h([u({constructOnly:!0,nonNullable:!0})],U.prototype,"enableZVertex",void 0),h([u({constructOnly:!0,nonNullable:!0})],U.prototype,"enableMoveGraphic",void 0),h([u({constructOnly:!0,nonNullable:!0})],U.prototype,"enableMidpoints",void 0),h([u({constructOnly:!0,nonNullable:!0})],U.prototype,"enableEdgeOffset",void 0),h([u()],U.prototype,"type",void 0),h([u({constructOnly:!0,type:Ta})],U.prototype,"labelOptions",void 0),h([u({constructOnly:!0,type:Rt})],U.prototype,"tooltipOptions",void 0),h([u({constructOnly:!0})],U.prototype,"snappingManager",void 0),h([u()],U.prototype,"updating",null),h([u()],U.prototype,"automaticManipulatorSelection",void 0),U=h([V("esri.views.3d.interactive.editingTools.graphicReshape3D.GraphicReshapeTool")],U);let mt=class extends Ue{constructor(t){super(t),this.type="transform-rotate",this.rotation=null,this.rotationPrecision=null,this.orientation=null,this.orientationPrecision=null,this.rotationType="geographic"}};h([u()],mt.prototype,"type",void 0),h([u()],mt.prototype,"rotation",void 0),h([u()],mt.prototype,"rotationPrecision",void 0),h([u()],mt.prototype,"orientation",void 0),h([u()],mt.prototype,"orientationPrecision",void 0),h([u()],mt.prototype,"rotationType",void 0),mt=h([V("esri.views.interactive.tooltip.TransformRotateTooltipInfo")],mt);let Ot=class extends Ue{constructor(i){super(i),this.type="transform-scale",this.size=null,this.sizeUnit=null,this.sizePrecision=null}};h([u()],Ot.prototype,"type",void 0),h([u()],Ot.prototype,"scale",void 0),h([u()],Ot.prototype,"size",void 0),h([u()],Ot.prototype,"sizeUnit",void 0),h([u()],Ot.prototype,"sizePrecision",void 0),Ot=h([V("esri.views.interactive.tooltip.TransformScaleTooltipInfo")],Ot);let pt=class extends Ue{constructor(t){super(t),this.type="transform-absolute",this.orientation=null,this.orientationPrecision=null,this.rotationType="geographic",this.size=null,this.sizePrecision=null,this.sizeUnit=null}};h([u()],pt.prototype,"type",void 0),h([u()],pt.prototype,"orientation",void 0),h([u()],pt.prototype,"orientationPrecision",void 0),h([u()],pt.prototype,"rotationType",void 0),h([u()],pt.prototype,"size",void 0),h([u()],pt.prototype,"sizePrecision",void 0),h([u()],pt.prototype,"sizeUnit",void 0),pt=h([V("esri.views.interactive.tooltip.TransformAbsoluteTooltipInfo")],pt);var E;(function(i){i.ScaleIn=yt.Custom2,i.ScaleOut=yt.Custom3,i.RotateLeft=yt.Custom4,i.RotateRight=yt.Custom5,i.Unlocked=yt.Custom7,i.DelayedFocused=yt.Custom8,i.TouchInput=yt.Custom12})(E||(E={}));let _t=class extends Yt{get angle(){return this.adapter.angle}get scale(){return this.adapter.scale}set location(i){this._ringManipulator.location=i}set elevationAlignedLocation(i){this._ringManipulator.elevationAlignedLocation=i}get grabbing(){return this._ringManipulator.grabbing}set interactive(i){this._ringManipulator.interactive=i}get updating(){return!!this._activeAnimation}constructor(i){super(i),this.mode=null,this._scaleRotateDragData=null,this._activeAnimation=null,this._ringIndicatorDelayMs=ps,this._absoluteTooltipInfo=null,this._scaleTooltipInfo=null,this._rotateTooltipInfo=null,this.events=new $t,this.getFocused=()=>this._ringManipulator.focused,this.getScale=()=>{var t;return((t=this._scaleRotateDragData)==null?void 0:t.mode)==="scale"?this.adapter.scale:1}}initialize(){this._tooltip=new ve({view:this.tool.view}),this._createManipulator(),this._updateDragState(),this._updateManipulatorTransform(),this.addHandles([Xt(()=>!this.tooltipOptions.enabled,()=>this._tooltip.clear(),$),f(()=>{const{adapter:i}=this,{info:t}=this._tooltip;return t===this._absoluteTooltipInfo&&this.getFocused()?[t,i.size,i.orientationClockwise]:[null]},([i])=>{i&&this._updateFocusTooltip()})])}destroy(){var i;(i=this._activeAnimation)==null||i.frameTask.remove(),this._activeAnimation=null,this.tool.manipulators.remove(this._ringManipulator),this._ringManipulator=null,this._tooltip=R(this._tooltip)}startAnimation(i){this.cancelActiveAnimation(),i.start();const t=mn({update:({deltaTime:e})=>{i.update(e)&&this.cancelActiveAnimation()}});this._activeAnimation={...i,frameTask:t}}cancelActiveAnimation(){var i;(i=this._activeAnimation)==null||i.frameTask.remove(),this._activeAnimation=R(this._activeAnimation)}forEachManipulator(i){i(this._ringManipulator,G.SCALE_ROTATE)}_createManipulator(){const i=this._createRingManipulator();this._ringManipulator=i,this.tool.manipulators.add(i);const t=this.tool.graphicState.graphic,e=rt(i,(n,a,o)=>{this._scaleRotateDragData=null;const s=this.adapter.startInteraction(),r={mode:"none",origin:le(n.renderLocation),initialAngle:this.adapter.angle,angle:0,angleDir:0,scaleDir:0};this._scaleRotateDragData=r,this._updateDragState();const l=x.get();this.tool.view.renderCoordsHelper.worldUpAtPosition(n.renderLocation,l),a.next(mi(this.tool.view,ga(n.renderLocation,l,pi()))).next(p=>{const c=_e(p.plane),d=Sa(p.renderStart,p.renderEnd,r.origin,c),g=bo.shortestSignedDiff(r.angle,d);r.angleDir=ii(r.angleDir+g,-qi,qi),r.angle=d;const m=ws(r,p),_=m-this.adapter.scale;if(r.scaleDir=ii(r.scaleDir+_,-ji,ji),this._onScaleChanged(),r.mode==="none"){const v=this.mode||Os(p,p.plane,r.origin,this.tool.view.state.camera);if(v!=null){switch(v){case"rotate":this.tool.emit("graphic-rotate-start",{graphic:t,angle:0}),this.tool.emit("record-undo",{record:this.adapter.createUndoRecord()});break;case"scale":this.tool.emit("graphic-scale-start",{graphic:t,xScale:1,yScale:1}),this.tool.emit("record-undo",{record:this.adapter.createUndoRecord()})}r.mode=v}}switch(r.mode){case"rotate":s.state.angle=r.initialAngle+d;break;case"scale":s.state.scale=m,this._onScaleChanged()}switch(this._updateDragState(),this._updateManipulatorTransform(),p.action){case"start":case"update":switch(r.mode){case"rotate":this.tool.emit("graphic-rotate",{graphic:t,angle:ce(r.angle)});break;case"scale":this.tool.emit("graphic-scale",{graphic:t,xScale:m,yScale:m})}break;case"end":switch(r.mode){case"rotate":this.tool.emit("graphic-rotate-stop",{graphic:t,angle:ce(r.angle)});break;case"scale":this.tool.emit("graphic-scale-stop",{graphic:t,xScale:m,yScale:m})}}return p.action==="end"&&(this.startAnimation(aa(this,()=>this._onScaleChanged())),this._scaleRotateDragData=null,this._updateDragState(),s.done()),p}).next(this._updateTooltipPipelineStep(r)),o.next(()=>{if(s.cancel(),this._scaleRotateDragData!=null){switch(this._scaleRotateDragData.mode){case"none":break;case"rotate":this.tool.emit("graphic-rotate-stop",{graphic:t,angle:0});break;case"scale":this.tool.emit("graphic-scale-stop",{graphic:t,xScale:1,yScale:1})}this.startAnimation(aa(this,()=>this._onScaleChanged())),this._scaleRotateDragData=null,this._updateDragState()}this._updateFocusTooltip()})});this.addHandles([e,i.events.on("focus-changed",n=>{n.action==="focus"?this.startAnimation(Es(this,()=>this._updateDelayedFocusedState(),{delayMs:this._ringIndicatorDelayMs})):this._updateDelayedFocusedState()}),i.events.on("immediate-click",n=>{n.stopPropagation()}),f(()=>{var n;return(n=this.tool.graphicState)==null?void 0:n.displaying},n=>this._ringManipulator.available=n,$)])}_updateTooltipPipelineStep(i){return t=>{const e=this.tooltipOptions;if(!e.enabled)return t;if(t.action==="end")return this._updateFocusTooltip(),t;const n=this._tooltip,a=this.tooltipOptions.visualVariables;switch(i.mode){case"scale":{n.info=this._scaleTooltipInfo??(this._scaleTooltipInfo=new Ot({tooltipOptions:e}));const{size:o,scale:s}=this.adapter,r=a==null?void 0:a.size,l=n.info;l.tooltipOptions=e,l.scale={value:s},l.size=o!=null?de(o,"meters"):void 0,l.sizePrecision=xe(r==null?void 0:r.valueType),l.sizeUnit=r==null?void 0:r.unit;break}case"rotate":{n.info=this._rotateTooltipInfo??(this._rotateTooltipInfo=new mt({tooltipOptions:e}));const{orientationClockwise:o,relativeAngleClockwise:s}=this.adapter,r=a==null?void 0:a.rotation,l=xe(r==null?void 0:r.valueType),p=n.info;p.tooltipOptions=e,p.rotation=s!=null?We(s,"radians","geographic"):void 0,p.rotationPrecision=l,p.rotationType=(r==null?void 0:r.rotationType)??"geographic",p.orientation=o!=null?We(o,"radians","geographic"):void 0,p.orientationPrecision=l;break}}return t}}_updateFocusTooltip(){const{tooltipOptions:i,_tooltip:t}=this;if(i.enabled)if(this.getFocused()){const e=i.visualVariables,n=e==null?void 0:e.rotation,a=e==null?void 0:e.size,o=this.mode,{size:s,orientationClockwise:r}=this.adapter,l=r!=null&&(o==null||o==="rotate"),p=s!=null&&(o==null||o==="scale");t.info=this._absoluteTooltipInfo??(this._absoluteTooltipInfo=new pt({tooltipOptions:i}));const c=t.info;c.tooltipOptions=i,c.orientation=l?We(r,"radians","geographic"):void 0,c.orientationPrecision=xe(n==null?void 0:n.valueType),c.rotationType=(n==null?void 0:n.rotationType)??"geographic",c.size=p?de(s,"meters"):void 0,c.sizeUnit=a==null?void 0:a.unit,c.sizePrecision=xe(a==null?void 0:a.valueType)}else t.clear()}_onScaleChanged(){this.events.emit("scale-changed"),this._updateManipulatorTransform()}_updateDelayedFocusedState(){this._ringManipulator.updateStateEnabled(E.DelayedFocused,this.getFocused()),this._updateFocusTooltip()}_updateDragState(){var i;if(this._ringManipulator.updateStateEnabled(E.Unlocked,!(this._scaleRotateDragData!=null&&((i=this._scaleRotateDragData)==null?void 0:i.mode)!=="none")),this._scaleRotateDragData!=null)switch(this._scaleRotateDragData.mode){case"rotate":this._ringManipulator.updateStateEnabled(E.ScaleIn|E.ScaleOut,!1),this._ringManipulator.updateStateEnabled(E.RotateLeft,this._scaleRotateDragData.angleDir<0),this._ringManipulator.updateStateEnabled(E.RotateRight,this._scaleRotateDragData.angleDir>=0);break;case"scale":this._ringManipulator.updateStateEnabled(E.RotateLeft|E.RotateRight,!1),this._ringManipulator.updateStateEnabled(E.ScaleIn,this._scaleRotateDragData.scaleDir<0),this._ringManipulator.updateStateEnabled(E.ScaleOut,this._scaleRotateDragData.scaleDir>=0)}else this._ringManipulator.updateStateEnabled(E.ScaleIn|E.ScaleOut|E.RotateLeft|E.RotateRight,!1)}_updateManipulatorTransform(){const i=ca(F.get(),this.adapter.angle,B(0,0,1));if(i==null)return;const t=this.getScale(),e=Oe(F.get(),ct(x.get(),t,t,t));this._ringManipulator.modelTransform=we(F.get(),e,i)}_createRingManipulator(){const i=(A,q,tt)=>{const xt=[],wt=Math.ceil($a*(q-A)/(2*Math.PI));for(let k=0;k<wt+1;k++){const ae=A+k*(q-A)/wt;xt.push(B(tt*Math.cos(ae),tt*Math.sin(ae),0))}return xt},t=A=>i(0,2*Math.PI,A),e=A=>[[-A/2,0],[A/2,0],[A/2,Ke/2],[-A/2,Ke/2]],n=this._createMaterial(1),a=(A,q,tt=n)=>Xn(tt,e(q),A,[],[],!1),o=t(zt),s=a(o,Qe),r={left:new Array,right:new Array},l=[];for(let A=0;A<2;A++){const q=A*Math.PI-Math.PI/4,tt=Math.PI/2-rs,xt=q+tt,wt=q+Math.PI/2-tt,k=i(xt,wt,ns),ae=a(k,qt);l.push(k),l.push(i(xt,wt,Ni-Qe/2)),r.left.push(ae),r.right.push(ae.instantiate());for(let qe=0;qe<2;qe++){const Si=qe===0,W=ke();if(Si){da(W,W,[1,-1,1]),Ti(W,W,-xt,[0,0,1]);const Ct=Math.round(Zi*(k.length-1));W[12]=k[Ct][0],W[13]=k[Ct][1],W[14]=k[Ct][2]}else{Ti(W,W,wt,[0,0,1]);const Ct=Math.round((1-Zi)*(k.length-1));W[12]=k[Ct][0],W[13]=k[Ct][1],W[14]=k[Ct][2]}const xi=Ae(n,os,0,ss,Ke);ya(xi,W),(Si?r.left:r.right).push(xi)}}const p=[];for(let A=0;A<2;A++){const q=A*Math.PI-Math.PI/4,tt=Math.PI/2-ls,xt=q+tt,wt=q+Math.PI/2-tt,k=i(xt,wt,Ni);p.push(a(k,qt))}const c=this._createMaterial(.66),d=this._createMaterial(.5),g=this._createMaterial(.33),m=t(zt+Fi),_=t(zt+Bi),v=a(m,qt,c),y=a(_,qt,g),b=t(zt-Fi),M=t(zt-Bi),T=a(b,qt,c),D=a(M,qt,g);let X=[new w(s,E.DelayedFocused),new w(s.instantiate({material:d}),O.None)];this.mode&&this.mode!=="scale"||(X=X.concat([...p.map(A=>new w(A,E.DelayedFocused|E.Unlocked)),new w(v,E.DelayedFocused|E.ScaleIn),new w(y,E.DelayedFocused|E.ScaleIn),new w(T,E.DelayedFocused|E.ScaleOut),new w(D,E.DelayedFocused|E.ScaleOut)])),this.mode&&this.mode!=="rotate"||(X=X.concat([...r.right.map(A=>new w(A.instantiate(),E.DelayedFocused|E.Unlocked)),...r.left.map(A=>new w(A,E.DelayedFocused|E.RotateLeft)),...r.right.map(A=>new w(A,E.DelayedFocused|E.RotateRight))]));const j=[o,...l];return new et({view:this.tool.view,renderObjects:X,autoScaleRenderObjects:!1,worldOriented:!0,radius:Qe,focusMultiplier:1,touchMultiplier:1.5,elevationInfo:z(this.tool.graphicState.graphic),collisionType:{type:"ribbon",paths:j,direction:B(0,0,1)}})}_createMaterial(i){const t=new _i({cullFace:li.Back,renderOccluded:It.Transparent,isDecoration:!0});return this.addHandles(f(()=>({color:_n(this.tool.view.effectiveTheme.accentColor,i)}),e=>t.setParameters(e),$)),t}get test(){return{ringManipulator:this._ringManipulator,setRingIndicatorDelayMs:i=>this._ringIndicatorDelayMs=i,tooltip:this._tooltip}}};function ws(i,t){const e=L(x.get(),t.renderStart,i.origin),n=L(x.get(),t.renderEnd,i.origin),a=te(e),o=te(n);return a===0?0:o/a}function Os(i,t,e,n){const{renderStart:a,renderEnd:o}=i,s=Se(a,n,x.get()),r=Se(o,n,x.get());if(vn(s,r)<Yi*Yi)return null;const l=L(x.get(),a,e),p=Dt(x.get(),l,_e(t)),c=a,d=At(x.get(),c,p),g=Se(e,n,x.get()),m=s,_=Se(d,n,x.get()),v=L(x.get(),_,m),y=L(x.get(),s,g),b=Ai(m,v),M=Ai(g,y);return Gi(b,r)<Gi(M,r)?"rotate":"scale"}function Se(i,t,e){return t.projectToScreen(i,ti),ct(e,ti[0],ti[1],0)}var ee;function aa(i,t){let e=null,n=1;const a=()=>n;return{start:()=>{n=i.getScale(),e=i.getScale,i.getScale=a,t()},update:o=>(n+=((n+1)/2-n)*Math.min(o*hs,1),t(),Math.abs(n-1)<.01?ee.STOP:ee.CONTINUE),destroy:()=>{e&&(i.getScale=e),t()}}}function Es(i,t,e){let n=0,a=null;const o=()=>!1;return{start:()=>{a=i.getFocused,i.getFocused=o,n=0,t()},update:s=>(n+=s,!(a!=null&&a())||n>=e.delayMs?ee.STOP:ee.CONTINUE),destroy:()=>{a&&(i.getFocused=a),t()}}}function xe(i){switch(i){case"integer":case"long":return 0;default:return null}}h([u({constructOnly:!0})],_t.prototype,"tool",void 0),h([u({constructOnly:!0})],_t.prototype,"adapter",void 0),h([u({constructOnly:!0})],_t.prototype,"tooltipOptions",void 0),h([u()],_t.prototype,"mode",void 0),h([u()],_t.prototype,"_activeAnimation",void 0),h([u()],_t.prototype,"updating",null),_t=h([V("esri.views.3d.interactive.editingTools.transformGraphic.GraphicScaleRotateTransform")],_t),function(i){i[i.CONTINUE=0]="CONTINUE",i[i.STOP=1]="STOP"}(ee||(ee={}));const ti=ze();function La(i){return i.geometry!=null&&i.geometry.type==="mesh"?Ts(i.geometry):As(i)}function Ts(i){return i.vertexSpace.isRelative?Gs(i,i.transform,i.vertexSpace):Ds(i)}function As(i){let t=i.geometry,e=null;return{undo(n){e=n.geometry,n.geometry=t},redo(n){t=n.geometry,n.geometry=e}}}function Gs(i,t,e){let n=t==null?void 0:t.clone(),a=le(e.origin),o=null,s=null;return{undo:r=>{var l;o=(l=i.transform)==null?void 0:l.clone(),s=le(e.origin),i.transform=n,i.vertexSpace.origin=a,r.notifyMeshTransformChanged()},redo:r=>{var l;n=(l=i.transform)==null?void 0:l.clone(),a=le(e.origin),i.transform=o,i.vertexSpace.origin=s,r.notifyMeshTransformChanged()}}}function Ds(i){let t,e=i.vertexAttributes.clonePositional();return{undo:n=>{t=i.vertexAttributes.clonePositional(),i.vertexAttributes=e,n.notifyGeometryChanged()},redo:n=>{e=i.vertexAttributes.clonePositional(),i.vertexAttributes=t,n.notifyGeometryChanged()}}}let J=class extends Yt{constructor(i){super(i),this._interactionState=null}initialize(){this.addHandles([Xt(()=>{const i=this._interactionState;return i&&i.angle!==i.previousAngle?{interactionState:i,angle:i.state.angle}:null},({interactionState:i})=>{this._updateMeshRotation(i)},Te),Xt(()=>{const i=this._interactionState;return i&&i.scale!==i.previousScale?{interactionState:i,scale:i.state.scale}:null},({interactionState:i})=>{this._updateMeshSize(i)},Te)])}get initialAngle(){var i;return((i=this._interactionState)==null?void 0:i.initialAngle)??0}get angle(){var e;const i=this.geometry.transform;if(i==null)return((e=this._interactionState)==null?void 0:e.angle)??0;const t=yn(i.rotation)[2];return Math.abs(t)>.999999?He(Mn(i.rotation))*Math.sign(t):0}get angleClockwise(){return-this.angle}get relativeAngle(){return this.angle-this.initialAngle}get relativeAngleClockwise(){return-this.relativeAngle}get scale(){var i;return((i=this._interactionState)==null?void 0:i.scale)??1}startInteraction(){const i=new vt({angle:this.angle});this._interactionState=i;const t=()=>{this._interactionState=null};return{state:i,done:t,cancel:()=>{i.cancel(),t()}}}createUndoRecord(){return La(this.graphic)}_updateMeshRotation(i){const{angle:t,previousAngle:e}=i;i.previousAngle=t;const{geometry:n}=this,{vertexSpace:a}=n,o=ce(t-e);if(a.isGeoreferenced){const s=!a.isRelative&&this.viewingMode===oi.Global,r=this.geometry.anchor;this.geometry.rotate(0,0,o,{origin:r,geographic:s}),this.graphic.notifyGeometryChanged()}else{n.transform??(n.transform=new Di);const{transform:s}=n,r=bn(0,0,o,Is);s.rotation=Sn(s.rotation,r,s.rotation),this.graphic.notifyMeshTransformChanged()}}_updateMeshSize(i){const{scale:t,previousScale:e}=i;i.previousScale=t;const{geometry:n}=this,{vertexSpace:a}=n,o=t/e;if(a.isGeoreferenced){const s=!a.isRelative&&this.viewingMode===oi.Global,r=this.geometry.anchor;this.geometry.scale(o,{origin:r,geographic:s}),this.graphic.notifyGeometryChanged()}else{n.transform??(n.transform=new Di);const{transform:s}=n;s.scale=Vt(s.scale,s.scale,o),this.graphic.notifyMeshTransformChanged()}}};h([u({constructOnly:!0})],J.prototype,"graphic",void 0),h([u({constructOnly:!0})],J.prototype,"geometry",void 0),h([u({constructOnly:!0})],J.prototype,"viewingMode",void 0),h([u()],J.prototype,"initialAngle",null),h([u()],J.prototype,"angle",null),h([u()],J.prototype,"angleClockwise",null),h([u()],J.prototype,"relativeAngle",null),h([u()],J.prototype,"relativeAngleClockwise",null),h([u()],J.prototype,"scale",null),h([u()],J.prototype,"_interactionState",void 0),J=h([V("esri.views.3d.interactive.editingTools.transformGraphic.ScaleRotateMeshAdapter")],J);let vt=class extends Yt{get state(){const{angle:i,scale:t}=this;return{angle:i,scale:t}}constructor(i){super(i),this.angle=0,this.initialAngle=0,this.previousAngle=0,this.previousScale=1,this.scale=1,this.initialAngle=i.angle,this.previousAngle=i.angle}cancel(){this.angle=this.initialAngle,this.scale=1}};h([u()],vt.prototype,"angle",void 0),h([u()],vt.prototype,"initialAngle",void 0),h([u()],vt.prototype,"previousAngle",void 0),h([u()],vt.prototype,"previousScale",void 0),h([u()],vt.prototype,"scale",void 0),h([u()],vt.prototype,"state",null),vt=h([V("InteractionState")],vt);const Is=fn();let P=class extends Yt{constructor(i){super(i),this.sizeAxis=null,this._interactionState=null}initialize(){this.addHandles(Xt(()=>this._interactionState!=null?this._interactionState.state:null,i=>{this._updateSymbol(i)},Te))}get initialAngle(){var i;return((i=this._interactionState)==null?void 0:i.initialAngle)??0}get angle(){return this._interactionState!=null?this._interactionState.angle:this._orientationReferenceSymbolLayer!=null?$s(this._orientationReferenceSymbolLayer.heading??0):0}get angleClockwise(){return-this.angle}get orientation(){return this.angle}get orientationClockwise(){return this.angleClockwise}get relativeAngle(){return this.angle-this.initialAngle}get relativeAngleClockwise(){return-this.relativeAngle}get scale(){var i;return((i=this._interactionState)==null?void 0:i.scale)??1}get size(){const i=this._sizeReferenceSymbolLayer;if(i==null)return null;const t=this.findLayerView(),e=this._graphicSymbol;if(t==null||e==null||e.type!=="point-3d")return null;const n=t.getSymbolLayerSize(e,i);if("size"in n&&n.size!=null)return n.size;const a=this.sizeAxis;return!("width"in n)||n.width==null||a!=null&&a!=="width"&&a!=="all"&&a!=="width-and-depth"?!("depth"in n)||i.depth==null||a!=null&&a!=="depth"&&a!=="all"&&a!=="width-and-depth"?!("height"in n)||i.height==null||a!=null&&a!=="height"&&a!=="all"?null:n.height:n.depth:n.width}get _sizeReferenceSymbolLayer(){const i=this._graphicSymbol;return i==null||i.symbolLayers.length===0?null:i.symbolLayers.find(t=>t.type==="object")}get _orientationReferenceSymbolLayer(){const i=this._graphicSymbol;return i==null||i.symbolLayers.length===0?null:i.symbolLayers.find(t=>t.type==="object"&&t.heading!=null)}get _graphicSymbol(){var i;return((i=this.graphic)==null?void 0:i.symbol)!=null&&this.graphic.symbol.type==="point-3d"?this.graphic.symbol:null}set _graphicSymbol(i){this.graphic.symbol=i}startInteraction(){const i=this._graphicSymbol,t=this.findLayerView();if(this._interactionState!=null||i==null||t==null)return Rs;const e=i.symbolLayers.map(r=>r.type==="object"?t.getSymbolLayerSize(i,r):null).toArray(),n=i.clone(),a=this.angle,o=new ft({originalSymbol:n,angle:a,initialSizes:e});this._interactionState=o;const s=()=>{this._interactionState=null};return{state:o,done:s,cancel:()=>{this._graphicSymbol=n,s()}}}createUndoRecord(){let i=this.graphic.symbol,t=null;return{undo:e=>{t=e.symbol,e.symbol=i},redo:e=>{i=e.symbol,e.symbol=t}}}_updateSymbol({scale:i,angle:t,originalSymbol:e,initialSizes:n}){const a=this._graphicSymbol;if(a==null||a.type!=="point-3d")return;const o=a.clone(),s=-ce(t-this.initialAngle);let r=!1;this._forEachObjectSymbolLayerPair(e,o,(l,p,c)=>{const d=(l.heading??0)+s;p.heading!==d&&(p.heading=d,r=!0);const g=n[c];if(g!=null&&"width"in g){g.width=this.sizeFilter(g.width),g.height=this.sizeFilter(g.height),g.depth=this.sizeFilter(g.depth);const m=g.width*i;p.width!==m&&(p.width=m,r=!0);const _=g.depth*i;p.depth!==_&&(p.depth=_,r=!0);const v=g.height*i;p.height!==v&&(p.height=v,r=!0)}}),r&&(this._graphicSymbol=o)}_forEachObjectSymbolLayerPair(i,t,e){i.symbolLayers.forEach((n,a)=>{const o=t.symbolLayers.at(a);n.type==="object"&&o.type==="object"&&e(n,o,a)})}};function $s(i){return-He(i)}h([u()],P.prototype,"initialAngle",null),h([u()],P.prototype,"angle",null),h([u()],P.prototype,"angleClockwise",null),h([u()],P.prototype,"orientation",null),h([u()],P.prototype,"orientationClockwise",null),h([u()],P.prototype,"relativeAngle",null),h([u()],P.prototype,"relativeAngleClockwise",null),h([u()],P.prototype,"scale",null),h([u()],P.prototype,"size",null),h([u()],P.prototype,"sizeAxis",void 0),h([u({constructOnly:!0})],P.prototype,"graphic",void 0),h([u()],P.prototype,"_interactionState",void 0),h([u({constructOnly:!0})],P.prototype,"findLayerView",void 0),h([u({constructOnly:!0})],P.prototype,"sizeFilter",void 0),h([u()],P.prototype,"_sizeReferenceSymbolLayer",null),h([u()],P.prototype,"_orientationReferenceSymbolLayer",null),h([u()],P.prototype,"_graphicSymbol",null),P=h([V("esri.views.3d.interactive.editingTools.transformGraphic.ScaleRotateObjectSymbol3DAdapter")],P);const Rs={state:{angle:0,scale:0},done:()=>{},cancel:()=>{}};let ft=class extends Yt{get state(){const{originalSymbol:i,angle:t,initialAngle:e,scale:n,initialSizes:a}=this;return{originalSymbol:i,angle:t,initialAngle:e,scale:n,initialSizes:a}}constructor(i){super(i),this.angle=0,this.initialAngle=0,this.scale=1,this.initialAngle=i.angle}};h([u()],ft.prototype,"originalSymbol",void 0),h([u()],ft.prototype,"angle",void 0),h([u()],ft.prototype,"initialAngle",void 0),h([u()],ft.prototype,"initialSizes",void 0),h([u()],ft.prototype,"scale",void 0),h([u()],ft.prototype,"state",null),ft=h([V("InteractionState")],ft);let K=class extends $t.EventedMixin(Ye){constructor(i){super(i),this.enableZ=!0,this.enableRotation=!0,this.enableScaling=!0,this.tooltipOptions=new Rt,this.type="transform-3d",this._updatingHandles=new di,this._scaleRotate=null,this._tooltip=null,this._translateGraphicTooltipInfo=null,this._translateGraphicXYTooltipInfo=null,this._translateGraphicZTooltipInfo=null}initialize(){const{graphic:i,view:t}=this;this.graphicState=new Ft({graphic:i}),this.addHandles(f(()=>this.tooltipOptions.enabled,o=>{this._tooltip=o?new ve({view:t}):R(this._tooltip)},Jt)),this._moveManipulation=new Ut({tool:this,view:t,snapToScene:this.snapToScene,xyAvailable:!0,xyAxisAvailable:!0,zAvailable:this.enableZ&&kt(i),radius:Ut.radiusForSymbol(i.symbol)}),this._moveManipulation.forEachManipulator(o=>this.addHandles(o.events.on("immediate-click",s=>{this.emit("immediate-click",{...s,graphic:i}),s.stopPropagation()})));const e=o=>s=>{this.addHandles(s.events.on("focus-changed",({action:r})=>{const l=this._tooltip;l!=null&&(r==="focus"?this._updateMoveTooltip(o):l.clear())}))};this._moveManipulation.xyManipulation.forEachManipulator(e(S.XY)),this._moveManipulation.xyAxisManipulation.forEachManipulator(e(S.XY_AXIS)),this._moveManipulation.zManipulation.forEachManipulator(e(S.Z));const n=z(i);this._moveManipulation.elevationInfo=n,this.addHandles(fi(this.graphicState));const{geometry:a}=i;if(this._moveManipulation.createGraphicDragPipeline((o,s,r,l,p)=>{if(a!=null&&o===S.XY){const{snappingStep:c,cancelSnapping:d}=$e({snappingContext:new Ie({elevationInfo:n,pointer:p,editGeometryOperations:Ze.fromGeometry(new xn({spatialReference:a.spatialReference}),t.state.viewingMode),visualizer:new ue,excludeFeature:i}),snappingManager:this.snappingManager,updatingHandles:this._updatingHandles,useZ:!1});l=l.next(d),r=r.next(co(this.view,n)).next(...c)}return{steps:r=r.next(c=>(this._updateMoveTooltip(o,c),c)),cancel:l}},this.graphicState,o=>{const{action:s,graphic:r,dxScreen:l,dyScreen:p}=o,c={graphic:r,dxScreen:l,dyScreen:p};switch(s){case"start":this.emit("graphic-translate-start",c),this.emit("record-undo",{record:this._createGeometryUndoRecord()});break;case"update":this.emit("graphic-translate",c);break;case"end":this.emit("graphic-translate-stop",c)}}),this._moveManipulation.angle=this._scaleRotate!=null?this._scaleRotate.angle:0,this._scaleRotateAdapter=this._createScaleRotateAdapter(),this.addHandles(f(()=>this._scaleRotateAdapter.angle,()=>this._updateMoveAngle())),this.enableScaling||this.enableRotation){const o=this.enableScaling&&this.enableRotation?null:this.enableScaling?"scale":"rotate";this._scaleRotate=new _t({tool:this,mode:o,adapter:this._scaleRotateAdapter,tooltipOptions:this.tooltipOptions}),this.addHandles(this._scaleRotate.events.on("scale-changed",()=>this._onScaleChanged()))}this.addHandles([Be({view:this.view,graphic:this.graphic,forEachManipulator:o=>this._forEachManipulator(o),onManipulatorsChanged:()=>Y()}),this.graphicState.on("changed",()=>this._onGeometryChanged()),this._hideManipulatorsForGraphicState(),f(()=>t.scale,()=>this._updateMoveAngle())].filter(wn)),this.addHandles(this.view.trackGraphicState(this.graphicState)),this._onGeometryChanged(),this._updateMoveAngle(),this._forEachManipulator(o=>{o instanceof et&&this.addHandles(o.events.on("grab-changed",()=>this._updateManipulatorsInteractive()))}),this.finishToolCreation()}destroy(){this._tooltip=R(this._tooltip),this._moveManipulation.destroy(),this._scaleRotate=R(this._scaleRotate),this._scaleRotateAdapter=R(this._scaleRotateAdapter),this._updatingHandles.destroy(),this._set("view",null),this._set("graphic",null)}_updateManipulatorsInteractive(){this._scaleRotate!=null&&(this._scaleRotate.interactive=!this._moveManipulation.grabbing,this._moveManipulation.interactive=!this._scaleRotate.grabbing)}_createScaleRotateAdapter(){var i,t,e;return this.graphic.geometry!=null&&this.graphic.geometry.type==="mesh"?new J({graphic:this.graphic,geometry:this.graphic.geometry,viewingMode:this.view.state.viewingMode}):new P({graphic:this.graphic,sizeFilter:n=>this._enforceNonZeroSize(n),findLayerView:()=>this.view.allLayerViews.find(n=>n.layer===this.graphic.layer),sizeAxis:((e=(t=(i=this.tooltipOptions)==null?void 0:i.visualVariables)==null?void 0:t.size)==null?void 0:e.axis)??null})}_forEachManipulator(i){var t,e;(t=this._moveManipulation)==null||t.forEachManipulator(i),(e=this._scaleRotate)==null||e.forEachManipulator(i)}_hideManipulatorsForGraphicState(){return f(()=>this.graphicState.displaying,i=>{this._forEachManipulator(t=>t.available=i),this._moveManipulation.zManipulation.available=i&&this.enableZ&&kt(this.graphic)})}_createGeometryUndoRecord(){return La(this.graphic)}set snapToScene(i){this._moveManipulation&&(this._moveManipulation.snapToScene=i),this._set("snapToScene",i)}get updating(){var i;return this._updatingHandles.updating||!!((i=this._scaleRotate)!=null&&i.updating)}set location(i){this._moveManipulation.location=i,this._scaleRotate&&(this._scaleRotate.location=i)}set elevationAlignedLocation(i){this._moveManipulation.elevationAlignedLocation=i,this._scaleRotate&&(this._scaleRotate.elevationAlignedLocation=i)}reset(){}onHide(){var i;(i=this._scaleRotate)==null||i.cancelActiveAnimation()}_onScaleChanged(){this._scaleRotate!=null&&(this._moveManipulation.displayScale=this._scaleRotate.getScale())}_updateMoveAngle(){this.view.state.viewingMode===oi.Local||this.view.scale<cs?this._moveManipulation.angle=this._scaleRotateAdapter.angle:this._moveManipulation.angle=0}_onGeometryChanged(){ba(this.view,this,this.graphic)}_enforceNonZeroSize(i){return i||this.view.state.camera.computeRenderPixelSizeAt(this._moveManipulation.renderLocation)}_updateMoveTooltip(i,t){const{tooltipOptions:e,_tooltip:n}=this;if(n==null)return;n.clear();const a=this.graphicState.isDraped?"on-the-ground":"absolute-height";switch(i){case S.XY:n.info=this._translateGraphicTooltipInfo??(this._translateGraphicTooltipInfo=new ge({tooltipOptions:e})),this._updateMoveTooltipDistance(n.info,t,(o,s)=>bt(o,s,a));break;case S.XY_AXIS:n.info=this._translateGraphicXYTooltipInfo??(this._translateGraphicXYTooltipInfo=new vi({tooltipOptions:e})),this._updateMoveTooltipDistance(n.info,t,(o,s)=>{const r=bt(o,s,a);return Ge(r,Le(t))});break;case S.Z:n.info=this._translateGraphicZTooltipInfo??(this._translateGraphicZTooltipInfo=new Fe({tooltipOptions:e})),this._updateMoveTooltipDistance(n.info,t,Re)}n.info.tooltipOptions=e}_updateMoveTooltipDistance(i,t,e){if(t!=null&&t.action!=="end"){const{mapStart:n,mapEnd:a}=t,o=e(n,a);i.distance=o??ht}else i.distance=ht}get test(){return{discManipulator:this._moveManipulation.xyManipulation.test.discManipulator,zManipulator:this._moveManipulation.zManipulation.test.manipulator,ringManipulator:this._scaleRotate!=null?this._scaleRotate.test.ringManipulator:null,arrowManipulators:this._moveManipulation.xyAxisManipulation.test.arrowManipulators,setRingIndicatorDelayMs:i=>this._scaleRotate!=null?this._scaleRotate.test.setRingIndicatorDelayMs(i):null,scaleRotateAdapter:this._scaleRotateAdapter,scaleRotateTransform:this._scaleRotate,tooltip:this._tooltip}}};h([u({constructOnly:!0,nonNullable:!0})],K.prototype,"view",void 0),h([u({constructOnly:!0,nonNullable:!0})],K.prototype,"graphic",void 0),h([u({constructOnly:!0,nonNullable:!0})],K.prototype,"enableZ",void 0),h([u()],K.prototype,"enableRotation",void 0),h([u()],K.prototype,"enableScaling",void 0),h([u({constructOnly:!0,type:Rt})],K.prototype,"tooltipOptions",void 0),h([u()],K.prototype,"graphicState",void 0),h([u({value:!1})],K.prototype,"snapToScene",null),h([u({constructOnly:!0})],K.prototype,"snappingManager",void 0),h([u({readOnly:!0})],K.prototype,"type",void 0),h([u({readOnly:!0})],K.prototype,"updating",null),K=h([V("esri.views.3d.interactive.editingTools.graphicTransform3D.GraphicTransformTool")],K);let Cs=class{constructor(t,e,n,a){this._tool=t,this._graphicState=e,this._editGeometryOperations=n,this._bounds=a,this._moveXYTooltipInfo=null,this._moveZTooltipInfo=null;const o=this._tool,s=o.view;this.moveXYGraphicManipulation=new bi({view:s,tool:o,graphicState:this._graphicState}),o.addHandles(this._createMoveXYGraphicDragPipeline()),this.moveZManipulator=new So(s,xo.CENTER_ON_CALLOUT),this.moveZManipulator.state|=wo,o.manipulators.add(this.moveZManipulator),o.addHandles([this._createMoveZDragPipeline()]),o.addHandles([o.on("graphic-translate-stop",()=>{this._moveXYTooltipInfo=null,this._moveZTooltipInfo=null})])}destroy(){this.moveXYGraphicManipulation.destroy(),this._tool.manipulators.remove(this.moveZManipulator),this.moveZManipulator.destroy()}forEachManipulator(t){this.moveXYGraphicManipulation.forEachManipulator(t),t(this.moveZManipulator,G.TRANSLATE_Z)}updateManipulators(t,e){const n=this.moveZManipulator,a=On(F.get(),t,Math.PI);a[12]=0,a[13]=0,a[14]=0,n.modelTransform=a,n.renderLocation=L(x.get(),e.origin,e.basis1)}getUpdatedTooltipInfo(){return this.moveXYGraphicManipulation.grabbing||this.moveXYGraphicManipulation.dragging?this._computeMoveXYTooltipInfo():this.moveZManipulator.focused?this._computeMoveZTooltipInfo():null}_computeMoveXYTooltipInfo(){const t=this._tool.tooltipOptions;return this._moveXYTooltipInfo??(this._moveXYTooltipInfo=new ge({tooltipOptions:t}))}_computeMoveZTooltipInfo(){const t=this._tool,e=t.tooltipOptions,n=this._moveZTooltipInfo??(this._moveZTooltipInfo=new Fe({tooltipOptions:e}));if(this.moveZManipulator.dragging){const a=this._bounds,o=a.mapBoundsStart.origin,s=a.mapBounds.origin,r=yo(o,s,this._tool.view.spatialReference);if(r==null)return null;n.distance=r}else n.distance=de(0,t.moveUnit);return n}_updateMoveTooltip(t,e){if(e===S.XY||e===S.XY_AXIS){const n=bt(t.mapStart,t.mapEnd,this._graphicState.isDraped?"on-the-ground":"absolute-height");n!=null&&this._moveXYTooltipInfo!=null&&(this._moveXYTooltipInfo.distance=n)}return t}_createMoveXYGraphicDragPipeline(){return this.moveXYGraphicManipulation.createDragPipeline((t,e,n)=>this._applyGraphicMoveSteps(e,n,S.XY))}_createMoveZDragPipeline(){const t=this._editGeometryOperations.data.spatialReference;return rt(this.moveZManipulator,(e,n,a)=>{const o=le(e.renderLocation),s=n.next(wa(this._tool.view,o,t)).next(ie());this._applyGraphicMoveSteps(s,a,S.Z)})}_applyGraphicMoveSteps(t,e,n){const a=this._tool,o=a.graphic,s=t.next(r=>(r.action==="start"&&(a.inputState={type:"move"},this._bounds.backupMapBounds(),a.emit("graphic-translate-start",{graphic:o,dxScreen:r.screenDeltaX,dyScreen:r.screenDeltaY})),r)).next(Kt()).next(this._moveDragUpdateGeometry()).next(r=>{const l={graphic:o,dxScreen:r.screenDeltaX,dyScreen:r.screenDeltaY};switch(r.action){case"start":case"update":(r.mapEnd.x-r.mapStart.x||r.mapEnd.y-r.mapStart.y||(r.mapEnd.z??0)-(r.mapStart.z??0))&&a.emit("graphic-translate",l);break;case"end":a.inputState=null,a.emit("graphic-translate-stop",l)}return r}).next(r=>this._updateMoveTooltip(r,n));return e.next(()=>{a.inputState!=null&&a.emit("graphic-translate-stop",{graphic:o,dxScreen:0,dyScreen:0}),a.cancel()}),s}_moveDragUpdateGeometry(){const t=this._tool;return e=>{if(t.inputState==null||t.inputState.type!=="move")return e;const n=[];for(const s of this._editGeometryOperations.data.components)n.push(...s.vertices);const a=e.action==="start"?St.NEW_STEP:St.ACCUMULATE_STEPS,o=this._editGeometryOperations.moveVertices(n,e.mapDeltaX,e.mapDeltaY,e.mapDeltaZ,a);return Xe(o,this._bounds.mapBounds),t.graphic.geometry=this._editGeometryOperations.data.geometry,e}}};class Ls{constructor(t,e,n){var r;this._tool=t,this._editGeometryOperations=e,this._bounds=n,this._rotateTooltipInfo=null,this._startAngle=0,this._endAngle=0;const a=this._tool,o=a.view,s=!((r=o._stage)!=null&&r.renderView.renderingContext.driverTest.svgPremultipliesAlpha.result);this.rotateManipulator=new Oo(o,(l,p)=>Co(o.textures,{accentColor:l,contrastColor:p,preMultiplyAlpha:s})),a.addHandles([this.rotateManipulator.events.on("grab-changed",l=>this._onRotateGrab(l)),this._createRotateDragPipeline(this.rotateManipulator)]),a.manipulators.add(this.rotateManipulator),a.addHandles([a.on("graphic-rotate-start",l=>{this._startAngle=l.angle}),a.on("graphic-rotate",l=>{this._endAngle=l.angle}),a.on("graphic-rotate-stop",()=>{this._startAngle=0,this._endAngle=0})])}destroy(){this._tool.manipulators.remove(this.rotateManipulator),this.rotateManipulator.destroy()}forEachManipulator(t){t(this.rotateManipulator,G.ROTATE)}updateManipulators(t,e){const n=this._bounds.mapBounds.plane[2]<0?Math.PI:0,a=ua(F.get(),t,n);a[12]=0,a[13]=0,a[14]=0,this.rotateManipulator.modelTransform=a,this.rotateManipulator.renderLocation=At(x.get(),e.origin,e.basis1)}getUpdatedTooltipInfo(){return this.rotateManipulator.focused?this._computeRotateTooltipInfo():null}_computeRotateTooltipInfo(){const t=this._tool.tooltipOptions,e=this._rotateTooltipInfo??(this._rotateTooltipInfo=new Lo({tooltipOptions:t}));return e.angle=this._startAngle-this._endAngle,e}_onRotateGrab({action:t,screenPoint:e}){const n=this._tool,a=this._bounds;if(t!=="start"||!e)return;const o=Eo(a.displayBounds,n.view.renderCoordsHelper,To.HEADING,pi()),s=Ga(n.view.state.camera,e);va(o,s,x.get())&&(a.backupMapBounds(),n.inputState={type:"rotate",rotatePlane:o})}_createRotateDragPipeline(t){const e=this._tool,n=e.graphic;return rt(t,(a,o,s)=>{const r=e.inputState;r!=null&&(o.next(l=>(l.action==="start"&&e.emit("graphic-rotate-start",{graphic:n,angle:0}),l)).next(mi(e.view,r.rotatePlane)).next(this._rotateDragRenderPlaneToRotate(r)).next(this._rotateDragUpdateGeometry()).next(l=>{const p={graphic:n,angle:ce(l.rotateAngle)};switch(l.action){case"start":case"update":e.emit("graphic-rotate",p);break;case"end":e.inputState=null,e.emit("graphic-rotate-stop",p)}return l}),s.next(()=>{e.inputState!=null&&e.emit("graphic-rotate-stop",{graphic:n,angle:0}),e.cancel()}))})}_rotateDragRenderPlaneToRotate(t){return e=>{const n=_e(t.rotatePlane),a=Sa(e.renderStart,e.renderEnd,this._bounds.displayBounds.origin,n);return{...e,rotateAxis:n,rotateAngle:a}}}_rotateDragUpdateGeometry(){const t=this._tool,e=this._bounds;return n=>{const a=ai(H(),e.mapBoundsStart.origin),o=[];for(const l of this._editGeometryOperations.data.components)o.push(...l.vertices);const s=n.action==="start"?St.NEW_STEP:St.ACCUMULATE_STEPS,r=this._editGeometryOperations.rotateVertices(o,a,n.rotateAngle,s,Ea.REPLACE);return me(e.mapBoundsStart,e.mapBounds),Xe(r,e.mapBounds),t.graphic.geometry=this._editGeometryOperations.data.geometry,n}}}class Ps{constructor(t,e,n){this._tool=t,this._onDisplayBoundsChanged=e,this.mapBounds=he(),this.mapBoundsStart=he(),this.displayBounds=he(),this._calculateMapBounds(n)}get displayBoundsMargin(){var a,o,s;const{view:t,graphic:e}=this._tool,n=((a=t.pointsOfInterest)==null?void 0:a.centerOnSurfaceFrequent.location)??((s=(o=e.geometry)==null?void 0:o.extent)==null?void 0:s.center);return n?zs*t.pixelSizeAt(n):0}backupMapBounds(){me(this.mapBounds,this.mapBoundsStart)}updateDisplayBounds(){this._calculateDisplayBounds(),this._onDisplayBoundsChanged()}_calculateMapBounds(t){const{view:e,attachmentOrigin:n}=this._tool,a=t.geometry,o=Xo(a);la(o,o,-1);const s=e.spatialReference,r=a.spatialReference,l=n?e.pixelSizeAt(n)*En(s)/_a(r):0;Fn(o,t,Hs*l,this.mapBounds)}_calculateDisplayBounds(){const{view:t,attachmentOrigin:e,graphic:n}=this._tool;if(!n.geometry)return;const a=(e==null?void 0:e.z)??ci(this.mapBounds.origin,t.elevationProvider,ui.fromElevationInfo(z(n)),t.renderCoordsHelper),o=me(this.mapBounds);o.origin[2]=a??0,Vs(o,t.renderCoordsHelper,n.geometry.spatialReference,this.displayBoundsMargin,this.displayBounds)}}const zs=10,Hs=80;function Vs(i,t,e,n=0,a){a||(a=he()),t.toRenderCoords(i.origin,e,a.origin);const o=x.get();At(o,i.origin,i.basis1),At(o,o,i.basis2),t.toRenderCoords(o,e,o);const s=x.get();At(s,i.origin,i.basis1),L(s,s,i.basis2),t.toRenderCoords(s,e,s);const r=x.get();L(r,i.origin,i.basis1),L(r,r,i.basis2),t.toRenderCoords(r,e,r);const l=x.get();L(l,i.origin,i.basis1),At(l,l,i.basis2),t.toRenderCoords(l,e,l);const p=Pt(x.get(),o,s,.5);L(p,p,a.origin);const c=Pt(x.get(),r,l,.5);L(c,a.origin,c),Pt(a.basis1,p,c,.5);const d=Pt(x.get(),l,o,.5);L(d,d,a.origin);const g=Pt(x.get(),s,r,.5);L(g,a.origin,g),Pt(a.basis2,d,g,.5);const m=Dt(x.get(),a.basis1,a.basis2),_=Dt(m,m,a.basis1);return ei(_,_),Vt(a.basis2,_,Ee(a.basis2,_)),Vt(a.basis1,a.basis1,1+n/te(a.basis1)),Vt(a.basis2,a.basis2,1+n/te(a.basis2)),Ro(a),a}function na(i,t,e,n){const a=x.get();L(a,L(a,i.origin,i.basis1),i.basis2);const o=x.get();Ht(o,a,i.basis1,2);const s=x.get();Ht(s,o,i.basis2,2);const r=x.get();Ht(r,a,i.basis2,2),a[2]=o[2]=s[2]=r[2]=t;const l=n?"on-the-ground":"absolute-height",p=Ci(ye(a,o,e,l),ye(r,s,e,l)),c=Ci(ye(o,s,e,l),ye(a,r,e,l));return c==null||p==null?null:[p,c]}class ks{get zMax(){if(!this._zMaxDirty)return this._zMax;const t=this._editGeometryOperations.data;if(t.geometry.hasZ){const e=t.coordinateHelper;this._zMax=Number.NEGATIVE_INFINITY;for(const n of t.components)for(const a of n.vertices){const o=e.getZ(a.pos)??0;this._zMax=Math.max(o,this._zMax)}}else this._zMax=0;return this._zMaxDirty=!1,this._zMax}constructor(t,e,n,a,o){this._tool=t,this._graphicState=e,this._editGeometryOperations=n,this._bounds=a,this._preserveAspectRatioStep=o,this._resizeHandles=[{direction:[1,0]},{direction:[1,1]},{direction:[0,1]},{direction:[-1,1]},{direction:[-1,0]},{direction:[-1,-1]},{direction:[0,-1]},{direction:[1,-1]}],this._scaleTooltipInfo=null,this._displayBoundsStart=he(),this._displayBoundsMarginStart=0,this._startScale=re(),this._endScale=re(),this._sizeStart=null,this._zMax=0,this._zMaxDirty=!0;const s=this._tool,r=s.view;this.resizeManipulators=this._resizeHandles.map(l=>{const p=new Ao(r,l);return s.addHandles([p.events.on("grab-changed",c=>this._onResizeGrab(c)),this._createResizeDragPipeline(p,l)]),p}),s.manipulators.addMany(this.resizeManipulators),s.addHandles([s.on("graphic-scale-start",l=>{Et(this._startScale,l.xScale,l.yScale),Et(this._endScale,l.xScale,l.yScale)}),s.on("graphic-scale",l=>{Et(this._endScale,l.xScale,l.yScale)}),s.on("graphic-scale-stop",()=>{Et(this._startScale,0,0),Et(this._endScale,0,0)}),this._graphicState.on("changed",()=>{var l;((l=s.inputState)==null?void 0:l.type)!=="resize"&&(this._zMaxDirty=!0)})])}destroy(){this.forEachManipulator(t=>{this._tool.manipulators.remove(t),t.destroy()})}forEachManipulator(t){this.resizeManipulators.forEach(e=>t(e,G.SCALE))}updateManipulators(t,e){this.resizeManipulators.forEach((n,a)=>{Go(n,this._resizeHandles[a],t,e)})}getUpdatedTooltipInfo(){return this.resizeManipulators.some(t=>t.focused)?this._computeScaleTooltipInfo():null}_computeScaleTooltipInfo(){const t=this._tool,e=t.tooltipOptions,n=this._scaleTooltipInfo??(this._scaleTooltipInfo=new Po({tooltipOptions:e})),a=t.graphic.geometry;if(a==null)return null;const o=na(this._bounds.mapBounds,this.zMax,a.spatialReference,this._graphicState.isDraped);return o==null?null:(n.xSize=o[0],n.ySize=o[1],this._sizeStart!=null&&this.resizeManipulators.some(s=>s.dragging)?(n.xScale=o[0].value/this._sizeStart[0].value,n.yScale=o[1].value/this._sizeStart[1].value):(n.xScale=1,n.yScale=1),n)}_onResizeGrab({action:t,screenPoint:e}){const n=this._tool,a=this._bounds;if(t!=="start"||!e||!n.graphic.geometry)return;const o=Ga(n.view.state.camera,e);va(a.displayBounds.plane,o,x.get())&&(a.backupMapBounds(),me(a.displayBounds,this._displayBoundsStart),this._displayBoundsMarginStart=a.displayBoundsMargin,this._sizeStart=na(a.mapBoundsStart,this.zMax,n.graphic.geometry.spatialReference,this._graphicState.isDraped),n.inputState={type:"resize"})}_createResizeDragPipeline(t,e){const n=this._tool,a=n.graphic;return rt(t,(o,s,r)=>{n.inputState!=null&&(s.next(l=>(l.action==="start"&&n.emit("graphic-scale-start",{graphic:a,xScale:1,yScale:1}),l)).next(mi(n.view,this._displayBoundsStart.plane)).next(l=>({...l,handle:e})).next(this._resizeDragRenderPlaneToFactors()).next(...this._preserveAspectRatioStep()).next(this._resizeDragUpdateGeometry()).next(l=>{const p={graphic:a,xScale:l.factor1,yScale:l.factor2};switch(l.action){case"start":case"update":n.emit("graphic-scale",p);break;case"end":n.inputState=null,n.emit("graphic-scale-stop",p)}return l}),r.next(()=>{n.inputState!=null&&n.emit("graphic-scale-stop",{graphic:a,xScale:1,yScale:1}),n.cancel()}))})}_resizeDragRenderPlaneToFactors(){const t=this._bounds;return e=>{const n=this._displayBoundsStart,a=e.handle.direction,o=t.displayBoundsMargin,s=this._displayBoundsMarginStart,r=ai(x.get(),n.origin);Ht(r,r,n.basis1,-a[0]),Ht(r,r,n.basis2,-a[1]);const l=L(x.get(),e.renderEnd,r),p=L(x.get(),e.renderStart,r),c=Aa(e.handle),d=Vi(n),g=Vi(t.displayBounds)/d,m=(_,v)=>{if(_===0)return 1;let y=te(v),b=.5*_*Ee(v,l)/y;const M=b<0?-1:1;c&&(b+=(y-.5*_*Ee(v,p)/y)*M*g);const T=y<1.5*s?1:oa;return y=Math.max(y-s,oa),M>0&&(b-=o),M*Math.max(M*(b/y),T)};return{...e,factor1:m(a[0],n.basis1),factor2:m(a[1],n.basis2)}}}_resizeDragUpdateGeometry(){const t=this._tool,e=this._bounds;return n=>{const a=ai(H(),e.mapBoundsStart.origin);Ht(a,a,e.mapBoundsStart.basis1,-n.handle.direction[0]),Ht(a,a,e.mapBoundsStart.basis2,-n.handle.direction[1]);const o=Et(re(),e.mapBoundsStart.basis1[0],e.mapBoundsStart.basis1[1]);ra(o,o);const s=[];for(const p of this._editGeometryOperations.data.components)s.push(...p.vertices);const r=n.action==="start"?St.NEW_STEP:St.ACCUMULATE_STEPS,l=this._editGeometryOperations.scaleVertices(s,a,o,n.factor1,n.factor2,r,Ea.REPLACE);return me(e.mapBoundsStart,e.mapBounds),Xe(l,e.mapBounds),t.graphic.geometry=this._editGeometryOperations.data.geometry,n}}}const oa=1e-6;class Us{constructor(){this._lastDragEvent=null,this._next=null,this._enabled=!1}get enabled(){return this._enabled}set enabled(t){if(this._enabled!==t&&this._lastDragEvent!=null&&this._next!=null){const e={...this._lastDragEvent,action:"update"};t&&this._adjustScaleFactors(e),this._next.execute(e)}this._enabled=t}createDragEventPipelineStep(){this._lastDragEvent=null;const t=new Oa;return this._next=t,[e=>(this._lastDragEvent=e.action!=="end"?{...e}:null,this._enabled&&this._adjustScaleFactors(e),e),t]}_adjustScaleFactors(t){const e=Aa(t.handle)?Math.max(Math.abs(t.factor1),Math.abs(t.factor2)):t.handle.direction[0]===0?Math.abs(t.factor2):Math.abs(t.factor1);t.factor1=t.factor1<0?-e:e,t.factor2=t.factor2<0?-e:e}get test(){return{_adjustScaleFactors:t=>this._adjustScaleFactors(t)}}}let Q=class extends $t.EventedMixin(Ye){constructor(i){super(i),this.enableZ=!0,this.enableScaling=!0,this.enableRotation=!0,this.tooltipOptions=new Rt,this._preserveAspectRatio=new Us,this.grabbing=!1,this.inputState=null,this._attachmentOrigin=null,this.type="transform-3d",this._outlineVisualElement=null}initialize(){const{view:i,graphic:t}=this,e=this._graphicState=new Ft({graphic:t}),n=t.geometry,a=this._editGeometryOperations=Ze.fromGeometry(n,i.state.viewingMode),o=this._bounds=new Ps(this,()=>this._updateManipulators(),a.data);this._extentMove=new Cs(this,e,a,o),this._extentScale=new ks(this,e,a,o,()=>this._preserveAspectRatio.createDragEventPipelineStep()),this._extentRotate=new Ls(this,a,o),this.addHandles([f(()=>this.enableZ,()=>this._updateManipulatorAvailability(this._extentMove.moveZManipulator,G.TRANSLATE_Z)),f(()=>this.enableScaling,()=>this._extentScale.forEachManipulator(p=>this._updateManipulatorAvailability(p,G.SCALE))),f(()=>this.enableRotation,()=>this._updateManipulatorAvailability(this._extentRotate.rotateManipulator,G.ROTATE))]),this._updateAllManipulatorAvailability();const s=Be({view:i,graphic:t,forEachManipulator:p=>this._forEachManipulator(p),onManipulatorsChanged:()=>Y()});if(s!=null){const{visualElement:p}=s;p instanceof Nt&&(this._outlineVisualElement=p,this.addHandles(p.events.on("attachment-origin-changed",()=>this._bounds.updateDisplayBounds()))),this.addHandles(s)}this.addHandles([e.on("changed",()=>this._onGeometryChanged()),f(()=>e.displaying,()=>this._updateAllManipulatorAvailability()),f(()=>e.isDraped,()=>this._graphicDrapedChanged(),$),f(()=>{var p;return(p=i.pointsOfInterest)==null?void 0:p.centerOnSurfaceFrequent.location},()=>o.updateDisplayBounds()),i.trackGraphicState(e)]);const r=p=>{this.addHandles(p.events.on("grab-changed",()=>{this.grabbing=p.grabbing,this._updateAllManipulatorAvailability()}))};this._forEachManipulator(r);const l=(p,c)=>{this.addHandles(p.events.on("immediate-click",d=>{c===G.TRANSLATE_XY&&this.emit("immediate-click",{...d,graphic:t}),d.stopPropagation()}))};this._forEachManipulator(l),this._initializeTooltip(),this.finishToolCreation()}destroy(){this._extentMove.destroy(),this._extentScale.destroy(),this._extentRotate.destroy(),this._editGeometryOperations.destroy(),this._tooltip.destroy(),this._set("view",null),this._set("graphic",null)}_initializeTooltip(){const{view:i}=this,t=this._tooltip=new ve({view:i}),e=()=>{t.info=this._getUpdatedTooltipInfo()};this.addHandles([this.on("graphic-translate-start",e),this.on("graphic-translate",e),this.on("graphic-translate-stop",()=>{this._tooltip.clear()}),this.on("graphic-rotate-start",e),this.on("graphic-rotate",e),this.on("graphic-rotate-stop",e),this.on("graphic-scale-start",e),this.on("graphic-scale",e),this.on("graphic-scale-stop",e)]),this._forEachManipulator(n=>{this.addHandles([n.events.on("focus-changed",e),n.events.on("grab-changed",e),n.events.on("drag",a=>{a.action==="cancel"?this._tooltip.clear():e()})])})}_getUpdatedTooltipInfo(){return this.tooltipOptions.enabled?this._extentMove.getUpdatedTooltipInfo()??this._extentScale.getUpdatedTooltipInfo()??this._extentRotate.getUpdatedTooltipInfo():null}_onGeometryChanged(){this._bounds.updateDisplayBounds()}_graphicDrapedChanged(){this.removeHandles(sa),this._bounds.updateDisplayBounds(),this._graphicState.isDraped&&this.addHandles(this.view.elevationProvider.on("elevation-change",i=>{this._attachmentOrigin!=null&&ha(i.extent,this._attachmentOrigin.x,this._attachmentOrigin.y)&&this._bounds.updateDisplayBounds()}),sa)}_updateManipulators(){if(!this.visible)return;const i=this._bounds.displayBounds,t=Do(i,F.get());this._extentMove.updateManipulators(t,i),this._extentScale.updateManipulators(t,i),this._extentRotate.updateManipulators(t,i)}_updateAllManipulatorAvailability(){this._forEachManipulator((i,t)=>this._updateManipulatorAvailability(i,t))}_updateManipulatorAvailability(i,t){const e=this.grabbing&&!i.grabbing;if(i.interactive=!e,i instanceof et){const n=this._graphicState.displaying,a=this.enableZ&&kt(this.graphic);switch(t){case G.ROTATE:i.available=n&&this.enableRotation;break;case G.SCALE:i.available=n&&(this.enableScaling||this.enableRotation||a),i.interactive=!e&&this.enableScaling,i.state=this.enableScaling?Io:$o;break;case G.TRANSLATE_Z:i.available=n&&a;break;default:i.available=n}}}_forEachManipulator(i){this._extentMove.forEachManipulator(i),this._extentScale.forEachManipulator(i),this._extentRotate.forEachManipulator(i)}get preserveAspectRatio(){return this._preserveAspectRatio.enabled}set preserveAspectRatio(i){this._preserveAspectRatio.enabled=i,this._set("preserveAspectRatio",i)}get moveUnit(){return Tn(this.view.spatialReference)??"meters"}get attachmentOrigin(){var e,n;const i=this.graphic.geometry,t=this._graphicState.isDraped?null:(e=this._outlineVisualElement)==null?void 0:e.attachmentOrigin;return this._attachmentOrigin=t??Ma(this.view,this.graphic)??((n=i==null?void 0:i.extent)==null?void 0:n.center),this._attachmentOrigin}reset(){}cancel(){if(this.canUndo){const i=this._editGeometryOperations.undo();Ri(i,this._bounds.mapBounds),this.graphic.geometry=this._editGeometryOperations.data.geometry}this.inputState=null}get canUndo(){return this._editGeometryOperations.canUndo}undo(){if(this.inputState!=null)this.view.activeTool=null;else if(this.canUndo){const i=this._editGeometryOperations.undo();Ri(i,this._bounds.mapBounds),this.graphic.geometry=this._editGeometryOperations.data.geometry}}get canRedo(){return this._editGeometryOperations.canRedo}redo(){if(this.canRedo){const i=this._editGeometryOperations.redo();Xe(i,this._bounds.mapBounds),this.graphic.geometry=this._editGeometryOperations.data.geometry}}get test(){return{moveZManipulator:this._extentMove.moveZManipulator,resizeManipulators:this._extentScale.resizeManipulators,rotateManipulator:this._extentRotate.rotateManipulator,tooltip:this._tooltip}}};h([u({constructOnly:!0,nonNullable:!0})],Q.prototype,"view",void 0),h([u({constructOnly:!0,nonNullable:!0})],Q.prototype,"graphic",void 0),h([u()],Q.prototype,"enableZ",void 0),h([u()],Q.prototype,"enableScaling",void 0),h([u()],Q.prototype,"enableRotation",void 0),h([u({constructOnly:!0,type:Rt})],Q.prototype,"tooltipOptions",void 0),h([u()],Q.prototype,"preserveAspectRatio",null),h([u()],Q.prototype,"moveUnit",null),h([u()],Q.prototype,"grabbing",void 0),h([u()],Q.prototype,"inputState",void 0),h([u({readOnly:!0})],Q.prototype,"type",void 0),Q=h([V("esri.views.3d.interactive.editingTools.transformGraphic.ExtentTransformTool")],Q);const sa="draped-elevation-changes";export{Bt as DrawGraphicTool3D,Q as ExtentTransformTool,dt as GraphicMoveTool,U as GraphicReshapeTool,K as GraphicTransformTool};
