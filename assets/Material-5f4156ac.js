import{aR as it,gH as h,hW as tt,fO as J,b0 as ot,aU as Mt,c9 as Ft,lh as ut,my as Tt,mz as Ct,f6 as et,fC as bt,fv as xt,aW as Z,ml as Et,mA as Pt,db as st,mB as St}from"./index-b516d057.js";import{n as Nt}from"./interfaces-8918b36f.js";import{l as Lt}from"./ViewingMode-5d7d590b.js";class Jt{constructor(){this.enabled=!0,this._time=it(0)}get time(){return this._time}advance({deltaTime:t,fixedTime:a}){return a!=null?this._time!==a&&(this._time=a,!0):(this._time=it(this._time+t),t!==0)}}let It=class{constructor(t,a){this.deltaTime=t,this.fixedTime=a}};const Rt=new Map([[h.POSITION,0],[h.NORMAL,1],[h.NORMALCOMPRESSED,1],[h.UV0,2],[h.COLOR,3],[h.COLORFEATUREATTRIBUTE,3],[h.SIZE,4],[h.TANGENT,4],[h.AUXPOS1,5],[h.SYMBOLCOLOR,5],[h.AUXPOS2,6],[h.FEATUREATTRIBUTE,6],[h.INSTANCEFEATUREATTRIBUTE,6],[h.INSTANCECOLOR,7],[h.OBJECTANDLAYERIDCOLOR,7],[h.INSTANCEOBJECTANDLAYERIDCOLOR,7],[h.INSTANCEMODEL,8],[h.INSTANCEMODELNORMAL,12],[h.INSTANCEMODELORIGINHI,11],[h.INSTANCEMODELORIGINLO,15]]);function Zt(e,t){return new mt(e,pt,t)}function Kt(e,t){const{curvatureDependent:a,scaleStart:r,scaleFallOffRange:i}=pt;return new mt(e,{curvatureDependent:{min:{curvature:a.min.curvature,tiltAngle:a.min.tiltAngle,scaleFallOffFactor:K.curvatureDependent.min.scaleFallOffFactor},max:{curvature:a.max.curvature,tiltAngle:a.max.tiltAngle,scaleFallOffFactor:K.curvatureDependent.max.scaleFallOffFactor}},scaleStart:r,scaleFallOffRange:i,minPixelSize:K.minPixelSize},t)}function Dt(e){return Math.abs(e*e*e)}function ht(e,t,a){const r=a.parameters;return Q.scale=Math.min(r.divisor/(t-r.offset),1),Q.factor=Dt(e),Q}function ft(e,t){return tt(e*Math.max(t.scale,t.minScaleFactor),e,t.factor)}function $t(e,t,a){const r=ht(e,t,a);return r.minScaleFactor=0,ft(1,r)}function Qt(e,t,a,r){r.scale=$t(e,t,a),r.factor=0,r.minScaleFactor=a.minScaleFactor}function te(e,t,a=[0,0]){const r=Math.min(Math.max(t.scale,t.minScaleFactor),1);return a[0]=e[0]*r,a[1]=e[1]*r,a}function yt(e,t,a,r){return ft(e,ht(t,a,r))}let mt=class dt{get minScaleFactor(){return this._fontHeight!=null?Math.min(this._description.minPixelSize/this._fontHeight,1):0}constructor(t,a,r,i=Yt(),c){this._viewingMode=t,this._description=a,this._ellipsoidRadius=r,this.parameters=i,this._fontHeight=c,this._viewingMode===Lt.Local?(this._coverageCompensation=this._surfaceCoverageCompensationLocal,this._calculateCurvatureDependentParameters=this._calculateCurvatureDependentParametersLocal):(this._coverageCompensation=this._surfaceCoverageCompensationGlobal,this._calculateCurvatureDependentParameters=this._calculateCurvatureDependentParametersGlobal)}update(t){return(!this.parameters||this.parameters.camera.fovY!==t.fovY||this.parameters.camera.distance!==t.distance)&&(this._calculateParameters(t,this._ellipsoidRadius,this.parameters),!0)}overrideFontHeight(t){return t!==this._fontHeight?new dt(this._viewingMode,this._description,this._ellipsoidRadius,this.parameters,t):this}_calculateParameters(t,a,r){const{scaleStart:i,scaleFallOffRange:c}=this._description,{fovY:l,distance:s}=t,o=this._calculateCurvatureDependentParameters(t,a),n=this._coverageCompensation(t,a,o),{tiltAngle:u,scaleFallOffFactor:m}=o,O=Math.sin(u)*s,I=.5*Math.PI-u-l*(.5-i*n),M=O/Math.cos(I),C=I+l*c*n,F=(M-m*(O/Math.cos(C)))/(1-m);return r.camera.fovY=t.fovY,r.camera.distance=t.distance,r.offset=F,r.divisor=M-F,r}_calculateCurvatureDependentParametersLocal(t,a,r=nt){return r.tiltAngle=this._description.curvatureDependent.min.tiltAngle,r.scaleFallOffFactor=this._description.curvatureDependent.min.scaleFallOffFactor,r}_calculateCurvatureDependentParametersGlobal(t,a,r=nt){const i=this._description.curvatureDependent,c=1+t.distance/a,l=Math.sqrt(c*c-1),[s,o]=[i.min.curvature,i.max.curvature],n=ot((l-s)/(o-s),0,1),[u,m]=[i.min,i.max];return r.tiltAngle=tt(u.tiltAngle,m.tiltAngle,n),r.scaleFallOffFactor=tt(u.scaleFallOffFactor,m.scaleFallOffFactor,n),r}_surfaceCoverageCompensationLocal(t,a,r){return(t.fovY-r.tiltAngle)/t.fovY}_surfaceCoverageCompensationGlobal(t,a,r){const i=a*a,c=r.tiltAngle+.5*Math.PI,{fovY:l,distance:s}=t,o=s*s+i-2*Math.cos(c)*s*a,n=Math.sqrt(o),u=Math.sqrt(o-i);return(Math.acos(u/n)-Math.asin(a/(n/Math.sin(c)))+.5*l)/l}};const pt={curvatureDependent:{min:{curvature:J(10),tiltAngle:J(12),scaleFallOffFactor:.5},max:{curvature:J(70),tiltAngle:J(40),scaleFallOffFactor:.8}},scaleStart:.3,scaleFallOffRange:.65,minPixelSize:0},K={curvatureDependent:{min:{scaleFallOffFactor:.7},max:{scaleFallOffFactor:.95}},minPixelSize:14};function Yt(){return{camera:{distance:0,fovY:0},divisor:0,offset:0}}const Q={scale:0,factor:0,minScaleFactor:0},nt={tiltAngle:0,scaleFallOffFactor:0},X=Mt();function ee(e,t,a,r,i,c){if(e.visible)if(e.boundingInfo){Ft(e.type===ut.Mesh);const l=t.tolerance;vt(e.boundingInfo,a,r,l,i,c)}else{const l=e.attributes.get(h.POSITION),s=l.indices;gt(a,r,0,s.length/3,s,l,void 0,i,c)}}const Vt=Z();function vt(e,t,a,r,i,c){if(e==null)return;const l=Ht(t,a,Vt);if(Tt(X,e.bbMin),Ct(X,e.bbMax),i!=null&&i.applyToAabb(X),wt(X,t,l,r)){const{primitiveIndices:s,position:o}=e,n=s?s.length:o.indices.length/3;if(n>qt){const u=e.getChildren();if(u!==void 0){for(const m of u)vt(m,t,a,r,i,c);return}}gt(t,a,0,n,o.indices,o,s,i,c)}}const Ot=Z();function gt(e,t,a,r,i,c,l,s,o){if(l)return Ut(e,t,a,r,i,c,l,s,o);const{data:n,stride:u}=c,m=e[0],O=e[1],I=e[2],M=t[0]-m,C=t[1]-O,F=t[2]-I;for(let p=a,G=3*a;p<r;++p){let d=u*i[G++],f=n[d++],g=n[d++],_=n[d];d=u*i[G++];let b=n[d++],D=n[d++],$=n[d];d=u*i[G++];let y=n[d++],Y=n[d++],V=n[d];s!=null&&([f,g,_]=s.applyToVertex(f,g,_,p),[b,D,$]=s.applyToVertex(b,D,$,p),[y,Y,V]=s.applyToVertex(y,Y,V,p));const R=b-f,x=D-g,E=$-_,P=y-f,S=Y-g,N=V-_,U=C*N-S*F,q=F*P-N*M,W=M*S-P*C,A=R*U+x*q+E*W;if(Math.abs(A)<=Number.EPSILON)continue;const v=m-f,H=O-g,w=I-_,T=v*U+H*q+w*W;if(A>0){if(T<0||T>A)continue}else if(T>0||T<A)continue;const L=H*E-x*w,j=w*R-E*v,k=v*x-R*H,z=M*L+C*j+F*k;if(A>0){if(z<0||T+z>A)continue}else if(z>0||T+z<A)continue;const B=(P*L+S*j+N*k)/A;B>=0&&o(B,_t(R,x,E,P,S,N,Ot),p,!1)}}function Ut(e,t,a,r,i,c,l,s,o){const{data:n,stride:u}=c,m=e[0],O=e[1],I=e[2],M=t[0]-m,C=t[1]-O,F=t[2]-I;for(let p=a;p<r;++p){const G=l[p];let d=3*G,f=u*i[d++],g=n[f++],_=n[f++],b=n[f];f=u*i[d++];let D=n[f++],$=n[f++],y=n[f];f=u*i[d];let Y=n[f++],V=n[f++],R=n[f];s!=null&&([g,_,b]=s.applyToVertex(g,_,b,p),[D,$,y]=s.applyToVertex(D,$,y,p),[Y,V,R]=s.applyToVertex(Y,V,R,p));const x=D-g,E=$-_,P=y-b,S=Y-g,N=V-_,U=R-b,q=C*U-N*F,W=F*S-U*M,A=M*N-S*C,v=x*q+E*W+P*A;if(Math.abs(v)<=Number.EPSILON)continue;const H=m-g,w=O-_,T=I-b,L=H*q+w*W+T*A;if(v>0){if(L<0||L>v)continue}else if(L>0||L<v)continue;const j=w*P-E*T,k=T*x-P*H,z=H*E-x*w,B=M*j+C*k+F*z;if(v>0){if(B<0||L+B>v)continue}else if(B>0||L+B<v)continue;const rt=(S*j+N*k+U*z)/v;rt>=0&&o(rt,_t(x,E,P,S,N,U,Ot),G,!1)}}const ct=Z(),lt=Z();function _t(e,t,a,r,i,c,l){return et(ct,e,t,a),et(lt,r,i,c),bt(l,ct,lt),xt(l,l),l}function Ht(e,t,a){return et(a,1/(t[0]-e[0]),1/(t[1]-e[1]),1/(t[2]-e[2]))}function wt(e,t,a,r){return zt(e,t,a,r,1/0)}function zt(e,t,a,r,i){const c=(e[0]-r-t[0])*a[0],l=(e[3]+r-t[0])*a[0];let s=Math.min(c,l),o=Math.max(c,l);const n=(e[1]-r-t[1])*a[1],u=(e[4]+r-t[1])*a[1];if(o=Math.min(o,Math.max(n,u)),o<0||(s=Math.max(s,Math.min(n,u)),s>o))return!1;const m=(e[2]-r-t[2])*a[2],O=(e[5]+r-t[2])*a[2];return o=Math.min(o,Math.max(m,O)),!(o<0)&&(s=Math.max(s,Math.min(m,O)),!(s>o)&&s<i)}function ae(e,t,a,r,i){let c=(a.screenLength||0)*e.pixelRatio;i!=null&&(c=yt(c,r,t,i));const l=c*Math.tan(.5*e.fovY)/(.5*e.fullHeight);return ot(l*t,a.minWorldLength||0,a.maxWorldLength!=null?a.maxWorldLength:1/0)}function At(e,t){const a=t?At(t):{};for(const r in e){let i=e[r];i!=null&&i.forEach&&(i=Gt(i)),i==null&&r in a||(a[r]=i)}return a}function Bt(e,t){let a=!1;for(const r in t){const i=t[r];i!==void 0&&(Array.isArray(i)?e[r]===null?(e[r]=i.slice(),a=!0):Et(e[r],i)&&(a=!0):e[r]!==i&&(a=!0,e[r]=i))}return a}function Gt(e){const t=[];return e.forEach(a=>t.push(a)),t}const re={multiply:1,ignore:2,replace:3,tint:4},qt=1e3;class ie extends Pt{constructor(t,a){super(),this.type=ut.Material,this.supportsEdges=!1,this._visible=!0,this._renderPriority=0,this._vertexAttributeLocations=Rt,this._pp0=st(0,0,1),this._pp1=st(0,0,0),this._parameters=At(t,a),this.validateParameters(this._parameters)}get parameters(){return this._parameters}update(t){return!1}setParameters(t,a=!0){Bt(this._parameters,t)&&(this.validateParameters(this._parameters),a&&this.parametersChanged())}validateParameters(t){}get visible(){return this._visible}set visible(t){t!==this._visible&&(this._visible=t,this.parametersChanged())}shouldRender(t){return this.isVisible()&&this.isVisibleForOutput(t.output)&&(!this.parameters.isDecoration||t.bindParameters.decorations===St.ON)&&(this.parameters.renderOccluded&t.renderOccludedMask)!=0}isVisibleForOutput(t){return!0}get renderPriority(){return this._renderPriority}set renderPriority(t){t!==this._renderPriority&&(this._renderPriority=t,this.parametersChanged())}get vertexAttributeLocations(){return this._vertexAttributeLocations}isVisible(){return this._visible}parametersChanged(){var t;(t=this.repository)==null||t.materialChanged(this)}intersectDraped(t,a,r,i,c,l){return this._pp0[0]=this._pp1[0]=i[0],this._pp0[1]=this._pp1[1]=i[1],this.intersect(t,a,r,this._pp0,this._pp1,c)}}class se extends It{constructor(t,a,r){super(a,r),this.camera=t}}var at;(function(e){e[e.None=0]="None",e[e.Occlude=1]="Occlude",e[e.Transparent=2]="Transparent",e[e.OccludeAndTransparent=4]="OccludeAndTransparent",e[e.OccludeAndTransparentStencil=8]="OccludeAndTransparentStencil",e[e.Opaque=16]="Opaque"})(at||(at={}));class ne extends Nt{constructor(){super(...arguments),this.renderOccluded=at.Occlude,this.isDecoration=!1}}export{Rt as E,wt as I,ae as L,gt as M,Bt as O,Ht as T,zt as V,Qt as a,re as b,ie as c,at as d,Jt as e,te as f,se as g,ee as h,Kt as i,Zt as n,ft as s,ne as u,_t as v};
