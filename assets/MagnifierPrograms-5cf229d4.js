import{n as x,d as ie}from"./WGLContainer-73827040.js";import{k as L,kz as se,v as wt,ib as ne,iL as ae,s as I,ao as re,aR as $,an as jt,y as oe,al as St,m as he,jM as Q,hC as Tt,r4 as ce,aZ as ue,g3 as zt,bg as le,b0 as C,bA as O,a5 as p,a6 as f,a9 as U,gQ as de,aW as me,B as rt,cc as Jt,d1 as ge,gy as _e,db as pe,gp as fe,gi as X,fZ as we,b9 as j}from"./index-b516d057.js";import{o as ye,h as ve,i as be}from"./cimAnalyzer-ce1886a0.js";import{f as xe}from"./fontUtils-56b88a2f.js";import{n as Me}from"./vec2f32-eaf29605.js";import{c as $e}from"./Rasterizer-81c172dd.js";import{b as v,f as ut,C as Ct,B as It,A as Se,X as Te,Y as ze}from"./definitions-5366d472.js";import{_ as J,T as Ce}from"./enums-b1d611e3.js";import{t as b}from"./Rect-ea14f53a.js";import{G as Kt,D as bt,L as Rt,R as A}from"./enums-bdecffa2.js";import{e as xt,T as Mt}from"./Texture-bcb6d63f.js";import{r as Pt}from"./pbf-2651fe50.js";import{o as Ie}from"./floatRGBA-ca990bbb.js";import{e as Dt}from"./GeometryUtils-dd03fc25.js";import{u as Re,d as Pe,l as De,n as At,a as Ae,y as Ee,f as K,s as Et,m as Ft,i as Fe,o as ke}from"./color-a1c19855.js";import{o as Be}from"./imageutils-3218f9c4.js";import{d as z}from"./enums-f1a6a48a.js";import{b as Le}from"./Matcher-fcb8339d.js";import{_ as Oe}from"./QueueProcessor-4b9d43d3.js";import{t as Ue}from"./CircularArray-ef508845.js";import{T as Ne}from"./testSVGPremultipliedAlpha-f5e92e14.js";import{e as Ge}from"./throttle-7bf02de9.js";import{t as Ve}from"./ComputedAttributeStorage-bbcde1eb.js";import{l as ot}from"./Viewpoint-f83262d0.js";import{A as nt,e as qe,j as Ze,Z as He,h as yt,y as We,G as kt}from"./DefaultUI-af7068c2.js";import{_ as Bt}from"./screenUtils-8dc4a7f9.js";import{l as Ye,a as Qe,s as Xe}from"./ZoomMomentumEstimator-7437d26a.js";import{e as je}from"./ProgramTemplate-611fcbef.js";const ns={shaders:{vertexShader:x("bitBlit/bitBlit.vert"),fragmentShader:x("bitBlit/bitBlit.frag")},attributes:new Map([["a_pos",0],["a_tex",1]])};let at=class{constructor(t,e){this._width=0,this._height=0,this._free=[],this._width=t,this._height=e,this._free.push(new b(0,0,t,e))}get width(){return this._width}get height(){return this._height}allocate(t,e){if(t>this._width||e>this._height)return new b;let i=null,n=-1;for(let s=0;s<this._free.length;++s){const a=this._free[s];t<=a.width&&e<=a.height&&(i===null||a.y<=i.y&&a.x<=i.x)&&(i=a,n=s)}return i===null?new b:(this._free.splice(n,1),i.width<i.height?(i.width>t&&this._free.push(new b(i.x+t,i.y,i.width-t,e)),i.height>e&&this._free.push(new b(i.x,i.y+e,i.width,i.height-e))):(i.width>t&&this._free.push(new b(i.x+t,i.y,i.width-t,i.height)),i.height>e&&this._free.push(new b(i.x,i.y+e,t,i.height-e))),new b(i.x,i.y,t,e))}release(t){for(let e=0;e<this._free.length;++e){const i=this._free[e];if(i.y===t.y&&i.height===t.height&&i.x+i.width===t.x)i.width+=t.width;else if(i.x===t.x&&i.width===t.width&&i.y+i.height===t.y)i.height+=t.height;else if(t.y===i.y&&t.height===i.height&&t.x+t.width===i.x)i.x=t.x,i.width+=t.width;else{if(t.x!==i.x||t.width!==i.width||t.y+t.height!==i.y)continue;i.y=t.y,i.height+=t.height}this._free.splice(e,1),this.release(t)}this._free.push(t)}};const Je=256,Ke=r=>Math.floor(r/256);function ti(r){const t=new Set;for(const e of r)t.add(Ke(e));return t}function ei(r,t,e){return r.has(t)||r.set(t,e().then(()=>{r.delete(t)}).catch(i=>{r.delete(t),se(i)})),r.get(t)}const ii=r=>({rect:new b(0,0,0,0),page:0,metrics:{left:0,width:0,height:0,advance:0,top:0},code:r,sdf:!0});let si=class{constructor(t,e,i){this.width=0,this.height=0,this._dirties=[],this._glyphData=[],this._currentPage=0,this._glyphCache={},this._textures=[],this._rangePromises=new Map,this._preloadCache={},this.width=t,this.height=e,this._glyphSource=i,this._binPack=new at(t-4,e-4),this._glyphData.push(new Uint8Array(t*e)),this._dirties.push(!0),this._textures.push(null),this._initDecorationGlyphs()}dispose(){this._binPack=null;for(const t of this._textures)t&&t.dispose();this._textures.length=0,this._glyphData.length=0}_initDecorationGlyphs(){const t=[117,149,181,207,207,181,149,117],e=[],i=[];for(let a=0;a<t.length;a++){const o=t[a];for(let h=0;h<11;h++){const c=a>=3&&a<5&&h>=3&&h<8?255:0;e.push(o),i.push(c)}}const n={metrics:{width:5,height:2,left:0,top:0,advance:0},bitmap:new Uint8Array(e)},s={metrics:{width:5,height:2,left:0,top:0,advance:0},bitmap:new Uint8Array(i)};this._recordGlyph(n),this._recordGlyph(s)}async getGlyphItems(t,e,i){const n=this._getGlyphCache(t);return await this._fetchRanges(t,e,i),e.map(s=>this._getMosaicItem(n,t,s))}bind(t,e,i,n){const s=this._getTexture(t,i);s.setSamplingMode(e),this._dirties[i]&&(s.setData(this._glyphData[i]),this._dirties[i]=!1),t.bindTexture(s,n)}preloadASCIIGlyphCache(t){const e=this._preloadCache[t];if(e!=null)return e;const i=this._glyphSource.preloadASCIIRange(t).then(()=>{const n=this._getGlyphCache(t);for(let s=0;s<256;s++)this._getMosaicItem(n,t,s)});return this._preloadCache[t]=i,i}_getGlyphCache(t){return this._glyphCache[t]||(this._glyphCache[t]={}),this._glyphCache[t]}_getTexture(t,e){if(!this._textures[e]){const i=new xt;i.pixelFormat=Kt.ALPHA,i.wrapMode=bt.CLAMP_TO_EDGE,i.width=this.width,i.height=this.height,this._textures[e]=new Mt(t,i,new Uint8Array(this.width*this.height))}return this._textures[e]}_invalidate(){this._dirties[this._currentPage]=!0}async _fetchRanges(t,e,i){const n=ti(e),s=[];n.forEach(a=>{s.push(this._fetchRange(t,a,i))}),await Promise.all(s)}async _fetchRange(t,e,i){if(e>Je)return;const n=t+e;return ei(this._rangePromises,n,()=>this._glyphSource.getRange(t,e,i))}_getMosaicItem(t,e,i){if(!t[i]){const n=this._glyphSource.getGlyph(e,i);if(!(n!=null&&n.metrics))return ii(i);const s=this._recordGlyph(n),a=this._currentPage,o=n.metrics;t[i]={rect:s,page:a,metrics:o,code:i,sdf:!0},this._invalidate()}return t[i]}_recordGlyph(t){const e=t.metrics;let i;if(e.width===0)i=new b(0,0,0,0);else{const s=e.width+6,a=e.height+2*3;i=this._binPack.allocate(s,a),i.isEmpty&&(this._dirties[this._currentPage]||(this._glyphData[this._currentPage]=null),this._currentPage=this._glyphData.length,this._glyphData.push(new Uint8Array(this.width*this.height)),this._dirties.push(!0),this._textures.push(null),this._initDecorationGlyphs(),this._binPack=new at(this.width-4,this.height-4),i=this._binPack.allocate(s,a));const o=this._glyphData[this._currentPage],h=t.bitmap;let c,u;if(h)for(let m=0;m<a;m++){c=s*m,u=this.width*(i.y+m)+i.x;for(let l=0;l<s;l++)o[u+l]=h[c+l]}L("esri-glyph-debug")&&this._showDebugPage(o)}return i}_showDebugPage(t){const e=document.createElement("canvas"),i=e.getContext("2d"),n=new ImageData(this.width,this.height),s=n.data;e.width=this.width,e.height=this.height,e.style.border="1px solid black";for(let a=0;a<t.length;++a)s[4*a]=t[a],s[4*a+1]=0,s[4*a+2]=0,s[4*a+3]=255;i.putImageData(n,0,0),document.body.appendChild(e)}},Lt=class{constructor(t){for(this._metrics=[],this._bitmaps=[];t.next();)switch(t.tag()){case 1:{const e=t.getMessage();for(;e.next();)switch(e.tag()){case 3:{const i=e.getMessage();let n,s,a,o,h,c,u;for(;i.next();)switch(i.tag()){case 1:n=i.getUInt32();break;case 2:s=i.getBytes();break;case 3:a=i.getUInt32();break;case 4:o=i.getUInt32();break;case 5:h=i.getSInt32();break;case 6:c=i.getSInt32();break;case 7:u=i.getUInt32();break;default:i.skip()}i.release(),n&&(this._metrics[n]={width:a,height:o,left:h,top:c,advance:u},this._bitmaps[n]=s);break}default:e.skip()}e.release();break}default:t.skip()}}getMetrics(t){return this._metrics[t]}getBitmap(t){return this._bitmaps[t]}},ni=class{constructor(){this._ranges=[]}getRange(t){return this._ranges[t]}addRange(t,e){this._ranges[t]=e}},ai=class{constructor(t){this._glyphInfo={},this._baseURL=t}getRange(t,e,i){const n=this._getFontStack(t);if(n.getRange(e))return Promise.resolve();const s=256*e,a=s+255,o=this._baseURL.replace("{fontstack}",t).replace("{range}",s+"-"+a);return wt(o,{responseType:"array-buffer",...i}).then(h=>{n.addRange(e,new Lt(new Pt(new Uint8Array(h.data),new DataView(h.data))))})}async preloadASCIIRange(t){const e=this._getFontStack(t),i=0,n=255,s=this._baseURL.replace("{fontstack}",t).replace("{range}",i+"-"+n),a=await wt(s,{responseType:"array-buffer"}),o=new Lt(new Pt(new Uint8Array(a.data),new DataView(a.data)));for(let h=i;h<=n;h++)e.getRange(h)||e.addRange(h,o)}getGlyph(t,e){const i=this._getFontStack(t);if(!i)return;const n=Math.floor(e/256),s=i.getRange(n);return s?{metrics:s.getMetrics(e),bitmap:s.getBitmap(e)}:void 0}_getFontStack(t){let e=this._glyphInfo[t];return e||(e=this._glyphInfo[t]=new ni),e}};const N=1e20;let ri=class{constructor(t){this._svg=null,this.size=t;const e=document.createElement("canvas");e.width=e.height=t,this._context=e.getContext("2d",{willReadFrequently:!1}),this._gridOuter=new Float64Array(t*t),this._gridInner=new Float64Array(t*t),this._f=new Float64Array(t),this._d=new Float64Array(t),this._z=new Float64Array(t+1),this._v=new Int16Array(t)}dispose(){this._context=this._gridOuter=this._gridInner=this._f=this._d=this._z=this._v=null,this._svg&&(document.body.removeChild(this._svg),this._svg=null)}draw(t,e,i,n=31){this._initSVG();const s=this.createSVGString(t,e);return new Promise((a,o)=>{const h=new Image;h.src="data:image/svg+xml; charset=utf8, "+encodeURIComponent(s),h.onload=()=>{h.onload=null,this._context.clearRect(0,0,this.size,this.size),this._context.drawImage(h,0,0,this.size,this.size);const u=this._context.getImageData(0,0,this.size,this.size),m=new Uint8Array(this.size*this.size*4);for(let l=0;l<this.size*this.size;l++){const d=u.data[4*l+3]/255;this._gridOuter[l]=d===1?0:d===0?N:Math.max(0,.5-d)**2,this._gridInner[l]=d===1?N:d===0?0:Math.max(0,d-.5)**2}this._edt(this._gridOuter,this.size,this.size),this._edt(this._gridInner,this.size,this.size);for(let l=0;l<this.size*this.size;l++){const d=this._gridOuter[l]-this._gridInner[l];Ie(.5-d/(2*n),m,4*l)}a(m)};const c=i==null?void 0:i.signal;c&&ne(c,()=>o(ae()))})}_initSVG(){if(!this._svg){const t=document.createElementNS("http://www.w3.org/2000/svg","svg");t.setAttribute("style","position: absolute;"),t.setAttribute("width","0"),t.setAttribute("height","0"),t.setAttribute("aria-hidden","true"),t.setAttribute("role","presentation"),document.body.appendChild(t),this._svg=t}return this._svg}createSVGString(t,e){const i=this._initSVG(),n=document.createElementNS("http://www.w3.org/2000/svg","path");n.setAttribute("d",t),i.appendChild(n);const s=n.getBBox(),a=s.width/s.height,o=this.size/2;let h,c,u;if(a>1){h=o/s.width;const g=o*(1/a);c=this.size/4,u=o-g/2}else h=o/s.height,c=o-o*a/2,u=this.size/4;const m=-s.x*h+c,l=-s.y*h+u;n.setAttribute("style",`transform: matrix(${h}, 0, 0, ${h}, ${m}, ${l})`),n.setAttribute("stroke-width",""+.5/h);const d=`<svg style="fill:${e?"red":"none"}; stroke:${e?"none":"red"}" height="${this.size}" width="${this.size}" xmlns="http://www.w3.org/2000/svg">${i.innerHTML}</svg>`;return i.removeChild(n),d}_edt(t,e,i){const n=this._f,s=this._d,a=this._v,o=this._z;for(let h=0;h<e;h++){for(let c=0;c<i;c++)n[c]=t[c*e+h];this._edt1d(n,s,a,o,i);for(let c=0;c<i;c++)t[c*e+h]=s[c]}for(let h=0;h<i;h++){for(let c=0;c<e;c++)n[c]=t[h*e+c];this._edt1d(n,s,a,o,e);for(let c=0;c<e;c++)t[h*e+c]=Math.sqrt(s[c])}}_edt1d(t,e,i,n,s){i[0]=0,n[0]=-N,n[1]=+N;for(let a=1,o=0;a<s;a++){let h=(t[a]+a*a-(t[i[o]]+i[o]*i[o]))/(2*a-2*i[o]);for(;h<=n[o];)o--,h=(t[a]+a*a-(t[i[o]]+i[o]*i[o]))/(2*a-2*i[o]);o++,i[o]=a,n[o]=h,n[o+1]=+N}for(let a=0,o=0;a<s;a++){for(;n[o+1]<a;)o++;e[a]=(a-i[o])*(a-i[o])+t[i[o]]}}};function R(r){return r&&r.type==="static"}let oi=class te{constructor(t,e,i=0){this._mosaicPages=[],this._maxItemSize=0,this._currentPage=0,this._pageWidth=0,this._pageHeight=0,this._mosaicRects=new Map,this._spriteCopyQueue=[],this.pixelRatio=1,(t<=0||e<=0)&&console.error("Sprites mosaic defaultWidth and defaultHeight must be greater than zero!"),this._pageWidth=t,this._pageHeight=e,i>0&&(this._maxItemSize=i),this.pixelRatio=window.devicePixelRatio||1,this._binPack=new at(this._pageWidth,this._pageHeight);const n=Math.floor(this._pageWidth),s=Math.floor(this._pageHeight);this._mosaicPages.push({mosaicsData:{type:"static",data:new Uint32Array(n*s)},size:[this._pageWidth,this._pageHeight],dirty:!0,texture:void 0})}getWidth(t){return t>=this._mosaicPages.length?-1:this._mosaicPages[t].size[0]}getHeight(t){return t>=this._mosaicPages.length?-1:this._mosaicPages[t].size[1]}getPageTexture(t){return t<this._mosaicPages.length?this._mosaicPages[t].texture:null}has(t){return this._mosaicRects.has(t)}get itemCount(){return this._mosaicRects.size}getSpriteItem(t){return this._mosaicRects.get(t)}addSpriteItem(t,e,i,n,s,a,o=1){if(this._mosaicRects.has(t))return this._mosaicRects.get(t);let h,c,u;if(R(i))[h,c,u]=this._allocateImage(e[0],e[1]);else{h=new b(0,0,e[0],e[1]),c=this._mosaicPages.length;const l=void 0;this._mosaicPages.push({mosaicsData:i,size:[e[0]+2*v,e[1]+2*v],dirty:!0,texture:l})}if(h.width<=0||h.height<=0)return null;const m={rect:h,width:e[0],height:e[1],sdf:s,simplePattern:a,pixelRatio:o,page:c};return this._mosaicRects.set(t,m),R(i)&&(L("esri-mosaic-debug")&&this._showDebugSprite(e,i.data),this._copy({rect:h,spriteSize:e,spriteData:i.data,page:c,pageSize:u,repeat:n,sdf:s})),m}hasItemsToProcess(){return this._spriteCopyQueue.length!==0}processNextItem(){const t=this._spriteCopyQueue.pop();t&&this._copy(t)}getSpriteItems(t){const e={};for(const i of t)e[i]=this.getSpriteItem(i);return e}getMosaicItemPosition(t){const e=this.getSpriteItem(t),i=e==null?void 0:e.rect;if(!i)return null;i.width=e.width,i.height=e.height;const n=e.width,s=e.height,a=v,o=this._mosaicPages[e.page].size;return{size:[e.width,e.height],tl:[(i.x+a)/o[0],(i.y+a)/o[1]],br:[(i.x+a+n)/o[0],(i.y+a+s)/o[1]],page:e.page}}bind(t,e,i=0,n=0){const s=this._mosaicPages[i],a=s.mosaicsData;let o=s.texture;o||(o=ci(t,s.size),s.texture=o),o.setSamplingMode(e),R(a)?(t.bindTexture(o,n),s.dirty&&(o.setData(new Uint8Array(a.data.buffer)),o.generateMipmap(),L("esri-mosaic-debug")&&this._showDebugPage(i))):(a.data.bindFrame(t,o,n),o.generateMipmap()),s.dirty=!1}dispose(){this._binPack=null;for(const t of this._mosaicPages){const e=t.texture;e&&e.dispose();const i=t.mosaicsData;R(i)||i.data.destroy()}this._mosaicPages=null,this._mosaicRects.clear()}static _copyBits(t,e,i,n,s,a,o,h,c,u,m){let l=n*e+i,d=h*a+o;if(m){d-=a;for(let g=-1;g<=u;g++,l=((g+u)%u+n)*e+i,d+=a)for(let _=-1;_<=c;_++)s[d+_]=t[l+(_+c)%c]}else for(let g=0;g<u;g++){for(let _=0;_<c;_++)s[d+_]=t[l+_];l+=e,d+=a}}_copy(t){if(t.page>=this._mosaicPages.length)return;const e=this._mosaicPages[t.page],i=e.mosaicsData;if(!R(e.mosaicsData))throw new I("mapview-invalid-resource","unsuitable data type!");const n=t.spriteData,s=i.data;s&&n||console.error("Source or target images are uninitialized!"),te._copyBits(n,t.spriteSize[0],0,0,s,t.pageSize[0],t.rect.x+v,t.rect.y+v,t.spriteSize[0],t.spriteSize[1],t.repeat),e.dirty=!0}_allocateImage(t,e){t+=2*v,e+=2*v;const i=Math.max(t,e);if(this._maxItemSize&&this._maxItemSize<i){const s=2**Math.ceil(Dt(t)),a=2**Math.ceil(Dt(e)),o=new b(0,0,t,e);return this._mosaicPages.push({mosaicsData:{type:"static",data:new Uint32Array(s*a)},size:[s,a],dirty:!0,texture:void 0}),[o,this._mosaicPages.length-1,[s,a]]}const n=this._binPack.allocate(t,e);if(n.width<=0){const s=this._mosaicPages[this._currentPage];return!s.dirty&&R(s.mosaicsData)&&(s.mosaicsData.data=null),this._currentPage=this._mosaicPages.length,this._mosaicPages.push({mosaicsData:{type:"static",data:new Uint32Array(this._pageWidth*this._pageHeight)},size:[this._pageWidth,this._pageHeight],dirty:!0,texture:void 0}),this._binPack=new at(this._pageWidth,this._pageHeight),this._allocateImage(t,e)}return[n,this._currentPage,[this._pageWidth,this._pageHeight]]}_showDebugSprite([t,e],i){const n=document.createElement("canvas");n.width=t,n.height=e,n.setAttribute("style",`position: absolute; top: ${4+204*hi++}px; right: 208px; width: 200px; height: 200px; border: 1px solid black;`);const s=n.getContext("2d"),a=new ImageData(t,e);a.data.set(new Uint8Array(i.buffer)),s.putImageData(a,0,0),document.body.appendChild(n)}_showDebugPage(t){const e=this._mosaicPages[t],{size:[i,n],mosaicsData:s}=e;if(!R(s))return void console.error("Could not show sprite mosaic debug for non-static resource");const a=`mosaicDebugPage${t}`,o=document.getElementById(a)??document.createElement("canvas");o.id=a,o.width=i,o.height=n,o.setAttribute("style",`position: absolute; top: ${4+204*t}px; right: 4px; width: 200px; height: 200px; border: 1px solid black;`);const h=o.getContext("2d"),c=new ImageData(i,n);c.data.set(new Uint8Array(s.data.buffer)),h.putImageData(c,0,0),document.body.appendChild(o)}},hi=0;function ci(r,t){const e=new xt;return e.width=t[0],e.height=t[1],e.wrapMode=bt.CLAMP_TO_EDGE,new Mt(r,e,null)}function ui(r){return $(r.frameDurations.reduce((t,e)=>t+e,0))}function li(r){const{width:t,height:e}=r,i=r.frameDurations.reverse(),n=s=>{const a=r.frameDurations.length-1-s;return r.getFrame(a)};return{frameCount:r.frameCount,duration:r.duration,frameDurations:i,getFrame:n,width:t,height:e}}function di(r,t){const{width:e,height:i,getFrame:n}=r,s=t/r.duration,a=r.frameDurations.map(o=>$(o*s));return{frameCount:r.frameCount,duration:r.duration,frameDurations:a,getFrame:n,width:e,height:i}}function mi(r,t){const{width:e,height:i,getFrame:n}=r,s=r.frameDurations.slice(),a=s.shift();return s.unshift($(a+t)),{frameCount:r.frameCount,duration:r.duration+t,frameDurations:s,getFrame:n,width:e,height:i}}function Ot(r,t){const{width:e,height:i,getFrame:n}=r,s=r.frameDurations.slice(),a=s.pop();return s.push($(a+t)),{frameCount:r.frameCount,duration:r.duration+t,frameDurations:s,getFrame:n,width:e,height:i}}let gi=class{constructor(t,e,i,n){this._animation=t,this._repeatType=i,this._onFrameData=n,this._direction=1,this._currentFrame=0,this.timeToFrame=this._animation.frameDurations[this._currentFrame];let s=0;for(;e>s;)s+=this.timeToFrame,this.nextFrame();const a=this._animation.getFrame(this._currentFrame);this._onFrameData(a)}nextFrame(){if(this._currentFrame+=this._direction,this._direction>0){if(this._currentFrame===this._animation.frameDurations.length)switch(this._repeatType){case z.None:this._currentFrame-=this._direction;break;case z.Loop:this._currentFrame=0;break;case z.Oscillate:this._currentFrame-=this._direction,this._direction=-1}}else if(this._currentFrame===-1)switch(this._repeatType){case z.None:this._currentFrame-=this._direction;break;case z.Loop:this._currentFrame=this._animation.frameDurations.length-1;break;case z.Oscillate:this._currentFrame-=this._direction,this._direction=1}this.timeToFrame=this._animation.frameDurations[this._currentFrame];const t=this._animation.getFrame(this._currentFrame);this._onFrameData(t)}};function _i(r,t,e,i){let n,{repeatType:s}=t;if(s==null&&(s=z.Loop),t.reverseAnimation===!0&&(r=li(r)),t.duration!=null&&(r=di(r,$(1e3*t.duration))),t.repeatDelay!=null){const a=1e3*t.repeatDelay;s===z.Loop?r=Ot(r,$(a)):s===z.Oscillate&&(r=mi(Ot(r,$(a/2)),$(a/2)))}if(t.startTimeOffset!=null)n=$(1e3*t.startTimeOffset);else if(t.randomizeStartTime!=null){const a=ye(e),o=82749913,h=t.randomizeStartSeed!=null?t.randomizeStartSeed:o,c=ve(a,h);n=$(c*ui(r))}else n=$(0);return new gi(r,n,s,i)}function pi(r,t,e,i){const n=t.playAnimation==null||t.playAnimation,s=_i(r,t,e,i);let a,o=s.timeToFrame;function h(){a=n?setTimeout(()=>{s.nextFrame(),o=s.timeToFrame,h()},o):void 0}return h(),re(()=>n&&clearTimeout(a))}let lt,Ut;function fi(){return lt??(lt=document.createElement("canvas")),Ut??(Ut=lt.getContext("2d")),{canvas:lt,ctx:Ut}}function wi(r,t,e){const{canvas:i,ctx:n}=fi();i.width=t,i.height=e;const s=[],a=r.frameDurations.length;for(let o=0;o<a;o++){const h=r.getFrame(o);n.clearRect(0,0,t,e),h instanceof ImageData?n.drawImage(Be(h),0,0,t,e):n.drawImage(h,0,0,t,e),s.push(n.getImageData(0,0,t,e))}return{width:t,height:e,frameDurations:r.frameDurations,getFrame:o=>s[o],frameCount:r.frameCount,duration:r.duration}}let yi=class{constructor(t,e,i,n){this._animation=t,this._frameData=null;const s=a=>{this._frameData=a,e.requestRender()};this.frameCount=this._animation.frameDurations.length,this.width=this._animation.width,this.height=this._animation.height,this._playHandle=pi(this._animation,i,n,s)}destroy(){this._playHandle.remove()}bindFrame(t,e,i){t.bindTexture(e,i);const n=this._frameData;if(n==null)return;const s="width"in n?n.width:n.codedWidth,a="height"in n?n.height:n.codedHeight;e.updateData(0,v,v,s,a,n),this._frameData=null}};function vi(r){switch(r.type){case"esriSMS":return`${r.style}.${r.path}`;case"esriSLS":return`${r.style}.${r.cap}`;case"esriSFS":return`${r.style}`;case"esriPFS":case"esriPMS":return r.imageData?`${r.imageData}${r.width}${r.height}`:`${r.url}${r.width}${r.height}`;default:return"mosaicHash"in r?r.mosaicHash:JSON.stringify(r)}}const Nt=Me(),Gt="arial-unicode-ms-regular",ee=jt.getLogger("esri.views.2d.engine.webgl.TextureManager");function vt(r){const t=Math.round(ue(r)*window.devicePixelRatio);return t*(t>=128?2:4)}function Vt(r,t){return Math.min(r,vt(t))}function qt(r,t){if(!r||!t)return{width:0,height:0};const e=r/t;if(e>1){const n=vt(r);return{width:n,height:n/e}}const i=vt(t);return{width:i*e,height:i}}const dt=(r,t,e)=>ee.error(new I(r,t,e));class $t{static fromMosaic(t,e){return new $t(t,e.page,e.sdf)}constructor(t,e,i){this.mosaicType=t,this.page=e,this.sdf=i}}class ms{constructor(t,e,i){this._requestRender=t,this.resourceManager=e,this._allowNonPowerOfTwo=i,this._invalidFontsMap=new Map,this._sdfConverter=new ri(ut),this._bindingInfos=new Array,this._hashToBindingIndex=new Map,this._ongoingRasterizations=new Map,this._imageRequestQueue=new Oe({concurrency:10,process:async(n,s)=>{oe(s);try{return await wt(n,{responseType:"image",signal:s})}catch(a){throw St(a)?a:new I("mapview-invalid-resource",`Could not fetch requested resource at ${n}`,a)}}}),this._spriteMosaic=new oi(2048,2048,500),this._glyphSource=new ai(`${he.fontsUrl}/{fontstack}/{range}.pbf`),this._glyphMosaic=new si(1024,1024,this._glyphSource),this._rasterizer=new $e(e)}dispose(){this._spriteMosaic.dispose(),this._glyphMosaic.dispose(),this._rasterizer.dispose(),this._sdfConverter.dispose(),this._spriteMosaic=null,this._glyphMosaic=null,this._sdfConverter=null,this._hashToBindingIndex.clear(),this._hashToBindingIndex=null,this._bindingInfos=null,this._ongoingRasterizations.clear(),this._ongoingRasterizations=null,this._imageRequestQueue.clear(),this._imageRequestQueue=null}get sprites(){return this._spriteMosaic}get glyphs(){return this._glyphMosaic}async rasterizeItem(t,e,i,n){if(t==null)return dt("mapview-null-resource","Unable to rasterize null resource"),null;switch(t.type){case"text":case"esriTS":{const s=await this._rasterizeText(t,i,n);return s.forEach(a=>this._setTextureBinding(J.GLYPH,a)),{glyphMosaicItems:s}}default:{if(Re(t))return dt("mapview-invalid-type",`MapView does not support symbol type: ${t.type}`,t),null;const s=await this._rasterizeSpriteSymbol(t,e,n);return Le(s)&&s&&this._setTextureBinding(J.SPRITE,s),{spriteMosaicItem:s}}}}bindTextures(t,e,i,n=!1){if(i.textureBinding===0)return;const s=this._bindingInfos[i.textureBinding-1],a=s.page,o=n?Rt.LINEAR_MIPMAP_LINEAR:Rt.LINEAR;switch(s.mosaicType){case J.SPRITE:{const h=this.sprites.getWidth(a),c=this.sprites.getHeight(a),u=Q(Nt,h,c);return this._spriteMosaic.bind(t,o,a,It),e.setUniform1i("u_texture",It),void e.setUniform2fv("u_mosaicSize",u)}case J.GLYPH:{const h=this.glyphs.width,c=this.glyphs.height,u=Q(Nt,h,c);return this._glyphMosaic.bind(t,o,a,Ct),e.setUniform1i("u_texture",Ct),void e.setUniform2fv("u_mosaicSize",u)}default:ee.error("mapview-texture-manager",`Cannot handle unknown type ${s.mosaicType}`)}}_hashMosaic(t,e){return 1|t<<1|(e.sdf?1:0)<<2|e.page<<3}_setTextureBinding(t,e){const i=this._hashMosaic(t,e);if(!this._hashToBindingIndex.has(i)){const n=$t.fromMosaic(t,e),s=this._bindingInfos.length+1;this._hashToBindingIndex.set(i,s),this._bindingInfos.push(n)}e.textureBinding=this._hashToBindingIndex.get(i)}async _rasterizeText(t,e,i){let n,s;if("cim"in t){const h=t;n=h.fontName,s=h.text}else{const h=t;n=xe(h.font),s=h.text}const a=this._invalidFontsMap.has(n),o=e||Pe(be(s)[0]);try{const h=a?Gt:n;return L("esri-2d-stabilize-glyphs")&&await this._glyphMosaic.preloadASCIIGlyphCache(h),await this._glyphMosaic.getGlyphItems(h,o,i)}catch{return dt("mapview-invalid-resource",`Couldn't find font ${n}. Falling back to Arial Unicode MS Regular`),this._invalidFontsMap.set(n,!0),this._glyphMosaic.getGlyphItems(Gt,o,i)}}async _rasterizeSpriteSymbol(t,e,i){if(De(t))return;const n=vi(t);if(this._spriteMosaic.has(n))return this._spriteMosaic.getSpriteItem(n);if(At(t)||Ae(t)&&!Ee(t))return this._handleAsyncResource(n,t,i);const s=Se,a=this._rasterizer.rasterizeJSONResource(t,s);if(a){const{size:o,image:h,sdf:c,simplePattern:u,rasterizationScale:m}=a;return this._addItemToMosaic(n,o,{type:"static",data:h},K(t),c,u,m)}return new I("TextureManager","unrecognized or null rasterized image")}async _handleAsyncResource(t,e,i){if(this._ongoingRasterizations.has(t))return this._ongoingRasterizations.get(t);let n;n=At(e)?this._handleSVG(e,t,i):this._handleImage(e,t,i),this._ongoingRasterizations.set(t,n);try{await n,this._ongoingRasterizations.delete(t)}catch{this._ongoingRasterizations.delete(t)}return n}async _handleSVG(t,e,i){const n=[ut,ut],s=!("cim"in t)||t.cim.asFill,a=await this._sdfConverter.draw(t.path,s,i);return this._addItemToMosaic(e,n,{type:"static",data:new Uint32Array(a.buffer)},!1,!0,!0)}async _handleGIFOrPNG(t,e,i){const n=Et(t);await this.resourceManager.fetchResource(n,i);let s=this.resourceManager.getResource(n);if(s==null)return new I("mapview-invalid-resource",`Could not fetch requested resource at ${n}.`);let a=s.width,o=s.height;if(s instanceof HTMLImageElement){t.type==="esriPMS"&&(a=Math.round(Vt(s.width,Ft(t))),o=Math.round(s.height*(a/s.width)));const m="cim"in t?t.cim.colorSubstitutions:void 0,{size:l,sdf:d,image:g}=this._rasterizer.rasterizeImageResource(a,o,s,m);return this._addItemToMosaic(e,l,{type:"static",data:g},K(t),d,!1)}this._allowNonPowerOfTwo||(a=Tt(s.width+2*v)-2*v,o=Tt(s.height+2*v)-2*v),a===s.width&&o===s.height||(s=wi(s,a,o));const h=t.animatedSymbolProperties||{},c=t.objectId,u=new yi(s,this._requestRender,h,c);return this._addItemToMosaic(e,[u.width,u.height],{type:"animated",data:u},K(t),!1,!1)}async _handleImage(t,e,i){if(Fe(t)||ke(t))return this._handleGIFOrPNG(t,e,i);const n=Et(t);try{let s;const a=this.resourceManager.getResource(n);if(a!=null&&a instanceof HTMLImageElement)s=a;else{const{data:d}=await this._imageRequestQueue.push(n,{...i});s=d}if(ce(n)){if("width"in t&&"height"in t){const{width:d,height:g}=qt(t.width,t.height);s.width=d,s.height=g}else if("cim"in t){const d=t.cim,{width:g,height:_}=qt(d.width??d.scaleX*d.size,d.size);s.width=g,s.height=_}}if(!s.width||!s.height)return null;let o=s.width,h=s.height;t.type==="esriPMS"&&(o=Math.round(Vt(s.width,Ft(t))),h=Math.round(s.height*(o/s.width)));const c="cim"in t?t.cim.colorSubstitutions:void 0,{size:u,sdf:m,image:l}=this._rasterizer.rasterizeImageResource(o,h,s,c);return this._addItemToMosaic(e,u,{type:"static",data:l},K(t),m,!1)}catch(s){if(!St(s))return new I("mapview-invalid-resource",`Could not fetch requested resource at ${n}. ${s.message}`)}}_addItemToMosaic(t,e,i,n,s,a,o){return this._spriteMosaic.addSpriteItem(t,e,i,n,s,a,o)}}const gs={shaders:{vertexShader:x("stencil/stencil.vert"),fragmentShader:x("stencil/stencil.frag")},attributes:new Map([["a_pos",0]])},bi=r=>r.replace("-","_").toUpperCase(),Zt=r=>`#define ${bi(r)}
`;function Ht(r){return{attributes:new Map([["a_pos",0],["a_tex",1]]),shaders:{vertexShader:Zt(r)+x("blend/blend.vert"),fragmentShader:Zt(r)+x("blend/blend.frag")}}}const Wt=jt.getLogger("esri.views.2d.engine.webgl.effects.blendEffects.BlendEffect");class _s{constructor(){this._size=[0,0]}dispose(t){this._backBufferTexture=zt(this._backBufferTexture),this._quad=zt(this._quad)}draw(t,e,i,n,s){const{context:a,drawPhase:o}=t;if(this._setupShader(a),n&&n!=="normal"&&o!==Ce.LABEL)return void this._drawBlended(t,e,i,n,s);const h=Ht("normal"),c=a.programCache.acquire(h.shaders.vertexShader,h.shaders.fragmentShader,h.attributes);if(!c)return void Wt.error(new I("mapview-BlendEffect",'Error creating shader program for blend mode "normal"'));a.useProgram(c),e.setSamplingMode(i),a.bindTexture(e,0),c.setUniform1i("u_layerTexture",0),c.setUniform1f("u_opacity",s),a.setBlendingEnabled(!0),a.setBlendFunction(A.ONE,A.ONE_MINUS_SRC_ALPHA);const u=this._quad;u.draw(),u.unbind(),c.dispose()}_drawBlended(t,e,i,n,s){const{context:a,state:o,pixelRatio:h,inFadeTransition:c}=t,{size:u}=o,m=a.getBoundFramebufferObject();let l,d;m!=null?(l=m.width,d=m.height):(l=Math.round(h*u[0]),d=Math.round(h*u[1])),this._createOrResizeTexture(t,l,d);const g=this._backBufferTexture;m.copyToTexture(0,0,l,d,0,0,g),a.setStencilTestEnabled(!1),a.setStencilWriteMask(0),a.setBlendingEnabled(!0),a.setDepthTestEnabled(!1),a.setDepthWriteEnabled(!1);const _=Ht(n),y=a.programCache.acquire(_.shaders.vertexShader,_.shaders.fragmentShader,_.attributes);if(!y)return void Wt.error(new I("mapview-BlendEffect",`Error creating shader program for blend mode ${n}`));a.useProgram(y),g.setSamplingMode(i),a.bindTexture(g,0),y.setUniform1i("u_backbufferTexture",0),e.setSamplingMode(i),a.bindTexture(e,1),y.setUniform1i("u_layerTexture",1),y.setUniform1f("u_opacity",s),y.setUniform1f("u_inFadeOpacity",c?1:0),a.setBlendFunction(A.ONE,A.ZERO);const w=this._quad;w.draw(),w.unbind(),y.dispose(),a.setBlendFunction(A.ONE,A.ONE_MINUS_SRC_ALPHA)}_setupShader(t){this._quad||(this._quad=new ie(t,[-1,-1,1,-1,-1,1,1,1]))}_createOrResizeTexture(t,e,i){const{context:n}=t;if(this._backBufferTexture===null||e!==this._size[0]||i!==this._size[1]){if(this._backBufferTexture)this._backBufferTexture.resize(e,i);else{const s=new xt;s.internalFormat=Kt.RGBA,s.wrapMode=bt.CLAMP_TO_EDGE,s.width=e,s.height=i,this._backBufferTexture=new Mt(n,s)}this._size[0]=e,this._size[1]=i}}}const ps={shaders:{vertexShader:x("highlight/textured.vert"),fragmentShader:x("highlight/highlight.frag")},attributes:new Map([["a_position",0],["a_texcoord",1]])},fs={shaders:{vertexShader:x("highlight/textured.vert"),fragmentShader:x("highlight/blur.frag")},attributes:new Map([["a_position",0],["a_texcoord",1]])},M=L("esri-2d-profiler");let ws=class{constructor(t,e){if(this._events=new le,this._entries=new Map,this._timings=new Ue(10),this._currentContainer=null,this._currentPass=null,this._currentBrush=null,this._currentSummary=null,!M)return;this._ext=Ne(t.gl,{}),this._debugOutput=e;const i=t.gl;if(!this.enableCommandLogging)return;let n;for(n in i)if(typeof i[n]=="function"){const s=i[n],a=n.includes("draw");i[n]=(...o)=>(this._events.emit("command",{container:this._currentContainer,pass:this._currentPass,brush:this._currentBrush,method:n,args:o,isDrawCommand:a}),this._currentSummary&&(this._currentSummary.commands++,a&&this._currentSummary.drawCommands++),s.apply(i,o))}}get enableCommandLogging(){return!(typeof M=="object"&&M.disableCommands)}recordContainerStart(t){M&&(this._currentContainer=t)}recordContainerEnd(){M&&(this._currentContainer=null)}recordPassStart(t){M&&(this._currentPass=t,this._initSummary())}recordPassEnd(){M&&(this._currentPass=null,this._emitSummary())}recordBrushStart(t){M&&(this._currentBrush=t)}recordBrushEnd(){M&&(this._currentBrush=null)}recordStart(t){if(M&&this._ext!=null){if(this._entries.has(t)){const i=this._entries.get(t),n=this._ext.resultAvailable(i.query),s=this._ext.disjoint();if(n&&!s){const a=this._ext.getResult(i.query)/1e6;let o=0;if(this._timings.enqueue(a)!=null){const u=this._timings.entries,m=u.length;let l=0;for(const d of u)l+=d;o=l/m}const h=a.toFixed(2),c=o?o.toFixed(2):"--";this.enableCommandLogging?(console.groupCollapsed(`Frame report for ${t}, ${h} ms (${c} last 10 avg)
${i.commandsLen} Commands (${i.drawCommands} draw)`),console.log("RenderPass breakdown: "),console.table(i.summaries),console.log("Commands: ",i.commands),console.groupEnd()):console.log(`Frame report for ${t}, ${h} ms (${c} last 10 avg)`),this._debugOutput.innerHTML=`${h} (${c})`}for(const a of i.handles)a.remove();this._ext.deleteQuery(i.query),this._entries.delete(t)}const e={name:t,query:this._ext.createQuery(),commands:[],commandsLen:0,drawCommands:0,summaries:[],handles:[]};this.enableCommandLogging&&(e.handles.push(this._events.on("command",i=>{e.commandsLen++,e.commands.push(i),i.isDrawCommand&&e.drawCommands++})),e.handles.push(this._events.on("summary",i=>{e.summaries.push(i)}))),this._ext.beginTimeElapsed(e.query),this._entries.set(t,e)}}recordEnd(t){M&&this._ext!=null&&this._entries.has(t)&&this._ext.endTimeElapsed()}_initSummary(){this.enableCommandLogging&&(this._currentSummary={container:this._currentContainer,pass:this._currentPass,drawCommands:0,commands:0})}_emitSummary(){this.enableCommandLogging&&this._currentSummary&&this._events.emit("summary",this._currentSummary)}};const tt=2,S=1,H=0,W=1,Y=2;let xi=class{constructor(t,e,i){this._debugMap=new Map,this._width=t*i,this._height=e*i,this._pixelRatio=i;const n=Math.ceil(this._width/S),s=Math.ceil(this._height/S);this._cols=n,this._rows=s,this._cells=Ve.create(n*s)}insertMetrics(t){const e=this._hasCollision(t);return e===H&&this._markMetrics(t),e}getCellId(t,e){return t+e*this._cols}has(t){return this._cells.has(t)}hasRange(t,e){return this._cells.hasRange(t,e)}set(t){this._cells.set(t)}setRange(t,e){this._cells.setRange(t,e)}_collide(t,e,i,n){const s=t-i/2,a=e-n/2,o=s+i,h=a+n;if(o<0||h<0||s>this._width||a>this._height)return W;const c=C(Math.floor(s/S),0,this._cols),u=C(Math.floor(a/S),0,this._rows),m=C(Math.ceil(o/S),0,this._cols),l=C(Math.ceil(h/S),0,this._rows);for(let d=u;d<=l;d++)for(let g=c;g<=m;g++){const _=this.getCellId(g,d);if(this.has(_))return Y}return H}_mark(t,e,i,n,s){const a=t-i/2,o=e-n/2,h=a+i,c=o+n,u=C(Math.floor(a/S),0,this._cols),m=C(Math.floor(o/S),0,this._rows),l=C(Math.ceil(h/S),0,this._cols),d=C(Math.ceil(c/S),0,this._rows);for(let g=m;g<=d;g++)for(let _=u;_<=l;_++){const y=this.getCellId(_,g);this._debugMap.set(y,s),this.set(y)}return!1}_hasCollision(t){const e=t.id;let i=0,n=0;t.save();do{const s=t.boundsCount;i+=s;for(let a=0;a<s;a++){const o=t.boundsComputedAnchorX(a),h=t.boundsComputedAnchorY(a),c=(t.boundsWidth(a)+tt)*this._pixelRatio,u=(t.boundsHeight(a)+tt)*this._pixelRatio;switch(this._collide(o,h,c,u)){case Y:return Y;case W:n++}}}while(t.peekId()===e&&t.next());return t.restore(),i===n?W:H}_markMetrics(t){const e=t.id;t.save();do{const i=t.boundsCount;for(let n=0;n<i;n++){const s=t.boundsComputedAnchorX(n),a=t.boundsComputedAnchorY(n),o=(t.boundsWidth(n)+tt)*this._pixelRatio,h=(t.boundsHeight(n)+tt)*this._pixelRatio;this._mark(s,a,o,h,t.id)}}while(t.peekId()===e&&t.next());t.restore()}};const mt=254,et=255,G=0;function E(r,t){const e=[];r.forEachTile(i=>e.push(i)),e.sort((i,n)=>i.instanceId-n.instanceId),e.forEach(i=>{i.labelMetrics!=null&&i.isReady&&t(i,i.labelMetrics.getCursor())})}let Mi=class{run(t,e,i){const n=[];for(let s=t.length-1;s>=0;s--){const a=t[s];a.labelingCollisionInfos&&n.push(...a.labelingCollisionInfos)}this._transformMetrics(n),this._runCollision(n,e,i)}_runCollision(t,e,i){const[n,s]=e.state.size,a=new xi(n,s,e.pixelRatio);for(const{tileRenderer:o,deconflictionEnabled:h,visible:c}of t){const u=o.featuresView.attributeView;h?c?(this._prepare(o),this._collideVisible(a,o,i),this._collideInvisible(a,o)):E(o,(m,l)=>{for(;l.nextId();)u.setLabelMinZoom(l.id,et)}):E(o,(m,l)=>{for(;l.nextId();)u.setLabelMinZoom(l.id,G),c&&a.insertMetrics(l)})}}_isFiltered(t,e,i){const n=e.getFilterFlags(t),s=!i.hasFilter||!!(n&Te),a=i.featureEffect==null||i.featureEffect.excludedLabelsVisible||!!(n&ze);return!(s&&a)}_prepare(t){const e=t.featuresView.attributeView,i=new Set;E(t,(n,s)=>{for(;s.nextId();)if(!i.has(s.id)){if(i.add(s.id),this._isFiltered(s.id,e,t.layerView)){e.setLabelMinZoom(s.id,mt);continue}e.getLabelMinZoom(s.id)!==G?e.setLabelMinZoom(s.id,et):e.setLabelMinZoom(s.id,G)}})}_collideVisible(t,e,i){const n=e.featuresView.attributeView,s=new Set;E(e,(a,o)=>{for(;o.nextId();)if(!s.has(o.id))if(a.key.level===i){if(n.getLabelMinZoom(o.id)===0)switch(t.insertMetrics(o)){case W:break;case Y:n.setLabelMinZoom(o.id,mt),s.add(o.id);break;case H:n.setLabelMinZoom(o.id,G),s.add(o.id)}}else n.setLabelMinZoom(o.id,mt)})}_collideInvisible(t,e){const i=e.featuresView.attributeView,n=new Set;E(e,(s,a)=>{for(;a.nextId();)if(!n.has(a.id)&&i.getLabelMinZoom(a.id)===et)switch(t.insertMetrics(a)){case W:break;case Y:i.setLabelMinZoom(a.id,et),n.add(a.id);break;case H:i.setLabelMinZoom(a.id,G),n.add(a.id)}})}_transformMetrics(t){for(const{tileRenderer:e,geometryType:i,vvEvaluators:n}of t)E(e,(s,a)=>{const o=e.featuresView.attributeView,h=s.transforms.labelMat2d;h[4]=Math.round(h[4]),h[5]=Math.round(h[5]);const c=i==="polyline";for(;a.next();){const u=a.boundsCount,m=a.anchorX,l=a.anchorY;let d=a.size;const g=n[0];if(g!=null){const w=g(o.getVVSize(a.id));d=isNaN(w)||w==null||w===1/0?d:w}const _=a.directionX*(d/2),y=a.directionY*(d/2);for(let w=0;w<u;w++){let ht=m,ct=a.anchorY;if(c){let P=ht+a.boundsX(w)+_,D=ct+a.boundsY(w)+y;P=h[0]*P+h[2]*D+h[4],D=h[1]*P+h[3]*D+h[5],a.setBoundsComputedAnchorX(w,Math.floor(P)),a.setBoundsComputedAnchorY(w,Math.floor(D))}else{ht=h[0]*m+h[2]*l+h[4],ct=h[1]*m+h[3]*l+h[5];const P=ht+a.boundsX(w)+_,D=ct+a.boundsY(w)+y;a.setBoundsComputedAnchorX(w,P),a.setBoundsComputedAnchorY(w,D)}}}})}};const $i=32;let V=class extends O{constructor(t){super(t),this.collisionEngine=new Mi,this.lastUpdateId=-1,this.updateRequested=!1,this.view=null,this._applyVisibilityPass=Ge(e=>{const i=this.view;if(i)try{const n=i.featuresTilingScheme.getClosestInfoForScale(e.state.scale).level;this.collisionEngine.run(i.allLayerViews.items,e,n)}catch{}},$i,this),this.addHandles(this._applyVisibilityPass)}get updating(){return L("esri-2d-log-updating")&&console.log(`Updating LabelManager ${this.updateRequested}:
-> updateRequested: ${this.updateRequested}`),this.updateRequested}update(t){this._applyVisibilityPass(t)}viewChange(){this.requestUpdate()}requestUpdate(){var t;this.updateRequested||(this.updateRequested=!0,(t=this.view)==null||t.requestUpdate())}processUpdate(t){this.updateRequested&&(this.updateRequested=!1,this.update(t))}};p([f()],V.prototype,"updateRequested",void 0),p([f()],V.prototype,"updating",null),p([f()],V.prototype,"view",void 0),V=p([U("esri.views.2d.LabelManager")],V);const it="esri-zoom-box",st={container:`${it}__container`,overlay:`${it}__overlay`,background:`${it}__overlay-background`,box:`${it}__outline`},gt={zoom:"Shift",counter:"Ctrl"};let q=class extends O{constructor(r){super(r),this._container=null,this._overlay=null,this._backgroundShape=null,this._boxShape=null,this._box={x:0,y:0,width:0,height:0},this._rafId=null,this._redraw=this._redraw.bind(this)}destroy(){this.view=null}set view(r){this.removeAllHandles(),this._destroyOverlay(),this._set("view",r),r&&this.addHandles([r.on("drag",[gt.zoom],t=>this._handleDrag(t,1),Bt.INTERNAL),r.on("drag",[gt.zoom,gt.counter],t=>this._handleDrag(t,-1),Bt.INTERNAL)])}_start(){this._createContainer(),this._createOverlay(),this.navigation.begin()}_update(r,t,e,i){this._box.x=r,this._box.y=t,this._box.width=e,this._box.height=i,this._rafId||(this._rafId=requestAnimationFrame(this._redraw))}_end(r,t,e,i,n){const s=this.view,a=s.toMap(de(r+.5*e,t+.5*i));let o=Math.max(e/s.width,i/s.height);n===-1&&(o=1/o),this._destroyOverlay(),this.navigation.end(),s.goTo({center:a,scale:s.scale*o})}_updateBox(r,t,e,i){const n=this._boxShape;n.setAttributeNS(null,"x",""+r),n.setAttributeNS(null,"y",""+t),n.setAttributeNS(null,"width",""+e),n.setAttributeNS(null,"height",""+i),n.setAttributeNS(null,"class",st.box)}_updateBackground(r,t,e,i){this._backgroundShape.setAttributeNS(null,"d",this._toSVGPath(r,t,e,i,this.view.width,this.view.height))}_createContainer(){const r=document.createElement("div");r.className=st.container,this.view.root.appendChild(r),this._container=r}_createOverlay(){const r=this.view.width,t=this.view.height,e=document.createElementNS("http://www.w3.org/2000/svg","path");e.setAttributeNS(null,"d","M 0 0 L "+r+" 0 L "+r+" "+t+" L 0 "+t+" Z"),e.setAttributeNS(null,"class",st.background);const i=document.createElementNS("http://www.w3.org/2000/svg","rect"),n=document.createElementNS("http://www.w3.org/2000/svg","svg");n.setAttributeNS("http://www.w3.org/2000/xmlns/","xmlns:xlink","http://www.w3.org/1999/xlink"),n.setAttributeNS(null,"class",st.overlay),n.appendChild(e),n.appendChild(i),this._container.appendChild(n),this._backgroundShape=e,this._boxShape=i,this._overlay=n}_destroyOverlay(){this._container&&this._container.parentNode&&this._container.parentNode.removeChild(this._container),this._container=this._backgroundShape=this._boxShape=this._overlay=null}_toSVGPath(r,t,e,i,n,s){const a=r+e,o=t+i;return"M 0 0 L "+n+" 0 L "+n+" "+s+" L 0 "+s+" ZM "+r+" "+t+" L "+r+" "+o+" L "+a+" "+o+" L "+a+" "+t+" Z"}_handleDrag(r,t){const e=r.x,i=r.y,n=r.origin.x,s=r.origin.y;let a,o,h,c;switch(e>n?(a=n,h=e-n):(a=e,h=n-e),i>s?(o=s,c=i-s):(o=i,c=s-i),r.action){case"start":this._start();break;case"update":this._update(a,o,h,c);break;case"end":this._end(a,o,h,c,t)}r.stopPropagation()}_redraw(){if(!this._rafId||(this._rafId=null,!this._overlay))return;const{x:r,y:t,width:e,height:i}=this._box;this._updateBox(r,t,e,i),this._updateBackground(r,t,e,i),this._rafId=requestAnimationFrame(this._redraw)}};p([f()],q.prototype,"navigation",void 0),p([f()],q.prototype,"view",null),q=p([U("esri.views.2d.navigation.ZoomBox")],q);const Si=q;let k=class extends O{constructor(t){super(t),this.animationTime=0,this.momentumEstimator=new Ye(500,6,.92),this.momentum=null,this.tmpMomentum=me(),this.momentumFinished=!1,this.viewpoint=new ot({targetGeometry:new rt,scale:0,rotation:0}),this._previousDrag=null,Jt(()=>this.momentumFinished,()=>this.navigation.stop())}begin(t,e){this.navigation.begin(),this.momentumEstimator.reset(),this.addToEstimator(e),this._previousDrag=e}update(t,e){this.addToEstimator(e);let i=e.center.x,n=e.center.y;const s=this._previousDrag;i=s?s.center.x-i:-i,n=s?n-s.center.y:n,t.viewpoint=nt(this.viewpoint,t.viewpoint,[i||0,n||0]),this._previousDrag=e}end(t,e){this.addToEstimator(e);const i=t.navigation.momentumEnabled;this.momentum=i?this.momentumEstimator.evaluateMomentum():null,this.animationTime=0,this.momentum&&this.onAnimationUpdate(t),this._previousDrag=null,this.navigation.end()}addToEstimator(t){const e=t.center.x,i=t.center.y,n=_e(-e,i),s=pe(-e,i,0);this.momentumEstimator.add(n,s,.001*t.timestamp)}onAnimationUpdate(t){var e;(e=this.navigation.animationManager)==null||e.animateContinous(t.viewpoint,(i,n)=>{const{momentum:s,animationTime:a,tmpMomentum:o}=this,h=.001*n;if(!(this.momentumFinished=!s||s.isFinished(a))){const c=s.valueDelta(a,h);ge(o,s.direction,c),nt(i,i,o),t.constraints.constrainByGeometry(i)}this.animationTime+=h})}stopMomentumNavigation(){this.momentum&&(this.momentumEstimator.reset(),this.momentum=null,this.navigation.stop())}};p([f()],k.prototype,"momentumFinished",void 0),p([f()],k.prototype,"viewpoint",void 0),p([f()],k.prototype,"navigation",void 0),k=p([U("esri.views.2d.navigation.actions.Pan")],k);const Ti=k;let B=class extends O{constructor(t){super(t),this._animationTime=0,this._momentumFinished=!1,this._previousAngle=0,this._previousRadius=0,this._previousCenter=null,this._rotationMomentumEstimator=new Qe(.6,.15,.95),this._rotationDirection=1,this._startAngle=0,this._startRadius=0,this._updateTimestamp=null,this._zoomDirection=1,this._zoomMomentumEstimator=new Xe,this._zoomOnly=null,this.zoomMomentum=null,this.rotateMomentum=null,this.viewpoint=new ot({targetGeometry:new rt,scale:0,rotation:0}),this.addHandles(Jt(()=>this._momentumFinished,()=>this.navigation.stop()))}begin(t,e){this.navigation.begin(),this._rotationMomentumEstimator.reset(),this._zoomMomentumEstimator.reset(),this._zoomOnly=null,this._previousAngle=this._startAngle=e.angle,this._previousRadius=this._startRadius=e.radius,this._previousCenter=e.center,this._updateTimestamp=null,t.constraints.rotationEnabled&&this.addToRotateEstimator(0,e.timestamp),this.addToZoomEstimator(e,1)}update(t,e){this._updateTimestamp===null&&(this._updateTimestamp=e.timestamp);const i=e.angle,n=e.radius,s=e.center,a=Math.abs(180*(i-this._startAngle)/Math.PI),o=Math.abs(n-this._startRadius),h=this._startRadius/n;if(this._previousRadius&&this._previousCenter){const c=n/this._previousRadius;let u=180*(i-this._previousAngle)/Math.PI;this._rotationDirection=u>=0?1:-1,this._zoomDirection=c>=1?1:-1,t.constraints.rotationEnabled?(this._zoomOnly===null&&e.timestamp-this._updateTimestamp>200&&(this._zoomOnly=o-a>0),this._zoomOnly===null||this._zoomOnly?u=0:this.addToRotateEstimator(i-this._startAngle,e.timestamp)):u=0,this.addToZoomEstimator(e,h),this.navigation.setViewpoint([s.x,s.y],1/c,u,[this._previousCenter.x-s.x,s.y-this._previousCenter.y])}this._previousAngle=i,this._previousRadius=n,this._previousCenter=s}end(t){this.rotateMomentum=this._rotationMomentumEstimator.evaluateMomentum(),this.zoomMomentum=this._zoomMomentumEstimator.evaluateMomentum(),this._animationTime=0,(this.rotateMomentum||this.zoomMomentum)&&this.onAnimationUpdate(t),this.navigation.end()}addToRotateEstimator(t,e){this._rotationMomentumEstimator.add(t,.001*e)}addToZoomEstimator(t,e){this._zoomMomentumEstimator.add(e,.001*t.timestamp)}canZoomIn(t){const e=t.scale,i=t.constraints.effectiveMaxScale;return i===0||e>i}canZoomOut(t){const e=t.scale,i=t.constraints.effectiveMinScale;return i===0||e<i}onAnimationUpdate(t){var e;(e=this.navigation.animationManager)==null||e.animateContinous(t.viewpoint,(i,n)=>{const s=!this.canZoomIn(t)&&this._zoomDirection>1||!this.canZoomOut(t)&&this._zoomDirection<1,a=!this.rotateMomentum||this.rotateMomentum.isFinished(this._animationTime),o=s||!this.zoomMomentum||this.zoomMomentum.isFinished(this._animationTime),h=.001*n;if(this._momentumFinished=a&&o,!this._momentumFinished){const c=this.rotateMomentum?Math.abs(this.rotateMomentum.valueDelta(this._animationTime,h))*this._rotationDirection*180/Math.PI:0;let u=this.zoomMomentum?Math.abs(this.zoomMomentum.valueDelta(this._animationTime,h)):1;const m=X(),l=X();if(this._previousCenter){Q(m,this._previousCenter.x,this._previousCenter.y),qe(l,t.size,t.padding),fe(m,m,l);const{constraints:d,scale:g}=t,_=g*u;u<1&&!d.canZoomInTo(_)?(u=g/d.effectiveMaxScale,this.zoomMomentum=null,this.rotateMomentum=null):u>1&&!d.canZoomOutTo(_)&&(u=g/d.effectiveMinScale,this.zoomMomentum=null,this.rotateMomentum=null),Ze(i,t.viewpoint,u,c,m,t.size),t.constraints.constrainByGeometry(i)}}this._animationTime+=h})}stopMomentumNavigation(){(this.rotateMomentum||this.zoomMomentum)&&(this.rotateMomentum&&(this._rotationMomentumEstimator.reset(),this.rotateMomentum=null),this.zoomMomentum&&(this._zoomMomentumEstimator.reset(),this.zoomMomentum=null),this.navigation.stop())}};p([f()],B.prototype,"_momentumFinished",void 0),p([f()],B.prototype,"viewpoint",void 0),p([f()],B.prototype,"navigation",void 0),B=p([U("esri.views.2d.navigation.actions.Pinch")],B);const zi=B,_t=X(),Yt=X();let Z=class extends O{constructor(r){super(r),this._previousCenter=X(),this.viewpoint=new ot({targetGeometry:new rt,scale:0,rotation:0})}begin(r,t){this.navigation.begin(),Q(this._previousCenter,t.center.x,t.center.y)}update(r,t){const{state:{size:e,padding:i}}=r;Q(_t,t.center.x,t.center.y),He(Yt,e,i),r.viewpoint=yt(this.viewpoint,r.state.paddedViewState.viewpoint,We(Yt,this._previousCenter,_t)),we(this._previousCenter,_t)}end(){this.navigation.end()}};p([f()],Z.prototype,"viewpoint",void 0),p([f()],Z.prototype,"navigation",void 0),Z=p([U("esri.views.2d.actions.Rotate")],Z);const Ci=Z,F=10,Qt=1,pt=new ot({targetGeometry:new rt}),ft=[0,0],Xt=250;let T=class extends O{constructor(r){super(r),this._endTimer=null,this._lastEventTimestamp=null,this.animationManager=null,this.interacting=!1}initialize(){this.pan=new Ti({navigation:this}),this.rotate=new Ci({navigation:this}),this.pinch=new zi({navigation:this}),this.zoomBox=new Si({view:this.view,navigation:this})}destroy(){this.pan=j(this.pan),this.rotate=j(this.rotate),this.pinch=j(this.pinch),this.zoomBox=j(this.zoomBox),this.animationManager=null}begin(){this._set("interacting",!0)}end(){this._lastEventTimestamp=performance.now(),this._startTimer(Xt)}async zoom(r,t=this._getDefaultAnchor()){if(this.stop(),this.begin(),this.view.constraints.snapToZoom&&this.view.constraints.effectiveLODs)return r<1?this.zoomIn(t):this.zoomOut(t);this.setViewpoint(t,r,0,[0,0])}async zoomIn(r){const t=this.view,e=t.constraints.snapToNextScale(t.scale);return this._zoomToScale(e,r)}async zoomOut(r){const t=this.view,e=t.constraints.snapToPreviousScale(t.scale);return this._zoomToScale(e,r)}setViewpoint(r,t,e,i){this.begin(),this.view.stateManager.state.viewpoint=this._scaleRotateTranslateViewpoint(this.view.viewpoint,r,t,e,i),this.end()}setViewpointImmediate(r,t=0,e=[0,0],i=this._getDefaultAnchor()){this.view.stateManager.state.viewpoint=this._scaleRotateTranslateViewpoint(this.view.viewpoint,i,r,t,e)}continousRotateClockwise(){var t;const r=this.view.viewpoint;(t=this.animationManager)==null||t.animateContinous(r,e=>{yt(e,e,-Qt)})}continousRotateCounterclockwise(){var t;const r=this.view.viewpoint;(t=this.animationManager)==null||t.animateContinous(r,e=>{yt(e,e,Qt)})}resetRotation(){this.view.constraints.rotationEnabled&&(this.view.rotation=0)}continousPanLeft(){this._continuousPan([-F,0])}continousPanRight(){this._continuousPan([F,0])}continousPanUp(){this._continuousPan([0,F])}continousPanDown(){this._continuousPan([0,-F])}continuousPanVector({x:r,y:t}){this._continuousPan([r*F,t*F])}stop(){var r;this.pan.stopMomentumNavigation(),(r=this.animationManager)==null||r.stop(),this.end(),this._endTimer!==null&&(clearTimeout(this._endTimer),this._endTimer=null,this._set("interacting",!1))}_continuousPan(r){var e;const t=this.view.viewpoint;(e=this.animationManager)==null||e.animateContinous(t,i=>{nt(i,i,r),this.view.constraints.constrainByGeometry(i)})}_startTimer(r){return this._endTimer!==null||(this._endTimer=setTimeout(()=>{this._endTimer=null;const t=performance.now()-(this._lastEventTimestamp??0);t<Xt?this._endTimer=this._startTimer(t):this._set("interacting",!1)},r)),this._endTimer}_getDefaultAnchor(){const{size:r,padding:{left:t,right:e,top:i,bottom:n}}=this.view;return ft[0]=.5*(r[0]-e+t),ft[1]=.5*(r[1]-n+i),ft}async _zoomToScale(r,t=this._getDefaultAnchor()){const{view:e}=this,{constraints:i,scale:n,viewpoint:s,size:a,padding:o}=e,h=i.canZoomInTo(r),c=i.canZoomOutTo(r);if(!(r<n&&!h||r>n&&!c))return kt(pt,s,r/n,0,t,a,o),i.constrainByGeometry(pt),e.goTo(pt,{animate:!0,pickClosestTarget:!1})}_scaleRotateTranslateViewpoint(r,t,e,i,n){const{view:s}=this,{size:a,padding:o,constraints:h,scale:c,viewpoint:u}=s,m=c*e,l=h.canZoomInTo(m),d=h.canZoomOutTo(m);return(e<1&&!l||e>1&&!d)&&(e=1),nt(u,u,n),kt(r,u,e,i,t,a,o),h.constrainByGeometry(r)}};p([f()],T.prototype,"animationManager",void 0),p([f({type:Boolean,readOnly:!0})],T.prototype,"interacting",void 0),p([f()],T.prototype,"pan",void 0),p([f()],T.prototype,"pinch",void 0),p([f()],T.prototype,"rotate",void 0),p([f()],T.prototype,"view",void 0),p([f()],T.prototype,"zoomBox",void 0),T=p([U("esri.views.2d.navigation.MapViewNavigation")],T);const Ss=T,Ii={shaders:{vertexShader:x("magnifier/magnifier.vert"),fragmentShader:x("magnifier/magnifier.frag")},attributes:new Map([["a_pos",0]])};function Ts(r){return je(r,Ii)}export{ms as J,fs as a,Ts as b,Ii as c,V as d,ns as e,pi as l,_s as m,ws as n,gs as r,ps as t,Ss as y};
