import{bg as C,eL as U,b9 as y,X as G,gy as S,gl as Z,a5 as n,a6 as r,a9 as u,B as x,bA as M}from"./index-b516d057.js";import{e as R}from"./dehydratedPoint-5a1dfed5.js";import{l as b}from"./ViewingMode-5d7d590b.js";import{S as $}from"./SnappingVisualizer2D-4547907b.js";import{w as K,V as A,p as E,l as D}from"./EditGeometryOperations-c2e73f2d.js";import{e as z}from"./SnappingContext-90969376.js";import{p as F}from"./SnappingOperation-4a4ee09b.js";import{_ as s,n as p}from"./screenUtils-8dc4a7f9.js";import{e as a}from"./snappingUtils-93e84fbe.js";import{o as N}from"./elevationInfoUtils-be36d866.js";import{k as B,o as Y,r as X,c as k,e as I,F as j}from"./surfaceCoordinateSystems-1cfad4a3.js";import{l as q}from"./InteractiveToolBase-ddd44c70.js";var P;let l=P=class extends C.EventedAccessor{constructor(e){super(e),this._hasZ=null,this._cursorScreenPoint=null,this._activePointerId=null,this._stagedVertexUnsnapped=null,this._lastVertexUnsnapped=null,this._viewHandlesKey="view-handles",this._undoRedoHandlesKey="undo-redo-handles",this._drawToolHandlesKey="draw-tool",this._nativeEventHistory={undoStack:[],redoStack:[]},this.interactiveUndoDisabled=!1,this.history=[],this.redoHistory=[],this.snapToScene=!1,this.view=null,this.elevationInfo=null,this.defaultZ=0,this._coordinateHelper=K(!!e.hasZ,!1,e.view.spatialReference),this._snappingManager=e.snappingManager,this._editGeometryOperations=new A(new E(e.editGeometryType??"polygon",this._coordinateHelper)),this._snappingGraphicsLayer=new U({id:P.SNAPPING_GRAPHICS_LAYER_ID,listMode:"hide",internal:!0}),this._snappingContext=new z({editGeometryOperations:this._editGeometryOperations,elevationInfo:{mode:"on-the-ground",offset:0},pointer:"mouse",visualizer:new $(this._snappingGraphicsLayer)}),this._activeComponent=new D(e.view.spatialReference,b.Local),this._editGeometryOperations.data.components.push(this._activeComponent)}normalizeCtorArgs(e){const t={...e};return delete t.editGeometryType,t}initialize(){this._snappingOperation=new F({view:this.view}),this.view.type==="2d"&&this.view.map.layers.add(this._snappingGraphicsLayer)}destroy(){this.view.map.layers.remove(this._snappingGraphicsLayer),this._snappingGraphicsLayer.destroy(),this._snappingManager!=null&&this._snappingManager.doneSnapping(),this._snappingOperation=y(this._snappingOperation),this._editGeometryOperations.destroy()}get _committedVertices(){return this._editGeometryOperations.data.components[0].vertices.map(e=>e.pos)}get vertices(){return this._stagedVertex!=null?[...this._committedVertices,this._coordinateHelper.pointToArray(this._stagedVertex)]:this._committedVertices}get hasZ(){return this._hasZ!=null?this._hasZ:this.view.type==="3d"}set hasZ(e){this._hasZ=e,this.notifyChange("hasZ")}get _stagedVertex(){return this._snappingOperation.stagedPoint}set _stagedVertex(e){this._snappingOperation.stagedPoint=G(e)}canUndo(){return this._editGeometryOperations.canUndo}canRedo(){return this._editGeometryOperations.canRedo}undo(){this.canUndo&&this._editGeometryOperations.undo()}redo(){this.canRedo&&this._editGeometryOperations.redo()}getCoordsFromScreenPoint(e){const t=e&&this.screenToMap(e);return t==null?null:t.hasZ?[t.x,t.y,t.z]:[t.x,t.y]}getCoordsAndPointFromScreenPoint(e){const t=this.screenToMap(e);return t==null?null:t.hasZ?{vertex:[t.x,t.y,t.z],mapPoint:t}:{vertex:[t.x,t.y],mapPoint:t}}screenToMap(e){let t=null;if(this.view.type==="3d")if(this.hasZ){const i=this.elevationInfo??J;t=this.view.sceneIntersectionHelper.intersectElevationFromScreen(S(e.x,e.y),i,this._getGeometryZValue())}else{const i=this.elevationInfo??Q;t=this.view.sceneIntersectionHelper.intersectElevationFromScreen(S(e.x,e.y),i,0),t!=null&&(t.z=void 0)}else t=this.view.toMap(e),t!=null&&(t.z=this.hasZ?this._getGeometryZValue():void 0);return t}_pushCursorVertex(e,t){const i=R(e[0],e[1],void 0,this.view.spatialReference);this._stagedVertexUnsnapped=i;const o=this._snappingManager;if(o==null)return this._stagedVertex=i,void t();Z(this._snappingOperation.snap({point:i},o,this._snappingContext)).then(()=>{t()})}_popCursorVertex(){this._stagedVertexUnsnapped=null,this._stagedVertex=null}_getGeometryZValue(){return this.defaultZ}_abortSnapping(){this._snappingOperation.abort()}_isDuplicateOfLastVertex(e){var d;const t=(d=this._editGeometryOperations.data.components[0].getLastVertex())==null?void 0:d.pos;if(t&&e[0]===t[0]&&e[1]===t[1])return!0;const{x:i,y:o}=this._coordinateHelper.vectorToDehydratedPoint(e);return this._lastVertexUnsnapped!=null&&i===this._lastVertexUnsnapped.x&&o===this._lastVertexUnsnapped.y}_shouldHandlePointerEvent(e){return this._isPrimaryPointerAction(e)&&(this._activePointerId==null||this._activePointerId===e.pointerId)}_vertexAddHandler(e){const t=this._stagedVertex!=null?this._coordinateHelper.pointToArray(this._stagedVertex):this.getCoordsFromScreenPoint(this._cursorScreenPoint);t!=null&&this._addVertex(t,e.native)}_drawCompleteHandler(e){this._completeDrawing(e.native)}_isPrimaryPointerAction(e){return e.pointerType!=="mouse"||e.button===0}};l.SNAPPING_GRAPHICS_LAYER_ID="DrawAction-snapping-graphics-layer",n([r({readOnly:!0})],l.prototype,"vertices",null),n([r({type:Boolean,nonNullable:!0})],l.prototype,"interactiveUndoDisabled",void 0),n([r({readOnly:!0})],l.prototype,"history",void 0),n([r({readOnly:!0})],l.prototype,"redoHistory",void 0),n([r()],l.prototype,"snapToScene",void 0),n([r()],l.prototype,"view",void 0),n([r()],l.prototype,"elevationInfo",void 0),n([r({nonNullable:!0})],l.prototype,"defaultZ",void 0),n([r()],l.prototype,"hasZ",null),n([r()],l.prototype,"_snappingOperation",void 0),n([r()],l.prototype,"_stagedVertex",null),l=P=n([u("esri.views.draw.DrawAction")],l);const J={mode:"absolute-height",offset:0},Q={mode:"on-the-ground",offset:0},O=l;class c{constructor(t,i,o,d){this.view=t,this.native=i,this.vertexIndex=o,this.vertices=d,this.defaultPrevented=!1,this.type="vertex-add"}preventDefault(){this.defaultPrevented=!0}}class f{constructor(t,i,o,d){this.view=t,this.native=i,this.vertexIndex=o,this.vertices=d,this.defaultPrevented=!1,this.type="vertex-remove"}preventDefault(){this.defaultPrevented=!0}}class _{constructor(t,i,o,d,L=null){this.view=t,this.native=i,this.vertexIndex=o,this.vertices=d,this.mapPoint=L,this.coordinates=null,this.defaultPrevented=!1,this.type="cursor-update",this.coordinates=d.length===1?d[0]:null}preventDefault(){this.defaultPrevented=!0}}class v{constructor(t,i){this.native=t,this.vertices=i,this.coordinates=null,this.defaultPrevented=!1,this.type="draw-complete",this.coordinates=i.length===1?i[0]:null}preventDefault(){this.defaultPrevented=!0}}let V=class extends O{constructor(e){super(e),this._popVertexOnPointerMove=!1,this._addVertexOnPointerUp=!1}initialize(){this._addViewHandles(),this._addUndoRedoHandles()}destroy(){this._removeViewHandles(),this._removeUndoRedoHandles(),this.emit("destroy")}undo(){super.undo(),this.notifyChange("vertices")}redo(){super.redo(),this.notifyChange("vertices")}complete(){this._completeDrawing()}_addViewHandles(){this._removeViewHandles(),this.addHandles([this.view.on("click",e=>{e.stopPropagation()},s.TOOL),this.view.on("pointer-down",e=>{this._shouldHandlePointerEvent(e)&&(this._abortSnapping(),this._activePointerId=e.pointerId,this._addVertexOnPointerUp=!0,this._cursorScreenPoint=p(e),e.pointerType==="touch"&&this._updateCursor(e.native))},s.TOOL),this.view.on("pointer-move",e=>{this._popVertexOnPointerMove&&(this.undo(),this._popVertexOnPointerMove=!1),this._abortSnapping(),this._cursorScreenPoint=p(e),e.pointerType!=="touch"&&this._updateCursor(e.native)},s.TOOL),this.view.on("pointer-drag",e=>{this._shouldHandlePointerEvent(e)&&(this._abortSnapping(),this._addVertexOnPointerUp=!1)},s.TOOL),this.view.on("pointer-up",e=>{if(this._shouldHandlePointerEvent(e))if(this._abortSnapping(),this._activePointerId=null,this._addVertexOnPointerUp)this._vertexAddHandler(e);else{const t=e.pointerType==="touch";this._updateCursor(e.native,t)}},s.TOOL),this.view.on("drag",["Shift"],e=>{e.stopPropagation()},s.TOOL),this.view.on("double-click",e=>{e.stopPropagation(),this._drawCompleteHandler(e)},s.TOOL),this.view.on("double-click",["Control"],e=>{e.stopPropagation(),this._drawCompleteHandler(e)},s.TOOL),this.view.on("key-down",e=>{const{key:t,repeat:i}=e;t===a.vertexAdd&&!i&&this._cursorScreenPoint?(e.stopPropagation(),this._abortSnapping(),this._vertexAddHandler(e)):t!==a.complete||i?t!==a.undo||this.interactiveUndoDisabled||i?t!==a.redo||this.interactiveUndoDisabled||i?t!==a.pan||i||e.stopPropagation():(e.stopPropagation(),this.redo()):(e.stopPropagation(),this.undo()):(e.stopPropagation(),this._drawCompleteHandler(e))},s.TOOL),this.view.on("key-up",e=>{e.key===a.pan&&e.stopPropagation()},s.TOOL)],this._viewHandlesKey)}_addUndoRedoHandles(){this._removeUndoRedoHandles(),this.addHandles([this._editGeometryOperations.on("vertex-remove",e=>{if(this.notifyChange("vertices"),e.operation==="undo"){const t=this._nativeEventHistory.undoStack.pop();this._nativeEventHistory.redoStack.push(t);const i=[...this._committedVertices];this._stagedVertex!=null&&i.push(this._coordinateHelper.pointToArray(this._stagedVertex)),this.emit("undo",new f(this.view,t,e.vertices[0].index,i))}}),this._editGeometryOperations.on("vertex-add",e=>{if(this.notifyChange("vertices"),e.operation==="apply"){const t=this._nativeEventHistory.undoStack[this._nativeEventHistory.undoStack.length],i=this._committedVertices.length-1,o=new c(this.view,t,i,this.vertices);this.emit("vertex-add",o),o.defaultPrevented&&(this._popVertexOnPointerMove=!0)}else if(e.operation==="redo"){const t=this._nativeEventHistory.redoStack.pop();this._nativeEventHistory.undoStack.push(t);const i=[...this._committedVertices];this._stagedVertex!=null&&i.push(this._coordinateHelper.pointToArray(this._stagedVertex)),this.emit("redo",new c(this.view,t,e.vertices[0].index,i))}})],this._undoRedoHandlesKey)}_removeViewHandles(){this.removeHandles(this._viewHandlesKey)}_removeUndoRedoHandles(){this.removeHandles(this._undoRedoHandlesKey)}_addVertex(e,t){const i=this._coordinateHelper.arrayToVector(e);if(this._isDuplicateOfLastVertex(i))return;this._popCursorVertex(),this._editGeometryOperations.appendVertex(i);const o=t||new Event("placeholder");this._nativeEventHistory.undoStack.push(o)}_updateCursor(e,t=!1){if(this._popCursorVertex(),!this._cursorScreenPoint)return;const i=this.getCoordsAndPointFromScreenPoint(this._cursorScreenPoint);i==null||t||this._pushCursorVertex(i.vertex,()=>this.emit("cursor-update",new _(this.view,e,this._activeComponent.vertices.length,this.vertices,this._stagedVertex!=null?new x(this._stagedVertex):null)))}_completeDrawing(e){if(this._activePointerId=null,this._popCursorVertex(),this._abortSnapping(),this._snappingManager!=null&&this._snappingManager.doneSnapping(),this.vertices.length<1)return;const t=new v(e,this.vertices);this.emit("draw-complete",t),t.defaultPrevented||this._removeViewHandles()}};V=n([u("esri.views.draw.MultipointDrawAction")],V);let h=class extends C.EventedMixin(q){constructor(t){super(t),this.defaultZ=0,this.elevationInfo=null,this.hasZ=!0,this.mode=null,this.snapToScene=null,this.type="draw-3d"}initialize(){const t=this.view,i=N(this.hasZ,this.elevationInfo);this.drawOperation=new B({view:t,manipulators:this.manipulators,geometryType:this.geometryType,drawingMode:this.mode,hasZ:this.hasZ,defaultZ:this.defaultZ,snapToSceneEnabled:this.snapToScene,drawSurface:t.type==="3d"?new Y(t,i):null,elevationDrawSurface:t.type==="3d"?new X(i,this.defaultZ,t):null,hasM:!1,elevationInfo:i}),this.addHandles([this.drawOperation.on("vertex-add",o=>this.onVertexAdd(o)),this.drawOperation.on("vertex-remove",o=>this.onVertexRemove(o)),this.drawOperation.on("vertex-update",o=>this.onVertexUpdate(o)),this.drawOperation.on("cursor-update",o=>this.onCursorUpdate(o)),this.drawOperation.on("complete",o=>this.onComplete(o))]),this.finishToolCreation()}destroy(){this.drawOperation=y(this.drawOperation),this._set("view",null)}get canRedo(){return this.drawOperation.canRedo}get canUndo(){return this.drawOperation.canUndo}set enabled(t){this.drawOperation.interactive=t,this._set("enabled",t)}get updating(){var t;return((t=this.drawOperation)==null?void 0:t.updating)??!1}completeCreateOperation(){this.drawOperation.complete()}onDeactivate(){this.drawOperation.isCompleted||this.drawOperation.cancel()}getVertexCoords(){return this.drawOperation.vertices}onInputEvent(t){this.drawOperation.onInputEvent(t)}redo(){this.drawOperation.redo()}reset(){}undo(){this.drawOperation.undo()}onComplete(t){this.emit("complete",t)}onCursorUpdate(t){this.emit("cursor-update",t)}onVertexAdd(t){this.emit("vertex-add",t)}onVertexRemove(t){this.emit("vertex-remove",t)}onVertexUpdate(t){this.emit("vertex-update",t)}};n([r({constructOnly:!0,nonNullable:!0})],h.prototype,"defaultZ",void 0),n([r()],h.prototype,"drawOperation",void 0),n([r({constructOnly:!0})],h.prototype,"elevationInfo",void 0),n([r({value:!0})],h.prototype,"enabled",null),n([r({constructOnly:!0})],h.prototype,"geometryType",void 0),n([r({constructOnly:!0})],h.prototype,"hasZ",void 0),n([r({constructOnly:!0})],h.prototype,"mode",void 0),n([r()],h.prototype,"snapToScene",void 0),n([r({readOnly:!0})],h.prototype,"type",void 0),n([r({readOnly:!0})],h.prototype,"updating",null),n([r({constructOnly:!0,nonNullable:!0})],h.prototype,"view",void 0),h=n([u("esri.views.draw.DrawTool")],h);let T=class extends O{constructor(t){super(t),this._addVertexOnPointerUp=!1}initialize(){this.view.type==="2d"?this._addViewHandles():this._addDrawTool()}destroy(){this.view.type==="2d"?this._removeViewHandles():this._removeDrawTool(),this.emit("destroy")}complete(){this.view.type==="2d"?this._cursorScreenPoint&&this._completeDrawing():this._drawTool.completeCreateOperation()}_addViewHandles(){this._removeViewHandles(),this.addHandles([this.view.on("pointer-down",t=>{this._shouldHandlePointerEvent(t)&&(this._abortSnapping(),this._activePointerId=t.pointerId,this._addVertexOnPointerUp=!0,this._cursorScreenPoint=p(t),t.pointerType==="touch"&&this._updateCursor(t.native))},s.TOOL),this.view.on("pointer-move",t=>{this._abortSnapping(),this._cursorScreenPoint=p(t),t.pointerType!=="touch"&&this._updateCursor(t.native)},s.TOOL),this.view.on("pointer-drag",t=>{this._shouldHandlePointerEvent(t)&&(this._abortSnapping(),this._addVertexOnPointerUp=!1)},s.TOOL),this.view.on("pointer-up",t=>{if(this._shouldHandlePointerEvent(t))if(this._abortSnapping(),this._activePointerId=null,this._addVertexOnPointerUp)t.stopPropagation(),this._vertexAddHandler(t);else{const i=t.pointerType==="touch";this._updateCursor(t.native,i)}},s.TOOL),this.view.on("drag",["Shift"],t=>{t.stopPropagation()},s.TOOL),this.view.on("key-down",t=>{t.key===a.complete&&this._cursorScreenPoint&&(this._abortSnapping(),this._vertexAddHandler(t))},s.TOOL)],this._viewHandlesKey)}_removeViewHandles(){this.removeHandles(this._viewHandlesKey)}_addDrawTool(){this._drawTool=new h({view:this.view,elevationInfo:this.elevationInfo,hasZ:this.hasZ,geometryType:"point",mode:"click"}),this.view.addAndActivateTool(this._drawTool),this.addHandles([this._drawTool.on("cursor-update",t=>{t.vertices.length===1&&this.emit("cursor-update",new _(this.view,null,t.vertices[0].vertexIndex,this._drawTool.getVertexCoords()))}),this._drawTool.on("complete",t=>{this.emit("draw-complete",new v(null,this._drawTool.getVertexCoords())),this._removeDrawTool()})],this._drawToolHandlesKey)}_removeDrawTool(){this.removeHandles(this._drawToolHandlesKey),this.view.tools.remove(this._drawTool),this._drawTool=null}_addVertex(t){const i=this._coordinateHelper.arrayToVector(t);this._isDuplicateOfLastVertex(i)||(this._lastVertexUnsnapped=this._stagedVertexUnsnapped,this._popCursorVertex(),this._editGeometryOperations.appendVertex(i),this.notifyChange("vertices"),this._completeDrawing())}_updateCursor(t,i=!1){if(this._popCursorVertex(),!this._cursorScreenPoint)return;const o=this.getCoordsAndPointFromScreenPoint(this._cursorScreenPoint);o==null||i||this._pushCursorVertex(o.vertex,()=>this.emit("cursor-update",new _(this.view,t,this._activeComponent.vertices.length,this.vertices,this._stagedVertex!=null?new x(this._stagedVertex):null)))}_completeDrawing(t){this._activePointerId=null,this._popCursorVertex(),this._abortSnapping(),this._snappingManager!=null&&this._snappingManager.doneSnapping();const i=new v(t,this.vertices);this.emit("draw-complete",i),i.defaultPrevented||this._removeViewHandles()}};T=n([u("esri.views.draw.PointDrawAction")],T);let w=class extends O{constructor(t){super(t),this._panEnabled=!1,this._popVertexOnPointerMove=!1,this._addVertexOnPointerUp=!1,this.mode=I}initialize(){this.view.type==="2d"?(this._addViewHandles(),this._addUndoRedoHandles()):this._addDrawTool()}destroy(){this.view.type==="2d"?(this._removeViewHandles(),this._removeUndoRedoHandles()):this._removeDrawTool(),this.emit("destroy")}get _dragEnabled(){return this.mode==="freehand"||this.mode==="hybrid"}get _clickEnabled(){return this.mode==="click"||this.mode==="hybrid"}undo(){super.undo(),this.notifyChange("vertices")}redo(){super.redo(),this.notifyChange("vertices")}complete(){this.view.type==="2d"?this._completeDrawing():this._drawTool.completeCreateOperation()}_getGeometryZValue(){return this.hasZ&&this.vertices.length>0?this.vertices[0][2]:this.defaultZ}_addViewHandles(){this._removeViewHandles(),this.addHandles([this.view.on("click",t=>{t.stopPropagation()},s.TOOL),this.view.on("pointer-down",t=>{this._shouldHandlePointerEvent(t)&&(this._abortSnapping(),this._activePointerId=t.pointerId,this._addVertexOnPointerUp=!0,this._cursorScreenPoint=p(t),t.pointerType==="touch"&&this._updateCursor(t.native))},s.TOOL),this.view.on("pointer-move",t=>{this._abortSnapping(),this._popVertexOnPointerMove&&(this.undo(),this._popVertexOnPointerMove=!1),this._cursorScreenPoint=p(t),t.pointerType!=="touch"&&this._updateCursor(t.native)},s.TOOL),this.view.on("pointer-drag",t=>{this._shouldHandlePointerEvent(t)&&(this._abortSnapping(),this._cursorScreenPoint=p(t),this._dragEnabled&&!this._panEnabled?this._vertexAddHandler(t):this._addVertexOnPointerUp=!1)},s.TOOL),this.view.on("pointer-up",t=>{if(this._shouldHandlePointerEvent(t))if(this._abortSnapping(),this._activePointerId=null,this._addVertexOnPointerUp){if(!this._clickEnabled)return this.vertices.length===1&&this.vertices.pop(),void this._drawCompleteHandler(t);this._vertexAddHandler(t)}else{const i=t.pointerType==="touch";this._updateCursor(t.native,i)}},s.TOOL),this.view.on("drag",t=>{this._dragEnabled&&this._activePointerId!=null&&!this._panEnabled&&t.stopPropagation()},s.TOOL),this.view.on("drag",["Shift"],t=>{t.stopPropagation()},s.TOOL),this.view.on("double-click",t=>{t.stopPropagation(),this._drawCompleteHandler(t)},s.TOOL),this.view.on("double-click",["Control"],t=>{t.stopPropagation(),this._drawCompleteHandler(t)},s.TOOL),this.view.on("key-down",t=>{const{key:i,repeat:o}=t;i===a.vertexAdd&&!o&&this._cursorScreenPoint?(t.stopPropagation(),this._abortSnapping(),this._vertexAddHandler(t)):i!==a.complete||o?i!==a.undo||this.interactiveUndoDisabled||o?i!==a.redo||this.interactiveUndoDisabled||o?i!==a.pan||o||(t.stopPropagation(),this._panEnabled=!0):(t.stopPropagation(),this.redo()):(t.stopPropagation(),this.undo()):(t.stopPropagation(),this._drawCompleteHandler(t))},s.TOOL),this.view.on("key-up",t=>{t.key===a.pan&&(t.stopPropagation(),this._panEnabled=!1)},s.TOOL)],this._viewHandlesKey)}_addUndoRedoHandles(){this._removeUndoRedoHandles(),this.addHandles([this._editGeometryOperations.on("vertex-remove",t=>{if(this.notifyChange("vertices"),t.operation==="undo"){const i=this._nativeEventHistory.undoStack.pop();this._nativeEventHistory.redoStack.push(i);const o=[...this._committedVertices];this._stagedVertex!=null&&o.push(this._coordinateHelper.pointToArray(this._stagedVertex)),this.emit("undo",new f(this.view,i,t.vertices[0].index,o))}}),this._editGeometryOperations.on("vertex-add",t=>{if(this.notifyChange("vertices"),t.operation==="apply"){const i=this._nativeEventHistory.undoStack[this._nativeEventHistory.undoStack.length],o=this._committedVertices.length-1,d=new c(this.view,i,o,this.vertices);this.emit("vertex-add",d),d.defaultPrevented&&(this._popVertexOnPointerMove=!0)}else if(t.operation==="redo"){const i=this._nativeEventHistory.redoStack.pop();this._nativeEventHistory.undoStack.push(i);const o=[...this._committedVertices];this._stagedVertex!=null&&o.push(this._coordinateHelper.pointToArray(this._stagedVertex)),this.emit("redo",new c(this.view,i,t.vertices[0].index,o))}})],this._undoRedoHandlesKey)}_removeViewHandles(){this.removeHandles(this._viewHandlesKey)}_removeUndoRedoHandles(){this.removeHandles(this._undoRedoHandlesKey)}_addDrawTool(){this._drawTool=new h({view:this.view,elevationInfo:this.elevationInfo,hasZ:this.hasZ,geometryType:"polygon",mode:this.mode}),this.view.addAndActivateTool(this._drawTool),this._drawTool.on("vertex-add",t=>{t.vertices.length===1&&this.emit("vertex-add",new c(this.view,null,t.vertices[0].vertexIndex,this._drawTool.getVertexCoords()))}),this._drawTool.on("cursor-update",t=>{t.vertices.length===1&&this.emit("cursor-update",new _(this.view,null,t.vertices[0].vertexIndex,this._drawTool.getVertexCoords()))}),this._drawTool.on("complete",t=>{this.emit("draw-complete",new v(null,this._drawTool.getVertexCoords())),this._removeDrawTool()})}_removeDrawTool(){this.removeHandles(this._drawToolHandlesKey),this.view.tools.remove(this._drawTool),this._drawTool=y(this._drawTool)}_addVertex(t,i){const o=this._coordinateHelper.arrayToVector(t);if(this._isDuplicateOfLastVertex(o))return;this._lastVertexUnsnapped=this._stagedVertexUnsnapped,this._popCursorVertex(),this._editGeometryOperations.appendVertex(o);const d=i||new Event("placeholder");this._nativeEventHistory.undoStack.push(d)}_updateCursor(t,i=!1){if(this._popCursorVertex(),!this._cursorScreenPoint)return;const o=this.getCoordsAndPointFromScreenPoint(this._cursorScreenPoint);o==null||i||this._pushCursorVertex(o.vertex,()=>this.emit("cursor-update",new _(this.view,t,this._activeComponent.vertices.length,this.vertices,this._stagedVertex!=null?new x(this._stagedVertex):null)))}_completeDrawing(t){if(this._activePointerId=null,this._popCursorVertex(),this._committedVertices.length<3)return;this._abortSnapping(),this._snappingManager!=null&&this._snappingManager.doneSnapping();const i=new v(t,this.vertices);this.emit("draw-complete",i),i.defaultPrevented||this._removeViewHandles()}};n([r()],w.prototype,"_dragEnabled",null),n([r()],w.prototype,"_clickEnabled",null),n([r({type:k})],w.prototype,"mode",void 0),w=n([u("esri.views.draw.PolygonDrawAction")],w);let m=class extends O{constructor(e){super(e),this._panEnabled=!1,this._popVertexOnPointerMove=!1,this._addVertexOnPointerUp=!1,this.mode=I}initialize(){this.view.type==="2d"?(this._addViewHandles(),this._addUndoRedoHandles()):this._addDrawTool()}destroy(){this.view.type==="2d"?(this._removeViewHandles(),this._removeUndoRedoHandles()):this._removeDrawTool(),this.emit("destroy")}get _clickEnabled(){return this.mode==="click"||this.mode==="hybrid"}get _dragEnabled(){return this.mode==="freehand"||this.mode==="hybrid"}undo(){super.undo(),this.notifyChange("vertices")}redo(){super.redo(),this.notifyChange("vertices")}complete(){this.view.type==="2d"?this._completeDrawing():this._drawTool.completeCreateOperation()}_addViewHandles(){this._removeViewHandles(),this.addHandles([this.view.on("click",e=>{e.stopPropagation()},s.TOOL),this.view.on("pointer-down",e=>{this._shouldHandlePointerEvent(e)&&!this._panEnabled&&(this._abortSnapping(),this._activePointerId=e.pointerId,this._addVertexOnPointerUp=!0,this._cursorScreenPoint=p(e),e.pointerType==="touch"&&this._updateCursor(e.native))},s.TOOL),this.view.on("pointer-move",e=>{this._popVertexOnPointerMove&&(this.undo(),this._popVertexOnPointerMove=!1),this._abortSnapping(),this._cursorScreenPoint=p(e),e.pointerType!=="touch"&&this._updateCursor(e.native)},s.TOOL),this.view.on("pointer-drag",e=>{this._shouldHandlePointerEvent(e)&&(this._abortSnapping(),this._cursorScreenPoint=p(e),this._dragEnabled&&!this._panEnabled?this._vertexAddHandler(e):this._addVertexOnPointerUp=!1)},s.TOOL),this.view.on("pointer-up",e=>{if(this._shouldHandlePointerEvent(e))if(this._abortSnapping(),this._activePointerId=null,this._addVertexOnPointerUp){if(!this._clickEnabled)return this.vertices.length===1&&this.vertices.pop(),void this._drawCompleteHandler(e);this._vertexAddHandler(e)}else{const t=e.pointerType==="touch";this._updateCursor(e.native,t)}},s.TOOL),this.view.on("drag",e=>{this._dragEnabled&&this._activePointerId!=null&&!this._panEnabled&&e.stopPropagation()},s.TOOL),this.view.on("drag",["Shift"],e=>{e.stopPropagation()},s.TOOL),this.view.on("double-click",e=>{e.stopPropagation(),this._drawCompleteHandler(e)},s.TOOL),this.view.on("double-click",["Control"],e=>{e.stopPropagation(),this._drawCompleteHandler(e)},s.TOOL),this.view.on("key-down",e=>{const{key:t,repeat:i}=e;t===a.vertexAdd&&!i&&this._cursorScreenPoint?(e.stopPropagation(),this._abortSnapping(),this._vertexAddHandler(e)):t!==a.complete||i?t!==a.undo||this.interactiveUndoDisabled||i?t!==a.redo||this.interactiveUndoDisabled||i?t!==a.pan||i||(e.stopPropagation(),this._panEnabled=!0):(e.stopPropagation(),this.redo()):(e.stopPropagation(),this.undo()):(e.stopPropagation(),this._drawCompleteHandler(e))},s.TOOL),this.view.on("key-up",e=>{e.key===a.pan&&(e.stopPropagation(),this._panEnabled=!1)},s.TOOL)],this._viewHandlesKey)}_addUndoRedoHandles(){this._removeUndoRedoHandles(),this.addHandles([this._editGeometryOperations.on("vertex-remove",e=>{if(this.notifyChange("vertices"),e.operation==="undo"){const t=this._nativeEventHistory.undoStack.pop();this._nativeEventHistory.redoStack.push(t);const i=[...this._committedVertices];this._stagedVertex!=null&&i.push(this._coordinateHelper.pointToArray(this._stagedVertex)),this.emit("undo",new f(this.view,t,e.vertices[0].index,i))}}),this._editGeometryOperations.on("vertex-add",e=>{if(this.notifyChange("vertices"),e.operation==="apply"){const t=this._nativeEventHistory.undoStack[this._nativeEventHistory.undoStack.length],i=this._committedVertices.length-1,o=new c(this.view,t,i,this.vertices);this.emit("vertex-add",o),o.defaultPrevented&&(this._popVertexOnPointerMove=!0)}else if(e.operation==="redo"){const t=this._nativeEventHistory.redoStack.pop();this._nativeEventHistory.undoStack.push(t);const i=[...this._committedVertices];this._stagedVertex!=null&&i.push(this._coordinateHelper.pointToArray(this._stagedVertex)),this.emit("redo",new c(this.view,t,e.vertices[0].index,i))}})],this._undoRedoHandlesKey)}_removeViewHandles(){this.removeHandles(this._viewHandlesKey)}_removeUndoRedoHandles(){this.removeHandles(this._undoRedoHandlesKey)}_addDrawTool(){this._drawTool=new h({view:this.view,elevationInfo:this.elevationInfo,hasZ:this.hasZ,geometryType:"polyline",mode:this.mode}),this.view.addAndActivateTool(this._drawTool),this.addHandles([this._drawTool.on("vertex-add",e=>{e.vertices.length===1&&this.emit("vertex-add",new c(this.view,null,e.vertices[0].vertexIndex,this._drawTool.getVertexCoords()))}),this._drawTool.on("cursor-update",e=>{e.vertices.length===1&&this.emit("cursor-update",new _(this.view,null,e.vertices[0].vertexIndex,this._drawTool.getVertexCoords()))}),this._drawTool.on("complete",e=>{this.emit("draw-complete",new v(null,this._drawTool.getVertexCoords())),this._removeDrawTool()})],this._drawToolHandlesKey)}_removeDrawTool(){this.removeHandles(this._drawToolHandlesKey),this.view.tools.remove(this._drawTool),this._drawTool=y(this._drawTool)}_addVertex(e,t){const i=this._coordinateHelper.arrayToVector(e);if(this._isDuplicateOfLastVertex(i))return;this._lastVertexUnsnapped=this._stagedVertexUnsnapped,this._popCursorVertex(),this._editGeometryOperations.appendVertex(i);const o=t||new Event("placeholder");this._nativeEventHistory.undoStack.push(o)}_updateCursor(e,t=!1){if(this._popCursorVertex(),!this._cursorScreenPoint)return;const i=this.getCoordsAndPointFromScreenPoint(this._cursorScreenPoint);i==null||t||this._pushCursorVertex(i.vertex,()=>this.emit("cursor-update",new _(this.view,e,this._activeComponent.vertices.length,this.vertices,this._stagedVertex!=null?new x(this._stagedVertex):null)))}_completeDrawing(e){if(this._activePointerId=null,this._popCursorVertex(),this._committedVertices.length<2)return;this._abortSnapping(),this._snappingManager!=null&&this._snappingManager.doneSnapping();const t=new v(e,this.vertices);this.emit("draw-complete",t),t.defaultPrevented||this._removeViewHandles()}};n([r()],m.prototype,"_clickEnabled",null),n([r()],m.prototype,"_dragEnabled",null),n([r({type:k})],m.prototype,"mode",void 0),m=n([u("esri.views.draw.PolylineDrawAction")],m);const W=["freehand","click"];let H=class extends O{constructor(e){super(e),this._isDragging=!1,this._panEnabled=!1,this._addVertexOnPointerUp=!1,this.viewAlignedCoordinateSystem=null,this.mode="freehand"}initialize(){this.view.type==="2d"?this._addViewHandles():this._addDrawTool()}destroy(){this.view.type==="2d"?this._removeViewHandles():this._removeDrawTool(),this.emit("destroy")}complete(){this.view.type==="2d"?this._completeDrawing():this._drawTool.completeCreateOperation()}_getGeometryZValue(){return this.hasZ&&this.vertices.length>0?this.vertices[0][2]:this.defaultZ}_addViewHandles(){this._removeViewHandles(),this.mode==="click"?this.addHandles(this._getClickModeViewHandles(),this._viewHandlesKey):this.addHandles(this._getDragModeViewHandles(),this._viewHandlesKey)}_getDragModeViewHandles(){return[this.view.on("immediate-click",e=>{e.stopPropagation(),e.mapPoint&&!this._panEnabled&&this.getCoordsFromScreenPoint(p(e))!=null&&(this._vertexAddHandler(e),this._drawCompleteHandler(e))},s.TOOL),this.view.on("pointer-down",e=>{this._shouldHandlePointerEvent(e)&&(this._abortSnapping(),this._panEnabled||(this._resetGeometry(),this._addVertexOnPointerUp=!0,this._cursorScreenPoint=p(e),this._activePointerId=e.pointerId,this._vertexAddHandler(e),this._isDragging=!1,e.pointerType==="touch"&&this._updateCursor(e.native)))},s.TOOL),this.view.on("pointer-move",e=>{this._abortSnapping(),this._activePointerId==null&&e.pointerType!=="touch"&&(this._cursorScreenPoint=p(e),this._updateCursor(e.native))},s.TOOL),this.view.on("pointer-drag",e=>{this._shouldHandlePointerEvent(e)&&(this._abortSnapping(),this._isDragging=!0,this._cursorScreenPoint=p(e),this._updateCursor(e.native))},s.TOOL),this.view.on("pointer-up",e=>{this._shouldHandlePointerEvent(e)&&this._addVertexOnPointerUp&&(this._abortSnapping(),this._activePointerId=null,this._isDragging&&this._vertexAddHandler(e),this._committedVertices.length===2&&this._drawCompleteHandler(e),this._isDragging=!1)},s.TOOL),this.view.on("key-down",e=>{e.key===a.complete&&this._cursorScreenPoint?(this._abortSnapping(),this._vertexAddHandler(e),this._drawCompleteHandler(e)):e.key===a.pan&&(this._panEnabled=!0)},s.TOOL),this.view.on("key-up",e=>{e.key===a.pan&&(this._panEnabled=!1)},s.TOOL),this.view.on("drag",e=>{this._activePointerId!=null&&e.stopPropagation()},s.TOOL),this.view.on("drag",["Shift"],e=>{e.stopPropagation()},s.TOOL)]}_getClickModeViewHandles(){return[this.view.on("pointer-down",e=>{this._abortSnapping(),this._cursorScreenPoint=p(e),this._activePointerId=e.pointerId,this._isDragging=!1,e.pointerType==="touch"&&this._updateCursor(e.native)},s.TOOL),this.view.on("pointer-move",e=>{this._abortSnapping(),this._cursorScreenPoint=p(e),this._activePointerId==null&&e.pointerType!=="touch"&&this._updateCursor(e.native)},s.TOOL),this.view.on("pointer-drag",e=>{this._shouldHandlePointerEvent(e)&&(this._abortSnapping(),this._isDragging=!0)},s.TOOL),this.view.on("pointer-up",e=>{this._shouldHandlePointerEvent(e)&&(this._abortSnapping(),this._activePointerId=null,e.stopPropagation(),this._isDragging||this._vertexAddHandler(e),this.vertices.length!==2||this._isDragging||this._drawCompleteHandler(e),this._isDragging=!1)},s.TOOL),this.view.on("key-down",e=>{e.key===a.vertexAdd&&this._cursorScreenPoint&&(this._vertexAddHandler(e),this.vertices.length===2&&this._drawCompleteHandler(e)),e.key===a.complete&&this._cursorScreenPoint&&this.vertices.length===2&&(this._vertexAddHandler(e),this._drawCompleteHandler(e))},s.TOOL)]}_removeViewHandles(){this.removeHandles(this._viewHandlesKey)}_addDrawTool(){this._drawTool=new h({view:this.view,elevationInfo:this.elevationInfo,hasZ:this.hasZ,geometryType:"segment",mode:this.mode}),this.view.addAndActivateTool(this._drawTool),this.addHandles([this._drawTool.on("vertex-add",e=>{e.vertices.length===1&&this.emit("vertex-add",new c(this.view,null,e.vertices[0].vertexIndex,this._drawTool.getVertexCoords()))}),this._drawTool.on("cursor-update",e=>{e.vertices.length===1&&this.emit("cursor-update",new _(this.view,null,e.vertices[0].vertexIndex,this._drawTool.getVertexCoords()))}),this._drawTool.on("complete",e=>{this.emit("draw-complete",new v(null,this._drawTool.getVertexCoords())),this._removeDrawTool()})],this._drawToolHandlesKey)}_removeDrawTool(){this.removeHandles(this._drawToolHandlesKey),this.view.tools.remove(this._drawTool),this._drawTool=y(this._drawTool)}_addVertex(e,t){const i=this._coordinateHelper.arrayToVector(e);if(this._isDuplicateOfLastVertex(i))return;this._lastVertexUnsnapped=this._stagedVertexUnsnapped,this._popCursorVertex(),this._editGeometryOperations.appendVertex(i),this._committedVertices.length===1&&(this.viewAlignedCoordinateSystem=j(this.view,this._committedVertices[0]));const o=this._committedVertices.length-1,d=new c(this.view,t,o,this.vertices);this.emit("vertex-add",d)}_updateCursor(e){if(this._popCursorVertex(),!this._cursorScreenPoint)return;const t=this.getCoordsAndPointFromScreenPoint(this._cursorScreenPoint);t!=null&&this._pushCursorVertex(t.vertex,()=>this.emit("cursor-update",new _(this.view,e,this._activeComponent.vertices.length,this.vertices,this._stagedVertex!=null?new x(this._stagedVertex):null)))}_completeDrawing(e){if(this._activePointerId=null,this._popCursorVertex(),this._cursorScreenPoint=null,this._isDragging=!1,this._abortSnapping(),this._snappingManager!=null&&this._snappingManager.doneSnapping(),this.vertices.length<1)return;const t=new v(e,this.vertices);this.emit("draw-complete",t),t.defaultPrevented||this._removeViewHandles()}_resetGeometry(){this._editGeometryOperations.destroy(),this._editGeometryOperations=new A(new E("polygon",this._coordinateHelper)),this._activeComponent=new D(this._coordinateHelper.spatialReference,b.Local),this._editGeometryOperations.data.components.push(this._activeComponent)}};n([r({type:W})],H.prototype,"mode",void 0),H=n([u("esri/views/2d/engine/markup/SegmentDrawAction")],H);let g=class extends M{constructor(){super(...arguments),this.activeAction=null,this.type="draw",this.view=null}destroy(){this.activeAction&&(this.activeAction.destroy(),this.activeAction=null)}create(e,t){this.reset();const i={view:this.view,...t};switch(e){case"point":i.editGeometryType="point",this.activeAction=new T(i);break;case"polyline":i.editGeometryType="polyline",this.activeAction=new m(i);break;case"multipoint":i.editGeometryType="polygon",this.activeAction=new V(i);break;case"polygon":i.editGeometryType="polygon",this.activeAction=new w(i);break;case"rectangle":case"circle":case"ellipse":case"triangle":i.editGeometryType="polygon",this.activeAction=new H(i)}return this.activeAction}complete(){this.activeAction&&this.activeAction.complete(),this.activeAction=null}reset(){this.activeAction&&this.activeAction.destroy(),this.activeAction=null}};n([r()],g.prototype,"activeAction",void 0),n([r({readOnly:!0})],g.prototype,"type",void 0),n([r()],g.prototype,"view",void 0),g=n([u("esri.views.draw.Draw")],g);const ue=g;export{ue as l};
