import{h3 as m,i2 as p,b9 as g,an as _,eH as f,a5 as o,a6 as l,a9 as b}from"./index-b516d057.js";import{s as F}from"./ReactiveSet-7afb73d5.js";import{x as v}from"./WhereClause-41137be1.js";import{d as I}from"./FeatureFilter-55dd341e.js";import{o as w}from"./floorFilterUtils-080a7cd2.js";import{b as a}from"./Query-071039d7.js";import{E,c as O,a as S}from"./I3SMeshView3D-c4f22244.js";import{n as x}from"./LayerView3D-c03d44fc.js";import{j as H,c as j,i as C,u as Q,d as q,f as V,a as D}from"./SceneLayerView-5ec175b3.js";import{L as u,d as $,l as A,o as R}from"./I3SQueryFeatureStore-daac455a.js";import{t as h}from"./I3SNode-81f8301c.js";import{S as G}from"./I3SOverrides-a9f31f33.js";import{h as P,u as L,Z as d}from"./I3SUtil-1c5e04a1.js";import{t as U}from"./DefinitionExpressionSceneLayerView-8a0da2cd.js";import{i as M}from"./PopupSceneLayerView-3bc58223.js";import{W as N}from"./SceneView-123ac862.js";import{u as T}from"./popupUtils-e4ebc84a.js";import{I as z}from"./Scheduler-ff5943a4.js";import"./TimeOnly-879c5107.js";import"./UnknownTimeZone-a05df022.js";import"./FullTextSearch-12e0754c.js";import"./QuantizationParameters-f983cf8d.js";import"./UpdatingHandles-7949a657.js";import"./projectVectorToVector-56c29b20.js";import"./DefaultTechniqueConfiguration-b4dbe32f.js";import"./requestImageUtils-b142708c.js";import"./enums-bdecffa2.js";import"./Texture-bcb6d63f.js";import"./contextUtils-81fda295.js";import"./interfaces-8918b36f.js";import"./Material-5f4156ac.js";import"./ViewingMode-5d7d590b.js";import"./FramebufferObject-123b7c8d.js";import"./ShaderTechniqueConfiguration-2502462e.js";import"./LayerConstants-d3ac1b7a.js";import"./SceneModification-073489fb.js";import"./persistable-a11ce298.js";import"./MD5-715f37cd.js";import"./multiOriginJSONSupportUtils-c978f4c3.js";import"./uuid-709b6c67.js";import"./resourceExtension-63924db9.js";import"./basemapUtils-6ec10a55.js";import"./Basemap-8d62c69e.js";import"./loadAll-5e767cfa.js";import"./writeUtils-e226a8aa.js";import"./dehydratedPoint-5a1dfed5.js";import"./Graphics3DObjectStates-511adea3.js";import"./jsonUtils-52514725.js";import"./DictionaryLoader-e327eff9.js";import"./Version-1f969b2a.js";import"./FieldsIndex-e8db657f.js";import"./HeatmapColorStop-3fff4333.js";import"./heatmapUtils-7f42325f.js";import"./dehydratedFeatures-2a3f0608.js";import"./quantizationUtils-17105106.js";import"./hydratedFeatures-2365c307.js";import"./rendererConversion-b2429202.js";import"./defaults-4faa92e6.js";import"./defaultsJSON-59981e75.js";import"./ElevationQuery-a3eaf0a0.js";import"./RenderGeometry-5dbc1699.js";import"./vec3f32-bac7ea57.js";import"./ElevationProvider-abb53936.js";import"./weather-2eb64924.js";import"./RenderState-1d6218ee.js";import"./NestedMap-1b5db22e.js";import"./frustum-f9d53cdf.js";import"./VertexElementDescriptor-2925c6af.js";import"./VertexArrayObject-d19dab8d.js";import"./Octree-7cea9440.js";import"./InterleavedLayout-d76b0d59.js";import"./types-1305598a.js";import"./OrderIndependentTransparency-755f7dcc.js";import"./floatRGBA-ca990bbb.js";import"./Intersector-2e1d9db3.js";import"./Intersector-fa865806.js";import"./boundedPlane-1da2f094.js";import"./verticalOffsetUtils-e5214af9.js";import"./orientedBoundingBox-67c5cd22.js";import"./glUtil-ce5ee52b.js";import"./vec2f32-eaf29605.js";import"./ColorMaterial-bdf1f62a.js";import"./VerticalOffset.glsl-5743f98e.js";import"./featureConversionUtils-09cf00ff.js";import"./OptimizedFeature-e90b69df.js";import"./OptimizedFeatureSet-1d1ac4b9.js";import"./OptimizedGeometry-196224d4.js";import"./edgeUtils-6e4a97fb.js";import"./SnappingCandidate-970faec6.js";import"./objectResourceUtils-003803db.js";import"./devEnvironmentUtils-4eab2a99.js";import"./DefaultMaterial_COLOR_GAMMA-101ea40c.js";import"./resourceUtils-1d03d2fe.js";import"./mat3f32-6c416b1c.js";import"./symbolColorUtils-3ca646c8.js";import"./callExpressionWithFeature-36423058.js";import"./lineStippleUtils-0688e06c.js";import"./projectVectorToDehydratedPoint-e30a7ff8.js";import"./interfaces-1a80c8eb.js";import"./webStyleSymbolUtils-4761c8f2.js";import"./Intersector-a291e778.js";import"./fontUtils-56b88a2f.js";import"./optimizedFeatureQueryEngineAdapter-1fecea41.js";import"./PooledRBush-fa11eac4.js";import"./quickselect-bc0541de.js";import"./screenUtils-8dc4a7f9.js";import"./signal-51ed66f5.js";import"./layerViewUtils-6ebe90f4.js";import"./WorkerHandle-9433ab9a.js";import"./SceneLayerWorker-b7dd55be.js";import"./intersectorUtilsConversions-d05d75a3.js";import"./FeatureLikeLayerView3D-88097627.js";import"./geometryServiceUtils-3e048225.js";import"./project-1bd91657.js";import"./dehydratedFeatureComparison-7855b188.js";import"./terrainUtils-b6b761ab.js";import"./queryForSymbologySnapping-caae9522.js";import"./projectPointToVectorWithEngine-f608a34a.js";import"./elevationInfoUtils-be36d866.js";import"./hash-6f442295.js";import"./QueryEngine-ee1ccbba.js";import"./projectionSupport-dcf335fc.js";import"./json-48e3ea08.js";import"./QueryEngineCapabilities-85c4f1d0.js";import"./utils-f54bcc46.js";import"./utils-1a995f8e.js";import"./scaleUtils-72744379.js";import"./FeatureStore-02a891a3.js";import"./BoundsStore-230a1891.js";import"./heatmapTextureUtils-6877589a.js";import"./projectExtentUtils-15e84132.js";import"./heightModelInfoUtils-0dd2b6e4.js";import"./HeightModelInfo-b816d32b.js";import"./featureQueryAll-40af0622.js";import"./LayerView-060b46d4.js";import"./I3SBinaryReader-e72af7de.js";import"./meshFeatureSet-8aa95dd7.js";import"./FeatureLayerView3D-08fb50ad.js";import"./FeatureLayerViewBase3D-6a7790b6.js";import"./query-351887b5.js";import"./pbfQueryUtils-b37a842c.js";import"./pbf-2651fe50.js";import"./queryZScale-d7a48772.js";import"./EventedSet-680e6831.js";import"./FeatureLayerView-7680760d.js";import"./FeatureEffect-c80bb16d.js";import"./RefreshableLayerView-4a86a8ac.js";import"./Viewpoint-f83262d0.js";import"./Cyclical-4c223a04.js";import"./jsxFactory-92036771.js";import"./debugFlags-9a30f077.js";import"./coordinateSystem-38339d17.js";import"./DefaultUI-af7068c2.js";import"./Map-1ad4186f.js";import"./Ground-ed93a93a.js";import"./CollectionFlattener-193451da.js";import"./editableLayers-856f2cb4.js";import"./TablesMixin-292d1d89.js";import"./IViewEvents-9a85f53d.js";import"./interfaces-0421c5e6.js";import"./mat2d-d4af8487.js";import"./mat2df32-fb26a8c9.js";import"./mat2df64-4d1a9198.js";import"./capabilities-9d56a1da.js";import"./themeUtils-7dcf5b71.js";import"./globalCss-94006b67.js";import"./accessibleHandler-e91101b2.js";import"./Compass-b37d7d1d.js";import"./GoTo-4d856ce0.js";import"./NavigationToggle-57c00adb.js";import"./Zoom-73b5f25a.js";import"./resources-d4afed0c.js";import"./viewpointUtils-245ed782.js";import"./projectVectorToPoint-fbaf5599.js";import"./earthUtils-ef4b5643.js";import"./spatialReferenceSupport-5aeb751c.js";import"./ElevationSamplerData-9f34f589.js";import"./Environment-91bfea7d.js";import"./projectPointToWGS84ComparableLonLat-1ba40d40.js";import"./projectVectorToWGS84ComparableLonLat-5675a9f4.js";import"./ShadowCastVisualizeTechniqueConfiguration-4fcc4e25.js";import"./ray-8da55042.js";import"./ZoomMomentumEstimator-7437d26a.js";import"./labelFormatUtils-d440367f.js";import"./labelUtils-b29175f3.js";import"./FeatureTileDescriptor3D-27dbeac7.js";import"./RenderCoordsHelper-8f237859.js";import"./LercDecoder-b49c0e9c.js";import"./RenderableTile-52f61d09.js";import"./enums-fb086c25.js";import"./config-1337d16e.js";import"./TiledDisplayObject-e7d105ae.js";import"./DisplayObject-9a6e3923.js";import"./TileKey-4b1303ff.js";import"./rasterUtils-15abcc11.js";import"./TileInfoView-ce4d65fb.js";import"./TileStrategy-a729431f.js";import"./QueueProcessor-4b9d43d3.js";import"./StyleDefinition-29c49b98.js";import"./enums-f1a6a48a.js";import"./edgeProcessing-82213448.js";import"./resources-15104e7a.js";import"./EdgeWorkerHandle-7d97defa.js";import"./workerHelper-d1cc0cda.js";import"./testSVGPremultipliedAlpha-f5e92e14.js";import"./DefaultVertexAttributeLayouts-8962d8eb.js";import"./RenderingContext-c0ea7a49.js";import"./ProgramCache-891c4b8d.js";import"./Program-96bc94ed.js";import"./hitTestSelectUtils-d512707e.js";const c=D();let s=class extends E(U(M(x(H)))){constructor(){super(...arguments),this.type="scene-layer-3d",this._setVisibilityHiddenObjectIds=new F,this.progressiveLoadFactor=1,this._elevationContext="scene",this._isIntegratedMesh=!1,this._supportsLabeling=!0,this._pendingEditsQueue=Promise.resolve(),this._interactiveEditingSessions=new Map,this._queryEngine=null}get i3slayer(){return this.layer}tryRecycleWith(t,e){return t.url===this.layer.url&&this.i3sOverrides.isEmpty?t.load(e).then(()=>{var r;P(this.layer,t,this.i3sOverrides),this.layer=t,this.i3sOverrides.destroy();const i=(r=this.view.resourceController)==null?void 0:r.memoryController;this.i3sOverrides=new G({view:this.view,layer:t,memoryController:i}),this.resetHighlights()}):null}get layerPopupEnabledAndHasTemplate(){var t;return this.layer.popupEnabled&&T(this.layer,(t=this.view.popup)==null?void 0:t.defaultPopupTemplateEnabled)}get filter(){return this._get("filter")}set filter(t){this._set("filter",u.checkSupport(t)?t:null)}get viewFilter(){const t=this.filter,e=this.layerFilter;if(t==null&&e==null)return null;const i=this._get("viewFilter");return i==null?new u({layerFilter:e,viewFilter:t,layerFieldsIndex:this.layer.fieldsIndex,loadAsyncModule:r=>this._loadAsyncModule(r),addSqlFilter:(r,n)=>this.addSqlFilter(r,n,this.logError)}):(i.viewFilter=t,i.layerFilter=e,i)}get requiredFields(){var t;return((t=this._fieldsHelper)==null?void 0:t.requiredFields)??[]}get _floorFilterClause(){const t=w(this);return t!=null?v.create(t,this.layer.fieldsIndex):null}get _excludeObjectIdsSorted(){const t=this.layer.excludeObjectIds.toArray();return t.length?t.sort((e,i)=>e-i):null}get _setVisibilityHiddenObjectIdsSorted(){return this._setVisibilityHiddenObjectIds.size?Array.from(this._setVisibilityHiddenObjectIds).sort((t,e)=>t-e):null}get _objectQualitySettings(){var t,e,i;return(i=(e=(t=this.view)==null?void 0:t.qualitySettings)==null?void 0:e.sceneService)==null?void 0:i.object}get lodFactor(){var t;return((t=this._objectQualitySettings)==null?void 0:t.lodFactor)??1}get lodCrossfadeinDuration(){return this._objectQualitySettings.lodCrossfadeinDuration??0}get lodCrossfadeoutDuration(){return this._objectQualitySettings.lodCrossfadeoutDuration??0}get lodCrossfadeUncoveredDuration(){return this._objectQualitySettings.lodCrossfadeUncoveredDuration??0}get updatingProgressValue(){var t;return((t=this._controller)==null?void 0:t.updatingProgress)??0}initialize(){this._fieldsHelper=new j({layerView:this}),this._updatingHandles.add(()=>this.layer.rangeInfos,e=>this._rangeInfosChanged(e),m),this._updatingHandles.add(()=>this.layer.renderer,e=>this._updatingHandles.addPromise(this._rendererChange(e)),m);const t=()=>this._filterChange();this._updatingHandles.add(()=>this.parsedDefinitionExpression,t),this._updatingHandles.add(()=>this.filter,t),this._updatingHandles.add(()=>this._floorFilterClause,t),this._updatingHandles.add(()=>this._excludeObjectIdsSorted,t),this._updatingHandles.add(()=>this._setVisibilityHiddenObjectIdsSorted,t),this._updatingHandles.add(()=>this.viewFilter!=null?this.viewFilter.sortedObjectIds:null,t),this._updatingHandles.add(()=>this.viewFilter!=null?this.viewFilter.parsedWhereClause:null,t),this._updatingHandles.add(()=>[this.viewFilter!=null?this.viewFilter.parsedGeometry:null,this.filter!=null?this.filter.spatialRelationship:null,this.layer.filter!=null?this.layer.filter.spatialRelationship:null],()=>this._geometryFilterChange()),p()&&this.i3sOverrides.is3DOFL&&this._updatingHandles.add(()=>this.i3sOverrides.sortedGeometryChangedObjectIds,t),this.addHandles(this.layer.on("apply-edits",e=>this._updatingHandles.addPromise(e.result))),this.addHandles(this.layer.on("edits",e=>{const i=this._pendingEditsQueue.then(()=>this._handleEdits(e)).then();this._pendingEditsQueue=i,this._updatingHandles.addPromise(i)}))}destroy(){this._fieldsHelper=g(this._fieldsHelper)}_rangeInfosChanged(t){t!=null&&t.length>0&&_.getLogger(this).warn("Unsupported property: rangeInfos are currently only serialized to and from web scenes but do not affect rendering.")}createQuery(){const t={outFields:["*"],returnGeometry:!1,outSpatialReference:this.view.spatialReference};return this.filter!=null?this.filter.createQuery(t):new a(t)}queryExtent(t,e){return this._ensureQueryEngine().executeQueryForExtent(this._ensureQuery(t),e==null?void 0:e.signal)}queryFeatureCount(t,e){return this._ensureQueryEngine().executeQueryForCount(this._ensureQuery(t),e==null?void 0:e.signal)}queryFeatures(t,e){return this._ensureQueryEngine().executeQuery(this._ensureQuery(t),e==null?void 0:e.signal).then(i=>{if(!(i!=null&&i.features))return i;const r=this.layer;for(const n of i.features)n.layer=r,n.sourceLayer=r;return i})}queryObjectIds(t,e){return this._ensureQueryEngine().executeQueryForIds(this._ensureQuery(t),e==null?void 0:e.signal)}_ensureQueryEngine(){return this._queryEngine||(this._queryEngine=this._createQueryEngine()),this._queryEngine}_createQueryEngine(){const t=O(this.view.spatialReference,this.view.renderSpatialReference,this._collection);return new $({layerView:this,priority:z.FEATURE_QUERY_ENGINE,spatialIndex:new A({featureAdapter:new R({objectIdField:this.layer.objectIdField,attributeStorageInfo:this.layer.attributeStorageInfo??[],getFeatureExtent:t}),forAllFeatures:(e,i)=>this._forAllFeatures((r,n,y)=>e({id:r,index:n,meta:y}),i,S.QUERYABLE),getFeatureExtent:t,sourceSpatialReference:L(this.layer),viewSpatialReference:this.view.spatialReference})})}highlight(t){const e=this._highlights;if(t instanceof a){const{set:i,handle:r}=e.acquireSet();return this.queryObjectIds(t).then(n=>e.setFeatureIds(i,n)),r}return super.highlight(t)}createInteractiveEditSession(t){return C(this._attributeEditingContext,t)}_createLayerGraphic(t){const e=new f(null,null,t);return e.layer=this.layer,e.sourceLayer=this.layer,e}getFilters(){const t=super.getFilters();p()&&this.i3sOverrides.is3DOFL&&this.i3sOverrides.sortedGeometryChangedObjectIds.length>0&&t.push((r,n)=>{n.node.index>=0&&d(this.i3sOverrides.sortedGeometryChangedObjectIds,!1,r)});const e=this._setVisibilityHiddenObjectIdsSorted;e!=null&&t.push(r=>d(e,!1,r));const i=this._excludeObjectIdsSorted;return i!=null&&t.push(r=>d(i,!1,r)),this._floorFilterClause&&this.addSqlFilter(t,this._floorFilterClause,this.logError),this.addSqlFilter(t,this.parsedDefinitionExpression,this.logError),this.viewFilter!=null&&this.viewFilter.addFilters(t,this.view,this._controller.crsIndex,this._collection),t}setVisibility(t,e){e?this._setVisibilityHiddenObjectIds.delete(t):this._setVisibilityHiddenObjectIds.add(t)}isUpdating(){return super.isUpdating()||this.layerFilterUpdating||this.viewFilter!=null&&this.viewFilter.updating||this.i3sOverrides!=null&&this.i3sOverrides.updating}_ensureQuery(t){return this._addDefinitionExpressionToQuery(t==null?this.createQuery():a.from(t))}get _attributeEditingContext(){return{sessions:this._interactiveEditingSessions,fieldsIndex:this.layer.fieldsIndex,objectIdField:this._getObjectIdField(),globalIdField:this._getGlobalIdField(),forEachNode:t=>this._forAllNodes(e=>e!=null?t(e.node,e.featureIds):null),attributeStorageInfo:this.i3slayer.attributeStorageInfo??[],i3sOverrides:this.i3sOverrides,getAttributeData:t=>this.getAttributeData(t),setAttributeData:(t,e)=>this.setAttributeData(t,e),clearMemCache:()=>this.clearMemCache()}}async _handleEdits(t){const e=p(),i=this._attributeEditingContext,r=await Q(i,t);e&&q(i,r),V(i,r)}get hasGeometryFilter(){const t=this.viewFilter;return(t==null?void 0:t.parsedGeometry)!=null}computeNodeFiltering(t){const e=this.viewFilter;return e==null||!this.view.spatialReference||e.isMBSGeometryVisible(t,this.view.spatialReference,this._controller.crsIndex)?h.Unmodified:h.Culled}};o([l()],s.prototype,"i3slayer",null),o([l(N)],s.prototype,"updatingProgress",void 0),o([l({type:I})],s.prototype,"filter",null),o([l({readOnly:!0})],s.prototype,"viewFilter",null),o([l(c.requiredFields)],s.prototype,"requiredFields",null),o([l(c.availableFields)],s.prototype,"availableFields",void 0),o([l()],s.prototype,"_fieldsHelper",void 0),o([l()],s.prototype,"_floorFilterClause",null),o([l()],s.prototype,"_excludeObjectIdsSorted",null),o([l()],s.prototype,"_setVisibilityHiddenObjectIds",void 0),o([l()],s.prototype,"_setVisibilityHiddenObjectIdsSorted",null),o([l()],s.prototype,"_objectQualitySettings",null),o([l()],s.prototype,"lodFactor",null),o([l()],s.prototype,"updatingProgressValue",null),s=o([b("esri.views.3d.layers.SceneLayerView3D")],s);const Lr=s;export{Lr as default};
