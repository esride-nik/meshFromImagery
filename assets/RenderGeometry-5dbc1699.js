import{gH as f,su as Ro,aW as F,fa as nr,mq as Pr,t6 as Ki,ni as es,sv as ts,mg as Ze,b0 as Ht,fv as oe,d1 as ne,fk as le,d8 as J,fx as B,db as lr,a5 as m,a6 as E,a9 as fr,bA as ua,fX as bo,gJ as cr,lf as pa,a$ as ze,fB as dt,t7 as rs,q0 as is,gD as oi,gE as wr,fK as Xe,t8 as Oo,t9 as Do,fo as rr,f9 as Qr,fp as fa,fZ as Ni,fn as Ft,ta as Ao,tb as ss,jo as as,fe as Zt,rc as os,jA as Eo,fl as $o,gy as Mo,j0 as er,hW as ot,f6 as ee,fC as Ue,fc as Po,an as Yr,tc as ma,gS as lt,mB as Io,gi as Y,gP as j,lg as ga,gO as Te,c9 as me,kE as Lo,pW as Fo,lh as Qt,fq as Se,d2 as he,e_ as mr,gA as No,f8 as jo,d0 as zo,td as Uo,te as Vo,tf as Wo,gz as Ho,bj as ir,mk as dr,kI as Go,li as va,ez as Bo,no as ko,nq as qo,np as Zo,p7 as Jo,oL as Qo,ld as Yo,lb as Xo,lc as Ko,cF as Ei,jf as en,dB as tn,y as rn,dv as sn,tg as an,mA as _a,q6 as on,oW as ns,hY as ls,th as cs,ti as ds,da as nn,tj as ya,d9 as wa,t0 as ln,tk as hs,fV as cn,a3 as Ur,k as ht,tl as Vr,kC as Nt,kD as jt,g3 as Gt,bg as xa,bu as Ae,iN as dn,b9 as Ca,cA as ji,n3 as hn,_ as Xr,f0 as Sa,tm as un,i5 as xr,j3 as Pe,fr as us,fm as pn,gF as ni,tn as fn,aR as mn,oA as ps,gG as gn,to as vn,fd as _n,jM as Wr,gp as tt,gr as Mt,le as Yt,kc as fs,gg as Pt,gn as de,lS as yn,gR as ms,tp as xt,tq as Cr,fJ as wn,mj as xn,tr as Cn,nd as Sn,ac as gs,lO as It,qi as Tn,ts as Rn,tt as bn,cb as li,dr as vs,cd as On,h$ as ci,tu as Dn,gM as An,tv as En}from"./index-b516d057.js";import{r as te,n as q,t as _s}from"./vec3f32-bac7ea57.js";import{ad as zi,ae as Ta,I as Jt,x as zt,e as Q,W as di,at as Ui,au as Vi,F as Ra,s as Ve,H as Kr,A as Z,aF as hi,aG as $n,t as Ee,aH as ys,f as O,an as hr,aD as Mn,aI as Pn,ap as qe,o as ei,J as ba,z as ut,n as Wi,aJ as ws,X as In,T as Ln,y as Oa,V as Hi,N as Fn,as as Nn,a5 as jn,Y as Da,d as Aa,a6 as zn,S as Un,c as Ea,P as Lt,h as $a,C as Je,i as ti,r as ri,j as ii,k as xs,l as Cs,m as Vn,aK as Ss,aL as Wn,aM as Hn,aN as Gn,aO as Bn,w as Ma,a7 as kn,aP as qn,aQ as Zn,aE as Jn,b as Qn,az as Yn,U as Xn,av as Kn,ar as el,aB as tl,p as rl,aR as il,K as sl,ac as al,v as ol,aS as nl,a as Ts}from"./DefaultTechniqueConfiguration-b4dbe32f.js";import{t as ll,b as cl,a as Sr}from"./ElevationProvider-abb53936.js";import{e as Gi}from"./dehydratedPoint-5a1dfed5.js";import{o as dl,x as hl,u as ul}from"./hydratedFeatures-2365c307.js";import{l as si}from"./ViewingMode-5d7d590b.js";import{o as g,n as Pa}from"./interfaces-8918b36f.js";import{p as Ct,i as pl}from"./weather-2eb64924.js";import{I as fl}from"./RenderState-1d6218ee.js";import{t as Bi}from"./NestedMap-1b5db22e.js";import{t as Ia,r as D}from"./ShaderTechniqueConfiguration-2502462e.js";import{I as ml,u as gl,L as vl,l as Tr}from"./frustum-f9d53cdf.js";import{E as gr,c as La,d as pt,h as _l,e as yl,u as wl}from"./Material-5f4156ac.js";import{C as $e,F as ki,L as qi,G as Fa,D as Hr,E as Rs,M as xl,_ as Gr,R as Ut}from"./enums-bdecffa2.js";import{t as Me}from"./VertexElementDescriptor-2925c6af.js";import{f as Cl}from"./VertexArrayObject-d19dab8d.js";import{h as Zi}from"./FramebufferObject-123b7c8d.js";import{e as vr,T as mt}from"./Texture-bcb6d63f.js";import{W as Sl}from"./Octree-7cea9440.js";import{H as _t}from"./InterleavedLayout-d76b0d59.js";import{o as ye,S as Qe,d as Ir,A as Na,l as ja,a as za,E as Ua,_ as ft,e as Tl,b as Rl,c as bl,f as Ol,s as Dl}from"./OrderIndependentTransparency-755f7dcc.js";import{o as Va}from"./floatRGBA-ca990bbb.js";import{i as Al}from"./Intersector-2e1d9db3.js";import{t as bs,M as El,i as $l}from"./Intersector-fa865806.js";import{r as Ml}from"./glUtil-ce5ee52b.js";import{I as Pl,C as Il}from"./Scheduler-ff5943a4.js";function Ll(t){t.fragment.code.add(g`const float GAMMA = 2.2;
const float INV_GAMMA = 0.4545454545;
vec4 delinearizeGamma(vec4 color) {
return vec4(pow(color.rgb, vec3(INV_GAMMA)), color.w);
}
vec3 linearizeGamma(vec3 color) {
return pow(color, vec3(GAMMA));
}`)}new Me(f.POSITION,3,$e.FLOAT,0,12);new Me(f.POSITION,3,$e.FLOAT,0,20),new Me(f.UV0,2,$e.FLOAT,12,20);new Me(f.POSITION,3,$e.FLOAT,0,32),new Me(f.NORMAL,3,$e.FLOAT,12,32),new Me(f.UV0,2,$e.FLOAT,24,32);new Me(f.POSITION,3,$e.FLOAT,0,16),new Me(f.COLOR,4,$e.UNSIGNED_BYTE,12,16);const Wa=[new Me(f.POSITION,2,$e.FLOAT,0,8)],Fl=[new Me(f.POSITION,2,$e.FLOAT,0,16),new Me(f.UV0,2,$e.FLOAT,8,16)];let Ji=class extends Cl{};function Bh(t,e=Wa,r=gr,i=-1,s=1){let a=null;return e===Fl?a=new Float32Array([i,i,0,0,s,i,1,0,i,s,0,1,s,s,1,1]):a=new Float32Array([i,i,s,i,i,s,s,s]),new Ji(t,r,{geometry:e},{geometry:Zi.createVertex(t,ki.STATIC_DRAW,a)})}function kh(t,e=Wa,r=gr){const i=new Float32Array([-1,-1,3,-1,-1,3]);return new Ji(t,r,{geometry:e},{geometry:Zi.createVertex(t,ki.STATIC_DRAW,i)})}const Nl=4;function qh(t){const e=new vr(Nl);return e.samplingMode=qi.NEAREST,new mt(t,e)}function jl(t){const e=new vr(1);return e.samplingMode=qi.NEAREST,new mt(t,e,new Uint8Array([255,255,255,255]))}var ct,Br;function Zh(t){return(t==null?void 0:t.cubeMap)!=null}function zl(t){return t!=null&&!t.running}(function(t){t[t.RENDERING=0]="RENDERING",t[t.FADING=1]="FADING",t[t.FINISHED=2]="FINISHED"})(ct||(ct={})),function(t){t[t.RG=0]="RG",t[t.BA=1]="BA"}(Br||(Br={}));let Ul=class{constructor(){this.readChannels=Br.RG,this.renderingStage=ct.FINISHED,this.startTime=0,this.startTimeHeightFade=0,this.cameraPositionLastFrame=F(),this.parallax=new Os,this.parallaxNew=new Os,this.pointOnGround=F(),this.fadeMode=G.HIDE,this.fadeFactor=0,this.opacity=0}updateParallax(e){const r=this.parallax,i=nr(e.eye);if(r.radiusCurvatureCorrectionFactor=.84*Math.sqrt(Math.max(i*i-Pr.radius*Pr.radius,0))/i,Ki(Ds,r.anchorPointClouds,St),es(r.transform,Ze,St[3],ts(St)),this.fadeMode===G.CROSS_FADE){const s=this.parallaxNew;Ki(Ds,s.anchorPointClouds,St),es(s.transform,Ze,St[3],ts(St))}}updateFading(e,r,i,s){this.isFading&&this._advanceFading(i,s),this._evaluateFading(e,r,i)}_evaluateFading(e,r,i){const s=e.relativeElevation,a=this._calculateDistanceToAnchorPoint(e);if((s>1.7*Ct||s<-Ct||a>Bl)&&this.opacity>0)this._setFade(G.HIDE,i);else if(!this.isFading){if((s>Ct||s<-.35*Ct||a>Gl)&&this.opacity>0)this._setFade(G.FADE_OUT,i);else if(s<=Ct&&s>=-.35*Ct&&r===fl.IDLE&&zl(this.data)){if(this.opacity===0)return void this._setFade(G.FADE_IN,i);(a>Hl||this.renderingStage===ct.FADING)&&this._setFade(G.CROSS_FADE,i)}}}_advanceFading(e,r){this._switchReadChannels(),this._updateAnchorPoint(),this._advanceFadingFactorAndOpacity(e,r)}_advanceFadingFactorAndOpacity(e,r){if(this.fadeFactor<1)return this.fadeFactor=r?Ht((e-this.startTime)/(Wl*r),0,1):1,this.fadeMode===G.FADE_OUT&&(this.opacity=1-this.fadeFactor),this.fadeMode===G.FADE_IN&&(this.opacity=this.fadeFactor),void(this.fadeMode===G.CROSS_FADE&&(this.opacity=1));this.fadeFactor=0,this.fadeMode===G.FADE_OUT&&(this.opacity=0),this.fadeMode===G.FADE_IN&&(this.opacity=1),this.fadeMode===G.CROSS_FADE&&(this.opacity=1),this.fadeMode=G.NONE}_switchReadChannels(){const e=this.fadeMode===G.CROSS_FADE&&this.fadeFactor===1,r=this.fadeMode===G.FADE_IN&&this.fadeFactor===0;this.renderingStage===ct.FADING&&(e||r)&&(this.readChannels=1-this.readChannels,this.renderingStage=ct.FINISHED)}_calculateDistanceToAnchorPoint(e){return oe(this.pointOnGround,e.eye),ne(this.pointOnGround,this.pointOnGround,Pr.radius),nr(le(Vl,this.parallax.anchorPointClouds,this.pointOnGround))}_updateAnchorPoint(){this.fadeMode===G.CROSS_FADE&&(this.fadeFactor===0&&J(this.parallaxNew.anchorPointClouds,this.pointOnGround),this.fadeFactor===1&&J(this.parallax.anchorPointClouds,this.parallaxNew.anchorPointClouds)),this.fadeMode===G.FADE_IN&&this.fadeFactor===0&&J(this.parallax.anchorPointClouds,this.pointOnGround)}_setFade(e,r){switch(e){case G.HIDE:this.opacity=0;break;case G.FADE_OUT:this.opacity=1;break;case G.FADE_IN:this.opacity=0;break;case G.CROSS_FADE:this.opacity=1}this.fadeMode=e,this.fadeFactor=0,this.startTime=r}get isFading(){return this.fadeMode===G.FADE_OUT||this.fadeMode===G.FADE_IN||this.fadeMode===G.CROSS_FADE}};var G;(function(t){t[t.NONE=0]="NONE",t[t.HIDE=1]="HIDE",t[t.FADE_OUT=2]="FADE_OUT",t[t.FADE_IN=3]="FADE_IN",t[t.CROSS_FADE=4]="CROSS_FADE"})(G||(G={}));let Os=class{constructor(){this.anchorPointClouds=F(),this.radiusCurvatureCorrectionFactor=0,this.transform=B()}};const Ds=lr(0,0,1),St=Ro(),Vl=F(),Wl=1.25,Hl=34e3,Gl=64e3,Bl=2e5;let kl=class extends zi{constructor(e,r){super(e,"samplerCube",Ta.Pass,(i,s,a)=>i.bindTexture(e,r(s,a)))}};function ql(t){const e=t.fragment;e.uniforms.add(new Jt("rotationMatrixClouds",(r,i)=>i.cloudsFade.parallax.transform),new Jt("rotationMatrixCloudsCrossFade",(r,i)=>i.cloudsFade.parallaxNew.transform),new zt("anchorPosition",(r,i)=>i.cloudsFade.parallax.anchorPointClouds),new zt("anchorPositionCrossFade",(r,i)=>i.cloudsFade.parallaxNew.anchorPointClouds),new Q("cloudsHeight",()=>pl),new Q("radiusCurvatureCorrectionFactor",(r,i)=>i.cloudsFade.parallax.radiusCurvatureCorrectionFactor),new Q("totalFadeInOut",(r,i)=>1-i.cloudsFade.opacity),new Q("crossFadeAnchorFactor",(r,i)=>Ht(i.cloudsFade.fadeFactor,0,1)),new kl("cubeMap",(r,i)=>{var s,a;return((a=(s=i.cloudsFade.data)==null?void 0:s.cubeMap)==null?void 0:a.colorTexture)??null}),new di("crossFade",(r,i)=>i.cloudsFade.fadeMode===G.CROSS_FADE),new di("readChannelsRG",(r,i)=>i.cloudsFade.readChannels===Br.RG),new di("fadeTextureChannels",(r,i)=>i.cloudsFade.renderingStage===ct.FADING)),e.constants.add("planetRadius","float",Pr.radius),e.code.add(g`vec3 intersectWithCloudLayer(vec3 dir, vec3 cameraPosition, vec3 spherePos)
{
float radiusClouds = planetRadius + cloudsHeight;
float B = 2.0 * dot(cameraPosition, dir);
float C = dot(cameraPosition, cameraPosition) - radiusClouds * radiusClouds;
float det = B * B - 4.0 * C;
float pointIntDist = max(0.0, 0.5 *(-B + sqrt(det)));
vec3 intersectionPont = cameraPosition + dir * pointIntDist;
intersectionPont =  intersectionPont - spherePos;
return intersectionPont;
}`),e.code.add(g`vec3 correctForPlanetCurvature(vec3 dir)
{
dir.z = dir.z*(1.-radiusCurvatureCorrectionFactor) + radiusCurvatureCorrectionFactor;
return dir;
}`),e.code.add(g`vec3 rotateDirectionToAnchorPoint(mat4 rotMat, vec3 inVec)
{
return (rotMat * vec4(inVec, 0.0)).xyz;
}`),Ui(e),Vi(e),e.code.add(g`const float SUNSET_TRANSITION_FACTOR = 0.3;
const vec3 RIM_COLOR = vec3(0.28, 0.175, 0.035);
const float RIM_SCATTERING_FACTOR = 140.0;
const float BACKLIGHT_FACTOR = 0.2;
const float BACKLIGHT_SCATTERING_FACTOR = 10.0;
const float BACKLIGHT_TRANSITION_FACTOR = 0.3;
vec3 calculateCloudColor(vec3 cameraPosition, vec3 worldSpaceRay, vec4 clouds)
{
float upDotLight = dot(normalize(cameraPosition), normalize(mainLightDirection));
float dirDotLight = max(dot(normalize(-worldSpaceRay), normalize(mainLightDirection)), 0.0);
float sunsetTransition = clamp(pow(max(upDotLight, 0.0), SUNSET_TRANSITION_FACTOR), 0.0, 1.0);
vec3 ambientLight = calculateAmbientIrradiance(normalize(cameraPosition),  0.0);
vec3 mainLight = evaluateMainLighting(normalize(cameraPosition),  0.0);
vec3 combinedLight = clamp((mainLightIntensity + ambientLight )/PI, vec3(0.0), vec3(1.0));
vec3 baseCloudColor = pow(combinedLight * pow(clouds.xyz, vec3(GAMMA)), vec3(INV_GAMMA));
float scatteringMod = max(clouds.a < 0.5 ? clouds.a / 0.5 : - clouds.a / 0.5 + 2.0, 0.0);
float rimLightIntensity = 0.5 + 0.5 *pow(max(upDotLight, 0.0), 0.35);
vec3 directSunScattering = RIM_COLOR * rimLightIntensity * (pow(dirDotLight, RIM_SCATTERING_FACTOR)) * scatteringMod;
float additionalLight = BACKLIGHT_FACTOR * pow(dirDotLight, BACKLIGHT_SCATTERING_FACTOR) * (1. - pow(sunsetTransition, BACKLIGHT_TRANSITION_FACTOR)) ;
return vec3(baseCloudColor * (1. + additionalLight) + directSunScattering);
}`),e.code.add(g`vec4 getCloudData(vec3 rayDir, bool readOtherChannel)
{
vec4 cloudData = texture(cubeMap, rayDir);
float mu = dot(rayDir, vec3(0, 0, 1));
bool readChannels = readChannelsRG ^^ readOtherChannel;
if (readChannels) {
cloudData = vec4(vec3(cloudData.r), cloudData.g);
} else {
cloudData = vec4(vec3(cloudData.b), cloudData.a);
}
if (length(cloudData) == 0.0) {
return vec4(cloudData.rgb, 1.0);
}
return cloudData;
}`),e.code.add(g`vec4 renderCloudsNoFade(vec3 worldRay, vec3 cameraPosition)
{
vec3 intersectionPoint = intersectWithCloudLayer(normalize(worldRay), cameraPosition, anchorPosition);
vec3 worldRayRotated = rotateDirectionToAnchorPoint(rotationMatrixClouds, normalize(intersectionPoint));
vec3 worldRayRotatedCorrected = correctForPlanetCurvature(worldRayRotated);
vec4 cloudData = getCloudData(worldRayRotatedCorrected, false);
float totalTransmittance = clamp(cloudData.a * (1.0 - totalFadeInOut) + totalFadeInOut, 0.0 , 1.0);
if (length(cloudData.rgb) == 0.0) {
totalTransmittance = 1.0;
}
return vec4(calculateCloudColor(cameraPosition, normalize(-worldRay), cloudData), totalTransmittance);
}`),e.code.add(g`vec4 renderCloudsCrossFade(vec3 worldRay, vec3 cameraPosition)
{
vec3 intersectionPoint = intersectWithCloudLayer(normalize(worldRay), cameraPosition, anchorPosition);
vec3 worldRayRotated = rotateDirectionToAnchorPoint(rotationMatrixClouds, normalize(intersectionPoint));
vec3 worldRayRotatedCorrected = correctForPlanetCurvature(worldRayRotated);
vec4 cloudData = getCloudData(worldRayRotatedCorrected, false);
vec4 cloudColor = vec4(calculateCloudColor(cameraPosition, normalize(-worldRay), cloudData), cloudData.a);
intersectionPoint = intersectWithCloudLayer(normalize(worldRay), cameraPosition, anchorPositionCrossFade);
worldRayRotated = rotateDirectionToAnchorPoint(rotationMatrixCloudsCrossFade, normalize(intersectionPoint));
worldRayRotatedCorrected = correctForPlanetCurvature(worldRayRotated);
cloudData = getCloudData(worldRayRotatedCorrected, fadeTextureChannels);
vec4 cloudColorCrossFade = vec4(calculateCloudColor(cameraPosition, normalize(-worldRay), cloudData), cloudData.a);
cloudColor = mix(cloudColor, cloudColorCrossFade, crossFadeAnchorFactor);
float totalTransmittance = clamp(cloudColor.a * (1.0 - totalFadeInOut) + totalFadeInOut, 0.0 , 1.0);
if (length(cloudColor.rgb) == 0.0) {
totalTransmittance = 1.0;
}
return vec4(cloudColor.rgb, totalTransmittance);
}`),e.code.add(g`vec4 renderClouds(vec3 worldRay, vec3 cameraPosition)
{
return crossFade ? renderCloudsCrossFade(worldRay, cameraPosition) : renderCloudsNoFade(worldRay, cameraPosition);
}`)}var $i;(function(t){t[t.Occluded=0]="Occluded",t[t.NotOccluded=1]="NotOccluded",t[t.Both=2]="Both",t[t.COUNT=3]="COUNT"})($i||($i={}));function Xh(t){t.include(Ra),t.uniforms.add(new Ve("geometryDepthTexture",(e,r)=>{var i;return(i=r.multipassGeometry.linearDepth)==null?void 0:i.colorTexture}),new Kr("nearFar",(e,r)=>r.camera.nearFar)),t.code.add(g`bool geometryDepthTest(vec2 pos, float elementDepth) {
float geometryDepth = linearDepthFromTexture(geometryDepthTexture, pos, nearFar);
return (elementDepth < (geometryDepth - 1.0));
}`)}let Zl=class{};function Jl(t,e,r){return 2*Math.atan(Math.sqrt(e*e+r*r)*Math.tan(.5*t)/e)}function Ql(t,e,r){return 2*Math.atan(Math.sqrt(e*e+r*r)*Math.tan(.5*t)/r)}function Yl(t,e,r){return 2*Math.atan(e*Math.tan(.5*t)/Math.sqrt(e*e+r*r))}function Xl(t,e,r){return 2*Math.atan(r*Math.tan(.5*t)/Math.sqrt(e*e+r*r))}var Mi;let N=Mi=class extends ua{constructor(t={}){super(t),this._center=F(),this._up=F(),this._viewUp=F(),this._viewForward=F(),this._viewRight=F(),this._ray=bo(),this._viewport=cr(0,0,1,1),this._padding=cr(0,0,0,0),this._fov=55/180*Math.PI,this._nearFar=pa(1,1e3),this._viewDirty=!0,this._viewMatrix=B(),this._viewProjectionDirty=!0,this._viewProjectionMatrix=B(),this._viewInverseTransposeMatrixDirty=!0,this._viewInverseTransposeMatrix=B(),this._frustumDirty=!0,this._frustum=ml(),this._fullViewport=ze(),this._pixelRatio=1,this.relativeElevation=0}get pixelRatio(){return this._pixelRatio}set pixelRatio(t){this._pixelRatio=t>0?t:1}get eye(){return this._ray.origin}set eye(t){this._compareAndSetView(t,this._ray.origin)}get center(){return this._center}set center(t){this._compareAndSetView(t,this._center,"_center")}get ray(){return le(this._ray.direction,this.center,this.eye),this._ray}get up(){return this._up}set up(t){this._compareAndSetView(t,this._up,"_up")}get viewMatrix(){return this._ensureViewClean(),this._viewMatrix}set viewMatrix(t){dt(this._viewMatrix,t),this._viewDirty=!1,this._viewInverseTransposeMatrixDirty=!0,this._viewProjectionDirty=!0,this._frustumDirty=!0}get viewForward(){return this._ensureViewClean(),this._viewForward}get viewUp(){return this._ensureViewClean(),this._viewUp}get viewRight(){return this._ensureViewClean(),this._viewRight}get nearFar(){return this._nearFar}get near(){return this._nearFar[0]}set near(t){this._nearFar[0]!==t&&(this._nearFar[0]=t,this._viewProjectionDirty=!0,this._frustumDirty=!0,this.notifyChange("_nearFar"))}get far(){return this._nearFar[1]}set far(t){this._nearFar[1]!==t&&(this._nearFar[1]=t,this._viewProjectionDirty=!0,this._frustumDirty=!0,this.notifyChange("_nearFar"))}get viewport(){return this._viewport}set viewport(t){this.x=t[0],this.y=t[1],this.width=t[2],this.height=t[3]}get screenViewport(){if(this.pixelRatio===1)return this._viewport;const t=rs(ze(),this._viewport,1/this.pixelRatio),e=this._get("screenViewport");return e&&is(t,e)?e:t}get screenPadding(){if(this.pixelRatio===1)return this._padding;const t=rs(ze(),this._padding,1/this.pixelRatio),e=this._get("screenPadding");return e&&is(t,e)?e:t}get x(){return this._viewport[0]}set x(t){t+=this._padding[z.LEFT],this._viewport[0]!==t&&(this._viewport[0]=t,this._viewProjectionDirty=!0,this._frustumDirty=!0,this.notifyChange("_viewport"))}get y(){return this._viewport[1]}set y(t){t+=this._padding[z.BOTTOM],this._viewport[1]!==t&&(this._viewport[1]=t,this._viewProjectionDirty=!0,this._frustumDirty=!0,this.notifyChange("_viewport"))}get width(){return this._viewport[2]}set width(t){this._viewport[2]!==t&&(this._viewport[2]=t,this._viewProjectionDirty=!0,this._frustumDirty=!0,this.notifyChange("_viewport"))}get height(){return this._viewport[3]}set height(t){this._viewport[3]!==t&&(this._viewport[3]=t,this._viewProjectionDirty=!0,this._frustumDirty=!0,this.notifyChange("_viewport"))}get fullWidth(){return this._viewport[2]+this._padding[z.RIGHT]+this._padding[z.LEFT]}set fullWidth(t){this.width=t-(this._padding[z.RIGHT]+this._padding[z.LEFT])}get fullHeight(){return this._viewport[3]+this._padding[z.TOP]+this._padding[z.BOTTOM]}set fullHeight(t){this.height=t-(this._padding[z.TOP]+this._padding[z.BOTTOM])}get fullViewport(){return this._fullViewport[0]=this._viewport[0]-this._padding[z.LEFT],this._fullViewport[1]=this._viewport[1]-this._padding[z.BOTTOM],this._fullViewport[2]=this.fullWidth,this._fullViewport[3]=this.fullHeight,this._fullViewport}get _aspect(){return this.width/this.height}get padding(){return this._padding}set padding(t){oi(this._padding,t)||(this._viewport[0]+=t[z.LEFT]-this._padding[z.LEFT],this._viewport[1]+=t[z.BOTTOM]-this._padding[z.BOTTOM],this._viewport[2]-=t[z.RIGHT]+t[z.LEFT]-(this._padding[z.RIGHT]+this._padding[z.LEFT]),this._viewport[3]-=t[z.TOP]+t[z.BOTTOM]-(this._padding[z.TOP]+this._padding[z.BOTTOM]),wr(this._padding,t),this._viewProjectionDirty=!0,this._frustumDirty=!0,this.notifyChange("_padding"),this.notifyChange("_viewport"))}get viewProjectionMatrix(){return this._viewProjectionDirty&&(Xe(this._viewProjectionMatrix,this.projectionMatrix,this.viewMatrix),this._viewProjectionDirty=!1),this._viewProjectionMatrix}get projectionMatrix(){const t=this.width,e=this.height,r=this.near*Math.tan(this.fovY/2),i=r*this._aspect,s=Oo(B(),-i*(1+2*this._padding[z.LEFT]/t),i*(1+2*this._padding[z.RIGHT]/t),-r*(1+2*this._padding[z.BOTTOM]/e),r*(1+2*this._padding[z.TOP]/e),this.near,this.far),a=this._get("projectionMatrix");return a&&Do(a,s)?a:s}get inverseProjectionMatrix(){return rr(B(),this.projectionMatrix)||this._get("inverseProjectionMatrix")||B()}get fov(){return this._fov}set fov(t){this._fov=t,this._viewProjectionDirty=!0,this._frustumDirty=!0}get fovX(){return Yl(this._fov,this.width,this.height)}set fovX(t){this._fov=Jl(t,this.width,this.height),this._viewProjectionDirty=!0,this._frustumDirty=!0}get fovY(){return Xl(this._fov,this.width,this.height)}set fovY(t){this._fov=Ql(t,this.width,this.height),this._viewProjectionDirty=!0,this._frustumDirty=!0}get distance(){return Qr(this.center,this.eye)}get frustum(){return this._recomputeFrustum(),this._frustum}get viewInverseTransposeMatrix(){return(this._viewInverseTransposeMatrixDirty||this._viewDirty)&&(rr(this._viewInverseTransposeMatrix,this.viewMatrix),fa(this._viewInverseTransposeMatrix,this._viewInverseTransposeMatrix),this._viewInverseTransposeMatrixDirty=!1),this._viewInverseTransposeMatrix}depthNDCToWorld(t){const e=2*t-1;return 2*this.near*this.far/(this.far+this.near-e*(this.far-this.near))}get perRenderPixelRatio(){return Math.tan(this.fovX/2)/(this.width/2)}get perScreenPixelRatio(){return this.perRenderPixelRatio*this.pixelRatio}get aboveGround(){return this.relativeElevation!=null&&this.relativeElevation>=0}copyFrom(t){J(this._ray.origin,t.eye),this.center=t.center,this.up=t.up,wr(this._viewport,t.viewport),this.notifyChange("_viewport"),wr(this._padding,t.padding),this.notifyChange("_padding"),Ni(this._nearFar,t.nearFar),this.notifyChange("_nearFar"),this._fov=t.fov,this.relativeElevation=t.relativeElevation;const e=t;return this._viewDirty=e._viewDirty,this._viewDirty||(dt(this._viewMatrix,t.viewMatrix),J(this._viewRight,t.viewRight),J(this._viewUp,t.viewUp),J(this._viewForward,t.viewForward)),this._viewProjectionDirty=!0,this._frustumDirty=e._frustumDirty,this._frustumDirty||(gl(this._frustum,t.frustum),this._frustumDirty=!1),e._viewInverseTransposeMatrixDirty?this._viewInverseTransposeMatrixDirty=!0:(dt(this._viewInverseTransposeMatrix,t.viewInverseTransposeMatrix),this._viewInverseTransposeMatrixDirty=!1),wr(this._fullViewport,t.fullViewport),this.pixelRatio=t.pixelRatio,this}copyViewFrom(t){this.eye=t.eye,this.center=t.center,this.up=t.up}clone(){return new Mi().copyFrom(this)}equals(t){return Ft(this.eye,t.eye)&&Ft(this.center,t.center)&&Ft(this.up,t.up)&&oi(this._viewport,t.viewport)&&oi(this._padding,t.padding)&&Ao(this.nearFar,t.nearFar)&&this._fov===t.fov&&this.pixelRatio===t.pixelRatio&&this.relativeElevation===t.relativeElevation}almostEquals(t){const e=Math.max(1,1/this.pixelRatio,1/t.pixelRatio);if(Math.abs(t.fov-this._fov)>=.001||ss(t.screenPadding,this.screenPadding)>=e||ss(this.screenViewport,t.screenViewport)>=e)return!1;as(ce,t.eye,t.center),as(ui,this.eye,this.center);const r=Zt(ce,ui),i=os(ce),s=os(ui),a=5e-4;return r*r>=(1-1e-10)*i*s&&Eo(t.eye,this.eye)<Math.max(i,s)*a*a}computeRenderPixelSizeAt(t){return this.computeRenderPixelSizeAtDist(this._viewDirectionDistance(t))}computeRenderPixelSizeAtDist(t){return t*this.perRenderPixelRatio}computeScreenPixelSizeAt(t){return this.computeScreenPixelSizeAtDist(this._viewDirectionDistance(t))}_viewDirectionDistance(t){return Math.abs($o(this.viewForward,le(ce,t,this.eye)))}computeScreenPixelSizeAtDist(t){return t*this.perScreenPixelRatio}computeDistanceFromRadius(t,e){return t/Math.tan(Math.min(this.fovX,this.fovY)/(2*(e||1)))}getScreenCenter(t=Mo()){return t[0]=(this.padding[z.LEFT]+this.width/2)/this.pixelRatio,t[1]=(this.padding[z.TOP]+this.height/2)/this.pixelRatio,t}getRenderCenter(t,e=.5,r=.5){return t[0]=this.padding[z.LEFT]+this.width*e,t[1]=this.padding[z.BOTTOM]+this.height*r,t[2]=.5,t}setGLViewport(t){const e=this.viewport,r=this.padding;t.setViewport(e[0]-r[3],e[1]-r[2],e[2]+r[1]+r[3],e[3]+r[0]+r[2])}applyProjection(t,e){t!==M&&J(M,t),M[3]=1,er(M,M,this.projectionMatrix);const r=Math.abs(M[3]);ne(M,M,1/r);const i=this.fullViewport;e[0]=ot(0,i[0]+i[2],.5+.5*M[0]),e[1]=ot(0,i[1]+i[3],.5+.5*M[1]),e[2]=.5*(M[2]+1),e[3]=r}unapplyProjection(t,e){const r=this.fullViewport;M[0]=(t[0]/(r[0]+r[2])*2-1)*t[3],M[1]=(t[1]/(r[1]+r[3])*2-1)*t[3],M[2]=(2*t[2]-1)*t[3],M[3]=t[3],this.inverseProjectionMatrix!=null&&(er(M,M,this.inverseProjectionMatrix),e[0]=M[0],e[1]=M[1],e[2]=M[2])}projectToScreen(t,e){return this.projectToRenderScreen(t,pi),this.renderToScreen(pi,e),e}projectToRenderScreen(t,e){if(M[0]=t[0],M[1]=t[1],M[2]=t[2],M[3]=1,er(M,M,this.viewProjectionMatrix),M[3]===0)return null;ne(M,M,1/Math.abs(M[3]));const r=this.fullViewport;return"x"in e?(e.x=ot(0,r[0]+r[2],.5+.5*M[0]),e.y=ot(0,r[1]+r[3],.5+.5*M[1])):(e[0]=ot(0,r[0]+r[2],.5+.5*M[0]),e[1]=ot(0,r[1]+r[3],.5+.5*M[1]),e.length>2&&(e[2]=.5*(M[2]+1))),e}unprojectFromScreen(t,e){return this.unprojectFromRenderScreen(this.screenToRender(t,pi),e)}unprojectFromRenderScreen(t,e){if(Xe(Rr,this.projectionMatrix,this.viewMatrix),!rr(Rr,Rr))return null;const r=this.fullViewport;return M[0]=2*(t[0]-r[0])/r[2]-1,M[1]=2*(t[1]-r[1])/r[3]-1,M[2]=2*t[2]-1,M[3]=1,er(M,M,Rr),M[3]===0?null:(e[0]=M[0]/M[3],e[1]=M[1]/M[3],e[2]=M[2]/M[3],e)}constrainWindowSize(t,e,r,i){const s=t*this.pixelRatio,a=e*this.pixelRatio,o=Math.max(s-r/2,0),n=Math.max(this.fullHeight-a-i/2,0),c=-Math.min(s-r/2,0),l=-Math.min(this.fullHeight-a-i/2,0),d=r-c- -Math.min(this.fullWidth-s-r/2,0),h=i-l- -Math.min(a-i/2,0);return[Math.round(o),Math.round(n),Math.round(d),Math.round(h)]}computeUp(t){t===si.Global?this._computeUpGlobal():this._computeUpLocal()}screenToRender(t,e){const r=t[0]*this.pixelRatio,i=this.fullHeight-t[1]*this.pixelRatio;return e[0]=r,e[1]=i,e}renderToScreen(t,e){const r=t[0]/this.pixelRatio,i=(this.fullHeight-t[1])/this.pixelRatio;e[0]=r,e[1]=i}_computeUpGlobal(){le(ce,this.center,this.eye);const t=nr(this.center);t<1?(ee(this._up,0,0,1),this._markViewDirty(),this.notifyChange("_up")):Math.abs(Zt(ce,this.center))>.9999*nr(ce)*t||(Ue(this._up,ce,this.center),Ue(this._up,this._up,ce),oe(this._up,this._up),this.notifyChange("_up"),this._markViewDirty())}_computeUpLocal(){Po(ce,this.eye,this.center),Math.abs(ce[2])<=.9999&&(ne(ce,ce,ce[2]),ee(this._up,-ce[0],-ce[1],1-ce[2]),oe(this._up,this._up),this.notifyChange("_up"),this._markViewDirty())}_compareAndSetView(t,e,r=""){typeof t[0]=="number"&&isFinite(t[0])&&typeof t[1]=="number"&&isFinite(t[1])&&typeof t[2]=="number"&&isFinite(t[2])?Ft(t,e)||(J(e,t),this._markViewDirty(),r.length&&this.notifyChange(r)):Yr.getLogger("esri.views.3d.webgl-engine.lib.Camera").warn("Camera vector contains invalid number, ignoring value")}_markViewDirty(){this._viewDirty=!0,this._frustumDirty=!0,this._viewProjectionDirty=!0}_recomputeFrustum(){this._frustumDirty&&(vl(this.viewMatrix,this.projectionMatrix,this._frustum),this._frustumDirty=!1)}_ensureViewClean(){this._viewDirty&&(ma(this._viewMatrix,this.eye,this.center,this.up),ee(this._viewForward,-this._viewMatrix[2],-this._viewMatrix[6],-this._viewMatrix[10]),ee(this._viewUp,this._viewMatrix[1],this._viewMatrix[5],this._viewMatrix[9]),ee(this._viewRight,this._viewMatrix[0],this._viewMatrix[4],this._viewMatrix[8]),this._viewDirty=!1,this._viewInverseTransposeMatrixDirty=!0)}};m([E()],N.prototype,"_center",void 0),m([E()],N.prototype,"_up",void 0),m([E()],N.prototype,"_viewport",void 0),m([E()],N.prototype,"_padding",void 0),m([E()],N.prototype,"_fov",void 0),m([E()],N.prototype,"_nearFar",void 0),m([E()],N.prototype,"_pixelRatio",void 0),m([E()],N.prototype,"pixelRatio",null),m([E()],N.prototype,"eye",null),m([E()],N.prototype,"center",null),m([E()],N.prototype,"up",null),m([E({readOnly:!0})],N.prototype,"nearFar",null),m([E()],N.prototype,"near",null),m([E()],N.prototype,"far",null),m([E()],N.prototype,"viewport",null),m([E({readOnly:!0})],N.prototype,"screenViewport",null),m([E({readOnly:!0})],N.prototype,"screenPadding",null),m([E()],N.prototype,"x",null),m([E()],N.prototype,"y",null),m([E()],N.prototype,"width",null),m([E()],N.prototype,"height",null),m([E()],N.prototype,"fullWidth",null),m([E()],N.prototype,"fullHeight",null),m([E({readOnly:!0})],N.prototype,"_aspect",null),m([E()],N.prototype,"padding",null),m([E({readOnly:!0})],N.prototype,"projectionMatrix",null),m([E({readOnly:!0})],N.prototype,"inverseProjectionMatrix",null),m([E()],N.prototype,"fov",null),m([E()],N.prototype,"fovX",null),m([E()],N.prototype,"fovY",null),N=Mi=m([fr("esri.views.3d.webgl-engine.lib.Camera")],N);const M=ze(),Rr=B(),ce=F(),ui=F(),pi=lt();var z;(function(t){t[t.TOP=0]="TOP",t[t.RIGHT=1]="RIGHT",t[t.BOTTOM=2]="BOTTOM",t[t.LEFT=3]="LEFT"})(z||(z={}));let Kl=class{constructor(e,r){this.shadowMap=e,this.slicePlane=r,this.slot=Z.OPAQUE_MATERIAL,this.hasOccludees=!1,this.enableFillLights=!0,this.transparencyPassType=ye.NONE,this.alignPixelEnabled=!1,this.decorations=Io.ON,this.overlayStretch=1,this._camera=new N,this._inverseViewport=Y(),this.oldLighting=new hi,this.newLighting=new hi,this._fadedLighting=new hi,this._lighting=this.newLighting,this.ssr=new ec,this.multipassEnabled=!1,this.multipassTerrain=new $n,this.multipassGeometry=new Zl,this.hudRenderStyle=$i.Occluded,this.cloudsFade=new Ul}get camera(){return this._camera}set camera(e){this._camera=e,this._inverseViewport[0]=1/e.fullViewport[2],this._inverseViewport[1]=1/e.fullViewport[3]}get inverseViewport(){return this._inverseViewport}get lighting(){return this._lighting}get weatherFading(){return this._lighting===this._fadedLighting}fadeLighting(e){const{oldLighting:r,newLighting:i}=this;e>=1?this._lighting=i:(this._fadedLighting.lerpLighting(r,i,e),this._lighting=this._fadedLighting)}},ec=class{constructor(){this.fadeFactor=1,this.reprojectionMatrix=B()}};var Pi;(function(t){function e(o,n){const c=o[n],l=o[n+1],d=o[n+2];return Math.sqrt(c*c+l*l+d*d)}function r(o,n){const c=o[n],l=o[n+1],d=o[n+2],h=1/Math.sqrt(c*c+l*l+d*d);o[n]*=h,o[n+1]*=h,o[n+2]*=h}function i(o,n,c){o[n]*=c,o[n+1]*=c,o[n+2]*=c}function s(o,n,c,l,d,h=n){(d=d||o)[h]=o[n]+c[l],d[h+1]=o[n+1]+c[l+1],d[h+2]=o[n+2]+c[l+2]}function a(o,n,c,l,d,h=n){(d=d||o)[h]=o[n]-c[l],d[h+1]=o[n+1]-c[l+1],d[h+2]=o[n+2]-c[l+2]}t.length=e,t.normalize=r,t.scale=i,t.add=s,t.subtract=a})(Pi||(Pi={}));const Tt=Pi,fi=[[-.5,-.5,.5],[.5,-.5,.5],[.5,.5,.5],[-.5,.5,.5],[-.5,-.5,-.5],[.5,-.5,-.5],[.5,.5,-.5],[-.5,.5,-.5]],tc=[0,0,1,-1,0,0,1,0,0,0,-1,0,0,1,0,0,0,-1],rc=[0,0,1,0,1,1,0,1],ic=[0,1,2,2,3,0,4,0,3,3,7,4,1,5,6,6,2,1,1,0,4,4,5,1,3,2,6,6,7,3,5,4,7,7,6,5],Ha=new Array(36);for(let t=0;t<6;t++)for(let e=0;e<6;e++)Ha[6*t+e]=t;const nt=new Array(36);for(let t=0;t<6;t++)nt[6*t]=0,nt[6*t+1]=1,nt[6*t+2]=2,nt[6*t+3]=2,nt[6*t+4]=3,nt[6*t+5]=0;function ru(t,e){Array.isArray(e)||(e=[e,e,e]);const r=new Array(24);for(let i=0;i<8;i++)r[3*i]=fi[i][0]*e[0],r[3*i+1]=fi[i][1]*e[1],r[3*i+2]=fi[i][2]*e[2];return new Te(t,[[f.POSITION,new j(r,ic,3,!0)],[f.NORMAL,new j(tc,Ha,3)],[f.UV0,new j(rc,nt,2)]])}const mi=[[-.5,0,-.5],[.5,0,-.5],[.5,0,.5],[-.5,0,.5],[0,-.5,0],[0,.5,0]],sc=[0,1,-1,1,1,0,0,1,1,-1,1,0,0,-1,-1,1,-1,0,0,-1,1,-1,-1,0],ac=[5,1,0,5,2,1,5,3,2,5,0,3,4,0,1,4,1,2,4,2,3,4,3,0],oc=[0,0,0,1,1,1,2,2,2,3,3,3,4,4,4,5,5,5,6,6,6,7,7,7];function iu(t,e){Array.isArray(e)||(e=[e,e,e]);const r=new Array(18);for(let i=0;i<6;i++)r[3*i]=mi[i][0]*e[0],r[3*i+1]=mi[i][1]*e[1],r[3*i+2]=mi[i][2]*e[2];return new Te(t,[[f.POSITION,new j(r,ac,3,!0)],[f.NORMAL,new j(sc,oc,3)]])}const Lr=te(-.5,0,-.5),Fr=te(.5,0,-.5),Nr=te(0,0,.5),jr=te(0,.5,0),Rt=q(),bt=q(),Bt=q(),kt=q(),qt=q();le(Rt,Lr,jr),le(bt,Lr,Fr),Ue(Bt,Rt,bt),oe(Bt,Bt),le(Rt,Fr,jr),le(bt,Fr,Nr),Ue(kt,Rt,bt),oe(kt,kt),le(Rt,Nr,jr),le(bt,Nr,Lr),Ue(qt,Rt,bt),oe(qt,qt);const gi=[Lr,Fr,Nr,jr],nc=[0,-1,0,Bt[0],Bt[1],Bt[2],kt[0],kt[1],kt[2],qt[0],qt[1],qt[2]],lc=[0,1,2,3,1,0,3,2,1,3,0,2],cc=[0,0,0,1,1,1,2,2,2,3,3,3];function su(t,e){Array.isArray(e)||(e=[e,e,e]);const r=new Array(12);for(let i=0;i<4;i++)r[3*i]=gi[i][0]*e[0],r[3*i+1]=gi[i][1]*e[1],r[3*i+2]=gi[i][2]*e[2];return new Te(t,[[f.POSITION,new j(r,lc,3,!0)],[f.NORMAL,new j(nc,cc,3)]])}function au(t,e,r,i,s={uv:!0}){const a=-Math.PI,o=2*Math.PI,n=-Math.PI/2,c=Math.PI,l=Math.max(3,Math.floor(r)),d=Math.max(2,Math.floor(i)),h=(l+1)*(d+1),p=Ee(3*h),u=Ee(3*h),v=Ee(2*h),x=[];let y=0;for(let _=0;_<=d;_++){const L=[],C=_/d,b=n+C*c,S=Math.cos(b);for(let U=0;U<=l;U++){const P=U/l,A=a+P*o,V=Math.cos(A)*S,W=Math.sin(b),yt=-Math.sin(A)*S;p[3*y]=V*e,p[3*y+1]=W*e,p[3*y+2]=yt*e,u[3*y]=V,u[3*y+1]=W,u[3*y+2]=yt,v[2*y]=P,v[2*y+1]=C,L.push(y),++y}x.push(L)}const R=new Array;for(let _=0;_<d;_++)for(let L=0;L<l;L++){const C=x[_][L],b=x[_][L+1],S=x[_+1][L+1],U=x[_+1][L];_===0?(R.push(C),R.push(S),R.push(U)):_===d-1?(R.push(C),R.push(b),R.push(S)):(R.push(C),R.push(b),R.push(S),R.push(S),R.push(U),R.push(C))}const w=[[f.POSITION,new j(p,R,3,!0)],[f.NORMAL,new j(u,R,3,!0)]];return s.uv&&w.push([f.UV0,new j(v,R,2,!0)]),s.offset&&(w[0][0]=f.OFFSET,w.push([f.POSITION,new j(Float64Array.from(s.offset),ga(R.length),3,!0)])),new Te(t,w)}function ou(t,e,r,i){const s=dc(e,r,i);return new Te(t,s)}function dc(t,e,r){const i=t;let s,a;if(r)s=[0,-1,0,1,0,0,0,0,1,-1,0,0,0,0,-1,0,1,0],a=[0,1,2,0,2,3,0,3,4,0,4,1,1,5,2,2,5,3,3,5,4,4,5,1];else{const l=i*(1+Math.sqrt(5))/2;s=[-i,l,0,i,l,0,-i,-l,0,i,-l,0,0,-i,l,0,i,l,0,-i,-l,0,i,-l,l,0,-i,l,0,i,-l,0,-i,-l,0,i],a=[0,11,5,0,5,1,0,1,7,0,7,10,0,10,11,1,5,9,5,11,4,11,10,2,10,7,6,7,1,8,3,9,4,3,4,2,3,2,6,3,6,8,3,8,9,4,9,5,2,4,11,6,2,10,8,6,7,9,8,1]}for(let l=0;l<s.length;l+=3)Tt.scale(s,l,t/Tt.length(s,l));let o={};function n(l,d){l>d&&([l,d]=[d,l]);const h=l.toString()+"."+d.toString();if(o[h])return o[h];let p=s.length;return s.length+=3,Tt.add(s,3*l,s,3*d,s,p),Tt.scale(s,p,t/Tt.length(s,p)),p/=3,o[h]=p,p}for(let l=0;l<e;l++){const d=a.length,h=new Array(4*d);for(let p=0;p<d;p+=3){const u=a[p],v=a[p+1],x=a[p+2],y=n(u,v),R=n(v,x),w=n(x,u),_=4*p;h[_]=u,h[_+1]=y,h[_+2]=w,h[_+3]=v,h[_+4]=R,h[_+5]=y,h[_+6]=x,h[_+7]=w,h[_+8]=R,h[_+9]=y,h[_+10]=R,h[_+11]=w}a=h,o={}}const c=ys(s);for(let l=0;l<c.length;l+=3)Tt.normalize(c,l);return[[f.POSITION,new j(ys(s),a,3,!0)],[f.NORMAL,new j(c,a,3,!0)]]}function nu(t,e,r,i,s,a,o,n,c=null){const l=r?[r[0],r[1],r[2]]:[0,0,0],d=e?[e[0],e[1],e[2]]:[0,0,1];o=o||[0,0];const h=i?[255*i[0],255*i[1],255*i[2],i.length>3?255*i[3]:255]:[255,255,255,255],p=s!=null&&s.length===2?s:[1,1],u=ga(1),v=[[f.POSITION,new j(l,u,3,!0)],[f.NORMAL,new j(d,u,3,!0)],[f.UV0,new j(o,u,o.length)],[f.COLOR,new j(h,u,4,!0)],[f.SIZE,new j(p,u,2)]];if(a!=null){const x=[a[0],a[1],a[2],a[3]];v.push([f.AUXPOS1,new j(x,u,4)])}if(n!=null){const x=[n[0],n[1],n[2],n[3]];v.push([f.FEATUREATTRIBUTE,new j(x,u,4)])}return new Te(t,v,null,Qt.Point,c)}const hc=[[-1,-1,0],[1,-1,0],[1,1,0],[-1,1,0]];function lu(t,e=hc){const r=new Array(12);for(let l=0;l<4;l++)for(let d=0;d<3;d++)r[3*l+d]=e[l][d];const i=[0,1,2,2,3,0],s=[0,0,1],a=[0,0,0,0,0,0],o=[0,0,1,0,1,1,0,1],n=[255,255,255,255],c=[[f.POSITION,new j(r,i,3,!0)],[f.NORMAL,new j(s,a,3,!0)],[f.UV0,new j(o,i,2,!0)],[f.COLOR,new j(n,a,4,!0)]];return new Te(t,c)}function cu(t,e,r,i,s,a=!0,o=!0){let n=0;const c=r,l=e;let d=te(0,n,0),h=te(0,n+l,0),p=te(0,-1,0),u=te(0,1,0);s&&(n=l,h=te(0,0,0),d=te(0,n,0),p=te(0,1,0),u=te(0,-1,0));const v=[h,d],x=[p,u],y=i+2,R=Math.sqrt(l*l+c*c);if(s)for(let S=i-1;S>=0;S--){const U=S*(2*Math.PI/i),P=te(Math.cos(U)*c,n,Math.sin(U)*c);v.push(P);const A=te(l*Math.cos(U)/R,-c/R,l*Math.sin(U)/R);x.push(A)}else for(let S=0;S<i;S++){const U=S*(2*Math.PI/i),P=te(Math.cos(U)*c,n,Math.sin(U)*c);v.push(P);const A=te(l*Math.cos(U)/R,c/R,l*Math.sin(U)/R);x.push(A)}const w=new Array,_=new Array;if(a){for(let S=3;S<v.length;S++)w.push(1),w.push(S-1),w.push(S),_.push(0),_.push(0),_.push(0);w.push(v.length-1),w.push(2),w.push(1),_.push(0),_.push(0),_.push(0)}if(o){for(let S=3;S<v.length;S++)w.push(S),w.push(S-1),w.push(0),_.push(S),_.push(S-1),_.push(1);w.push(0),w.push(2),w.push(v.length-1),_.push(1),_.push(2),_.push(x.length-1)}const L=Ee(3*y);for(let S=0;S<y;S++)L[3*S]=v[S][0],L[3*S+1]=v[S][1],L[3*S+2]=v[S][2];const C=Ee(3*y);for(let S=0;S<y;S++)C[3*S]=x[S][0],C[3*S+1]=x[S][1],C[3*S+2]=x[S][2];const b=[[f.POSITION,new j(L,w,3,!0)],[f.NORMAL,new j(C,_,3,!0)]];return new Te(t,b)}function du(t,e,r,i,s,a,o){const n=s?_s(s):te(1,0,0),c=a?_s(a):te(0,0,0);o??(o=!0);const l=q();oe(l,n);const d=q();ne(d,l,Math.abs(e));const h=q();ne(h,d,-.5),he(h,h,c);const p=te(0,1,0);Math.abs(1-Zt(l,p))<.2&&ee(p,0,0,1);const u=q();Ue(u,l,p),oe(u,u),Ue(p,u,l);const v=2*i+(o?2:0),x=i+(o?2:0),y=Ee(3*v),R=Ee(3*x),w=Ee(2*v),_=new Array(3*i*(o?4:2)),L=new Array(3*i*(o?4:2));o&&(y[3*(v-2)]=h[0],y[3*(v-2)+1]=h[1],y[3*(v-2)+2]=h[2],w[2*(v-2)]=0,w[2*(v-2)+1]=0,y[3*(v-1)]=y[3*(v-2)]+d[0],y[3*(v-1)+1]=y[3*(v-2)+1]+d[1],y[3*(v-1)+2]=y[3*(v-2)+2]+d[2],w[2*(v-1)]=1,w[2*(v-1)+1]=1,R[3*(x-2)]=-l[0],R[3*(x-2)+1]=-l[1],R[3*(x-2)+2]=-l[2],R[3*(x-1)]=l[0],R[3*(x-1)+1]=l[1],R[3*(x-1)+2]=l[2]);const C=(A,V,W)=>{_[A]=V,L[A]=W};let b=0;const S=q(),U=q();for(let A=0;A<i;A++){const V=A*(2*Math.PI/i);ne(S,p,Math.sin(V)),ne(U,u,Math.cos(V)),he(S,S,U),R[3*A]=S[0],R[3*A+1]=S[1],R[3*A+2]=S[2],ne(S,S,r),he(S,S,h),y[3*A]=S[0],y[3*A+1]=S[1],y[3*A+2]=S[2],w[2*A]=A/i,w[2*A+1]=0,y[3*(A+i)]=y[3*A]+d[0],y[3*(A+i)+1]=y[3*A+1]+d[1],y[3*(A+i)+2]=y[3*A+2]+d[2],w[2*(A+i)]=A/i,w[2*A+1]=1;const W=(A+1)%i;C(b++,A,A),C(b++,A+i,A),C(b++,W,W),C(b++,W,W),C(b++,A+i,A),C(b++,W+i,W)}if(o){for(let A=0;A<i;A++){const V=(A+1)%i;C(b++,v-2,x-2),C(b++,A,x-2),C(b++,V,x-2)}for(let A=0;A<i;A++){const V=(A+1)%i;C(b++,A+i,x-1),C(b++,v-1,x-1),C(b++,V+i,x-1)}}const P=[[f.POSITION,new j(y,_,3,!0)],[f.NORMAL,new j(R,L,3,!0)],[f.UV0,new j(w,_,2,!0)]];return new Te(t,P)}function hu(t,e,r,i,s,a){i=i||10,s=s==null||s,me(e.length>1);const o=[[0,0,0]],n=[],c=[];for(let l=0;l<i;l++){n.push([0,-l-1,-(l+1)%i-1]);const d=l/i*2*Math.PI;c.push([Math.cos(d)*r,Math.sin(d)*r])}return uc(t,c,e,o,n,s,a)}function uc(t,e,r,i,s,a,o=te(0,0,0)){const n=e.length,c=Ee(r.length*n*3+(6*i.length||0)),l=Ee(r.length*n*3+(i?6:0)),d=new Array,h=new Array;let p=0,u=0;const v=q(),x=q(),y=q(),R=q(),w=q(),_=q(),L=q(),C=F(),b=q(),S=q(),U=q(),P=q(),A=q(),V=mr();ee(b,0,1,0),le(x,r[1],r[0]),oe(x,x),a?(he(C,r[0],o),oe(y,C)):ee(y,0,0,1),As(x,y,b,b,w,y,Es),J(R,y),J(P,w);for(let $=0;$<i.length;$++)ne(_,w,i[$][0]),ne(C,y,i[$][2]),he(_,_,C),he(_,_,r[0]),c[p++]=_[0],c[p++]=_[1],c[p++]=_[2];l[u++]=-x[0],l[u++]=-x[1],l[u++]=-x[2];for(let $=0;$<s.length;$++)d.push(s[$][0]>0?s[$][0]:-s[$][0]-1+i.length),d.push(s[$][1]>0?s[$][1]:-s[$][1]-1+i.length),d.push(s[$][2]>0?s[$][2]:-s[$][2]-1+i.length),h.push(0),h.push(0),h.push(0);let W=i.length;const yt=i.length-1;for(let $=0;$<r.length;$++){let k=!1;$>0&&(J(v,x),$<r.length-1?(le(x,r[$+1],r[$]),oe(x,x)):k=!0,he(S,v,x),oe(S,S),he(U,r[$-1],R),No(r[$],S,V),jo(V,zo(U,v),C)?(le(C,C,r[$]),oe(y,C),Ue(w,S,y),oe(w,w)):As(S,R,P,b,w,y,Es),J(R,y),J(P,w)),a&&(he(C,r[$],o),oe(A,C));for(let re=0;re<n;re++)if(ne(_,w,e[re][0]),ne(C,y,e[re][1]),he(_,_,C),oe(L,_),l[u++]=L[0],l[u++]=L[1],l[u++]=L[2],he(_,_,r[$]),c[p++]=_[0],c[p++]=_[1],c[p++]=_[2],!k){const we=(re+1)%n;d.push(W+re),d.push(W+n+re),d.push(W+we),d.push(W+we),d.push(W+n+re),d.push(W+n+we);for(let We=0;We<6;We++){const wt=d.length-6;h.push(d[wt+We]-yt)}}W+=n}const ge=r[r.length-1];for(let $=0;$<i.length;$++)ne(_,w,i[$][0]),ne(C,y,i[$][1]),he(_,_,C),he(_,_,ge),c[p++]=_[0],c[p++]=_[1],c[p++]=_[2];const Ge=u/3;l[u++]=x[0],l[u++]=x[1],l[u++]=x[2];const Ke=W-n;for(let $=0;$<s.length;$++)d.push(s[$][0]>=0?W+s[$][0]:-s[$][0]-1+Ke),d.push(s[$][2]>=0?W+s[$][2]:-s[$][2]-1+Ke),d.push(s[$][1]>=0?W+s[$][1]:-s[$][1]-1+Ke),h.push(Ge),h.push(Ge),h.push(Ge);const et=[[f.POSITION,new j(c,d,3,!0)],[f.NORMAL,new j(l,h,3,!0)]];return new Te(t,et)}function uu(t,e,r,i){me(e.length>1,"createPolylineGeometry(): polyline needs at least 2 points"),me(e[0].length===3,"createPolylineGeometry(): malformed vertex"),me(r==null||r.length===e.length,"createPolylineGeometry: need same number of points and normals"),me(r==null||r[0].length===3,"createPolylineGeometry(): malformed normal");const s=Lo(3*e.length),a=new Array(2*(e.length-1));let o=0,n=0;for(let l=0;l<e.length;l++){for(let d=0;d<3;d++)s[o++]=e[l][d];l>0&&(a[n++]=l-1,a[n++]=l)}const c=[[f.POSITION,new j(s,a,3,!0)]];if(r){const l=Ee(3*r.length);let d=0;for(let h=0;h<e.length;h++)for(let p=0;p<3;p++)l[d++]=r[h][p];c.push([f.NORMAL,new j(l,a,3,!0)])}return i&&c.push([f.COLOR,new j(i,Fo(i.length/4),4)]),new Te(t,c,null,Qt.Line)}function pu(t,e,r,i,s,a=0){const o=new Array(18),n=[[-r,a,s/2],[i,a,s/2],[0,e+a,s/2],[-r,a,-s/2],[i,a,-s/2],[0,e+a,-s/2]],c=[0,1,2,3,0,2,2,5,3,1,4,5,5,2,1,1,0,3,3,4,1,4,3,5];for(let l=0;l<6;l++)o[3*l]=n[l][0],o[3*l+1]=n[l][1],o[3*l+2]=n[l][2];return new Te(t,[[f.POSITION,new j(o,c,3,!0)]])}function fu(t,e){const r=t.getMutableAttribute(f.POSITION).data;for(let i=0;i<r.length;i+=3){const s=r[i],a=r[i+1],o=r[i+2];ee(Ot,s,a,o),Se(Ot,Ot,e),r[i]=Ot[0],r[i+1]=Ot[1],r[i+2]=Ot[2]}}function mu(t,e=t){const r=t.attributes,i=r.get(f.POSITION).data,s=r.get(f.NORMAL).data;if(s){const a=e.getMutableAttribute(f.NORMAL).data;for(let o=0;o<s.length;o+=3){const n=s[o+1];a[o+1]=-s[o+2],a[o+2]=n}}if(i){const a=e.getMutableAttribute(f.POSITION).data;for(let o=0;o<i.length;o+=3){const n=i[o+1];a[o+1]=-i[o+2],a[o+2]=n}}}function vi(t,e,r,i,s){return!(Math.abs(Zt(e,t))>s)&&(Ue(r,t,e),oe(r,r),Ue(i,r,t),oe(i,i),!0)}function As(t,e,r,i,s,a,o){return vi(t,e,s,a,o)||vi(t,r,s,a,o)||vi(t,i,s,a,o)}const Es=.99619469809,Ot=q();function gu(t,e){if(t.type==="point")return Be(t,e,!1);if(dl(t))switch(t.type){case"extent":return Be(t.center,e,!1);case"polygon":return Be(t.centroid,e,!1);case"polyline":return Be($s(t),e,!0);case"mesh":return Be(t.origin,e,!1)}else switch(t.type){case"extent":return Be(pc(t),e,!0);case"polygon":return Be(fc(t),e,!0);case"polyline":return Be($s(t),e,!0)}}function $s(t){const e=t.paths[0];if(!e||e.length===0)return null;const r=Uo(e,Vo(e)/2);return Gi(r[0],r[1],r[2],t.spatialReference)}function pc(t){return Gi(.5*(t.xmax+t.xmin),.5*(t.ymax+t.ymin),t.zmin!=null&&t.zmax!=null&&isFinite(t.zmin)&&isFinite(t.zmax)?.5*(t.zmax+t.zmin):void 0,t.spatialReference)}function fc(t){const e=t.rings[0];if(!e||e.length===0)return null;const r=Wo(t.rings,!!t.hasZ);return Gi(r[0],r[1],r[2],t.spatialReference)}function Be(t,e,r){const i=r?t:hl(t);return e&&t?Ho(t,i,e)?i:null:i}function vu(t,e,r,i=0){if(t){e||(e=ir());const s=t;let a=.5*s.width*(r-1),o=.5*s.height*(r-1);return s.width<1e-7*s.height?a+=o/20:s.height<1e-7*s.width&&(o+=a/20),dr(e,s.xmin-a-i,s.ymin-o-i,s.xmax+a+i,s.ymax+o+i),e}return null}function mc(t,e){for(let r=0;r<t.geometries.length;++r){const i=t.geometries[r].getMutableAttribute(f.AUXPOS1);i&&i.data[3]!==e&&(i.data[3]=e,t.geometryVertexAttributeUpdated(t.geometries[r],f.AUXPOS1))}}function _u(t,e,r=null){const i=Go(va);return t!=null&&(i[0]=t[0],i[1]=t[1],i[2]=t[2]),e!=null?i[3]=e:t!=null&&t.length>3&&(i[3]=t[3]),r&&(i[0]*=r,i[1]*=r,i[2]*=r,i[3]*=r),i}function yu(t,e,r,i,s,a=[0,0,0,0]){for(let o=0;o<3;++o)a[o]=(t==null?void 0:t[o])!=null?t[o]:(r==null?void 0:r[o])!=null?r[o]:s[o];return a[3]=e??i??s[3],a}function wu(t=Qo,e,r,i=1){const s=new Array(3);if(e==null||r==null)s[0]=1,s[1]=1,s[2]=1;else{let a,o=0;for(let n=2;n>=0;n--){const c=t[n];let l;const d=c!=null,h=n===0&&!a&&!d,p=r[n];c==="symbol-value"||h?l=p!==0?e[n]/p:1:d&&c!=="proportional"&&isFinite(c)&&(l=p!==0?c/p:1),l!=null&&(s[n]=l,a=l,o=Math.max(o,Math.abs(l)))}for(let n=2;n>=0;n--)s[n]==null?s[n]=a:s[n]===0&&(s[n]=.001*o)}for(let a=2;a>=0;a--)s[a]/=i;return Jo(s)}function gc(t){return t.isPrimitive!=null}function xu(t){return vc(gc(t)?[t.width,t.depth,t.height]:t)?null:"Symbol sizes may not be negative values"}function vc(t){const e=r=>r==null||r>=0;return Array.isArray(t)?t.every(e):e(t)}function Cu(t,e,r,i=B()){return t&&Yo(i,i,-t/180*Math.PI),e&&Xo(i,i,e/180*Math.PI),r&&Ko(i,i,r/180*Math.PI),i}function Su(t,e,r){if(r.minDemResolution!=null)return r.minDemResolution;const i=Bo(e),s=ko(t)*i,a=qo(t)*i,o=Zo(t)*(e.isGeographic?1:i);return s===0&&a===0&&o===0?r.minDemResolutionForPoints:.01*Math.max(s,a,o)}function Tu(t,e,r,i,s,a,o,n,c,l,d){const h=Tc[d.mode];let p,u,v=0;if(Ei(t,e,r,i,c.spatialReference,s,n))return h.requiresAlignment(d)?(v=h.applyElevationAlignmentBuffer(i,s,a,o,n,c,l,d),p=a,u=o):(p=i,u=s),Ei(p,c.spatialReference,u,a,l.spatialReference,o,n)?v:void 0}function Ga(t,e,r,i,s){const a=(ll(t)?t.z:cl(t)?t.array[t.offset+2]:t[2])||0;switch(r.mode){case"on-the-ground":{const o=Sr(e,t,"ground")??0;return s.verticalDistanceToGround=0,s.sampledElevation=o,void(s.z=o)}case"relative-to-ground":{const o=Sr(e,t,"ground")??0,n=r.geometryZWithOffset(a,i);return s.verticalDistanceToGround=n,s.sampledElevation=o,void(s.z=n+o)}case"relative-to-scene":{const o=Sr(e,t,"scene")??0,n=r.geometryZWithOffset(a,i);return s.verticalDistanceToGround=n,s.sampledElevation=o,void(s.z=n+o)}case"absolute-height":{const o=r.geometryZWithOffset(a,i),n=Sr(e,t,"ground")??0;return s.verticalDistanceToGround=o-n,s.sampledElevation=n,void(s.z=o)}default:return void(s.z=0)}}function Ru(t,e,r,i){return Ga(t,e,r,i,Vt),Vt.z}function bu(t,e,r){return e==null||r==null?t.definedChanged:e==="on-the-ground"&&r==="on-the-ground"?t.staysOnTheGround:e===r||e!=="on-the-ground"&&r!=="on-the-ground"?Ii.UPDATE:t.onTheGroundChanged}function Ou(t){return t==="relative-to-ground"||t==="relative-to-scene"}function Du(t){return t!=="absolute-height"}function Au(t,e,r,i,s){Ga(e,r,s,i,Vt),mc(t,Vt.verticalDistanceToGround);const a=Vt.sampledElevation,o=dt(Rc,t.transformation);return br[0]=e.x,br[1]=e.y,br[2]=Vt.z,en(e.spatialReference,br,o,i.spatialReference)?t.transformation=o:console.warn("Could not locate symbol object properly, it might be misplaced"),a}function _c(t,e,r,i,s,a){let o=0;const n=a.spatialReference;e*=3,i*=3;for(let c=0;c<s;++c){const l=t[e],d=t[e+1],h=t[e+2],p=a.getElevation(l,d,h,n,"ground")??0;o+=p,r[i]=l,r[i+1]=d,r[i+2]=p,e+=3,i+=3}return o/s}function yc(t,e,r,i,s,a,o,n){let c=0;const l=n.calculateOffsetRenderUnits(o),d=n.featureExpressionInfoContext,h=a.spatialReference;e*=3,i*=3;for(let p=0;p<s;++p){const u=t[e],v=t[e+1],x=t[e+2],y=a.getElevation(u,v,x,h,"ground")??0;c+=y,r[i]=u,r[i+1]=v,r[i+2]=d==null?x+y+l:y+l,e+=3,i+=3}return c/s}function wc(t,e,r,i,s,a,o,n){let c=0;const l=n.calculateOffsetRenderUnits(o),d=n.featureExpressionInfoContext,h=a.spatialReference;e*=3,i*=3;for(let p=0;p<s;++p){const u=t[e],v=t[e+1],x=t[e+2],y=a.getElevation(u,v,x,h,"scene")??0;c+=y,r[i]=u,r[i+1]=v,r[i+2]=d==null?x+y+l:y+l,e+=3,i+=3}return c/s}function xc(t){const e=t.meterUnitOffset,r=t.featureExpressionInfoContext;return e!==0||r!=null}function Cc(t,e,r,i,s,a,o,n){const c=n.calculateOffsetRenderUnits(o),l=n.featureExpressionInfoContext;e*=3,i*=3;for(let d=0;d<s;++d){const h=t[e],p=t[e+1],u=t[e+2];r[i]=h,r[i+1]=p,r[i+2]=l==null?u+c:c,e+=3,i+=3}return 0}let Sc=class{constructor(){this.verticalDistanceToGround=0,this.sampledElevation=0,this.z=0}};var Ii;(function(t){t[t.NONE=0]="NONE",t[t.UPDATE=1]="UPDATE",t[t.RECREATE=2]="RECREATE"})(Ii||(Ii={}));const Tc={"absolute-height":{applyElevationAlignmentBuffer:Cc,requiresAlignment:xc},"on-the-ground":{applyElevationAlignmentBuffer:_c,requiresAlignment:()=>!0},"relative-to-ground":{applyElevationAlignmentBuffer:yc,requiresAlignment:()=>!0},"relative-to-scene":{applyElevationAlignmentBuffer:wc,requiresAlignment:()=>!0}},Rc=B(),Vt=new Sc,br=F(),bc=Yr.getLogger("esri.views.3d.layers.graphics.featureExpressionInfoUtils");function Oc(t){return{cachedResult:t.cachedResult,arcade:t.arcade?{func:t.arcade.func,context:t.arcade.modules.arcadeUtils.createExecContext(null,{sr:t.arcade.context.spatialReference}),modules:t.arcade.modules}:null}}function $u(t){const e=t==null?void 0:t.expression;if(typeof e=="string"){const r=ka(e);if(r!=null)return{cachedResult:r}}return null}async function Mu(t,e,r,i){const s=t==null?void 0:t.expression;if(typeof s!="string")return null;const a=ka(s);if(a!=null)return{cachedResult:a};const o=await tn();rn(r);const n=o.arcadeUtils,c=n.createSyntaxTree(s);return n.dependsOnView(c)?(i!=null&&i.error("Expressions containing '$view' are not supported on ElevationInfo"),{cachedResult:0}):{arcade:{func:n.createFunction(c),context:n.createExecContext(null,{sr:e}),modules:o}}}function Dc(t,e,r){return t.arcadeUtils.createFeature(e.attributes,e.geometry,r)}function Ac(t,e){if(t!=null&&!Ba(t)){if(!e||!t.arcade)return void bc.errorOncePerTick("Arcade support required but not provided");const r=e;r._geometry&&(r._geometry=ul(r._geometry)),t.arcade.modules.arcadeUtils.updateExecContext(t.arcade.context,e)}}function Ec(t){if(t!=null){if(Ba(t))return t.cachedResult;const e=t.arcade;let r=e==null?void 0:e.modules.arcadeUtils.executeFunction(e.func,e.context);return typeof r!="number"&&(t.cachedResult=0,r=0),r}return 0}function Pu(t,e=!1){let r=t==null?void 0:t.featureExpressionInfo;const i=r==null?void 0:r.expression;return e||i==="0"||(r=null),r??null}const Iu={cachedResult:0};function Ba(t){return t.cachedResult!=null}function ka(t){return t==="0"?0:null}let Lu=class qa{constructor(){this._meterUnitOffset=0,this._renderUnitOffset=0,this._unit="meters",this._metersPerElevationInfoUnit=1,this._featureExpressionInfoContext=null,this.centerPointInElevationSR=null,this.mode=null}get featureExpressionInfoContext(){return this._featureExpressionInfoContext}get meterUnitOffset(){return this._meterUnitOffset}get unit(){return this._unit}set unit(e){this._unit=e,this._metersPerElevationInfoUnit=sn(e)}get requiresSampledElevationInfo(){return this.mode!=="absolute-height"}reset(){this.mode=null,this._meterUnitOffset=0,this._renderUnitOffset=0,this._featureExpressionInfoContext=null,this.unit="meters"}set offsetMeters(e){this._meterUnitOffset=e,this._renderUnitOffset=0}set offsetElevationInfoUnits(e){this._meterUnitOffset=e*this._metersPerElevationInfoUnit,this._renderUnitOffset=0}addOffsetRenderUnits(e){this._renderUnitOffset+=e}geometryZWithOffset(e,r){const i=this.calculateOffsetRenderUnits(r);return this.featureExpressionInfoContext!=null?i:e+i}calculateOffsetRenderUnits(e){let r=this._meterUnitOffset;const i=this.featureExpressionInfoContext;return i!=null&&(r+=Ec(i)*this._metersPerElevationInfoUnit),r/e.unitInMeters+this._renderUnitOffset}setFromElevationInfo(e){this.mode=e.mode,this.unit=an(e.unit)?e.unit:"meters",this.offsetElevationInfoUnits=e.offset??0}updateFeatureExpressionInfoContext(e,r,i){if(e==null)return void(this._featureExpressionInfoContext=null);const s=e==null?void 0:e.arcade;s&&r!=null&&i!=null?(this._featureExpressionInfoContext=Oc(e),Ac(this._featureExpressionInfoContext,Dc(s.modules,r,i))):this._featureExpressionInfoContext=e}static fromElevationInfo(e){const r=new qa;return e!=null&&r.setFromElevationInfo(e),r}},$c=class extends _a{get geometries(){return this._geometries}get transformation(){return this._transformation??Ze}set transformation(e){this._transformation=dt(this._transformation??B(),e),this._invalidateBoundingVolume(),this._emit("transformationChanged",this)}get shaderTransformation(){return this._shaderTransformation}set shaderTransformation(e){this._shaderTransformation=e?dt(this._shaderTransformation??B(),e):null,this._invalidateBoundingVolume(),this._emit("shaderTransformationChanged",this)}get effectiveTransformation(){return this.shaderTransformation??this.transformation}constructor(e={}){super(),this.type=Qt.Object,this._shaderTransformation=null,this._parentLayer=null,this._visible=!0,this.castShadow=e.castShadow??!0,this.usesVerticalDistanceToGround=e.usesVerticalDistanceToGround??!1,this.graphicUid=e.graphicUid,this.layerUid=e.layerUid,e.isElevationSource&&(this.lastValidElevationBB=new Za),this._geometries=e.geometries?Array.from(e.geometries):new Array}dispose(){this._geometries.length=0}get parentLayer(){return this._parentLayer}set parentLayer(e){me(this._parentLayer==null||e==null,"Object3D can only be added to a single Layer"),this._parentLayer=e}addGeometry(e){e.visible=this._visible,this._geometries.push(e),this._emit("geometryAdded",{object:this,geometry:e}),this._invalidateBoundingVolume()}removeGeometry(e){const r=this._geometries.splice(e,1)[0];r&&(this._emit("geometryRemoved",{object:this,geometry:r}),this._invalidateBoundingVolume())}removeAllGeometries(){for(;this._geometries.length>0;)this.removeGeometry(0)}geometryVertexAttributeUpdated(e,r,i=!1){this._emit("attributesChanged",{object:this,geometry:e,attribute:r,sync:i}),on(r)&&this._invalidateBoundingVolume()}get visible(){return this._visible}set visible(e){if(this._visible!==e){this._visible=e;for(const r of this._geometries)r.visible=this._visible;this._emit("visibilityChanged",this)}}maskOccludee(){const e=new ns(ls.MaskOccludee);for(const r of this._geometries)r.occludees=cs(r.occludees,e);return this._emit("occlusionChanged",this),e}removeOcclude(e){for(const r of this._geometries)r.occludees=ds(r.occludees,e);this._emit("occlusionChanged",this)}highlight(){const e=new ns(ls.Highlight);for(const r of this._geometries)r.highlights=cs(r.highlights,e);return this._emit("highlightChanged",this),e}removeHighlight(e){for(const r of this._geometries)r.highlights=ds(r.highlights,e);this._emit("highlightChanged",this)}getCombinedStaticTransformation(e,r){return Xe(r,this.transformation,e.transformation)}getCombinedShaderTransformation(e,r=B()){return Xe(r,this.effectiveTransformation,e.transformation)}get boundingVolumeWorldSpace(){return this._bvWorldSpace||(this._bvWorldSpace=this._bvWorldSpace||new Ms,this._validateBoundingVolume(this._bvWorldSpace,sr.WorldSpace)),this._bvWorldSpace}get boundingVolumeObjectSpace(){return this._bvObjectSpace||(this._bvObjectSpace=this._bvObjectSpace||new Ms,this._validateBoundingVolume(this._bvObjectSpace,sr.ObjectSpace)),this._bvObjectSpace}_validateBoundingVolume(e,r){const i=r===sr.ObjectSpace;for(const s of this._geometries){const a=s.boundingInfo;a&&Mc(a,e,i?s.transformation:this.getCombinedShaderTransformation(s))}nn(e.bounds,e.min,e.max,.5);for(const s of this._geometries){const a=s.boundingInfo;if(a==null)continue;const o=i?s.transformation:this.getCombinedShaderTransformation(s),n=ya(o);Se(Ps,a.center,o);const c=Qr(Ps,e.bounds),l=a.radius*n;e.bounds[3]=Math.max(e.bounds[3],c+l)}}_invalidateBoundingVolume(){var r;const e=(r=this._bvWorldSpace)==null?void 0:r.bounds;this._bvObjectSpace=this._bvWorldSpace=void 0,this._parentLayer&&e&&this._parentLayer.notifyObjectBBChanged(this,e)}_emit(e,r){this._parentLayer&&this._parentLayer.events.emit(e,r)}get test(){const e=this;return{hasGeometry:r=>e._geometries.includes(r),getGeometryIndex:r=>e._geometries.indexOf(r)}}},Za=class{constructor(){this.min=lr(Number.MAX_VALUE,Number.MAX_VALUE,Number.MAX_VALUE),this.max=lr(-Number.MAX_VALUE,-Number.MAX_VALUE,-Number.MAX_VALUE)}isEmpty(){return this.max[0]<this.min[0]&&this.max[1]<this.min[1]&&this.max[2]<this.min[2]}},Ms=class extends Za{constructor(){super(...arguments),this.bounds=wa()}};function Mc(t,e,r){const i=t.bbMin,s=t.bbMax;if(ln(r)){const a=ee(Pc,r[12],r[13],r[14]);he(xe,i,a),he(De,s,a);for(let o=0;o<3;++o)e.min[o]=Math.min(e.min[o],xe[o]),e.max[o]=Math.max(e.max[o],De[o])}else if(Se(xe,i,r),Ft(i,s))for(let a=0;a<3;++a)e.min[a]=Math.min(e.min[a],xe[a]),e.max[a]=Math.max(e.max[a],xe[a]);else{Se(De,s,r);for(let a=0;a<3;++a)e.min[a]=Math.min(e.min[a],xe[a],De[a]),e.max[a]=Math.max(e.max[a],xe[a],De[a]);for(let a=0;a<3;++a){J(xe,i),J(De,s),xe[a]=s[a],De[a]=i[a],Se(xe,xe,r),Se(De,De,r);for(let o=0;o<3;++o)e.min[o]=Math.min(e.min[o],xe[o],De[o]),e.max[o]=Math.max(e.max[o],xe[o],De[o])}}}const Pc=F(),xe=F(),De=F(),Ps=F();var sr;(function(t){t[t.WorldSpace=0]="WorldSpace",t[t.ObjectSpace=1]="ObjectSpace"})(sr||(sr={}));var ar,kr,Li;(function(t){t[t.RasterImage=0]="RasterImage",t[t.Features=1]="Features"})(ar||(ar={})),function(t){t[t.MapLayer=0]="MapLayer",t[t.ViewLayer=1]="ViewLayer",t[t.Outline=2]="Outline",t[t.SnappingHint=3]="SnappingHint"}(kr||(kr={})),function(t){t[t.WithRasterImage=0]="WithRasterImage",t[t.WithoutRasterImage=1]="WithoutRasterImage"}(Li||(Li={}));var Oe,Is,Ls,Fs;(function(t){t[t.INNER=0]="INNER",t[t.OUTER=1]="OUTER"})(Oe||(Oe={})),function(t){t[t.REGULAR=0]="REGULAR",t[t.HAS_NORTH_POLE=1]="HAS_NORTH_POLE",t[t.HAS_SOUTH_POLE=2]="HAS_SOUTH_POLE",t[t.HAS_BOTH_POLES=3]="HAS_BOTH_POLES"}(Is||(Is={})),function(t){t[t.OFF=0]="OFF",t[t.ON=1]="ON"}(Ls||(Ls={})),function(t){t[t.FADING=0]="FADING",t[t.IMMEDIATE=1]="IMMEDIATE",t[t.UNFADED=2]="UNFADED"}(Fs||(Fs={}));let Ic=class{constructor(e,r){this.vec3=e,this.id=r}};function Fi(t,e,r,i){return new Ic(lr(t,e,r),i)}let Ns=class{constructor(){this._extent=ir(),this.resolution=0,this.renderLocalOrigin=Fi(0,0,0,"O"),this.pixelRatio=1,this.mapUnitsPerPixel=1,this.canvasGeometries=new Lc}get extent(){return this._extent}setupGeometryViewsCyclical(e){this.setupGeometryViewsDirect();const r=.001*e.range;if(this._extent[0]-r<=e.min){const i=this.canvasGeometries.extents[this.canvasGeometries.numViews++];hs(this._extent,e.range,0,i)}if(this._extent[2]+r>=e.max){const i=this.canvasGeometries.extents[this.canvasGeometries.numViews++];hs(this._extent,-e.range,0,i)}}setupGeometryViewsDirect(){this.canvasGeometries.numViews=1,cn(this.canvasGeometries.extents[0],this._extent)}hasSomeSizedView(){for(let e=0;e<this.canvasGeometries.numViews;e++){const r=this.canvasGeometries.extents[e];if(r[0]!==r[2]&&r[1]!==r[3])return!0}return!1}},Lc=class{constructor(){this.extents=[ir(),ir(),ir()],this.numViews=0}};var ae;(function(t){t[t.Color=0]="Color",t[t.ColorNoRasterImage=1]="ColorNoRasterImage",t[t.Highlight=2]="Highlight",t[t.WaterNormal=3]="WaterNormal",t[t.Occluded=4]="Occluded",t[t.ObjectAndLayerIdColor=5]="ObjectAndLayerIdColor"})(ae||(ae={}));let Fc=class{constructor(e,r){this._fbos=e,this._format=r}get valid(){return this._handle!=null}dispose(){this._handle=Ur(this._handle)}get texture(){var e;return(e=this._handle)==null?void 0:e.colorTexture}bind(e,r,i){var s,a;this._handle&&this._handle.fbo.width===r&&this._handle.fbo.height===i||((s=this._handle)==null||s.release(),this._handle=this._fbos.acquire(this._format,r,i)),e.bindFramebuffer((a=this._handle)==null?void 0:a.fbo)}generateMipMap(){var e,r,i,s,a;(i=(r=(e=this._handle)==null?void 0:e.colorTexture)==null?void 0:r.descriptor)!=null&&i.hasMipmap&&((a=(s=this._handle)==null?void 0:s.colorTexture)==null||a.generateMipmap())}},Dt=class{constructor(e,r,i,s=hr.RGBA_MIPMAP){this.output=r,this.content=i,this.fbo=new Fc(e,s)}get valid(){return this.fbo.valid}},Nc=class{constructor(e){this.targets=[new Dt(e,O.Color,ae.Color),new Dt(e,O.Color,ae.ColorNoRasterImage),new Dt(e,O.Highlight,ae.Highlight,hr.RGBA4),new Dt(e,O.Normal,ae.WaterNormal),new Dt(e,O.Color,ae.Occluded)],ht("enable-feature:objectAndLayerId-rendering")&&this.targets.push(new Dt(e,O.ObjectAndLayerIdColor,ae.ObjectAndLayerIdColor))}getTexture(e){var r;return(r=this.targets[e])==null?void 0:r.fbo.texture}dispose(){for(const e of this.targets)e.fbo.dispose()}computeValidity(){return this.targets.reduce((e,r,i)=>r.valid?e|=1<<i:e,0)}},Qi=class extends Mn{constructor(){super(...arguments),this.slicePlaneLocalOrigin=F(),this.origin=this.slicePlaneLocalOrigin,this.modelTransformation=null}};var Ye;(function(t){t[t.Material=0]="Material",t[t.ShadowMap=1]="ShadowMap",t[t.Highlight=2]="Highlight"})(Ye||(Ye={}));let ku=class extends Qi{constructor(){super(...arguments),this.identifier=Ye.Material,this.output=O.Color,this.transparent=!1}},Zu=class extends Qi{constructor(){super(...arguments),this.identifier=Ye.ShadowMap}},Qu=class extends Qi{constructor(){super(...arguments),this.identifier=Ye.Highlight}};function jc(t){t.fragment.code.add(g`float normals2FoamIntensity(vec3 n, float waveStrength){
float normalizationFactor =  max(0.015, waveStrength);
return max((n.x + n.y)*0.3303545/normalizationFactor + 0.3303545, 0.0);
}`)}function zc(t){t.fragment.code.add(g`vec3 foamIntensity2FoamColor(float foamIntensityExternal, float foamPixelIntensity, vec3 skyZenitColor, float dayMod){
return foamIntensityExternal * (0.075 * skyZenitColor * pow(foamPixelIntensity, 4.) +  50.* pow(foamPixelIntensity, 23.0)) * dayMod;
}`)}function Uc(t,e){const r=t.fragment;r.include(Ra),r.uniforms.add(new Kr("nearFar",(i,s)=>s.camera.nearFar)),r.uniforms.add(new Ve("depthMap",(i,s)=>{var a;return(a=s.linearDepth)==null?void 0:a.colorTexture})),r.uniforms.add(new Jt("proj",(i,s)=>s.camera.projectionMatrix)),r.uniforms.add(new Q("invResolutionHeight",(i,s)=>1/s.camera.height)),r.uniforms.add(new Jt("reprojectionMatrix",(i,s)=>s.ssr.reprojectionMatrix)),r.code.add(g`
  vec2 reprojectionCoordinate(vec3 projectionCoordinate)
  {
    vec4 zw = proj * vec4(0.0, 0.0, -projectionCoordinate.z, 1.0);
    vec4 reprojectedCoord = reprojectionMatrix * vec4(zw.w * (projectionCoordinate.xy * 2.0 - 1.0), zw.z, zw.w);
    reprojectedCoord.xy /= reprojectedCoord.w;
    return reprojectedCoord.xy * 0.5 + 0.5;
  }

  const int maxSteps = ${e.highStepCount?"150":"75"};

  vec4 applyProjectionMat(mat4 projectionMat, vec3 x)
  {
    vec4 projectedCoord =  projectionMat * vec4(x, 1.0);
    projectedCoord.xy /= projectedCoord.w;
    projectedCoord.xy = projectedCoord.xy*0.5 + 0.5;
    return projectedCoord;
  }

  vec3 screenSpaceIntersection(vec3 dir, vec3 startPosition, vec3 viewDir, vec3 normal)
  {
    vec3 viewPos = startPosition;
    vec3 viewPosEnd = startPosition;

    // Project the start position to the screen
    vec4 projectedCoordStart = applyProjectionMat(proj, viewPos);
    vec3  Q0 = viewPos / projectedCoordStart.w; // homogeneous camera space
    float k0 = 1.0/ projectedCoordStart.w;

    // advance the position in the direction of the reflection
    viewPos += dir;

    vec4 projectedCoordVanishingPoint = applyProjectionMat(proj, dir);

    // Project the advanced position to the screen
    vec4 projectedCoordEnd = applyProjectionMat(proj, viewPos);
    vec3  Q1 = viewPos / projectedCoordEnd.w; // homogeneous camera space
    float k1 = 1.0/ projectedCoordEnd.w;

    // calculate the reflection direction in the screen space
    vec2 projectedCoordDir = (projectedCoordEnd.xy - projectedCoordStart.xy);
    vec2 projectedCoordDistVanishingPoint = (projectedCoordVanishingPoint.xy - projectedCoordStart.xy);

    float yMod = min(abs(projectedCoordDistVanishingPoint.y), 1.0);

    float projectedCoordDirLength = length(projectedCoordDir);
    float maxSt = float(maxSteps);

    // normalize the projection direction depending on maximum steps
    // this determines how blocky the reflection looks
    vec2 dP = yMod * (projectedCoordDir)/(maxSt * projectedCoordDirLength);

    // Normalize the homogeneous camera space coordinates
    vec3  dQ = yMod * (Q1 - Q0)/(maxSt * projectedCoordDirLength);
    float dk = yMod * (k1 - k0)/(maxSt * projectedCoordDirLength);

    // initialize the variables for ray marching
    vec2 P = projectedCoordStart.xy;
    vec3 Q = Q0;
    float k = k0;
    float rayStartZ = -startPosition.z; // estimated ray start depth value
    float rayEndZ = -startPosition.z;   // estimated ray end depth value
    float prevEstimateZ = -startPosition.z;
    float rayDiffZ = 0.0;
    float dDepth;
    float depth;
    float rayDiffZOld = 0.0;

    // early outs
    if (dot(normal, dir) < 0.0 || dot(-viewDir, normal) < 0.0)
      return vec3(P, 0.0);

    for(int i = 0; i < maxSteps-1; i++)
    {
      depth = -linearDepthFromTexture(depthMap, P, nearFar); // get linear depth from the depth buffer

      // estimate depth of the marching ray
      rayStartZ = prevEstimateZ;
      dDepth = -rayStartZ - depth;
      rayEndZ = (dQ.z * 0.5 + Q.z)/ ((dk * 0.5 + k));
      rayDiffZ = rayEndZ- rayStartZ;
      prevEstimateZ = rayEndZ;

      if(-rayEndZ > nearFar[1] || -rayEndZ < nearFar[0] || P.y < 0.0  || P.y > 1.0 )
      {
        return vec3(P, 0.);
      }

      // If we detect a hit - return the intersection point, two conditions:
      //  - dDepth > 0.0 - sampled point depth is in front of estimated depth
      //  - if difference between dDepth and rayDiffZOld is not too large
      //  - if difference between dDepth and 0.025/abs(k) is not too large
      //  - if the sampled depth is not behind far plane or in front of near plane

      if((dDepth) < 0.025/abs(k) + abs(rayDiffZ) && dDepth > 0.0 && depth > nearFar[0] && depth < nearFar[1] && abs(P.y - projectedCoordStart.y) > invResolutionHeight)
      {
        return vec3(P, depth);
      }

      // continue with ray marching
      P = clamp(P + dP, vec2(0.0), vec2(0.999));
      Q.z += dQ.z;
      k += dk;
      rayDiffZOld = rayDiffZ;
    }
    return vec3(P, 0.0);
  }
  `)}function Ja(t,e){t.include(Pn,e),t.include(Ll),t.include(zc),e.hasCloudsReflections&&t.include(ql,e),e.hasScreenSpaceReflections&&t.include(Uc,e);const r=t.fragment;r.constants.add("fresnelSky","vec3",[.02,1,15]).add("fresnelMaterial","vec2",[.02,.1]).add("roughness","float",.015).add("foamIntensityExternal","float",1.7).add("ssrIntensity","float",.65).add("ssrHeightFadeStart","float",3e5).add("ssrHeightFadeEnd","float",5e5).add("waterDiffusion","float",.92).add("waterSeaColorMod","float",.8).add("correctionViewingPowerFactor","float",.4).add("skyZenitColor","vec3",[.52,.68,.9]).add("skyColor","vec3",[.67,.79,.9]).add("cloudFresnelModifier","vec2",[1.2,.01]),r.code.add(g`PBRShadingWater shadingInfo;
vec3 getSkyGradientColor(in float cosTheta, in vec3 horizon, in vec3 zenit) {
float exponent = pow((1.0 - cosTheta), fresnelSky[2]);
return mix(zenit, horizon, exponent);
}`),r.uniforms.add(new Q("lightingSpecularStrength",(i,s)=>s.lighting.mainLight.specularStrength),new Q("lightingEnvironmentStrength",(i,s)=>s.lighting.mainLight.environmentStrength)),r.code.add(g`vec3 getSeaColor(in vec3 n, in vec3 v, in vec3 l, vec3 color, in vec3 lightIntensity, in vec3 localUp, in float shadow, float foamIntensity, vec3 viewPosition, vec3 position) {
float reflectionHit = 0.0;
float reflectionHitDiffused = 0.0;
vec3 seaWaterColor = linearizeGamma(color);
vec3 h = normalize(l + v);
shadingInfo.NdotL = clamp(dot(n, l), 0.0, 1.0);
shadingInfo.NdotV = clamp(dot(n, v), 0.001, 1.0);
shadingInfo.VdotN = clamp(dot(v, n), 0.001, 1.0);
shadingInfo.NdotH = clamp(dot(n, h), 0.0, 1.0);
shadingInfo.VdotH = clamp(dot(v, h), 0.0, 1.0);
shadingInfo.LdotH = clamp(dot(l, h), 0.0, 1.0);
float upDotV = max(dot(localUp,v), 0.0);
vec3 skyHorizon = linearizeGamma(skyColor);
vec3 skyZenit = linearizeGamma(skyZenitColor);
vec3 skyColor = getSkyGradientColor(upDotV, skyHorizon, skyZenit );
float upDotL = max(dot(localUp,l),0.0);
float daytimeMod = 0.1 + upDotL * 0.9;
skyColor *= daytimeMod;
float shadowModifier = clamp(shadow, 0.8, 1.0);
vec3 fresnelModifier = fresnelReflection(shadingInfo.VdotN, vec3(fresnelSky[0]), fresnelSky[1]);
vec3 reflSky = lightingEnvironmentStrength * fresnelModifier * skyColor * shadowModifier;
vec3 reflSea = seaWaterColor * mix(skyColor, upDotL * lightIntensity * LIGHT_NORMALIZATION, 2.0 / 3.0) * shadowModifier;
vec3 specular = vec3(0.0);
if(upDotV > 0.0 && upDotL > 0.0) {
vec3 specularSun = brdfSpecularWater(shadingInfo, roughness, vec3(fresnelMaterial[0]), fresnelMaterial[1]);
vec3 incidentLight = lightIntensity * LIGHT_NORMALIZATION * shadow;
specular = lightingSpecularStrength * shadingInfo.NdotL * incidentLight * specularSun;
}
vec3 foam = vec3(0.0);
if(upDotV > 0.0) {
foam = foamIntensity2FoamColor(foamIntensityExternal, foamIntensity, skyZenitColor, daytimeMod);
}
float correctionViewingFactor = pow(max(dot(v, localUp), 0.0), correctionViewingPowerFactor);
vec3 normalCorrectedClouds = mix(localUp, n, correctionViewingFactor);
vec3 reflectedWorld = normalize(reflect(-v, normalCorrectedClouds));`),e.hasCloudsReflections&&r.code.add(g`vec4 cloudsColor = renderClouds(reflectedWorld, position);
cloudsColor.a = 1.0 - cloudsColor.a;
cloudsColor = pow(cloudsColor, vec4(GAMMA));
cloudsColor *= clamp(fresnelModifier.y * cloudFresnelModifier[0] - cloudFresnelModifier[1], 0.0, 1.0) * clamp((1.0 - totalFadeInOut), 0.0, 1.0);`),e.hasScreenSpaceReflections?(r.uniforms.add(new Jt("view",(i,s)=>s.camera.viewMatrix),new Ve("lastFrameColorTexture",(i,s)=>{var a;return(a=s.ssr.lastFrameColor)==null?void 0:a.colorTexture}),new Q("fadeFactorSSR",(i,s)=>s.ssr.fadeFactor)),r.code.add(g`vec3 viewDir = normalize(viewPosition);
vec4 viewNormalVectorCoordinate = view *vec4(n, 0.0);
vec3 viewNormal = normalize(viewNormalVectorCoordinate.xyz);
vec4 viewUp = view * vec4(localUp, 0.0);
vec3 viewNormalCorrectedSSR = mix(viewUp.xyz, viewNormal, correctionViewingFactor);
vec3 reflected = normalize(reflect(viewDir, viewNormalCorrectedSSR));
vec3 hitCoordinate = screenSpaceIntersection(reflected, viewPosition, viewDir, viewUp.xyz);
vec3 reflectedColor = vec3(0.0);
if (hitCoordinate.z > 0.0)
{
vec2 reprojectedCoordinate = reprojectionCoordinate(hitCoordinate);
vec2 dCoords = smoothstep(0.3, 0.6, abs(vec2(0.5, 0.5) - hitCoordinate.xy));
float heightMod = smoothstep(ssrHeightFadeEnd, ssrHeightFadeStart, -viewPosition.z);
reflectionHit = clamp(1.0 - (1.3 * dCoords.y), 0.0, 1.0) * heightMod * fadeFactorSSR;
reflectionHitDiffused = waterDiffusion * reflectionHit;
reflectedColor = linearizeGamma(texture(lastFrameColorTexture, reprojectedCoordinate).xyz) *
reflectionHitDiffused * fresnelModifier.y * ssrIntensity;
}
float seaColorMod =  mix(waterSeaColorMod, waterSeaColorMod * 0.5, reflectionHitDiffused);
vec3 waterRenderedColor = tonemapACES((1.0 - reflectionHitDiffused) * reflSky + reflectedColor +
reflSea * seaColorMod + specular + foam);`)):r.code.add(g`vec3 waterRenderedColor = tonemapACES(reflSky + reflSea * waterSeaColorMod + specular + foam);`),e.hasCloudsReflections?e.hasScreenSpaceReflections?r.code.add(g`return waterRenderedColor * (1.0 - (1.0 - reflectionHit) * cloudsColor.a) + (1.0 - reflectionHit) * cloudsColor.xyz;
}`):r.code.add(g`return waterRenderedColor * (1.0 - cloudsColor.a) + cloudsColor.xyz;
}`):r.code.add(g`return waterRenderedColor;
}`)}let js=class extends zi{constructor(e,r){super(e,"vec4",Ta.Draw,(i,s,a)=>i.setUniform4fv(e,r(s,a)))}};var Wt;function Ku(t,e){const{vertex:r,fragment:i}=t;r.uniforms.add(new js("overlayTexOffset",(s,a)=>Wc(s,a)),new js("overlayTexScale",(s,a)=>Hc(s,a))),i.constants.add("overlayOpacity","float",1),i.uniforms.add(new Ve("ovColorTex",(s,a)=>Vc(s,a))),Qa(t,e)}function ep(t,e){const{vertex:r,fragment:i}=t;r.uniforms.add(new zs("overlayTexOffset"),new zs("overlayTexScale")),i.uniforms.add(new Q("overlayOpacity",s=>s.overlayOpacity),new Ve("ovColorTex",(s,a)=>{var o;return(o=a.overlay)==null?void 0:o.getTexture(s.overlayContent)})),Qa(t,e)}(function(t){t[t.Disabled=0]="Disabled",t[t.Enabled=1]="Enabled",t[t.EnabledWithWater=2]="EnabledWithWater",t[t.COUNT=3]="COUNT"})(Wt||(Wt={}));let zs=class extends zi{constructor(e){super(e,"vec4")}};function Qa(t,e){e.pbrMode!==qe.Water&&e.pbrMode!==qe.WaterOnIntegratedMesh&&e.pbrMode!==qe.TerrainWithWater||t.include(Ja,e);const{vertex:r,fragment:i}=t;t.varyings.add("vtcOverlay","vec4"),r.code.add(g`void setOverlayVTC(in vec2 uv) {
vtcOverlay = vec4(uv, uv) * overlayTexScale + overlayTexOffset;
}`),i.code.add(g`bool isValid(vec2 uv, vec2 dxdy) {
return (uv.x >= 0.0 + dxdy.x) && (uv.x <= 1.0 - dxdy.x) && (uv.y >= 0.0 + dxdy.y) && (uv.y <= 1.0 - dxdy.y);
}
vec4 getOverlayColor(sampler2D ov0Tex, vec4 texCoords) {
vec4 color0 = texture(ov0Tex, vec2(texCoords.x * 0.5, texCoords.y));
vec4 color1 = texture(ov0Tex, vec2(texCoords.z * 0.5 + 0.5, texCoords.w));
bool isValid0 = isValid(texCoords.xy, fwidth(texCoords.xy));
bool isValid1 = isValid(texCoords.zw, vec2(0.0, 0.0));
return mix(color1 * float(isValid1), color0, float(isValid0));
}`),i.code.add(g`vec4 getCombinedOverlayColor() {
return overlayOpacity * getOverlayColor(ovColorTex, vtcOverlay);
}`),i.code.add(g`vec4 getOverlayColorTexel(vec4 texCoords) {
vec2 texDim =  vec2(textureSize(ovColorTex, 0));
vec4 color0 = texelFetch(ovColorTex, ivec2(vec2(texCoords.x * 0.5, texCoords.y) * texDim), 0);
vec4 color1 = texelFetch(ovColorTex, ivec2(vec2(texCoords.z * 0.5 + 0.5, texCoords.w) * texDim), 0);
bool isValid0 = isValid(texCoords.xy, fwidth(texCoords.xy));
bool isValid1 = isValid(texCoords.zw, vec2(0.0, 0.0));
return mix(color1 * float(isValid1), color0, float(isValid0));
}`),e.pbrMode!==qe.Water&&e.pbrMode!==qe.WaterOnIntegratedMesh&&e.pbrMode!==qe.TerrainWithWater||(Ui(i),Vi(i),i.code.add(g`vec4 getOverlayWaterColor(vec4 maskInput, vec4 colorInput, vec3 vposEyeDir,
float shadow, vec3 localUp, mat3 tbn, vec3 position, vec3 positionWorld) {
vec3 n = normalize(tbn *  (2.0 * maskInput.rgb - vec3(1.0)));
vec3 v = vposEyeDir;
vec3 final = getSeaColor(n, v, mainLightDirection, colorInput.rgb, mainLightIntensity, localUp, 1.0 - shadow, maskInput.w, position, positionWorld);
return vec4(final, colorInput.w);
}`))}function Vc(t,e){var r,i,s;return t.identifier===Ye.Material&&t.output===O.Color?(r=e.overlay)==null?void 0:r.getTexture(ae.ColorNoRasterImage):t.identifier===Ye.Material&&t.output===O.ObjectAndLayerIdColor?(i=e.overlay)==null?void 0:i.getTexture(ae.ObjectAndLayerIdColor):t.identifier===Ye.Highlight?(s=e.overlay)==null?void 0:s.getTexture(ae.Highlight):null}function Wc(t,e){var s,a,o,n;const r=(a=(s=e.overlay)==null?void 0:s.overlays[Oe.INNER])==null?void 0:a.extent;Vr(r)&&(Ne[0]=t.toMapSpace[0]/Nt(r)-r[0]/Nt(r),Ne[1]=t.toMapSpace[1]/jt(r)-r[1]/jt(r));const i=(n=(o=e.overlay)==null?void 0:o.overlays[Oe.OUTER])==null?void 0:n.extent;return Vr(i)&&(Ne[2]=t.toMapSpace[0]/Nt(i)-i[0]/Nt(i),Ne[3]=t.toMapSpace[1]/jt(i)-i[1]/jt(i)),Ne}function Hc(t,e){var s,a,o,n;const r=(a=(s=e.overlay)==null?void 0:s.overlays[Oe.INNER])==null?void 0:a.extent;Vr(r)&&(Ne[0]=t.toMapSpace[2]/Nt(r),Ne[1]=t.toMapSpace[3]/jt(r));const i=(n=(o=e.overlay)==null?void 0:o.overlays[Oe.OUTER])==null?void 0:n.extent;return Vr(i)&&(Ne[2]=t.toMapSpace[2]/Nt(i),Ne[3]=t.toMapSpace[3]/jt(i)),Ne}const Ne=ze();let Ya=class extends Pa{constructor(){super(...arguments),this.color=cr(1,1,1,1)}};function Gc(){const t=new ei;return t.include(ba),t.fragment.uniforms.add(new Ve("tex",e=>e.texture),new ut("uColor",e=>e.color)),t.fragment.code.add(g`void main() {
vec4 texColor = texture(tex, uv);
fragColor = texColor * uColor;
}`),t}const Bc=Object.freeze(Object.defineProperty({__proto__:null,TextureOnlyPassParameters:Ya,build:Gc},Symbol.toStringTag,{value:"Module"}));let kc=class{constructor(e){this._context=e,this._perConstructorInstances=new Bi,this._frameCounter=0,this._keepAliveFrameCount=Us}get viewingMode(){return this._context.viewingMode}get constructionContext(){return this._context}destroy(){this._perConstructorInstances.forEach(e=>e.forEach(r=>r.technique.destroy())),this._perConstructorInstances.clear()}acquire(e,r=Zc){const i=r.key;let s=this._perConstructorInstances.get(e,i);if(s==null){const a=new e(this._context,r,()=>this.release(a));s=new qc(a),this._perConstructorInstances.set(e,i,s)}return++s.refCount,s.technique}releaseAndAcquire(e,r,i){if(i!=null){if(r.key===i.key)return i;this.release(i)}return this.acquire(e,r)}release(e){if(e==null||this._perConstructorInstances.empty)return;const r=this._perConstructorInstances.get(e.constructor,e.key);r!=null&&(--r.refCount,r.refCount===0&&(r.refZeroFrame=this._frameCounter))}frameUpdate(){this._frameCounter++,this._keepAliveFrameCount!==Us&&this._perConstructorInstances.forEach((e,r)=>{e.forEach((i,s)=>{i.refCount===0&&i.refZeroFrame+this._keepAliveFrameCount<this._frameCounter&&(i.technique.destroy(),this._perConstructorInstances.delete(r,s))})})}async reloadAll(){const e=new Array;this._perConstructorInstances.forEach((r,i)=>{const s=async(a,o)=>{const n=o.shader;n&&(await n.reload(),a.forEach(c=>c.technique.reload(this._context)))};e.push(s(r,i))}),await Promise.all(e)}},qc=class{constructor(e){this.technique=e,this.refCount=0,this.refZeroFrame=0}};const Us=-1,Zc=new Ia;let Jc=class{constructor(e,r,i,s){this._textureRepository=e,this._techniqueRepository=r,this.materialChanged=i,this.requestRender=s,this._id2glMaterialRef=new Bi}dispose(){this._textureRepository.destroy()}acquire(e,r,i){if(this._ownMaterial(e),!e.produces(r,i))return null;let s=this._id2glMaterialRef.get(i,e.id);if(s==null){const a=e.createGLMaterial({material:e,techniqueRep:this._techniqueRepository,textureRepository:this._textureRepository,output:i});s=new Qc(a),this._id2glMaterialRef.set(i,e.id,s)}return s.ref(),s.glMaterial}release(e,r){const i=this._id2glMaterialRef.get(r,e.id);i!=null&&(i.unref(),i.referenced||(Gt(i.glMaterial),this._id2glMaterialRef.delete(r,e.id)))}_ownMaterial(e){e.repository&&e.repository!==this&&Yr.getLogger("esri.views.3d.webgl-engine.lib.GLMaterialRepository").error("Material is already owned by a different material repository"),e.repository=this}},Qc=class{constructor(e){this.glMaterial=e,this._refCnt=0}ref(){++this._refCnt}unref(){--this._refCnt,me(this._refCnt>=0)}get referenced(){return this._refCnt>0}};const Yc=["layerObjectAdded","layerObjectRemoved","layerObjectsAdded","layerObjectsRemoved","transformationChanged","shaderTransformationChanged","visibilityChanged","occlusionChanged","highlightChanged","geometryAdded","geometryRemoved","attributesChanged"];var ur;(function(t){t[t.ASYNC=0]="ASYNC",t[t.SYNC=1]="SYNC"})(ur||(ur={}));let Xc=class extends _a{get objects(){return this._objects}constructor(e,r,i=""){super(),this.stage=e,this.apiLayerUid=i,this.type=Qt.Layer,this.events=new xa,this.visible=!0,this.pickable=!0,this.sliceable=!1,this._objects=new Ae,this._objectsAdded=new Ae,this._handles=new dn,this.apiLayerUid=i,this.visible=(r==null?void 0:r.visible)??!0,this.pickable=(r==null?void 0:r.pickable)??!0,this.updatePolicy=(r==null?void 0:r.updatePolicy)??ur.ASYNC,this._disableOctree=(r==null?void 0:r.disableOctree)??!1,e.add(this);for(const s of Yc)this._handles.add(this.events.on(s,a=>e.handleEvent(s,a)))}destroy(){this._handles.size&&(this._handles.destroy(),this.stage.remove(this),this.invalidateSpatialQueryAccelerator())}add(e){this._objects.push(e),e.parentLayer=this,this.events.emit("layerObjectAdded",{layer:this,object:e}),this._octree!=null&&this._objectsAdded.push(e)}remove(e){this._objects.removeUnordered(e)&&(e.parentLayer=null,this.events.emit("layerObjectRemoved",{layer:this,object:e}),this._octree!=null&&(this._objectsAdded.removeUnordered(e)||this._octree.remove([e])))}addMany(e){this._objects.pushArray(e);for(const r of e)r.parentLayer=this;this.events.emit("layerObjectsAdded",{layer:this,objects:e}),this._octree!=null&&this._objectsAdded.pushArray(e)}removeMany(e){const r=new Array;if(this._objects.removeUnorderedMany(e,e.length,r),r.length!==0){for(const i of r)i.parentLayer=null;if(this.events.emit("layerObjectsRemoved",{layer:this,objects:r}),this._octree!=null){for(let i=0;i<r.length;)this._objectsAdded.removeUnordered(r[i])?(r[i]=r[r.length-1],r.length-=1):++i;this._octree.remove(r)}}}sync(){this.updatePolicy!==ur.SYNC&&this.stage.syncLayer(this.id)}notifyObjectBBChanged(e,r){this._octree==null||this._objectsAdded.includes(e)||this._octree.update(e,r)}getSpatialQueryAccelerator(){return this._octree==null&&this._objects.length>50&&!this._disableOctree?(this._octree=new Sl(e=>e.boundingVolumeWorldSpace.bounds),this._octree.add(this._objects.data,this._objects.length)):this._octree!=null&&this._objectsAdded.length>0&&(this._octree.add(this._objectsAdded.data,this._objectsAdded.length),this._objectsAdded.clear()),this._octree}invalidateSpatialQueryAccelerator(){this._octree=Ca(this._octree),this._objectsAdded.clear()}};function lp(t){return t!=null&&t.type===Qt.Layer}var gt,pr;(function(t){t[t.Draped=0]="Draped",t[t.Screen=1]="Screen",t[t.World=2]="World",t[t.COUNT=3]="COUNT"})(gt||(gt={})),function(t){t[t.Center=0]="Center",t[t.Tip=1]="Tip",t[t.COUNT=2]="COUNT"}(pr||(pr={}));let ie=class extends Wi{constructor(){super(...arguments),this.output=O.Color,this.transparencyPassType=ye.NONE,this.occluder=!1,this.hasSlicePlane=!1,this.writeDepth=!1,this.space=gt.Screen,this.hideOnShortSegments=!1,this.hasCap=!1,this.anchor=pr.Center,this.hasTip=!1,this.vvSize=!1,this.vvColor=!1,this.vvOpacity=!1,this.hasOccludees=!1,this.multipassEnabled=!1,this.cullAboveGround=!1}get draped(){return this.space===gt.Draped}};m([D({count:O.COUNT})],ie.prototype,"output",void 0),m([D({count:ye.COUNT})],ie.prototype,"transparencyPassType",void 0),m([D()],ie.prototype,"occluder",void 0),m([D()],ie.prototype,"hasSlicePlane",void 0),m([D()],ie.prototype,"writeDepth",void 0),m([D({count:gt.COUNT})],ie.prototype,"space",void 0),m([D()],ie.prototype,"hideOnShortSegments",void 0),m([D()],ie.prototype,"hasCap",void 0),m([D({count:pr.COUNT})],ie.prototype,"anchor",void 0),m([D()],ie.prototype,"hasTip",void 0),m([D()],ie.prototype,"vvSize",void 0),m([D()],ie.prototype,"vvColor",void 0),m([D()],ie.prototype,"vvOpacity",void 0),m([D()],ie.prototype,"hasOccludees",void 0),m([D()],ie.prototype,"multipassEnabled",void 0),m([D()],ie.prototype,"cullAboveGround",void 0),m([D({constValue:!1})],ie.prototype,"occlusionPass",void 0),m([D({constValue:!0})],ie.prototype,"hasVvInstancing",void 0),m([D({constValue:!0})],ie.prototype,"hasSliceTranslatedView",void 0);const Vs=8;function Kc(t,e){const r=t.vertex;r.uniforms.add(new Q("intrinsicWidth",i=>i.width)),e.vvSize?(t.attributes.add(f.SIZEFEATUREATTRIBUTE,"float"),r.uniforms.add(new zt("vvSizeMinSize",i=>i.vvSize.minSize),new zt("vvSizeMaxSize",i=>i.vvSize.maxSize),new zt("vvSizeOffset",i=>i.vvSize.offset),new zt("vvSizeFactor",i=>i.vvSize.factor)),r.code.add(g`float getSize() {
return intrinsicWidth * clamp(vvSizeOffset + sizeFeatureAttribute * vvSizeFactor, vvSizeMinSize, vvSizeMaxSize).x;
}`)):(t.attributes.add(f.SIZE,"float"),r.code.add(g`float getSize(){
return intrinsicWidth * size;
}`)),e.vvOpacity?(t.attributes.add(f.OPACITYFEATUREATTRIBUTE,"float"),r.constants.add("vvOpacityNumber","int",8),r.uniforms.add(new ws("vvOpacityValues",i=>i.vvOpacity.values,Vs),new ws("vvOpacityOpacities",i=>i.vvOpacity.opacityValues,Vs)),r.code.add(g`float interpolateOpacity( float value ){
if (value <= vvOpacityValues[0]) {
return vvOpacityOpacities[0];
}
for (int i = 1; i < vvOpacityNumber; ++i) {
if (vvOpacityValues[i] >= value) {
float f = (value - vvOpacityValues[i-1]) / (vvOpacityValues[i] - vvOpacityValues[i-1]);
return mix(vvOpacityOpacities[i-1], vvOpacityOpacities[i], f);
}
}
return vvOpacityOpacities[vvOpacityNumber - 1];
}
vec4 applyOpacity( vec4 color ){
return vec4(color.xyz, interpolateOpacity(opacityFeatureAttribute));
}`)):r.code.add(g`vec4 applyOpacity( vec4 color ){
return color;
}`),e.vvColor?(t.include(In,e),t.attributes.add(f.COLORFEATUREATTRIBUTE,"float"),r.code.add(g`vec4 getColor(){
return applyOpacity(interpolateVVColor(colorFeatureAttribute));
}`)):(t.attributes.add(f.COLOR,"vec4"),r.code.add(g`vec4 getColor(){
return applyOpacity(color);
}`))}let ed=class{constructor(e,r,i){this._createTexture=e,this._parametersKey=r,this._repository=new Map,this._orphanCache=i.newCache(`procedural-texture-repository:${ji()}`,s=>s.dispose())}destroy(){for(const[e,{texture:r}]of this._repository)r.dispose();this._repository.clear(),this._orphanCache.destroy()}swap(e,r=null){const i=this._acquire(e);return this.release(r),i}release(e){if(e==null)return;const r=this._parametersKey(e),i=this._repository.get(r);if(i&&(i.refCount--,i.refCount===0)){this._repository.delete(r);const{texture:s}=i,a=s.gpuMemoryUsage;this._orphanCache.put(r,s,a)}}_acquire(e){if(e==null)return null;const r=this._parametersKey(e),i=this._repository.get(r);if(i)return i.refCount++,i.texture;const s=this._orphanCache.pop(r)??this._createTexture(e),a=new td(s);return this._repository.set(r,a),s}},td=class{constructor(e){this.texture=e,this.refCount=1}};function up(t,e){return new ed(r=>{const{encodedData:i,textureSize:s}=rd(r),a=new vr;return a.internalFormat=Fa.RGBA,a.width=s,a.height=1,a.wrapMode=Hr.REPEAT,new mt(t,a,i)},r=>`${r.pattern.join(",")}-r${r.pixelRatio}`,e)}function rd(t){const e=Yi(t),r=1/t.pixelRatio,i=Xa(t),s=Ka(t),a=(Math.floor(.5*(s-1))+.5)*r,o=[];let n=1;for(const p of e){for(let u=0;u<p;u++){const v=n*(Math.min(u,p-1-u)+.5)*r/a*.5+.5;o.push(v)}n=-n}const c=Math.round(e[0]/2),l=[...o.slice(c),...o.slice(0,c)],d=new Uint8Array(4*i);let h=0;for(const p of l)Va(p,d,h),h+=4;return{encodedData:d,textureSize:i}}function Yi(t){return t.pattern.map(e=>Math.round(e*t.pixelRatio))}function Xa(t){if(t==null)return 1;const e=Yi(t);return Math.floor(e.reduce((r,i)=>r+i))}function Ka(t){return Yi(t).reduce((e,r)=>Math.max(e,r))}function id(t){return t==null?hn:t.length===4?t:dr(sd,t[0],t[1],t[2],1)}const sd=ze();function ad(t,e){t.constants.add("stippleAlphaColorDiscard","float",.001),t.constants.add("stippleAlphaHighlightDiscard","float",.5),e.stippleEnabled?od(t,e):nd(t)}function od(t,e){const r=!(e.draped&&e.stipplePreferContinuous),{vertex:i,fragment:s}=t;s.include(Ln),e.draped||(Oa(i,e),i.uniforms.add(new Q("worldToScreenPerDistanceRatio",(a,o)=>1/o.camera.perScreenPixelRatio)),i.code.add(g`float computeWorldToScreenRatio(vec3 segmentCenter) {
float segmentDistanceToCamera = length(segmentCenter - cameraPosition);
return worldToScreenPerDistanceRatio / segmentDistanceToCamera;
}`)),t.varyings.add("vStippleDistance","float"),t.varyings.add("vStippleDistanceLimits","vec2"),t.varyings.add("vStipplePatternStretch","float"),i.code.add(g`
    float discretizeWorldToScreenRatio(float worldToScreenRatio) {
      float step = ${cd};

      float discreteWorldToScreenRatio = log(worldToScreenRatio);
      discreteWorldToScreenRatio = ceil(discreteWorldToScreenRatio / step) * step;
      discreteWorldToScreenRatio = exp(discreteWorldToScreenRatio);
      return discreteWorldToScreenRatio;
    }
  `),i.code.add(g`vec2 computeStippleDistanceLimits(float startPseudoScreen, float segmentLengthPseudoScreen, float segmentLengthScreen, float patternLength) {`),i.code.add(g`
    if (segmentLengthPseudoScreen >= ${r?"patternLength":"1e4"}) {
  `),Hi(i),i.code.add(g`float repetitions = segmentLengthScreen / (patternLength * pixelRatio);
float flooredRepetitions = max(1.0, floor(repetitions + 0.5));
float segmentLengthScreenRounded = flooredRepetitions * patternLength;
float stretch = repetitions / flooredRepetitions;
vStipplePatternStretch = max(0.75, stretch);
return vec2(0.0, segmentLengthScreenRounded);
}
return vec2(startPseudoScreen, startPseudoScreen + segmentLengthPseudoScreen);
}`),s.uniforms.add(new Ve("stipplePatternTexture",a=>a.stippleTexture),new Q("stipplePatternSDFNormalizer",a=>ld(a.stipplePattern)),new Q("stipplePatternPixelSizeInv",a=>1/eo(a))),s.code.add(g`float getStippleSDF(out bool isClamped) {
float stippleDistanceClamped = clamp(vStippleDistance, vStippleDistanceLimits.x, vStippleDistanceLimits.y);
vec2 aaCorrectedLimits = vStippleDistanceLimits + vec2(1.0, -1.0) / gl_FragCoord.w;
isClamped = vStippleDistance < aaCorrectedLimits.x || vStippleDistance > aaCorrectedLimits.y;
float u = stippleDistanceClamped * gl_FragCoord.w * stipplePatternPixelSizeInv * vLineSizeInv;
u = fract(u);
float encodedSDF = rgba2float(texture(stipplePatternTexture, vec2(u, 0.5)));
float sdf = (encodedSDF * 2.0 - 1.0) * stipplePatternSDFNormalizer;
return (sdf - 0.5) * vStipplePatternStretch + 0.5;
}
float getStippleSDF() {
bool ignored;
return getStippleSDF(ignored);
}
float getStippleAlpha() {
bool isClamped;
float stippleSDF = getStippleSDF(isClamped);
float antiAliasedResult = clamp(stippleSDF * vLineWidth + 0.5, 0.0, 1.0);
return isClamped ? floor(antiAliasedResult + 0.5) : antiAliasedResult;
}`),e.stippleOffColorEnabled?(s.uniforms.add(new ut("stippleOffColor",a=>id(a.stippleOffColor))),s.code.add(g`#define discardByStippleAlpha(stippleAlpha, threshold) {}
#define blendStipple(color, stippleAlpha) mix(color, stippleOffColor, stippleAlpha)`)):s.code.add(g`#define discardByStippleAlpha(stippleAlpha, threshold) if (stippleAlpha < threshold) { discard; }
#define blendStipple(color, stippleAlpha) vec4(color.rgb, color.a * stippleAlpha)`)}function nd(t){t.fragment.code.add(g`float getStippleAlpha() { return 1.0; }
#define discardByStippleAlpha(_stippleAlpha_, _threshold_) {}
#define blendStipple(color, _stippleAlpha_) color`)}function ld(t){return t?(Math.floor(.5*(Ka(t)-1))+.5)/t.pixelRatio:1}function eo(t){const e=t.stipplePattern;return e?Xa(t.stipplePattern)/e.pixelRatio:1}const cd=g.float(.4),to=128,ro=.5;function pp(t){return t==="cross"||t==="x"}function fp(t,e=to,r=e*ro,i=0){const s=io(t,e,r,i);return new Fn(s,{mipmap:!1,wrap:{s:Hr.CLAMP_TO_EDGE,t:Hr.CLAMP_TO_EDGE},width:e,height:e,components:4,noUnpackFlip:!0,reloadable:!0})}function io(t,e=to,r=e*ro,i=0){switch(t){case"circle":default:return dd(e,r);case"square":return hd(e,r);case"cross":return pd(e,r,i);case"x":return fd(e,r,i);case"kite":return ud(e,r);case"triangle":return md(e,r);case"arrow":return gd(e,r)}}function dd(t,e){const r=t/2-.5;return _r(t,oo(r,r,e/2))}function hd(t,e){return so(t,e,!1)}function ud(t,e){return so(t,e,!0)}function pd(t,e,r=0){return ao(t,e,!1,r)}function fd(t,e,r=0){return ao(t,e,!0,r)}function md(t,e){return _r(t,no(t/2,e,e/2))}function gd(t,e){const r=e,i=e/2,s=t/2,a=.8*r,o=oo(s,(t-e)/2-a,Math.sqrt(a*a+i*i)),n=no(s,r,i);return _r(t,(c,l)=>Math.max(n(c,l),-o(c,l)))}function so(t,e,r){return r&&(e/=Math.SQRT2),_r(t,(i,s)=>{let a=i-.5*t+.25,o=.5*t-s-.75;if(r){const n=(a+o)/Math.SQRT2;o=(o-a)/Math.SQRT2,a=n}return Math.max(Math.abs(a),Math.abs(o))-.5*e})}function ao(t,e,r,i=0){e-=i,r&&(e*=Math.SQRT2);const s=.5*e;return _r(t,(a,o)=>{let n,c=a-.5*t,l=.5*t-o-1;if(r){const d=(c+l)/Math.SQRT2;l=(l-c)/Math.SQRT2,c=d}return c=Math.abs(c),l=Math.abs(l),n=c>l?c>s?Math.sqrt((c-s)*(c-s)+l*l):l:l>s?Math.sqrt(c*c+(l-s)*(l-s)):c,n-=i/2,n})}function oo(t,e,r){return(i,s)=>{const a=i-t,o=s-e;return Math.sqrt(a*a+o*o)-r}}function no(t,e,r){const i=Math.sqrt(e*e+r*r);return(s,a)=>{const o=Math.abs(s-t)-r,n=a-t+e/2+.75,c=(e*o+r*n)/i,l=-n;return Math.max(c,l)}}function _r(t,e){const r=new Uint8Array(4*t*t);for(let i=0;i<t;i++)for(let s=0;s<t;s++){const a=s+t*i;let o=e(s,i);o=o/t+.5,Va(o,r,4*a)}return r}const or=64,lo=or/2,co=lo/5,vd=or/co,mp=.25;function gp(t,e){const r=io(t,or,lo,co),i=new vr;return i.internalFormat=Fa.RGBA,i.width=or,i.height=or,i.wrapMode=Hr.CLAMP_TO_EDGE,new mt(e,i,r)}function _d(t,e){const{vertex:r,constants:i}=t;i.add("markerSizePerLineWidth","float",vd),Hi(r),r.uniforms.get("markerScale")==null&&r.constants.add("markerScale","float",1),r.code.add(g`float getLineWidth() {
return max(getSize(), 1.0) * pixelRatio;
}
float getScreenMarkerSize() {
return markerSizePerLineWidth * markerScale * getLineWidth();
}`),e.space===gt.World&&(r.constants.add("maxSegmentLengthFraction","float",.45),r.uniforms.add(new Q("perRenderPixelRatio",(s,a)=>a.camera.perRenderPixelRatio)),r.code.add(g`bool areWorldMarkersHidden(vec4 pos, vec4 other) {
vec3 midPoint = mix(pos.xyz, other.xyz, 0.5);
float distanceToCamera = length(midPoint);
float screenToWorldRatio = perRenderPixelRatio * distanceToCamera * 0.5;
float worldMarkerSize = getScreenMarkerSize() * screenToWorldRatio;
float segmentLen = length(pos.xyz - other.xyz);
return worldMarkerSize > maxSegmentLengthFraction * segmentLen;
}
float getWorldMarkerSize(vec4 pos) {
float distanceToCamera = length(pos.xyz);
float screenToWorldRatio = perRenderPixelRatio * distanceToCamera * 0.5;
return getScreenMarkerSize() * screenToWorldRatio;
}`))}var vt;(function(t){t[t.BUTT=0]="BUTT",t[t.SQUARE=1]="SQUARE",t[t.ROUND=2]="ROUND",t[t.COUNT=3]="COUNT"})(vt||(vt={}));let H=class extends Wi{constructor(){super(...arguments),this.output=O.Color,this.capType=vt.BUTT,this.transparencyPassType=ye.NONE,this.occluder=!1,this.hasSlicePlane=!1,this.hasPolygonOffset=!1,this.writeDepth=!1,this.draped=!1,this.stippleEnabled=!1,this.stippleOffColorEnabled=!1,this.stipplePreferContinuous=!0,this.roundJoins=!1,this.applyMarkerOffset=!1,this.vvSize=!1,this.vvColor=!1,this.vvOpacity=!1,this.falloffEnabled=!1,this.innerColorEnabled=!1,this.hasOccludees=!1,this.multipassEnabled=!1,this.cullAboveGround=!1,this.wireframe=!1,this.objectAndLayerIdColorInstanced=!1}};m([D({count:O.COUNT})],H.prototype,"output",void 0),m([D({count:vt.COUNT})],H.prototype,"capType",void 0),m([D({count:ye.COUNT})],H.prototype,"transparencyPassType",void 0),m([D()],H.prototype,"occluder",void 0),m([D()],H.prototype,"hasSlicePlane",void 0),m([D()],H.prototype,"hasPolygonOffset",void 0),m([D()],H.prototype,"writeDepth",void 0),m([D()],H.prototype,"draped",void 0),m([D()],H.prototype,"stippleEnabled",void 0),m([D()],H.prototype,"stippleOffColorEnabled",void 0),m([D()],H.prototype,"stipplePreferContinuous",void 0),m([D()],H.prototype,"roundJoins",void 0),m([D()],H.prototype,"applyMarkerOffset",void 0),m([D()],H.prototype,"vvSize",void 0),m([D()],H.prototype,"vvColor",void 0),m([D()],H.prototype,"vvOpacity",void 0),m([D()],H.prototype,"falloffEnabled",void 0),m([D()],H.prototype,"innerColorEnabled",void 0),m([D()],H.prototype,"hasOccludees",void 0),m([D()],H.prototype,"multipassEnabled",void 0),m([D()],H.prototype,"cullAboveGround",void 0),m([D()],H.prototype,"wireframe",void 0),m([D()],H.prototype,"objectAndLayerIdColorInstanced",void 0),m([D({constValue:!1})],H.prototype,"occlusionPass",void 0),m([D({constValue:!0})],H.prototype,"hasVvInstancing",void 0),m([D({constValue:!0})],H.prototype,"hasSliceTranslatedView",void 0);const qr=1;function yd(t){const e=new ei,{vertex:r,fragment:i}=e,s=t.multipassEnabled&&(t.output===O.Color||t.output===O.Alpha);e.include(Nn),e.include(Kc,t),e.include(ad,t);const a=t.applyMarkerOffset&&!t.draped;a&&(r.uniforms.add(new Q("markerScale",u=>u.markerScale)),e.include(_d,{space:gt.World,draped:!1})),t.output===O.Depth&&e.include(jn,t),e.include(Da,t),Aa(r,t),r.uniforms.add(new Jt("inverseProjectionMatrix",(u,v)=>v.camera.inverseProjectionMatrix),new Kr("nearFar",(u,v)=>v.camera.nearFar),new Q("miterLimit",u=>u.join!=="miter"?0:u.miterLimit),new ut("viewport",(u,v)=>v.camera.fullViewport)),r.constants.add("LARGE_HALF_FLOAT","float",65500),e.attributes.add(f.POSITION,"vec3"),e.attributes.add(f.SUBDIVISIONFACTOR,"float"),e.attributes.add(f.UV0,"vec2"),e.attributes.add(f.AUXPOS1,"vec3"),e.attributes.add(f.AUXPOS2,"vec3"),e.varyings.add("vColor","vec4"),e.varyings.add("vpos","vec3"),zn(e),s&&e.varyings.add("depth","float");const o=t.stippleEnabled;o&&e.varyings.add("vLineSizeInv","float");const n=t.capType===vt.ROUND,c=o||n;c&&e.varyings.add("vLineWidth","float");const l=t.innerColorEnabled||n;l&&e.varyings.add("vLineDistance","float");const d=t.stippleEnabled&&n,h=t.falloffEnabled||d;h&&e.varyings.add("vLineDistanceNorm","float"),n&&(e.varyings.add("vSegmentSDF","float"),e.varyings.add("vReverseSegmentSDF","float")),r.code.add(g`#define PERPENDICULAR(v) vec2(v.y, -v.x);
float interp(float ncp, vec4 a, vec4 b) {
return (-ncp - a.z) / (b.z - a.z);
}
vec2 rotate(vec2 v, float a) {
float s = sin(a);
float c = cos(a);
mat2 m = mat2(c, -s, s, c);
return m * v;
}`),r.code.add(g`vec4 projectAndScale(vec4 pos) {
vec4 posNdc = proj * pos;
posNdc.xy *= viewport.zw / posNdc.w;
return posNdc;
}`),Un(e),r.code.add(g`
    void clipAndTransform(inout vec4 pos, inout vec4 prev, inout vec4 next, in bool isStartVertex) {
      float vnp = nearFar[0] * 0.99;

      if(pos.z > -nearFar[0]) {
        //current pos behind ncp --> we need to clip
        if (!isStartVertex) {
          if(prev.z < -nearFar[0]) {
            //previous in front of ncp
            pos = mix(prev, pos, interp(vnp, prev, pos));
            next = pos;
          } else {
            pos = vec4(0.0, 0.0, 0.0, 1.0);
          }
        } else {
          if(next.z < -nearFar[0]) {
            //next in front of ncp
            pos = mix(pos, next, interp(vnp, pos, next));
            prev = pos;
          } else {
            pos = vec4(0.0, 0.0, 0.0, 1.0);
          }
        }
      } else {
        //current position visible
        if (prev.z > -nearFar[0]) {
          //previous behind ncp
          prev = mix(pos, prev, interp(vnp, pos, prev));
        }
        if (next.z > -nearFar[0]) {
          //next behind ncp
          next = mix(next, pos, interp(vnp, next, pos));
        }
      }

      ${s?"depth = pos.z;":""}
      linearDepth = calculateLinearDepth(nearFar,pos.z);

      pos = projectAndScale(pos);
      next = projectAndScale(next);
      prev = projectAndScale(prev);
    }
  `),Hi(r),r.code.add(g`
  void main(void) {
    // unpack values from uv0.y
    bool isStartVertex = abs(abs(uv0.y)-3.0) == 1.0;

    float coverage = 1.0;

    // Check for special value of uv0.y which is used by the Renderer when graphics
    // are removed before the VBO is recompacted. If this is the case, then we just
    // project outside of clip space.
    if (uv0.y == 0.0) {
      // Project out of clip space
      gl_Position = vec4(1e038, 1e038, 1e038, 1.0);
    }
    else {
      bool isJoin = abs(uv0.y) < 3.0;

      float lineSize = getSize();
      float lineWidth = lineSize * pixelRatio;

      ${c?g`vLineWidth = lineWidth;`:""}
      ${o?g`vLineSizeInv = 1.0 / lineSize;`:""}

      // convert sub-pixel coverage to alpha
      if (lineWidth < 1.0) {
        coverage = lineWidth;
        lineWidth = 1.0;
      }else{
        // Ribbon lines cannot properly render non-integer sizes. Round width to integer size if
        // larger than one for better quality. Note that we do render < 1 pixels more or less correctly
        // so we only really care to round anything larger than 1.
        lineWidth = floor(lineWidth + 0.5);
      }

      vec4 pos  = view * vec4(position.xyz, 1.0);
      vec4 prev = view * vec4(auxpos1.xyz, 1.0);
      vec4 next = view * vec4(auxpos2.xyz, 1.0);
  `),a&&r.code.add(g`vec4 other = isStartVertex ? next : prev;
bool markersHidden = areWorldMarkersHidden(pos, other);
if(!isJoin && !markersHidden) {
pos.xyz += normalize(other.xyz - pos.xyz) * getWorldMarkerSize(pos) * 0.5;
}`),r.code.add(g`clipAndTransform(pos, prev, next, isStartVertex);
vec2 left = (pos.xy - prev.xy);
vec2 right = (next.xy - pos.xy);
float leftLen = length(left);
float rightLen = length(right);`),(t.stippleEnabled||n)&&r.code.add(g`
      float isEndVertex = float(!isStartVertex);
      vec2 segmentOrigin = mix(pos.xy, prev.xy, isEndVertex);
      vec2 segment = mix(right, left, isEndVertex);
      ${n?g`vec2 segmentEnd = mix(next.xy, pos.xy, isEndVertex);`:""}
    `),r.code.add(g`left = (leftLen > 0.001) ? left/leftLen : vec2(0.0, 0.0);
right = (rightLen > 0.001) ? right/rightLen : vec2(0.0, 0.0);
vec2 capDisplacementDir = vec2(0, 0);
vec2 joinDisplacementDir = vec2(0, 0);
float displacementLen = lineWidth;
if (isJoin) {
bool isOutside = (left.x * right.y - left.y * right.x) * uv0.y > 0.0;
joinDisplacementDir = normalize(left + right);
joinDisplacementDir = PERPENDICULAR(joinDisplacementDir);
if (leftLen > 0.001 && rightLen > 0.001) {
float nDotSeg = dot(joinDisplacementDir, left);
displacementLen /= length(nDotSeg * left - joinDisplacementDir);
if (!isOutside) {
displacementLen = min(displacementLen, min(leftLen, rightLen)/abs(nDotSeg));
}
}
if (isOutside && (displacementLen > miterLimit * lineWidth)) {`),t.roundJoins?r.code.add(g`
        vec2 startDir = leftLen < 0.001 ? right : left;
        startDir = PERPENDICULAR(startDir);

        vec2 endDir = rightLen < 0.001 ? left : right;
        endDir = PERPENDICULAR(endDir);

        float factor = ${t.stippleEnabled?g`min(1.0, subdivisionFactor * ${g.float((qr+2)/(qr+1))})`:g`subdivisionFactor`};

        float rotationAngle = acos(clamp(dot(startDir, endDir), -1.0, 1.0));
        joinDisplacementDir = rotate(startDir, -sign(uv0.y) * factor * rotationAngle);
      `):r.code.add(g`if (leftLen < 0.001) {
joinDisplacementDir = right;
}
else if (rightLen < 0.001) {
joinDisplacementDir = left;
}
else {
joinDisplacementDir = (isStartVertex || subdivisionFactor > 0.0) ? right : left;
}
joinDisplacementDir = PERPENDICULAR(joinDisplacementDir);`);const p=t.capType!==vt.BUTT;return r.code.add(g`
        displacementLen = lineWidth;
      }
    } else {
      // CAP handling ---------------------------------------------------
      joinDisplacementDir = isStartVertex ? right : left;
      joinDisplacementDir = PERPENDICULAR(joinDisplacementDir);

      ${p?g`capDisplacementDir = isStartVertex ? -right : left;`:""}
    }
  `),r.code.add(g`
    // Displacement (in pixels) caused by join/or cap
    vec2 dpos = joinDisplacementDir * sign(uv0.y) * displacementLen + capDisplacementDir * displacementLen;

    ${h||l?g`float lineDistNorm = sign(uv0.y) * pos.w;`:""}

    ${l?g`vLineDistance = lineWidth * lineDistNorm;`:""}
    ${h?g`vLineDistanceNorm = lineDistNorm;`:""}

    pos.xy += dpos;
  `),n&&r.code.add(g`vec2 segmentDir = normalize(segment);
vSegmentSDF = (isJoin && isStartVertex) ? LARGE_HALF_FLOAT : (dot(pos.xy - segmentOrigin, segmentDir) * pos.w) ;
vReverseSegmentSDF = (isJoin && !isStartVertex) ? LARGE_HALF_FLOAT : (dot(pos.xy - segmentEnd, -segmentDir) * pos.w);`),t.stippleEnabled&&(t.draped?r.uniforms.add(new Q("worldToScreenRatio",(u,v)=>1/v.screenToPCSRatio)):r.code.add(g`vec3 segmentCenter = mix((auxpos2 + position) * 0.5, (position + auxpos1) * 0.5, isEndVertex);
float worldToScreenRatio = computeWorldToScreenRatio(segmentCenter);`),r.code.add(g`float segmentLengthScreenDouble = length(segment);
float segmentLengthScreen = segmentLengthScreenDouble * 0.5;
float discreteWorldToScreenRatio = discretizeWorldToScreenRatio(worldToScreenRatio);
float segmentLengthRender = length(mix(auxpos2 - position, position - auxpos1, isEndVertex));
vStipplePatternStretch = worldToScreenRatio / discreteWorldToScreenRatio;`),t.draped?r.code.add(g`float segmentLengthPseudoScreen = segmentLengthScreen / pixelRatio * discreteWorldToScreenRatio / worldToScreenRatio;
float startPseudoScreen = uv0.x * discreteWorldToScreenRatio - mix(0.0, segmentLengthPseudoScreen, isEndVertex);`):r.code.add(g`float startPseudoScreen = mix(uv0.x, uv0.x - segmentLengthRender, isEndVertex) * discreteWorldToScreenRatio;
float segmentLengthPseudoScreen = segmentLengthRender * discreteWorldToScreenRatio;`),r.uniforms.add(new Q("stipplePatternPixelSize",u=>eo(u))),r.code.add(g`float patternLength = lineSize * stipplePatternPixelSize;
vStippleDistanceLimits = computeStippleDistanceLimits(startPseudoScreen, segmentLengthPseudoScreen, segmentLengthScreen, patternLength);
vStippleDistance = mix(vStippleDistanceLimits.x, vStippleDistanceLimits.y, isEndVertex);
if (segmentLengthScreenDouble >= 0.001) {
vec2 stippleDisplacement = pos.xy - segmentOrigin;
float stippleDisplacementFactor = dot(segment, stippleDisplacement) / (segmentLengthScreenDouble * segmentLengthScreenDouble);
vStippleDistance += (stippleDisplacementFactor - isEndVertex) * (vStippleDistanceLimits.y - vStippleDistanceLimits.x);
}
vStippleDistanceLimits *= pos.w;
vStippleDistance *= pos.w;
vStippleDistanceLimits = isJoin ?
vStippleDistanceLimits :
isStartVertex ?
vec2(-1e34, vStippleDistanceLimits.y) :
vec2(vStippleDistanceLimits.x, 1e34);`)),r.code.add(g`
      // Convert back into NDC
      pos.xy = (pos.xy / viewport.zw) * pos.w;

      vColor = getColor();
      vColor.a *= coverage;

      ${t.wireframe&&!t.draped?"pos.z -= 0.001 * pos.w;":""}

      // transform final position to camera space for slicing
      vpos = (inverseProjectionMatrix * pos).xyz;
      gl_Position = pos;
      forwardObjectAndLayerIdColor();
    }
  }
  `),s&&e.include(Ea,t),e.include(Lt,t),i.include($a),i.code.add(g`
  void main() {
    discardBySlice(vpos);
    ${s?"terrainDepthTest(depth);":""}
  `),t.wireframe?i.code.add(g`vec4 finalColor = vec4(1.0, 0.0, 1.0, 1.0);`):(n&&i.code.add(g`
      float sdf = min(vSegmentSDF, vReverseSegmentSDF);
      vec2 fragmentPosition = vec2(
        min(sdf, 0.0),
        vLineDistance
      ) * gl_FragCoord.w;

      float fragmentRadius = length(fragmentPosition);
      float fragmentCapSDF = (fragmentRadius - vLineWidth) * 0.5; // Divide by 2 to transform from double pixel scale
      float capCoverage = clamp(0.5 - fragmentCapSDF, 0.0, 1.0);

      if (capCoverage < ${g.float(Je)}) {
        discard;
      }
    `),d?i.code.add(g`
      vec2 stipplePosition = vec2(
        min(getStippleSDF() * 2.0 - 1.0, 0.0),
        vLineDistanceNorm * gl_FragCoord.w
      );
      float stippleRadius = length(stipplePosition * vLineWidth);
      float stippleCapSDF = (stippleRadius - vLineWidth) * 0.5; // Divide by 2 to transform from double pixel scale
      float stippleCoverage = clamp(0.5 - stippleCapSDF, 0.0, 1.0);
      float stippleAlpha = step(${g.float(Je)}, stippleCoverage);
      `):i.code.add(g`float stippleAlpha = getStippleAlpha();`),t.output!==O.ObjectAndLayerIdColor&&i.code.add(g`discardByStippleAlpha(stippleAlpha, stippleAlphaColorDiscard);`),i.uniforms.add(new ut("intrinsicColor",u=>u.color)),i.code.add(g`vec4 color = intrinsicColor * vColor;`),t.innerColorEnabled&&(i.uniforms.add(new ut("innerColor",u=>u.innerColor??u.color),new Q("innerWidth",(u,v)=>u.innerWidth*v.camera.pixelRatio)),i.code.add(g`float distToInner = abs(vLineDistance * gl_FragCoord.w) - innerWidth;
float innerAA = clamp(0.5 - distToInner, 0.0, 1.0);
float innerAlpha = innerColor.a + color.a * (1.0 - innerColor.a);
color = mix(color, vec4(innerColor.rgb, innerAlpha), innerAA);`)),i.code.add(g`vec4 finalColor = blendStipple(color, stippleAlpha);`),t.falloffEnabled&&(i.uniforms.add(new Q("falloff",u=>u.falloff)),i.code.add(g`finalColor.a *= pow(max(0.0, 1.0 - abs(vLineDistanceNorm * gl_FragCoord.w)), falloff);`))),i.code.add(g`
    ${t.output===O.ObjectAndLayerIdColor?g`finalColor.a = 1.0;`:""}

    if (finalColor.a < ${g.float(Je)}) {
      discard;
    }

    ${t.output===O.Alpha?g`fragColor = vec4(finalColor.a);`:""}
    ${t.output===O.Color?g`fragColor = highlightSlice(finalColor, vpos);`:""}
    ${t.output===O.Color&&t.transparencyPassType===ye.Color?"fragColor = premultiplyAlpha(fragColor);":""}
    ${t.output===O.Highlight?g`fragColor = vec4(1.0);`:""}
    ${t.output===O.Depth?g`outputDepth(linearDepth);`:""}
    ${t.output===O.ObjectAndLayerIdColor?g`outputObjectAndLayerIdColor();`:""}
  }
  `),e}const wd=Object.freeze(Object.defineProperty({__proto__:null,build:yd,ribbonlineNumRoundJoinSubdivisions:qr},Symbol.toStringTag,{value:"Module"})),ho=new Map([[f.POSITION,0],[f.SUBDIVISIONFACTOR,1],[f.UV0,2],[f.AUXPOS1,3],[f.AUXPOS2,4],[f.COLOR,5],[f.COLORFEATUREATTRIBUTE,5],[f.SIZE,6],[f.SIZEFEATUREATTRIBUTE,6],[f.OPACITYFEATUREATTRIBUTE,7],[f.OBJECTANDLAYERIDCOLOR,8]]);let uo=class po extends ri{initializeProgram(e){return new ii(e.rctx,po.shader.get().build(this.configuration),ho)}_makePipelineState(e,r){const i=this.configuration,s=e===ye.NONE,a=e===ye.FrontFace;return Qe({blending:i.output===O.Color||i.output===O.Alpha?s?Ir:Na(e):null,depthTest:{func:ja(e)},depthWrite:s?i.writeDepth?za:null:Ua(e),colorWrite:ft,stencilWrite:i.hasOccludees?xs:null,stencilTest:i.hasOccludees?r?Cs:Vn:null,polygonOffset:s||a?i.hasPolygonOffset?Ws:null:Tl})}initializePipeline(){const e=this.configuration;if(e.occluder){const r=e.hasPolygonOffset?Ws:null;this._occluderPipelineTransparent=Qe({blending:Ir,polygonOffset:r,depthTest:Ss,depthWrite:null,colorWrite:ft,stencilWrite:null,stencilTest:Wn}),this._occluderPipelineOpaque=Qe({blending:Ir,polygonOffset:r,depthTest:Ss,depthWrite:null,colorWrite:ft,stencilWrite:Hn,stencilTest:Gn}),this._occluderPipelineMaskWrite=Qe({blending:null,polygonOffset:r,depthTest:Bn,depthWrite:null,colorWrite:null,stencilWrite:xs,stencilTest:Cs})}return this._occludeePipelineState=this._makePipelineState(this.configuration.transparencyPassType,!0),this._makePipelineState(this.configuration.transparencyPassType,!1)}get primitiveType(){return this.configuration.wireframe?Rs.LINES:Rs.TRIANGLE_STRIP}getPipeline(e,r,i){return e?this._occludeePipelineState:this.configuration.occluder?i?this._occluderPipelineTransparent:r?this._occluderPipelineOpaque:this._occluderPipelineMaskWrite:super.getPipeline()}};uo.shader=new ti(wd,()=>Xr(()=>import("./RibbonLine.glsl-2e431c35.js"),["assets/RibbonLine.glsl-2e431c35.js","assets/DefaultTechniqueConfiguration-b4dbe32f.js","assets/index-b516d057.js","assets/index-b252abd2.css","assets/requestImageUtils-b142708c.js","assets/enums-bdecffa2.js","assets/Texture-bcb6d63f.js","assets/contextUtils-81fda295.js","assets/interfaces-8918b36f.js","assets/Material-5f4156ac.js","assets/ViewingMode-5d7d590b.js","assets/FramebufferObject-123b7c8d.js","assets/ShaderTechniqueConfiguration-2502462e.js","assets/floatRGBA-ca990bbb.js","assets/OrderIndependentTransparency-755f7dcc.js","assets/vec3f32-bac7ea57.js","assets/ElevationProvider-abb53936.js","assets/dehydratedPoint-5a1dfed5.js","assets/hydratedFeatures-2365c307.js","assets/weather-2eb64924.js","assets/RenderState-1d6218ee.js","assets/NestedMap-1b5db22e.js","assets/frustum-f9d53cdf.js","assets/VertexElementDescriptor-2925c6af.js","assets/VertexArrayObject-d19dab8d.js","assets/Octree-7cea9440.js","assets/InterleavedLayout-d76b0d59.js","assets/types-1305598a.js","assets/Intersector-2e1d9db3.js","assets/Intersector-fa865806.js","assets/boundedPlane-1da2f094.js","assets/verticalOffsetUtils-e5214af9.js","assets/orientedBoundingBox-67c5cd22.js","assets/glUtil-ce5ee52b.js","assets/Scheduler-ff5943a4.js","assets/signal-51ed66f5.js","assets/debugFlags-9a30f077.js"]));const Ws={factor:0,units:-4};var _e;(function(t){t[t.LEFT_JOIN_START=-2]="LEFT_JOIN_START",t[t.LEFT_JOIN_END=-1]="LEFT_JOIN_END",t[t.LEFT_CAP_START=-4]="LEFT_CAP_START",t[t.LEFT_CAP_END=-5]="LEFT_CAP_END",t[t.RIGHT_JOIN_START=2]="RIGHT_JOIN_START",t[t.RIGHT_JOIN_END=1]="RIGHT_JOIN_END",t[t.RIGHT_CAP_START=4]="RIGHT_CAP_START",t[t.RIGHT_CAP_END=5]="RIGHT_CAP_END"})(_e||(_e={}));let xd=class extends La{constructor(e){super(e,new Sd),this._configuration=new H,this._vertexAttributeLocations=ho}getConfiguration(e,r){this._configuration.output=e,this._configuration.draped=r.slot===Z.DRAPED_MATERIAL;const i=this.parameters.stipplePattern!=null&&e!==O.Highlight;return this._configuration.stippleEnabled=i,this._configuration.stippleOffColorEnabled=i&&this.parameters.stippleOffColor!=null,this._configuration.stipplePreferContinuous=i&&this.parameters.stipplePreferContinuous,this._configuration.hasSlicePlane=this.parameters.hasSlicePlane,this._configuration.hasOccludees=this.parameters.hasOccludees,this._configuration.roundJoins=this.parameters.join==="round",this._configuration.capType=this.parameters.cap,this._configuration.applyMarkerOffset=this.parameters.markerParameters!=null&&Rd(this.parameters.markerParameters),this._configuration.hasPolygonOffset=this.parameters.hasPolygonOffset,this._configuration.writeDepth=this.parameters.writeDepth,this._configuration.vvSize=!!this.parameters.vvSize,this._configuration.vvColor=!!this.parameters.vvColor,this._configuration.vvOpacity=!!this.parameters.vvOpacity,this._configuration.innerColorEnabled=this.parameters.innerWidth>0&&this.parameters.innerColor!=null,this._configuration.falloffEnabled=this.parameters.falloff>0,this._configuration.occluder=this.parameters.renderOccluded===pt.OccludeAndTransparentStencil,this._configuration.transparencyPassType=r.transparencyPassType,this._configuration.multipassEnabled=r.multipassEnabled,this._configuration.cullAboveGround=r.multipassTerrain.cullAboveGround,this._configuration.wireframe=this.parameters.wireframe,this._configuration}intersectDraped(e,r,i,s,a,o){if(!i.options.selectionMode)return;const n=e.attributes.get(f.POSITION).data,c=e.attributes.get(f.SIZE);let l=this.parameters.width;if(this.parameters.vvSize){const x=e.attributes.get(f.SIZEFEATUREATTRIBUTE).data[0];l*=Ht(this.parameters.vvSize.offset[0]+x*this.parameters.vvSize.factor[0],this.parameters.vvSize.minSize[0],this.parameters.vvSize.maxSize[0])}else c&&(l*=c.data[0]);const d=s[0],h=s[1],p=(l/2+4)*e.screenToWorldRatio;let u=Number.MAX_VALUE,v=0;for(let x=0;x<n.length-5;x+=3){const y=n[x],R=n[x+1],w=d-y,_=h-R,L=n[x+3]-y,C=n[x+4]-R,b=Ht((L*w+C*_)/(L*L+C*C),0,1),S=L*b-w,U=C*b-_,P=S*S+U*U;P<u&&(u=P,v=x/3)}u<p*p&&a(o.dist,o.normal,v,!1)}intersect(e,r,i,s,a,o){if(!i.options.selectionMode||!e.visible)return;if(!un(r))return void Yr.getLogger("esri.views.3d.webgl-engine.materials.RibbonLineMaterial").error("intersection assumes a translation-only matrix");const n=e.attributes,c=n.get(f.POSITION).data;let l=this.parameters.width;if(this.parameters.vvSize){const w=n.get(f.SIZEFEATUREATTRIBUTE).data[0];l*=Ht(this.parameters.vvSize.offset[0]+w*this.parameters.vvSize.factor[0],this.parameters.vvSize.minSize[0],this.parameters.vvSize.maxSize[0])}else n.has(f.SIZE)&&(l*=n.get(f.SIZE).data[0]);const d=i.camera,h=bd;Ni(h,i.point);const p=l*d.pixelRatio/2+4*d.pixelRatio;ee(Xt[0],h[0]-p,h[1]+p,0),ee(Xt[1],h[0]+p,h[1]+p,0),ee(Xt[2],h[0]+p,h[1]-p,0),ee(Xt[3],h[0]-p,h[1]-p,0);for(let w=0;w<4;w++)if(!d.unprojectFromRenderScreen(Xt[w],He[w]))return;xr(d.eye,He[0],He[1],yi),xr(d.eye,He[1],He[2],wi),xr(d.eye,He[2],He[3],xi),xr(d.eye,He[3],He[0],Ci);let u=Number.MAX_VALUE,v=0;const x=fo(this.parameters,n)?c.length-2:c.length-5;for(let w=0;w<x;w+=3){ue[0]=c[w]+r[12],ue[1]=c[w+1]+r[13],ue[2]=c[w+2]+r[14];const _=(w+3)%c.length;if(pe[0]=c[_]+r[12],pe[1]=c[_+1]+r[13],pe[2]=c[_+2]+r[14],Pe(yi,ue)<0&&Pe(yi,pe)<0||Pe(wi,ue)<0&&Pe(wi,pe)<0||Pe(xi,ue)<0&&Pe(xi,pe)<0||Pe(Ci,ue)<0&&Pe(Ci,pe)<0)continue;if(d.projectToRenderScreen(ue,it),d.projectToRenderScreen(pe,st),it[2]<0&&st[2]>0){le(Ie,ue,pe);const C=d.frustum,b=-Pe(C[Tr.NEAR],ue)/Zt(Ie,us(C[Tr.NEAR]));ne(Ie,Ie,b),he(ue,ue,Ie),d.projectToRenderScreen(ue,it)}else if(it[2]>0&&st[2]<0){le(Ie,pe,ue);const C=d.frustum,b=-Pe(C[Tr.NEAR],pe)/Zt(Ie,us(C[Tr.NEAR]));ne(Ie,Ie,b),he(pe,pe,Ie),d.projectToRenderScreen(pe,st)}else if(it[2]<0&&st[2]<0)continue;it[2]=0,st[2]=0;const L=pn(ni(it,st,Bs),h);L<u&&(u=L,J(Hs,ue),J(Gs,pe),v=w/3)}const y=i.rayBegin,R=i.rayEnd;if(u<p*p){let w=Number.MAX_VALUE;if(fn(ni(Hs,Gs,Bs),ni(y,R,Od),rt)){le(rt,rt,y);const _=nr(rt);ne(rt,rt,1/_),w=_/Qr(y,R)}o(w,rt,v,!1)}}get _layout(){const e=_t().vec3f(f.POSITION).f32(f.SUBDIVISIONFACTOR).vec2f(f.UV0).vec3f(f.AUXPOS1).vec3f(f.AUXPOS2);return this.parameters.vvSize?e.f32(f.SIZEFEATUREATTRIBUTE):e.f32(f.SIZE),this.parameters.vvColor?e.f32(f.COLORFEATUREATTRIBUTE):e.vec4f(f.COLOR),this.parameters.vvOpacity&&e.f32(f.OPACITYFEATUREATTRIBUTE),ht("enable-feature:objectAndLayerId-rendering")&&e.vec4u8(f.OBJECTANDLAYERIDCOLOR),e}createBufferWriter(){return new Td(this._layout,this.parameters)}produces(e,r){return r===O.Color||r===O.Alpha||r===O.Highlight||r===O.Depth||r===O.ObjectAndLayerIdColor?e===Z.DRAPED_MATERIAL?!0:this.parameters.renderOccluded===pt.OccludeAndTransparentStencil?e===Z.OPAQUE_MATERIAL||e===Z.OCCLUDER_MATERIAL||e===Z.TRANSPARENT_OCCLUDER_MATERIAL:r===O.Color||r===O.Alpha?e===(this.parameters.writeDepth?Z.TRANSPARENT_MATERIAL:Z.TRANSPARENT_DEPTH_WRITE_DISABLED_MATERIAL):e===Z.OPAQUE_MATERIAL:!1}createGLMaterial(e){return new Cd(e)}validateParameters(e){e.join!=="miter"&&(e.miterLimit=0),e.markerParameters!=null&&(e.markerScale=e.markerParameters.width/e.width)}},Cd=class extends Ma{constructor(){super(...arguments),this._stipplePattern=null}dispose(){super.dispose(),this._stippleTextureRepository.release(this._stipplePattern),this._stipplePattern=null}_updateOccludeeState(e){e.hasOccludees!==this._material.parameters.hasOccludees&&this._material.setParameters({hasOccludees:e.hasOccludees})}beginSlot(e){this._output!==O.Color&&this._output!==O.Alpha||this._updateOccludeeState(e);const r=this._material.parameters.stipplePattern;return this._stipplePattern!==r&&(this._material.setParameters({stippleTexture:this._stippleTextureRepository.swap(r,this._stipplePattern)}),this._stipplePattern=r),this.ensureTechnique(uo,e)}},Sd=class extends kn{constructor(){super(...arguments),this.width=0,this.color=va,this.join="miter",this.cap=vt.BUTT,this.miterLimit=5,this.writeDepth=!0,this.hasPolygonOffset=!1,this.stippleTexture=null,this.stipplePreferContinuous=!0,this.markerParameters=null,this.markerScale=1,this.hasSlicePlane=!1,this.vvFastUpdate=!1,this.isClosed=!1,this.falloff=0,this.innerWidth=0,this.hasOccludees=!1,this.wireframe=!1}};class Td{constructor(e,r){this.vertexBufferLayout=e,this._parameters=r,this.numJoinSubdivisions=0;const i=r.stipplePattern?1:0;switch(this._parameters.join){case"miter":case"bevel":this.numJoinSubdivisions=i;break;case"round":this.numJoinSubdivisions=qr+i}}_isClosed(e){return fo(this._parameters,e.attributes)}allocate(e){return this.vertexBufferLayout.createBuffer(e)}elementCount(e){const i=e.attributes.get(f.POSITION).indices.length/2+1,s=this._isClosed(e);let a=s?2:2*2;return a+=((s?i:i-1)-(s?0:1))*(2*this.numJoinSubdivisions+4),a+=2,this._parameters.wireframe&&(a=2+4*(a-2)),a}write(e,r,i,s,a){var $;const o=Dd,n=Ad,c=Ed,l=i.attributes.get(f.POSITION),d=l.indices,h=l.data.length/3,p=($=i.attributes.get(f.DISTANCETOSTART))==null?void 0:$.data;d&&d.length!==2*(h-1)&&console.warn("RibbonLineMaterial does not support indices");let u=1,v=0;const x=this.vertexBufferLayout.fields.has(f.SIZEFEATUREATTRIBUTE);x?v=i.attributes.get(f.SIZEFEATUREATTRIBUTE).data[0]:i.attributes.has(f.SIZE)&&(u=i.attributes.get(f.SIZE).data[0]);let y=[1,1,1,1],R=0;const w=this.vertexBufferLayout.fields.has(f.COLORFEATUREATTRIBUTE);w?R=i.attributes.get(f.COLORFEATUREATTRIBUTE).data[0]:i.attributes.has(f.COLOR)&&(y=i.attributes.get(f.COLOR).data);const _=ht("enable-feature:objectAndLayerId-rendering")?i.objectAndLayerIdColor:null;let L=0;const C=this.vertexBufferLayout.fields.has(f.OPACITYFEATUREATTRIBUTE);C&&(L=i.attributes.get(f.OPACITYFEATUREATTRIBUTE).data[0]);const b=new Float32Array(s.buffer),S=ht("enable-feature:objectAndLayerId-rendering")?new Uint8Array(s.buffer):null,U=this.vertexBufferLayout.stride/4;let P=a*U;const A=P;let V=0;const W=p?(k,re,we)=>V=p[we]:(k,re,we)=>V+=Qr(k,re),yt=ht("enable-feature:objectAndLayerId-rendering"),ge=(k,re,we,We,wt,So,To)=>{if(b[P++]=re[0],b[P++]=re[1],b[P++]=re[2],b[P++]=We,b[P++]=To,b[P++]=wt,b[P++]=k[0],b[P++]=k[1],b[P++]=k[2],b[P++]=we[0],b[P++]=we[1],b[P++]=we[2],b[P++]=x?v:u,w)b[P++]=R;else{const yr=Math.min(4*So,y.length-4);b[P++]=y[yr],b[P++]=y[yr+1],b[P++]=y[yr+2],b[P++]=y[yr+3]}C&&(b[P++]=L),yt&&(_!=null&&(S[4*P]=_[0],S[4*P+1]=_[1],S[4*P+2]=_[2],S[4*P+3]=_[3]),P++)};P+=U,ee(n,l.data[0],l.data[1],l.data[2]),e&&Se(n,n,e);const Ge=this._isClosed(i);if(Ge){const k=l.data.length-3;ee(o,l.data[k],l.data[k+1],l.data[k+2]),e&&Se(o,o,e)}else ee(c,l.data[3],l.data[4],l.data[5]),e&&Se(c,c,e),ge(n,n,c,1,_e.LEFT_CAP_START,0,0),ge(n,n,c,1,_e.RIGHT_CAP_START,0,0),J(o,n),J(n,c);const Ke=Ge?0:1,et=Ge?h:h-1;for(let k=Ke;k<et;k++){const re=(k+1)%h*3;ee(c,l.data[re],l.data[re+1],l.data[re+2]),e&&Se(c,c,e),W(o,n,k),ge(o,n,c,0,_e.LEFT_JOIN_END,k,V),ge(o,n,c,0,_e.RIGHT_JOIN_END,k,V);const we=this.numJoinSubdivisions;for(let We=0;We<we;++We){const wt=(We+1)/(we+1);ge(o,n,c,wt,_e.LEFT_JOIN_END,k,V),ge(o,n,c,wt,_e.RIGHT_JOIN_END,k,V)}ge(o,n,c,1,_e.LEFT_JOIN_START,k,V),ge(o,n,c,1,_e.RIGHT_JOIN_START,k,V),J(o,n),J(n,c)}Ge?(ee(c,l.data[3],l.data[4],l.data[5]),e&&Se(c,c,e),V=W(o,n,et),ge(o,n,c,0,_e.LEFT_JOIN_END,Ke,V),ge(o,n,c,0,_e.RIGHT_JOIN_END,Ke,V)):(V=W(o,n,et),ge(o,n,n,0,_e.LEFT_CAP_END,et,V),ge(o,n,n,0,_e.RIGHT_CAP_END,et,V)),_i(b,A+U,b,A,U),P=_i(b,P-U,b,P,U),this._parameters.wireframe&&this._addWireframeVertices(s,A,P,U)}_addWireframeVertices(e,r,i,s){const a=new Float32Array(e.buffer,i*Float32Array.BYTES_PER_ELEMENT),o=new Float32Array(e.buffer,r*Float32Array.BYTES_PER_ELEMENT,i-r);let n=0;const c=l=>n=_i(o,l,a,n,s);for(let l=0;l<o.length-1;l+=2*s)c(l),c(l+2*s),c(l+1*s),c(l+2*s),c(l+1*s),c(l+3*s)}}function _i(t,e,r,i,s){for(let a=0;a<s;a++)r[i++]=t[e++];return i}function fo(t,e){return t.isClosed?e.get(f.POSITION).indices.length>2:!1}function Rd(t){return t.anchor===pr.Tip&&t.hideOnShortSegments&&t.placement==="begin-end"&&t.worldSpace}const ue=F(),pe=F(),Ie=F(),rt=F(),bd=F(),it=lt(),st=lt(),Hs=F(),Gs=F(),Bs=Sa(),Od=Sa(),Dd=F(),Ad=F(),Ed=F(),Xt=[lt(),lt(),lt(),lt()],He=[F(),F(),F(),F()],yi=mr(),wi=mr(),xi=mr(),Ci=mr();let $d=class{constructor(e){this._originSR=e,this._rootOriginId="root/"+ji(),this._origins=new Map,this._objects=new Map,this._gridSize=5e5}getOrigin(e){const r=this._origins.get(this._rootOriginId);if(r==null){const d=Fi(e[0]+Math.random()-.5,e[1]+Math.random()-.5,e[2]+Math.random()-.5,this._rootOriginId);return this._origins.set(this._rootOriginId,d),d}const i=this._gridSize,s=Math.round(e[0]/i),a=Math.round(e[1]/i),o=Math.round(e[2]/i),n=`${s}/${a}/${o}`;let c=this._origins.get(n);const l=.5*i;if(le(se,e,r.vec3),se[0]=Math.abs(se[0]),se[1]=Math.abs(se[1]),se[2]=Math.abs(se[2]),se[0]<l&&se[1]<l&&se[2]<l){if(c){const d=Math.max(...se);if(le(se,e,c.vec3),se[0]=Math.abs(se[0]),se[1]=Math.abs(se[1]),se[2]=Math.abs(se[2]),Math.max(...se)<d)return c}return r}return c||(c=Fi(s*i,a*i,o*i,n),this._origins.set(n,c)),c}_drawOriginBox(e,r=cr(1,1,0,1)){const i=window.view,s=i._stage,a=r.toString();if(!this._objects.has(a)){this._material=new xd({width:2,color:r}),s.add(this._material);const u=new Xc(s,{pickable:!1}),v=new $c({castShadow:!1});s.add(v),u.add(v),this._objects.set(a,v)}const o=this._objects.get(a),n=[0,1,5,4,0,2,1,7,6,2,0,1,3,7,5,4,6,2,0],c=n.length,l=new Array(3*c),d=new Array,h=.5*this._gridSize;for(let u=0;u<c;u++)l[3*u]=e[0]+(1&n[u]?h:-h),l[3*u+1]=e[1]+(2&n[u]?h:-h),l[3*u+2]=e[2]+(4&n[u]?h:-h),u>0&&d.push(u-1,u);Ei(l,this._originSR,0,l,i.renderSpatialReference,0,c);const p=new Te(this._material,[[f.POSITION,new j(l,d,3,!0)]],null,Qt.Line);s.add(p),o.addGeometry(p)}get test(){const e=this;return{set gridSize(r){e._gridSize=r}}}};const se=F();let mo=class{constructor(e,r,i=null){this.rctx=e,this.sliceHelper=i,this.lastFrameCamera=new N,this.output=O.Color,this.renderOccludedMask=ks,this.bindParameters=new Kl(r,i!=null?i.plane:null),this.bindParameters.alignPixelEnabled=!0}resetRenderOccludedMask(){this.renderOccludedMask=ks}},Sp=class extends mo{constructor(e,r,i,s){super(e,i,s),this.offscreenRenderingHelper=r,this.sliceHelper=s,this.time=mn(0)}};const ks=pt.Occlude|pt.OccludeAndTransparent|pt.OccludeAndTransparentStencil;let tr=class extends N{constructor(){super(...arguments),this._projectionMatrix=B()}get projectionMatrix(){return this._projectionMatrix}};m([E()],tr.prototype,"_projectionMatrix",void 0),m([E({readOnly:!0})],tr.prototype,"projectionMatrix",null),tr=m([fr("esri.views.3d.webgl-engine.lib.CascadeCamera")],tr);var qs;(function(t){t[t.Highlight=0]="Highlight",t[t.Default=1]="Default"})(qs||(qs={}));let Or=class{constructor(){this.camera=new tr,this.lightMat=B()}},Md=class{constructor(){this.maxNumCascadesHighQuality=4,this.maxNumCascadesLowQuality=4,this.textureSizeModHighQuality=1.3,this.textureSizeModLowQuality=.9,this.splitSchemeLambda=0}},Pd=class{get depthTexture(){var e;return(e=this._handle)==null?void 0:e.colorTexture}get _textureWidth(){return this._textureHeight*this._numCascades}get numCascades(){return this._numCascades}get cascadeDistances(){return dr(this._usedCascadeDistances,this._cascadeDistances[0],this._numCascades>1?this._cascadeDistances[1]:1/0,this._numCascades>2?this._cascadeDistances[2]:1/0,this._numCascades>3?this._cascadeDistances[3]:1/0)}constructor(e,r){this._fbos=e,this._viewingMode=r,this._enabled=!1,this._snapshots=new Array,this._textureHeight=0,this._numCascades=1,this.settings=new Md,this._projectionView=B(),this._projectionViewInverse=B(),this._modelViewLight=B(),this._cascadeDistances=[0,0,0,0,0],this._usedCascadeDistances=ze(),this._cascades=[new Or,new Or,new Or,new Or],this._lastOrigin=null,this._maxTextureWidth=Math.min(ht("esri-mobile")?4096:16384,e.rctx.parameters.maxTextureSize)}dispose(){this.enabled=!1,this.disposeOffscreenBuffers()}disposeOffscreenBuffers(){this._handle=Ur(this._handle),this._discardSnapshots()}set maxCascades(e){this.settings.maxNumCascadesHighQuality=Ht(Math.floor(e),1,4)}get maxCascades(){return this.settings.maxNumCascadesHighQuality}set enabled(e){this._enabled=e,e||this.disposeOffscreenBuffers()}get enabled(){return this._enabled}get ready(){return this._enabled&&this.depthTexture!=null}get cascades(){for(let e=0;e<this._numCascades;++e)Ti[e]=this._cascades[e];return Ti.length=this._numCascades,Ti}start(e,r,i,s,a){me(this.enabled);const{near:o,far:n}=this._clampNearFar(i);this._computeCascadeDistances(o,n,s),this._textureHeight=this._computeTextureHeight(e,a,s),this._setupMatrices(e,r);const{viewMatrix:c,projectionMatrix:l}=e;for(let d=0;d<this._numCascades;++d)this._constructCascade(d,l,c,r);this._lastOrigin=null,this.clear()}finish(){var e;me(this.enabled),(e=this._handle)==null||e.releaseDepth()}getShadowMapMatrices(e){if(!this._lastOrigin||!Ft(e,this._lastOrigin)){this._lastOrigin=this._lastOrigin||F(),J(this._lastOrigin,e);for(let r=0;r<this._numCascades;++r){ps(Ks,this._cascades[r].lightMat,e);for(let i=0;i<16;++i)ea[16*r+i]=Ks[i]}}return ea}moveSnapshot(e){var r,i;me(this.enabled),(r=this._handle)==null||r.releaseDepth(),(i=this._snapshots[e])==null||i.release(),this._snapshots[e]=this._handle,this._handle=null}copySnapshot(e){var n,c,l,d;const r=(c=(n=this._handle)==null?void 0:n.colorTexture)==null?void 0:c.descriptor;if(!this.enabled||!r)return;(l=this._snapshots[e])==null||l.release();const{width:i,height:s}=r;this._snapshots[e]=this._fbos.acquire(hr.RGBA4,i,s);const a=this._fbos.rctx;this._bindFbo();const o=a.bindTexture((d=this._snapshots[e])==null?void 0:d.colorTexture,mt.TEXTURE_UNIT_FOR_UPDATES);a.gl.copyTexSubImage2D(xl.TEXTURE_2D,0,0,0,0,0,i,s),a.bindTexture(o,mt.TEXTURE_UNIT_FOR_UPDATES)}getSnapshot(e){var r;return this.enabled?(r=this._snapshots[e])==null?void 0:r.colorTexture:null}clear(){const e=this._fbos.rctx;this._ensureFbo(),this._bindFbo(),e.setClearColor(1,1,1,1),e.clearSafe(Gr.COLOR_BUFFER_BIT|Gr.DEPTH_BUFFER_BIT)}_computeTextureHeight(e,r,i){const s=Math.min(window.devicePixelRatio,r)/e.pixelRatio,a=i?this.settings.textureSizeModHighQuality:this.settings.textureSizeModLowQuality,o=qn(Math.floor(Math.max(e.fullWidth,e.fullHeight)*s*a));return Math.min(this._maxTextureWidth,this._numCascades*o)/this._numCascades}_ensureFbo(){var e,r,i;((e=this._handle)==null?void 0:e.fbo.width)===this._textureWidth&&((r=this._handle)==null?void 0:r.fbo.height)===this._textureHeight||((i=this._handle)==null||i.release(),this._handle=this._fbos.acquire(hr.RGBA4,this._textureWidth,this._textureHeight)),this._handle.acquireDepth(Zn.DEPTH16_BUFFER)}_discardSnapshot(e){this._snapshots[e]=Ur(this._snapshots[e])}_discardSnapshots(){for(let e=0;e<this._snapshots.length;++e)this._discardSnapshot(e);this._snapshots.length=0}_bindFbo(){var r;const e=this._fbos.rctx;e.unbindTexture(this.depthTexture),e.bindFramebuffer((r=this._handle)==null?void 0:r.fbo)}_constructCascade(e,r,i,s){const a=this._cascades[e],o=-this._cascadeDistances[e],n=-this._cascadeDistances[e+1],c=(r[10]*o+r[14])/Math.abs(r[11]*o+r[15]),l=(r[10]*n+r[14])/Math.abs(r[11]*n+r[15]);me(c<l);for(let u=0;u<8;++u){dr(Zs,u%4==0||u%4==3?-1:1,u%4==0||u%4==1?-1:1,u<4?c:l,1);const v=be[u];er(v,Zs,this._projectionViewInverse),v[0]/=v[3],v[1]/=v[3],v[2]/=v[3]}gn(Si,be[0]),a.camera.viewMatrix=ps(Id,this._modelViewLight,Si);for(let u=0;u<8;++u)Se(be[u],be[u],a.camera.viewMatrix);let d=be[0][2],h=be[0][2];for(let u=1;u<8;++u)d=Math.min(d,be[u][2]),h=Math.max(h,be[u][2]);d-=200,h+=200,a.camera.near=-h,a.camera.far=-d,jd(i,s,d,h,a.camera),Xe(a.lightMat,a.camera.projectionMatrix,a.camera.viewMatrix);const p=this._textureHeight;a.camera.viewport=[e*p,0,p,p]}_setupMatrices(e,r){Xe(this._projectionView,e.projectionMatrix,e.viewMatrix),rr(this._projectionViewInverse,this._projectionView);const i=this._viewingMode===si.Global?e.eye:ee(Si,0,0,1);ma(this._modelViewLight,[0,0,0],[-r[0],-r[1],-r[2]],i)}_clampNearFar(e){let{near:r,far:i}=e;return r<2&&(r=2),i<2&&(i=2),r>=i&&(r=2,i=4),{near:r,far:i}}_computeCascadeDistances(e,r,i){const s=i?this.settings.maxNumCascadesHighQuality:this.settings.maxNumCascadesLowQuality;this._numCascades=Math.min(1+Math.floor(vn(r/e,4)),s);const a=(r-e)/this._numCascades,o=(r/e)**(1/this._numCascades);let n=e,c=e;for(let l=0;l<this._numCascades+1;++l)this._cascadeDistances[l]=ot(n,c,this.settings.splitSchemeLambda),n*=o,c+=a}get test(){return{cascades:this._cascades,textureHeight:this._textureHeight}}};const Id=B(),Zs=ze(),be=[];for(let t=0;t<8;++t)be.push(ze());const Js=Y(),Qs=Y(),Ld=Y(),Ys=Y(),Xs=Y(),Si=F(),Ti=[],Ks=B(),ea=Ze.concat(Ze,Ze,Ze,Ze),Ce=Y(),At=Y(),at=[Y(),Y(),Y(),Y()],X=Y(),Ri=Y(),ke=Y(),Kt=Y(),Et=Y(),$t=Y(),Dr=Y();function Fd(t,e,r,i,s,a,o,n){Wr(Ce,0,0);for(let C=0;C<4;++C)tt(Ce,Ce,t[C]);Mt(Ce,Ce,.25),Wr(At,0,0);for(let C=4;C<8;++C)tt(At,At,t[C]);Mt(At,At,.25),Yt(at[0],t[4],t[5],.5),Yt(at[1],t[5],t[6],.5),Yt(at[2],t[6],t[7],.5),Yt(at[3],t[7],t[4],.5);let c=0,l=fs(at[0],Ce);for(let C=1;C<4;++C){const b=fs(at[C],Ce);b<l&&(l=b,c=C)}Pt(X,at[c],t[c+4]);const d=X[0];let h,p;X[0]=-X[1],X[1]=d,Pt(Ri,At,Ce),de(Ri,X)<0&&yn(X,X),Yt(X,X,Ri,r),ms(X,X),h=p=de(Pt(ke,t[0],Ce),X);for(let C=1;C<8;++C){const b=de(Pt(ke,t[C],Ce),X);b<h?h=b:b>p&&(p=b)}Ni(i,Ce),Mt(ke,X,h-e),tt(i,i,ke);let u=-1,v=1,x=0,y=0;for(let C=0;C<8;++C){Pt(Kt,t[C],i),ms(Kt,Kt);const b=X[0]*Kt[1]-X[1]*Kt[0];b>0?b>u&&(u=b,x=C):b<v&&(v=b,y=C)}xt(u>0,"leftArea"),xt(v<0,"rightArea"),Mt(Et,X,h),tt(Et,Et,Ce),Mt($t,X,p),tt($t,$t,Ce),Dr[0]=-X[1],Dr[1]=X[0];const R=Cr(i,t[y],$t,tt(ke,$t,Dr),1,s),w=Cr(i,t[x],$t,ke,1,a),_=Cr(i,t[x],Et,tt(ke,Et,Dr),1,o),L=Cr(i,t[y],Et,ke,1,n);xt(R,"rayRay"),xt(w,"rayRay"),xt(_,"rayRay"),xt(L,"rayRay")}function I(t,e){return 3*e+t}const ta=Y();function ve(t,e){return Wr(ta,t[e],t[e+3]),ta}const fe=Y(),T=wn();function Nd(t,e,r,i,s){Pt(fe,r,i),Mt(fe,fe,.5),T[0]=fe[0],T[1]=fe[1],T[2]=0,T[3]=fe[1],T[4]=-fe[0],T[5]=0,T[6]=fe[0]*fe[0]+fe[1]*fe[1],T[7]=fe[0]*fe[1]-fe[1]*fe[0],T[8]=1,T[I(0,2)]=-de(ve(T,0),t),T[I(1,2)]=-de(ve(T,1),t);let a=de(ve(T,0),r)+T[I(0,2)],o=de(ve(T,1),r)+T[I(1,2)],n=de(ve(T,0),i)+T[I(0,2)],c=de(ve(T,1),i)+T[I(1,2)];a=-(a+n)/(o+c),T[I(0,0)]+=T[I(1,0)]*a,T[I(0,1)]+=T[I(1,1)]*a,T[I(0,2)]+=T[I(1,2)]*a,a=1/(de(ve(T,0),r)+T[I(0,2)]),o=1/(de(ve(T,1),r)+T[I(1,2)]),T[I(0,0)]*=a,T[I(0,1)]*=a,T[I(0,2)]*=a,T[I(1,0)]*=o,T[I(1,1)]*=o,T[I(1,2)]*=o,T[I(2,0)]=T[I(1,0)],T[I(2,1)]=T[I(1,1)],T[I(2,2)]=T[I(1,2)],T[I(1,2)]+=1,a=de(ve(T,1),e)+T[I(1,2)],o=de(ve(T,2),e)+T[I(2,2)],n=de(ve(T,1),r)+T[I(1,2)],c=de(ve(T,2),r)+T[I(2,2)],a=-.5*(a/o+n/c),T[I(1,0)]+=T[I(2,0)]*a,T[I(1,1)]+=T[I(2,1)]*a,T[I(1,2)]+=T[I(2,2)]*a,a=de(ve(T,1),e)+T[I(1,2)],o=de(ve(T,2),e)+T[I(2,2)],n=-o/a,T[I(1,0)]*=n,T[I(1,1)]*=n,T[I(1,2)]*=n,s[0]=T[0],s[1]=T[1],s[2]=0,s[3]=T[2],s[4]=T[3],s[5]=T[4],s[6]=0,s[7]=T[5],s[8]=0,s[9]=0,s[10]=1,s[11]=0,s[12]=T[6],s[13]=T[7],s[14]=0,s[15]=T[8]}function jd(t,e,r,i,s){const a=1/be[0][3],o=1/be[4][3];me(a<o);let n=a+Math.sqrt(a*o);const c=Math.sin(_n(t[2]*e[0]+t[6]*e[1]+t[10]*e[2]));n/=c,Fd(be,n,c,Js,Qs,Ld,Ys,Xs),Nd(Js,Qs,Ys,Xs,s.projectionMatrix),s.projectionMatrix[10]=2/(r-i),s.projectionMatrix[14]=-(r+i)/(r-i)}let zd=class{constructor(){this.adds=new Ae,this.removes=new Ae,this.updates=new Ae({allocator:e=>e||new Ud,deallocator:e=>(e.renderGeometry=null,e)})}clear(){this.adds.clear(),this.removes.clear(),this.updates.clear()}prune(){this.adds.prune(),this.removes.prune(),this.updates.prune()}get empty(){return this.adds.length===0&&this.removes.length===0&&this.updates.length===0}},Ud=class{},Vd=class{constructor(){this.adds=new Array,this.removes=new Array,this.updates=new Array}};var Zr,je;(function(t){t[t.ADD=0]="ADD",t[t.UPDATE=1]="UPDATE",t[t.REMOVE=2]="REMOVE"})(Zr||(Zr={})),function(t){t[t.NONE=0]="NONE",t[t.VISIBILITY=1]="VISIBILITY",t[t.GEOMETRY=2]="GEOMETRY",t[t.TRANSFORMATION=4]="TRANSFORMATION",t[t.HIGHLIGHT=8]="HIGHLIGHT",t[t.OCCLUDEE=16]="OCCLUDEE"}(je||(je={}));function Wd(t){const e=new Map,r=i=>{let s=e.get(i);return s||(s=new Vd,e.set(i,s)),s};return t.removes.forAll(i=>{bi(i)&&r(i.material).removes.push(i)}),t.adds.forAll(i=>{bi(i)&&r(i.material).adds.push(i)}),t.updates.forAll(i=>{bi(i.renderGeometry)&&r(i.renderGeometry.material).updates.push(i)}),e}function bi(t){return t.geometry.indexCount>=1}let Hd=class{constructor(e,r){this._material=e,this._repository=r,this._map=new Map}dispose(){this._map.forEach((e,r)=>{e!=null&&this._repository.release(this._material,r)})}load(e,r,i){if(!this._material.produces(r,i))return null;this._map.has(i)||this._map.set(i,this._repository.acquire(this._material,r,i));const s=this._map.get(i);if(s!=null){if(s.ensureResources(e)===xn.LOADED)return s;this._repository.requestRender()}return null}},Gd=class extends Jn{constructor(e=F()){super(),this.origin=e,this.slicePlaneLocalOrigin=this.origin}};const Pp=_t().vec3f(f.POSITION),Bd=_t().vec3f(f.POSITION).vec2f(f.UV0),Ip=_t().vec3f(f.POSITION).vec4u8(f.COLOR);_t().vec3f(f.POSITION).vec4u8(f.OBJECTANDLAYERIDCOLOR);const kd=_t().vec3f(f.POSITION).vec2f(f.UV0).vec4u8(f.OBJECTANDLAYERIDCOLOR);_t().vec3f(f.POSITION).vec4u8(f.COLOR).vec4u8(f.OBJECTANDLAYERIDCOLOR);class qd extends La{intersect(e,r,i,s,a,o){return _l(e,i,s,a,void 0,o)}}function ra(t){t.fragment.uniforms.add(new Ve("texWaveNormal",e=>e.waveNormal),new Ve("texWavePerturbation",e=>e.wavePerturbation),new ut("waveParams",e=>dr(Zd,e.waveStrength,e.waveTextureRepeat,e.flowStrength,e.flowOffset)),new Kr("waveDirection",e=>Wr(Jd,e.waveDirection[0]*e.waveVelocity,e.waveDirection[1]*e.waveVelocity))),t.include(jc),t.fragment.code.add(g`const vec2  FLOW_JUMP = vec2(6.0/25.0, 5.0/24.0);
vec2 textureDenormalized2D(sampler2D _tex, vec2 _uv) {
return 2.0 * texture(_tex, _uv).rg - 1.0;
}
float sampleNoiseTexture(vec2 _uv) {
return texture(texWavePerturbation, _uv).b;
}
vec3 textureDenormalized3D(sampler2D _tex, vec2 _uv) {
return 2.0 * texture(_tex, _uv).rgb - 1.0;
}
float computeProgress(vec2 uv, float time) {
return fract(time);
}
float computeWeight(vec2 uv, float time) {
float progress = computeProgress(uv, time);
return 1.0 - abs(1.0 - 2.0 * progress);
}
vec3 computeUVPerturbedWeigth(sampler2D texFlow, vec2 uv, float time, float phaseOffset) {
float flowStrength = waveParams[2];
float flowOffset = waveParams[3];
vec2 flowVector = textureDenormalized2D(texFlow, uv) * flowStrength;
float progress = computeProgress(uv, time + phaseOffset);
float weight = computeWeight(uv, time + phaseOffset);
vec2 result = uv;
result -= flowVector * (progress + flowOffset);
result += phaseOffset;
result += (time - progress) * FLOW_JUMP;
return vec3(result, weight);
}
const float TIME_NOISE_TEXTURE_REPEAT = 0.3737;
const float TIME_NOISE_STRENGTH = 7.77;
vec3 getWaveLayer(sampler2D _texNormal, sampler2D _dudv, vec2 _uv, vec2 _waveDir, float time) {
float waveStrength = waveParams[0];
vec2 waveMovement = time * -_waveDir;
float timeNoise = sampleNoiseTexture(_uv * TIME_NOISE_TEXTURE_REPEAT) * TIME_NOISE_STRENGTH;
vec3 uv_A = computeUVPerturbedWeigth(_dudv, _uv + waveMovement, time + timeNoise, 0.0);
vec3 uv_B = computeUVPerturbedWeigth(_dudv, _uv + waveMovement, time + timeNoise, 0.5);
vec3 normal_A = textureDenormalized3D(_texNormal, uv_A.xy) * uv_A.z;
vec3 normal_B = textureDenormalized3D(_texNormal, uv_B.xy) * uv_B.z;
vec3 mixNormal = normalize(normal_A + normal_B);
mixNormal.xy *= waveStrength;
mixNormal.z = sqrt(1.0 - dot(mixNormal.xy, mixNormal.xy));
return mixNormal;
}
vec4 getSurfaceNormalAndFoam(vec2 _uv, float _time) {
float waveTextureRepeat = waveParams[1];
vec3 normal = getWaveLayer(texWaveNormal, texWavePerturbation, _uv * waveTextureRepeat, waveDirection, _time);
float foam  = normals2FoamIntensity(normal, waveParams[0]);
return vec4(normal, foam);
}`)}const Zd=ze(),Jd=Y();function ia(t,e){e.spherical?t.vertex.code.add(g`vec3 getLocalUp(in vec3 pos, in vec3 origin) {
return normalize(pos + origin);
}`):t.vertex.code.add(g`vec3 getLocalUp(in vec3 pos, in vec3 origin) {
return vec3(0.0, 0.0, 1.0);
}`),e.spherical?t.vertex.code.add(g`mat3 getTBNMatrix(in vec3 n) {
vec3 t = normalize(cross(vec3(0.0, 0.0, 1.0), n));
vec3 b = normalize(cross(n, t));
return mat3(t, b, n);
}`):t.vertex.code.add(g`mat3 getTBNMatrix(in vec3 n) {
vec3 t = vec3(1.0, 0.0, 0.0);
vec3 b = normalize(cross(n, t));
return mat3(t, b, n);
}`)}function Qd(t){const e=new ei,{vertex:r,fragment:i}=e;Aa(r,t),e.include(Qn,t),e.attributes.add(f.POSITION,"vec3"),e.attributes.add(f.UV0,"vec2");const s=new ut("waterColor",a=>a.color);if(t.output===O.Color&&t.isDraped)return e.varyings.add("vpos","vec3"),r.uniforms.add(s),r.code.add(g`
        void main(void) {
          if (waterColor.a < ${g.float(Je)}) {
            // Discard this vertex
            gl_Position = vec4(1e38, 1e38, 1e38, 1.0);
            return;
          }

          vpos = position;
          gl_Position = transformPosition(proj, view, vpos);
        }
    `),i.uniforms.add(s),i.code.add(g`void main() {
fragColor = waterColor;
}`),e;switch(t.output!==O.Color&&t.output!==O.Alpha||(e.include(ia,t),e.include(Yn,t),e.varyings.add("vuv","vec2"),e.varyings.add("vpos","vec3"),e.varyings.add("vnormal","vec3"),e.varyings.add("vtbnMatrix","mat3"),t.multipassEnabled&&e.varyings.add("depth","float"),r.uniforms.add(s),r.code.add(g`
      void main(void) {
        if (waterColor.a < ${g.float(Je)}) {
          // Discard this vertex
          gl_Position = vec4(1e38, 1e38, 1e38, 1.0);
          return;
        }

        vuv = uv0;
        vpos = position;

        vnormal = getLocalUp(vpos, localOrigin);
        vtbnMatrix = getTBNMatrix(vnormal);

        ${t.multipassEnabled?"depth = (view * vec4(vpos, 1.0)).z;":""}

        gl_Position = transformPosition(proj, view, vpos);
        ${t.output===O.Color?"forwardLinearDepth();":""}
      }
    `)),e.include(Ea,t),t.output){case O.Alpha:e.include(Lt,t),i.uniforms.add(s),i.code.add(g`
        void main() {
          discardBySlice(vpos);
          ${t.multipassEnabled?"terrainDepthTest(depth);":""}

          fragColor = vec4(waterColor.a);
        }
      `);break;case O.Color:e.include(Kn),e.include(el,{pbrMode:qe.Disabled,lightingSphericalHarmonicsOrder:2}),e.include(ra),e.include(Lt,t),e.include(tl,t),e.include(Ja,t),i.uniforms.add(s,new Q("timeElapsed",a=>a.timeElapsed),r.uniforms.get("view"),r.uniforms.get("localOrigin")),Oa(i,t),i.include($a),Ui(i),Vi(i),i.code.add(g`
      void main() {
        discardBySlice(vpos);
        ${t.multipassEnabled?"terrainDepthTest(depth);":""}
        vec3 localUp = vnormal;
        // the created normal is in tangent space
        vec4 tangentNormalFoam = getSurfaceNormalAndFoam(vuv, timeElapsed);

        // we rotate the normal according to the tangent-bitangent-normal-Matrix
        vec3 n = normalize(vtbnMatrix * tangentNormalFoam.xyz);
        vec3 v = -normalize(vpos - cameraPosition);
        float shadow = ${t.receiveShadows?g`1.0 - readShadowMap(vpos, linearDepth)`:"1.0"};
        vec4 vPosView = view * vec4(vpos, 1.0);
        vec4 final = vec4(getSeaColor(n, v, mainLightDirection, waterColor.rgb, mainLightIntensity, localUp, shadow, tangentNormalFoam.w, vPosView.xyz, vpos + localOrigin), waterColor.w);

        // gamma correction
        fragColor = delinearizeGamma(final);
        fragColor = highlightSlice(fragColor, vpos);
        ${t.transparencyPassType===ye.Color?"fragColor = premultiplyAlpha(fragColor);":""}
      }
    `);break;case O.Normal:e.include(ia,t),e.include(ra,t),e.include(Lt,t),e.varyings.add("vpos","vec3"),e.varyings.add("vuv","vec2"),r.uniforms.add(s),r.code.add(g`
        void main(void) {
          if (waterColor.a < ${g.float(Je)}) {
            // Discard this vertex
            gl_Position = vec4(1e38, 1e38, 1e38, 1.0);
            return;
          }

          vuv = uv0;
          vpos = position;

          gl_Position = transformPosition(proj, view, vpos);
        }
    `),i.uniforms.add(new Q("timeElapsed",a=>a.timeElapsed)),i.code.add(g`void main() {
discardBySlice(vpos);
vec4 tangentNormalFoam = getSurfaceNormalAndFoam(vuv, timeElapsed);
tangentNormalFoam.xyz = normalize(tangentNormalFoam.xyz);
fragColor = vec4((tangentNormalFoam.xyz + vec3(1.0)) * 0.5, tangentNormalFoam.w);
}`);break;case O.Highlight:e.include(Xn,t),e.varyings.add("vpos","vec3"),r.uniforms.add(s),r.code.add(g`
      void main(void) {
        if (waterColor.a < ${g.float(Je)}) {
          // Discard this vertex
          gl_Position = vec4(1e38, 1e38, 1e38, 1.0);
          return;
        }

        vpos = position;
        gl_Position = transformPosition(proj, view, vpos);
      }
    `),e.include(Lt,t),i.code.add(g`void main() {
discardBySlice(vpos);
outputHighlight();
}`);break;case O.ObjectAndLayerIdColor:e.include(Da,t),e.varyings.add("vpos","vec3"),r.uniforms.add(s),r.code.add(g`
      void main(void) {
        if (waterColor.a < ${g.float(Je)}) {
          // Discard this vertex
          gl_Position = vec4(1e38, 1e38, 1e38, 1.0);
          return;
        }

        vpos = position;
        gl_Position = transformPosition(proj, view, vpos);
        forwardObjectAndLayerIdColor();
      }
    `),e.include(Lt,t),i.code.add(g`void main() {
discardBySlice(vpos);
outputObjectAndLayerIdColor();
}`)}return e}const Yd=Object.freeze(Object.defineProperty({__proto__:null,build:Qd},Symbol.toStringTag,{value:"Module"}));let go=class vo extends ri{initializeConfiguration(e,r){r.spherical=e.viewingMode===si.Global,r.doublePrecisionRequiresObfuscation=e.rctx.driverTest.doublePrecisionRequiresObfuscation.result}initializeProgram(e){return new ii(e.rctx,vo.shader.get().build(this.configuration),gr)}_setPipelineState(e){const r=this.configuration,i=e===ye.NONE,s=e===ye.FrontFace;return Qe({blending:r.output!==O.Normal&&r.output!==O.Highlight&&r.output!==O.ObjectAndLayerIdColor&&r.transparent?i?Ir:Na(e):null,depthTest:{func:ja(e)},depthWrite:i?r.writeDepth?za:null:Ua(e),colorWrite:ft,polygonOffset:i||s?null:Rl(r.enableOffset)})}initializePipeline(){return this._setPipelineState(this.configuration.transparencyPassType)}};go.shader=new ti(Yd,()=>Xr(()=>import("./WaterSurface.glsl-dcfe63ed.js"),["assets/WaterSurface.glsl-dcfe63ed.js","assets/DefaultTechniqueConfiguration-b4dbe32f.js","assets/index-b516d057.js","assets/index-b252abd2.css","assets/requestImageUtils-b142708c.js","assets/enums-bdecffa2.js","assets/Texture-bcb6d63f.js","assets/contextUtils-81fda295.js","assets/interfaces-8918b36f.js","assets/Material-5f4156ac.js","assets/ViewingMode-5d7d590b.js","assets/FramebufferObject-123b7c8d.js","assets/ShaderTechniqueConfiguration-2502462e.js","assets/weather-2eb64924.js","assets/OrderIndependentTransparency-755f7dcc.js","assets/vec3f32-bac7ea57.js","assets/ElevationProvider-abb53936.js","assets/dehydratedPoint-5a1dfed5.js","assets/hydratedFeatures-2365c307.js","assets/RenderState-1d6218ee.js","assets/NestedMap-1b5db22e.js","assets/frustum-f9d53cdf.js","assets/VertexElementDescriptor-2925c6af.js","assets/VertexArrayObject-d19dab8d.js","assets/Octree-7cea9440.js","assets/InterleavedLayout-d76b0d59.js","assets/types-1305598a.js","assets/floatRGBA-ca990bbb.js","assets/Intersector-2e1d9db3.js","assets/Intersector-fa865806.js","assets/boundedPlane-1da2f094.js","assets/verticalOffsetUtils-e5214af9.js","assets/orientedBoundingBox-67c5cd22.js","assets/glUtil-ce5ee52b.js","assets/Scheduler-ff5943a4.js","assets/signal-51ed66f5.js","assets/debugFlags-9a30f077.js"]));let K=class extends Wi{constructor(){super(...arguments),this.output=O.Color,this.transparencyPassType=ye.NONE,this.spherical=!1,this.receiveShadows=!1,this.hasSlicePlane=!1,this.transparent=!1,this.enableOffset=!0,this.writeDepth=!1,this.hasScreenSpaceReflections=!1,this.doublePrecisionRequiresObfuscation=!1,this.hasCloudsReflections=!1,this.objectAndLayerIdColorInstanced=!1,this.isDraped=!1,this.multipassEnabled=!1,this.cullAboveGround=!1}};m([D({count:O.COUNT})],K.prototype,"output",void 0),m([D({count:ye.COUNT})],K.prototype,"transparencyPassType",void 0),m([D()],K.prototype,"spherical",void 0),m([D()],K.prototype,"receiveShadows",void 0),m([D()],K.prototype,"hasSlicePlane",void 0),m([D()],K.prototype,"transparent",void 0),m([D()],K.prototype,"enableOffset",void 0),m([D()],K.prototype,"writeDepth",void 0),m([D()],K.prototype,"hasScreenSpaceReflections",void 0),m([D()],K.prototype,"doublePrecisionRequiresObfuscation",void 0),m([D()],K.prototype,"hasCloudsReflections",void 0),m([D()],K.prototype,"objectAndLayerIdColorInstanced",void 0),m([D()],K.prototype,"isDraped",void 0),m([D()],K.prototype,"multipassEnabled",void 0),m([D()],K.prototype,"cullAboveGround",void 0),m([D({constValue:!1})],K.prototype,"occlusionPass",void 0),m([D({constValue:qe.Water})],K.prototype,"pbrMode",void 0),m([D({constValue:!0})],K.prototype,"useCustomDTRExponentForWater",void 0),m([D({constValue:!0})],K.prototype,"highStepCount",void 0),m([D({constValue:!1})],K.prototype,"useFillLights",void 0);let Xd=class extends Ma{_updateShadowState(e){e.shadowMap.enabled!==this._material.parameters.receiveShadows&&this._material.setParameters({receiveShadows:e.shadowMap.enabled})}_updateSSRState(e){const r=e.ssr.lastFrameColor!=null;r!==this._material.parameters.hasScreenSpaceReflections&&this._material.setParameters({hasScreenSpaceReflections:r})}_updateCloudsReflectionState(e){const r=e.cloudsFade.data!=null;r!==this._material.parameters.hasCloudsReflections&&this._material.setParameters({hasCloudsReflections:r})}ensureResources(e){return this._techniqueRepository.constructionContext.waterTextureRepository.ensureResources(e)}beginSlot(e){return this._output===O.Color&&(this._updateShadowState(e),this._updateSSRState(e),this._updateCloudsReflectionState(e)),this._material.setParameters(this._techniqueRepository.constructionContext.waterTextureRepository.passParameters),this.ensureTechnique(go,e)}},Kd=class extends qd{constructor(e){super(e,new eh),this._configuration=new K,this._animation=new yl}getConfiguration(e,r){return this._configuration.output=e,this._configuration.writeDepth=this.parameters.writeDepth,this._configuration.receiveShadows=this.parameters.receiveShadows,this._configuration.hasSlicePlane=this.parameters.hasSlicePlane,this._configuration.transparent=this.parameters.transparent,this._configuration.hasScreenSpaceReflections=this.parameters.hasScreenSpaceReflections,this._configuration.hasCloudsReflections=this.parameters.hasCloudsReflections,this._configuration.isDraped=this.parameters.isDraped,this._configuration.transparencyPassType=r.transparencyPassType,this._configuration.enableOffset=r.camera.relativeElevation<bl,this._configuration.multipassEnabled=r.multipassEnabled,this._configuration.cullAboveGround=r.multipassTerrain.cullAboveGround,this._configuration}update(e){const r=Math.min(e.camera.relativeElevation,e.camera.distance);this._animation.enabled=Math.sqrt(this.parameters.waveTextureRepeat/this.parameters.waveStrength)*r<th;const i=this._animation.advance(e);return this.setParameters({timeElapsed:Cn(this._animation.time)*this.parameters.animationSpeed},!1),this._animation.enabled&&i}produces(e,r){switch(r){case O.Normal:return e===Z.DRAPED_WATER;case O.Color:if(this.parameters.isDraped)return e===Z.DRAPED_MATERIAL;break;case O.Alpha:break;case O.Highlight:case O.ObjectAndLayerIdColor:return e===Z.OPAQUE_MATERIAL||e===Z.DRAPED_MATERIAL;default:return!1}let i=Z.OPAQUE_MATERIAL;return this.parameters.transparent&&(i=this.parameters.writeDepth?Z.TRANSPARENT_MATERIAL:Z.TRANSPARENT_DEPTH_WRITE_DISABLED_MATERIAL),e===i}createGLMaterial(e){return new Xd(e)}createBufferWriter(){return new rl(ht("enable-feature:objectAndLayerId-rendering")?kd:Bd)}get test(){return{animationEnabled:this._animation.enabled}}},eh=class extends wl{constructor(){super(...arguments),this.waveStrength=.06,this.waveTextureRepeat=32,this.waveDirection=pa(1,0),this.waveVelocity=.05,this.flowStrength=.015,this.flowOffset=-.5,this.animationSpeed=.35,this.timeElapsed=0,this.color=cr(0,0,0,0),this.transparent=!0,this.writeDepth=!0,this.hasSlicePlane=!1,this.isDraped=!1,this.receiveShadows=!0,this.hasScreenSpaceReflections=!1,this.hasCloudsReflections=!1,this.origin=F(),this.modelTransformation=null}};const th=35e3;let Xi=class{constructor(e=0,r=0){this.from=e,this.to=r}get numElements(){return this.to-this.from}};function sa(t){const e=new Map;t.forAll(i=>e.set(i.from,i));let r=!0;for(;r;)r=!1,t.forEach(i=>{const s=e.get(i.to);s&&(i.to=s.to,e.delete(s.from),t.removeUnordered(s),r=!0)})}let aa=class extends Xi{constructor(e,r,i){super(r,i),this.geometry=e}get isVisible(){return this.geometry.visible}get hasHighlights(){return this.geometry.highlights!=null&&this.isVisible}get hasOccludees(){return this.geometry.occludees!=null}};class rh{constructor(){this.first=0,this.count=0}}let ih=class{constructor(){this._numElements=0,this._instances=new Map,this.holes=new Ae({allocator:e=>e||new Xi,deallocator:null}),this.hasHiddenInstances=!1,this.hasHighlights=!1,this.hasOccludees=!1,this.drawCommandsDirty=!0,this.drawCommandsDefault=Ar(),this.drawCommandsHighlight=Ar(),this.drawCommandsOccludees=Ar(),this.drawCommandsShadowHighlightRest=Ar()}get numElements(){return this._numElements}get instances(){return this._instances}addInstance(e,r){this.deleteInstance(e),this._instances.set(e,r),this._numElements+=r.numElements}deleteInstance(e){const r=this._instances.get(e);r&&(this._numElements-=r.numElements,this._instances.delete(e))}updateInstance(e,r,i){const s=this._instances.get(e);s&&(this._numElements-=s.numElements,s.from=r,s.to=i,this._numElements+=s.numElements)}updateDrawState(e){e.isVisible?(e.hasHighlights&&(this.hasHighlights=!0),e.hasOccludees&&(this.hasOccludees=!0)):this.hasHiddenInstances=!0}updateDrawCommands(e){if(this.drawCommandsDefault.clear(),this.drawCommandsHighlight.clear(),this.drawCommandsOccludees.clear(),this.drawCommandsShadowHighlightRest.clear(),this.drawCommandsDirty=!1,this._instances.size===0)return;if(!this.needsMultipleCommands()){const i=this.drawCommandsDefault.pushNew(),s=this.holes.front();return this.vao!=null&&this.holes.length===1&&s.to===Math.floor(this.vao.byteSize/e)?(i.first=0,void(i.count=s.from)):(i.first=1/0,i.count=0,this._instances.forEach(a=>{i.first=Math.min(i.first,a.from),i.count=Math.max(i.count,a.to)}),void(i.count-=i.first))}const r=Array.from(this._instances.values()).sort((i,s)=>i.from===s.from?i.to-s.to:i.from-s.from);for(const i of r)i.isVisible&&(oa(i.hasOccludees?this.drawCommandsOccludees:this.drawCommandsDefault,i),oa(i.hasHighlights?this.drawCommandsHighlight:this.drawCommandsShadowHighlightRest,i))}needsMultipleCommands(){return this.hasOccludees||this.hasHighlights||this.hasHiddenInstances}};function sh(t){return t.vao!=null}function Ar(){return new Ae({allocator:t=>t||new rh,deallocator:t=>t})}function oa(t,e){const r=t.back();if(r==null){const i=t.pushNew();return i.first=e.from,void(i.count=e.numElements)}if(ah(r,e)){const i=e.from-r.first+e.numElements;r.count=i}else{const i=t.pushNew();i.first=e.from,i.count=e.numElements}}function ah(t,e){return t.first+t.count>=e.from}class oh{constructor(e){this.origin=e,this.buffers=new Array}dispose(){this.buffers.forEach(e=>e.vao.dispose()),this.buffers.length=0}findBuffer(e){return this.buffers.find(r=>r.instances.has(e))}}const nh=Sn+1;class lh{constructor(e,r,i){this._rctx=e,this._locations=r,this._layout=i,this._cache=new il(e.newCache,"VAOCache")}dispose(){this._cache.destroy()}newVao(e){const r=e.toString();let i=this._cache.pop(r);return i||(i=new Ji(this._rctx,this._locations,{geometry:this._layout},{geometry:Zi.createVertex(this._rctx,ki.STATIC_DRAW)}),i.vertexBuffers.geometry.setSize(e),i)}deleteVao(e){if(e==null)return;const r=e.byteSize.toString();this._cache.put(r,e,nh)}}let zr=class extends sl{constructor(t){super(t),this._vaoCache=null,this._glMaterials=null,this._bufferWriter=null,this._dataByOrigin=new Map,this._hasHighlights=!1,this._hasOccludees=!1,this.priority=0,this.produces=new Map}dispose(){this._glMaterials=Gt(this._glMaterials),this._dataByOrigin.forEach(t=>t.dispose()),this._dataByOrigin.clear(),this._vaoCache=Gt(this._vaoCache)}initializeRenderContext(t,e){const{rctx:r}=t.renderContext;this._glMaterials=new Hd(this.material,e??t.materialRepository),this._bufferWriter=this.material.createBufferWriter(),this._vaoCache=new lh(r,this.material.vertexAttributeLocations,Ml(this._bufferWriter.vertexBufferLayout))}uninitializeRenderContext(){}get isEmpty(){return this._dataByOrigin.size===0}get hasHighlights(){return this._hasHighlights}get hasOccludees(){return this._hasOccludees}get hasWater(){return!this.isEmpty&&this.material instanceof Kd}get isDecoration(){return this.material.parameters.isDecoration}get rendersOccluded(){return!this.isEmpty&&this.material.parameters.renderOccluded!==pt.Occlude}get numGeometries(){let t=0;return this._dataByOrigin.forEach(e=>t+=e.buffers.reduce((r,i)=>r+i.instances.size,0)),t}get usedMemory(){let t=0;return this._dataByOrigin.forEach(e=>t+=e.buffers.reduce((r,i)=>r+i.vao.usedMemory,0)),t}forEachGeometry(t){this._dataByOrigin.forEach(e=>e.buffers.forEach(r=>r.instances.forEach(i=>t(i.geometry))))}modify(t){this._updateGeometries(t.updates),this._addAndRemoveGeometries(t.adds,t.removes),this._updateDrawCommands()}_updateGeometries(t){const e=this._bufferWriter;if(e===null)return;const r=e.vertexBufferLayout.stride/4;for(const i of t){const s=i.renderGeometry,a=this._dataByOrigin.get(s.localOrigin.id),o=a==null?void 0:a.findBuffer(s.id);if(o==null)return;const n=o.instances.get(s.id);if(i.updateType&(je.GEOMETRY|je.TRANSFORMATION)){const c=Mr(e.elementCount(n.geometry.geometry)*r),l=e.vertexBufferLayout.createView(c.buffer);this._writeGeometry(s,l,0),o.vao.vertexBuffers.geometry.setSubData(c,n.from*r,0,n.numElements*r)}i.updateType&(je.HIGHLIGHT|je.OCCLUDEE|je.VISIBILITY)&&(o.drawCommandsDirty=!0)}}_computeDeltas(t,e){const r=new Bi;for(const i of t){const s=i.localOrigin;if(s==null)continue;let a=r.get(s.id,null);a==null&&(a=new na(s.vec3),r.set(s.id,null,a)),a.changes.push(i)}for(const i of e){const s=i.localOrigin;if(s==null)continue;const a=this._dataByOrigin.get(s.id),o=a==null?void 0:a.findBuffer(i.id);if(o==null)continue;let n=r.get(s.id,o);n==null&&(n=new na(s.vec3),r.set(s.id,o,n)),n.changes.push(i)}return r}_addAndRemoveGeometries(t,e){if(this._bufferWriter===null||this._vaoCache===null)return;const{_bufferWriter:r,_dataByOrigin:i}=this,s=r.vertexBufferLayout.stride/4,a=this._computeDeltas(t,e);a.forEach((o,n)=>{const c=o.get(null),l=c!=null?c.changes:[];a.delete(n,null);let d=i.get(n);if(o.forEach((h,p)=>{if(a.delete(n,p),p==null)return void me(!1,"No VAO for removed geometries");if(p.instances.size===h.changes.length)return this._vaoCache.deleteVao(p.vao),gs(d.buffers,p),void(d.buffers.length===0&&l.length===0&&i.delete(n));const u=p.numElements,v=p.vao.byteSize/4,x=l.reduce((_,L)=>_+r.elementCount(L.geometry),0),y=h.changes.reduce((_,L)=>_+r.elementCount(L.geometry),0),R=Math.min((u+x-y)*s,$r),w=R>v;R>Jr&&R<v/2?(h.changes.forEach(({id:_})=>p.deleteInstance(_)),p.instances.forEach(({geometry:_})=>l.push(_)),this._vaoCache.deleteVao(p.vao),gs(d.buffers,p)):w?this._applyAndRebuild(p,l,h):this._applyRemoves(p,h)}),l.length>0)for(d==null&&(d=new oh(c.origin),i.set(n,d)),d.buffers.forEach(h=>this._applyAdds(h,l));l.length>0;)d.buffers.push(this._applyAndRebuild(new ih,l,null))})}_updateDrawCommands(){this._hasHighlights=!1,this._hasOccludees=!1,this._dataByOrigin.forEach(t=>{t.buffers.forEach(e=>{e.drawCommandsDirty&&(e.hasHiddenInstances=!1,e.hasHighlights=!1,e.hasOccludees=!1,It(e.instances,r=>(e.updateDrawState(r),e.hasHiddenInstances&&e.hasHighlights&&e.hasOccludees)),e.updateDrawCommands(this._bufferWriter.vertexBufferLayout.stride)),this._hasHighlights=this._hasHighlights||e.hasHighlights,this._hasOccludees=this._hasOccludees||e.hasOccludees})})}_applyAndRebuild(t,e,r){if(r!=null)for(const u of r.changes)t.deleteInstance(u.id);const i=this._bufferWriter,s=i.vertexBufferLayout.stride,a=s/4,o=Math.floor($r/a);let n=t.numElements;for(;e.length>0;){const u=e.pop(),v=i.elementCount(u.geometry);if(n+v>o&&n>0){e.push(u);break}n+=v;const x=new aa(u,0,0);me(t.instances.get(u.id)==null),t.addInstance(u.id,x)}const c=n*a,l=Mr(c),d=i.vertexBufferLayout.createView(l.buffer);let h=0;t.hasHiddenInstances=!1,t.hasHighlights=!1,t.hasOccludees=!1,t.instances.forEach((u,v)=>{this._writeGeometry(u.geometry,d,h);const x=h;h+=i.elementCount(u.geometry.geometry),t.updateInstance(v,x,h),t.updateDrawState(u)}),this._vaoCache.deleteVao(t.vao),t.vao=this._vaoCache.newVao(da(c)),t.vao.vertexBuffers.geometry.setSubData(l,0,0,h*a),t.holes.clear();const p=t.holes.pushNew();return p.from=h,p.to=Math.floor(t.vao.byteSize/s),t.updateDrawCommands(s),t}_applyRemoves(t,e){if(e.changes.length===0||this._bufferWriter===null)return;for(const o of e.changes){const n=o.id,c=t.instances.get(n);if(!c)continue;t.deleteInstance(n);const l=Le.back();if(l){if(l.to===c.from){l.to=c.to;continue}if(l.from===c.to){l.from=c.from;continue}}const d=Le.pushNew();d.from=c.from,d.to=c.to}sa(Le);const r=this._bufferWriter.vertexBufferLayout.stride/4,i=Le.reduce((o,n)=>Math.max(o,n.numElements),0)*r,s=Mr(i);s.fill(0,0,i);const a=t.vao.vertexBuffers.geometry;Le.forAll(o=>a.setSubData(s,o.from*r,0,o.numElements*r)),t.holes.pushArray(Le.data,Le.length),Le.forAll((o,n)=>Le.data[n]=null),Le.clear(),t.drawCommandsDirty=!0}_applyAdds(t,e){if(e.length===0||this._bufferWriter===null)return;if(!sh(t))return void this._applyAndRebuild(t,e,null);const r=this._bufferWriter,i=r.vertexBufferLayout.stride/4,s=t.numElements,a=e.reduce((y,R)=>y+r.elementCount(R.geometry),0),o=Math.min((s+a)*i,$r),n=4*o;if(t.vao.byteSize<da($r-Jr)&&n>t.vao.byteSize)return void this._applyAndRebuild(t,e,null);sa(t.holes);const c=new Array;for(const y of e){const R=r.elementCount(y.geometry),w=ch(t.holes,R);c.push(w)}const l=t.vao.vertexBuffers.geometry;let d=0,h=0,p=0;const u=Mr(o),v=r.vertexBufferLayout.createView(u.buffer);e.forEach((y,R)=>{const w=c[R];if(w==null)return;if(p!==w){const C=p-h;C>0&&l.setSubData(u,h*i,0,C*i),h=w,d=0}const _=r.elementCount(y.geometry);this._writeGeometry(y,v,d),d+=_,p=w+_;const L=new aa(y,w,w+_);me(t.instances.get(y.id)==null),t.addInstance(y.id,L),t.drawCommandsDirty=!0});const x=p-h;x>0&&l.setSubData(u,h*i,0,x*i),Tn(e,(y,R)=>c[R]==null)}_writeGeometry(t,e,r){if(this._bufferWriter===null)return;const i=t.localOrigin.vec3;Rn(la,-i[0],-i[1],-i[2]);const s=Xe(dh,la,t.transformation);rr(Er,s),fa(Er,Er),this._bufferWriter.write(s,Er,t.geometry,e,r)}updateAnimation(t){return this.material.update(t)}prepareTechnique(t){if(!this.material.shouldRender(t))return null;const{output:e,bindParameters:r}=t;if(!this.material.produces(r.slot,e))return null;const i=e===O.Highlight||e===O.ShadowHighlight;if(i&&!this._hasHighlights)return null;const s=e===O.ShadowExcludeHighlight,a=!(i||s);for(const o of this._dataByOrigin.values())for(const n of o.buffers){if(i&&!n.hasHighlights)continue;const c=(i?n.drawCommandsHighlight:s&&n.needsMultipleCommands()?n.drawCommandsShadowHighlightRest:n.drawCommandsDefault)||null,l=a&&n.drawCommandsOccludees||null;if(c!=null&&c.length||l!=null&&l.length){const d=this._glMaterials.load(t.rctx,r.slot,e),h=d!=null?d.beginSlot(r):null;if(h!=null)return h}}return null}renderNode(t,e){const{output:r,bindParameters:i}=t,s=r===O.Highlight||r===O.ShadowHighlight,a=r===O.ShadowExcludeHighlight,o=!(s||a),n=t.rctx,c=t.bindParameters.slot===Z.OCCLUDER_MATERIAL,l=t.bindParameters.slot===Z.TRANSPARENT_OCCLUDER_MATERIAL;n.runAppleAmdDriverHelper(),n.bindTechnique(e,this.material.parameters,i);for(const d of this._dataByOrigin.values())for(const h of d.buffers){if(s&&!h.hasHighlights)continue;const p=(s?h.drawCommandsHighlight:a&&h.needsMultipleCommands()?h.drawCommandsShadowHighlightRest:h.drawCommandsDefault)||null,u=o&&h.drawCommandsOccludees||null;(p!=null&&p.length||u!=null&&u.length)&&(e.program.bindDraw(new Gd(d.origin),i,this.material.parameters),e.ensureAttributeLocations(h.vao),n.bindVAO(h.vao),p!=null&&p.length&&(n.setPipelineState(e.getPipeline(!1,c,l)),p.forAll(v=>n.drawArrays(e.primitiveType,v.first,v.count))),u!=null&&u.length&&(n.setPipelineState(e.getPipeline(!0,c,l)),u.forAll(v=>n.drawArrays(e.primitiveType,v.first,v.count))))}}get test(){return{material:this.material,glMaterials:this._glMaterials,dataByOrigin:this._dataByOrigin}}};m([E({constructOnly:!0})],zr.prototype,"material",void 0),zr=m([fr("esri.views.3d.webgl-engine.materials.renderers.MergedRenderer")],zr);class na{constructor(e){this.origin=e,this.changes=new Array}}function ch(t,e){let r;if(!t.some(s=>!(s.numElements<e)&&(r=s,!0)))return null;const i=r.from;return r.from+=e,r.from>=r.to&&t.removeUnordered(r),i}const la=B(),dh=B(),Er=B(),Le=new Ae({allocator:t=>t||new Xi,deallocator:null}),Jr=65536,Oi=4*Jr,ca=1024,_o=16777216,$r=_o/4;let Di=new Float32Array(Jr);function Mr(t){return Di.length<t&&(Di=new Float32Array(t)),Di}function da(t){const e=4*t;return e<=ca?ca:e<Oi?bn(e):Math.max(Math.min(Math.ceil(1.5*e/Oi)*Oi,_o),e)}let Re=class extends ua{constructor(t){super(t),this._pending=new hh,this._changes=new zd,this._materialRenderers=new Ae,this._sortedMaterialRenderers=new Ae,this._geometries=new Map,this._hasHighlights=!1,this._hasWater=!1}destroy(){this._changes.prune(),this._materialRenderers.forAll(t=>t.dispose()),this._materialRenderers.clear(),this._sortedMaterialRenderers.clear(),this._geometries.clear(),this._pending.clear()}get updating(){return!this._pending.empty||this._changes.updates.length>0}get rctx(){return this.rendererContext.rctx}get _materialRepository(){return this.rendererContext.materialRepository}get _localOriginFactory(){return this.rendererContext.localOriginFactory}get hasHighlights(){return this._hasHighlights}get hasWater(){return this._hasWater}get rendersOccluded(){return this._materialRenderers.some(t=>t.rendersOccluded)}get isEmpty(){return!this.updating&&this._materialRenderers.length===0&&this._geometries.size===0}getMemoryForMaterial(t){if(t==null)return 0;const e=this._materialRenderers.find(r=>r.material===t);return(e==null?void 0:e.usedMemory)??0}commitChanges(){if(!this.updating)return!1;this._processAddsRemoves();const t=Wd(this._changes);let e=!1,r=!1,i=!1;return t.forEach((s,a)=>{let o=this._materialRenderers.find(l=>l.material===a);if(!o&&s.adds.length>0){const l=new zr({material:a});l.initializeRenderContext(this.rendererContext.pluginContext,this._materialRepository),o=l,this._materialRenderers.push(o),e=!0,r=!0,i=!0}if(!o)return;const n=r||o.hasHighlights,c=i||o.hasWater;o.modify(s),r=r||n!==o.hasHighlights,i=i||c!==o.hasWater,o.isEmpty&&(this._materialRenderers.removeUnordered(o),o.dispose(),e=!0)}),this._changes.clear(),e&&this._updateSortedMaterialRenderers(),r&&(this._hasHighlights=this._materialRenderers.some(s=>s.hasHighlights)),i&&(this._hasWater=this._materialRenderers.some(s=>s.hasWater)),this.notifyChange("updating"),!0}addGeometries(t,e){if(t.length===0)return;const r=this._validateRenderGeometries(t);for(const s of r)this._geometries.set(s.id,s);const i=this._pending.empty;for(const s of r)this._pending.adds.add(s);i&&this.notifyChange("updating"),e===Zr.UPDATE&&this._notifyGraphicGeometryChanged(t)}removeGeometries(t,e){const r=this._pending.empty,i=this._pending.adds;for(const s of t)i.has(s)?(this._pending.removed.add(s),i.delete(s)):this._pending.removed.has(s)||this._pending.removes.add(s),this._geometries.delete(s.id);r&&!this._pending.empty&&this.notifyChange("updating"),e===Zr.UPDATE&&this._notifyGraphicGeometryChanged(t)}modifyGeometries(t,e){const r=this._changes.updates.length===0;for(const i of t){const s=this._changes.updates.pushNew();s.renderGeometry=this._validateRenderGeometry(i),s.updateType=e}switch(r&&this._changes.updates.length>0&&this.notifyChange("updating"),e){case je.TRANSFORMATION:case je.GEOMETRY:return this._notifyGraphicGeometryChanged(t);case je.VISIBILITY:return this._notifyGraphicVisibilityChanged(t)}}updateAnimation(t){let e=!1;return this._sortedMaterialRenderers.forAll(r=>e=r.updateAnimation(t)||e),e}shouldRender(t){return this._sortedMaterialRenderers.some(e=>e.prepareTechnique(t))}render(t){this._sortedMaterialRenderers.forAll(e=>{const r=e.prepareTechnique(t);r!=null&&e.renderNode(t,r)})}intersect(t,e,r,i,s){return this._geometries.forEach(a=>{if(i&&!i(a))return;this._intersectRenderGeometry(a,r,e,0,t,s);const o=this.rendererContext.longitudeCyclical;o&&(a.boundingSphere[0]-a.boundingSphere[3]<o.min&&this._intersectRenderGeometry(a,r,e,o.range,t,s),a.boundingSphere[0]+a.boundingSphere[3]>o.max&&this._intersectRenderGeometry(a,r,e,-o.range,t,s)),s++}),s}_updateSortedMaterialRenderers(){this._sortedMaterialRenderers.clear(),this._materialRenderers.forAll((t,e)=>{t.priority=e,this._sortedMaterialRenderers.push(t)}),this._sortedMaterialRenderers.sort((t,e)=>e.material.renderPriority===t.material.renderPriority?t.priority-e.priority:e.material.renderPriority-t.material.renderPriority)}_processAddsRemoves(){this._changes.adds.clear(),this._changes.removes.clear(),this._changes.adds.pushArray(Array.from(this._pending.adds)),this._changes.removes.pushArray(Array.from(this._pending.removes));for(let t=0;t<this._changes.updates.length;){const e=this._changes.updates.data[t];this._pending.has(e.renderGeometry)?this._changes.updates.removeUnorderedIndex(t):t++}this._pending.clear()}_intersectRenderGeometry(t,e,r,i,s,a){if(!t.visible)return;let o=0;i+=t.transformation[12],o=t.transformation[13],Ai[0]=r[0]-i,Ai[1]=r[1]-o,t.screenToWorldRatio=this.rendererContext.screenToWorldRatio,t.material.intersectDraped(t,null,s,Ai,(n,c,l)=>{uh(e,l,t.material.renderPriority,a,s,t.layerUid,t.graphicUid)},e)}_notifyGraphicGeometryChanged(t){if(this.drapeSource.notifyGraphicGeometryChanged==null)return;let e;for(const r of t){const i=r.graphicUid;i!=null&&i!==e&&(this.drapeSource.notifyGraphicGeometryChanged(i),e=i)}}_notifyGraphicVisibilityChanged(t){if(this.drapeSource.notifyGraphicVisibilityChanged==null)return;let e;for(const r of t){const i=r.graphicUid;i!=null&&i!==e&&(this.drapeSource.notifyGraphicVisibilityChanged(i),e=i)}}_validateRenderGeometries(t){for(const e of t)this._validateRenderGeometry(e);return t}_validateRenderGeometry(t){return t.localOrigin==null&&(t.localOrigin=this._localOriginFactory.getOrigin(t.boundingSphere)),t}get test(){return{sortedMaterialRenderers:this._sortedMaterialRenderers}}};m([E()],Re.prototype,"drapeSource",void 0),m([E()],Re.prototype,"updating",null),m([E()],Re.prototype,"rctx",null),m([E({constructOnly:!0})],Re.prototype,"rendererContext",void 0),m([E()],Re.prototype,"_materialRepository",null),m([E()],Re.prototype,"_localOriginFactory",null),m([E({readOnly:!0})],Re.prototype,"isEmpty",null),m([E()],Re.prototype,"_materialRenderers",void 0),m([E()],Re.prototype,"_geometries",void 0),Re=m([fr("esri.views.3d.webgl-engine.lib.SortedRenderGeometryRenderer")],Re);class hh{constructor(){this.adds=new Set,this.removes=new Set,this.removed=new Set}get empty(){return this.adds.size===0&&this.removes.size===0&&this.removed.size===0}has(e){return this.adds.has(e)||this.removes.has(e)||this.removed.has(e)}clear(){this.adds.clear(),this.removes.clear(),this.removed.clear()}}function uh(t,e,r,i,s,a,o){const n=new Al(a,o,e),c=l=>{l.set($l.OVERLAY,n,t.dist,t.normal,t.transformation,r,i)};if((s.results.min.drapedLayerOrder==null||r>=s.results.min.drapedLayerOrder)&&(s.results.min.dist==null||s.results.ground.dist<=s.results.min.dist)&&c(s.results.min),s.options.store!==bs.MIN&&(s.results.max.drapedLayerOrder==null||r<s.results.max.drapedLayerOrder)&&(s.results.max.dist==null||s.results.ground.dist>s.results.max.dist)&&c(s.results.max),s.options.store===bs.ALL){const l=El(s.ray);c(l),s.results.all.push(l)}}const Ai=Y();let yo=class wo extends ri{initializeProgram(e){return new ii(e.rctx,wo.shader.get().build(),gr)}initializePipeline(){return this.configuration.hasAlpha?Qe({blending:Ol(Ut.SRC_ALPHA,Ut.ONE,Ut.ONE_MINUS_SRC_ALPHA,Ut.ONE_MINUS_SRC_ALPHA),colorWrite:ft}):Qe({colorWrite:ft})}};yo.shader=new ti(Bc,()=>Xr(()=>import("./TextureOnly.glsl-1c4c9c3b.js"),["assets/TextureOnly.glsl-1c4c9c3b.js","assets/index-b516d057.js","assets/index-b252abd2.css","assets/interfaces-8918b36f.js","assets/DefaultTechniqueConfiguration-b4dbe32f.js","assets/requestImageUtils-b142708c.js","assets/enums-bdecffa2.js","assets/Texture-bcb6d63f.js","assets/contextUtils-81fda295.js","assets/Material-5f4156ac.js","assets/ViewingMode-5d7d590b.js","assets/FramebufferObject-123b7c8d.js","assets/ShaderTechniqueConfiguration-2502462e.js","assets/vec3f32-bac7ea57.js","assets/ElevationProvider-abb53936.js","assets/dehydratedPoint-5a1dfed5.js","assets/hydratedFeatures-2365c307.js","assets/weather-2eb64924.js","assets/RenderState-1d6218ee.js","assets/NestedMap-1b5db22e.js","assets/frustum-f9d53cdf.js","assets/VertexElementDescriptor-2925c6af.js","assets/VertexArrayObject-d19dab8d.js","assets/Octree-7cea9440.js","assets/InterleavedLayout-d76b0d59.js","assets/types-1305598a.js","assets/OrderIndependentTransparency-755f7dcc.js","assets/floatRGBA-ca990bbb.js","assets/Intersector-2e1d9db3.js","assets/Intersector-fa865806.js","assets/boundedPlane-1da2f094.js","assets/verticalOffsetUtils-e5214af9.js","assets/orientedBoundingBox-67c5cd22.js","assets/glUtil-ce5ee52b.js","assets/Scheduler-ff5943a4.js","assets/signal-51ed66f5.js","assets/debugFlags-9a30f077.js"]));class xo extends Ia{constructor(){super(...arguments),this.hasAlpha=!1}}m([D()],xo.prototype,"hasAlpha",void 0);class Co extends Pa{constructor(){super(...arguments),this.overlayIndex=Oe.INNER,this.opacity=1}}function ph(){const t=new ei;return t.include(ba),t.fragment.uniforms.add(new Ve("tex",e=>e.texture)),t.fragment.uniforms.add(new al("overlayIdx",e=>e.overlayIndex)),t.fragment.uniforms.add(new Q("opacity",e=>e.opacity)),t.fragment.code.add(g`void main() {
vec2 overlayUV = overlayIdx == 0 ? vec2(uv.x * 0.5, uv.y) : vec2(uv.x * 0.5 + 0.5, uv.y);
fragColor = texture(tex, overlayUV) * opacity;
}`),t}const fh=Object.freeze(Object.defineProperty({__proto__:null,OverlayCompositingPassParameters:Co,build:ph},Symbol.toStringTag,{value:"Module"}));class ai extends ri{initializeProgram(e){return new ii(e.rctx,ai.shader.get().build(),gr)}initializePipeline(){return Qe({blending:Dl(Ut.ONE,Ut.ONE_MINUS_SRC_ALPHA),colorWrite:ft})}}ai.shader=new ti(fh,()=>Xr(()=>import("./OverlayCompositing.glsl-ef6887b8.js"),["assets/OverlayCompositing.glsl-ef6887b8.js","assets/interfaces-8918b36f.js","assets/index-b516d057.js","assets/index-b252abd2.css","assets/DefaultTechniqueConfiguration-b4dbe32f.js","assets/requestImageUtils-b142708c.js","assets/enums-bdecffa2.js","assets/Texture-bcb6d63f.js","assets/contextUtils-81fda295.js","assets/Material-5f4156ac.js","assets/ViewingMode-5d7d590b.js","assets/FramebufferObject-123b7c8d.js","assets/ShaderTechniqueConfiguration-2502462e.js","assets/vec3f32-bac7ea57.js","assets/ElevationProvider-abb53936.js","assets/dehydratedPoint-5a1dfed5.js","assets/hydratedFeatures-2365c307.js","assets/weather-2eb64924.js","assets/RenderState-1d6218ee.js","assets/NestedMap-1b5db22e.js","assets/frustum-f9d53cdf.js","assets/VertexElementDescriptor-2925c6af.js","assets/VertexArrayObject-d19dab8d.js","assets/Octree-7cea9440.js","assets/InterleavedLayout-d76b0d59.js","assets/types-1305598a.js","assets/OrderIndependentTransparency-755f7dcc.js","assets/floatRGBA-ca990bbb.js","assets/Intersector-2e1d9db3.js","assets/Intersector-fa865806.js","assets/boundedPlane-1da2f094.js","assets/verticalOffsetUtils-e5214af9.js","assets/orientedBoundingBox-67c5cd22.js","assets/glUtil-ce5ee52b.js","assets/Scheduler-ff5943a4.js","assets/signal-51ed66f5.js","assets/debugFlags-9a30f077.js"]));let Fe=class extends ol{get _bindParameters(){return this._renderContext.bindParameters}get _rctx(){return this.view._stage.renderView.renderingContext}get rctx(){return this._rctx}get materialRepository(){return this._materialRepository}get screenToWorldRatio(){return this._screenToWorldRatio}get localOriginFactory(){return this._localOriginFactory}constructor(t){super(t),this._overlays=null,this._renderTargets=null,this._overlayParameters=new Co,this.hasHighlights=!1,this._rendersOccluded=!1,this._hasWater=!1,this._renderers=new Map,this._sortedDrapeSourceRenderersDirty=!1,this._sortedRenderers=new Ae,this._passParameters=new Ya,this._materialRepository=null,this._screenToWorldRatio=1,this._localOriginFactory=null,this.unloadedMemory=0,this.ignoresMemoryFactor=!1,this._camera=new N,this.worldToPCSRatio=1,this.events=new xa,this.longitudeCyclical=null,this.produces=new Map([[Z.DRAPED_MATERIAL,e=>e!==O.Highlight||this.hasHighlights],[Z.DRAPED_WATER,()=>!0]]),this._hasTargetWithoutRasterImage=!1,this._hasDrapedFeatureSource=!1,this._hasDrapedRasterSource=!1}initialize(){const t=this.view._stage.renderer.fboCache,e=this.view._stage.renderView,{waterTextureRepository:r,stippleTextureRepository:i,markerTextureRepository:s}=e;this._shaderTechniqueRepository=new kc({rctx:this._rctx,viewingMode:si.Local,stippleTextureRepository:i,markerTextureRepository:s,waterTextureRepository:r}),this._renderContext=new mo(this._rctx,new Pd(t,this.view.state.viewingMode),null),this.addHandles([li(()=>r.updating,()=>this.events.emit("content-changed"),vs),li(()=>this.spatialReference,a=>this._localOriginFactory=new $d(a),vs),On(()=>this.view.allLayerViews,"after-changes",()=>this._sortedDrapeSourceRenderersDirty=!0)]),this._materialRepository=new Jc(e.textureRepository,this._shaderTechniqueRepository,a=>{(a.parameters.renderOccluded&ha)>0!==this._rendersOccluded&&this._updateRendersOccluded(),this.events.emit("content-changed"),this.notifyChange("updating"),this.notifyChange("isEmpty")},()=>this.events.emit("content-changed")),this._bindParameters.slot=Z.DRAPED_MATERIAL,this._bindParameters.mainDepth=jl(this._rctx),this._camera.near=1,this._camera.far=1e4,this._camera.relativeElevation=null,this._bindParameters.camera=this._camera,this._bindParameters.transparencyPassType=ye.NONE,this._bindParameters.newLighting.noonFactor=0,this._bindParameters.newLighting.globalFactor=0,this._bindParameters.newLighting.set([new nl(lr(1,1,1))]),this.addHandles(this.view.resourceController.scheduler.registerTask(Pl.STAGE,this))}destroy(){this._renderers.forEach(t=>t.destroy()),this._renderers.clear(),this._debugTextureTechnique=Ur(this._debugTextureTechnique),this._passParameters.texture=Gt(this._passParameters.texture),this._bindParameters.mainDepth=Gt(this._bindParameters.mainDepth),this._shaderTechniqueRepository=Ca(this._shaderTechniqueRepository),this.disposeOverlays()}initializeRenderContext(t){this.pluginContext=t}uninitializeRenderContext(){}renderNode(){}get updating(){return this._sortedDrapeSourceRenderersDirty||It(this._renderers,t=>t.updating)}get hasOverlays(){return this._overlays!=null&&this._renderTargets!=null}getMemoryForMaterial(t){return Array.from(this._renderers.values()).reduce((e,r)=>e+r.getMemoryForMaterial(t),0)}createGeometryDrapeSourceRenderer(t){return this.createDrapeSourceRenderer(t,Re)}createDrapeSourceRenderer(t,e,r){const i=this._renderers.get(t);i!=null&&i.destroy();const s=new e({...r,rendererContext:this,drapeSource:t});return this._renderers.set(t,s),this._sortedDrapeSourceRenderersDirty=!0,"fullOpacity"in t&&this.addHandles(li(()=>t.fullOpacity,()=>this.events.emit("content-changed")),t),s}removeDrapeSourceRenderer(t){if(t==null)return;const e=this._renderers.get(t);e!=null&&(this._sortedDrapeSourceRenderersDirty=!0,this._renderers.delete(t),this.removeHandles(t),e.destroy())}computeValidity(){var t;return((t=this._renderTargets)==null?void 0:t.computeValidity())??0}releaseRenderTargets(){var t;(t=this._renderTargets)==null||t.dispose()}get overlays(){return this._overlays??[]}ensureDrapeTargets(t){this._hasTargetWithoutRasterImage=!!this._overlays&&ci(t,e=>e.drapeTargetType===Li.WithoutRasterImage)}ensureDrapeSources(t){this._overlays?(this._hasDrapedFeatureSource=ci(t,e=>e.drapeSourceType===ar.Features),this._hasDrapedRasterSource=ci(t,e=>e.drapeSourceType===ar.RasterImage)):this._hasDrapedFeatureSource=this._hasDrapedRasterSource=!1}get _needsColorWithoutRasterImage(){return this._hasDrapedRasterSource&&this._hasDrapedFeatureSource&&this._hasTargetWithoutRasterImage}ensureOverlays(t,e,r=this._bindParameters.overlayStretch){this._overlays==null&&(this._renderTargets=new Nc(this.view._stage.renderer.fboCache),this._overlays=[new Ns,new Ns]),this.ensureDrapeTargets(t),this.ensureDrapeSources(e),this._bindParameters.overlayStretch=r}disposeOverlays(){this._overlays=null,this._renderTargets=Gt(this._renderTargets),this.events.emit("textures-disposed")}getTexture(t){var e,r;if(t!=null)return t===ae.ColorNoRasterImage&&!this._needsColorWithoutRasterImage&&this._hasDrapedFeatureSource?(e=this._renderTargets)==null?void 0:e.getTexture(ae.Color):(r=this._renderTargets)==null?void 0:r.getTexture(t)}get running(){return this.updating}runTask(t){this._processDrapeSources(t,()=>!0)}_processDrapeSources(t,e){let r=!1;for(const[i,s]of this._renderers){if(t.done)break;(i.destroyed||e(i))&&s.commitChanges()&&(r=!0,t.madeProgress())}this._sortedDrapeSourceRenderersDirty&&(this._sortedDrapeSourceRenderersDirty=!1,r=!0,this._updateSortedDrapeSourceRenderers()),r&&(this._overlays!=null&&this._renderers.size===0&&this.disposeOverlays(),this.notifyChange("updating"),this.notifyChange("isEmpty"),this.events.emit("content-changed"),this.hasHighlights=It(this._renderers,i=>i.hasHighlights),this._updateRendersOccluded(),this._updateHasWater())}processSyncDrapeSources(){this._processDrapeSources(Il,t=>t.updatePolicy===ur.SYNC)}get isEmpty(){return!Ts.OVERLAY_DRAW_DEBUG_TEXTURE&&!It(this._renderers,t=>!t.isEmpty)}get hasWater(){return this._hasWater}get rendersOccluded(){return this._rendersOccluded}get mode(){var t,e;return this.isEmpty?Wt.Disabled:(t=this._renderTargets)!=null&&t.getTexture(ae.WaterNormal)?Wt.EnabledWithWater:(e=this._renderTargets)!=null&&e.getTexture(ae.Color)?Wt.Enabled:Wt.Disabled}updateAnimation(t){let e=!1;return this._renderers.forEach(r=>e=r.updateAnimation(t)||e),e}updateDrapeSourceOrder(){this._sortedDrapeSourceRenderersDirty=!0}drawOverlays(t){if(this._overlays&&this._renderTargets){for(const e of this._overlays)this.longitudeCyclical?e.setupGeometryViewsCyclical(this.longitudeCyclical):e.setupGeometryViewsDirect();for(const e of this._renderTargets.targets)(e.content!==ae.ColorNoRasterImage||this._needsColorWithoutRasterImage)&&(this._drawTarget(Oe.INNER,e,t),this._drawTarget(Oe.OUTER,e,t))}}_drawTarget(t,e,r){const i=this._overlays[t],s=i.canvasGeometries;if(s.numViews===0)return;const{alignPixelEnabled:a,contentPixelRatio:o}=r;this._screenToWorldRatio=o*i.mapUnitsPerPixel/this._bindParameters.overlayStretch;const n=e.output;if(this.isEmpty||n===O.Highlight&&!this.hasHighlights||n===O.Normal&&!this.hasWater||!i.hasSomeSizedView())return;const c=this._rctx;this._camera.pixelRatio=i.pixelRatio*o,this._renderContext.output=n,this._bindParameters.alignPixelEnabled=a,this._bindParameters.screenToWorldRatio=this._screenToWorldRatio,this._bindParameters.screenToPCSRatio=this._screenToWorldRatio*this.worldToPCSRatio,this._bindParameters.slot=n===O.Normal?Z.DRAPED_WATER:Z.DRAPED_MATERIAL;const l=Ts.OVERLAY_DRAW_DEBUG_TEXTURE&&e.content!==ae.Occluded;if(!l&&!this._sortedRenderers.some(({renderer:v})=>v.shouldRender(this._renderContext)))return;const d=i.resolution;this._rctx.setViewport(t===Oe.INNER?0:d,0,d,d);const h=2*i.resolution,p=i.resolution,u=e.fbo;if(u.bind(c,h,p),t===Oe.INNER&&(c.setClearColor(0,0,0,0),c.clearSafe(Gr.COLOR_BUFFER_BIT)),e.content===ae.Occluded&&(this._renderContext.renderOccludedMask=ha),l)for(let v=0;v<s.numViews;v++)this._setViewParameters(s.extents[v],i),this._ensureDebugPatternResources(i.resolution,gh[t]),this._rctx.bindTechnique(this._debugTextureTechnique,this._passParameters,null),this._rctx.screen.draw();this._sortedRenderers.forAll(({drapeSource:v,renderer:x})=>{if(e.content===ae.ColorNoRasterImage&&v.drapeSourceType===ar.RasterImage)return;const{fullOpacity:y}=v,R=y!=null&&y<1&&n===O.Color?this.bindTemporaryFramebuffer(h,p):null;for(let w=0;w<s.numViews;w++)this._setViewParameters(s.extents[w],i),x.render(this._renderContext);if(R){u.bind(c,h,p),this._overlayParameters.texture=R.colorTexture,this._overlayParameters.opacity=y,this._overlayParameters.overlayIndex=t;const w=this.pluginContext.techniqueRepository.acquire(ai);this._rctx.bindTechnique(w,this._overlayParameters,this._renderContext.bindParameters),this._rctx.screen.draw(),w.release(),R.release()}}),c.bindFramebuffer(null),t===Oe.OUTER&&u.generateMipMap(),this._renderContext.resetRenderOccludedMask()}bindTemporaryFramebuffer(t,e){const r=this.view._stage.renderer.fboCache,i=r.acquire(hr.RGBA,t,e);return r.rctx.bindFramebuffer(i.fbo),r.rctx.clearSafe(Gr.COLOR_BUFFER_BIT),i}async reloadShaders(){await this._shaderTechniqueRepository.reloadAll()}notifyContentChanged(){this.events.emit("content-changed")}intersect(t,e,r,i){var a;let s=0;for(const o of this._renderers.values())s=((a=o.intersect)==null?void 0:a.call(o,t,e,r,i,s))??s}_updateSortedDrapeSourceRenderers(){if(this._sortedRenderers.clear(),this._renderers.size===0)return;const t=this.view.map.allLayers;this._renderers.forEach((e,r)=>{const i=t.indexOf(r.layer),s=i>=0,a=this._renderers.size*(r.renderGroup??(s?kr.MapLayer:kr.ViewLayer))+(s?i:0);this._sortedRenderers.push(new mh(r,e,a))}),this._sortedRenderers.sort((e,r)=>e.index-r.index)}_setViewParameters(t,e){const r=this._camera;r.viewport=[0,0,e.resolution,e.resolution],Dn(r.projectionMatrix,0,t[2]-t[0],0,t[3]-t[1],r.near,r.far),An(r.viewMatrix,[-t[0],-t[1],0])}_updateHasWater(){const t=It(this._renderers,e=>e.hasWater);t!==this._hasWater&&(this._hasWater=t,this.events.emit("has-water",t))}_updateRendersOccluded(){const t=It(this._renderers,e=>e.rendersOccluded);t!==this._rendersOccluded&&(this._rendersOccluded=t,this.events.emit("renders-occluded",t))}_ensureDebugPatternResources(t,e){if(ee(this._passParameters.color,e[0],e[1],e[2]),this._passParameters.texture)return;const r=new Uint8Array(t*t*4);let i=0;for(let o=0;o<t;o++)for(let n=0;n<t;n++){const c=Math.floor(n/10),l=Math.floor(o/10);c<2||l<2||10*c>t-20||10*l>t-20?(r[i++]=255,r[i++]=255,r[i++]=255,r[i++]=255):(r[i++]=255,r[i++]=255,r[i++]=255,r[i++]=1&c&&1&l?1&n^1&o?0:255:1&c^1&l?0:128)}const s=new vr(t);s.samplingMode=qi.NEAREST,this._passParameters.texture=new mt(this._rctx,s,r);const a=new xo;a.hasAlpha=!0,this._debugTextureTechnique=this._shaderTechniqueRepository.acquire(yo,a)}get test(){return{drapedRenderers:Array.from(this._renderers.values()),getDrapeSourceRenderer:t=>this._renderers.get(t)}}};m([E()],Fe.prototype,"hasHighlights",void 0),m([E()],Fe.prototype,"_sortedDrapeSourceRenderersDirty",void 0),m([E({autoDestroy:!0})],Fe.prototype,"_shaderTechniqueRepository",void 0),m([E({constructOnly:!0})],Fe.prototype,"view",void 0),m([E()],Fe.prototype,"worldToPCSRatio",void 0),m([E()],Fe.prototype,"spatialReference",void 0),m([E({type:Boolean,readOnly:!0})],Fe.prototype,"updating",null),m([E()],Fe.prototype,"isEmpty",null),Fe=m([fr("esri.views.3d.terrain.OverlayRenderer")],Fe);class mh{constructor(e,r,i){this.drapeSource=e,this.renderer=r,this.index=i}}const gh=[[1,.5,.5],[.5,.5,1]],Wp=-2,ha=pt.OccludeAndTransparent;class Hp{constructor(e,r={}){this.geometry=e,this.screenToWorldRatio=1,this._transformation=B(),this._shaderTransformation=null,this._boundingSphere=null,this.id=ji(),this.layerUid=r.layerUid,this.graphicUid=r.graphicUid,this.castShadow=r.castShadow??!1,r.objectShaderTransformation!=null&&this.objectShaderTransformationChanged(r.objectShaderTransformation)}get transformation(){return this._transformation}set transformation(e){dt(this._transformation,e),this._boundingSphere=null}get boundingInfo(){return this.geometry.boundingInfo}objectShaderTransformationChanged(e){e==null?this._shaderTransformation=null:(this._shaderTransformation??(this._shaderTransformation=B()),Xe(this._shaderTransformation,e,this.geometry.transformation)),this._boundingSphere=null}get boundingSphere(){return this.boundingInfo?(this._boundingSphere==null&&(this._boundingSphere??(this._boundingSphere=wa()),Se(this._boundingSphere,this.boundingInfo.center,this.shaderTransformation),this._boundingSphere[3]=this.boundingInfo.radius*ya(this.shaderTransformation)),this._boundingSphere):En}get material(){return this.geometry.material}get type(){return this.geometry.type}get shaderTransformation(){return this._shaderTransformation==null?this.transformation:this._shaderTransformation}get attributes(){return this.geometry.attributes}get highlights(){return this.geometry.highlights}get occludees(){return this.geometry.occludees}get visible(){return this.geometry.visible}set visible(e){this.geometry.visible=e}}export{N as $,yd as A,Tu as B,ur as C,au as D,Zr as E,qd as F,Bd as G,gu as H,je as I,Ji as J,cu as K,uc as L,Xh as M,$i as N,vd as O,pr as P,$u as Q,vu as R,Re as S,Bh as T,yu as U,$c as V,pu as W,fu as X,du as Y,hu as Z,$d as _,ph as a,ku as a$,mc as a0,Ac as a1,Su as a2,mu as a3,iu as a4,su as a5,ru as a6,ou as a7,Iu as a8,_u as a9,Ll as aA,Fl as aB,ql as aC,Br as aD,Kl as aE,G as aF,ct as aG,dc as aH,Zh as aI,z as aJ,Fe as aK,Fi as aL,Fs as aM,Wt as aN,ep as aO,ae as aP,Is as aQ,qh as aR,ha as aS,Gd as aT,Ls as aU,lp as aV,js as aW,Ku as aX,Vc as aY,Ye as aZ,Wa as a_,Ii as aa,Au as ab,bu as ac,Ou as ad,Dc as ae,xu as af,Du as ag,to as ah,vt as ai,gt as aj,Kc as ak,_d as al,or as am,lo as an,mp as ao,ie as ap,Ip as aq,Pp as ar,Hd as as,wu as at,Cu as au,As as av,ia as aw,vc as ax,eh as ay,Kd as az,xd as b,Zu as b0,Qu as b1,qs as b2,Pd as b3,Sp as b4,Wd as b5,zr as b6,kh as b7,yo as b8,xo as b9,ed as ba,gp as bb,up as bc,kc as bd,Jc as be,zd as bf,pp as c,Co as d,Ru as e,uu as f,nu as g,Hp as h,Ya as i,qr as j,ro as k,Gc as l,Xc as m,ar as n,Lu as o,kr as p,lu as q,Oe as r,Wp as s,Li as t,fp as u,Pu as v,Mu as w,Qd as x,Ga as y,Sc as z};
